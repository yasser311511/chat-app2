 
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WalChat - ÙˆØ§Ù„ Ø´Ø§Øª  Ù…Ù†ØµØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© </title>
    <meta name="description" content="WalChat - Ù…Ù†ØµØ© Ø¯Ø±Ø¯Ø´Ø© Ø¹Ø±Ø¨ÙŠØ© Ø¢Ù…Ù†Ø© ÙˆÙ…Ù…ØªØ¹Ø©. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙÙŠ Ø¨ÙŠØ¦Ø© Ù…Ø­Ù…ÙŠØ© Ø¨Ù‚ÙˆØ§Ù†ÙŠÙ† ØµØ§Ø±Ù…Ø© Ø¶Ø¯ Ø§Ù„Ø¥Ø³Ø§Ø¡Ø© ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ø§Ù„Ù„Ø§Ø¦Ù‚.">
    <meta name="keywords" content="Ø¯Ø±Ø¯Ø´Ø© Ø¹Ø±Ø¨ÙŠØ©, Ø´Ø§Øª Ø¹Ø±Ø¨ÙŠ, Ù…Ø­Ø§Ø¯Ø«Ø©, ØªÙˆØ§ØµÙ„ ,ÙˆØ§Ù„ Ø´Ø§Øª,WalChat, Ø¯Ø±Ø¯Ø´Ø© Ø¢Ù…Ù†Ø©">
    <meta name="author" content="WalChat">
    <meta property="og:title" content="WalChat - Ù…Ù†ØµØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">
    <meta property="og:description" content="Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù…Ø¬ØªÙ…Ø¹ WalChat Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø¢Ù…Ù†Ø© ÙˆØ§Ù„Ù…Ù…ØªØ¹Ø©">
    <meta property="og:image" content="https://walidchating.onrender.com/icon.png">
    <meta property="og:url" content="https://walidchating.onrender.com">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="canonical" href="https://walidchating.onrender.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #000000;
        }
        .chat-message {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-container { transition: all 0.3s ease; }
        .tab-button { transition: all 0.2s ease; }
        .avatar-option { transition: all 0.2s ease; }
        .avatar-option:hover { transform: scale(1.1); }
        .avatar-option.selected { border: 3px solid #3B82F6; }
        .notification {
            animation: notificationSlide 0.5s ease-out, notificationFade 5s forwards;
        }
        @keyframes notificationSlide {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes notificationFade {
            0%, 70% { opacity: 1; }
            100% { opacity: 0; }
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        /* ØªØ¹Ø¯ÙŠÙ„ z-index Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© - ØªÙ… Ù†Ù‚Ù„Ù‡ Ø¥Ù„Ù‰ Ø±Ø£Ø³ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
        @media (min-width: 768px) {
            #onlineUsersPanel { z-index: 20; }
        }
        /* ØªØ¹Ø¯ÙŠÙ„ Ø®Ø§Øµ Ø¨Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 768px) {
            .chat-header-mobile { min-height: auto; }
            .chat-header-buttons { flex-wrap: wrap; justify-content: flex-end; gap: 0.5rem; }
        }
        .rank-badge {
            background: linear-gradient(45deg, #3B82F6, #8B5CF6);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            margin-left: 5px;
        }
        .achievement-badge {
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-right: 2px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: help;
        }
        .achievement-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            transition: all 0.3s ease;
        }
        .achievement-card.completed {
            border-color: #10B981;
            background: rgba(16, 185, 129, 0.1);
        }
        .achievement-count-badge {
            position: absolute;
            bottom: -4px;
            right: -4px;
            width: 14px;
            height: 14px;
            background: #6B7280;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 5;
        }
        .messages-container {
            height: 100%;
            overflow-y: auto;
        }
    
        .users-container {
            height: 100%;
            overflow-y: auto;
        }
    
        /* Ù†Ø¶Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ø§ ÙŠÙ†Ø²Ø§Ø­ */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Ø³Ø¨ÙŠÙ†Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        @media (max-width: 768px) {
            .users-container {
                position: fixed;
                top: 0;
                right: -100%;
                width: 80%;
                height: 100vh;
                z-index: 50;
                transition: transform 0.3s ease;
                background: rgba(15, 23, 42, 0.95);
                backdrop-filter: blur(10px);
                padding: 1rem;
            }
            
            .users-container.show {
                right: 0;
                transform: translateX(0);
            }
            
            .users-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }
            
            .users-overlay.show {
                display: block;
            }
        }

        /* Responsive adjustments for very small screens */
        @media (max-width: 380px) {
            /* Reduce padding on main chat send button */
            #messageInputContainer button {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            #messageInputContainer span {
                display: none; /* Hide the "Send" text */
            }
            #messageInputContainer svg {
                margin: auto;
            }

            /* Reduce padding on login/register form */
            #loginPage .p-8 {
                padding: 1.5rem;
            }

            /* Reduce font size on room cards */
            #roomsContainer h3 {
                font-size: 1.1rem;
            }
            #roomsContainer p {
                font-size: 0.8rem;
            }
        }

        /* Ensure main chat area flexes correctly */
        #chatPage > .flex-1 {
            flex-direction: column;
        }
        @media (min-width: 768px) {
            #chatPage > .flex-1 {
                flex-direction: row;
            }
        }

        /* Ù†Ù…Ø· Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
       .private-chat-modal {
    position: fixed;
    bottom: 100px;
    right: 20px;
    width: 350px;
    height: 450px;
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    z-index: 999;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    transform: translateY(100%);
    opacity: 0;
    transition: all 0.3s ease;
    pointer-events: none; /* Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù…Ù‡Ù… Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ù…Ø®ÙÙŠÙ‹Ø§ */
}

.private-chat-modal.show {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto; /* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø¸Ø§Ù‡Ø±Ù‹Ø§ */
}
        
        .profile-content {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            width: 90%;
            max-width: 550px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            margin: auto;
        }
        
        .profile-modal.show .profile-content {
            transform: scale(1);
        }
        
        /* Ù†Ù…Ø· Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ© */
        /* Ù†Ù…Ø· Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            overflow-y: auto;
            padding: 2rem 0;
        }
        .profile-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .private-chat-modal {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 350px;
            height: 450px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .private-chat-modal.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .private-chat-header {
            background: rgba(30, 41, 59, 0.8);
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .private-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .private-chat-input {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø±Ø£Ø³ ÙˆØ§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .main-header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
        }
        
        .user-profile-btn {
            transition: all 0.3s ease;
        }
        
        .user-profile-btn:hover {
            transform: translateY(-2px);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #EF4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ */
        .friends-sidebar {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            width: 300px;
            height: 100vh;
            position: fixed;
            top: 0;
            right: 0;
            z-index: 40;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .friends-sidebar.show {
            transform: translateX(0);
        }
        
        .friends-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 30;
        }
        
        .friends-overlay.show {
            display: block;
        }
        
        .friend-item {
            transition: all 0.3s ease;
        }
        
        .friend-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù†Ù…Ø§Ø· ÙÙŠ Ù‚Ø³Ù… style */
        /* Ù†Ù…Ø· Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ÙŠÙ…ÙˆØ¬ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ø§Ù„Ù…Ø·ÙˆØ± */
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            left: 20px;
            width: 320px;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 0;
            margin-bottom: 5px;
            display: none;
            flex-direction: column;
            max-height: 350px;
            overflow: hidden;
            z-index: 1000;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .emoji-picker.show {
            display: flex;
        }
        .emoji-picker-header {
            display: flex;
            background: rgba(30, 41, 59, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .emoji-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            color: #94a3b8;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .emoji-tab.active {
            color: #fff;
            background: rgba(59, 130, 246, 0.5);
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }
        .animated-emoji {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: contain;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .animated-emoji:hover {
            transform: scale(1.2);
        }

.bg-option {
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.bg-option:hover {
    transform: scale(1.05);
}

.bg-option.selected > div {
    border-color: #3B82F6 !important;
}

/* Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
.chat-image {
    max-width: 300px;
    max-height: 300px;
    border-radius: 10px;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.chat-image:hover {
    transform: scale(1.02);
}

.image-modal {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; } to { opacity: 1; }
}

#imageButton, #privateImageButton {
    transition: all 0.3s ease;
}

#imageButton:hover, #privateImageButton:hover {
    transform: scale(1.05);
}

/* --- Ø£Ù†Ù…Ø§Ø· Ø§Ø­ØªØ±Ø§ÙÙŠØ© ÙˆÙ…Ø¯Ù…Ø¬Ø© Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ --- */
.chat-message {
    margin-bottom: 0.25rem !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
}
/* Ø¥Ø¸Ù‡Ø§Ø± Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
.message-actions {
    opacity: 1;
    transition: opacity 0.2s ease-in-out;
}
.chat-message:hover .message-actions {
    opacity: 1;
}
/* ØªØ¹Ø¯ÙŠÙ„ Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ£Ø«Ø± Ø¨Ù€ hover */
.chat-message.justify-center:hover .message-actions {
    opacity: 0;
}

/* ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
.chat-message .avatar-container {
    width: 2rem !important; /* 32px */
    height: 2rem !important; /* 32px */
    overflow: visible !important;
}

/* ØªØ¹Ø¯ÙŠÙ„ ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
.chat-message .message-bubble {
    padding: 0.5rem 0.85rem !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„ÙÙ‚Ø§Ø¹Ø© */
    padding-left: 2.5rem !important; /* Ù…Ø³Ø§Ø­Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø²Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª */
    border-radius: 0.75rem !important; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªØ¯Ø§Ø±Ø© Ø§Ù„Ø²ÙˆØ§ÙŠØ§ Ù„Ù…Ø¸Ù‡Ø± ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ */
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¬Ù… Ø®Ø· Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
.chat-message .message-content {
    font-size: 0.9rem !important; /* 14.4px */
    line-height: 1.4 !important;
    word-break: break-word; /* --- Ø§Ù„Ø­Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© Ø®Ø±ÙˆØ¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ÙÙ‚Ø§Ø¹Ø© --- */
    /* --- Ø§Ù„Ø­Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù†Øµ --- */
    unicode-bidi: plaintext;
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¬Ù… Ø®Ø· Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
.chat-message .username-text {
    font-size: 0.8rem !important; /* 12.8px */
}

/* ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¬Ù… Ø®Ø· Ø§Ù„ÙˆÙ‚Øª */
.chat-message .timestamp-text {
    font-size: 0.7rem !important; /* 11.2px */
}

/* ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
.chat-image {
    max-width: 220px !important;
    max-height: 180px !important;
    border-radius: 0.5rem !important;
}

/* ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø±ØªØ¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
.rank-badge {
    font-size: 0.65rem !important; /* 10.4px */
    padding: 1px 5px !important;
    margin-bottom: 2px !important;
}

/* ØªØ­Ø³ÙŠÙ† ØªØ®Ø·ÙŠØ· Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
.chat-message .flex.items-center.space-x-3 {
    margin-bottom: 0.25rem !important;
}

.chat-message .space-x-3 > * + * {
    margin-right: 0.75rem !important;
}

/* ØªØ­Ø³ÙŠÙ† ØªØ®Ø·ÙŠØ· Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… */
.chat-message.justify-center .max-w-md {
    padding: 0.3rem 0.75rem !important;
    font-size: 0.8rem !important;
}

/* ØªØ­Ø³ÙŠÙ† Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
.messages-container {
    padding: 0.5rem !important;
}

/* ØªØ£Ø«ÙŠØ± Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
@keyframes slideInUser {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}
.user-entry-animation {
    animation: slideInUser 0.4s ease-out forwards;
}

/* Ø£Ù†Ù…Ø§Ø· Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù…ØªØ­Ø±Ùƒ */
@keyframes marquee-rtl {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}
.animate-marquee {
    animation: marquee-rtl 20s linear infinite;
}

/* Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
.profile-tab-btn {
    padding: 0.75rem 1rem;
    font-weight: 600;
    color: #94a3b8; /* text-slate-400 */
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
}
.profile-tab-btn.active, .profile-tab-btn:hover {
    color: #3b82f6; /* text-blue-500 */
    border-bottom-color: #3b82f6;
}

/* Ø£Ù†Ù…Ø§Ø· Ø¥Ø·Ø§Ø±Ø§Øª Ø§Ù„ØµÙˆØ± */
.frame-none { border: none; }
.frame-gold { border: 3px solid #FFD700; box-shadow: 0 0 5px #FFD700; }
.frame-silver { border: 3px solid #C0C0C0; box-shadow: 0 0 5px #C0C0C0; }
.frame-red-glow { border: 2px solid #FF4500; box-shadow: 0 0 8px #FF4500; }
.frame-blue-glow { border: 2px solid #00BFFF; box-shadow: 0 0 8px #00BFFF; }
.frame-double { border: 4px double #ffffff; }
.frame-dashed { border: 3px dashed #ffffff; }

/* Ø¥Ø·Ø§Ø±Ø§Øª Ù…ØªØ­Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø© */
.frame-rainbow {
    border: 3px solid transparent;
    border-image: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet) 1;
    animation: rainbow-border 3s linear infinite;
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
}
@keyframes rainbow-border {
    0% { filter: hue-rotate(0deg); }
    100% { filter: hue-rotate(360deg); }
}

.frame-neon-pulse {
    border: 3px solid #00ff00;
    animation: neon-pulse 1.5s ease-in-out infinite;
    box-shadow: 0 0 15px #00ff00;
}
@keyframes neon-pulse {
    0%, 100% { box-shadow: 0 0 5px #00ff00; border-color: #00ff00; }
    50% { box-shadow: 0 0 20px #00ff00, 0 0 30px #00ff00; border-color: #7fff00; }
}

.frame-fire {
    border: 3px solid #ff4500;
    animation: fire-glow 1s ease-in-out infinite;
    box-shadow: 0 0 10px #ff4500;
}
@keyframes fire-glow {
    0%, 100% { box-shadow: 0 0 10px #ff4500, 0 0 5px #ff8c00; }
    50% { box-shadow: 0 0 20px #ff4500, 0 0 10px #ff8c00; }
}

.frame-rotating {
    border: 3px dashed #3498db;
    animation: rotate-border 4s linear infinite;
}
@keyframes rotate-border {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* ØªØ¯Ø±Ø¬Ø§Øª Ø£Ù„ÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù†Øµ Ø§Ù„Ø§Ø³Ù… */
.text-gradient-rainbow {
    background: linear-gradient(to right, #ef4444, #f59e0b, #10b981, #3b82f6, #8b5cf6, #ec4899);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: bold;
}
.text-gradient-gold {
    background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: bold;
}
.text-gradient-fire {
    background: linear-gradient(to right, #f83600 0%, #f9d423 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: bold;
}
.text-gradient-ocean {
    background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: bold;
}

/* Ø£Ù„ÙˆØ§Ù† Ø£Ø³Ù…Ø§Ø¡ Ø¨Ø±Ø§Ù‚Ø© ÙˆÙ…ØªØ­Ø±ÙƒØ© */
.text-sparkle-gold {
    background: linear-gradient(90deg, #ffd700, #fff7ad, #ffd700);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shine 2s linear infinite;
    font-weight: bold;
    text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
}

.text-sparkle-rainbow {
    background: linear-gradient(to right, #ef4444, #f59e0b, #10b981, #3b82f6, #8b5cf6, #ec4899);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: rainbow-move 3s linear infinite;
    font-weight: bold;
}

.text-sparkle-blue {
    background: linear-gradient(90deg, #00d2ff, #3a7bd5, #00d2ff);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shine 2s linear infinite;
    font-weight: bold;
}

.text-sparkle-pink {
    background: linear-gradient(90deg, #ec4899, #f472b6, #ec4899);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shine 2s linear infinite;
    font-weight: bold;
}

.text-neon-pulse {
    color: #00ff00;
    text-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00;
    animation: neon-text-pulse 1.5s ease-in-out infinite alternate;
    font-weight: bold;
}
@keyframes neon-text-pulse {
    from { text-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
    to { text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00, 0 0 30px #00ff00; }
}

.text-fire-wave {
    background: linear-gradient(0deg, #f59e0b, #ef4444);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: fire-wave-anim 1s ease-in-out infinite alternate;
    font-weight: bold;
}
@keyframes fire-wave-anim {
    from { filter: brightness(1) drop-shadow(0 0 2px #ef4444); }
    to { filter: brightness(1.3) drop-shadow(0 0 5px #f59e0b); }
}

@keyframes shine {
    to { background-position: 200% center; }
}

@keyframes rainbow-move {
    0% { background-position: 0% center; }
    100% { background-position: 200% center; }
}

/* Ø¥Ø·Ø§Ø±Ø§Øª Ø¯Ø§Ø¦Ø±ÙŠØ© Ù…ØªØ­Ø±ÙƒØ© ÙˆØ¨Ø±Ø§Ù‚Ø© */
.frame-diamond-sparkle {
    border: 3px solid #b9f2ff;
    box-shadow: 0 0 10px #b9f2ff, inset 0 0 5px #b9f2ff;
    animation: diamond-pulse 2s infinite alternate;
}
@keyframes diamond-pulse {
    0% { box-shadow: 0 0 5px #b9f2ff; transform: scale(1); }
    100% { box-shadow: 0 0 15px #b9f2ff, 0 0 20px #fff; transform: scale(1.02); }
}

.frame-electric {
    border: 3px solid #00ffff;
    box-shadow: 0 0 10px #00ffff;
    animation: electric-glow 0.8s ease-in-out infinite alternate;
}
@keyframes electric-glow {
    from { box-shadow: 0 0 5px #00ffff; border-color: #00ffff; }
    to { box-shadow: 0 0 15px #00ffff, 0 0 10px #fff; border-color: #fff; }
}

.frame-magic-purple {
    border: 3px double #a855f7;
    box-shadow: 0 0 10px #a855f7;
    animation: magic-rotate 3s linear infinite;
}
@keyframes magic-rotate {
    0% { border-color: #a855f7; box-shadow: 0 0 10px #a855f7; filter: hue-rotate(0deg); }
    100% { border-color: #a855f7; box-shadow: 0 0 10px #a855f7; filter: hue-rotate(360deg); }
}

.frame-lava {
    border: 3px solid #ff4d00;
    box-shadow: 0 0 10px #ff4d00;
    animation: lava-flow 2s ease-in-out infinite;
}
@keyframes lava-flow {
    0%, 100% { border-color: #ff4d00; box-shadow: 0 0 8px #ff4d00; }
    50% { border-color: #ffcc00; box-shadow: 0 0 15px #ffcc00; }
}

.frame-royal-gold {
    border: 3px solid #ffd700;
    position: relative;
    overflow: hidden;
}
.frame-royal-gold::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent 45%, rgba(255,255,255,0.6) 50%, transparent 55%);
    animation: royal-shine 3s infinite;
}
@keyframes royal-shine {
    0% { transform: translate(-30%, -30%) rotate(0deg); }
    100% { transform: translate(30%, 30%) rotate(0deg); }
}

.frame-matrix {
    border: 3px solid #00ff00;
    box-shadow: 0 0 10px #00ff00;
    animation: matrix-pulse 1.5s steps(4) infinite;
}
@keyframes matrix-pulse {
    0%, 100% { opacity: 1; border-color: #00ff00; }
    50% { opacity: 0.7; border-color: #008800; }
}

.frame-ghostly {
    border: 2px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
    animation: ghostly-fade 2s ease-in-out infinite;
}
@keyframes ghostly-fade {
    0%, 100% { opacity: 0.5; transform: scale(0.95); }
    50% { opacity: 1; transform: scale(1.05); }
}

/* Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ù…ÙŠØ²Ø§Øª */
.color-option { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
.color-option:hover { transform: scale(1.2); }
.color-option.selected { border-color: white; transform: scale(1.1); }
        #changeBotAvatarBtn:hover { filter: brightness(1.2); cursor: pointer; }
        #changeBotAvatarBtn:hover::after { content: '\270E'; position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    <input type="file" id="botAvatarInput" class="hidden" accept="image/*" onchange="uploadBotAvatar(event)">
    <!-- Ø³Ø¨ÙŠÙ†Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loadingSpinner" class="loading-overlay hidden">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-white text-lg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù‡Ø§Ù… -->
    <div id="announcementBar" class="hidden fixed top-0 left-0 w-full bg-gradient-to-r from-red-600 to-red-800 text-white z-50 shadow-lg overflow-hidden h-10 flex items-center border-b border-red-400">
        <div class="w-full overflow-hidden relative h-full flex items-center">
            <div id="announcementText" class="whitespace-nowrap font-bold text-lg animate-marquee absolute w-full text-center"></div>
        </div>
        <button onclick="hideAnnouncementLocal()" class="absolute left-4 bg-black/20 hover:bg-black/40 rounded-full p-1 transition-colors z-10">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>

    <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginPage" class="hidden min-h-screen flex items-center justify-center px-4 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 via-gray-900 to-black relative overflow-hidden">
        <!-- Ø¹Ù†Ø§ØµØ± Ø¯ÙŠÙƒÙˆØ± Ø®Ù„ÙÙŠØ© -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
            <div class="absolute -top-[10%] -left-[10%] w-[40%] h-[40%] bg-blue-600/20 blur-[120px] rounded-full animate-pulse"></div>
            <div class="absolute -bottom-[10%] -right-[10%] w-[40%] h-[40%] bg-purple-600/20 blur-[120px] rounded-full animate-pulse" style="animation-delay: 2s;"></div>
        </div>

        <div class="bg-gray-900/40 backdrop-blur-xl rounded-[2.5rem] p-8 max-w-md w-full border border-white/10 shadow-[0_20px_50px_rgba(0,0,0,0.5)] transform transition-all duration-500 hover:shadow-blue-500/10">
            <div class="text-center mb-10">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-tr from-blue-600 to-purple-600 rounded-3xl shadow-lg shadow-blue-500/30 mb-6 rotate-3 hover:rotate-0 transition-transform duration-300">
                    <span class="text-4xl">ğŸ’¬</span>
                </div>
                <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400 mb-2 tracking-tight">WalChat</h1>
                <p class="text-slate-400 font-medium">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ø¬ØªÙ…Ø¹Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„Ø¢Ù…Ù†</p>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ -->
            <div class="flex bg-black/40 backdrop-blur-md rounded-2xl p-1.5 mb-8 border border-white/5">
                <button id="loginTab" class="tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 bg-gradient-to-r from-blue-600 to-blue-500 text-white shadow-lg">
                    ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
                </button>
                <button id="registerTab" class="tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white">
                    Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
                </button>
                <button id="guestTab" class="tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white">
                    Ø¯Ø®ÙˆÙ„ Ø²Ø§Ø¦Ø±
                </button>
            </div>

            <!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
            <form id="loginForm" class="form-container space-y-5">
                <div class="group">
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1 transition-colors group-focus-within:text-blue-400">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        </span>
                        <input type="text" id="loginUsername" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" required 
                            class="w-full bg-white/5 border border-white/10 rounded-2xl pl-12 pr-4 py-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:bg-white/10 transition-all duration-300">
                    </div>
                </div>

                <div class="group">
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1 transition-colors group-focus-within:text-blue-400">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        </span>
                        <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required 
                            class="w-full bg-white/5 border border-white/10 rounded-2xl pl-12 pr-4 py-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:bg-white/10 transition-all duration-300">
                    </div>
                </div>

                <div class="flex items-center justify-between px-1">
                    <label class="flex items-center cursor-pointer group">
                        <input type="checkbox" id="rememberMe" class="hidden">
                        <div class="w-5 h-5 border-2 border-white/20 rounded-md mr-3 flex items-center justify-center group-hover:border-blue-500 transition-all duration-200" id="rememberMeCustom">
                            <div class="w-2.5 h-2.5 bg-blue-500 rounded-sm scale-0 transition-transform duration-200"></div>
                        </div>
                        <span class="text-slate-400 text-sm font-medium select-none">ØªØ°ÙƒØ±Ù†ÙŠ</span>
                    </label>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-black py-4 px-4 rounded-2xl transition-all duration-300 transform active:scale-[0.98] shadow-lg shadow-blue-500/25">
                    Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†
                </button>
            </form>

            <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ -->
            <form id="registerForm" class="form-container hidden space-y-5">
                <div class="group">
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1 group-focus-within:text-green-400">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                    <input type="text" id="registerUsername" placeholder="Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±" required 
                        class="w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:bg-white/10 transition-all duration-300">
                </div>

                <div class="group">
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1 group-focus-within:text-green-400">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
                    <input type="password" id="registerPassword" placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ø³Ø± Ù‚ÙˆÙŠØ©" required 
                        class="w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:bg-white/10 transition-all duration-300">
                </div>

                <div class="group">
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1 group-focus-within:text-green-400">Ø§Ù„Ø¬Ù†Ø³</label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="relative flex items-center justify-center bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl p-4 cursor-pointer transition-all duration-300 group/item overflow-hidden">
                            <input type="radio" name="gender" value="male" required class="absolute inset-0 opacity-0 cursor-pointer z-10 peer">
                            <div class="absolute inset-0 bg-blue-600/20 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                            <span class="text-white relative z-20 font-bold peer-checked:text-blue-400">ğŸ‘¨ Ø°ÙƒØ±</span>
                        </label>
                        <label class="relative flex items-center justify-center bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl p-4 cursor-pointer transition-all duration-300 group/item overflow-hidden">
                            <input type="radio" name="gender" value="female" required class="absolute inset-0 opacity-0 cursor-pointer z-10 peer">
                            <div class="absolute inset-0 bg-pink-600/20 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                            <span class="text-white relative z-20 font-bold peer-checked:text-pink-400">ğŸ‘© Ø£Ù†Ø«Ù‰</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-emerald-500 hover:from-green-500 hover:to-emerald-400 text-white font-black py-4 px-4 rounded-2xl transition-all duration-300 transform active:scale-[0.98] shadow-lg shadow-green-500/25">
                    Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
                </button>
            </form>

            <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¯Ø®ÙˆÙ„ Ø²Ø§Ø¦Ø± -->
            <form id="guestForm" class="form-container hidden space-y-5">
                <div class="group">
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1 group-focus-within:text-purple-400">Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø¦Ø±</label>
                    <input type="text" id="guestUsername" placeholder="ÙƒÙŠÙ ØªÙˆØ¯ Ø£Ù† Ù†Ù†Ø§Ø¯ÙŠÙƒØŸ" required 
                        class="w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:bg-white/10 transition-all duration-300">
                </div>

                <div class="group">
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1 group-focus-within:text-purple-400">Ø§Ù„Ø¬Ù†Ø³</label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="relative flex items-center justify-center bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl p-4 cursor-pointer transition-all duration-300 group/item overflow-hidden">
                            <input type="radio" name="guestGender" value="male" required class="absolute inset-0 opacity-0 cursor-pointer z-10 peer">
                            <div class="absolute inset-0 bg-blue-600/20 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                            <span class="text-white relative z-20 font-bold peer-checked:text-blue-400">ğŸ‘¨ Ø°ÙƒØ±</span>
                        </label>
                        <label class="relative flex items-center justify-center bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl p-4 cursor-pointer transition-all duration-300 group/item overflow-hidden">
                            <input type="radio" name="guestGender" value="female" required class="absolute inset-0 opacity-0 cursor-pointer z-10 peer">
                            <div class="absolute inset-0 bg-pink-600/20 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                            <span class="text-white relative z-20 font-bold peer-checked:text-pink-400">ğŸ‘© Ø£Ù†Ø«Ù‰</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-indigo-500 hover:from-purple-500 hover:to-indigo-400 text-white font-black py-4 px-4 rounded-2xl transition-all duration-300 transform active:scale-[0.98] shadow-lg shadow-purple-500/25">
                    Ø¯Ø®ÙˆÙ„ Ø³Ø±ÙŠØ¹
                </button>
            </form>

            <div class="mt-8 text-center">
                <div class="flex items-center justify-center space-x-2 space-x-reverse text-xs text-slate-500">
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                    <span>${onlineUsersCount.textContent || '0'} Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="mainPage" class="hidden min-h-screen">
        <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <header class="bg-gray-900/80 backdrop-blur-lg border-b border-gray-700 p-4 flex justify-between items-center">
            <div></div> <!-- Ø¹Ù†ØµØ± ÙØ§Ø±Øº Ù„Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙŠØ³Ø±Ù‰ -->
            <h1 id="welcomeMessage" class="text-2xl font-bold text-white">ğŸ  ØºØ±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h1>
<!-- Ø²Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - Ø³ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡ -->
<div class="relative hidden">
    <button id="postsButton" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors relative">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <span id="postsBadge" class="notification-badge hidden">0</span>
    </button>
</div>

                <div class="flex items-center space-x-4 space-x-reverse">
<button onclick="openDrawingBoard()" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors" title="Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø³Ù…">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
    </svg>
</button>
                <!-- Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ - Ø³ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡ -->
                <div class="relative hidden">
    <button id="messagesButton" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors relative">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
        </svg>
        <span id="messagesBadge" class="notification-badge hidden">0</span>
        <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
        <div id="notificationsDropdown" class="hidden absolute top-full left-0 mt-2 w-72 bg-slate-800 rounded-lg shadow-lg border border-slate-700 z-50">
            <div class="p-3 border-b border-slate-700">
                <h3 class="text-white font-semibold">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
            </div>
            <div id="notificationsList" class="p-2 max-h-80 overflow-y-auto custom-scrollbar">
                <!-- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
            </div>
        </div>
    </button>
</div>
                
                <!-- Ø²Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ - Ø³ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡ -->
                <button id="friendsButton" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                </button>
                
                <!-- Ø²Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
                <button id="profileButton" class="user-profile-btn flex items-center space-x-2 space-x-reverse bg-gray-800 hover:bg-gray-700 rounded-full pl-3 pr-2 py-1 transition-colors">
                    <span class="text-white text-sm font-medium" id="headerUsername"></span>
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white">
                        <span id="headerAvatarInitial"></span>
                    </div>
                </button>
                
                <!-- Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ -->
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-full font-semibold transition-colors flex items-center space-x-2 space-x-reverse text-sm">
                    <span>Ø®Ø±ÙˆØ¬</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 01-3-3h4a3 3 0 013 3v1"></path>
                    </svg>
                </button>
            </div>
        </header>
       
        <div class="container mx-auto px-4 py-8">
            <div class="text-center mb-12">
                <p class="text-xl text-slate-300">Ø§Ø®ØªØ± ØºØ±ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„ÙŠÙ‡Ø§</p>
            </div>
           
            <div id="roomsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 max-w-7xl mx-auto">
                <!-- Ø§Ù„ØºØ±Ù Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
    <div id="chatPage" class="hidden h-screen flex flex-col overflow-hidden">
        <!-- Ø±Ø£Ø³ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
        <div class="bg-gray-900/90 backdrop-blur-lg border-b border-gray-700 py-2 px-4 relative z-30 md:z-40 chat-header-mobile">
            <div class="container mx-auto flex items-center justify-between flex-wrap md:flex-nowrap">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <button onclick="goBack()" class="text-slate-300 hover:text-blue-500 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </button>
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <div id="chatIcon" class="text-3xl"></div>
                        <div>
                            <h2 id="chatTitle" class="text-xl font-semibold text-white"></h2>
                            <p class="text-sm text-slate-400">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2 space-x-reverse mt-2 md:mt-0 chat-header-buttons">
                    <!-- Ø²Ø± ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø§Ù„Ùƒ -->
                    <button id="adminControlRoomBtn" onclick="openControlPanel()" class="hidden text-white p-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors" title="ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ…">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                    <!-- Ø²Ø± Ù„Ø¹Ø¨Ø© XO -->
                    <a href="https://xo-game-6m3e.onrender.com/" target="_blank" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors" title="Ù„Ø¹Ø¨Ø© XO">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </a>
                    <!-- Ø²Ø± Ø§Ù„Ù…ØªØ¬Ø± -->
                    <button id="shopButton" onclick="openShopModal()" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors" title="Ø§Ù„Ù…ØªØ¬Ø±">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </button>
                    <button onclick="openDrawingBoard()" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors" title="Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø³Ù…">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
                        </svg>
                    </button>
                    <!-- Ø²Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
<button id="chatPostsButton" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors relative">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
    </svg>
    <span id="chatPostsBadge" class="notification-badge hidden">0</span>
</button>
                    <!-- Ø²Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙØ§Ø¹Ù„ÙŠÙ† -->
                    <button id="topUsersButton" onclick="openTopUsersModal()" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors" title="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙØ§Ø¹Ù„ÙŠÙ†">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14v6m-3-3h6M6 10h2a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10 0h2a2 2 0 002-2V6a2 2 0 00-2-2h-2a2 2 0 00-2 2v2a2 2 0 002 2zM6 20h2a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                    <!-- Ø²Ø± Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
    <button id="chatFriendsButton" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
    </button>
                    <!-- Ø²Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ© -->
                    <button id="roomInfoButton" onclick="openRoomInfo()" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors" title="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ©">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                    <!-- Ø²Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ© (Ø§Ù„Ø¨Ø±ÙŠØ¯) -->
    <div class="relative" id="chatMessagesButtonContainer">
        <button id="chatMessagesButton" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors relative">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            <span id="chatMessagesBadge" class="notification-badge hidden"></span>
        </button>
        <div id="privateConversationsDropdown" class="hidden absolute top-full left-0 mt-2 w-72 bg-slate-800 rounded-lg shadow-lg border border-slate-700 z-50">
            <div class="p-3 border-b border-slate-700">
                <h3 class="text-white font-semibold">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø®Ø§ØµØ©</h3>
            </div>
            <div id="privateConversationsList" class="p-2 max-h-80 overflow-y-auto custom-scrollbar">
                <!-- Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
            </div>
        </div>
    </div>
                    <!-- Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ø§Ù„Ø¬Ø±Ø³) -->
    <div class="relative" id="chatNotificationsButtonContainer">
        <button id="chatNotificationsButton" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors relative">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
            </svg>
            <span id="chatNotificationsBadge" class="notification-badge hidden"></span>
        </button>
        <div id="chatNotificationsDropdown" class="hidden absolute top-full left-0 mt-2 w-72 bg-slate-800 rounded-lg shadow-lg border border-slate-700 z-50">
            <div class="p-3 border-b border-slate-700">
                <h3 class="text-white font-semibold">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
            </div>
            <div id="chatNotificationsList" class="p-2 max-h-80 overflow-y-auto custom-scrollbar">
                <!-- Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
            </div>
        </div>
    </div>
                    <button id="toggleUsersButton" class="md:hidden text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
    </button>
    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
    <span class="text-white text-sm">Ù†Ø´Ø·</span>
</div>
            </div>
        </div>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† (Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©) -->
            <div id="onlineUsersPanel" class="hidden md:block w-80 bg-gray-800/70 backdrop-blur-lg border-l border-gray-700 p-4 users-container custom-scrollbar">
                <h3 class="text-white font-bold mb-4 flex items-center space-x-2 space-x-reverse">
                    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                    <span>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†</span>
                    <span id="onlineUsersCount" class="bg-blue-600 text-white text-xs px-2 py-1 rounded-full">0</span>
                </h3>
        
                <div id="onlineUsersList" class="space-y-3">
                    <!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ù… Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
            </div>

            <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
            <div class="flex-1 flex flex-col overflow-hidden pt-4 relative">
                <div id="messagesContainer" class="w-full max-w-5xl mr-0 ml-auto space-y-4 messages-container custom-scrollbar pb-4 px-4">
                    <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                </div>
            </div>
            
            <!-- Ø²Ø± Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ù„Ù„Ø¬ÙˆØ§Ù„ -->
            <div id="usersOverlay" class="users-overlay" onclick="toggleUsersList()"></div>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
        <div id="messageArea" class="bg-gray-900/90 backdrop-blur-lg border-t border-gray-700 py-2 px-4">
            <div class="container mx-auto max-w-4xl">
                <!-- Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ØªØ¨ -->
                <div id="rankManagementPanel" class="hidden mb-4 bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-xl p-4 border border-purple-500/50">
                    <h3 class="text-white font-bold mb-3 flex items-center space-x-2 space-x-reverse">
                        <span>ğŸ‘‘</span>
                        <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ØªØ¨</span>
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-white text-sm font-semibold mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                            <input 
                                type="text"
                                id="rankUserName"
                                placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..."
                                class="w-full bg-gray-700 border border-purple-300/50 rounded-lg px-4 py-2 text-white placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                            >
                        </div>
                        <div>
                            <label class="block text-white text-sm font-semibold mb-2">Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                            <select 
                                id="rankSelect"
                                class="w-full bg-gray-700 border border-purple-300/50 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-400"
                            >
                                <option value="" class="bg-gray-900">Ø§Ø®ØªØ± Ø§Ù„Ø±ØªØ¨Ø©...</option>
                                <option value="Ø¬ÙŠØ¯" class="bg-gray-900">â‡ï¸ Ø¬ÙŠØ¯</option>
                                <option value="Ø¨Ø±ÙŠÙ…ÙŠÙˆÙ…" class="bg-gray-900">ğŸ’ Ø¨Ø±ÙŠÙ…ÙŠÙˆÙ…</option>
                                <option value="Ø§Ø¯Ù…Ù†" class="bg-gray-900">ğŸ›¡ï¸ Ø§Ø¯Ù…Ù†</option>
                                <option value="Ø³ÙˆØ¨Ø± Ø§Ø¯Ù…Ù†" class="bg-gray-900">â­ Ø³ÙˆØ¨Ø± Ø§Ø¯Ù…Ù†</option>
                                <option value="Ù…Ù†Ø´Ø¦" class="bg-gray-900">ğŸ‘‘ Ù…Ù†Ø´Ø¦</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex space-x-4 space-x-reverse">
                        <button 
                            onclick="assignRank()"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                        >
                            <span>Ù…Ù†Ø­ Ø§Ù„Ø±ØªØ¨Ø©</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                        <button 
                            onclick="removeRank()"
                            class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                        >
                            <span>Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±ØªØ¨Ø©</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                            </svg>
                        </button>
                        <button
                            onclick="showAllRanks()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                        >
                            <span>Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ØªØ¨</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
                <div id="userManagementPanel" class="hidden mb-4 bg-gradient-to-r from-red-900/30 to-orange-900/30 rounded-xl p-4 border border-red-500/50">
                    <h3 class="text-white font-bold mb-3 flex items-center space-x-2 space-x-reverse">
                        <span>ğŸ‘‘</span>
                        <span id="managementTitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-white text-sm font-semibold mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                            <input 
                                type="text"
                                id="managedUserName"
                                placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..."
                                class="w-full bg-gray-700 border border-red-300/50 rounded-lg px-4 py-2 text-white placeholder-red-300 focus:outline-none focus:ring-2 focus:ring-red-400"
                            >
                        </div>
                        <div>
                            <label class="block text-white text-sm font-semibold mb-2">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</label>
                            <select 
                                id="userActionSelect"
                                class="w-full bg-gray-700 border border-red-300/50 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-red-400"
                                onchange="toggleManagementFields()"
                            >
                                <option value="" class="bg-gray-900">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡...</option>
                                <option value="mute" class="bg-gray-900">ğŸ”‡ ÙƒØªÙ…</option>
                                <option value="unmute" class="bg-gray-900">ğŸ”Š Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒØªÙ…</option>
                                <option value="banFromRoom" class="bg-gray-900">ğŸš« Ø­Ø¸Ø± Ù…Ù† Ø§Ù„ØºØ±ÙØ©</option>
                                <option value="unbanFromRoom" class="bg-gray-900">âœ… Ø¥Ø²Ø§Ù„Ø© Ø­Ø¸Ø± Ø§Ù„ØºØ±ÙØ©</option>
                                <option value="banFromSite" class="bg-gray-900">â›” Ø­Ø¸Ø± Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹</option>
                                <option value="unbanFromSite" class="bg-gray-900">ğŸŒ Ø¥Ø²Ø§Ù„Ø© Ø­Ø¸Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹</option>
                                <option value="deleteUser" class="bg-gray-900">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</option>
                                <option value="showStatus" class="bg-gray-900">ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø©</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="durationField" class="hidden mb-4">
                        <label class="block text-white text-sm font-semibold mb-2">Ù…Ø¯Ø© Ø§Ù„ÙƒØªÙ… (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                        <input 
                            type="number"
                            id="muteDuration"
                            placeholder="Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚..."
                            min="1"
                            class="w-full bg-gray-700 border border-red-300/50 rounded-lg px-4 py-2 text-white placeholder-red-300 focus:outline-none focus:ring-2 focus:ring-red-400"
                        >
                    </div>
                    
                    <div id="reasonField" class="hidden mb-4">
                        <label class="block text-white text-sm font-semibold mb-2">Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input 
                            type="text"
                            id="banReason"
                            placeholder="Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø±..."
                            class="w-full bg-gray-700 border border-red-300/50 rounded-lg px-4 py-2 text-white placeholder-red-300 focus:outline-none focus:ring-2 focus:ring-red-400"
                        >
                    </div>
                    
                    <div class="flex space-x-4 space-x-reverse">
                        <button 
                            onclick="manageUser()"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                        >
                            <span>ØªÙ†ÙÙŠØ°</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </button>
                        <button 
                            onclick="clearManagementFields()"
                            class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                        >
                            <span>Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- Ø­Ø§ÙˆÙŠØ© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ù„Ø±Ø¯ -->
                <div class="relative">
                    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ÙŠÙ…ÙˆØ¬ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© -->
                    <div id="emojiPicker" class="emoji-picker custom-scrollbar"></div>

                    <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¯ -->
                    <div id="replyPreview" class="hidden mb-2 bg-gray-700 rounded-lg p-2 max-w-4xl mx-auto relative z-20">
                        <div class="flex justify-between items-center">
                            <div class="text-xs text-white overflow-hidden">
                                <div class="font-semibold">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ <span id="replyUsername"></span></div>
                                <p id="replyContent" class="truncate opacity-70"></p>
                            </div>
                            <button onclick="cancelReply()" class="text-white hover:text-red-400 p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div id="messageInputContainer" class="flex space-x-4 space-x-reverse relative z-10">
                        <input 
                        type="text"
                        id="messageInput"
                        placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."
                        class="flex-1 bg-gray-800 border border-gray-700 rounded-full px-6 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-colors"
                        onkeypress="handleKeyPress(event)"
                        oninput="checkMessageLength()"
                        style="text-align: start; direction: rtl; padding-left: 20px; position: relative; z-index: 10;"
                    >                      
                        <button 
                            id="sendMessageButton"
                            onclick="sendMessage()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full font-semibold transition-colors flex items-center space-x-2 space-x-reverse disabled:bg-gray-500 disabled:cursor-not-allowed"
                        >
                            <span>Ø¥Ø±Ø³Ø§Ù„</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
    <div id="profileModal" class="profile-modal">
        <div id="profileContent" class="profile-content custom-scrollbar relative">
            <!-- Ø±Ø£Ø³ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
            <div id="profileHeader" class="relative h-64 w-full bg-gray-800 border-b border-gray-700/50 overflow-hidden">
                 <!-- ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù -->
                 <div class="absolute inset-0 z-0">
                    <img id="profileCoverDisplay" src="" class="w-full h-full object-cover hidden">
                 </div>

                 <button onclick="closeProfileModal()" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 transition-colors z-20 bg-black/20 rounded-full p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© -->
                <div id="profileMenuContainer" class="absolute top-4 left-4 z-20">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>

                <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© -->
                <div class="absolute bottom-0 right-0 w-full p-4 flex items-end space-x-4 space-x-reverse z-10">
                    <!-- Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© -->
                    <div class="relative group flex-shrink-0">
                        <div id="profileAvatarFrame" class="w-24 h-24 rounded-full relative">
                            <img id="profileAvatar" src="" class="w-full h-full rounded-full object-cover border-4 border-gray-800 shadow-xl transition-transform duration-300 group-hover:scale-105">
                        </div>
                        <!-- Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø© (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨) -->
                        <button id="changeProfilePicBtn" onclick="openImageUploadForProfile()" class="hidden absolute bottom-0 right-0 bg-blue-600 hover:bg-blue-700 text-white p-1.5 rounded-full shadow-lg transition-all duration-200 transform hover:scale-110 border-2 border-gray-800" title="ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </button>
                        <!-- Ø²Ø± Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© -->
                        <button id="removeProfilePicBtn" onclick="removeProfilePic()" class="hidden absolute bottom-0 left-0 bg-red-600 hover:bg-red-700 text-white p-1.5 rounded-full shadow-lg transition-all duration-200 transform hover:scale-110 border-2 border-gray-800" title="Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        <!-- Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„ØºÙ„Ø§Ù (Ø¬Ø¯ÙŠØ¯) -->
                        <button id="changeCoverBtn" onclick="openCoverUpload()" class="hidden absolute top-0 right-0 -mt-1 -mr-1 bg-gray-800/80 hover:bg-gray-700 text-white p-1.5 rounded-full shadow-lg transition-all duration-200 border border-gray-600 z-20" title="ØªØºÙŠÙŠØ± Ø§Ù„ØºÙ„Ø§Ù">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </button>
                        <!-- Ø²Ø± Ø­Ø°Ù Ø§Ù„ØºÙ„Ø§Ù -->
                        <button id="removeCoverBtn" onclick="removeCover()" class="hidden absolute top-0 left-0 -mt-1 -ml-1 bg-red-600/80 hover:bg-red-700 text-white p-1.5 rounded-full shadow-lg transition-all duration-200 border border-gray-600 z-20" title="Ø­Ø°Ù Ø§Ù„ØºÙ„Ø§Ù">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <!-- Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†ØµÙŠØ© -->
                    <div class="flex-1 mb-1 text-right">
                        <h2 id="profileUsername" class="text-2xl font-bold text-white tracking-wide drop-shadow-md"></h2>
                        <div class="flex items-center gap-2 mt-1">
                            <div id="profileRank" class="inline-block px-3 py-0.5 rounded-full text-xs font-semibold text-white shadow-sm"></div>
                            <div id="profileStatus" class="flex items-center space-x-1 space-x-reverse bg-gray-800/60 inline-flex px-2 py-0.5 rounded-full border border-gray-700/50 backdrop-blur-sm">
                                <span class="w-2 h-2 rounded-full"></span>
                                <span class="text-xs text-blue-200"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
            <div class="flex border-b border-gray-700/50 px-2 overflow-x-auto whitespace-nowrap custom-scrollbar">
                <button onclick="switchProfileTab(event, 'details')" class="profile-tab-btn active">ØªÙØ§ØµÙŠÙ„</button>
                <button onclick="switchProfileTab(event, 'friends')" class="profile-tab-btn">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</button>
                <button onclick="switchProfileTab(event, 'achievements')" class="profile-tab-btn">ğŸ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</button>
                <button id="featuresTabButton" onclick="switchProfileTab(event, 'features')" class="profile-tab-btn hidden">Ù…ÙŠØ²Ø§Øª ğŸŒŸ</button>
                <button id="accountTabButton" onclick="switchProfileTab(event, 'account')" class="profile-tab-btn hidden">Ø­ÙˆÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
            </div>

            <div id="profileBody" class="p-6 bg-gray-900/50">
                <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
                <div id="profileTab-details" class="profile-tab-content">
                    <!-- Ø§Ù„Ø¬Ù†Ø³ -->
                    <div class="bg-gray-800/50 rounded-xl p-3 mb-4 border border-gray-700/30 flex items-center justify-between">
                        <span class="text-slate-400 text-sm">Ø§Ù„Ø¬Ù†Ø³</span>
                        <span id="profileGender" class="text-white font-medium text-sm"></span>
                    </div>

                    <!-- Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ù…Ø³ØªÙˆÙ‰ -->
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-gray-800/80 rounded-xl p-4 border border-gray-700/50 hover:border-yellow-500/30 transition-colors group">
                            <div class="text-yellow-400 text-3xl mb-1 group-hover:scale-110 transition-transform duration-200">â­</div>
                            <div class="text-white font-bold text-lg" id="profilePoints">0</div>
                            <div class="text-slate-400 text-xs font-medium">Ø§Ù„Ù†Ù‚Ø§Ø·</div>
                        </div>
                        <div class="bg-gray-800/80 rounded-xl p-4 border border-gray-700/50 hover:border-green-500/30 transition-colors group">
                            <div class="text-green-400 text-3xl mb-1 group-hover:scale-110 transition-transform duration-200">ğŸ“ˆ</div>
                            <div class="text-white font-bold text-lg" id="profileLevel">1</div>
                            <div class="text-slate-400 text-xs font-medium">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div>
                        </div>
                    </div>

                    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù„Ù„Ø²ÙˆØ§Ø± -->
                    <div id="visitorActions" class="space-y-3 pt-6">
                        <button id="privateChatButton" onclick="startPrivateChat()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-900/20 transition-all duration-200 transform hover:-translate-y-0.5 flex items-center justify-center space-x-2 space-x-reverse">
                            <span>Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ©</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        </button>
                        <button id="addFriendButton" onclick="sendFriendRequest()" class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-green-900/20 transition-all duration-200 transform hover:-translate-y-0.5 flex items-center justify-center space-x-2 space-x-reverse">
                            <span>Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                        </button>
                        <button id="sendPointsButton" onclick="sendPoints()" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-500 hover:to-purple-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-purple-900/20 transition-all duration-200 transform hover:-translate-y-0.5 flex items-center justify-center space-x-2 space-x-reverse">
                            <span>Ø¥Ø±Ø³Ø§Ù„ Ù†Ù‚Ø§Ø·</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-1V4m0 2v1m0 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        </button>
                    </div>

                    <div class="text-center pt-6" id="bioSection">
                        <h3 class="text-sm font-bold text-slate-300 mb-3 flex items-center justify-center gap-2">
                            <span>ğŸ“</span> Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠ
                        </h3>
                        <div id="bioContainer" class="relative text-slate-300 text-sm bg-gray-900/50 rounded-lg p-4 min-h-[120px] whitespace-pre-wrap border border-gray-700/50 w-full">
                            <p id="profileBio" class="text-center leading-relaxed"></p>
                            <textarea id="profileBioInput" class="hidden w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø´ÙŠØ¦Ø§Ù‹ Ø¹Ù† Ù†ÙØ³Ùƒ..." oninput="updateBioCharCount()"></textarea>
                            <div id="bioCharCounter" class="hidden absolute bottom-2 left-3 text-xs text-gray-400">0 / 500</div>
                        </div>
                        <div id="editBioButtons" class="mt-3 space-x-2 space-x-reverse">
                            <button id="editBioButton" onclick="toggleBioEdit(true)" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-full text-sm font-semibold transition-colors">
                                ØªØ¹Ø¯ÙŠÙ„
                            </button>
                            <button id="saveBioButton" onclick="saveBio()" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded-full text-sm font-semibold transition-colors">
                                Ø­ÙØ¸
                            </button>
                            <button id="cancelBioButton" onclick="toggleBioEdit(false)" class="hidden bg-gray-600 hover:bg-gray-700 text-white px-4 py-1 rounded-full text-sm font-semibold transition-colors">
                                Ø¥Ù„ØºØ§Ø¡
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ (Ø¬Ø¯ÙŠØ¯) -->
                <div id="profileTab-friends" class="profile-tab-content hidden">
                    <div id="profileFriendsList" class="grid grid-cols-3 gap-3">
                        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ù‡Ù†Ø§ -->
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª (Ø¬Ø¯ÙŠØ¯) -->
                <div id="profileTab-achievements" class="profile-tab-content hidden">
                    <div class="mb-4">
                        <h3 class="text-sm font-bold text-slate-300 mb-4 flex items-center gap-2">
                            <span>ğŸ†</span> Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª ÙˆØ§Ù„Ø£ÙˆØ³Ù…Ø©
                        </h3>
                        <div id="profileAchievementsList" class="space-y-3">
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ù‡Ù†Ø§ -->
                        </div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ù…ÙŠØ²Ø§Øª (Ù„Ù„Ø±ØªØ¨ Ø§Ù„Ø¹Ø§Ù„ÙŠØ©) -->
                <div id="profileTab-features" class="profile-tab-content hidden space-y-6">
                    <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙØ±Ø¹ÙŠØ© Ù„Ù„Ù…ÙŠØ²Ø§Øª -->
                    <div class="flex justify-center space-x-1 space-x-reverse bg-gray-800/50 p-1 rounded-lg mb-4">
                        <button onclick="switchFeatureSubTab('nameColor')" class="feature-sub-btn flex-1 py-1 px-2 rounded text-xs font-semibold bg-blue-600 text-white" id="btn-nameColor">Ù„ÙˆÙ† Ø§Ù„Ø§Ø³Ù…</button>
                        <button onclick="switchFeatureSubTab('nameBackground')" class="feature-sub-btn flex-1 py-1 px-2 rounded text-xs font-semibold text-slate-400 hover:bg-gray-700" id="btn-nameBackground">Ø®Ù„ÙÙŠØ© Ø§Ù„Ø§Ø³Ù…</button>
                        <button onclick="switchFeatureSubTab('avatarFrame')" class="feature-sub-btn flex-1 py-1 px-2 rounded text-xs font-semibold text-slate-400 hover:bg-gray-700" id="btn-avatarFrame">Ø¥Ø·Ø§Ø± Ø§Ù„ØµÙˆØ±Ø©</button>
                        <button onclick="switchFeatureSubTab('userCardBackground')" class="feature-sub-btn flex-1 py-1 px-2 rounded text-xs font-semibold text-slate-400 hover:bg-gray-700" id="btn-userCardBackground">Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
                         <button onclick="switchFeatureSubTab('profileBackground')" class="feature-sub-btn flex-1 py-1 px-2 rounded text-xs font-semibold text-slate-400 hover:bg-gray-700" id="btn-profileBackground">Ù„ÙˆÙ† Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>
                        <button onclick="switchFeatureSubTab('nameCardBorder')" class="feature-sub-btn flex-1 py-1 px-2 rounded text-xs font-semibold text-slate-400 hover:bg-gray-700" id="btn-nameCardBorder">Ø¥Ø·Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
                        <button onclick="switchFeatureSubTab('changeName')" class="feature-sub-btn flex-1 py-1 px-2 rounded text-xs font-semibold text-slate-400 hover:bg-gray-700" id="btn-changeName">ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</button>
                    </div>

                    <!-- Ù…Ø­ØªÙˆÙ‰ Ù„ÙˆÙ† Ø§Ù„Ø§Ø³Ù… -->
                    <div id="feature-nameColor" class="feature-content">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">Ø§Ø®ØªØ± Ù„ÙˆÙ† Ù„Ø§Ø³Ù…Ùƒ:</h4>
                        <div class="grid grid-cols-6 gap-3 justify-items-center mb-4" id="nameColorGrid">
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
                        </div>
                        <div class="border-t border-gray-700 pt-3">
                            <h4 class="text-xs font-bold text-slate-400 mb-2">ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ Ø£Ùˆ Ù„ÙˆÙ† Ù…Ø®ØµØµ:</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="selectFeature('nameColor', 'text-gradient-rainbow')" class="py-1 px-2 rounded bg-gradient-to-r from-red-500 via-green-500 to-blue-500 text-white text-[10px] font-bold">Ù‚ÙˆØ³ Ù‚Ø²Ø­</button>
                                <button onclick="selectFeature('nameColor', 'text-gradient-gold')" class="py-1 px-2 rounded bg-gradient-to-r from-yellow-600 to-yellow-200 text-black text-[10px] font-bold">Ø°Ù‡Ø¨ÙŠ Ù…Ù„ÙƒÙŠ</button>
                                <button onclick="selectFeature('nameColor', 'text-gradient-fire')" class="py-1 px-2 rounded bg-gradient-to-r from-red-600 to-orange-400 text-white text-[10px] font-bold">Ù†Ø§Ø±ÙŠ</button>
                                <button onclick="selectFeature('nameColor', 'text-gradient-ocean')" class="py-1 px-2 rounded bg-gradient-to-r from-blue-400 to-cyan-300 text-white text-[10px] font-bold">Ù…Ø­ÙŠØ·</button>
                                <button onclick="selectFeature('nameColor', 'text-sparkle-gold')" class="py-1 px-2 rounded text-sparkle-gold text-[10px] font-bold bg-black/40">Ø¨Ø±ÙŠÙ‚ Ø°Ù‡Ø¨ÙŠ âœ¨</button>
                                <button onclick="selectFeature('nameColor', 'text-sparkle-rainbow')" class="py-1 px-2 rounded text-sparkle-rainbow text-[10px] font-bold bg-black/40">Ø¨Ø±ÙŠÙ‚ Ù‚ÙˆØ³ Ù‚Ø²Ø­ ğŸŒˆ</button>
                                <button onclick="selectFeature('nameColor', 'text-sparkle-blue')" class="py-1 px-2 rounded text-sparkle-blue text-[10px] font-bold bg-black/40">Ø¨Ø±ÙŠÙ‚ Ø£Ø²Ø±Ù‚ ğŸ’</button>
                                <button onclick="selectFeature('nameColor', 'text-sparkle-pink')" class="py-1 px-2 rounded text-sparkle-pink text-[10px] font-bold bg-black/40">Ø¨Ø±ÙŠÙ‚ ÙˆØ±Ø¯ÙŠ âœ¨</button>
                                <button onclick="selectFeature('nameColor', 'text-neon-pulse')" class="py-1 px-2 rounded text-neon-pulse text-[10px] font-bold bg-black/40">Ù†ÙŠÙˆÙ† Ù†Ø§Ø¨Ø¶ ğŸ”‹</button>
                                <button onclick="selectFeature('nameColor', 'text-fire-wave')" class="py-1 px-2 rounded text-fire-wave text-[10px] font-bold bg-black/40">Ù…ÙˆØ¬Ø© Ù†Ø§Ø±ÙŠØ© ğŸ”¥</button>
                            </div>
                            <div class="mt-3 flex items-center justify-between bg-gray-800/50 p-2 rounded-lg">
                                <span class="text-[10px] text-slate-300">Ù„ÙˆÙ† Ù…Ø®ØµØµ (Ù…Ø²Ø¬):</span>
                                <input type="color" id="customNameColorPicker" onchange="applyCustomColor('nameColor', this.value)" class="w-8 h-6 bg-transparent cursor-pointer">
                            </div>
                        </div>
                    </div>

                    <!-- Ù…Ø­ØªÙˆÙ‰ Ø®Ù„ÙÙŠØ© Ø§Ù„Ø§Ø³Ù… -->
                    <div id="feature-nameBackground" class="feature-content hidden">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">Ø§Ø®ØªØ± Ø®Ù„ÙÙŠØ© Ù„Ø§Ø³Ù…Ùƒ (ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„):</h4>
                        <div class="grid grid-cols-4 gap-3" id="nameBackgroundGrid">
                            <div onclick="selectFeature('nameBackground', null)" class="cursor-pointer p-2 rounded text-center border border-gray-600 hover:border-white text-xs">Ø¨Ø¯ÙˆÙ† Ø®Ù„ÙÙŠØ©</div>
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
                        </div>
                        <div class="mt-4 p-3 bg-gray-800 rounded-lg text-center">
                            <p class="text-xs text-slate-400 mb-1">Ù…Ø¹Ø§ÙŠÙ†Ø©:</p>
                            <span id="nameBackgroundPreview" class="px-2 py-1 rounded">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
                        </div>
                    </div>

                    <!-- Ù…Ø­ØªÙˆÙ‰ Ø¥Ø·Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© -->
                    <div id="feature-avatarFrame" class="feature-content hidden">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">Ø§Ø®ØªØ± Ø¥Ø·Ø§Ø±Ø§Ù‹ Ù„ØµÙˆØ±ØªÙƒ:</h4>
                        <div class="grid grid-cols-4 gap-4 justify-items-center" id="avatarFrameGrid">
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
                        </div>
                        <div class="mt-3 flex items-center justify-between bg-gray-800/50 p-2 rounded-lg">
                            <span class="text-[10px] text-slate-300">Ù„ÙˆÙ† Ù…Ø®ØµØµ Ù„Ù„Ø¥Ø·Ø§Ø±:</span>
                            <input type="color" id="customFrameColorPicker" onchange="applyCustomColor('avatarFrame', this.value)" class="w-8 h-6 bg-transparent cursor-pointer">
                        </div>
                    </div>

                    <!-- Ù…Ø­ØªÙˆÙ‰ Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ø¬Ø¯ÙŠØ¯) -->
                    <div id="feature-userCardBackground" class="feature-content hidden">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">Ø§Ø®ØªØ± Ø®Ù„ÙÙŠØ© Ù„Ø¨Ø·Ø§Ù‚ØªÙƒ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†:</h4>
                        <div class="grid grid-cols-3 gap-3" id="userCardBackgroundGrid">
                            <div onclick="selectFeature('userCardBackground', null)" class="cursor-pointer p-3 rounded-lg text-center border border-gray-600 hover:border-white text-xs bg-gray-800">Ø§ÙØªØ±Ø§Ø¶ÙŠ</div>
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
                        </div>
                        <div class="mt-4 p-2 rounded-lg border border-gray-700" id="cardBackgroundPreview">
                            <p class="text-xs text-slate-400 mb-2">Ù…Ø¹Ø§ÙŠÙ†Ø©:</p>
                            <div class="flex items-center space-x-3 space-x-reverse p-2 rounded-lg" id="previewCardDiv"><div class="w-8 h-8 rounded-full bg-gray-500"></div><span class="text-white text-sm">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span></div>
                        </div>
                        <div class="mt-3 flex items-center justify-between bg-gray-800/50 p-2 rounded-lg">
                            <span class="text-[10px] text-slate-300">Ù„ÙˆÙ† Ù…Ø®ØµØµ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø©:</span>
                            <input type="color" id="customCardColorPicker" onchange="applyCustomColor('userCardBackground', this.value)" class="w-8 h-6 bg-transparent cursor-pointer">
                        </div>
                    </div>

                    <!-- Ù…Ø­ØªÙˆÙ‰ Ù„ÙˆÙ† Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ø¬Ø¯ÙŠØ¯) -->
                    <div id="feature-profileBackground" class="feature-content hidden">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">Ø§Ø®ØªØ± Ù„ÙˆÙ†Ø§Ù‹ Ù„Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ:</h4>
                        <div class="grid grid-cols-3 gap-3" id="profileBackgroundGrid">
                            <div onclick="selectFeature('profileBackground', null)" class="cursor-pointer p-3 rounded-lg text-center border border-gray-600 hover:border-white text-xs bg-gray-800">Ø§ÙØªØ±Ø§Ø¶ÙŠ</div>
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
                        </div>
                        <div class="mt-4 p-2 rounded-lg border border-gray-700">
                            <p class="text-xs text-slate-400 mb-2">Ù…Ø¹Ø§ÙŠÙ†Ø©:</p>
                            <div id="previewProfileDiv" class="p-4 rounded-lg text-center bg-gradient-to-b from-gray-800 to-gray-900">
                                <span class="text-white text-sm">Ù…Ù„Ù Ø´Ø®ØµÙŠ</span>
                            </div>
                        </div>
                        <div class="mt-3 flex items-center justify-between bg-gray-800/50 p-2 rounded-lg">
                            <span class="text-[10px] text-slate-300">Ù„ÙˆÙ† Ù…Ø®ØµØµ Ù„Ù„Ù…Ù„Ù:</span>
                            <input type="color" id="customProfileColorPicker" onchange="applyCustomColor('profileBackground', this.value)" class="w-8 h-6 bg-transparent cursor-pointer">
                        </div>
                    </div>

                    <!-- Ù…Ø­ØªÙˆÙ‰ Ø¥Ø·Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø³Ù… (Ø¬Ø¯ÙŠØ¯) -->
                    <div id="feature-nameCardBorder" class="feature-content hidden">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">Ø§Ø®ØªØ± Ù„ÙˆÙ†Ø§Ù‹ Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</h4>
                        <p class="text-xs text-slate-400 mb-3">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ù„ÙˆÙ† Ø§Ù„Ø¥Ø·Ø§Ø± Ù…Ù† Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„ØªÙŠ Ø­Ù‚Ù‚ØªÙ‡Ø§ ÙÙ‚Ø·</p>
                        <div class="grid grid-cols-4 gap-3" id="nameCardBorderGrid">
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
                        </div>
                        <div class="mt-4 p-2 rounded-lg border border-gray-700" id="cardBorderPreview">
                            <p class="text-xs text-slate-400 mb-2">Ù…Ø¹Ø§ÙŠÙ†Ø©:</p>
                            <div class="flex items-center space-x-3 space-x-reverse p-3 rounded-lg" id="previewCardBorderDiv" style="border: 3px solid #6366f1;"><div class="w-8 h-8 rounded-full bg-gray-500"></div><span class="text-white text-sm">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span></div>
                        </div>
                    </div>

                    <!-- Ù…Ø­ØªÙˆÙ‰ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… (Ø¬Ø¯ÙŠØ¯) -->
                    <div id="feature-changeName" class="feature-content hidden">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</h4>
                        <p class="text-xs text-slate-400 mb-4">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ø§Ù„Ø§Ø³Ù… Ù…Ù† 3-15 Ø­Ø±Ù (Ø£Ø­Ø±Ù Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©ØŒ Ø£Ø±Ù‚Ø§Ù…ØŒ ÙˆÙ…Ø³Ø§ÙØ§Øª ÙÙ‚Ø·).</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-slate-200 text-sm font-semibold mb-2">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                                <input type="text" id="newUsernameInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯..." 
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            </div>
                            <button onclick="requestUsernameChange()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                            </button>
                        </div>
                    </div>

                    <div class="mt-6 text-center">
                        <button onclick="saveSelectedFeature()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-2 rounded-full font-bold shadow-lg transition-transform transform hover:scale-105">
                            Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                        </button>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø­ÙˆÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ -->
                <div id="profileTab-account" class="profile-tab-content hidden space-y-6">
                    <div id="accountActions">
                        <h3 class="text-lg font-bold text-red-400 mb-2">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø®Ø·ÙŠØ±Ø©</h3>
                        <p class="text-sm text-slate-400 mb-4">Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§. ÙŠØ±Ø¬Ù‰ ØªÙˆØ®ÙŠ Ø§Ù„Ø­Ø°Ø±.</p>
                        <button onclick="confirmDeleteAccount()" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            Ø­Ø°Ù Ø­Ø³Ø§Ø¨ÙŠ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
                        </button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ© -->
    <div id="privateChatModal" class="private-chat-modal">
        <div class="private-chat-header bg-slate-800 border-b border-white/10 px-4 py-3 flex items-center justify-between shadow-lg">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <img id="privateChatAvatar" src="" class="w-10 h-10 rounded-full object-cover border-2 border-blue-500/20" onerror="this.src = '/my-avatar.png'">
                    <span id="privateChatStatusDot" class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-slate-800"></span>
                </div>
                <div>
                    <h3 id="privateChatUsername" class="text-white font-bold text-sm leading-tight"></h3>
                    <p id="privateChatStatus" class="text-[10px] text-slate-400 font-medium"></p>
                </div>
            </div>
            <button onclick="closePrivateChat()" class="text-slate-400 hover:text-white hover:bg-white/10 p-2 rounded-full transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div id="privateChatMessages" class="private-chat-messages custom-scrollbar">
            <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
        </div>
        
        <div class="private-chat-input bg-slate-800/50 p-3 relative">
            <div id="privateEmojiPicker" class="emoji-picker custom-scrollbar"></div>
            <div class="flex items-center gap-2">
                <input
                    type="text"
                    id="privateMessageInput"
                    placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ø§Ù„Ø®Ø§ØµØ©..."
                    class="flex-1 bg-slate-900/50 border border-white/10 rounded-full px-4 py-2 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-sm transition-all"
                    onkeypress="handlePrivateKeyPress(event)"
                >
                <button
                    onclick="sendPrivateMessage()"
                    class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full transition-all shadow-lg shadow-blue-900/20 active:scale-95"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ -->
    <div id="friendsSidebar" class="friends-sidebar">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-white">ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h2>
            <button onclick="closeFriendsSidebar()" class="text-slate-300 hover:text-blue-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
        <div class="mb-6">
            <div class="relative">
                <input
                    type="text"
                    id="userSearchInput"
                    placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..."
                    class="w-full bg-gray-700 border border-gray-600 rounded-full px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent text-sm"
                >
                <button onclick="searchUsers()" class="absolute left-2 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
            </div>
            <div id="searchResults" class="mt-3 hidden bg-white/10 rounded-lg p-3 max-h-40 overflow-y-auto">
                <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
            </div>
        </div>
        
        <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© -->
        <div class="mb-6">
            <h3 class="text-white font-semibold mb-3 flex items-center space-x-2 space-x-reverse">
                <span>ğŸ“©</span>
                <span>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©</span>
                <span id="friendRequestsCount" class="bg-blue-600 text-white text-xs px-2 py-1 rounded-full">0</span>
            </h3>
            <div id="friendRequestsList" class="space-y-2">
                <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
            </div>
        </div>
        
        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ -->
        <div>
            <h3 class="text-white font-semibold mb-3 flex items-center space-x-2 space-x-reverse">
                <span>ğŸ‘¥</span>
                <span>Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ</span>
                <span id="friendsCount" class="bg-green-600 text-white text-xs px-2 py-1 rounded-full">0</span>
            </h3>
            <div id="friendsList" class="space-y-2">
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
            </div>
        </div>
    </div>
    
    <div id="friendsOverlay" class="friends-overlay" onclick="closeFriendsSidebar()"></div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
    <div id="globalNotifications" class="fixed top-4 right-4 z-50 space-y-3 max-w-sm"></div>
<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª -->
<div id="postsModal" class="profile-modal">
    <div class="profile-content custom-scrollbar" style="max-width: 650px; height: 95vh;">
        <!-- Ø±Ø£Ø³ Ø§Ù„Ù†Ø§ÙØ°Ø© -->
        <div class="flex justify-between items-center p-4 border-b border-slate-700 flex-shrink-0">
            <h2 class="text-xl font-bold text-white">ğŸ“ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h2>
            <button onclick="closePostsSidebar()" class="text-slate-300 hover:text-blue-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ…Ø±ÙŠØ± -->
        <div class="flex-1 p-4 overflow-y-auto custom-scrollbar">
            <!-- Ù…Ù†Ø·Ù‚Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯ -->
            <div class="mb-6 bg-gray-800 rounded-xl p-4 border border-gray-700">
                <h3 class="text-white font-semibold mb-3">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</h3>
                <textarea 
                    id="newPostContent" 
                    placeholder="Ø¨Ù…Ø§Ø°Ø§ ØªÙÙƒØ± ÙŠØ§ ${currentUser?.name || ''}ØŸ" 
                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm mb-3"
                    rows="3"
                ></textarea>
                <button 
                    onclick="createNewPost()" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors"
                >
                    Ù†Ø´Ø±
                </button>
            </div>
            
            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª -->
            <div id="postsList" class="space-y-4">
                <!-- Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù‡Ù†Ø§ -->
            </div>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙØ§Ø¹Ù„ÙŠÙ† -->
<div id="topUsersModal" class="profile-modal">
    <div class="profile-content custom-scrollbar">
        <!-- Ø±Ø£Ø³ Ø§Ù„Ù†Ø§ÙØ°Ø© -->
        <div class="relative bg-gray-800 p-6 text-center">
             <button onclick="closeTopUsersModal()" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">ğŸ† Ø§Ù„Ù…ØªÙØ§Ø¹Ù„ÙˆÙ†</h2>
            <p class="text-slate-400 text-sm">Ø£ÙƒØ«Ø± 10 Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù†Ø´Ø§Ø·Ø§Ù‹</p>
        </div>

        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
        <div id="topUsersListContainer" class="flex-1 p-4 space-y-3 overflow-y-auto custom-scrollbar">
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù‡Ù†Ø§ -->
            <div class="text-center text-slate-400 p-8">
                <div class="spinner mx-auto"></div>
                <p class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</p>
            </div>
        </div>
    </div>
</div>

<div id="topUsersOverlay" class="friends-overlay" onclick="closeTopUsersModal()"></div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØªØ¬Ø± -->
<div id="shopModal" class="profile-modal">
    <div class="profile-content custom-scrollbar" style="max-width: 500px;">
        <!-- Ø±Ø£Ø³ Ø§Ù„Ù†Ø§ÙØ°Ø© --> 
        <div class="relative bg-gray-800 p-6 text-center">
             <button onclick="closeShopModal()" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">ğŸ›’ Ø§Ù„Ù…ØªØ¬Ø±</h2>
            <p class="text-slate-400 text-sm">Ø§Ø³ØªØ®Ø¯Ù… Ù†Ù‚Ø§Ø·Ùƒ Ù„Ø´Ø±Ø§Ø¡ Ø¹Ù†Ø§ØµØ± Ù…Ù…ÙŠØ²Ø©</p>
        </div>

        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ØªØ¬Ø± -->
        <div id="shopItemsContainer" class="flex-1 p-4 overflow-y-auto custom-scrollbar">
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
            <div class="text-center text-slate-400 p-8">
                <div class="spinner mx-auto"></div>
                <p class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ØªØ¬Ø±...</p>
            </div>
        </div>
    </div>
</div>
<div id="shopOverlay" class="friends-overlay" onclick="closeShopModal()"></div>

<style>
    #shopModal.show {
        opacity: 1;
        visibility: visible;
    }
    #shopModal.show .profile-content {
        transform: scale(1);
    }
    #shopOverlay.show {
        display: block;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
    }
</style>

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· -->
<div id="sendPointsModal" class="profile-modal">
    <div class="profile-content" style="max-width: 350px;">
        <!-- Ø±Ø£Ø³ Ø§Ù„Ù†Ø§ÙØ°Ø© -->
        <div class="relative bg-gray-800 p-6 text-center">
             <button onclick="closeSendPointsModal()" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">ğŸ Ø¥Ø±Ø³Ø§Ù„ Ù†Ù‚Ø§Ø·</h2>
            <p id="sendPointsToUser" class="text-slate-400 text-sm"></p>
        </div>

        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø§ÙØ°Ø© -->
        <div class="flex-1 p-6 space-y-4">
            <div>
                <label for="pointsAmountInput" class="block text-slate-200 text-sm font-semibold mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·</label>
                <input 
                    type="number"
                    id="pointsAmountInput"
                    placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10,000)..."
                    min="1"
                    max="10000"
                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400"
                >
            </div>
            <button
                onclick="submitSendPoints()"
                class="w-full bg-purple-600 hover:bg-purple-700 text-white px-6 py-2.5 rounded-lg font-semibold transition-colors flex items-center justify-center space-x-2 space-x-reverse"
            >
                <span>Ø¥Ø±Ø³Ø§Ù„</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-1V4m0 2v1m0 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            </button>
        </div>
    </div>
</div>

<style>
    #topUsersModal.show {
        opacity: 1;
        visibility: visible;
    }
    #topUsersModal.show .profile-content {
        transform: scale(1);
    }
    #topUsersOverlay.show {
        display: block;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
    }
</style>

<!-- Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© body -->
<!-- Ù†Ø§ÙØ°Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ© -->
<div id="roomInfoModal" class="profile-modal">
    <div class="profile-content" style="max-width: 600px;">
        <button onclick="closeRoomInfo()" class="absolute top-4 right-4 text-slate-300 hover:text-red-500">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        
        <div class="bg-gray-800 p-6 text-center border-b border-gray-700">
            <h2 id="roomInfoTitle" class="text-2xl font-bold text-white mb-2">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ©</h2>
            <p id="roomInfoDesc" class="text-slate-400 text-sm"></p>
        </div>

        <div id="roomInfoContent" class="p-6 space-y-6 overflow-y-auto" style="max-height: 70vh;">
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‡Ù†Ø§ -->
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
<div id="changePasswordModal" class="profile-modal">
    <div class="profile-content" style="max-width: 400px;">
        <!-- Ø±Ø£Ø³ Ø§Ù„Ù†Ø§ÙØ°Ø© -->
        <div class="relative bg-gray-800 p-6 text-center">
             <button onclick="closeChangePasswordModal()" class="absolute top-4 right-4 text-slate-300 hover:text-sky-400 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
            <p class="text-slate-400 text-sm mt-1">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</p>
        </div>

        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø§ÙØ°Ø© -->
        <div class="flex-1 p-6 space-y-4">
            <div>
                <label for="oldPasswordInput" class="block text-slate-200 text-sm font-semibold mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©</label>
                <input type="password" id="oldPasswordInput" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©"
                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
            </div>
            <div>
                <label for="newPasswordInput" class="block text-slate-200 text-sm font-semibold mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                <input type="password" id="newPasswordInput" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"
                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
            </div>
            <div>
                <label for="confirmNewPasswordInput" class="block text-slate-200 text-sm font-semibold mb-2">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                <input type="password" id="confirmNewPasswordInput" placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"
                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
            </div>
            <button onclick="submitChangePassword()"
                class="w-full bg-teal-600 hover:bg-teal-700 text-white px-6 py-2.5 rounded-lg font-semibold transition-colors flex items-center justify-center space-x-2 space-x-reverse">
                <span>ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØºÙŠÙŠØ±</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ… (Control Panel) -->
<div id="controlPanelModal" class="profile-modal">
    <div class="profile-content custom-scrollbar" style="max-width: 800px; height: 95vh;">
        <!-- Ø±Ø£Ø³ Ø§Ù„Ù†Ø§ÙØ°Ø© -->
        <div class="relative bg-gray-800 p-6 text-center border-b border-gray-700 flex-shrink-0">
            <button onclick="closeControlPanel()" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">âš™ï¸ ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <p class="text-slate-400 text-sm">Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø´Ø§Ù…Ù„Ø©</p>
        </div>
        
        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø§ÙØ°Ø© -->
        <div class="flex-1 p-6 space-y-8 overflow-y-auto custom-scrollbar">
            <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gray-700/50 p-4 rounded-xl text-center border border-gray-600">
                    <div class="text-3xl mb-2">ğŸ‘¥</div>
                    <div class="text-2xl font-bold text-white" id="statsTotalUsers">0</div>
                    <div class="text-xs text-slate-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                </div>
                <div class="bg-gray-700/50 p-4 rounded-xl text-center border border-gray-600">
                    <div class="text-3xl mb-2">ğŸŸ¢</div>
                    <div class="text-2xl font-bold text-green-400" id="statsOnline">0</div>
                    <div class="text-xs text-slate-400">Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†</div>
                </div>
                <div class="bg-gray-700/50 p-4 rounded-xl text-center border border-gray-600">
                    <div class="text-3xl mb-2">ğŸ‘¨</div>
                    <div class="text-2xl font-bold text-blue-400" id="statsMales">0</div>
                    <div class="text-xs text-slate-400">Ø§Ù„Ø°ÙƒÙˆØ±</div>
                </div>
                <div class="bg-gray-700/50 p-4 rounded-xl text-center border border-gray-600">
                    <div class="text-3xl mb-2">ğŸ‘©</div>
                    <div class="text-2xl font-bold text-pink-400" id="statsFemales">0</div>
                    <div class="text-xs text-slate-400">Ø§Ù„Ø¥Ù†Ø§Ø«</div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù‡Ø§Ù… -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <span>ğŸ“¢</span> Ø¥Ø¹Ù„Ø§Ù† Ù‡Ø§Ù… (Ø´Ø±ÙŠØ· Ù…ØªØ­Ø±Ùƒ)
                </h3>
                <div class="flex gap-2">
                    <input type="text" id="announcementInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù‡Ù†Ø§..." class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-red-500">
                    <button onclick="setAnnouncement()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">Ù†Ø´Ø±</button>
                    <button onclick="removeAnnouncement()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">Ø¥Ø²Ø§Ù„Ø©</button>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ØªØ¨ -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <span>ğŸŒŸ</span> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ØªØ¨ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                </h3>
                
                <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
                <div class="bg-gray-900/50 p-4 rounded-lg mb-6 border border-gray-600">
                    <h4 class="text-white font-semibold mb-3 text-sm" id="rankFormTitle">Ø¥Ø¶Ø§ÙØ© Ø±ØªØ¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</h4>
                    <input type="hidden" id="editingRankName" value="">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="customRankName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø±ØªØ¨Ø©" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 col-span-2 md:col-span-1">
                    
                    <div class="col-span-2 md:col-span-1">
                        <div class="flex gap-2">
                            <input type="text" id="customRankIcon" placeholder="Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ù…Ø«Ø§Ù„: ğŸš€)" class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-center focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <input type="file" id="rankIconUpload" accept="image/*" class="hidden" onchange="handleRankIconUpload()">
                            <button onclick="document.getElementById('rankIconUpload').click()" class="bg-gray-600 hover:bg-gray-500 text-white px-3 py-2 rounded-lg transition-colors" title="Ø±ÙØ¹ ØµÙˆØ±Ø©">ğŸ–¼ï¸</button>
                        </div>
                        <div id="rankIconPreviewContainer" class="hidden mt-2 text-center"><img id="rankIconPreview" src="" class="w-8 h-8 mx-auto object-contain"><button onclick="clearRankIconImage()" class="text-xs text-red-400 hover:text-red-300 mt-1">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©</button></div>
                    </div>

                    <input type="number" id="customRankLevel" placeholder="Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (1-99)" min="1" max="99" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500" title="Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙŠØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ù†Ù‰. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 99.">
                        <select id="customRankColor" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="from-gray-500 to-gray-700">âšª Ø±Ù…Ø§Ø¯ÙŠ (Ø¹Ø§Ø¯ÙŠ)</option>
                            <option value="from-red-600 to-orange-400">ğŸ”´ Ø£Ø­Ù…Ø± - Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ (Ù…Ù…ÙŠØ²)</option>
                            <option value="from-yellow-400 to-yellow-500">ğŸŸ¡ Ø°Ù‡Ø¨ÙŠ (Ù…Ù„ÙƒÙŠ)</option>
                            <option value="from-green-500 to-emerald-600">ğŸŸ¢ Ø£Ø®Ø¶Ø± (Ù†Ø´Ø·)</option>
                            <option value="from-blue-500 to-cyan-600">ğŸ”µ Ø£Ø²Ø±Ù‚ (Ø¥Ø¯Ø§Ø±ÙŠ)</option>
                            <option value="from-purple-500 to-indigo-600">ğŸŸ£ Ø¨Ù†ÙØ³Ø¬ÙŠ (ÙØ®Ù…)</option>
                            <option value="from-pink-500 to-rose-500">ğŸŒ¸ ÙˆØ±Ø¯ÙŠ (Ø¨Ù†Ø§ØªÙŠ)</option>
                        </select>
                        <div class="md:col-span-2">
                            <input type="text" id="customRankTarget" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ¹ÙŠÙŠÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                </div>
                    <div class="flex gap-2">
                        <button onclick="saveRankDefinition()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors" id="saveRankBtn">Ø­ÙØ¸ ÙˆØªØ¹ÙŠÙŠÙ†</button>
                        <button onclick="resetRankForm()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors hidden" id="cancelRankEditBtn">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>

                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±ØªØ¨ -->
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-right text-gray-400">
                        <thead class="text-xs text-gray-200 uppercase bg-gray-700/50">
                            <tr>
                                <th class="px-4 py-3">Ø§Ù„Ø±ØªØ¨Ø©</th>
                                <th class="px-4 py-3">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (Ø§Ù„Ù‚ÙˆØ©)</th>
                                <th class="px-4 py-3">Ø§Ù„Ù„ÙˆÙ†</th>
                                <th class="px-4 py-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="ranksTableBody" class="divide-y divide-gray-700">
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø±ØªØ¨ Ù‡Ù†Ø§ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠØ±ÙŠ Ø§Ù„ØºØ±Ù -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <span>ğŸ‘®</span> Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯ÙŠØ±ÙŠ Ø§Ù„ØºØ±Ù
                </h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-slate-300 mb-2 block">Ø§Ø®ØªØ± Ø§Ù„ØºØ±ÙØ©</label>
                            <select id="managerRoomSelect" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-orange-500" onchange="updateManagersList()">
                                <option value="">Ø§Ø®ØªØ± ØºØ±ÙØ©...</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-300 mb-2 block">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                            <input type="text" id="managerUserInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..." class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>
                    <button onclick="assignRoomManager()" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">ØªØ¹ÙŠÙŠÙ† Ù…Ø¯ÙŠØ± Ø§Ù„ØºØ±ÙØ©</button>
                </div>

                <!-- Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¯ÙŠØ±ÙŠ Ø§Ù„ØºØ±Ù Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ† -->
                <div class="mt-6 pt-6 border-t border-gray-700">
                    <h4 class="text-lg font-semibold text-white mb-4">Ù…Ø¯ÙŠØ±Ùˆ Ø§Ù„ØºØ±Ù Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ†</h4>
                    <div id="roomManagersList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† Ù‡Ù†Ø§ -->
                    </div>
                    <div id="noManagersMsg" class="text-center text-slate-400 text-sm py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±Ù Ø¨Ù‡Ø§ Ù…Ø¯ÙŠØ±ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±Ù -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <span>ğŸšª</span> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±Ù
                </h3>

                <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø© -->
                <div class="bg-gray-900/50 p-4 rounded-lg mb-6 border border-gray-600">
                    <h4 class="text-white font-semibold mb-3 text-sm">Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
                        <input type="text" id="newRoomName" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                        <input type="text" id="newRoomIcon" placeholder="Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ù…Ø«Ø§Ù„: ğŸ’¬)" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-center focus:outline-none focus:ring-2 focus:ring-green-500">
                        <input type="number" id="newRoomOrder" placeholder="Ø§Ù„ØªØ±ØªÙŠØ¨ (Ù…Ø«Ø§Ù„: 1)" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-center focus:outline-none focus:ring-2 focus:ring-green-500" min="0">
                        <input type="text" id="newRoomDesc" placeholder="ÙˆØµÙ Ø§Ù„ØºØ±ÙØ©" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 md:col-span-1">
                    </div>
                    <button onclick="addNewRoom()" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">â• Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ©</button>
                </div>

                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºØ±Ù -->
                <div class="overflow-x-auto bg-gray-900/50 rounded-lg border border-gray-700 custom-scrollbar">
                    <table class="w-full text-sm text-right text-gray-400">
                        <thead class="text-xs text-gray-200 uppercase bg-gray-700/80 sticky top-0">
                            <tr>
                                <th class="px-4 py-3">Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                                <th class="px-4 py-3">Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</th>
                                <th class="px-4 py-3">Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©</th>
                                <th class="px-4 py-3">Ø§Ù„ÙˆØµÙ</th>
                                <th class="px-4 py-3 text-center">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</th>
                                <th class="px-4 py-3 text-center">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th class="px-4 py-3 text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="roomsListTableBody" class="divide-y divide-gray-700">
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‡Ù†Ø§ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <span>ğŸ®</span> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª (QuizBot)
                </h3>

                <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯ -->
                <div class="bg-gray-900/50 p-4 rounded-lg mb-6 border border-gray-600">
                    <h4 class="text-white font-semibold mb-3 text-sm">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                        <input type="text" id="newQuizCategory" placeholder="Ø§Ù„ÙØ¦Ø© (Ù…Ø«Ù„Ø§Ù‹: Ø±ÙŠØ§Ø¶Ø©)" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        <input type="text" id="newQuizQuestion" placeholder="Ø§Ù„Ø³Ø¤Ø§Ù„" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        <input type="text" id="newQuizAnswer" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500">
                    </div>
                    <button onclick="addQuizQuestion()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
                </div>

                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
                <div class="overflow-x-auto bg-gray-900/50 rounded-lg border border-gray-700 custom-scrollbar">
                    <table class="w-full text-sm text-right text-gray-400">
                        <thead class="text-xs text-gray-200 uppercase bg-gray-700/80 sticky top-0">
                            <tr>
                                <th class="px-4 py-3">Ø§Ù„ÙØ¦Ø©</th>
                                <th class="px-4 py-3">Ø§Ù„Ø³Ø¤Ø§Ù„</th>
                                <th class="px-4 py-3">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</th>
                                <th class="px-4 py-3 text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="quizQuestionsTableBody" class="divide-y divide-gray-700">
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‡Ù†Ø§ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø´Ø§Ù…Ù„Ø© -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <span>ğŸ‘¥</span> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø´Ø§Ù…Ù„Ø©
                    </h3>
                    <div class="relative w-full md:w-64">
                        <input type="text" id="controlUserSearch" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..." class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="filterControlUsers()">
                    </div>
                </div>
                <div class="overflow-x-auto bg-gray-900/50 rounded-lg border border-gray-700 custom-scrollbar">
                    <table class="w-full text-sm text-right text-gray-400">
                        <thead class="text-xs text-gray-200 uppercase bg-gray-700/80 sticky top-0">
                            <tr>
                                <th scope="col" class="px-4 py-3">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ØªØ¹Ø¯ÙŠÙ„)</th>
                                <th scope="col" class="px-4 py-3">Ø§Ù„Ø±ØªØ¨Ø©</th>
                                <th scope="col" class="px-4 py-3">Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                                <th scope="col" class="px-4 py-3">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
                                <th scope="col" class="px-4 py-3 text-center">Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ</th>
                                <th scope="col" class="px-4 py-3 text-center">Ø§Ù„Ù…ØªÙØ§Ø¹Ù„ÙŠÙ†</th>
                                <th scope="col" class="px-4 py-3 text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="controlUsersTableBody" class="divide-y divide-gray-700">
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‡Ù†Ø§ -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-2 text-xs text-slate-500 text-center">ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·</div>
            </div>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© -->
<div id="drawingModal" class="profile-modal">
    <div class="profile-content custom-scrollbar relative bg-gray-900 border border-gray-700 rounded-xl overflow-hidden" style="max-width: 800px; width: 95%;">
        <div class="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-800">
            <h2 class="text-xl font-bold text-white">ğŸ¨ Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©</h2>
            <div class="flex items-center gap-2">
                <button onclick="clearDrawingBoard()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-bold transition-colors">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
                <button onclick="closeDrawingBoard()" class="text-slate-300 hover:text-blue-500 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>
        <div class="p-4 bg-gray-800 flex justify-center overflow-auto">
            <canvas id="sharedCanvas" width="750" height="500" class="bg-white rounded shadow-lg cursor-crosshair touch-none"></canvas>
        </div>
        <div class="p-4 bg-gray-800 border-t border-gray-700 flex justify-center gap-6 items-center flex-wrap">
             <div class="flex items-center gap-2">
                <label class="text-white text-sm font-semibold">Ø§Ù„Ù„ÙˆÙ†:</label>
                <input type="color" id="drawingColor" value="#000000" class="h-8 w-10 rounded cursor-pointer bg-transparent border-0 p-0">
             </div>
             <div class="flex items-center gap-2">
                <label class="text-white text-sm font-semibold">Ø§Ù„Ø­Ø¬Ù…:</label>
                <input type="range" id="drawingWidth" min="1" max="20" value="3" class="w-32 accent-blue-500">
             </div>
        </div>
    </div>
</div>

<!-- Ø¹Ù†Ø§ØµØ± Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ÙÙŠØ© -->
<input type="file" id="imageUpload" accept="image/*" class="hidden">
<input type="file" id="privateImageUpload" accept="image/*" class="hidden">
<input type="file" id="profileImageUpload" accept="image/*" class="hidden">
<input type="file" id="coverUpload" accept="image/*" class="hidden">



    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({ 
            transports: ['polling', 'websocket'],
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000
        });
        window.DEFAULT_AVATAR_URL = '/my-avatar.png';
        const SITE_OWNER = {
            username: "Walid dz 31",
            rank: "ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹"
        };
        let currentUser = null;
        let BOT_AVATAR_URL = '/icon.png';

        const animatedEmojis = [
            "/f/1.png", "/f/2.png", "/f/3.png", "/f/4.png", "/f/5.png",
            "/f/6.png", "/f/7.png", "/f/8.png", "/f/9.png", "/f/10.png",
            "/f/11.png", "/f/12.png", "/f/13.png", "/f/14.png", "/f/15.png",
            "/f/16.png", "/f/17.png", "/f/18.png", "/f/19.png", "/f/20.png",
            "/f/21.png", "/f/22.png", "/f/23.png", "/f/24.png", "/f/25.png",
            "/f/26.png", "/f/27.png", "/f/28.png", "/f/29.png", "/f/30.png",
            "/f/31.png", "/f/32.png", "/f/33.png", "/f/34.png", "/f/35.png",
            "/f/36.png", "/f/37.png", "/f/38.png", "/f/39.png", "/f/40.png",
            "/f/41.png", "/f/42.png", "/f/43.png", "/f/44.png", "/f/45.png",
            "/f/46.png", "/f/47.png", "/f/48.png", "/f/49.png", "/f/50.png",
            "/f/51.png", "/f/52.png", "/f/53.png", "/f/54.png", "/f/55.png",
            "/f/56.png", "/f/57.png", "/f/58.png"
        ];

        const localEmojis = [
            "/e/1.gif", "/e/29.gif", "/e/30.gif", "/e/31.gif", 
            "/e/32.gif", "/e/34.gif", "/e/35.gif", "/e/36.gif", 
            "/e/38.gif", "/e/50.gif", "/e/51.gif", "/e/52.gif", 
            "/e/57.gif", "/e/62.gif", "/e/63.gif", "/e/64.gif", 
            "/e/65.gif", "/e/66.gif"
        ];

        let currentEmojiTab = 'animated';

        function toggleEmojiPicker(isPrivate = false) {
            if (event) event.stopPropagation();
            if (typeof isPrivate !== 'boolean') isPrivate = false;
            
            const pickerId = isPrivate ? 'privateEmojiPicker' : 'emojiPicker';
            const picker = document.getElementById(pickerId);
            
            if (picker.classList.contains('show')) {
                picker.classList.remove('show');
                return;
            }

            const otherPickerId = isPrivate ? 'emojiPicker' : 'privateEmojiPicker';
            const otherPicker = document.getElementById(otherPickerId);
            if (otherPicker) otherPicker.classList.remove('show');

            renderEmojiPicker(pickerId, isPrivate);
            picker.classList.add('show');
        }

        function renderEmojiPicker(pickerId, isPrivate) {
            const picker = document.getElementById(pickerId);
            picker.innerHTML = `
                <div class="emoji-picker-header">
                    <div class="emoji-tab ${currentEmojiTab === 'animated' ? 'active' : ''}" onclick="switchEmojiTab(event, 'animated', '${pickerId}', ${isPrivate})">Ø«Ø§Ø¨ØªØ©</div>
                    <div class="emoji-tab ${currentEmojiTab === 'local' ? 'active' : ''}" onclick="switchEmojiTab(event, 'local', '${pickerId}', ${isPrivate})">Ù…ØªØ­Ø±ÙƒØ©</div>
                </div>
                <div class="emoji-grid custom-scrollbar"></div>
            `;
            
            const grid = picker.querySelector('.emoji-grid');
            const emojis = currentEmojiTab === 'animated' ? animatedEmojis : localEmojis;
            
            emojis.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.className = 'animated-emoji';
                img.onclick = (e) => {
                    e.stopPropagation();
                    sendAnimatedEmoji(url, isPrivate);
                };
                grid.appendChild(img);
            });
        }

        function switchEmojiTab(event, tab, pickerId, isPrivate) {
            if (event) event.stopPropagation();
            currentEmojiTab = tab;
            renderEmojiPicker(pickerId, isPrivate);
        }

        function sendAnimatedEmoji(url, isPrivate) {
            if (isPrivate) {
                const privateInput = document.getElementById('privateMessageInput');
                if (privateInput) {
                    privateInput.value = (privateInput.value.trim() ? privateInput.value + ' ' : '') + url;
                    privateInput.focus();
                }
                document.getElementById('privateEmojiPicker').classList.remove('show');
            } else {
                const input = document.getElementById('messageInput');
                if (input) {
                    input.value = (input.value.trim() ? input.value + ' ' : '') + url;
                    input.focus();
                }
                document.getElementById('emojiPicker').classList.remove('show');
            }
        }

        function triggerBotAvatarUpload() {
            if (currentUser && currentUser.name === SITE_OWNER.username) {
                document.getElementById('botAvatarInput').click();
            }
        }

        function uploadBotAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                showNotification('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const avatarUrl = e.target.result;
                socket.emit('update bot avatar', { avatarUrl, currentUser });
                // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ
                BOT_AVATAR_URL = avatarUrl;
                document.querySelectorAll('#changeBotAvatarBtn img').forEach(img => img.src = avatarUrl);
            };
            reader.readAsDataURL(file);
        }

        // --- Ø¯ÙˆØ§Ù„ ØªØ¨Ø¯ÙŠÙ„ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ---
        function switchProfileTab(event, tabName) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª
            document.querySelectorAll('.profile-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            // Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.profile-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø¯Ø¯
            document.getElementById(`profileTab-${tabName}`).classList.remove('hidden');
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
            event.currentTarget.classList.add('active');
        }

        function confirmDeleteAccount() {
            const username = document.getElementById('profileUsername').textContent;
            if (username !== currentUser.name) return;

            const confirmation = prompt(`Ù„Ù„ØªØ£ÙƒÙŠØ¯ØŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ: "${username}"`);
            if (confirmation === username) {
                if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.")) {
                    socket.emit('delete account', { username: currentUser.name });
                }
            } else if (confirmation !== null) {
                showNotification('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚. ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.', 'error');
            }
        }

        function requestUsernameChange() {
            const newUsername = document.getElementById('newUsernameInput').value.trim();
            if (!newUsername) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯.', 'error');
                return;
            }
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ø³Ù…Ùƒ Ø¥Ù„Ù‰ "${newUsername}"ØŸ Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ.`)) {
                socket.emit('change username', { newUsername, currentUser });
            }
        }

        socket.on('username change success', (message) => {
            showNotification(message, 'success');
            setTimeout(logout, 2000);
        });

        socket.on('username change error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('user name changed', ({ oldUsername, newUsername }) => {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†
            document.querySelectorAll(`[data-username="${oldUsername}"]`).forEach(el => {
                el.setAttribute('data-username', newUsername);
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                const textNode = el.querySelector('.font-semibold.truncate, .username-text, #profileUsername');
                if (textNode && textNode.textContent === oldUsername) textNode.textContent = newUsername;
            });
        });

        // --- Ø¯ÙˆØ§Ù„ Ù‚Ø³Ù… Ø§Ù„Ù…ÙŠØ²Ø§Øª ---
        let currentFeatureSelection = {
            feature: 'nameColor',
            value: null
        };

        function switchFeatureSubTab(tabName) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.feature-sub-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-slate-400', 'hover:bg-gray-700');
            });
            const activeBtn = document.getElementById(`btn-${tabName}`);
            activeBtn.classList.remove('text-slate-400', 'hover:bg-gray-700');
            activeBtn.classList.add('bg-blue-600', 'text-white');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            document.querySelectorAll('.feature-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(`feature-${tabName}`).classList.remove('hidden');

            currentFeatureSelection.feature = tabName;
            currentFeatureSelection.value = null; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
        }

        function applyCustomColor(feature, color) {
            let value = '';
            if (feature === 'nameColor') {
                value = `color:${color}`; // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆÙ† Ù…Ø¨Ø§Ø´Ø±Ø©
            } else if (feature === 'userCardBackground') {
                value = `background-color:${color}`;
            } else if (feature === 'profileBackground') {
                value = `background-color:${color}`;
            } else if (feature === 'avatarFrame') {
                value = `border-color:${color}`;
            }
            selectFeature(feature, value);
        }

        function selectFeature(feature, value) {
            currentFeatureSelection.feature = feature;
            currentFeatureSelection.value = value;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±Ø¦ÙŠ
            if (feature === 'nameColor') {
                document.querySelectorAll('#nameColorGrid .color-option').forEach(el => el.classList.remove('selected'));
                if (event && event.target && event.target.classList.contains('color-option')) {
                    event.target.classList.add('selected');
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ù…Ø¹Ø§ÙŠÙ†Ø©)
                const previewText = document.querySelector('#previewCardDiv .truncate, #previewCardDiv .font-semibold');
                if (previewText) {
                    previewText.className = 'font-semibold truncate text-sm';
                    previewText.style.color = '';
                    previewText.style.background = '';
                    previewText.style.webkitBackgroundClip = '';
                    previewText.style.webkitTextFillColor = '';
                    
                    if (value && value.startsWith('color:')) {
                        previewText.style.color = value.split(':')[1];
                    } else if (value && value.startsWith('text-gradient-')) {
                        previewText.classList.add(value);
                    } else if (value && value.startsWith('text-sparkle-')) {
                        previewText.classList.add(value);
                    } else if (value && value.startsWith('text-neon-')) {
                        previewText.classList.add(value);
                    } else if (value && value.startsWith('text-fire-')) {
                        previewText.classList.add(value);
                    } else if (value) {
                        previewText.classList.add(value);
                    }
                }
            } else if (feature === 'nameBackground') {
                document.querySelectorAll('#nameBackgroundGrid > div').forEach(el => el.classList.remove('border-blue-500', 'border-2'));
                if (event && event.currentTarget) event.currentTarget.classList.add('border-blue-500', 'border-2');
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                const preview = document.getElementById('nameBackgroundPreview');
                preview.className = `px-2 py-1 rounded ${value || ''}`;
            } else if (feature === 'avatarFrame') {
                document.querySelectorAll('#avatarFrameGrid > div').forEach(el => el.classList.remove('ring-2', 'ring-blue-500'));
                if (event && event.currentTarget && event.currentTarget.id !== 'customFrameColorPicker') event.currentTarget.classList.add('ring-2', 'ring-blue-500');
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©
                const avatarFrame = document.getElementById('profileAvatarFrame');
                if (avatarFrame) {
                    avatarFrame.style.border = '';
                    if (value && value.startsWith('border-color:')) {
                        avatarFrame.className = `w-24 h-24 rounded-full relative`;
                        avatarFrame.style.border = `3px solid ${value.split(':')[1]}`;
                    } else {
                        avatarFrame.className = `w-24 h-24 rounded-full relative ${value || ''}`;
                    }
                }
            } else if (feature === 'userCardBackground') {
                document.querySelectorAll('#userCardBackgroundGrid > div').forEach(el => el.classList.remove('ring-2', 'ring-blue-500'));
                if (event && event.currentTarget && event.currentTarget.id !== 'customCardColorPicker') {
                    event.currentTarget.classList.add('ring-2', 'ring-blue-500');
                }
                
                const previewDiv = document.getElementById('previewCardDiv');
                previewDiv.style.backgroundColor = '';
                if (value && value.startsWith('background-color:')) {
                    previewDiv.className = `flex items-center space-x-3 space-x-reverse p-2 rounded-lg`;
                    previewDiv.style.backgroundColor = value.split(':')[1];
                } else {
                    previewDiv.className = `flex items-center space-x-3 space-x-reverse p-2 rounded-lg ${value || 'bg-gray-800'}`;
                }
            } else if (feature === 'profileBackground') {
                document.querySelectorAll('#profileBackgroundGrid > div').forEach(el => el.classList.remove('ring-2', 'ring-blue-500'));
                if (event && event.currentTarget && event.currentTarget.id !== 'customProfileColorPicker') {
                    event.currentTarget.classList.add('ring-2', 'ring-blue-500');
                }
                
                const previewDiv = document.getElementById('previewProfileDiv');
                previewDiv.style.backgroundColor = '';
                if (value && value.startsWith('background-color:')) {
                    previewDiv.className = `p-4 rounded-lg text-center`;
                    previewDiv.style.backgroundColor = value.split(':')[1];
                } else {
                    previewDiv.className = `p-4 rounded-lg text-center ${value || 'bg-gradient-to-b from-gray-800 to-gray-900'}`;
                }
            } else if (feature === 'nameCardBorder') {
                document.querySelectorAll('#nameCardBorderGrid > div').forEach(el => el.style.borderColor = '');
                if (event && event.currentTarget) {
                    event.currentTarget.style.borderColor = '#3b82f6';
                }
                
                const previewDiv = document.getElementById('previewCardBorderDiv');
                previewDiv.style.borderColor = '#6366f1';
                if (value && value.startsWith('border-color:')) {
                    previewDiv.style.borderColor = value.split(':')[1];
                }
            }
        }

        function updateNameCardBorderGrid(profileData) {
            const nameCardBorderGrid = document.getElementById('nameCardBorderGrid');
            if (!nameCardBorderGrid || !profileData || !profileData.achievements) return;
            
            nameCardBorderGrid.innerHTML = '';
            const completedAchievements = profileData.achievements.filter(a => a.completed);
            
            if (completedAchievements.length > 0) {
                completedAchievements.forEach(ach => {
                    const div = document.createElement('div');
                    let borderColor = ach.cardColor || '#6366f1';
                    
                    div.className = 'cursor-pointer p-3 rounded-lg border-2 hover:border-white text-center flex flex-col items-center gap-2 bg-gray-800/50';
                    div.style.borderColor = borderColor;
                    div.innerHTML = `<span class="text-2xl">${ach.icon || 'ğŸ†'}</span><span class="text-[10px] text-slate-300">${ach.name}</span>`;
                    div.onclick = (e) => selectFeature('nameCardBorder', `border-color:${borderColor}`);
                    nameCardBorderGrid.appendChild(div);
                });
            } else {
                nameCardBorderGrid.innerHTML = '<div class="text-center text-slate-500 text-xs py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ù…Ø­Ù‚Ù‚Ø© Ø¨Ø¹Ø¯</div>';
            }
        }

        function saveSelectedFeature() {
            if (currentFeatureSelection.value === undefined) return; // Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø´ÙŠØ¡
            
            socket.emit('update user feature', {
                feature: currentFeatureSelection.feature,
                value: currentFeatureSelection.value,
                currentUser: currentUser
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙˆØ±Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            if (currentUser) {
                currentUser[currentFeatureSelection.feature] = currentFeatureSelection.value;
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ÙŠØ²Ø§Øª
        function initFeaturesUI() {
            // 1. Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø§Ø³Ù…
            const colors = [
                'text-red-500', 'text-orange-500', 'text-yellow-400', 'text-green-500', 'text-cyan-400',
                'text-blue-500', 'text-indigo-500', 'text-purple-500', 'text-pink-500', 'text-lime-400',
                'text-emerald-500', 'text-white'
            ];
            const colorGrid = document.getElementById('nameColorGrid');
            colorGrid.innerHTML = '';
            colors.forEach(color => {
                const div = document.createElement('div');
                div.className = `color-option ${color.replace('text-', 'bg-')}`;
                div.onclick = (e) => selectFeature('nameColor', color);
                colorGrid.appendChild(div);
            });

            // 2. Ø®Ù„ÙÙŠØ§Øª Ø§Ù„Ø§Ø³Ù…
            const backgrounds = [
                'bg-red-600', 'bg-blue-600', 'bg-green-600', 'bg-purple-600', 
                'bg-yellow-600', 'bg-pink-600', 'bg-gray-600', 'bg-indigo-900',
                'bg-gradient-to-r from-purple-500 to-pink-500', 'bg-gradient-to-r from-blue-500 to-teal-400'
            ];
            const bgGrid = document.getElementById('nameBackgroundGrid');
            // Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø± "Ø¨Ø¯ÙˆÙ† Ø®Ù„ÙÙŠØ©" ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø§Ù‚ÙŠ
            backgrounds.forEach(bg => {
                const div = document.createElement('div');
                div.className = `cursor-pointer p-2 rounded text-center text-white text-xs ${bg} border border-transparent hover:border-white`;
                div.textContent = 'Aa';
                div.onclick = (e) => selectFeature('nameBackground', bg);
                bgGrid.appendChild(div);
            });

            // 3. Ø¥Ø·Ø§Ø±Ø§Øª Ø§Ù„ØµÙˆØ±
            const frames = [
                { id: 'frame-none', name: 'Ø¨Ø¯ÙˆÙ†' },
                { id: 'frame-gold', name: 'Ø°Ù‡Ø¨ÙŠ' },
                { id: 'frame-silver', name: 'ÙØ¶ÙŠ' },
                { id: 'frame-red-glow', name: 'ØªÙˆÙ‡Ø¬ Ø£Ø­Ù…Ø±' },
                { id: 'frame-blue-glow', name: 'ØªÙˆÙ‡Ø¬ Ø£Ø²Ø±Ù‚' },
                { id: 'frame-rainbow', name: 'Ù‚ÙˆØ³ Ù‚Ø²Ø­' },
                { id: 'frame-neon-pulse', name: 'Ù†ÙŠÙˆÙ†' },
                { id: 'frame-fire', name: 'Ù†Ø§Ø±ÙŠ' },
                { id: 'frame-rotating', name: 'Ø¯ÙˆØ§Ø±' },
                { id: 'frame-diamond-sparkle', name: 'Ø§Ù„Ù…Ø§Ø³ Ø§Ù„Ø¨Ø±Ø§Ù‚ âœ¨' },
                { id: 'frame-electric', name: 'ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ âš¡' },
                { id: 'frame-magic-purple', name: 'Ø³Ø­Ø± Ø¨Ù†ÙØ³Ø¬ÙŠ ğŸ”®' },
                { id: 'frame-lava', name: 'Ø­Ù…Ù… Ø¨Ø±ÙƒØ§Ù†ÙŠØ© ğŸŒ‹' },
                { id: 'frame-royal-gold', name: 'Ø°Ù‡Ø¨ÙŠ Ù…Ù„ÙƒÙŠ ğŸ‘‘' },
                { id: 'frame-matrix', name: 'Ù…Ø§ØªØ±ÙŠÙƒØ³ ğŸ“Ÿ' },
                { id: 'frame-ghostly', name: 'Ø´Ø¨Ø­ ğŸ‘»' },
                { id: 'frame-double', name: 'Ù…Ø²Ø¯ÙˆØ¬' },
                { id: 'frame-dashed', name: 'Ù…ØªÙ‚Ø·Ø¹' }
            ];
            const frameGrid = document.getElementById('avatarFrameGrid');
            frameGrid.innerHTML = '';
            frames.forEach(frame => {
                const div = document.createElement('div');
                div.className = 'cursor-pointer p-2 rounded hover:bg-gray-700 flex flex-col items-center';
                div.onclick = (e) => selectFeature('avatarFrame', frame.id === 'frame-none' ? null : frame.id);
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-gray-600 ${frame.id}"></div>
                    <span class="text-[10px] mt-1 text-slate-300">${frame.name}</span>
                `;
                frameGrid.appendChild(div);
            });

            // 4. Ø®Ù„ÙÙŠØ§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
            const cardBackgrounds = [
                'bg-gradient-to-r from-slate-900 to-slate-700', 'bg-gradient-to-r from-zinc-900 to-stone-800',
                'bg-gradient-to-r from-red-900/80 to-red-800/60', 'bg-gradient-to-r from-orange-900/80 to-amber-800/60',
                'bg-gradient-to-r from-yellow-900/80 to-amber-700/60', 'bg-gradient-to-r from-green-900/80 to-emerald-800/60',
                'bg-gradient-to-r from-teal-900/80 to-cyan-800/60', 'bg-gradient-to-r from-blue-900/80 to-indigo-800/60',
                'bg-gradient-to-r from-indigo-900/80 to-violet-800/60', 'bg-gradient-to-r from-purple-900/80 to-fuchsia-800/60',
                'bg-gradient-to-r from-pink-900/80 to-rose-800/60', 'bg-gradient-to-r from-gray-800 to-gray-600'
            ];
            const cardBgGrid = document.getElementById('userCardBackgroundGrid');
            cardBackgrounds.forEach(bg => {
                const div = document.createElement('div');
                div.className = `cursor-pointer h-10 rounded-lg border border-transparent hover:border-white ${bg}`;
                div.onclick = (e) => selectFeature('userCardBackground', bg);
                cardBgGrid.appendChild(div);
            });

            // 5. Ø®Ù„ÙÙŠØ§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            const profileBgs = [
                'bg-gradient-to-br from-slate-800 to-slate-900',
                'bg-gradient-to-br from-red-800 to-rose-900',
                'bg-gradient-to-br from-sky-800 to-indigo-900',
                'bg-gradient-to-br from-emerald-800 to-teal-900',
                'bg-gradient-to-br from-amber-800 to-orange-900',
                'bg-gradient-to-br from-fuchsia-800 to-purple-900'
            ];
            const profileBgGrid = document.getElementById('profileBackgroundGrid');
            profileBgs.forEach(bg => {
                const div = document.createElement('div');
                div.className = `cursor-pointer h-10 rounded-lg border border-transparent hover:border-white ${bg}`;
                div.onclick = (e) => selectFeature('profileBackground', bg);
                profileBgGrid.appendChild(div);
            });

            // 6. Ø£Ù„ÙˆØ§Ù† Ø¥Ø·Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª)
            // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            // Ø³ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ updateNameCardBorderGrid Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
        }

        let currentRoom = null;
        let currentRoomSettings = {
            textColor: 'text-white',
            messageBackground: 'bg-gray-800'
        };
        let currentRoomBackground = null;
        let rooms = [];
        let roomsWithSettings = {};
        let roomsWithBackgrounds = {};
        let sessionChecked = false;
        let privateChatTarget = null;
        let friendRequests = [];
        let privateConversations = {};
        let friendsList = [];
        let userAvatars = {};
        let shopItems = [];
        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø±ØªØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±)
        let ranks = {
            'ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹': { color: 'from-red-600 to-orange-400', icon: 'ğŸ†', level: 6 },
            'Ø±Ø¦ÙŠØ³': { color: 'from-yellow-400 to-yellow-500', icon: 'ğŸ©', level: 5 },
            'Ø±Ø¦ÙŠØ³Ø©': { color: 'from-yellow-400 to-yellow-500', icon: 'ğŸ©', level: 5 },
            'Ù…Ù†Ø´Ø¦': { color: 'from-yellow-400 to-orange-500', icon: 'ğŸ‘‘', level: 4 },
            'Ø³ÙˆØ¨Ø± Ø§Ø¯Ù…Ù†': { color: 'from-red-500 to-pink-600', icon: 'â­', level: 3 },
            'Ø§Ø¯Ù…Ù†': { color: 'from-purple-500 to-indigo-600', icon: 'ğŸ›¡ï¸', level: 2 },
            'Ø¨Ø±ÙŠÙ…ÙŠÙˆÙ…': { color: 'from-green-500 to-emerald-600', icon: 'ğŸ’', level: 2 },
            'Ø¬ÙŠØ¯': { color: 'from-blue-500 to-cyan-600', icon: 'â‡ï¸', level: 1 }
        };
        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ø¬Ù†Ø­Ø© ÙˆØªÙƒÙˆÙŠÙ†Ù‡Ø§
        let wingsConfig = {
            owners: ['ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'Ø±Ø¦ÙŠØ³', 'Ø±Ø¦ÙŠØ³Ø©'],
            kings: ['Ù…Ù†Ø´Ø¦', 'Ø³ÙˆØ¨Ø± Ø§Ø¯Ù…Ù†', 'Ø§Ø¯Ù…Ù†'],
            distinguished: ['Ø¨Ø±ÙŠÙ…ÙŠÙˆÙ…', 'Ø¬ÙŠØ¯']
        };
        let previousOnlineUsernames = new Set();
        let isFirstUserLoad = true;
        const entrySound = new Audio('https://codeskulptor-demos.commondatastorage.googleapis.com/pang/pop.mp3');
        entrySound.volume = 0.4;
        const leaveSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2776/2776-preview.mp3'); // Leave sound
        leaveSound.volume = 0.6;
        leaveSound.preload = 'auto';

        const mentionSound = new Audio('/sounds/mention.mp3'); // Local mention sound
        mentionSound.volume = 0.8;
        mentionSound.preload = 'auto';

        // Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙƒ Ø­Ø¸Ø± Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„
        const unlockAudio = () => {
            [mentionSound, entrySound, leaveSound].forEach(sound => {
                sound.play().then(() => {
                    sound.pause();
                    sound.currentTime = 0;
                }).catch(e => console.log("Audio unlock failed for", sound.src, e));
            });
            document.removeEventListener('click', unlockAudio);
            document.removeEventListener('keydown', unlockAudio);
        };
        document.addEventListener('click', unlockAudio);
        document.addEventListener('keydown', unlockAudio);
        
        window.onlineUsersData = {}; // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹
        
        // ØªÙ†Ø³ÙŠÙ‚ ÙˆÙ‚Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø´ÙƒÙ„ Ø§Ø­ØªØ±Ø§ÙÙŠ
        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†ØµØ§Ù‹ (Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ BIGINT Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
            const ts = (typeof timestamp === 'string' && /^\d+$/.test(timestamp)) ? Number(timestamp) : timestamp;
            const date = new Date(ts);
            if (isNaN(date.getTime())) return '';
            
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${hours}:${minutes} ${day}/${month}`;
        }
        // --- Ø¯ÙˆØ§Ù„ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø±ØªØ¨ ---
        let tempRankIcon = null;

        function handleRankIconUpload() {
            const fileInput = document.getElementById('rankIconUpload');
            const file = fileInput.files[0];
            if (file) {
                if (file.size > 500 * 1024) { // 500KB limit
                     showNotification('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 500KB)', 'error');
                     return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempRankIcon = e.target.result;
                    document.getElementById('rankIconPreview').src = tempRankIcon;
                    document.getElementById('rankIconPreviewContainer').classList.remove('hidden');
                    document.getElementById('customRankIcon').disabled = true;
                    document.getElementById('customRankIcon').placeholder = "(ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©)";
                    document.getElementById('customRankIcon').value = '';
                };
                reader.readAsDataURL(file);
            }
        }

        function clearRankIconImage() {
            tempRankIcon = null;
            document.getElementById('rankIconUpload').value = '';
            document.getElementById('rankIconPreviewContainer').classList.add('hidden');
            document.getElementById('customRankIcon').disabled = false;
            document.getElementById('customRankIcon').placeholder = "Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ù…Ø«Ø§Ù„: ğŸš€)";
        }

        function getRankIconHtml(icon, className = "text-xl") {
            // ØªÙ… Ø¥Ø¶Ø§ÙØ© transform: translateY(2px) Ù„Ø¥Ù†Ø²Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªÙƒÙˆÙ† ÙÙŠ Ù†ÙØ³ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù†Øµ
            if (icon && (icon.startsWith('data:image') || icon.startsWith('http'))) return `<img src="${icon}" class="${className} inline-block object-contain" style="width: 1.5em; height: 1.5em; vertical-align: middle; transform: translateY(2px);">`;
            return `<span class="${className}">${icon || ''}</span>`;
        }

        // --- Ø¯ÙˆØ§Ù„ Ù†Ø§ÙØ°Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· (ØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…) ---

        function openSendPointsModal(username) {
            const modal = document.getElementById('sendPointsModal');
            const title = document.getElementById('sendPointsToUser');
            const input = document.getElementById('pointsAmountInput');

            title.textContent = `Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${username}`;
            modal.dataset.username = username;
            input.value = '';
            modal.classList.add('show');
        }

        function closeSendPointsModal() {
            document.getElementById('sendPointsModal').classList.remove('show');
        }

        // --- Ø¯ÙˆØ§Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØªØ¬Ø± ---
        function openShopModal() {
            const modal = document.getElementById('shopModal');
            const overlay = document.getElementById('shopOverlay');
            modal.classList.add('show');
            overlay.classList.add('show');
            
            // Ø·Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
            socket.emit('get shop items');
        }

        function closeShopModal() {
            const modal = document.getElementById('shopModal');
            const overlay = document.getElementById('shopOverlay');
            modal.classList.remove('show');
            overlay.classList.remove('show');
        }

        // --- Ø¯ÙˆØ§Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· (ØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…) ---
        function sendPoints() {
            const toUser = document.getElementById('profileUsername').textContent;
            if (!toUser || toUser === currentUser.name) {
                showNotification('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ù†Ù‚Ø§Ø· Ù„Ù†ÙØ³Ùƒ.', 'error');
                return;
            }
            openSendPointsModal(toUser);
        }

        function submitSendPoints() {
            const modal = document.getElementById('sendPointsModal');
            const toUser = modal.dataset.username;
            const amountInput = document.getElementById('pointsAmountInput');
            const amount = parseInt(amountInput.value, 10);

            if (isNaN(amount) || amount <= 0) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· ØµØ­ÙŠØ­ ÙˆØ£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.', 'error');
                return;
            }

            if (amount > 10000) {
                showNotification('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· Ù‡Ùˆ 10,000 Ù†Ù‚Ø·Ø©.', 'error');
                return;
            }

            socket.emit('send points', { fromUser: currentUser.name, toUser: toUser, amount: amount });
            closeSendPointsModal();
        }

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ± Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    socket.on('user avatars data', (avatarsData) => {
        userAvatars = { ...userAvatars, ...avatarsData };
        updateFriendsList();
        updateOnlineUsersAvatars();
    });
     // Ø·Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ± Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„
    socket.on('connect', () => {
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        if (currentUser && currentRoom) {
             socket.emit('join room', { roomId: currentRoom.id, user: currentUser });
             showNotification('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„.', 'success');
        }

        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø¹Ø¯ØŒ Ø§Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        const savedSession = localStorage.getItem('userSession');
        if (savedSession) {
            try {
                const sessionData = JSON.parse(savedSession);
                if (sessionData && sessionData.sessionId) {
                    socket.emit('check session', sessionData.sessionId);
                }
            } catch (e) { /* ignore */ }
        }
        // ØªØ£ÙƒÙŠØ¯ Ø£Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ù‚Ø¯ ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§ Ø®Ù„Ø§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„
        if (!sessionChecked) {
            // Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© ÙƒÙ…Ù†ØªÙ‡ÙŠØ© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¥Ø°Ø§ Ù„Ù… ÙŠØ£Øª Ø±Ø¯
            setTimeout(() => {
                if (!sessionChecked) {
                    console.warn('Ù„Ù… ÙŠØµÙ„ Ø±Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„. Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙƒØ­Ø§Ù„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.');
                    sessionChecked = true;
                    hideLoading();
                }
            }, 3000);
        }
    });

    socket.on('connect_error', (err) => {
        sessionChecked = true;
        hideLoading();
        showNotification('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
    });

    socket.on('disconnect', (reason) => {
        if (currentRoom) {
            if (reason === 'io server disconnect') {
                showNotification('ØªÙ… Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø§Ø¯Ù….', 'error');
            }
            // ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¹Ø¯Ù… Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ù…Ø¤Ù‚Øª
            if (reason === 'io server disconnect') {
                goBack(true); 
            }
        }
    });
        // ØªØªØ¨Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
let unreadPrivateMessages = {};

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
function updateUnreadBadges() {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
    const friendElements = document.querySelectorAll('#friendsList .friend-item');
    friendElements.forEach(element => {
        const usernameElement = element.querySelector('.text-white.font-medium');
        if (usernameElement) {
            const username = usernameElement.textContent;
            const unreadCount = unreadPrivateMessages[username] || 0;
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
            const existingBadge = element.querySelector('.unread-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©
            if (unreadCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'unread-badge absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white rounded-full text-xs h-5 w-5 flex items-center justify-center';
                badge.textContent = unreadCount;
                
                const avatarContainer = element.querySelector('.relative');
                if (avatarContainer) {
                    avatarContainer.appendChild(badge);
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø²Ø± ÙØ­Øµ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
                const profileButton = element.querySelector('button[onclick^="showUserProfileModal"]');
                if (profileButton) {
                    let profileBadge = profileButton.querySelector('.unread-badge');
                    if (!profileBadge) {
                        profileBadge = document.createElement('span');
                        profileBadge.className = 'unread-badge absolute -top-1 -right-1 bg-red-500 text-white rounded-full text-xs h-4 w-4 flex items-center justify-center';
                        profileButton.style.position = 'relative';
                        profileButton.appendChild(profileBadge);
                    }
                    profileBadge.textContent = unreadCount;
                    profileBadge.classList.remove('hidden');
                }
            } else {
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©
                const profileButton = element.querySelector('button[onclick^="showUserProfileModal"]');
                if (profileButton) {
                    const profileBadge = profileButton.querySelector('.unread-badge');
                    if (profileBadge) {
                        profileBadge.classList.add('hidden');
                    }
                }
            }
        }
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø²Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
    const privateChatButton = document.getElementById('privateChatButton');
    if (privateChatButton) {
        const username = privateChatButton.getAttribute('data-username');
        if (username) {
            const unreadCount = unreadPrivateMessages[username] || 0;
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
            const existingBadge = privateChatButton.querySelector('.unread-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©
            if (unreadCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'unread-badge absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white rounded-full text-xs h-5 w-5 flex items-center justify-center';
                badge.textContent = unreadCount;
                privateChatButton.style.position = 'relative';
                privateChatButton.appendChild(badge);
            }
        }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø²Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    updateMessagesBadge();
}
        // ØµÙˆØ± Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        const defaultAvatars = {
            'boy1': DEFAULT_AVATAR_URL,
            'boy2': DEFAULT_AVATAR_URL,
            'boy3': DEFAULT_AVATAR_URL,
            'girl1': DEFAULT_AVATAR_URL,
            'girl2': DEFAULT_AVATAR_URL,
            'girl3': DEFAULT_AVATAR_URL,
            'guest': DEFAULT_AVATAR_URL
        };

        // Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const toggleUsersButton = document.getElementById('toggleUsersButton');
        const onlineUsersPanel = document.getElementById('onlineUsersPanel');
        const usersOverlay = document.getElementById('usersOverlay');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const profileButton = document.getElementById('profileButton');
        const messagesButton = document.getElementById('messagesButton');
        const friendsButton = document.getElementById('friendsButton');

        // ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø²Ø§Ø¦Ø±
        loginTab.addEventListener('click', () => {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            guestForm.classList.add('hidden');
            loginTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 bg-gradient-to-r from-blue-600 to-blue-500 text-white shadow-lg';
            registerTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white';
            guestTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white';
        });

        registerTab.addEventListener('click', () => {
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            guestForm.classList.add('hidden');
            registerTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 bg-gradient-to-r from-green-600 to-emerald-500 text-white shadow-lg';
            loginTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white';
            guestTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white';
        });

        guestTab.addEventListener('click', () => {
            guestForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            registerForm.classList.add('hidden');
            guestTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 bg-gradient-to-r from-purple-600 to-indigo-500 text-white shadow-lg';
            loginTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white';
            registerTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white';
        });

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù€ rememberMe Ù…Ø®ØµØµ
        const rememberMeInput = document.getElementById('rememberMe');
        const rememberMeCustom = document.getElementById('rememberMeCustom');
        if (rememberMeInput && rememberMeCustom) {
            rememberMeInput.addEventListener('change', () => {
                const check = rememberMeCustom.querySelector('div');
                if (rememberMeInput.checked) {
                    check.classList.remove('scale-0');
                    check.classList.add('scale-100');
                    rememberMeCustom.classList.add('border-blue-500');
                } else {
                    check.classList.add('scale-0');
                    check.classList.remove('scale-100');
                    rememberMeCustom.classList.remove('border-blue-500');
                }
            });
        }

        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        profileButton.addEventListener('click', () => {
            showUserProfileModal(currentUser.name);
        });

        messagesButton.addEventListener('click', () => {
            // Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø£Ùˆ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            openFriendsSidebar();
        });

        friendsButton.addEventListener('click', () => {
            openFriendsSidebar();
        });

        // Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ¥Ø®ÙØ§Ø¡ Ø³Ø¨ÙŠÙ†Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        function showLoading() {
            loadingSpinner.classList.remove('hidden');
        }

        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }

        // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© (Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠØŒ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ØŒ Ø§Ù„ØµÙˆØ±) Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
        function loadBackgroundData() {
            if (!currentUser) return;
            console.log('Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©...');
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø¯Ø« ÙˆØ§Ø­Ø¯ Ù…Ø¬Ù…Ø¹ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ§Øª Ø§Ù„Ø¶Ø¹ÙŠÙØ©
            socket.emit('get initial data', currentUser.name);
        }

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©
        socket.on('initial data', (data) => {
            console.log('ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©');
            if (data.friendRequests) friendRequests = data.friendRequests;
            if (data.friendsList) friendsList = data.friendsList;
            if (data.userAvatars) userAvatars = data.userAvatars;
            
            if (data.unreadCounts) {
                updateMessagesBadge(data.unreadCounts.privateMessages);
                updateNotificationsBadge(data.unreadCounts.notifications > 0);
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            updateFriendRequests();
            updateFriendsList();
            updateUnreadBadges();
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('DOMContentLoaded', async () => {
            applyBackground(); // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙˆØ±Ø§Ù‹
            showLoading();
            try {
                const response = await fetch('/check-auth');
                const data = await response.json();

                if (data.authenticated) {
                    handleSessionValid(data.user);
                } else {
                    handleSessionInvalid();
                }
            } catch (error) {
                console.error('ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', error);
                handleSessionInvalid();
            }
        });


        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©
        function handleSessionValid(userData) {
            currentUser = userData;
            // Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ ÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ currentUser
            if (userData.nameCardBorder) currentUser.nameCardBorder = userData.nameCardBorder;
            
            updateHeaderUserInfo();
            showNotification(`Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ ${userData.name}! ğŸ˜Š`, 'success');
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø³Ø±Ø¹Ø©
            const savedRoom = localStorage.getItem('currentRoom');
            if (savedRoom) {
                try {
                    const roomData = JSON.parse(savedRoom);
                    if (roomData && roomData.id) {
                        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØºØ±Ù Ù…Ø­Ù…Ù„Ø©ØŒ Ø§Ø¯Ø®Ù„ ÙÙˆØ±Ø§Ù‹ØŒ ÙˆØ¥Ù„Ø§ Ø§Ù†ØªØ¸Ø± Ø£ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ù„Ù„ØºØ±Ù
                        if (rooms.length > 0) {
                            rooms.forEach(r => {
                                if (r.background) roomsWithBackgrounds[r.id] = r.background;
                                if (r.settings) roomsWithSettings[r.id] = r.settings;
                            });
                            openChat(roomData.id, roomData.name, roomData.icon);
                        } else {
                            // Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØºØ±ÙØ© Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ 'rooms update' Ø§Ù„Ø£ÙˆÙ„
                            const entryHandler = (updatedRooms) => {
                                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
                                updatedRooms.forEach(room => {
                                    if (room.settings) roomsWithSettings[room.id] = room.settings;
                                    if (room.background) roomsWithBackgrounds[room.id] = room.background;
                                });
                                rooms = updatedRooms;
                                openChat(roomData.id, roomData.name, roomData.icon);
                                socket.off('rooms update', entryHandler); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
                            };
                            socket.on('rooms update', entryHandler);
                            // Ø­Ø¯ Ø²Ù…Ù†ÙŠ Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø±
                            setTimeout(() => socket.off('rooms update', entryHandler), 5000);
                            showMainPage();
                        }
                        return;
                    }
                } catch (e) {
                    localStorage.removeItem('currentRoom');
                }
            }

            showMainPage();
            hideLoading();
        }

        function handleSessionInvalid() {
            console.log('Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©ØŒ Ø¬Ø§Ø±ÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...');
            localStorage.removeItem('currentRoom');
            currentUser = null;
            sessionChecked = true;
            hideLoading();
            document.getElementById('loginPage').classList.remove('hidden');
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„ÙˆÙ† Ø§Ù„Ø§Ø³Ù… (ÙƒÙ„Ø§Ø³ Ø£Ùˆ Ø³ØªØ§ÙŠÙ„)
        function getUserNameStyle(colorValue) {
            if (!colorValue) return { class: 'text-gray-200', style: '' };
            if (colorValue.startsWith('color:')) {
                return { class: '', style: `color: ${colorValue.split(':')[1]}` };
            }
            if (colorValue.startsWith('text-gradient-')) {
                return { class: colorValue, style: '' };
            }
            return { class: colorValue, style: '' };
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø±Ø£Ø³
        function updateHeaderUserInfo() {
            if (currentUser) {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ… Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                const adminControlRoomBtn = document.getElementById('adminControlRoomBtn');
                if (adminControlRoomBtn) {
                    if (currentUser.isSiteOwner || currentUser.name === 'Walid dz 31') {
                        adminControlRoomBtn.classList.remove('hidden');
                    } else {
                        adminControlRoomBtn.classList.add('hidden');
                    }
                }

                const headerUsernameElem = document.getElementById('headerUsername');
                if (headerUsernameElem) {
                    headerUsernameElem.textContent = currentUser.name;
                }
                
                const headerAvatarContainer = document.querySelector('#profileButton .w-8.h-8');
                if (headerAvatarContainer) {
                    headerAvatarContainer.style.border = '';
                    if (currentUser.avatarFrame && currentUser.avatarFrame.startsWith('border-color:')) {
                        headerAvatarContainer.className = `w-8 h-8 rounded-full flex items-center justify-center text-white relative`;
                        headerAvatarContainer.style.border = `2px solid ${currentUser.avatarFrame.split(':')[1]}`;
                    } else {
                        headerAvatarContainer.className = `w-8 h-8 rounded-full flex items-center justify-center text-white relative ${currentUser.avatarFrame || 'bg-blue-600'}`;
                    }
                    const headerAvatarInitialElem = document.getElementById('headerAvatarInitial');
                    if (headerAvatarInitialElem) {
                        headerAvatarInitialElem.textContent = currentUser.name.charAt(0).toUpperCase();
                    }
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                socket.emit('get avatar', currentUser.name);
            }
        }

        socket.on('avatar data', (data) => {
            if (data.username === currentUser.name && data.avatarUrl) {
                const headerAvatar = document.querySelector('#profileButton .w-8.h-8');
                if (headerAvatar) {
                    let frameStyle = '';
                    let frameClass = '';
                    if (currentUser.avatarFrame && currentUser.avatarFrame.startsWith('border-color:')) {
                        frameStyle = `border: 2px solid ${currentUser.avatarFrame.split(':')[1]};`;
                    } else {
                        frameClass = currentUser.avatarFrame || '';
                    }
                    headerAvatar.innerHTML = `<div class="w-full h-full rounded-full relative ${frameClass}" style="${frameStyle}"><img src="${data.avatarUrl}" class="w-full h-full rounded-full object-cover" alt="${data.username}"></div>`;
                    headerAvatar.className = "w-8 h-8 rounded-full flex items-center justify-center text-white relative";
                }
            }
        });

        // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            showLoading();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            socket.emit('user login', { username, password, rememberMe });
        });

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            showLoading();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const gender = document.querySelector('input[name="gender"]:checked')?.value;
            
            if (!gender) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³!', 'error');
                hideLoading();
                return;
            }
            
            socket.emit('user register', { username, password, gender });
        });

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¯Ø®ÙˆÙ„ Ø²Ø§Ø¦Ø±
        guestForm.addEventListener('submit', (e) => {
            e.preventDefault();
            showLoading();
            const username = document.getElementById('guestUsername').value;
            const gender = document.querySelector('input[name="guestGender"]:checked')?.value;
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§ÙŠÙ…ÙˆØ¬ÙŠ
            const emojiRegex = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/u;
            if (emojiRegex.test(username)) {
                showNotification('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© (Emojis) ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ø²Ø§Ø¦Ø±!', 'error');
                hideLoading();
                return;
            }

            if (!gender) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ù†Ø³!', 'error');
                hideLoading();
                return;
            }
            
            socket.emit('user guest login', { username, gender });
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù†ØªØ§Ø¦Ø¬ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø²Ø§Ø¦Ø±
        socket.on('guest success', (userData) => {
            currentUser = userData;
            handleSessionValid(userData);
        });

        socket.on('guest error', (error) => {
            showNotification(error, 'error');
            hideLoading();
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù†ØªØ§Ø¦Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        socket.on('login success', (userData) => {
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙˆÙƒÙŠ Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
            currentUser = userData; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹
            currentUser.nameColor = userData.nameColor; // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø§Ù„Ø§Ø³Ù…
            currentUser.bio = userData.bio; // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ bio
            currentUser.nameBackground = userData.nameBackground;
            currentUser.avatarFrame = userData.avatarFrame;
            currentUser.userCardBackground = userData.userCardBackground;
            currentUser.profileBackground = userData.profileBackground;
            currentUser.profileCover = userData.profileCover;
            currentUser.nameCardBorder = userData.nameCardBorder;

            document.cookie = `sessionId=${userData.sessionId}; path=/; max-age=31536000; SameSite=Lax`; // ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù…Ø¯Ø© Ø³Ù†Ø©
            handleSessionValid(userData);
            // Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø§Ø¬Ø­ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (currentUser) {
                toggleBackgroundButton();
            }

        });

        socket.on('login error', (error) => {
            showNotification(error, 'error');
            hideLoading();
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù†ØªØ§Ø¦Ø¬ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
        socket.on('register success', (userData) => {
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙˆÙƒÙŠ Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
            currentUser = userData; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙˆØ±Ø§Ù‹
            currentUser.nameColor = null; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            currentUser.bio = null; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            currentUser.nameCardBorder = null;

            document.cookie = `sessionId=${userData.sessionId}; path=/; max-age=31536000; SameSite=Lax`; // ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù…Ø¯Ø© Ø³Ù†Ø©
            handleSessionValid(userData);
            
            // Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (currentUser) {
                toggleBackgroundButton();
            }
        });

        socket.on('register error', (error) => {
            showNotification(error, 'error');
            hideLoading();
        });

        // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø£Ø¬Ù†Ø­Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØªØ¨
        function updateWingsConfig() {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙƒÙˆÙŠÙ†
            wingsConfig = { owners: [], kings: [], distinguished: [] };
            
            // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø±ØªØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù†Ø­Ø©
            for (const [rankName, rankData] of Object.entries(ranks)) {
                if (rankData.wingId === 'owners' || rankData.level >= 5) wingsConfig.owners.push(rankName);
                else if (rankData.wingId === 'kings' || rankData.level >= 3) wingsConfig.kings.push(rankName);
                else if (rankData.wingId === 'distinguished' || rankData.level >= 2) wingsConfig.distinguished.push(rankName);
            }
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø¹Ø±ÙˆØ¶Ø©
            const currentUsers = Array.from(document.querySelectorAll('#onlineUsersList > div[data-username]')).map(el => ({name: el.dataset.username, rank: ranks[el.dataset.username]?.rank})); // Ù‡Ø°Ø§ ØªÙ‚Ø±ÙŠØ¨ÙŠØŒ Ø§Ù„Ø£ÙØ¶Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        }

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØºØ±Ù
        socket.on('rooms update', (updatedRooms) => {
            rooms = updatedRooms;
            loadRooms();
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        socket.on('users update', (users) => {
            updateOnlineUsersList(users);
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©
        socket.on('new message', (message) => {
            if (message.type === 'user' || (message.type === 'image' && message.user) || message.replyTo) {
                addMessageToChat(message.user, message.content, message.time, message.user === currentUser.name, message.rank, message.avatar, message.messageId, message.replyTo, null, message.timestamp, message.badges, message.nameCardBorder);
            } else if (message.type === 'system') {
                addSystemMessage(message, message.time, null, message.timestamp);
            } else {
                addSystemMessage(message, message.time, null, message.timestamp);
            }
            // ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø³ÙÙ„ Ø¹Ù†Ø¯ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
            setTimeout(scrollToBottom, 100);
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Ù…Ø­Ø¯Ø« Ù„Ø¯Ø¹Ù… Ø§Ù„ØµÙˆØ±)
socket.on('chat history', (messages) => {
    const container = document.getElementById('messagesContainer');
    container.innerHTML = '';

    // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
    const loadMoreBtn = document.createElement('button');
    loadMoreBtn.id = 'loadMoreBtn';
    loadMoreBtn.className = 'w-full py-2 text-sm text-blue-400 hover:text-blue-300 transition-colors mb-2 font-medium';
    loadMoreBtn.innerHTML = '<span>â†» ØªØ­Ù…ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø£Ù‚Ø¯Ù…</span>';
    loadMoreBtn.onclick = loadMoreMessages;
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù‚Ù„ÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹ (Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¯ÙØ¹Ø©)
    if (messages.length < 25) loadMoreBtn.style.display = 'none';
    
    container.appendChild(loadMoreBtn);
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… DocumentFragment Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©)
    const fragment = document.createDocumentFragment();
    
    messages.forEach(msg => {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ messageIdØŒ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯ Ø­Ù‚ÙŠÙ‚ÙŠ ÙˆÙÙˆØ±ÙŠ
        if (!msg.messageId) {
            msg.messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        if (msg.type === 'user') {
            addMessageToChat(msg.user, msg.content, msg.time, msg.user === currentUser.name, msg.rank, msg.avatar, msg.messageId, msg.replyTo, fragment, msg.timestamp, msg.badges, msg.nameCardBorder);
        } else if (msg.type === 'image') {
            addImageMessageToChat(msg.user, msg.imageData, msg.time, msg.user === currentUser.name, msg.rank, msg.avatar, msg.messageId, fragment, msg.timestamp, msg.replyTo, msg.badges, msg.nameCardBorder);
        } else {
            addSystemMessage(msg, msg.time, fragment, msg.timestamp);
        }
    });
    
    container.appendChild(fragment);
    
    // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
    setTimeout(() => {
        container.scrollTop = container.scrollHeight;
    }, 100);
    hideLoading();
    loadBackgroundData(); // ØªØ­Ù…ÙŠÙ„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù† Ø¨Ø¹Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
});

        // Ø¯Ø§Ù„Ø© Ø·Ù„Ø¨ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function loadMoreMessages() {
            const container = document.getElementById('messagesContainer');
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© ÙØ¹Ù„ÙŠØ© (ØªØ¬Ø§Ù‡Ù„ Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„)
            const firstMessage = container.querySelector('.chat-message');
            if (!firstMessage) return;

            const firstMessageId = firstMessage.getAttribute('data-message-id');
            if (!firstMessageId) return;

            const btn = document.getElementById('loadMoreBtn');
            if (btn) btn.innerHTML = '<span class="spinner inline-block w-4 h-4 border-2 border-blue-400 border-t-transparent rounded-full animate-spin ml-2"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';

            socket.emit('load more messages', {
                roomId: currentRoom.id,
                firstMessageId: firstMessageId
            });
        }

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        socket.on('more chat history', (messages) => {
            const btn = document.getElementById('loadMoreBtn');
            if (messages.length === 0) {
                if (btn) btn.style.display = 'none';
                return;
            }
            if (btn) btn.innerHTML = '<span>â†» ØªØ­Ù…ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø£Ù‚Ø¯Ù…</span>';

            const container = document.getElementById('messagesContainer');
            const oldHeight = container.scrollHeight;
            const fragment = document.createDocumentFragment();

            messages.forEach(msg => {
                if (msg.type === 'user') {
                    addMessageToChat(msg.user, msg.content, msg.time, msg.user === currentUser.name, msg.rank, msg.avatar, msg.messageId, msg.replyTo, fragment, msg.timestamp, msg.badges, msg.nameCardBorder);
                } else if (msg.type === 'image') {
                    addImageMessageToChat(msg.user, msg.imageData, msg.time, msg.user === currentUser.name, msg.rank, msg.avatar, msg.messageId, fragment, msg.timestamp, msg.replyTo, msg.badges, msg.nameCardBorder);
                }
            });

            // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯ Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆÙ‚Ø¨Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            container.insertBefore(fragment, btn.nextSibling);
            
            // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±
            container.scrollTop = container.scrollHeight - oldHeight;
        });

        socket.on('feature success', (msg) => {
            showNotification(msg, 'success');
        });

        socket.on('feature error', (msg) => {
            showNotification(msg, 'error');
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø±ØªØ¨
        socket.on('rank success', (message) => {
            showNotification(message, 'success');
        });

        socket.on('rank error', (error) => {
            showNotification(error, 'error');
        });
        
        socket.on('rank expired', (message) => {
            showNotification(message, 'warning');
        });

        socket.on('show ranks', (message) => {
            addSystemMessage(message.content, message.time);
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        socket.on('message error', (error) => {
            showNotification(error, 'error');
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØµÙˆØ±
        socket.on('avatar updated', (data) => {
            showNotification(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© Ù„Ù€ ${data.username}`, 'success');
            updateHeaderUserInfo();
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ø§Ù‹
            const profileUsername = document.getElementById('profileUsername').textContent;
            if (profileUsername === data.username) {
                const profileAvatar = document.getElementById('profileAvatar');
                if (profileAvatar) {
                    profileAvatar.src = data.avatarUrl;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­Ø°Ù Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù„Ù
                    if (data.username === currentUser.name) {
                        const removeProfilePicBtn = document.getElementById('removeProfilePicBtn');
                        if (removeProfilePicBtn) {
                            if (data.avatarUrl && data.avatarUrl !== DEFAULT_AVATAR_URL) {
                                removeProfilePicBtn.classList.remove('hidden');
                            } else {
                                removeProfilePicBtn.classList.add('hidden');
                            }
                        }
                    }
                }
            }
        });

        socket.on('avatar error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('user avatar updated', (data) => {
            updateOnlineUsersAvatars(data.username, data.avatarUrl);
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ø§Ù‹
            const profileUsername = document.getElementById('profileUsername').textContent;
            if (profileUsername === data.username) {
                const profileAvatar = document.getElementById('profileAvatar');
                if (profileAvatar) profileAvatar.src = data.avatarUrl;
            }
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù†ØªØ§Ø¦Ø¬ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        socket.on('management success', (message) => {
            showNotification(message, 'success');
        });

        socket.on('management error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('user status', (message) => {
            addSystemMessage(message.content, message.time);
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø¸Ø±
        socket.on('banned from room', (data) => {
            showNotification(`ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† ØºØ±ÙØ© ${data.room}. Ø§Ù„Ø³Ø¨Ø¨: ${data.reason}`, 'error');
            goBack();
        });

        socket.on('banned from site', (data) => {
            showNotification(`ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ø§Ù„Ø³Ø¨Ø¨: ${data.reason}`, 'error');
            logout();
        });

        socket.on('user deleted', () => {
            showNotification('ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', 'error');
            logout();
        });

        socket.on('user warned', (data) => {
            // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù†Ø¨Ø«Ù‚ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            alert(`âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø¯Ø§Ø±ÙŠ!\n\nØªÙ… ØªÙˆØ¬ÙŠÙ‡ ØªØ­Ø°ÙŠØ± Ù„Ùƒ Ù…Ù† Ù‚Ø¨Ù„ ${data.from}.\nØ§Ù„Ø³Ø¨Ø¨: ${data.reason}`);
            showNotification(`âš ï¸ ØªØ­Ø°ÙŠØ±: ${data.reason}`, 'warning');
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
        socket.on('user profile data', (data) => {
            showUserProfile(data);
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø®Ø§ØµØ©
        socket.on('private message sent', (message) => {
            addPrivateMessageToChat(message, true);
        });

        socket.on('new private message', (message) => {
    if (privateChatTarget && message.from === privateChatTarget) {
        addPrivateMessageToChat(message, false);
    } else {
        // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (!unreadPrivateMessages[message.from]) {
            unreadPrivateMessages[message.from] = 0;
        }
        unreadPrivateMessages[message.from]++;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        updateUnreadBadges();
        
        showNotification(`Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† ${message.from}`, 'info');
    }
});

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ© (Ù…Ø­Ø¯Ø« Ù„Ø¯Ø¹Ù… Ø§Ù„ØµÙˆØ±)
socket.on('private messages history', (messages) => {
    const container = document.getElementById('privateChatMessages');
    if (!container) return;
    
    // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø£Ùˆ ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    container.innerHTML = '';
    
    if (messages.length === 0) {
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full text-slate-500 opacity-50">
                <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <p class="text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø³Ø§Ø¨Ù‚Ø©</p>
            </div>
        `;
        return;
    }
    
    messages.forEach(msg => {
        if (msg.type === 'image') {
            addPrivateImageMessage(msg, msg.from === currentUser.name);
        } else {
            addPrivateMessageToChat(msg, msg.from === currentUser.name);
        }
    });
    
    setTimeout(() => {
        container.scrollTop = container.scrollHeight;
    }, 100);
});

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø£Ø­Ø¯Ø§Ø« Ù†Ø¸Ø§Ù… Ø§Ù„ØµØ¯Ø§Ù‚Ø§Øª
        socket.on('new friend request', (data) => {
            showNotification(`Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯ Ù…Ù† ${data.fromUser}`, 'info');
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙˆØ±Ø§Ù‹
            if (!friendRequests.includes(data.fromUser)) {
                friendRequests.push(data.fromUser);
            }
            updateFriendRequests();
            updateMessagesBadge();
        });

        socket.on('friend request sent', (message) => {
            showNotification(message, 'success');
            // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù…ÙØªÙˆØ­Ø§Ù‹
            const addFriendButton = document.getElementById('addFriendButton');
            if (addFriendButton && addFriendButton.style.display !== 'none') {
                addFriendButton.innerHTML = `
                    <span>ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                `;
                addFriendButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                addFriendButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                addFriendButton.disabled = true;
            }
        });

        socket.on('friend request error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('friend request accepted', (data) => {
            showNotification(`Ù‚Ø¨Ù„ ${data.byUser} Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø©`, 'success');
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµØ¯ÙŠÙ‚ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙˆØ±Ø§Ù‹
            if (!friendsList.includes(data.byUser)) {
                friendsList.push(data.byUser);
            }
            // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ø¥Ù† ÙˆØ¬Ø¯
            friendRequests = friendRequests.filter(u => u !== data.byUser);
            
            updateFriendsList();
            updateFriendRequests();
            
            // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ø§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const profileUsername = document.getElementById('profileUsername').textContent;
            if (profileUsername === data.byUser) {
                const addFriendButton = document.getElementById('addFriendButton');
                if (addFriendButton) {
                    addFriendButton.innerHTML = `
                        <span>ØµØ¯ÙŠÙ‚</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    `;
                    addFriendButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-blue-600');
                    addFriendButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
                    addFriendButton.disabled = true;
                }
            }
        });

        socket.on('friend request processed', (message) => {
            showNotification(message, 'success');
            
            // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØªÙˆØ­Ø§Ù‹
            const profileUsername = document.getElementById('profileUsername').textContent;
            if (profileUsername && message.includes(profileUsername)) {
                if (!friendsList.includes(profileUsername)) {
                    friendsList.push(profileUsername);
                }
                const addFriendButton = document.getElementById('addFriendButton');
                if (addFriendButton) {
                    addFriendButton.innerHTML = `
                        <span>ØµØ¯ÙŠÙ‚</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    `;
                    addFriendButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-blue-600');
                    addFriendButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
                    addFriendButton.disabled = true;
                }
            }
            
            socket.emit('get friend requests', currentUser.name);
            socket.emit('get friends list', currentUser.name);
        });

        socket.on('friend removed', (message) => {
            showNotification(message, 'success');
            updateFriendsList();
        });

        socket.on('friend removed you', (data) => {
            showNotification(`Ø£Ø²Ø§Ù„Ùƒ ${data.byUser} Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡`, 'info');
            updateFriendsList();
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙØªØ­ Ø¥Ù†Ø¬Ø§Ø² Ø¬Ø¯ÙŠØ¯
        socket.on('achievement_unlocked', (data) => {
            const ach = data.achievement;
            showNotification(`ğŸ† ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ÙˆØ³Ø§Ù… Ø¬Ø¯ÙŠØ¯: ${ach.name}`, 'success');
            
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙˆØ±Ø§Ù‹
            if (currentUser) {
                currentUser.badges = data.allBadges || [];
            }

            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø¥Ø°Ø§ ÙˆØ¬Ø¯ Ø£Ùˆ ØµÙˆØª Ø§Ù„Ù†Ø¬Ø§Ø­
            if (window.successSound) successSound.play().catch(e => {});
        });

        socket.on('friend error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('friend requests list', (requests) => {
            friendRequests = requests;
            updateFriendRequests();
            updateMessagesBadge();
        });

        socket.on('friends list', (friends) => {
            friendsList = friends;
            updateFriendsList();
        });

        socket.on('search results', (results) => {
            displaySearchResults(results);
        });


        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ù„Ù„Ø¬ÙˆØ§Ù„
        toggleUsersButton.addEventListener('click', toggleUsersList);
        
        function toggleUsersList() {
            onlineUsersPanel.classList.toggle('show');
            usersOverlay.classList.toggle('show');
        }

        // ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
        function openFriendsSidebar() {
            document.getElementById('friendsSidebar').classList.add('show');
            document.getElementById('friendsOverlay').classList.add('show');
        }

        function closeFriendsSidebar() {
            document.getElementById('friendsSidebar').classList.remove('show');
            document.getElementById('friendsOverlay').classList.remove('show');
            // Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ¯Ø§Ø®Ù„ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
            setTimeout(() => {
                document.body.style.overflow = 'auto';
            }, 300);
        }

        // ØªØ­Ø¯ÙŠØ« Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©
        function updateFriendRequests() {
            const container = document.getElementById('friendRequestsList');
            const countElement = document.getElementById('friendRequestsCount');
            
            if (!container || !countElement) return;
            
            container.innerHTML = '';
            countElement.textContent = friendRequests.length;
            
            if (friendRequests.length === 0) {
                container.innerHTML = '<p class="text-blue-200 text-sm text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØµØ¯Ø§Ù‚Ø©</p>';
                return;
            }
            
            friendRequests.forEach(username => {
                const requestDiv = document.createElement('div');
                requestDiv.className = 'flex items-center justify-between bg-white/5 rounded-lg p-3 friend-item';
                requestDiv.innerHTML = `
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <div class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-white">
                            ${username.charAt(0).toUpperCase()}
                        </div>
                        <span class="text-white font-medium">${username}</span>
                    </div>
                    <div class="flex space-x-2 space-x-reverse">
                        <button onclick="acceptFriendRequest('${username}')" class="text-green-500 hover:text-green-300">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </button>
                        <button onclick="rejectFriendRequest('${username}')" class="text-red-500 hover:text-red-300">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;
                container.appendChild(requestDiv);
            });
        }

         // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ù…Ø¹ Ø§Ù„ØµÙˆØ±
    function updateFriendsList() {
        const container = document.getElementById('friendsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        friendsList.forEach(username => {
            const avatarUrl = userAvatars[username] || DEFAULT_AVATAR_URL;
            const friendDiv = document.createElement('div');
            friendDiv.className = 'flex items-center justify-between bg-white/5 rounded-lg p-3 friend-item';
            
            friendDiv.innerHTML = `
    <div class="flex items-center space-x-3 space-x-reverse">
        ${avatarUrl ? 
            `<img src="${avatarUrl}" class="w-8 h-8 rounded-full object-cover" alt="${username}">` :
            `<div class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-white">
                ${username.charAt(0).toUpperCase()}
            </div>`
        }
        <span class="text-white font-medium">${username}</span>
    </div>
    <div class="flex space-x-2 space-x-reverse">
        <button onclick="showUserProfileModal('${username}')" class="text-blue-500 hover:text-blue-300 relative">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span id="profileBadge_${username}" class="unread-badge hidden absolute -top-1 -right-1 bg-red-500 text-white rounded-full text-xs h-4 w-4 flex items-center justify-center"></span>
        </button>
        <button onclick="removeFriend('${username}')" class="text-red-500 hover:text-red-300">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
        </button>
    </div>
`;
            container.appendChild(friendDiv);
        });
    }

        // ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function updateMessagesBadge() {
    const badge = document.getElementById('messagesBadge');
    const chatBadge = document.getElementById('chatMessagesBadge');
    
    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
    let totalUnread = 0;
    for (const username in unreadPrivateMessages) {
        totalUnread += unreadPrivateMessages[username];
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    totalUnread += friendRequests.length;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    if (badge) {
        if (totalUnread > 0) {
            badge.textContent = totalUnread;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    if (chatBadge) {
        if (totalUnread > 0) {
            chatBadge.textContent = totalUnread;
            chatBadge.classList.remove('hidden');
        } else {
            chatBadge.classList.add('hidden');
        }
    }
}

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        function searchUsers() {
            const query = document.getElementById('userSearchInput').value.trim();
            
            if (query.length < 2) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„è‡³å°‘ Ø­Ø±ÙÙŠÙ† Ù„Ù„Ø¨Ø­Ø«', 'error');
                return;
            }
            
            socket.emit('search users', {
                query: query,
                currentUser: currentUser.name
            });
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (!container) return;
            
            container.innerHTML = '';
            container.classList.remove('hidden');
            
            if (results.length === 0) {
                container.innerHTML = '<p class="text-blue-200 text-sm text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
                return;
            }
            
            results.forEach(username => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'flex items-center justify-between py-2';
                resultDiv.innerHTML = `
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <div class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-white">
                            ${username.charAt(0).toUpperCase()}
                        </div>
                        <span class="text-white font-medium">${username}</span>
                    </div>
                    <button onclick="showUserProfileModal('${username}')" class="text-blue-500 hover:text-blue-300 text-sm">
                        Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù
                    </button>
                `;
                container.appendChild(resultDiv);
            });
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø©
        function sendFriendRequest() {
            const profileUsername = document.getElementById('profileUsername').textContent;
            
            if (profileUsername === currentUser.name) {
                showNotification('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø© Ù„Ù†ÙØ³Ùƒ', 'error');
                return;
            }
            
            socket.emit('send friend request', {
                fromUser: currentUser.name,
                toUser: profileUsername
            });
        }

        // Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø©
        function acceptFriendRequest(username) {
            socket.emit('accept friend request', {
                fromUser: username,
                toUser: currentUser.name
            });
        }

        // Ø±ÙØ¶ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø©
        function rejectFriendRequest(username) {
            socket.emit('reject friend request', {
                fromUser: username,
                toUser: currentUser.name
            });
        }

        // Ø¥Ø²Ø§Ù„Ø© ØµØ¯ÙŠÙ‚
        function removeFriend(username) {
            if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¥Ø²Ø§Ù„Ø© ${username} Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø£ØµØ¯Ù‚Ø§Ø¦ÙƒØŸ`)) {
                socket.emit('remove friend', {
                    username: currentUser.name,
                    friendToRemove: username
                });
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        function showMainPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            updateWelcomeMessage();
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ù† Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            document.getElementById('postsButton').parentElement.classList.add('hidden');
            document.getElementById('messagesButton').parentElement.classList.add('hidden');
            document.getElementById('friendsButton').classList.add('hidden');
            
            // Ø·Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºØ±Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
            fetch('/api/rooms')
                .then(response => response.json())
                .then(data => {
                    rooms = data;
                    loadRooms();
                });
        }

        // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
        function updateWelcomeMessage() {
            const welcomeElement = document.getElementById('welcomeMessage');
            if (welcomeElement && currentUser) {
                let rankBadge = '';
                if (currentUser.rank) {
                    const rankInfo = ranks[currentUser.rank] || { icon: '' };
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© getRankIconHtml Ù„ØªØ­ÙˆÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ØµÙˆØ±Ø© ÙØ¹Ù„ÙŠØ©
                    const iconHtml = getRankIconHtml(rankInfo.icon, "text-xl");
                    rankBadge = `<span class="inline-flex items-center mx-1" dir="ltr">(${currentUser.rank} ${iconHtml})</span>`;
                }
                welcomeElement.innerHTML = `ğŸ  Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.name} ${rankBadge}`;
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù
        function loadRooms() {
            const roomsContainer = document.getElementById('roomsContainer');
            if (!roomsContainer) return;
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… DocumentFragment Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
            const fragment = document.createDocumentFragment();
            
            // ÙØ±Ø² Ø§Ù„ØºØ±Ù Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø±Ø¶
            const sortedRooms = [...rooms].sort((a, b) => (a.order - b.order) || (a.id - b.id));
            
            sortedRooms.forEach(room => {
                const roomDiv = document.createElement('div');
                roomDiv.className = room.protected ? 
                    'bg-gradient-to-br from-red-900/30 to-orange-900/30 backdrop-blur-lg rounded-2xl p-6 hover:from-red-800/40 hover:to-orange-800/40 transition-all duration-300 relative group border-2 border-red-500/50' :
                    'bg-white/10 backdrop-blur-lg rounded-2xl p-6 hover:bg-white/20 transition-all duration-300 relative group';
                
                roomDiv.innerHTML = `
                    <div class="absolute top-4 right-4 bg-blue-600/50 text-white text-xs font-bold px-2.5 py-1 rounded-full flex items-center space-x-1 space-x-reverse backdrop-blur-sm">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <span>${room.userCount !== undefined ? room.userCount : (room.users ? room.users.length : 0)}</span>
                    </div>
                    <div class="cursor-pointer" onclick="${room.protected ? `openProtectedChat(${room.id}, '${room.name}', '${room.icon}')` : `openChat(${room.id}, '${room.name}', '${room.icon}')`}">
                        <div class="text-4xl mb-4 text-center">${room.icon}</div>
                        <h3 class="text-xl font-semibold text-white text-center mb-2">${room.name}</h3>
                        <p class="text-blue-200 text-center text-sm">${room.description}</p>
                        ${room.managers && room.managers.length > 0 ? `
                            <div class="mt-3 pt-3 border-t border-white/20">
                                <p class="text-xs text-slate-300 mb-1">ğŸ‘® Ù…Ø¯ÙŠØ±Ùˆ Ø§Ù„ØºØ±ÙØ©:</p>
                                <p class="text-xs text-yellow-300 font-semibold">${room.managers.join(', ')}</p>
                            </div>
                        ` : ''}
                        <div class="mt-4 text-center">
                            <span class="${room.protected ? 'bg-red-600' : 'bg-gray-500'} text-white px-3 py-1 rounded-full text-xs">
                                ${room.protected ? 'ğŸ”’ Ù…Ø­Ù…ÙŠØ©' : 'Ø§Ù†Ù‚Ø± Ù„Ù„Ø¯Ø®ÙˆÙ„'}
                            </span>
                        </div>
                    </div>
                `;
                
                fragment.appendChild(roomDiv);
            });

            // Ø¥Ø¶Ø§ÙØ© ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ… Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙ‚Ø·
            if (currentUser && (currentUser.isSiteOwner || currentUser.name === 'Walid dz 31')) {
                const controlDiv = document.createElement('div');
                controlDiv.className = 'bg-gradient-to-br from-slate-800 to-slate-900 border-2 border-blue-500/50 rounded-2xl p-6 hover:shadow-[0_0_20px_rgba(59,130,246,0.5)] transition-all duration-300 relative group cursor-pointer';
                controlDiv.onclick = openControlPanel;
                
                controlDiv.innerHTML = `
                    <div class="absolute top-4 right-4 bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded-full">
                        Ø®Ø§Øµ
                    </div>
                    <div class="text-4xl mb-4 text-center">âš™ï¸</div>
                    <h3 class="text-xl font-bold text-white text-center mb-2">ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ…</h3>
                    <p class="text-slate-400 text-center text-sm">Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø´Ø§Ù…Ù„Ø©</p>
                    <div class="mt-4 text-center">
                        <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-xs">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø§Ù„Ùƒ</span>
                    </div>
                `;
                fragment.appendChild(controlDiv);
            }

            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
            roomsContainer.innerHTML = '';
            roomsContainer.appendChild(fragment);
        }

        // ÙØªØ­ ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        function openChat(roomId, roomName, icon) {
            // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„Ø© ØªØ¹Ø·Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            // Ø³Ù†ÙƒØªÙÙŠ Ø¨ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
            previousOnlineUsernames.clear();
            isFirstUserLoad = true;

            currentRoom = { id: roomId, name: roomName, icon: icon };
            
            // Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØºØ±ÙØ©
            const roomSettings = roomsWithSettings[roomId] || {
                textColor: 'text-white',
                messageBackground: 'bg-gray-800'
            };
            currentRoomSettings = roomSettings;
            
            // Ø¬Ù„Ø¨ Ø®Ù„ÙÙŠØ© Ø§Ù„ØºØ±ÙØ©
            let roomBackground = roomsWithBackgrounds[roomId];
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ù…ØµÙÙˆÙØ© Ø§Ù„ØºØ±Ù Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            if (!roomBackground && rooms.length > 0) {
                const roomInList = rooms.find(r => r.id === roomId);
                if (roomInList && roomInList.background) {
                    roomBackground = roomInList.background;
                    roomsWithBackgrounds[roomId] = roomBackground;
                }
            }

            if (roomBackground) {
                currentRoomBackground = roomBackground;
                applyBackground(roomBackground, true);
            }
            
            // Ø­ÙØ¸ Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            localStorage.setItem('currentRoom', JSON.stringify(currentRoom));
            
            // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª ÙÙˆØ±Ø§Ù‹
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('chatPage').classList.remove('hidden');
            document.getElementById('chatTitle').textContent = roomName;
            document.getElementById('chatIcon').textContent = icon;
            
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ù„ØªÙƒÙˆÙ† Ø¬Ø§Ù‡Ø²Ø© (ÙØ§Ø±ØºØ© Ù…Ø¤Ù‚ØªØ§Ù‹)
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '<div class="flex items-center justify-center h-full"><div class="text-gray-400">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...</div></div>';

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø±Ø£Ø³ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            document.getElementById('chatPostsButton').classList.remove('hidden');
            document.getElementById('chatMessagesButtonContainer').classList.remove('hidden');
            document.getElementById('chatFriendsButton').classList.remove('hidden');
            
            // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ÙÙŠ Ø±Ø£Ø³ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            document.getElementById('profileButton').classList.add('hidden');
            
            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„ØºØ±ÙØ©
            const rankPanel = document.getElementById('rankManagementPanel');
            const userPanel = document.getElementById('userManagementPanel');
            const messageInputContainer = document.getElementById('messageInputContainer');
            
            if (roomName === 'ØºØ±ÙØ© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©') {
                rankPanel.classList.remove('hidden');
                userPanel.classList.remove('hidden');
                messageInputContainer.classList.remove('hidden');
            } else {
                rankPanel.classList.add('hidden');
                userPanel.classList.add('hidden');
                messageInputContainer.classList.remove('hidden');
            }
            
            // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
            socket.emit('join room', { roomId, user: currentUser });
        }

        // ÙØªØ­ ØºØ±ÙØ© Ù…Ø­Ù…ÙŠØ© Ø¨ÙƒÙ„Ù…Ø© Ø³Ø±
        function openProtectedChat(roomId, roomName, icon) {
            let password = '';
            
            if (roomName === 'ØºØ±ÙØ© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©') {
                password = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± ØºØ±ÙØ© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:');
                if (password !== 'admin123') {
                    showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!', 'error');
                    return;
                }
            }
            
            openChat(roomId, roomName, icon);
        }

        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        function goBack(isDisconnected = false) {
    if (currentRoom) {
        socket.emit('leave room', { roomId: currentRoom.id, user: currentUser });
        localStorage.removeItem('currentRoom');
    }
    document.getElementById('chatPage').classList.add('hidden');
    document.getElementById('mainPage').classList.remove('hidden');
    document.getElementById('messagesContainer').innerHTML = '';

    if (isDisconnected) {
        showNotification('Ù„Ù‚Ø¯ ÙÙ‚Ø¯Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ØºØ±ÙØ© Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø®Ù…ÙˆÙ„.', 'warning');
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø±Ø£Ø³ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø©
    document.getElementById('chatPostsButton').classList.add('hidden');
    document.getElementById('chatMessagesButtonContainer').classList.add('hidden');
    document.getElementById('chatFriendsButton').classList.add('hidden');
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ÙÙŠ Ø§Ù„Ø±Ø£Ø³
    document.getElementById('profileButton').classList.remove('hidden');
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø©
    applyBackground();
    
    currentRoom = null;
}

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        // ...existing code...
let manualLogout = false;

function logout() {
    manualLogout = true;
    if (currentRoom) {
        socket.emit('leave room', { roomId: currentRoom.id, user: currentUser });
    }
    
    // Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    socket.emit('logout');
    
    localStorage.removeItem('currentRoom');
    document.cookie = "sessionId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"; 
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø¶Ù…Ø§Ù† ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„ Ù„Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø©
    location.reload(); 
}

// Ù…Ù†Ø¹ Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† logout Ø­Ù‚ÙŠÙ‚ÙŠ
window.addEventListener('beforeunload', function (e) {
    if (!manualLogout) {
        // Ù„Ø§ ØªØ­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©
        return;
    }
    // Ø¥Ø°Ø§ ÙƒØ§Ù† logout Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø§Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©
    localStorage.removeItem('currentRoom');
});
// ...existing code...

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
        function sendMessage() {
            const input = document.getElementById('messageInput');
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø·ÙˆÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
            if (input.value.length > 300) {
                showNotification('Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø·ÙˆÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 300 Ø­Ø±Ù)', 'error');
                return;
            }

            const message = input.value.trim();
            const replyPreview = document.getElementById('replyPreview');
            let replyTo = null;

            if (!replyPreview.classList.contains('hidden')) {
                const isImage = document.getElementById('replyContent').getAttribute('data-is-image') === 'true';
                replyTo = {
                    messageId: replyPreview.getAttribute('data-reply-id'),
                    user: document.getElementById('replyUsername').textContent,
                    content: isImage ? document.getElementById('replyContent').getAttribute('data-image-url') : document.getElementById('replyContent').textContent
                };
            }
           
            if (message && currentUser && currentRoom) {
                socket.emit('send message', { 
                    roomId: currentRoom.id, 
                    message, 
                    user: currentUser,
                    replyTo: replyTo
                });
                input.value = '';
                cancelReply(); // Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            }
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Enter
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø·ÙˆÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        function checkMessageLength() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendMessageButton');
            if (input.value.length > 300) {
                sendBtn.disabled = true;
                sendBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                sendBtn.classList.add('bg-gray-500');
            } else {
                sendBtn.disabled = false;
                sendBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                sendBtn.classList.remove('bg-gray-500');
            }
        }

        function formatLinks(text) {
            const allEmojis = [...new Set([...animatedEmojis, ...localEmojis])];
            
            let result = text;
            let insideTag = false;
            let output = '';
            
            for (let i = 0; i < result.length; i++) {
                if (result[i] === '<') insideTag = true;
                if (result[i] === '>') insideTag = false;
                
                if (!insideTag) {
                    const remaining = result.substring(i);
                    const urlMatch = remaining.match(/^(https?:\/\/[^\s<]+)/);
                    
                    if (urlMatch) {
                        const url = urlMatch[1];
                        if (allEmojis.includes(url)) {
                            output += url;
                        } else {
                            output += `<a href="${url}" target="_blank" class="text-blue-400 underline hover:text-blue-300 transition-colors">${url}</a>`;
                        }
                        i += url.length - 1;
                        continue;
                    }
                }
                
                output += result[i];
            }
            
            return output;
        }

        function formatMessageWithInlineEmojis(text) {
            let result = text;
            
            const allEmojis = [...new Set([...animatedEmojis, ...localEmojis])];
            
            allEmojis.forEach(emojiUrl => {
                const escapedUrl = emojiUrl.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(escapedUrl, 'g');
                result = result.replace(regex, `<img src="${emojiUrl}" class="h-10 inline-block align-text-bottom mx-1" alt="emoji" style="max-height: 2em; vertical-align: text-bottom;">`);
            });
            
            return result;
        }

        // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ù†Ø³Ø®Ø© Ù…Ø¯Ù…Ø¬Ø©)
function addMessageToChat(user, message, time, isOwn, userRank, avatarUrl, messageId = null, replyTo = null, targetContainer = null, timestamp = null, badges = null, nameCardBorder = null) {
    let formattedMessage;
    
    if (animatedEmojis.includes(message) || localEmojis.includes(message)) {
        formattedMessage = `<img src="${message}" class="w-12 h-12 inline-block" alt="emoji">`;
    } else {
        formattedMessage = formatMessageWithInlineEmojis(message);
        formattedMessage = formatLinks(formattedMessage);
    }
    
    // Ø®Ø§ØµÙŠØ© Ø§Ù„Ù…Ù†Ø´Ù†
    let isMentioned = false;
    if (currentUser && message.includes(`@${currentUser.name}`)) {
        isMentioned = true;
        // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙØ± ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø°ÙƒÙˆØ±
        const mentionRegex = new RegExp(`@${currentUser.name}\\b`, 'g');
        formattedMessage = formattedMessage.replace(mentionRegex, `<span class="text-yellow-400 font-bold bg-yellow-400/10 px-1 rounded">@${currentUser.name}</span>`);
        
        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¹ØµÙÙˆØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ø§Ù„Ø© Ø­ÙŠØ© (ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø´Ø±Ø· isOwn Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©)
        if (!targetContainer) {
            mentionSound.play().catch(e => console.log("Audio play blocked:", e));
        }
    }

    const container = targetContainer || document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');    
    messageDiv.setAttribute('data-message-id', messageId);
   
    const timeStr = formatMessageTime(timestamp || Date.now());
   
    let rankBadge = '';
   
    if (userRank) {
        const rankInfo = ranks[userRank] || {}; 
        const iconHtml = getRankIconHtml(rankInfo.icon, "text-base");
        // Ø¥Ø¶Ø§ÙØ© align-middle Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø©
        rankBadge = `<span title="${userRank}" class="mx-1 inline-flex items-center align-middle">${iconHtml}</span>`;
    }

    // Ø¥Ø­Ø¶Ø§Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ³Ù…Ø©
    let achievementCount = 0;
    if (badges && Array.isArray(badges)) {
        achievementCount = badges.length;
    } else {
        const onlineUserForBadges = isOwn ? currentUser : (window.onlineUsersData ? window.onlineUsersData[user] : null);
        achievementCount = (onlineUserForBadges && onlineUserForBadges.badges) ? onlineUserForBadges.badges.length : 0;
    }
    const achievementCountBadge = achievementCount > 0 ? `<div class="achievement-count-badge" title="${achievementCount} Ø£ÙˆØ³Ù…Ø©">${achievementCount}</div>` : '';

    // --- Ø¥ØµÙ„Ø§Ø­: ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ§Ù„Ø¥Ø·Ø§Ø± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ ---
    let nameColorClass, nameBgClass, avatarFrameClass, currentNameCardBorder;

    if (isOwn) {
        nameColorClass = currentUser.nameColor || 'text-blue-100';
        nameBgClass = currentUser.nameBackground || '';
        avatarFrameClass = currentUser.avatarFrame || '';
        currentNameCardBorder = nameCardBorder || currentUser.nameCardBorder || null;
    } else {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¨Ø­Ø« ÙÙŠ DOM (Ø£Ø³Ø±Ø¹ Ø¨ÙƒØ«ÙŠØ±)
        const onlineUser = window.onlineUsersData ? window.onlineUsersData[user] : null;
        if (onlineUser) {
            nameColorClass = (onlineUser.nameColor && onlineUser.nameColor !== 'null') ? onlineUser.nameColor : 'text-blue-200';
            nameBgClass = (onlineUser.nameBackground && onlineUser.nameBackground !== 'null') ? onlineUser.nameBackground : '';
            avatarFrameClass = (onlineUser.avatarFrame && onlineUser.avatarFrame !== 'null') ? onlineUser.avatarFrame : '';
            currentNameCardBorder = nameCardBorder || onlineUser.nameCardBorder || null;
        } else {
            nameColorClass = 'text-blue-200';
            nameBgClass = '';
            avatarFrameClass = '';
            currentNameCardBorder = nameCardBorder || null;
        }
    }

    // ØªØ¬Ù‡ÙŠØ² Ù†Ù…Ø· Ø¥Ø·Ø§Ø± Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
    let bubbleStyle = '';
    if (currentNameCardBorder && currentNameCardBorder.startsWith('border-color:')) {
        bubbleStyle = `border: 2px solid ${currentNameCardBorder.split(':')[1]};`;
    }

    // Ø²Ø± Ø§Ù„Ø­Ø°Ù: ÙŠØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
    // --- ØªØ¹Ø¯ÙŠÙ„: ÙØµÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ---
    let directActions = '';
    let menuBtn = '';
    if (messageId && user) { // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        const isMessageOwner = user === currentUser.name;
        const canDelete = 
            (currentUser.isSiteOwner) || 
            (isMessageOwner && currentUser.rank); 

        // Ø²Ø± Ø§Ù„Ø±Ø¯ ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹
        directActions = `
            <button class="hover:opacity-80 transition-opacity" title="Ø±Ø¯" onclick="startReply('${messageId}', '${user}', '${message.replace(/'/g, "\\'")}')">
                <span class="inline-flex items-center justify-center w-5 h-5 bg-slate-700 rounded text-white shadow-sm">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                </span>
            </button>
        `;

        // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø­Ø°Ù ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ù…ÙˆØ­Ø§Ù‹
        if (canDelete) {
            directActions += `
                <button class="text-gray-400 hover:text-red-500 transition-colors" title="Ø­Ø°Ù" onclick="deleteRoomMessage('${messageId}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>`;
        }

        const myLevel = currentUser.rank ? (ranks[currentUser.rank]?.level || 0) : 0;
        const targetLevel = userRank ? (ranks[userRank]?.level || 0) : 0;
        const canManage = (currentUser.isSiteOwner || (myLevel > targetLevel && myLevel >= 2)) && !isMessageOwner;

        if (canManage) {
            menuBtn = `
            <div class=\"relative inline-block ml-2\">
                <button class=\"menu-btn text-gray-400 hover:text-blue-500 text-xl font-bold\" title=\"Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©\" data-message-id=\"${messageId}\" data-user=\"${user}\" data-content=\"${message.replace(/'/g, "\\'")}\">â‹®</button>
                <div class=\"message-menu hidden absolute left-0 z-50 bg-slate-800 text-white rounded shadow-lg mt-2 min-w-[160px] text-sm border border-slate-700\">
                    <button class=\"block w-full text-right px-4 py-2 hover:bg-slate-700\" data-action=\"mute\">ğŸ”‡ ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                    <button class=\"block w-full text-right px-4 py-2 hover:bg-slate-700\" data-action=\"unmute\">ğŸ”Š Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                    <button class=\"block w-full text-right px-4 py-2 hover:bg-slate-700\" data-action=\"warn\">âš ï¸ ØªØ­Ø°ÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                    <button class=\"block w-full text-right px-4 py-2 hover:bg-slate-700\" data-action=\"banRoom\">ğŸš« Ø­Ø¸Ø± Ù…Ù† Ø§Ù„ØºØ±ÙØ©</button>
                    <button class=\"block w-full text-right px-4 py-2 hover:bg-slate-700\" data-action=\"unbanRoom\">âœ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„ØºØ±ÙØ©</button>
                </div>
            </div>
            `;
        }
    }

    let replyHtml = '';
    if (replyTo) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (Ø³ÙˆØ§Ø¡ ÙˆØ­Ø¯Ù‡ Ø£Ùˆ Ù…Ø¹ Ù†Øµ)
        const allEmojis = [...new Set([...animatedEmojis, ...localEmojis])];
        const containsEmoji = replyTo.content && allEmojis.some(e => replyTo.content.includes(e));
        const isImageReply = replyTo.content && (replyTo.content.startsWith('data:image') || replyTo.content.startsWith('http') || replyTo.content.includes('ğŸ–¼ï¸ ØµÙˆØ±Ø©') || replyTo.content.includes('ØµÙˆØ±Ø© ğŸ–¼ï¸'));
        
        let displayContent = replyTo.content;
        if (containsEmoji) {
            displayContent = formatMessageWithInlineEmojis(replyTo.content);
        } else if (isImageReply) {
            displayContent = 'ØµÙˆØ±Ø© ğŸ–¼ï¸';
        }

        // ØªØ·Ø¨ÙŠÙ‚ ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…Ù†Ø´Ù† ÙÙŠ Ø§Ù„Ø±Ø¯ Ø£ÙŠØ¶Ø§Ù‹
        if (!isImageReply && currentUser && displayContent && typeof displayContent === 'string' && displayContent.includes(`@${currentUser.name}`)) {
            const mentionRegex = new RegExp(`@${currentUser.name}\\b`, 'g');
            displayContent = displayContent.replace(mentionRegex, `<span class="text-yellow-400 font-bold">@${currentUser.name}</span>`);
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù„Ø¹Ø±Ø¶Ù‡ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† ØµÙˆØ±Ø©
        let emojiPreviewUrl = null;
        if (containsEmoji && !isImageReply) {
            emojiPreviewUrl = allEmojis.find(e => replyTo.content.includes(e));
        }

        const imagePreview = (isImageReply || emojiPreviewUrl) 
            ? `<img src="${isImageReply ? replyTo.content : emojiPreviewUrl}" class="w-10 h-10 rounded-md object-cover ml-2 border border-white/10 shadow-sm">` 
            : '';

        replyHtml = `
            <a href="#${replyTo.messageId}" onclick="scrollToMessage('${replyTo.messageId}')" class="block bg-black/20 hover:bg-black/30 p-2 rounded-lg mb-2 text-xs border-r-4 border-blue-500 transition-colors">
                <div class="flex items-center justify-between gap-3">
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-blue-400 mb-0.5">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ${replyTo.user}</div>
                        <p class="opacity-70 truncate text-slate-300">${displayContent}</p>
                    </div>
                    ${imagePreview}
                </div>
            </a>
        `;
    }


    const avatarHtml = avatarUrl 
        ? `<div class="w-full h-full rounded-full relative ${(avatarFrameClass && !avatarFrameClass.startsWith('border-color:')) ? avatarFrameClass : ''}" style="${(avatarFrameClass && avatarFrameClass.startsWith('border-color:')) ? `border: 2px solid ${avatarFrameClass.split(':')[1]};` : ''}">${achievementCountBadge}<img src="${avatarUrl}" class="w-full h-full rounded-full object-cover" alt="${user}"></div>`
        : `<div class="w-full h-full rounded-full relative bg-gray-400 flex items-center justify-center text-white font-bold text-sm ${(avatarFrameClass && !avatarFrameClass.startsWith('border-color:')) ? avatarFrameClass : ''}" style="${(avatarFrameClass && avatarFrameClass.startsWith('border-color:')) ? `border: 2px solid ${avatarFrameClass.split(':')[1]};` : ''}">${achievementCountBadge}${user.charAt(0).toUpperCase()}</div>`;

    // --- Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯Ù…Ø¬ ---
    const messageBgClass = currentRoomSettings?.messageBackground || 'bg-gray-800';
    const messageTextColorClass = currentRoomSettings?.textColor || 'text-white';
    
    messageDiv.innerHTML = `
        <div class="flex items-start gap-3">
            <div class="avatar-container flex-shrink-0 cursor-pointer" onclick="showUserProfileModal('${user}')">
                ${avatarHtml}
            </div>
            <div class="flex items-end gap-2 flex-wrap">
                <div class="message-bubble relative ${messageBgClass + ' ' + messageTextColorClass} rounded-lg p-2 min-w-[50px]" style="${bubbleStyle}">
                    ${replyHtml}
                    <div class="message-content leading-snug flex items-center flex-wrap gap-1">
                        <span class="username-text font-bold cursor-pointer ${nameColorClass} ${nameBgClass ? nameBgClass + ' px-1 rounded' : ''}" onclick="mentionUser('${user}')">${user}</span>
                        ${rankBadge}
                        <span class="font-bold">:</span>
                        <span class="break-words">${formattedMessage}</span>
                    </div>
                </div>
                <div class="flex items-center gap-1 mb-1 message-actions">
                    <span class="timestamp-text opacity-70 text-gray-400 text-[10px] ml-1">${timeStr}</span> 
                    ${directActions}
                    ${menuBtn}
                </div>
            </div>
        </div>
    `;

    messageDiv.className = `chat-message flex flex-row items-start w-full px-0 user-message`;

    container.appendChild(messageDiv);
    // Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ø§Ù„Ø© Ø­ÙŠØ© (Ù„ÙŠØ³Øª Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®)
    if (!targetContainer) {
        scrollToBottom();
    }
}

// --- Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ù†Ø¸Ø§Ù… Ù‚Ø§Ø¦Ù…Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ---

// 1. Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø©
function closeAllMessageMenus() {
    document.querySelectorAll('.message-menu').forEach(m => m.classList.add('hidden'));
}

// 2. Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø¹Ø§Ù…
document.addEventListener('click', function(e) {
    const menuButton = e.target.closest('.menu-btn');
    const menuOption = e.target.closest('.message-menu button');

    if (menuButton) {
        // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (â‹®)
        e.stopPropagation();
        const menu = menuButton.nextElementSibling;
        const isHidden = menu.classList.contains('hidden');
        closeAllMessageMenus(); // Ø£ØºÙ„Ù‚ Ø£ÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø£Ø®Ø±Ù‰
        if (isHidden) {
            menu.classList.remove('hidden'); // Ø§ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        }
    } else if (menuOption) {
        // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        e.stopPropagation();
        const action = menuOption.dataset.action;
        const button = menuOption.closest('.relative').querySelector('.menu-btn');
        const messageId = button.dataset.messageId;
        const user = button.dataset.user; // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­ÙÙˆØ¸ ÙÙŠ Ø§Ù„Ø²Ø±
        const content = button.dataset.content;

        switch (action) {
            case 'reply':
                startReply(messageId, user, content);
                break;
            case 'delete':
                deleteRoomMessage(messageId);
                break;
            case 'mute':
                if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${user}ØŸ`)) {
                    socket.emit('mute user', { username: user, duration: 60, currentUser });
                }
                break;
            case 'unmute':
                if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${user}ØŸ`)) {
                    socket.emit('unmute user', { username: user, currentUser });
                }
                break;
            case 'banRoom':
                if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${user} Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©ØŸ`)) {
                    socket.emit('ban from room', { username: user, reason: 'ØªÙ… Ø§Ù„Ø­Ø¸Ø± Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', currentUser });
                }
                break;
            case 'unbanRoom':
                if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${user} Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©ØŸ`)) {
                    socket.emit('unban from room', { username: user, currentUser });
                }
                break;
            case 'warn':
                const reason = prompt(`Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„ØªØ­Ø°ÙŠØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${user}:`);
                if (reason !== null) {
                    socket.emit('warn user', { username: user, reason, currentUser });
                }
                break;
        }
        closeAllMessageMenus();
    } else {
        // Ø¥ØºÙ„Ø§Ù‚ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ø§ÙŠÙ…ÙˆØ¬ÙŠØ§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬
        closeAllMessageMenus();
    }
    
    const emojiPicker = document.getElementById('emojiPicker');
    const privateEmojiPicker = document.getElementById('privateEmojiPicker');
    const emojiButton = e.target.closest('#emojiButton');
    const privateEmojiButton = e.target.closest('#privateEmojiButton');
    
    if (emojiPicker && emojiPicker.classList.contains('show') && !emojiButton && !e.target.closest('#emojiPicker')) {
        emojiPicker.classList.remove('show');
    }
    if (privateEmojiPicker && privateEmojiPicker.classList.contains('show') && !privateEmojiButton && !e.target.closest('#privateEmojiPicker')) {
        privateEmojiPicker.classList.remove('show');
    }
});

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (ØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­)
function startReply(messageId, user, content) {
    const replyPreview = document.getElementById('replyPreview');
    const replyUsername = document.getElementById('replyUsername');
    const replyContent = document.getElementById('replyContent');

    replyPreview.setAttribute('data-reply-id', messageId);
    replyUsername.textContent = user;
    
    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø´ÙƒÙ„ Ø§Ø­ØªØ±Ø§ÙÙŠ
    if (content && (content.startsWith('data:image') || content.startsWith('http'))) {
        replyContent.innerHTML = `
            <div class="flex items-center gap-2">
                <img src="${content}" class="w-10 h-10 rounded-md object-cover border border-white/20 shadow-sm">
                <span class="text-gray-400 italic">ØµÙˆØ±Ø©</span>
            </div>
        `;
        replyContent.setAttribute('data-is-image', 'true');
        replyContent.setAttribute('data-image-url', content);
    } else {
        replyContent.textContent = content;
        replyContent.removeAttribute('data-is-image');
        replyContent.removeAttribute('data-image-url');
    }

    replyPreview.classList.remove('hidden');
    document.getElementById('messageInput').focus();

    // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
    closeAllMessageMenus();
}

function cancelReply() {
    const replyPreview = document.getElementById('replyPreview');
    replyPreview.classList.add('hidden');
    replyPreview.removeAttribute('data-reply-id');
}

function scrollToMessage(messageId) {
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    if (messageElement) {
        messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± ÙˆÙ…ÙŠØ¶ Ù…Ø¤Ù‚Øª
        messageElement.classList.add('animate-pulse');
        setTimeout(() => { messageElement.classList.remove('animate-pulse'); }, 2000);
    }
}

        // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù†Ø¸Ø§Ù… (Ù†Ø³Ø®Ø© Ù…Ø¯Ù…Ø¬Ø©)
function addSystemMessage(message, time, targetContainer = null, timestamp = null) {
    const container = targetContainer || document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ø§Ù„Ø© Ø§Ù†Ø¶Ù…Ø§Ù…
    if (typeof message === 'object' && message.subType === 'join') {
        messageDiv.className = 'chat-message flex flex-row items-start w-full my-1 px-0';
        const iconHtml = message.rankIcon ? getRankIconHtml(message.rankIcon, "text-xs") : '';
        
        messageDiv.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="avatar-container flex-shrink-0 cursor-pointer" onclick="showUserProfileModal('${message.user}')">
                    <img src="${message.avatar || 'icon.png'}" class="w-8 h-8 rounded-full border border-red-500/50 object-cover" alt="Avatar">
                </div>
                <div class="bg-[#2c2c2c]/80 backdrop-blur-sm px-3 py-1.5 rounded-lg shadow-sm border border-white/5 flex items-center flex-wrap text-sm">
                    <span class="text-gray-200 font-bold cursor-pointer hover:underline" onclick="mentionUser('${message.user}')">${message.user}</span>
                    <span class="text-red-500 font-bold mx-1">Ø§Ù†Ø¶Ù… Ù„Ù„ØºØ±ÙØ©</span>
                    ${message.rank ? `<span class="text-gray-400 text-xs">(# ${message.rank} #)</span>` : ''}
                </div>
            </div>
        `;
    } else {
        const content = typeof message === 'object' ? message.content : message;
        const timeStr = formatMessageTime(timestamp || Date.now());
        
        // Ø§Ø³ØªØ«Ù†Ø§Ø¡: Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… ØªØ³ØªØ®Ø¯Ù… Ø£Ù„ÙˆØ§Ù†Ù‡Ø§ Ø§Ù„Ø®Ø§ØµØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙˆÙ„Ø§ ØªØªØ£Ø«Ø± Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØºØ±ÙØ©
        let statusColorClass = 'text-white'; 
        if (typeof message === 'object' && message.systemStatus) {
            if (message.systemStatus === 'positive') statusColorClass = 'text-green-400';
            else if (message.systemStatus === 'negative') statusColorClass = 'text-red-400';
        }

        // Ø§Ø³ØªØ«Ù†Ø§Ø¡: Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… ØªØ³ØªØ®Ø¯Ù… Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙ‚Ø§Ø¹Ø© Ø±Ù…Ø§Ø¯ÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙˆÙ„Ø§ ØªØªØ£Ø«Ø± Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØºØ±ÙØ©
        const messageBgClass = 'bg-gray-800'; 
        const messageTextColorClass = statusColorClass;

        messageDiv.className = 'chat-message flex flex-row items-start w-full px-0 system-message'; // Ø¥Ø¶Ø§ÙØ© class Ù„Ù„ØªÙ…ÙŠÙŠØ²
        messageDiv.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="avatar-container flex-shrink-0 cursor-pointer" id="${currentUser.name === SITE_OWNER.username ? 'changeBotAvatarBtn' : ''}" onclick="${currentUser.name === SITE_OWNER.username ? 'triggerBotAvatarUpload()' : ''}">
                    <img src="${typeof BOT_AVATAR_URL !== 'undefined' ? BOT_AVATAR_URL : (typeof DEFAULT_AVATAR_URL !== 'undefined' ? DEFAULT_AVATAR_URL : 'icon.png')}" class="w-8 h-8 rounded-full border border-blue-500/50 object-cover" alt="System Bot">
                </div>
                <div class="flex items-end gap-2 flex-wrap">
                    <div class="message-bubble relative ${messageBgClass} ${messageTextColorClass} rounded-lg p-2 min-w-[50px] border border-white/5">
                        <div class="message-content leading-snug flex items-center flex-wrap gap-1">
                            <span class="username-text font-bold text-blue-400 cursor-pointer hover:underline" onclick="mentionUser('Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…')">Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…</span>
                            <span class="font-bold">:</span>
                            <span class="break-words font-semibold">${content}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-1 mb-1 message-actions">
                        <span class="timestamp-text opacity-70 text-gray-400 text-[10px] ml-1">${timeStr}</span> 
                    </div>
                </div>
            </div>
        `;
    }
   
    container.appendChild(messageDiv);
    if (!targetContainer) {
        scrollToBottom();
    }
}


        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ù…Ø¹ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø±ØªØ¨Ø©
function updateOnlineUsersList(users) {
    const onlineUsersList = document.getElementById('onlineUsersList');
    const onlineUsersCount = document.getElementById('onlineUsersCount');
    
    if (!onlineUsersList || !onlineUsersCount) return;
    
    onlineUsersCount.textContent = users.length;
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… DocumentFragment Ù„ØªÙ‚Ù„ÙŠÙ„ ÙˆÙ…ÙŠØ¶ Ø§Ù„ØµÙØ­Ø© ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
    const fragment = document.createDocumentFragment();
    
    // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ø¬Ù†Ø­Ø© (Wings Configuration)
    const wings = [
        {
            id: 'owners',
            title: 'ğŸ‘‘ Ø¬Ù†Ø§Ø­ ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹',
            ranks: wingsConfig.owners,
            classes: 'bg-gradient-to-r from-red-900 via-red-800 to-orange-900 text-yellow-100 border-y border-yellow-500/50 shadow-[0_0_15px_rgba(220,38,38,0.3)]'
        },
        {
            id: 'kings',
            title: 'ğŸ›¡ï¸ Ø¬Ù†Ø§Ø­ Ø§Ù„Ù…Ù„ÙˆÙƒ',
            ranks: wingsConfig.kings,
            classes: 'bg-gradient-to-r from-indigo-900 via-purple-900 to-slate-900 text-purple-100 border-y border-purple-500/50 shadow-[0_0_15px_rgba(124,58,237,0.3)]'
        },
        {
            id: 'distinguished',
            title: 'ğŸ’ Ø¬Ù†Ø§Ø­ Ø§Ù„Ø§Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†',
            ranks: wingsConfig.distinguished,
            classes: 'bg-gradient-to-r from-emerald-900 via-teal-900 to-slate-900 text-emerald-100 border-y border-emerald-500/50 shadow-[0_0_15px_rgba(16,185,129,0.3)]'
        },
        {
            id: 'members',
            title: 'ğŸ‘¥ Ù…ØªØµÙ„ÙˆÙ†',
            ranks: [], // Ø§Ù„Ø¨Ù‚ÙŠØ©
            classes: 'bg-gray-800/80 text-gray-300 border-y border-gray-700'
        }
    ];

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ø£Ø¬Ù†Ø­Ø©
    let shouldPlaySound = false;
    const groupedUsers = { owners: [], kings: [], distinguished: [], members: [] };
    
    // ØªØ­Ø¯ÙŠØ« Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹
    window.onlineUsersData = {};

    users.forEach(user => {
        if (user.name === currentUser.name) {
            currentUser.nameColor = user.nameColor;
        }

        const rank = user.rank;
        if (wings[0].ranks.includes(rank)) {
            groupedUsers.owners.push(user);
        } else if (wings[1].ranks.includes(rank)) {
            groupedUsers.kings.push(user);
        } else if (wings[2].ranks.includes(rank)) {
            groupedUsers.distinguished.push(user);
        } else {
            groupedUsers.members.push(user);
        }
        
        // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹
        window.onlineUsersData[user.name] = user;
    });

    // Ø¯Ø§Ù„Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ù†Ø§Ø­
    const sortUsers = (userList) => {
        return userList.sort((a, b) => {
            const rankA = a.rank ? ranks[a.rank]?.level || 0 : 0; 
            const rankB = b.rank ? ranks[b.rank]?.level || 0 : 0; 
            if (a.rank === 'ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹') return -1;
            if (b.rank === 'ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹') return 1;
            return rankB - rankA; 
        });
    };

    const currentOnlineUsernames = new Set();

    // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¬Ù†Ø­Ø©
    wings.forEach(wing => {
        const wingUsers = sortUsers(groupedUsers[wing.id]);
        
        if (wingUsers.length > 0) {
            // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ù†Ø§Ø­
            const wingHeader = document.createElement('div');
            wingHeader.className = `py-2 px-3 mb-2 mt-2 font-bold text-sm text-center uppercase tracking-wider rounded-lg backdrop-blur-md ${wing.classes}`;
            wingHeader.innerHTML = wing.title;
            fragment.appendChild(wingHeader);

            // Ù‚Ø§Ø¦Ù…Ø© Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ø¬Ù†Ø§Ø­
            wingUsers.forEach(user => {
                currentOnlineUsernames.add(user.name);
                const userDiv = document.createElement('div');
                
                // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„Ø­Ø±ÙƒØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯Ø§Ù‹
                if (!previousOnlineUsernames.has(user.name)) {
                    userDiv.classList.add('user-entry-animation');
                    shouldPlaySound = true;
                }

                userDiv.onclick = () => showUserProfileModal(user.name);
                userDiv.setAttribute('data-username', user.name);
                userDiv.setAttribute('data-name-color', user.nameColor || 'null');
                userDiv.setAttribute('data-name-background', user.nameBackground || 'null');
                userDiv.setAttribute('data-avatar-frame', user.avatarFrame || 'null');

                // Ø´Ø§Ø±Ø© Ø§Ù„Ø±ØªØ¨Ø© (Ù…ØµØºØ±Ø©)
                let rankBadge = '';
                if (user.rank) {
                    const rankInfo = ranks[user.rank] || { icon: '' };
                    const iconHtml = getRankIconHtml(rankInfo.icon, "text-[10px]");
                    rankBadge = `<span class="text-[10px] opacity-80 mr-2 flex items-center gap-1">${iconHtml} ${user.rank}</span>`;
                }

                // Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø²ÙŠØ©
                let frameStyle = '';
                let frameClass = '';
                if (user.avatarFrame && user.avatarFrame.startsWith('border-color:')) {
                    frameStyle = `border: 2px solid ${user.avatarFrame.split(':')[1]};`;
                } else {
                    frameClass = user.avatarFrame || '';
                }

                const avatarHtml = user.avatar 
                    ? `<div class="w-9 h-9 rounded-full relative group-hover:border-blue-400 transition-colors ${frameClass}" style="${frameStyle}"><img src="${user.avatar}" class="w-full h-full rounded-full object-cover" alt="${user.name}" loading="lazy"></div>`
                    : `<div class="w-9 h-9 rounded-full bg-gray-600 flex items-center justify-center text-white font-bold text-xs group-hover:border-blue-400 transition-colors ${frameClass}" style="${frameStyle}">${user.name.charAt(0).toUpperCase()}</div>`;

                // ØªØ·Ø¨ÙŠÙ‚ Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø®ØµØµØ©
                const cardBgValue = user.userCardBackground || 'hover:bg-white/5';
                if (cardBgValue.startsWith('background-color:')) {
                    userDiv.className = `group flex items-center space-x-3 space-x-reverse p-2 rounded-lg transition-all duration-200 ease-in-out cursor-pointer mb-1 border border-transparent hover:border-white/10`;
                    userDiv.style.backgroundColor = cardBgValue.split(':')[1];
                } else {
                    userDiv.className = `group flex items-center space-x-3 space-x-reverse p-2 rounded-lg transition-all duration-200 ease-in-out cursor-pointer mb-1 border border-transparent hover:border-white/10 ${cardBgValue}`;
                    userDiv.style.backgroundColor = '';
                }
                
                // ØªØ·Ø¨ÙŠÙ‚ Ù„ÙˆÙ† Ø¥Ø·Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
                if (user.nameCardBorder && user.nameCardBorder.startsWith('border-color:')) {
                    const borderColor = user.nameCardBorder.split(':')[1];
                    userDiv.style.borderColor = borderColor;
                    userDiv.style.borderWidth = '2px';
                } else {
                    userDiv.style.borderColor = 'transparent';
                    userDiv.style.borderWidth = '1px';
                }

                // ØªØ·Ø¨ÙŠÙ‚ Ù„ÙˆÙ† Ø§Ù„Ø§Ø³Ù…
                const nameStyle = getUserNameStyle(user.nameColor);

                userDiv.innerHTML = `
                    <div class="relative flex-shrink-0">
                        ${avatarHtml}
                        <span class="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full bg-green-500 border-2 border-gray-800"></span>
                    </div>
                    <div class="flex-1 min-w-0 flex flex-col justify-center">
                        <div class="flex items-center justify-between">
                            <div class="font-semibold truncate ${nameStyle.class} text-sm" style="${nameStyle.style}">${user.name}</div>
                        </div>
                        ${rankBadge ? `<div class="text-gray-400 leading-none">${rankBadge}</div>` : ''}
                    </div>
                `;
                fragment.appendChild(userDiv);
            });
        }
    });

    // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
    onlineUsersList.innerHTML = '';
    onlineUsersList.appendChild(fragment);

    if (shouldPlaySound && !isFirstUserLoad) {
        entrySound.play().catch(e => {});
    }

    if (!isFirstUserLoad && currentUser) {
        for (const username of previousOnlineUsernames) {
            if (!currentOnlineUsernames.has(username) && username !== currentUser.name) {
                leaveSound.currentTime = 0;
                leaveSound.play().catch(e => console.log("Audio play blocked:", e));
                break;
            }
        }
    }

    isFirstUserLoad = false;
    previousOnlineUsernames = currentOnlineUsernames;
    document.getElementById('onlineUsersPanel').classList.remove('hidden');
}

        // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ØªØ¨
        function assignRank() {
            const username = document.getElementById('rankUserName').value.trim();
            const selectedRank = document.getElementById('rankSelect').value;
            
            if (!username || !selectedRank) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±ØªØ¨Ø©', 'error');
                return;
            }
            
            socket.emit('assign rank', { 
                username, 
                rank: selectedRank, 
                currentUser: { ...currentUser, roomId: currentRoom.id } 
            });
        }

        function removeRank() {
            const username = document.getElementById('rankUserName').value.trim();
            
            if (!username) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
                return;
            }
            
            socket.emit('remove rank', { 
                username, 
                currentUser: { ...currentUser, roomId: currentRoom.id } 
            });
        }

        function showAllRanks() {
            socket.emit('show all ranks', { 
                currentUser: { ...currentUser, roomId: currentRoom.id } 
            });
        }

        function updateOnlineUsersAvatars(username, avatarUrl) {
            const userElements = document.querySelectorAll('#onlineUsersList .flex.items-center');
            userElements.forEach(element => {
                const userNameElement = element.querySelector('.font-semibold');
                if (userNameElement && userNameElement.textContent === username) {
                    const imgElement = element.querySelector('img');
                    if (imgElement) {
                        imgElement.src = avatarUrl;
                    } else {
                        const divElement = element.querySelector('.rounded-full');
                        if (divElement) {
                            divElement.innerHTML = `<img src="${avatarUrl}" class="w-10 h-10 rounded-full object-cover" alt="${username}">`;
                        }
                    }
                }
            });
        }

        // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        function toggleManagementFields() {
            const action = document.getElementById('userActionSelect').value;
            const durationField = document.getElementById('durationField');
            const reasonField = document.getElementById('reasonField');
            
            durationField.classList.add('hidden');
            reasonField.classList.add('hidden');
            
            if (action === 'mute') {
                durationField.classList.remove('hidden');
            } else if (['banFromRoom', 'banFromSite'].includes(action)) {
                reasonField.classList.remove('hidden');
            }
        }

        function clearManagementFields() {
            document.getElementById('managedUserName').value = '';
            document.getElementById('userActionSelect').value = '';
            document.getElementById('muteDuration').value = '';
            document.getElementById('banReason').value = '';
            document.getElementById('durationField').classList.add('hidden');
            document.getElementById('reasonField').classList.add('hidden');
        }

        function manageUser() {
            const username = document.getElementById('managedUserName').value.trim();
            const action = document.getElementById('userActionSelect').value;
            
            if (!username) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
                return;
            }
            
            if (!action) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡', 'error');
                return;
            }
            
            if (action === 'mute') {
                const duration = document.getElementById('muteDuration').value;
                if (!duration || duration < 1) {
                    showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¯Ø© ÙƒØªÙ… ØµØ­ÙŠØ­Ø©', 'error');
                    return;
                }
                
                socket.emit('mute user', {
                    username,
                    duration,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'unmute') {
                socket.emit('unmute user', {
                    username,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'banFromRoom') {
                const reason = document.getElementById('banReason').value;
                socket.emit('ban from room', {
                    username,
                    reason,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'unbanFromRoom') {
                socket.emit('unban from room', {
                    username,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'banFromSite') {
                const reason = document.getElementById('banReason').value;
                socket.emit('ban from site', {
                    username,
                    reason,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'unbanFromSite') {
                socket.emit('unban from site', {
                    username,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'deleteUser') {
                if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username}ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.`)) {
                    socket.emit('delete user', {
                        username,
                        currentUser: { ...currentUser, roomId: currentRoom.id }
                    });
                }
            } else if (action === 'showStatus') {
                socket.emit('get user status', {
                    username,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            }
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ÙˆØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ©
        function mentionUser(username) {
            const input = document.getElementById('messageInput');
            if (!input) return;
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø´Ù† ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø¹ Ù…Ø³Ø§ÙØ©
            const mentionText = `@${username} `;
            input.value = input.value.trim() ? input.value.trim() + ' ' + mentionText : mentionText;
            input.focus();
        }

        function showUserProfileModal(username) {
    if (!currentUser) return;
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
    const avatarUrl = userAvatars[username] || DEFAULT_AVATAR_URL;
    
    socket.emit('get user profile', { username });
}

        socket.on('points sent success', (data) => {
            const message = typeof data === 'object' ? data.message : data;
            const newPoints = typeof data === 'object' ? data.newPoints : null;
            showNotification(message, 'success');
            if (currentUser && newPoints !== null) currentUser.points = newPoints;
        });
        socket.on('points sent error', (error) => {
            showNotification(error, 'error');
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø­Ø¯Ø« ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
        socket.on('force reload', () => {
            location.reload();
        });

        // --- Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…ØªØ¬Ø± ---
        socket.on('shop items data', (items) => {
            window.shopItems = items; // Ø­ÙØ¸ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ØªØ¬Ø± Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹
            const container = document.getElementById('shopItemsContainer'); 
            container.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>';
            const gridContainer = container.querySelector('.grid');
  
            if (items.length === 0) {
                gridContainer.innerHTML = '<p class="text-slate-400 text-center p-8 col-span-2">Ø§Ù„Ù…ØªØ¬Ø± ÙØ§Ø±Øº Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                return;
            }

            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-gray-800 p-4 rounded-lg border border-gray-700 flex flex-col items-center text-center space-y-3';

                let iconHtml = '';
                if (item.itemType === 'name_change_card') {
                    iconHtml = '<div class="text-4xl">ğŸ”‘</div>';
                } else if (item.itemType === 'password_change_card') {
                    iconHtml = '<div class="text-4xl">ğŸ”</div>';
                } else if (item.itemType === 'name_color') {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ù…Ø¤Ù‚Øª Ù„ØªØ·Ø¨ÙŠÙ‚ ÙƒÙ„Ø§Ø³ Tailwind ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù„ÙˆÙ†
                    const tempDiv = document.createElement('div');
                    tempDiv.className = item.itemValue; 
                    document.body.appendChild(tempDiv); // ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù€ DOM Ù„ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù…Ø·
                    const cssColor = window.getComputedStyle(tempDiv).color;
                    document.body.removeChild(tempDiv);
                    iconHtml = `<div class="w-12 h-12 rounded-full border-2 border-slate-600" style="background-color: ${cssColor || '#ffffff'};"></div>`;
                } else {
                    const rIcon = ranks[item.itemValue]?.icon;
                    if (rIcon && (rIcon.startsWith('data:image') || rIcon.startsWith('http'))) {
                        iconHtml = `<div class="w-12 h-12"><img src="${rIcon}" class="w-full h-full object-contain"></div>`;
                    } else {
                        iconHtml = `<div class="text-4xl">${rIcon || 'ğŸ›ï¸'}</div>`;
                    }
                }
                
                itemDiv.innerHTML = `
                    ${iconHtml}
                    <div class="flex-1 w-full">
                        <h4 class="text-white font-semibold text-md">${item.name}</h4>
                        <p class="text-slate-400 text-xs mt-1">${item.description}</p>
                    </div>
                    <button onclick="buyItem(${item.id})" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 space-x-reverse transition-colors">
                        <span>${item.price}</span>
                        <span class="text-yellow-300">â­</span>
                    </button>
                `;
                gridContainer.appendChild(itemDiv);
            });
        });

        function buyItem(itemId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø´Ø±Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø±ØµÙŠØ¯Ùƒ.')) {
                socket.emit('buy item', { itemId, currentUser });
            }
        }

        socket.on('buy item success', (data) => {
            showNotification(data.message, 'success');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ø·Ù„Ø¨ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø°Ù„Ùƒ
            if (data.reload) {
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }
        });

        socket.on('buy item error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('control error', (error) => {
            showNotification(error, 'error');
        });

        // --- New Password Change Functions ---
        function usePasswordChangeCard(inventoryId) {
            openChangePasswordModal(inventoryId);
        }

        function openChangePasswordModal(inventoryId) {
            const modal = document.getElementById('changePasswordModal');
            if (modal) {
                modal.dataset.inventoryId = inventoryId;
                modal.classList.add('show');
                document.getElementById('oldPasswordInput').value = '';
                document.getElementById('newPasswordInput').value = '';
                document.getElementById('confirmNewPasswordInput').value = '';
            }
        }

        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        function submitChangePassword() {
            const modal = document.getElementById('changePasswordModal');
            const inventoryId = parseInt(modal.dataset.inventoryId, 10);
            const oldPassword = document.getElementById('oldPasswordInput').value;
            const newPassword = document.getElementById('newPasswordInput').value;
            const confirmNewPassword = document.getElementById('confirmNewPasswordInput').value;

            if (!oldPassword || !newPassword || !confirmNewPassword) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.', 'error');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showNotification('ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ØªØ§Ù† ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†.', 'error');
                return;
            }
            
            if (newPassword.length < 4) {
                showNotification('ÙŠØ¬Ø¨ Ø£Ù† ØªØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.', 'error');
                return;
            }

            socket.emit('change password', {
                username: currentUser.name,
                oldPassword: oldPassword,
                newPassword: newPassword,
                inventoryId: inventoryId
            });
        }

        socket.on('password change success', (message) => {
            showNotification(message, 'success');
            closeChangePasswordModal();
            setTimeout(logout, 2000); 
        });
        // --- End New Password Change Functions ---

        socket.on('name change success', (data) => {
            showNotification(data.message, 'success');
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆÙƒÙŠ Ø¨Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            document.cookie = `sessionId=${data.newSessionId}; path=/; max-age=31536000; SameSite=Lax`;
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
            currentUser.name = data.newUsername;
            currentUser.nameColor = data.nameColor;
            currentUser.sessionId = data.newSessionId;
            updateHeaderUserInfo();
            closeProfileModal();
        });

        socket.on('name change error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('user name changed', ({ oldUsername, newUsername }) => {
            // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            document.querySelectorAll(`[data-username="${oldUsername}"]`).forEach(el => el.dataset.username = newUsername);
        });

        function useNameChangeCard(inventoryId) {
            const newUsername = prompt("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
            if (newUsername && newUsername.trim() !== '') {
                if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ø³Ù…Ùƒ Ø¥Ù„Ù‰ "${newUsername}"ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø¨Ø·Ø§Ù‚Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù….`)) {
                    socket.emit('use name change card', {
                        oldUsername: currentUser.name,
                        newUsername: newUsername.trim(),
                        inventoryId: inventoryId,
                        currentUser: currentUser
                    });
                }
            }
        }


        function showUserProfile(profileData) {
            const modal = document.getElementById('profileModal');
            const avatar = document.getElementById('profileAvatar');
            const usernameElem = document.getElementById('profileUsername');
            const rankElem = document.getElementById('profileRank');
            const genderElem = document.getElementById('profileGender');
            const statusElem = document.getElementById('profileStatus');
            const statusDot = statusElem.querySelector('span:first-child'); // ØªØ¹Ø¯ÙŠÙ„: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø´ÙƒÙ„ Ù…ÙˆØ«ÙˆÙ‚
            const statusText = statusElem.querySelector('span:last-child'); // ØªØ¹Ø¯ÙŠÙ„: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¨Ø´ÙƒÙ„ Ù…ÙˆØ«ÙˆÙ‚
            const profileMenuContainer = document.getElementById('profileMenuContainer');
            const visitorActions = document.getElementById('visitorActions');
            const profileBio = document.getElementById('profileBio');
            const profileBioInput = document.getElementById('profileBioInput');
            const editBioButton = document.getElementById('editBioButton');
            const saveBioButton = document.getElementById('saveBioButton');
            const changeProfilePicBtn = document.getElementById('changeProfilePicBtn');
            const removeProfilePicBtn = document.getElementById('removeProfilePicBtn');
            const changeCoverBtn = document.getElementById('changeCoverBtn');
            const removeCoverBtn = document.getElementById('removeCoverBtn');
            const featuresTabButton = document.getElementById('featuresTabButton');
            const specialUsers = ["Walid dz 31", "Ø³ÙŠØ¯ Ø§Ø­Ù…Ø¯", "Ù…ÙŠØ§Ø±Ø§"]; 
            const profileHeader = document.getElementById('profileHeader');
            const profileContent = document.getElementById('profileContent');
            const profileBody = document.getElementById('profileBody');
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            avatar.src = profileData.avatar || DEFAULT_AVATAR_URL;
            avatar.onerror = function() {
                this.src = DEFAULT_AVATAR_URL;
            };
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø·Ø§Ø± Ø§Ù„ØµÙˆØ±Ø©
            const avatarFrame = document.getElementById('profileAvatarFrame');
            if (avatarFrame) {
                avatarFrame.style.border = '';
                if (profileData.avatarFrame && profileData.avatarFrame.startsWith('border-color:')) {
                    avatarFrame.className = `w-24 h-24 rounded-full relative`;
                    avatarFrame.style.border = `3px solid ${profileData.avatarFrame.split(':')[1]}`;
                } else {
                    avatarFrame.className = `w-24 h-24 rounded-full relative ${profileData.avatarFrame || ''}`;
                }
            }
            usernameElem.textContent = profileData.username;

            const isOwner = currentUser && profileData.username === currentUser.name;
            if (isOwner) {
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
                currentUser.nameCardBorder = profileData.nameCardBorder;
            }

            // ØªØ·Ø¨ÙŠÙ‚ Ù„ÙˆÙ† Ø¥Ø·Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            if (profileContent) {
                profileContent.style.border = '';
                if (profileData.nameCardBorder && profileData.nameCardBorder.startsWith('border-color:')) {
                    const borderColor = profileData.nameCardBorder.split(':')[1];
                    profileContent.style.border = `2px solid ${borderColor}`;
                }
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
            if (isOwner) {
                const previewCardBorderDiv = document.getElementById('previewCardBorderDiv');
                if (previewCardBorderDiv) {
                    previewCardBorderDiv.style.borderColor = '#6366f1'; // Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                    if (profileData.nameCardBorder && profileData.nameCardBorder.startsWith('border-color:')) {
                        previewCardBorderDiv.style.borderColor = profileData.nameCardBorder.split(':')[1];
                        previewCardBorderDiv.style.borderWidth = '2px';
                    } else {
                        previewCardBorderDiv.style.borderWidth = '1px';
                    }
                }
            }

            // Ø¹Ø±Ø¶ ØºÙ„Ø§Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            const coverDisplay = document.getElementById('profileCoverDisplay');
            if (profileData.profileCover) {
                coverDisplay.src = profileData.profileCover;
                coverDisplay.classList.remove('hidden');
            } else {
                coverDisplay.classList.add('hidden');
            }

            // ØªØ·Ø¨ÙŠÙ‚ Ù„ÙˆÙ†/Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            profileContent.style.backgroundColor = '';
            if (profileData.profileBackground) {
                if (profileData.profileBackground.startsWith('background-color:')) {
                    profileContent.className = 'profile-content custom-scrollbar relative';
                    profileContent.style.backgroundColor = profileData.profileBackground.split(':')[1];
                } else {
                    profileContent.className = `profile-content custom-scrollbar relative ${profileData.profileBackground}`;
                }
                profileHeader.className = 'relative h-64 w-full border-b border-gray-700/50 bg-transparent overflow-hidden';
                profileBody.className = 'p-6 bg-transparent';
            } else {
                profileContent.className = 'profile-content custom-scrollbar relative';
                profileHeader.className = 'relative h-64 w-full bg-gray-800 border-b border-gray-700/50 overflow-hidden';
                profileBody.className = 'p-6 bg-gray-900/50';
            }

            usernameElem.className = `text-2xl font-bold tracking-wide ${profileData.nameColor || 'text-white'}`;
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù†Ø³
            const genderText = profileData.gender === 'male' ? 'Ø°ÙƒØ±' : 'Ø£Ù†Ø«Ù‰';
            genderElem.textContent = genderText;

            if (profileData.rank) {
                const rankInfo = ranks[profileData.rank] || { icon: '', color: 'from-gray-500 to-gray-600' };
                const iconHtml = getRankIconHtml(rankInfo.icon, "text-base");
                rankElem.innerHTML = `${iconHtml} ${profileData.rank}`;
                rankElem.className = `inline-block mt-2 px-3 py-1 rounded-full text-sm font-semibold text-white bg-gradient-to-r ${rankInfo.color}`;
                rankElem.style.display = 'inline-block';

                // Ø¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø±ØªØ¨Ø©
                const existingExpiry = document.getElementById('profileRankExpiry');
                if (existingExpiry) existingExpiry.remove();

                if (profileData.rankExpiry) {
                    const expiryDate = new Date(profileData.rankExpiry);
                    const now = new Date();
                    
                    if (expiryDate > now) {
                        const diffTime = expiryDate - now;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        const expiryDiv = document.createElement('div');
                        expiryDiv.id = 'profileRankExpiry';
                        expiryDiv.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-900/40 text-yellow-300 border border-yellow-500/30';
                        expiryDiv.innerHTML = `<span class="ml-1">â³</span><span>${diffDays} ÙŠÙˆÙ…</span>`;
                        rankElem.parentNode.insertBefore(expiryDiv, rankElem.nextSibling);
                    }
                }
            } else {
                rankElem.style.display = 'none';
                const existingExpiry = document.getElementById('profileRankExpiry');
                if (existingExpiry) existingExpiry.remove();
            }
            
            if (profileData.isOnline) {
                statusDot.className = 'w-2.5 h-2.5 rounded-full bg-green-500';
                statusText.textContent = 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†';
            } else { 
                statusDot.className = 'w-2.5 h-2.5 rounded-full bg-gray-500';
                const lastSeenText = profileData.lastSeen ? `Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± ${getTimeAgo(new Date(profileData.lastSeen))}` : 'ØºÙŠØ± Ù…ØªØµÙ„';
                statusText.textContent = lastSeenText;
            }
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© (Bio)
            profileBio.textContent = profileData.bio || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.';
            profileBioInput.value = profileData.bio || '';

            // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ (Ù…Ø¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±)
            const friendsContainer = document.getElementById('profileFriendsList');
            friendsContainer.innerHTML = '';
            if (profileData.friends && profileData.friends.length > 0) {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Set Ù„Ø¶Ù…Ø§Ù† ÙØ±Ø§Ø¯Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                const uniqueFriends = [];
                const seenUsernames = new Set();
                
                profileData.friends.forEach(friend => {
                    if (!seenUsernames.has(friend.username)) {
                        seenUsernames.add(friend.username);
                        uniqueFriends.push(friend);
                    }
                });

                uniqueFriends.forEach(friend => {
                    const friendDiv = document.createElement('div');
                    friendDiv.className = 'bg-gray-800/60 p-2 rounded-lg text-center cursor-pointer hover:bg-gray-700/80 transition-colors border border-gray-700/50';
                    friendDiv.onclick = () => showUserProfileModal(friend.username);
                    friendDiv.innerHTML = `
                        <div class="relative inline-block">
                            <img src="${friend.avatar || defaultAvatars.guest}" class="w-10 h-10 rounded-full object-cover mx-auto mb-1 border border-gray-600">
                            ${friend.isOnline ? '<span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-gray-800 rounded-full"></span>' : ''}
                        </div>
                        <div class="text-xs text-white truncate font-medium">${friend.username}</div>
                    `;
                    friendsContainer.appendChild(friendDiv);
                });
            } else {
                friendsContainer.innerHTML = '<p class="col-span-3 text-center text-slate-400 text-sm py-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ù„Ø¹Ø±Ø¶Ù‡Ù….</p>';
            }

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ù…Ø³ØªÙˆÙ‰
            if (specialUsers.includes(profileData.username)) {
                document.getElementById('profilePoints').textContent = '99999';
                document.getElementById('profileLevel').textContent = '9999';
            } else {
                document.getElementById('profilePoints').textContent = profileData.points;
                document.getElementById('profileLevel').textContent = profileData.level;
            }

            // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª
            const achievementsListElem = document.getElementById('profileAchievementsList');
            if (achievementsListElem) {
                achievementsListElem.innerHTML = '';
                if (profileData.achievements && profileData.achievements.length > 0) {
                    profileData.achievements.forEach(ach => {
                        const card = document.createElement('div');
                        card.className = `achievement-card flex items-center gap-3 ${ach.completed ? 'completed' : 'opacity-60'}`;
                        
                        const progressPercent = Math.min(100, Math.round((ach.currentValue / ach.targetValue) * 100));
                        
                        const borderColor = ach.cardColor || (ach.completed ? '#10b981' : '#4b5563');
                        
                        card.innerHTML = `
                            <div class="achievement-badge w-12 h-12 text-2xl bg-gray-800 border-2 rounded-full flex items-center justify-center" 
                                 style="border-color: ${borderColor}; box-shadow: 0 0 5px ${borderColor}44;">
                                ${ach.icon}
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-center mb-1">
                                    <h4 class="text-sm font-bold text-white">${ach.name}</h4>
                                    <span class="text-[10px] ${ach.completed ? 'text-green-400' : 'text-slate-400'}">
                                        ${ach.completed ? 'Ù…ÙƒØªÙ…Ù„' : `${ach.currentValue} / ${ach.targetValue}`}
                                    </span>
                                </div>
                                <p class="text-[10px] text-slate-400 mb-2">${ach.description}</p>
                                <div class="w-full bg-gray-700 rounded-full h-1.5 overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                        `;
                        achievementsListElem.appendChild(card);
                    });
                } else {
                    achievementsListElem.innerHTML = '<div class="text-center text-slate-500 text-xs py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ù…ØªØ§Ø­Ø©</div>';
                }
            }
 
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØªØ¨Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ÙŠØ²Ø§Øª
            // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… ØªØ¹Ø±ÙŠÙ isOwner Ø³Ø§Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø³Ø·Ø± 5532
            const userRankLevel = profileData.rank ? (ranks[profileData.rank]?.level || 0) : 0;
            if (isOwner && (userRankLevel >= 4 || profileData.username === "Walid dz 31")) {
                featuresTabButton.classList.remove('hidden');
                initFeaturesUI(); // ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙŠØ²Ø§Øª
                updateNameCardBorderGrid(profileData); // ØªØ­Ø¯ÙŠØ« Ø´Ø¨ÙƒØ© Ø¥Ø·Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
            } else {
                featuresTabButton.classList.add('hidden');
            }

            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
            if (isOwner) {
                changeProfilePicBtn.classList.remove('hidden'); // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©
                changeCoverBtn.classList.remove('hidden'); // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„ØºÙ„Ø§Ù
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø­Ø°Ù ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø©/Ø§Ù„ØºÙ„Ø§Ù ØºÙŠØ± Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                if (profileData.avatar && profileData.avatar !== DEFAULT_AVATAR_URL) {
                    removeProfilePicBtn.classList.remove('hidden');
                } else {
                    removeProfilePicBtn.classList.add('hidden');
                }
                
                if (profileData.profileCover) {
                    removeCoverBtn.classList.remove('hidden');
                } else {
                    removeCoverBtn.classList.add('hidden');
                }

                editBioButton.classList.remove('hidden');
                saveBioButton.classList.add('hidden');
                visitorActions.classList.add('hidden');
                profileMenuContainer.innerHTML = ''; // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                document.getElementById('accountTabButton').classList.remove('hidden');
            } else {
                changeProfilePicBtn.classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©
                removeProfilePicBtn.classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©
                changeCoverBtn.classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„ØºÙ„Ø§Ù
                removeCoverBtn.classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø­Ø°Ù Ø§Ù„ØºÙ„Ø§Ù
                editBioButton.classList.add('hidden');
                saveBioButton.classList.add('hidden');
                visitorActions.classList.remove('hidden');
                const privateChatButton = document.getElementById('privateChatButton');
                privateChatButton.style.display = 'flex';
                privateChatButton.setAttribute('data-username', profileData.username);
                const addFriendButton = document.getElementById('addFriendButton');
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡
                addFriendButton.style.display = 'flex';
                sendPointsButton.style.display = 'flex';
                addFriendButton.setAttribute('data-username', profileData.username);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµØ¯ÙŠÙ‚Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„
                if (friendsList.includes(profileData.username)) {
                    addFriendButton.innerHTML = `
                        <span>ØµØ¯ÙŠÙ‚</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    `;
                    addFriendButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                    addFriendButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
                    addFriendButton.disabled = true;
                } else {
                    addFriendButton.innerHTML = `
                        <span>Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                        </svg>
                    `;
                    addFriendButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                    addFriendButton.classList.add('bg-green-600', 'hover:bg-green-700');
                    addFriendButton.disabled = false;
                }

                // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø´Ø±ÙØ§Ù‹
                const isSiteOwner = currentUser.name === "Walid dz 31";
                const managerLevel = ranks[currentUser.rank]?.level || 0;
                const targetLevel = ranks[profileData.rank]?.level || 0;
                const canManage = isSiteOwner || managerLevel > targetLevel;

                if (canManage && currentUser.name !== profileData.username) {
                    profileMenuContainer.innerHTML = ` 
                        <div class="relative inline-block">
                            <button class="menu-btn text-gray-400 hover:text-blue-400 text-xl font-bold" title="Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©" onclick="toggleProfileMenu(event, '${profileData.username}')">â‹®</button>
                            <div id="profileActionMenu" class="message-menu hidden absolute left-0 z-50 bg-slate-800 text-white rounded shadow-lg mt-2 min-w-[160px] text-sm border border-slate-700">
                                <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileMute('${profileData.username}')">ğŸ”‡ ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                                <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileUnmute('${profileData.username}')">ğŸ”Š Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ…</button>
                                <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileWarn('${profileData.username}')">âš ï¸ ØªØ­Ø°ÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                                <div class="border-t border-slate-600 my-1"></div>
                                <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileBanRoom('${profileData.username}')">ğŸš« Ø­Ø¸Ø± Ù…Ù† Ø§Ù„ØºØ±ÙØ©</button>
                                <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileUnbanRoom('${profileData.username}')">âœ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„ØºØ±ÙØ©</button>
                                ${isSiteOwner ? ` 
                                    <div class="border-t border-slate-600 my-1"></div>
                                    <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileBanSite('${profileData.username}')">â›” Ø­Ø¸Ø± Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
                                    <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileUnbanSite('${profileData.username}')">ğŸŒ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    profileMenuContainer.innerHTML = '';
                }
                document.getElementById('accountTabButton').classList.add('hidden');
            }
            
            modal.classList.add('show');
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
            switchProfileTab({ currentTarget: document.querySelector('.profile-tab-btn') }, 'details');

            // Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª (ÙÙŠ Ø²Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ©)
    const unreadCount = unreadPrivateMessages[profileData.username] || 0;
    if (unreadCount > 0 && profileData.username !== currentUser.name) {
        let badge = privateChatButton.querySelector('.unread-badge');
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'unread-badge absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white rounded-full text-xs h-5 w-5 flex items-center justify-center';
            privateChatButton.style.position = 'relative';
            privateChatButton.appendChild(badge);
        }
        badge.textContent = unreadCount;
    }
        }

        socket.on('account deleted', () => {
            showNotification('ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ø§Ù„Ø¢Ù†.', 'success');
            setTimeout(logout, 2000);
        });

        socket.on('delete account error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('cover success', (data) => {
            const message = typeof data === 'string' ? data : data.message;
            showNotification(message, 'success');
            
            if (typeof data === 'object' && data.coverUrl !== undefined) {
                const coverDisplay = document.getElementById('profileCoverDisplay');
                const removeCoverBtn = document.getElementById('removeCoverBtn');
                
                if (data.coverUrl) {
                    coverDisplay.src = data.coverUrl;
                    coverDisplay.classList.remove('hidden');
                    if (removeCoverBtn) removeCoverBtn.classList.remove('hidden');
                } else {
                    coverDisplay.src = '';
                    coverDisplay.classList.add('hidden');
                    if (removeCoverBtn) removeCoverBtn.classList.add('hidden');
                }
            }
        });

        socket.on('cover error', (msg) => {
            showNotification(msg, 'error');
        });

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
        }

        // Ø¯ÙˆØ§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
        function toggleProfileMenu(event, username) {
            event.stopPropagation();
            const menu = document.getElementById('profileActionMenu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }

        function handleProfileMute(username) {
            const duration = prompt(`Ø£Ø¯Ø®Ù„ Ù…Ø¯Ø© Ø§Ù„ÙƒØªÙ… Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username} (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚):`, "60");
            if (duration && !isNaN(duration)) {
                socket.emit('mute user', { username, duration: parseInt(duration), currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileUnmute(username) {
            if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username}ØŸ`)) {
                socket.emit('unmute user', { username, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileWarn(username) {
            const reason = prompt(`Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„ØªØ­Ø°ÙŠØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username}:`);
            if (reason !== null) {
                socket.emit('warn user', { username, reason, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileBanRoom(username) {
            const reason = prompt(`Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø­Ø¸Ø± ${username} Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©:`);
            if (reason !== null) { // ÙŠØ³Ù…Ø­ Ø¨Ø³Ø¨Ø¨ ÙØ§Ø±Øº
                socket.emit('ban from room', { username, reason, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileUnbanRoom(username) {
            if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username} Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©ØŸ`)) {
                socket.emit('unban from room', { username, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileBanSite(username) {
            const reason = prompt(`Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø­Ø¸Ø± ${username} Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„:`);
            if (reason !== null) {
                socket.emit('ban from site', { username, reason, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileUnbanSite(username) {
            if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username} Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ`)) {
                socket.emit('unban from site', { username, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        // Ø¯ÙˆØ§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©
        function updateBioCharCount() {
            const bioInput = document.getElementById('profileBioInput');
            const charCounter = document.getElementById('bioCharCounter');
            const currentLength = bioInput.value.length;
            const maxLength = 500;
            charCounter.textContent = `${currentLength} / ${maxLength}`; 
            if (currentLength > maxLength) {
                charCounter.classList.add('text-red-500');
                charCounter.classList.remove('text-gray-400');
            } else {
                charCounter.classList.remove('text-red-500');
                charCounter.classList.add('text-gray-400');
            }
        }
 
        function toggleBioEdit(isEditing) {
            const bioText = document.getElementById('profileBio');
            const bioInput = document.getElementById('profileBioInput');
            const editButton = document.getElementById('editBioButton');
            const saveButton = document.getElementById('saveBioButton');
            const cancelButton = document.getElementById('cancelBioButton');
            const charCounter = document.getElementById('bioCharCounter');
 
            if (isEditing) {
                bioText.classList.add('hidden');
                bioInput.classList.remove('hidden');
                charCounter.classList.remove('hidden');
                editButton.classList.add('hidden');
                saveButton.classList.remove('hidden');
                cancelButton.classList.remove('hidden');
                bioInput.value = bioText.textContent === 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.' ? '' : bioText.textContent;
                updateBioCharCount();
                bioInput.focus();
            } else {
                bioText.classList.remove('hidden');
                bioInput.classList.add('hidden');
                charCounter.classList.add('hidden');
                editButton.classList.remove('hidden');
                saveButton.classList.add('hidden');
                cancelButton.classList.add('hidden');
            }
        }

        function saveBio() {
            const newBio = document.getElementById('profileBioInput').value.trim();
            if (newBio.length > 500) {
                showNotification('Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² 500 Ø­Ø±Ù.', 'error');
                return; 
            }
            socket.emit('update user bio', { username: currentUser.name, bio: newBio, currentUser });
        }

        // Ø¯ÙˆØ§Ù„ ØªØºÙŠÙŠØ± Ø§Ù„ØºÙ„Ø§Ù
        function openCoverUpload() {
            document.getElementById('coverUpload').click();
        }

        document.getElementById('coverUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ÙÙ‚Ø·', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showNotification('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const coverUrl = e.target.result;
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙÙˆØ±Ø§Ù‹
                document.getElementById('profileCoverDisplay').src = coverUrl;
                document.getElementById('profileCoverDisplay').classList.remove('hidden');
                socket.emit('update profile cover', { username: currentUser.name, coverUrl, currentUser });
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        });

        socket.on('bio success', (message) => {
            showNotification(message, 'success');
            const newBio = document.getElementById('profileBioInput').value.trim();
            document.getElementById('profileBio').textContent = newBio || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.';
            toggleBioEdit(false);
        });

        socket.on('bio error', (error) => {
            showNotification(error, 'error');
        });
 
        function startPrivateChat() {
            const privateChatButton = document.getElementById('privateChatButton');
            const username = privateChatButton.getAttribute('data-username');
            
            if (!username) return;
            
            closeProfileModal();
            openPrivateChat(username);
        }

/* --- Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø³Ø­Ø¨ (ØªØ¯Ø¹Ù… Ø§Ù„Ù„Ù…Ø³ ÙˆØ§Ù„ÙØ£Ø±Ø©) --- */
function makeDraggable(element, handle) {
    let active = false;
    let currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;

    const dragStart = (e) => {
        e = e || window.event;
        if (e.type === 'touchstart') {
            initialX = e.touches[0].clientX - xOffset;
            initialY = e.touches[0].clientY - yOffset;
        } else {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
        }

        if (e.target === handle || handle.contains(e.target)) {
            active = true;
        }
    };

    const dragEnd = () => {
        initialX = currentX;
        initialY = currentY;
        active = false;
    };

    const drag = (e) => {
        if (!active) return;
        e = e || window.event;
        e.preventDefault();

        if (e.type === 'touchmove') {
            currentX = e.touches[0].clientX - initialX;
            currentY = e.touches[0].clientY - initialY;
        } else {
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;
        }

        xOffset = currentX;
        yOffset = currentY;

        requestAnimationFrame(() => {
            element.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
        });
    };

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    const parent = element.parentElement;
    parent.addEventListener('touchstart', dragStart, false);
    parent.addEventListener('touchend', dragEnd, false);
    parent.addEventListener('touchmove', drag, { passive: false });
    parent.addEventListener('mousedown', dragStart, false);
    parent.addEventListener('mouseup', dragEnd, false);
    parent.addEventListener('mousemove', drag, { passive: false });
}

       function openPrivateChat(username) {
    privateChatTarget = username;
    const modal = document.getElementById('privateChatModal');
    const avatar = document.getElementById('privateChatAvatar');
    const usernameElem = document.getElementById('privateChatUsername');
    const statusElem = document.getElementById('privateChatStatus');
    const statusDot = document.getElementById('privateChatStatusDot');
    
    // Ø¬Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©
    const avatarUrl = userAvatars[username] || DEFAULT_AVATAR_URL;
    avatar.src = avatarUrl || DEFAULT_AVATAR_URL;
    avatar.onerror = function() {
        this.src = DEFAULT_AVATAR_URL;
    };
    
    usernameElem.textContent = username;
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØµÙ„
    const isOnline = window.onlineUsersData && window.onlineUsersData[username];
    if (isOnline) {
        statusDot.className = 'absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-slate-800 bg-green-500';
        statusElem.textContent = 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†';
        statusElem.className = 'text-[10px] text-green-400 font-medium';
    } else {
        statusDot.className = 'absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-slate-800 bg-slate-500';
        statusElem.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
        statusElem.className = 'text-[10px] text-slate-500 font-medium';
    }
    
    // ØªÙØ±ÙŠØº Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (unreadPrivateMessages[username]) {
        delete unreadPrivateMessages[username];
        updateUnreadBadges();
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    modal.classList.add('show');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¯Ø§Ø®Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    const container = document.getElementById('privateChatMessages');
    container.innerHTML = `
        <div id="privateChatLoader" class="flex flex-col items-center justify-center h-full space-y-3 text-slate-400">
            <div class="spinner w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-xs font-medium">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...</p>
        </div>
    `;
    
    // ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    socket.emit('get private messages', {
        otherUser: username,
        currentUser: currentUser.name
    });

    // Ø¬Ø¹Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø³Ø­Ø¨
    const header = document.querySelector('#privateChatModal .private-chat-header');
    makeDraggable(modal, header);
}

        function closePrivateChat() {
            document.getElementById('privateChatModal').classList.remove('show');
            privateChatTarget = null;
        }

        function sendPrivateMessage() {
            if (!privateChatTarget) return;
            
            const input = document.getElementById('privateMessageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            socket.emit('send private message', {
                toUser: privateChatTarget,
                message: message,
                fromUser: currentUser.name
            });
            
            input.value = '';
        }

        function handlePrivateKeyPress(event) {
            if (event.key === 'Enter') {
                sendPrivateMessage();
            }
        }

        function addPrivateMessageToChat(message, isOwn) {
    let formattedContent = formatLinks(message.content);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§ÙŠÙ…ÙˆØ¬ÙŠ Ù…ØªØ­Ø±Ùƒ (Google Ø£Ùˆ Ù…Ø­Ù„ÙŠ)
    if (animatedEmojis.includes(message.content) || localEmojis.includes(message.content)) {
        formattedContent = `<img src="${message.content}" class="w-12 h-12 inline-block" alt="emoji">`;
    }

    const container = document.getElementById('privateChatMessages');
    
    // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    const loader = document.getElementById('privateChatLoader');
    if (loader) {
        container.innerHTML = '';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-4 flex ${isOwn ? 'flex-row-reverse' : 'flex-row'} items-end gap-2 chat-message`;
    
    const timeStr = formatMessageTime(message.timestamp || Date.now());
    const avatarUrl = message.avatar || DEFAULT_AVATAR_URL;

    messageDiv.innerHTML = `
        <img src="${avatarUrl}" class="w-8 h-8 rounded-full border border-white/10" alt="avatar">
        <div class="flex flex-col ${isOwn ? 'items-end' : 'items-start'} max-w-[75%]">
            <div class="px-4 py-2 rounded-2xl text-sm ${
                isOwn
                    ? 'bg-blue-600 text-white rounded-br-none shadow-lg shadow-blue-900/20'
                    : 'bg-slate-700 text-white rounded-bl-none shadow-lg shadow-black/20'
            }">
                <div class="whitespace-pre-wrap break-words">${formattedContent}</div>
            </div>
            <div class="text-[10px] opacity-50 mt-1 mx-1">${timeStr}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}
 
        // ÙˆØ¸ÙŠÙØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function showNotification(message, type = 'info') {
            const notificationsContainer = document.getElementById('globalNotifications');
            const notification = document.createElement('div');
            
            let bgColor = 'bg-blue-600';
            if (type === 'error') bgColor = 'bg-red-600';
            if (type === 'success') bgColor = 'bg-green-600';
            if (type === 'warning') bgColor = 'bg-yellow-600';
             
            notification.className = `${bgColor} text-white p-4 rounded-lg shadow-lg notification`;
            notification.innerHTML = `
                <div class="flex items-center space-x-3 space-x-reverse">
                    <span class="text-lg">${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}</span>
                    <span>${message}</span>
                </div>
            `;
             
            notificationsContainer.appendChild(notification);
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // ÙˆØ¸ÙŠÙØ© Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¥Ù„Ù‰ Ø£Ø­Ø¯Ø« Ø±Ø³Ø§Ù„Ø©
        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„ Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
        let scrollTimeout;
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (!container) return;
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… requestAnimationFrame Ù„Ø¶Ù…Ø§Ù† Ø³Ù„Ø§Ø³Ø© Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙˆØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬
            cancelAnimationFrame(scrollTimeout);
            scrollTimeout = requestAnimationFrame(() => {
                container.scrollTop = container.scrollHeight;
            });
        }
        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø­Ø¯Ø« Ø§Ù„ØªØ±Ù‚ÙŠØ©
socket.on('level up', (data) => {
  showNotification(`ğŸ‰ Ù„Ù‚Ø¯ Ø§Ø±ØªÙ‚Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${data.level}! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„ØªØ±ØªÙ‚ÙŠ Ø£ÙƒØ«Ø±!`, 'success');
});

function updateChatMessagesBadge() {
    const badge = document.getElementById('chatMessagesBadge');
    
    if (badge) {
        // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
        let totalUnread = 0;
        for (const username in unreadPrivateMessages) {
            totalUnread += unreadPrivateMessages[username];
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        totalUnread += friendRequests.length;
        
        if (totalUnread > 0) {
            badge.textContent = totalUnread;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
}
// Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
document.getElementById('chatMessagesButton')?.addEventListener('click', toggleNotificationsDropdown);

document.getElementById('chatFriendsButton')?.addEventListener('click', () => {
    openFriendsSidebar();
});

function openPostsSidebar() {
    document.getElementById('postsModal').classList.add('show');
    loadPosts();
}

function closePostsSidebar() {
    const modal = document.getElementById('postsModal');
    modal.classList.remove('show');
    modal.querySelector('#postsList').innerHTML = ''; // ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
}

function createNewPost() {
    const content = document.getElementById('newPostContent').value.trim();
    if (!content) {
        showNotification('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ù…Ù†Ø´ÙˆØ±', 'error');
        return;
    }
    socket.emit('create post', {
        content: content,
        username: currentUser.name
    });
    document.getElementById('newPostContent').value = '';
}

function loadPosts() {
    socket.emit('get posts');
}

function displayPosts(posts, prepend = false) {
    const container = document.getElementById('postsList');
    if (!prepend) {
        container.innerHTML = '';
    }

    if (posts.length === 0 && !prepend) {
        container.innerHTML = '<p class="text-slate-400 text-sm text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø¨Ø¹Ø¯.</p>';
        return;
    }

    const postsHtml = posts.map(post => {
        // Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø±
        const timeAgo = getTimeAgo(new Date(post.timestamp));
        const isLiked = post.likes && post.likes.includes(currentUser.name);

        return `
            <div class="bg-gray-800 rounded-xl p-4 border border-gray-700" id="post-card-${post.id}">
                <!-- Post Header -->
                <div class="flex items-center space-x-3 space-x-reverse mb-4">
                    <img src="${post.avatar || defaultAvatars.guest}" class="w-11 h-11 rounded-full object-cover cursor-pointer border-2 border-slate-600" onclick="showUserProfileModal('${post.username}')" alt="${post.username}">
                    <div class="flex-1">
                        <p class="font-semibold text-white cursor-pointer" onclick="showUserProfileModal('${post.username}')">${post.username}</p>
                        <p class="text-xs text-slate-400">${timeAgo}</p>
                    </div>
                    ${post.username === currentUser.name ? `
                        <button onclick="deletePost(${post.id})" class="text-slate-400 hover:text-red-500 transition-colors" title="Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    ` : ''}
                </div>

                <!-- Post Content -->
                <p class="text-slate-200 text-sm mb-4 whitespace-pre-wrap">${post.content}</p>

                <!-- Post Actions -->
                <div class="flex items-center justify-between text-slate-400 border-t border-gray-700 pt-2">
                    <button id="like-btn-${post.id}" onclick="likePost(${post.id})" class="flex items-center space-x-2 space-x-reverse hover:text-pink-500 transition-colors ${isLiked ? 'text-pink-500' : ''}">
                        <svg class="w-5 h-5" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z"></path>
                        </svg>
                        <span id="like-count-${post.id}">${post.likes ? post.likes.length : 0}</span>
                    </button>
                    <button onclick="toggleComments(${post.id})" class="flex items-center space-x-2 space-x-reverse hover:text-blue-400 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <span id="comment-count-${post.id}">${post.comments ? post.comments.length : 0}</span>
                    </button>
                </div>

                <!-- Comments Section -->
                <div id="comments-section-${post.id}" class="hidden mt-4 pt-3 border-t border-gray-700">
                    <div id="comments-list-${post.id}" class="space-y-3 mb-3 max-h-60 overflow-y-auto custom-scrollbar">
                        ${post.comments ? post.comments.map(comment => `
                            <div class="bg-gray-700/50 rounded-lg p-3 text-sm">
                                <div class="flex items-center space-x-2 space-x-reverse mb-1">
                                    <p class="font-semibold text-blue-300">${comment.username}</p>
                                    <p class="text-xs text-slate-400">${new Date(comment.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}</p>
                                </div>
                                <p class="text-slate-300">${comment.content}</p>
                            </div>
                        `).join('') : ''}
                    </div>
                    <div class="flex space-x-2 space-x-reverse mt-2">
                        <input type="text" id="comment-input-${post.id}" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ..." class="flex-1 bg-gray-700 border border-gray-600 rounded-full px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" onkeypress="if(event.key === 'Enter') addComment(${post.id})">
                        <button onclick="addComment(${post.id})" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-full transition-colors text-sm">
                            Ø¥Ø±Ø³Ø§Ù„
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    if (prepend) {
        container.insertAdjacentHTML('afterbegin', postsHtml);
    } else {
        container.innerHTML = postsHtml;
    }
}

function likePost(postId) {
    socket.emit('like post', {
        postId: postId,
        username: currentUser.name
    });
}

function toggleComments(postId) {
    const commentsSection = document.getElementById(`comments-section-${postId}`);
    commentsSection.classList.toggle('hidden');
    if (!commentsSection.classList.contains('hidden')) {
        document.getElementById(`comment-input-${postId}`).focus();
    }
}

function addComment(postId) {
    const commentInput = document.getElementById(`comment-input-${postId}`);
    const content = commentInput.value.trim();
    
    if (!content) {
        showNotification('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚', 'error');
        return;
    }
    
    socket.emit('add comment', {
        postId: postId,
        username: currentUser.name,
        content: content
    });
    commentInput.value = '';
}

function deletePost(postId) {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
        socket.emit('delete post', {
            postId: postId,
            username: currentUser.name
        });
    }
}

function getTimeAgo(date) {
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000); 
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (days > 0) return `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
    if (hours > 0) return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
    if (minutes > 0) return `Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
    return 'Ø§Ù„Ø¢Ù†';
}

// Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³ÙˆÙƒÙŠØª Ù„Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
socket.on('posts data', (posts) => {
    displayPosts(posts);
});

socket.on('new post', (newPost) => {
    showNotification(`Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯ Ù…Ù† ${newPost.username}`, 'info');
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const container = document.getElementById('postsList');
    if (container.querySelector('p')) { // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø±Ø³Ø§Ù„Ø© "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª"
        container.innerHTML = '';
    }
    displayPosts([newPost], true);
});

socket.on('post liked', ({ postId, likes }) => {
    const likeCountElem = document.getElementById(`like-count-${postId}`);
    const likeBtnElem = document.getElementById(`like-btn-${postId}`);
    
    if (likeCountElem && likeBtnElem) {
        likeCountElem.textContent = likes.length;
        const isLiked = likes.includes(currentUser.name);
        likeBtnElem.classList.toggle('text-pink-500', isLiked);
        likeBtnElem.querySelector('svg').setAttribute('fill', isLiked ? 'currentColor' : 'none');
    }
});

socket.on('comment added', ({ postId, username, content, timestamp }) => {
    const commentsList = document.getElementById(`comments-list-${postId}`);
    const commentCountElem = document.getElementById(`comment-count-${postId}`);

    if (commentsList && commentCountElem) {
        const newComment = document.createElement('div');
        newComment.className = 'bg-gray-700/50 rounded-lg p-3 text-sm';
        newComment.innerHTML = `
            <div class="flex items-center space-x-2 space-x-reverse mb-1">
                <p class="font-semibold text-blue-300">${username}</p>
                <p class="text-xs text-slate-400">${new Date(timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}</p>
            </div>
            <p class="text-slate-300">${content}</p>
        `;
        commentsList.appendChild(newComment);
        commentsList.scrollTop = commentsList.scrollHeight; // ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø³ÙÙ„
        commentCountElem.textContent = parseInt(commentCountElem.textContent) + 1;
    }
});

socket.on('post deleted', ({ postId }) => {
    document.getElementById(`post-card-${postId}`)?.remove();
});

socket.on('post delete success', (message) => {
    showNotification(message, 'success');
});

socket.on('post delete error', (error) => {
    showNotification(error, 'error');
});
// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
document.getElementById('postsButton').addEventListener('click', openPostsSidebar);

document.getElementById('chatPostsButton')?.addEventListener('click', openPostsSidebar);
document.getElementById('chatFriendsButton')?.addEventListener('click', openFriendsSidebar);
document.getElementById('chatMessagesButton')?.addEventListener('click', togglePrivateConversationsDropdown);
document.getElementById('chatNotificationsButton')?.addEventListener('click', toggleNotificationsDropdown);

// --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---

function togglePrivateConversationsDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('privateConversationsDropdown');
    const otherDropdown = document.getElementById('chatNotificationsDropdown');
    const isHidden = dropdown.classList.contains('hidden');
 
    // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¸Ù‡ÙˆØ±
    dropdown.classList.toggle('hidden');
 
    // Ø¥Ø°Ø§ ØªÙ… ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¢Ù†
    if (isHidden) {
        otherDropdown.classList.add('hidden'); // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø®Ø±Ù‰
        socket.emit('get private conversations', currentUser.name); // Ø§Ø·Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    }
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener('click', function (e) {
    const privateDropdown = document.getElementById('privateConversationsDropdown');
    const privateButton = document.getElementById('chatMessagesButton');
    if (privateDropdown && !privateDropdown.contains(e.target) && !privateButton.contains(e.target)) {
        privateDropdown.classList.add('hidden');
    }

    const dropdown = document.getElementById('chatNotificationsDropdown');
    const button = document.getElementById('chatNotificationsButton');
    if (dropdown && !dropdown.contains(e.target) && !button.contains(e.target)) {
        dropdown.classList.add('hidden');
    }
});

function updateNotificationsBadge(hasUnread) {
    const badge = document.getElementById('chatNotificationsBadge');
    if (badge) {
        badge.classList.toggle('hidden', !hasUnread);
    }
}

function updateMessagesBadge(count) {
    const chatBadge = document.getElementById('chatMessagesBadge');
    if (chatBadge) {
        if (count > 0) {
            chatBadge.textContent = count;
            chatBadge.classList.remove('hidden');
        } else {
            chatBadge.classList.add('hidden');
        }
    }
}

socket.on('new notification', (notification) => {
    showNotification(`ğŸ”” Ù„Ø¯ÙŠÙƒ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯!`, 'info');
    socket.emit('get unread counts', currentUser.name);
});

socket.on('notifications list', (notifications) => {
    const container = document.getElementById('chatNotificationsList');
    container.innerHTML = '';
    const unreadCount = notifications.filter(n => !n.read).length;

    if (notifications.length === 0) {
        container.innerHTML = '<p class="text-blue-200 text-sm text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>';
        return;
    }

    notifications.forEach(notif => {
        const notifDiv = document.createElement('div');
        notifDiv.className = `p-2 text-sm rounded-md hover:bg-white/10 cursor-pointer ${!notif.read ? 'bg-blue-500/20' : ''}`;
        notifDiv.setAttribute('onclick', `goToPost(${notif.postId})`);

        let text = '';
        if (notif.type === 'like') {
            text = `ğŸ‘ Ø£Ø¹Ø¬Ø¨ <strong class="text-white">${notif.senderUsername}</strong> Ø¨Ù…Ù†Ø´ÙˆØ±Ùƒ.`;
        } else if (notif.type === 'comment') {
            text = `ğŸ’¬ Ø¹Ù„Ù‘Ù‚ <strong class="text-white">${notif.senderUsername}</strong> Ø¹Ù„Ù‰ Ù…Ù†Ø´ÙˆØ±Ùƒ.`;
        } else if (notif.type === 'new_post') {
            text = `âœï¸ Ù†Ø´Ø± <strong class="text-white">${notif.senderUsername}</strong> Ù…Ù†Ø´ÙˆØ±Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹.`;
        }

        notifDiv.innerHTML = `<p class="text-slate-300">${text}</p>`;
        container.appendChild(notifDiv);
    });
});

socket.on('private conversations list', (conversations) => {
    const container = document.getElementById('privateConversationsList');
    container.innerHTML = '';
    let totalUnread = 0;

    if (conversations.length === 0) {
        container.innerHTML = '<p class="text-slate-400 text-sm text-center p-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø®Ø§ØµØ© Ø¨Ø¹Ø¯.</p>';
        return;
    }

    conversations.forEach(conv => {
        const convDiv = document.createElement('div');
        const otherUser = conv.otherUser;
        const avatarUrl = userAvatars[otherUser] || defaultAvatars.guest;

        if (conv.unreadCount > 0) {
            totalUnread += conv.unreadCount;
        }

        convDiv.className = `flex items-center p-2 rounded-md cursor-pointer transition-colors ${conv.unreadCount > 0 ? 'bg-blue-500/20' : 'hover:bg-white/10'}`;
        convDiv.onclick = () => {
            openPrivateChat(otherUser);
            document.getElementById('privateConversationsDropdown').classList.add('hidden');
        };

        convDiv.innerHTML = `
            <div class="relative flex-shrink-0">
                <img src="${avatarUrl}" class="w-10 h-10 rounded-full object-cover" alt="${otherUser}">
                ${conv.isOnline ? '<span class="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full bg-green-500 border-2 border-slate-800"></span>' : ''}
            </div>
            <div class="flex-1 min-w-0 mx-3">
                <div class="flex justify-between items-center">
                    <p class="text-white font-semibold truncate">${otherUser}</p>
                </div>
                <div class="flex justify-between items-center">
                    <p class="text-slate-400 text-sm truncate">${conv.lastMessage.content}</p>
                    ${conv.unreadCount > 0 ? `<span class="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">${conv.unreadCount}</span>` : ''}
                </div>
            </div>
        `;
        container.appendChild(convDiv);
    });
});

socket.on('private conversations updated', () => {
    socket.emit('get unread counts', currentUser.name);
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…ÙØªÙˆØ­Ø©ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ«Ù‡Ø§
    if (!document.getElementById('privateConversationsDropdown').classList.contains('hidden')) {
        socket.emit('get private conversations', currentUser.name);
    }
});

socket.on('unread counts data', (counts) => {
    updateMessagesBadge(counts.privateMessages);
    updateNotificationsBadge(counts.notifications > 0);
});

function toggleNotificationsDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('chatNotificationsDropdown');
    const otherDropdown = document.getElementById('privateConversationsDropdown');
    const isHidden = dropdown.classList.contains('hidden');

    otherDropdown.classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹

    if (isHidden) {
        socket.emit('get notifications', currentUser.name);
        dropdown.classList.remove('hidden');
        setTimeout(() => {
            socket.emit('mark notifications as read', currentUser.name);
            updateNotificationsBadge(false);
        }, 2000);
    } else {
        dropdown.classList.add('hidden');
    }
}

function goToPost(postId) {
    // 1. Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    document.getElementById('chatNotificationsDropdown').classList.add('hidden');

    // 2. ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª (Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ ØªØ­Ù…ÙŠÙ„Ù‡Ø§)
    openPostsSidebar();

    // 3. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ± ÙˆØªÙ…Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø© Ø¥Ù„ÙŠÙ‡ Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ù‚ØµÙŠØ±Ø© Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ­Ù…ÙŠÙ„
    setTimeout(() => {
        const postElement = document.getElementById(`post-card-${postId}`);
        if (postElement) {
            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
            postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù
            postElement.style.transition = 'background-color 0.5s ease';
            postElement.style.backgroundColor = 'rgba(59, 130, 246, 0.3)'; // ØªÙ…ÙŠÙŠØ² Ø£Ø²Ø±Ù‚

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø¨Ø¹Ø¯ ÙØªØ±Ø©
            setTimeout(() => {
                postElement.style.backgroundColor = '';
            }, 2500);
        } else {
            showNotification('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŒ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù‚Ø¯ÙŠÙ…Ø§Ù‹.', 'warning');
        }
    }, 500); // Ø§Ù†ØªØ¸Ø§Ø± Ù†ØµÙ Ø«Ø§Ù†ÙŠØ© Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
}

// Ø¯ÙˆØ§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙØ§Ø¹Ù„ÙŠÙ†
function openTopUsersModal() {
    const modal = document.getElementById('topUsersModal');
    const overlay = document.getElementById('topUsersOverlay');
    modal.classList.add('show');
    overlay.classList.add('show');
    
    // Ø·Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    socket.emit('get top users');
}

function closeTopUsersModal() {
    const modal = document.getElementById('topUsersModal');
    const overlay = document.getElementById('topUsersOverlay');
    modal.classList.remove('show');
    overlay.classList.remove('show');
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const container = document.getElementById('topUsersListContainer');
    container.innerHTML = `
        <div class="text-center text-blue-200 p-8">
            <div class="spinner mx-auto"></div>
            <p class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</p>
        </div>
    `;
}

socket.on('top users list', (users) => {
    const container = document.getElementById('topUsersListContainer');
    container.innerHTML = '';

    if (users.length === 0) {
        container.innerHTML = '<p class="text-slate-400 text-center p-8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªÙØ§Ø¹Ù„ÙˆÙ† Ù„Ø¹Ø±Ø¶Ù‡Ù… Ø¨Ø¹Ø¯.</p>';
        return;
    }

    users.forEach((user, index) => {
        const userDiv = document.createElement('div');
        userDiv.className = 'flex items-center bg-gray-800 p-3 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer';
        userDiv.onclick = () => showUserProfileModal(user.username);

        userDiv.innerHTML = `
            <div class="flex-shrink-0 w-10 text-center text-xl font-bold ${index < 3 ? 'text-yellow-400' : 'text-blue-300'}">${index + 1}</div>
            ${user.avatar ? 
                `<img src="${user.avatar}" class="w-10 h-10 rounded-full object-cover" alt="${user.username}">` :
                `<div class="w-10 h-10 rounded-full bg-gray-500 flex items-center justify-center text-white font-bold">${user.username.charAt(0).toUpperCase()}</div>`
            }
            <div class="flex-1 min-w-0 mx-3">
                <div class="text-white font-semibold truncate">${user.username}</div>
                <div class="text-xs text-slate-400">ğŸ“ˆ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${user.level}</div>
            </div>
            <div class="text-yellow-400 font-bold text-sm">â­ ${user.points}</div>
        `;
        container.appendChild(userDiv);
    });
});

document.getElementById('chatPostsButton').addEventListener('click', openPostsSidebar);
        
        // Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙÙŠ Ù‚Ø³Ù… JavaScript

function applyBackground(backgroundData, isRoomBackground = false) {
    const body = document.body;
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø´ÙØ§ÙØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const existingOverlay = document.getElementById('background-overlay');
    if (existingOverlay) {
        existingOverlay.remove();
    }

    // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø®Ù„ÙÙŠØ© ØºØ±ÙØ©ØŒ Ù†Ø·Ø¨Ù‚ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…ÙˆÙ‚Ø¹
    if (!isRoomBackground) {
        body.style.backgroundColor = '#000000';
        body.style.backgroundImage = 'none';
        body.className = body.className.split(' ').filter(c => !c.startsWith('from-') && !c.startsWith('via-') && !c.startsWith('to-') && c !== 'bg-gradient-to-br' && c !== 'bg-gradient-to-t').join(' ');
        return;
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ø®Ù„ÙÙŠØ© Ø§Ù„ØºØ±ÙØ©
    if (backgroundData) {
        if (backgroundData.type === 'image') {
            body.style.backgroundImage = `url('${backgroundData.value}')`;
            body.style.backgroundSize = 'cover';
            body.style.backgroundRepeat = 'no-repeat';
            body.style.backgroundAttachment = 'fixed';
            body.style.backgroundPosition = 'center';
            
            const overlay = document.createElement('div');
            overlay.id = 'background-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.3);
                z-index: -1;
                pointer-events: none;
            `;
            body.appendChild(overlay);
        } else if (backgroundData.type === 'color') {
            body.style.backgroundColor = backgroundData.value;
            body.style.backgroundImage = 'none';
        } else {
            body.style.backgroundImage = 'none';
            body.classList.add('bg-gradient-to-br'); 
            const gradientClasses = backgroundData.value.split(' ');
            gradientClasses.forEach(className => {
                body.classList.add(className);
            });
        }
    }
}

// Ø·Ù„Ø¨ Ø§Ù„Ø§ØªØµØ§Ù„
socket.on('connect', () => {
    // Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    socket.on('login success', (userData) => {
        currentUser = userData;
    });
    
    socket.on('register success', (userData) => {
        currentUser = userData;
    });
    
    socket.on('session valid', (userData) => {
        currentUser = userData;
    });
});
// Ø¯ÙˆØ§Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±
function openImageUpload() {
    document.getElementById('imageUpload').click();
}

function openPrivateImageUpload() {
    document.getElementById('privateImageUpload').click();
}

function openImageUploadForProfile() {
    document.getElementById('profileImageUpload').click();
}

function removeProfilePic() {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ØµÙˆØ±ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŸ')) {
        socket.emit('update avatar', {
            username: currentUser.name,
            avatarUrl: null,
            currentUser: { ...currentUser, roomId: currentRoom ? currentRoom.id : null }
        });
    }
}

function removeCover() {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ØºÙ„Ø§Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠØŸ')) {
        socket.emit('update profile cover', {
            username: currentUser.name,
            coverUrl: null,
            currentUser: currentUser
        });
    }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
document.getElementById('profileImageUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ÙÙ‚Ø·', 'error');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showNotification('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 5MB', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const imageData = e.target.result;
        socket.emit('update avatar', {
            username: currentUser.name,
            avatarUrl: imageData,
            currentUser: { ...currentUser, roomId: currentRoom ? currentRoom.id : null }
        });
    };
    reader.readAsDataURL(file);
    e.target.value = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚Ù„
});

// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
document.getElementById('imageUpload').addEventListener('change', function(e) {
    handleImageUpload(e, 'public');
});

// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ©
document.getElementById('privateImageUpload').addEventListener('change', function(e) {
    handleImageUpload(e, 'private');
});

// ÙÙŠ Ø¯Ø§Ù„Ø© handleImageUploadØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø¬Ø²Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ©
function handleImageUpload(event, type) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ÙÙ‚Ø·', 'error');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showNotification('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 5MB', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const imageData = e.target.result;
        
        if (type === 'public') {
            socket.emit('send image message', {
                roomId: currentRoom.id,
                imageData: imageData,
                user: currentUser
            });
        } else {
            // Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ©
            if (!privateChatTarget) {
                showNotification('ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            
            socket.emit('send private image', {
                toUser: privateChatTarget,
                imageData: imageData,
                fromUser: currentUser.name
            });
        }
        
        event.target.value = '';
    };
    
    reader.readAsDataURL(file);
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ù„ØµÙ‚ Ø§Ù„ØµÙˆØ± ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ù†Øµ
function setupPasteHandler() {
    // Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('paste', function(e) {
            handlePaste(e, 'public');
        });
    }
    
    // Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ©
    const privateMessageInput = document.getElementById('privateMessageInput');
    if (privateMessageInput) {
        privateMessageInput.addEventListener('paste', function(e) {
            handlePaste(e, 'private');
        });
    }
}

function handlePaste(event, type) {
    const items = event.clipboardData?.items;
    if (!items) return;
    
    for (let item of items) {
        if (item.type.indexOf('image') !== -1) {
            event.preventDefault();
            
            const file = item.getAsFile();
            if (!file) return;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (5MB ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                
                if (type === 'public') {
                    socket.emit('send image message', {
                        roomId: currentRoom.id,
                        imageData: imageData,
                        user: currentUser
                    });
                } else {
                    socket.emit('send private image', {
                        toUser: privateChatTarget,
                        imageData: imageData,
                        fromUser: currentUser.name
                    });
                }
            };
            
            reader.readAsDataURL(file);
            break;
        }
    }
}

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
socket.on('new image message', (message) => {
    addImageMessageToChat(message.user, message.imageData, message.time, message.user === currentUser.name, message.rank, message.avatar, message.messageId, null, message.timestamp, message.replyTo);
});

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ©
socket.on('new private image', (message) => {
    addPrivateImageMessage(message, message.from === currentUser.name);
});

socket.on('private image sent', (message) => {
    addPrivateImageMessage(message, true);
});

// Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
// Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ù†Ø³Ø®Ø© Ù…Ø¯Ù…Ø¬Ø©)
function addImageMessageToChat(user, imageData, time, isOwn, userRank, avatarUrl, messageId = null, targetContainer = null, timestamp = null, replyTo = null, badges = null, nameCardBorder = null) {
    const container = targetContainer || document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    
    // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ù…Ù†Ø´Ù† Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ù†Ø´Ù† ÙÙŠ Ø§Ù„Ø±Ø¯ (ReplyTo)
    if (currentUser && replyTo && replyTo.content && replyTo.content.includes(`@${currentUser.name}`)) {
        if (!targetContainer) {
            mentionSound.play().catch(e => console.log("Audio play blocked:", e));
        }
    }

    const timeStr = formatMessageTime(timestamp || Date.now());
    
    // Ø¥Ø­Ø¶Ø§Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ³Ù…Ø©
    let achievementCount = 0;
    if (badges && Array.isArray(badges)) {
        achievementCount = badges.length;
    } else {
        const onlineUserForBadges = isOwn ? currentUser : (window.onlineUsersData ? window.onlineUsersData[user] : null);
        achievementCount = (onlineUserForBadges && onlineUserForBadges.badges) ? onlineUserForBadges.badges.length : 0;
    }
    const achievementCountBadge = achievementCount > 0 ? `<div class="achievement-count-badge" title="${achievementCount} Ø£ÙˆØ³Ù…Ø©">${achievementCount}</div>` : '';

    // ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ©
    messageDiv.className = `chat-message flex flex-row items-start w-full user-message`;
    
    // --- Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯Ù…Ø¬ ---
    const messageBgClass = currentRoomSettings?.messageBackground || 'bg-gray-800';
    const messageTextColorClass = currentRoomSettings?.textColor || 'text-white';
    
    if (!messageId) {
        messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    messageDiv.setAttribute('data-message-id', messageId);
    
    let rankBadge = '';
    if (userRank) {
        const rankInfo = ranks[userRank] || {}; 
        const iconHtml = getRankIconHtml(rankInfo.icon, "text-base");
        rankBadge = `<span title="${userRank}" class="mx-1 inline-flex items-center align-middle">${iconHtml}</span>`;
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ù„Ø­Ø°Ù
    const senderLevel = userRank ? (ranks[userRank]?.level || 0) : 0;
    const myLevel = currentUser.rank ? (ranks[currentUser.rank]?.level || 0) : 0;
    const isMessageOwner = user === currentUser.name;
    const canDelete = (currentUser.isSiteOwner) || (isMessageOwner && currentUser.rank) || (myLevel > senderLevel && myLevel >= 2);

    let directActions = `
        <button class="hover:opacity-80 transition-opacity" title="Ø±Ø¯" onclick="startReply('${messageId}', '${user}', '${imageData}')">
            <span class="inline-flex items-center justify-center w-5 h-5 bg-slate-700 rounded text-white shadow-sm">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
            </span>
        </button>
    `;

    if (canDelete) {
        directActions += `
            <button class="text-gray-400 hover:text-red-500 transition-colors" title="Ø­Ø°Ù" onclick="deleteRoomMessage('${messageId}')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>`;
    }

    let extraMenuItems = '';
    if (canDelete) {
        extraMenuItems += `<button class="block w-full text-right px-4 py-2 hover:bg-red-600/20 text-red-400" data-action="delete">âŒ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©</button>`;
    }
    
    if ((currentUser.isSiteOwner || (myLevel > senderLevel && myLevel >= 2)) && !isMessageOwner) {
        extraMenuItems += `
            <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" data-action="mute">ğŸ”‡ ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
            <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" data-action="unmute">ğŸ”Š Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
            <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" data-action="warn">âš ï¸ ØªØ­Ø°ÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
            <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" data-action="banRoom">ğŸš« Ø­Ø¸Ø± Ù…Ù† Ø§Ù„ØºØ±ÙØ©</button>
        `;
    }

    let menuBtn = `
    <div class="relative inline-block ml-2">
        <button class="menu-btn text-gray-400 hover:text-blue-500 text-xl font-bold px-1" title="Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©" data-message-id="${messageId}" data-user="${user}" data-content="${imageData}">â‹®</button>
        <div class="message-menu hidden absolute left-0 z-50 bg-slate-800 text-white rounded shadow-lg mt-2 min-w-[160px] text-sm border border-slate-700 overflow-hidden">
            ${extraMenuItems}
        </div>
    </div>
    `;

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¯ (ReplyTo)
    let replyHtml = '';
    if (replyTo) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (Ø³ÙˆØ§Ø¡ ÙˆØ­Ø¯Ù‡ Ø£Ùˆ Ù…Ø¹ Ù†Øµ)
        const allEmojis = [...new Set([...animatedEmojis, ...localEmojis])];
        const containsEmoji = replyTo.content && allEmojis.some(e => replyTo.content.includes(e));
        const isImageReply = replyTo.content && (replyTo.content.startsWith('data:image') || replyTo.content.startsWith('http') || replyTo.content.includes('ğŸ–¼ï¸ ØµÙˆØ±Ø©') || replyTo.content.includes('ØµÙˆØ±Ø© ğŸ–¼ï¸'));
        
        let displayContent = replyTo.content;
        if (containsEmoji) {
            displayContent = formatMessageWithInlineEmojis(replyTo.content);
        } else if (isImageReply) {
            displayContent = 'ØµÙˆØ±Ø© ğŸ–¼ï¸';
        }

        // ØªØ·Ø¨ÙŠÙ‚ ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…Ù†Ø´Ù† ÙÙŠ Ø§Ù„Ø±Ø¯ Ø£ÙŠØ¶Ø§Ù‹
        if (!isImageReply && currentUser && displayContent && typeof displayContent === 'string' && displayContent.includes(`@${currentUser.name}`)) {
            const mentionRegex = new RegExp(`@${currentUser.name}\\b`, 'g');
            displayContent = displayContent.replace(mentionRegex, `<span class="text-yellow-400 font-bold">@${currentUser.name}</span>`);
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù„Ø¹Ø±Ø¶Ù‡ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† ØµÙˆØ±Ø©
        let emojiPreviewUrl = null;
        if (containsEmoji && !isImageReply) {
            emojiPreviewUrl = allEmojis.find(e => replyTo.content.includes(e));
        }

        const imagePreview = (isImageReply || emojiPreviewUrl) 
            ? `<img src="${isImageReply ? replyTo.content : emojiPreviewUrl}" class="w-10 h-10 rounded-md object-cover ml-2 border border-white/10 shadow-sm">` 
            : '';

        replyHtml = `
            <a href="#${replyTo.messageId}" onclick="scrollToMessage('${replyTo.messageId}')" class="block bg-black/20 hover:bg-black/30 p-2 rounded-lg mb-2 text-xs border-r-4 border-blue-500 transition-colors">
                <div class="flex items-center justify-between gap-3">
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-blue-400 mb-0.5">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ${replyTo.user}</div>
                        <p class="opacity-70 truncate text-slate-300">${displayContent}</p>
                    </div>
                    ${imagePreview}
                </div>
            </a>
        `;
    }

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø¥Ø·Ø§Ø±Ø§Øª
    let nameColorClass, nameBgClass, avatarFrameClass, currentNameCardBorder;
    if (isOwn) {
        nameColorClass = currentUser.nameColor || 'text-blue-100';
        nameBgClass = currentUser.nameBackground || '';
        avatarFrameClass = currentUser.avatarFrame || '';
        currentNameCardBorder = nameCardBorder || currentUser.nameCardBorder || null;
    } else {
        const onlineUser = window.onlineUsersData ? window.onlineUsersData[user] : null;
        if (onlineUser) {
            nameColorClass = (onlineUser.nameColor && onlineUser.nameColor !== 'null') ? onlineUser.nameColor : 'text-blue-200';
            nameBgClass = (onlineUser.nameBackground && onlineUser.nameBackground !== 'null') ? onlineUser.nameBackground : '';
            avatarFrameClass = (onlineUser.avatarFrame && onlineUser.avatarFrame !== 'null') ? onlineUser.avatarFrame : '';
            currentNameCardBorder = nameCardBorder || onlineUser.nameCardBorder || null;
        } else {
            nameColorClass = 'text-blue-200';
            nameBgClass = '';
            avatarFrameClass = '';
            currentNameCardBorder = nameCardBorder || null;
        }
    }

    // ØªØ¬Ù‡ÙŠØ² Ù†Ù…Ø· Ø¥Ø·Ø§Ø± Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
    let bubbleStyle = '';
    if (currentNameCardBorder && currentNameCardBorder.startsWith('border-color:')) {
        bubbleStyle = `border: 2px solid ${currentNameCardBorder.split(':')[1]};`;
    }

    const avatarHtml = avatarUrl 
        ? `<div class="w-full h-full rounded-full relative ${(avatarFrameClass && !avatarFrameClass.startsWith('border-color:')) ? avatarFrameClass : ''}" style="${(avatarFrameClass && avatarFrameClass.startsWith('border-color:')) ? `border: 2px solid ${avatarFrameClass.split(':')[1]};` : ''}">${achievementCountBadge}<img src="${avatarUrl}" class="w-full h-full rounded-full object-cover" alt="${user}"></div>`
        : `<div class="w-full h-full rounded-full relative bg-gray-400 flex items-center justify-center text-white font-bold text-sm ${(avatarFrameClass && !avatarFrameClass.startsWith('border-color:')) ? avatarFrameClass : ''}" style="${(avatarFrameClass && avatarFrameClass.startsWith('border-color:')) ? `border: 2px solid ${avatarFrameClass.split(':')[1]};` : ''}">${achievementCountBadge}${user.charAt(0).toUpperCase()}</div>`;

    messageDiv.innerHTML = `
        <div class="flex items-start gap-3">
            <div class="avatar-container flex-shrink-0 cursor-pointer" onclick="showUserProfileModal('${user}')">
                ${avatarHtml}
            </div>
            <div class="flex items-end gap-2 flex-wrap">
                <div class="message-bubble relative ${messageBgClass + ' ' + messageTextColorClass} rounded-lg p-2 max-w-[250px] sm:max-w-md w-fit" style="${bubbleStyle}">
                    ${replyHtml}
                    <div class="message-content leading-snug flex flex-col gap-1">
                        <div class="flex items-center flex-wrap gap-1">
                            <span class="username-text font-bold cursor-pointer ${nameColorClass} ${nameBgClass ? nameBgClass + ' px-1 rounded' : ''}" onclick="mentionUser('${user}')">${user}</span>
                            ${rankBadge}
                            <span class="font-bold">:</span>
                        </div>
                        <div class="relative">
                            <img src="${imageData}" class="max-w-full h-auto rounded-lg cursor-pointer chat-image" onclick="openImageModal('${imageData}')" alt="ØµÙˆØ±Ø© Ù…Ø­Ø§Ø¯Ø«Ø©">
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-1 mb-1 message-actions">
                    <span class="timestamp-text opacity-70 text-gray-400 text-[10px] ml-1">${timeStr}</span> 
                    ${directActions}
                    ${menuBtn}
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}
// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø­Ø¯Ø« Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
socket.on('room message deleted', ({ messageId }) => {
    // Ø­Ø§ÙˆÙ„ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø³ÙˆØ§Ø¡ Ø¨Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø£Ùˆ Ø§Ù„Ù…Ø¤Ù‚Øª
    let msgElem = document.querySelector(`[data-message-id="${messageId}"]`);
    if (!msgElem && window.tempMessageIdMap) {
        // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…Ø¹Ø±Ù Ù…Ø¤Ù‚Øª Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ù
        for (const [tempId, realId] of Object.entries(window.tempMessageIdMap)) {
            if (realId === messageId) {
                msgElem = document.querySelector(`[data-message-id="${tempId}"]`);
                break;
            }
        }
    }
    if (msgElem) msgElem.remove();
});

// Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© ØºØ±ÙØ©
function deleteRoomMessage(messageId) {
    if (!currentRoom || !currentUser) return;
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) return;
    socket.emit('delete room message', {
        roomId: currentRoom.id,
        messageId: messageId,
        currentUser: currentUser
    });
}

// Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø´ÙƒÙ„ Ø§Ø­ØªØ±Ø§ÙÙŠ
function addPrivateImageMessage(message, isOwn) {
    const container = document.getElementById('privateChatMessages');
    if (!container) return;

    // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    const loader = document.getElementById('privateChatLoader');
    if (loader) {
        container.innerHTML = '';
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-4 flex ${isOwn ? 'flex-row-reverse' : 'flex-row'} items-end gap-2 chat-message`;
    
    const timeStr = formatMessageTime(message.timestamp || Date.now());
    const avatarUrl = message.avatar || DEFAULT_AVATAR_URL;
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ù…Ø¤Ù‚ØªØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const loadingImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPua1i+ivleWbvuWDjzwvdGV4dD48L3N2Zz4=';
    
    messageDiv.innerHTML = `
        <img src="${avatarUrl}" class="w-8 h-8 rounded-full border border-white/10" alt="avatar">
        <div class="flex flex-col ${isOwn ? 'items-end' : 'items-start'} max-w-[75%]">
            <div class="p-1 rounded-2xl text-sm ${
                isOwn ? 'bg-blue-600 rounded-br-none shadow-lg shadow-blue-900/20' : 'bg-slate-700 rounded-bl-none shadow-lg shadow-black/20'
            }">
                <div class="relative overflow-hidden rounded-xl">
                    <img src="${loadingImage}" data-src="${message.imageData}" class="max-w-full h-auto rounded-lg cursor-pointer chat-image transition-transform hover:scale-[1.02]" onclick="openImageModal('${message.imageData}')" alt="ØµÙˆØ±Ø© Ù…Ø­Ø§Ø¯Ø«Ø©" onload="handleImageLoad(this)" onerror="handleImageError(this)"> 
                </div>
            </div>
            <div class="text-[10px] opacity-50 mt-1 mx-1">${timeStr}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„DOM
    setTimeout(() => {
        loadImageIfNeeded(message.imageData, (finalImageData) => {
            const img = messageDiv.querySelector('img.chat-image');
            if (img) {
                img.src = finalImageData;
                img.setAttribute('onclick', `openImageModal('${finalImageData}')`);
            }
        });
    }, 100);
    
    container.scrollTop = container.scrollHeight;
}

// Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø´ÙƒÙ„ Ù…ÙƒØ¨Ø±
function openImageModal(imageData) {
    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="relative max-w-4xl max-h-full">
            <button onclick="closeImageModal()" class="absolute -top-12 left-0 text-white text-2xl z-10">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <img src="${imageData}" class="max-w-full max-h-full object-contain" alt="ØµÙˆØ±Ø© Ù…ÙƒØ¨Ø±Ø©">
        </div>
    `;
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeImageModal();
        }
    });
    
    document.body.appendChild(modal);
}

function closeImageModal() {
    const modal = document.querySelector('.fixed.inset-0.bg-black');
    if (modal) {
        modal.remove();
    }
}

// ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø§ÙŠÙ…ÙˆØ¬ÙŠØ§Øª
function updateUIWithImageButtons() {
    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
    const messageInputContainer = document.getElementById('messageInputContainer');
    if (messageInputContainer) {
        // Ø²Ø± Ø§Ù„ØµÙˆØ±
        if (!messageInputContainer.querySelector('#imageButton')) {
            const imageButton = document.createElement('button');
            imageButton.id = 'imageButton';
            imageButton.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
            `;
            imageButton.className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-full font-semibold transition-colors flex items-center justify-center';
            imageButton.onclick = openImageUpload;
            imageButton.title = 'Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø©';
            
            const sendButton = messageInputContainer.querySelector('#sendMessageButton');
            messageInputContainer.insertBefore(imageButton, sendButton);
        }

        // Ø²Ø± Ø§Ù„Ø§ÙŠÙ…ÙˆØ¬ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
        if (!messageInputContainer.querySelector('#emojiButton')) {
            const emojiButton = document.createElement('button');
            emojiButton.id = 'emojiButton';
            emojiButton.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            `;
            emojiButton.className = 'bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-3 rounded-full font-semibold transition-colors flex items-center justify-center';
            emojiButton.onclick = (e) => {
                e.stopPropagation();
                toggleEmojiPicker(false);
            };
            emojiButton.title = 'Ø§ÙŠÙ…ÙˆØ¬ÙŠØ§Øª Ù…ØªØ­Ø±ÙƒØ©';
            
            const imageButton = messageInputContainer.querySelector('#imageButton');
            messageInputContainer.insertBefore(emojiButton, imageButton);
        }
    }
    
    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ©
    const privateChatInput = document.querySelector('.private-chat-input .flex');
    if (privateChatInput) {
        // Ø²Ø± Ø§Ù„ØµÙˆØ± Ø§Ù„Ø®Ø§Øµ
        if (!privateChatInput.querySelector('#privateImageButton')) {
            const privateImageButton = document.createElement('button');
            privateImageButton.id = 'privateImageButton';
            privateImageButton.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
            `;
            privateImageButton.className = 'bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-full font-semibold transition-colors flex items-center justify-center text-sm';
            privateImageButton.onclick = openPrivateImageUpload;
            privateImageButton.title = 'Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø©';
            
            const privateSendButton = privateChatInput.querySelector('button[onclick="sendPrivateMessage()"]');
            privateChatInput.insertBefore(privateImageButton, privateSendButton);
        }

        // Ø²Ø± Ø§Ù„Ø§ÙŠÙ…ÙˆØ¬ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ø§Ù„Ø®Ø§Øµ (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ© Ø£ÙŠØ¶Ø§Ù‹ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª)
        if (!privateChatInput.querySelector('#privateEmojiButton')) {
            const privateEmojiButton = document.createElement('button');
            privateEmojiButton.id = 'privateEmojiButton';
            privateEmojiButton.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            `;
            privateEmojiButton.className = 'bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-full font-semibold transition-colors flex items-center justify-center text-sm';
            privateEmojiButton.onclick = (e) => {
                e.stopPropagation();
                toggleEmojiPicker(true);
            };
            privateEmojiButton.title = 'Ø§ÙŠÙ…ÙˆØ¬ÙŠØ§Øª Ù…ØªØ­Ø±ÙƒØ©';
            
            const privateImageButton = privateChatInput.querySelector('#privateImageButton');
            privateChatInput.insertBefore(privateEmojiButton, privateImageButton);
        }
    }
}
// ØªÙ‡ÙŠØ¦Ø© Ù…ÙŠØ²Ø§Øª Ø§Ù„ØµÙˆØ± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù„ØµÙ‚
    setupPasteHandler();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙˆØ±
    setTimeout(updateUIWithImageButtons, 1000);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ©
    const originalOpenPrivateChat = openPrivateChat;
    openPrivateChat = function(username) {
        originalOpenPrivateChat(username);
        setTimeout(updateUIWithImageButtons, 100);
    };
});

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù†Ø¯ ÙØªØ­ ØºØ±ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
const originalOpenChat = openChat;
openChat = function(roomId, roomName, icon) {
    originalOpenChat(roomId, roomName, icon);
    setTimeout(updateUIWithImageButtons, 100);
};


// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©
function loadImageIfNeeded(imageData, callback) {
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙƒÙ€ base64ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©
    if (imageData && imageData.startsWith('data:image')) {
        callback(imageData);
        return;
    }
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø© Ù…Ø±Ø¬Ø¹Ø§Ù‹ (ÙÙŠ Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ®Ø²ÙŠÙ† Ù…Ù†ÙØµÙ„ Ù„Ù„ØµÙˆØ±)
    // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù‡Ù†Ø§
    console.log('ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:', imageData);
    callback(imageData); // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ø¤Ù‚ØªØ§Ù‹
}

// Ø¯ÙˆØ§Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±
function handleImageLoad(img) {
    img.style.opacity = '0';
    setTimeout(() => {
        img.style.transition = 'opacity 0.3s ease';
        img.style.opacity = '1';
    }, 50);
}

function handleImageError(img) {
    console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©:', img.src);
    img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNjY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPua1i+ivleWksei0pTwvdGV4dD48L3N2Zz4=';
    img.alt = 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©';
}

// Ø¶ØºØ· Ø§Ù„ØµÙˆØ± Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
function compressImage(imageData, quality = 0.7, maxWidth = 800) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      let width = img.width;
      let height = img.height;
      
      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }
      
      canvas.width = width;
      canvas.height = height;
      
      // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¶ØºÙˆØ·Ø©
      ctx.drawImage(img, 0, 0, width, height);
      
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¶ØºÙˆØ·Ø©
      const compressedData = canvas.toDataURL('image/jpeg', quality);
      resolve(compressedData);
    };
    
    img.onerror = function() {
      resolve(imageData); // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
    };
    
    img.src = imageData;
  });
}
// ØªØ­Ø³ÙŠÙ† ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ© Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±
const originalOpenPrivateChat = openPrivateChat;
openPrivateChat = function(username) {
    originalOpenPrivateChat(username);
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    setTimeout(() => {
        const images = document.querySelectorAll('#privateChatMessages img.chat-image');
        images.forEach(img => {
            const originalSrc = img.getAttribute('data-src');
            if (originalSrc && img.src !== originalSrc) {
                loadImageIfNeeded(originalSrc, (finalImageData) => {
                    img.src = finalImageData;
                });
            }
        });
    }, 500);
};

// --- Ø¯ÙˆØ§Ù„ ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ… (Control Panel) ---
function openControlPanel() {
    const modal = document.getElementById('controlPanelModal');
    modal.classList.add('show');
    
    // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    socket.emit('get control stats', { currentUser });
    socket.emit('get all users stats', { currentUser });
    
    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºØ±Ù ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
    updateRoomsListTable(); // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØºØ±Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
    updateRanksTable(); // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±ØªØ¨
    initManagerPanel(); // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†

    // Ø·Ù„Ø¨ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª
    socket.emit('get quiz questions', { currentUser });
}

function closeControlPanel() {
    document.getElementById('controlPanelModal').classList.remove('show');
}

function initManagerPanel() {
    const managerRoomSelect = document.getElementById('managerRoomSelect');
    managerRoomSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± ØºØ±ÙØ©...</option>';
    
    rooms.forEach(room => {
        const option = document.createElement('option');
        option.value = room.id;
        option.textContent = `${room.icon} ${room.name}`;
        managerRoomSelect.appendChild(option);
    });

    document.getElementById('managerUserInput').value = '';
    updateManagersList();
}

function updateManagersList() {
    const roomId = parseInt(document.getElementById('managerRoomSelect').value);
    const container = document.getElementById('roomManagersList');
    const noMsg = document.getElementById('noManagersMsg');
    
    container.innerHTML = '';
    let hasManagers = false;

    rooms.forEach(room => {
        if (room.managers && room.managers.length > 0) {
            hasManagers = true;
            const roomCard = document.createElement('div');
            roomCard.className = 'bg-gray-900/50 border border-gray-600 rounded-lg p-4';
            roomCard.innerHTML = `
                <div class="font-semibold text-white mb-2">${room.icon} ${room.name}</div>
                <div class="space-y-2">
                    ${room.managers.map(manager => `
                        <div class="flex items-center justify-between bg-gray-800/50 p-2 rounded text-sm">
                            <span class="text-yellow-300">${manager}</span>
                            <button onclick="removeRoomManager(${room.id}, '${manager}')" class="text-red-400 hover:text-red-300 text-xs px-2 py-1 hover:bg-red-500/10 rounded transition-colors">Ø¥Ø²Ø§Ù„Ø©</button>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(roomCard);
        }
    });

    noMsg.style.display = hasManagers ? 'none' : 'block';
}

function assignRoomManager() {
    const roomId = parseInt(document.getElementById('managerRoomSelect').value);
    const username = document.getElementById('managerUserInput').value.trim();

    if (!roomId || !username) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØºØ±ÙØ© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
        return;
    }

    socket.emit('set room manager', {
        roomId,
        managerUsername: username,
        currentUser
    });

    document.getElementById('managerUserInput').value = '';
}

function removeRoomManager(roomId, managerUsername) {
    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© ${managerUsername} ÙƒÙ…Ø¯ÙŠØ± Ø§Ù„ØºØ±ÙØ©ØŸ`)) {
        socket.emit('remove room manager', {
            roomId,
            managerUsername,
            currentUser
        });
    }
}

function addNewRoom() {
    const name = document.getElementById('newRoomName').value.trim();
    const icon = document.getElementById('newRoomIcon').value.trim();
    const order = document.getElementById('newRoomOrder').value.trim();
    const description = document.getElementById('newRoomDesc').value.trim();
    
    if (!name || !icon) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©', 'error');
        return;
    }
    
    socket.emit('add room', { name, icon, order, description, currentUser });
    document.getElementById('newRoomName').value = '';
    document.getElementById('newRoomIcon').value = '';
    document.getElementById('newRoomOrder').value = '';
    document.getElementById('newRoomDesc').value = '';
}

function updateRoomOrder(roomId, newOrder) {
    socket.emit('update room order', { roomId, newOrder: parseInt(newOrder), currentUser });
}

function deleteRoom(roomId) {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©ØŸ')) {
        socket.emit('delete room', { roomId, currentUser });
    }
}

function updateRoomsListTable() {
    const tbody = document.getElementById('roomsListTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    // ÙØ±Ø² Ø§Ù„ØºØ±Ù Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø±Ø¶
    const sortedRooms = [...rooms].sort((a, b) => (a.order - b.order) || (a.id - b.id));
    
    sortedRooms.forEach(room => {
        const row = document.createElement('tr');
        const usersCount = room.userCount !== undefined ? room.userCount : (room.users ? room.users.length : 0);
        const status = room.protected ? 'ğŸ”’ Ù…Ø­Ù…ÙŠØ©' : 'ğŸ”“ Ø¹Ø§Ù…Ø©';
        
        row.innerHTML = `
            <td class="px-4 py-3">
                <input type="number" value="${room.order || 0}" 
                    onchange="updateRoomOrder(${room.id}, this.value)"
                    class="w-16 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-center text-xs focus:outline-none focus:ring-1 focus:ring-blue-500">
            </td>
            <td class="px-4 py-3">${room.icon}</td>
            <td class="px-4 py-3 font-semibold text-white">${room.name}</td>
            <td class="px-4 py-3 text-xs text-slate-300">${room.description || '-'}</td>
            <td class="px-4 py-3 text-center">${usersCount}</td>
            <td class="px-4 py-3 text-center text-xs">${status}</td>
            <td class="px-4 py-3 text-center">
                ${!room.protected ? `
                    <button onclick="deleteRoom(${room.id})" class="text-red-400 hover:text-red-600 px-2 py-1 rounded hover:bg-red-500/20 transition-colors text-sm">
                        ğŸ—‘ï¸ Ø­Ø°Ù
                    </button>
                ` : '<span class="text-gray-500 text-xs">Ø«Ø§Ø¨ØªØ©</span>'}
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù‡Ø§Ù…
function setAnnouncement() {
    const message = document.getElementById('announcementInput').value.trim();
    if (!message) return;
    socket.emit('set announcement', { message, currentUser });
}

function updateRanksTable() {
    const tbody = document.getElementById('ranksTableBody');
    tbody.innerHTML = '';

    // ØªØ­ÙˆÙŠÙ„ ÙƒØ§Ø¦Ù† Ø§Ù„Ø±ØªØ¨ Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© ÙˆØªØ±ØªÙŠØ¨Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹
    const sortedRanks = Object.entries(ranks).map(([name, data]) => ({
        name,
        ...data
    })).sort((a, b) => b.level - a.level);

    sortedRanks.forEach(rank => {
        const isOwner = rank.name === 'ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
        const iconHtml = getRankIconHtml(rank.icon);
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-700/30 transition-colors';
        tr.innerHTML = `
            <td class="px-4 py-3 font-medium text-white flex items-center gap-2">
                ${iconHtml}
                ${rank.name}
                ${isOwner ? '<span class="text-xs bg-yellow-500/20 text-yellow-400 px-2 py-0.5 rounded">Ø«Ø§Ø¨ØªØ©</span>' : ''}
            </td>
            <td class="px-4 py-3 font-bold text-blue-300">${rank.level}</td>
            <td class="px-4 py-3">
                <div class="w-6 h-6 rounded bg-gradient-to-r ${rank.color}"></div>
            </td>
            <td class="px-4 py-3">
                ${!isOwner ? `
                <div class="flex gap-2">
                    <button onclick="editRank('${rank.name}')" class="text-blue-400 hover:text-blue-300 p-1 hover:bg-blue-500/10 rounded" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                    <button onclick="deleteRankDefinition('${rank.name}')" class="text-red-400 hover:text-red-300 p-1 hover:bg-red-500/10 rounded" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                </div>
                ` : '<span class="text-slate-600 text-xs">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</span>'}
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function saveRankDefinition() {
    const name = document.getElementById('customRankName').value.trim();
    const iconText = document.getElementById('customRankIcon').value.trim();
    const icon = tempRankIcon || iconText;
    const level = document.getElementById('customRankLevel').value;
    const color = document.getElementById('customRankColor').value;
    const originalName = document.getElementById('editingRankName').value;
    const targetUsername = document.getElementById('customRankTarget').value.trim();

    if (!name || !icon || !level) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±ØªØ¨Ø© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©ØŒ Ø§Ù„Ù…Ø³ØªÙˆÙ‰)', 'error');
        return;
    }

    socket.emit('save rank', {
        originalName,
        name,
        icon,
        level,
        color,
        targetUsername,
        currentUser
    });
    resetRankForm();
}

function editRank(rankName) {
    const rank = ranks[rankName];
    if (!rank) return;

    document.getElementById('customRankName').value = rankName;
    
    if (rank.icon.startsWith('data:image') || rank.icon.startsWith('http')) {
        tempRankIcon = rank.icon;
        document.getElementById('rankIconPreview').src = tempRankIcon;
        document.getElementById('rankIconPreviewContainer').classList.remove('hidden');
        document.getElementById('customRankIcon').disabled = true;
        document.getElementById('customRankIcon').value = '';
    } else {
        clearRankIconImage();
        document.getElementById('customRankIcon').value = rank.icon;
    }

    document.getElementById('customRankLevel').value = rank.level;
    document.getElementById('customRankColor').value = rank.color;
    document.getElementById('editingRankName').value = rankName;
    document.getElementById('rankFormTitle').textContent = `ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØªØ¨Ø©: ${rankName}`;
    document.getElementById('saveRankBtn').textContent = 'Ø­ÙØ¸ ÙˆØªØ¹ÙŠÙŠÙ†';
    document.getElementById('cancelRankEditBtn').classList.remove('hidden');
}

function deleteRankDefinition(rankName) {
    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø±ØªØ¨Ø© "${rankName}"ØŸ Ø³ÙŠØªÙ… Ø¥Ø²Ø§Ù„ØªÙ‡Ø§ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.`)) {
        socket.emit('delete rank definition', { rankName, currentUser });
    }
}

function resetRankForm() {
    document.getElementById('customRankName').value = '';
    clearRankIconImage();
    document.getElementById('customRankLevel').value = '';
    document.getElementById('customRankTarget').value = '';
    document.getElementById('editingRankName').value = '';
    document.getElementById('rankFormTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø±ØªØ¨Ø© Ø¬Ø¯ÙŠØ¯Ø©';
    document.getElementById('saveRankBtn').textContent = 'Ø­ÙØ¸ ÙˆØªØ¹ÙŠÙŠÙ†';
    document.getElementById('cancelRankEditBtn').classList.add('hidden');
}

function removeAnnouncement() {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ')) {
        socket.emit('set announcement', { message: '', currentUser });
        document.getElementById('announcementInput').value = '';
    }
}

function hideAnnouncementLocal() {
    document.getElementById('announcementBar').classList.add('hidden');
}

socket.on('announcement update', (message) => {
    const bar = document.getElementById('announcementBar');
    const text = document.getElementById('announcementText');
    
    if (message && message.trim() !== '') {
        text.textContent = message;
        bar.classList.remove('hidden');
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§ÙØ© Ø¹Ù„ÙˆÙŠØ© Ù„Ù„ØµÙØ­Ø© Ù„ÙƒÙŠ Ù„Ø§ ÙŠØºØ·ÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        document.body.style.paddingTop = '40px';
    } else {
        bar.classList.add('hidden');
        document.body.style.paddingTop = '0';
    }
});

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
socket.on('control stats data', (stats) => {
    document.getElementById('statsTotalUsers').textContent = stats.totalUsers;
    document.getElementById('statsOnline').textContent = stats.onlineCount;
    document.getElementById('statsMales').textContent = stats.males;
    document.getElementById('statsFemales').textContent = stats.females;
});

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø´Ø§Ù…Ù„Ø©
socket.on('all users stats data', (usersList) => {
    window.allControlUsers = usersList; // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¨Ø­Ø«
    renderControlUsers(usersList);
});

function renderControlUsers(list) {
    const tbody = document.getElementById('controlUsersTableBody');
    tbody.innerHTML = '';
    
    if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
        return;
    }

    list.forEach(user => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-700/50 transition-colors group';
        
        // Username Column with Edit
        const usernameHtml = `
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full ${user.isOnline ? 'bg-green-500' : 'bg-gray-500'}" title="${user.isOnline ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„'}"></div>
                <div class="flex items-center gap-1 flex-1">
                    <input type="text" value="${user.username}" id="username-input-${user.username}" class="bg-transparent border border-transparent hover:border-gray-600 focus:border-blue-500 rounded px-1 py-0.5 text-white w-full text-sm focus:outline-none transition-colors" onkeydown="if(event.key === 'Enter') adminRenameUser('${user.username}')">
                    <button onclick="adminRenameUser('${user.username}')" class="text-blue-400 hover:text-blue-300 opacity-0 group-hover:opacity-100 transition-opacity" title="Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…">ğŸ’¾</button>
                </div>
            </div>
        `;

        // Points Column with Edit
        const pointsHtml = `
            <div class="flex items-center gap-1">
                <input type="number" value="${user.points}" id="points-input-${user.username}" class="bg-transparent border border-transparent hover:border-gray-600 focus:border-yellow-500 rounded px-1 py-0.5 text-yellow-400 font-bold w-20 text-sm focus:outline-none transition-colors" ${user.isInfinite ? 'disabled' : ''}>
                <button onclick="adminUpdatePoints('${user.username}')" class="text-yellow-400 hover:text-yellow-300 opacity-0 group-hover:opacity-100 transition-opacity" title="Ø­ÙØ¸ Ø§Ù„Ù†Ù‚Ø§Ø·" ${user.isInfinite ? 'hidden' : ''}>ğŸ’¾</button>
            </div>
        `;

        // Level Column with Edit
        const levelHtml = `
            <div class="flex items-center gap-1">
                <input type="number" value="${user.level}" id="level-input-${user.username}" class="bg-transparent border border-transparent hover:border-gray-600 focus:border-blue-500 rounded px-1 py-0.5 text-blue-300 font-bold w-16 text-sm focus:outline-none transition-colors">
                <button onclick="adminUpdateLevel('${user.username}')" class="text-blue-400 hover:text-blue-300 opacity-0 group-hover:opacity-100 transition-opacity" title="Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙˆÙ‰">ğŸ’¾</button>
            </div>
        `;

        // Infinite Toggle
        const infiniteHtml = `
            <button onclick="adminToggleInfinite('${user.username}', ${!user.isInfinite})" class="relative inline-flex items-center cursor-pointer">
                <div class="w-9 h-5 bg-gray-600 rounded-full peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 ${user.isInfinite ? 'bg-purple-600' : ''}">
                    <div class="absolute top-[2px] left-[2px] bg-white border-gray-300 border rounded-full h-4 w-4 transition-all ${user.isInfinite ? 'translate-x-full border-white' : ''}"></div>
                </div>
            </button>
        `;

        // Show in Top Toggle
        const showInTopHtml = `
            <button onclick="adminToggleShowInTop('${user.username}', ${!user.showInTop})" class="relative inline-flex items-center cursor-pointer" title="${user.showInTop ? 'Ø¥Ø®ÙØ§Ø¡ Ù…Ù† Ø§Ù„Ù…ØªÙØ§Ø¹Ù„ÙŠÙ†' : 'Ø¥Ø¸Ù‡Ø§Ø± ÙÙŠ Ø§Ù„Ù…ØªÙØ§Ø¹Ù„ÙŠÙ†'}">
                <div class="w-9 h-5 bg-gray-600 rounded-full peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 ${user.showInTop ? 'bg-green-600' : ''}">
                    <div class="absolute top-[2px] left-[2px] bg-white border-gray-300 border rounded-full h-4 w-4 transition-all ${user.showInTop ? 'translate-x-full border-white' : ''}"></div>
                </div>
            </button>
        `;

        // Actions
        const actionsHtml = `
            <button onclick="adminDeleteUser('${user.username}')" class="bg-red-500/10 hover:bg-red-500/20 text-red-400 hover:text-red-300 p-1.5 rounded-lg transition-colors" title="Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
        `;

        tr.innerHTML = `
            <td class="px-4 py-3">${usernameHtml}</td>
            <td class="px-4 py-3"><span class="bg-gray-700 px-2 py-1 rounded text-xs">${user.rank}</span></td>
            <td class="px-4 py-3">${pointsHtml}</td>
            <td class="px-4 py-3">${levelHtml}</td>
            <td class="px-4 py-3 text-center">${infiniteHtml}</td>
            <td class="px-4 py-3 text-center">${showInTopHtml}</td>
            <td class="px-4 py-3 text-center">${actionsHtml}</td>
        `;
        tbody.appendChild(tr);
    });
}

function adminRenameUser(oldUsername) {
    const input = document.getElementById(`username-input-${oldUsername}`);
    const newUsername = input.value.trim();
    
    if (newUsername === oldUsername) return;
    
    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† "${oldUsername}" Ø¥Ù„Ù‰ "${newUsername}"ØŸ`)) {
        socket.emit('admin change username', { oldUsername, newUsername, currentUser });
    } else {
        input.value = oldUsername; // Reset
    }
}

function adminUpdatePoints(username) {
    const input = document.getElementById(`points-input-${username}`);
    const newPoints = input.value;
    
    socket.emit('admin update points', { targetUsername: username, newPoints, currentUser });
    setTimeout(() => socket.emit('get all users stats', { currentUser }), 200);
}

function adminUpdateLevel(username) {
    const input = document.getElementById(`level-input-${username}`);
    const newLevel = input.value;
    
    socket.emit('admin update level', { targetUsername: username, newLevel, currentUser });
    setTimeout(() => socket.emit('get all users stats', { currentUser }), 200);
}

function adminToggleInfinite(username, newState) {
    socket.emit('admin toggle infinite', { targetUsername: username, isInfinite: newState, currentUser });
    setTimeout(() => socket.emit('get all users stats', { currentUser }), 200);
}

function adminToggleShowInTop(username, newState) {
    socket.emit('admin toggle show in top', { targetUsername: username, showInTop: newState, currentUser });
    setTimeout(() => socket.emit('get all users stats', { currentUser }), 200);
}

function adminDeleteUser(username) {
    if (confirm(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}"ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`)) {
        socket.emit('delete user', { username, currentUser });
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹
        setTimeout(() => socket.emit('get all users stats', { currentUser }), 500);
    }
}

function filterControlUsers() {
    const query = document.getElementById('controlUserSearch').value.toLowerCase();
    if (!window.allControlUsers) return;
    
    const filtered = window.allControlUsers.filter(u => u.username.toLowerCase().includes(query));
    renderControlUsers(filtered);
}

// ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºØ±Ù ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ù†Ø¯ Ø­Ø¯ÙˆØ« ØªØºÙŠÙŠØ±
socket.on('rooms update', (updatedRooms) => {
    rooms = updatedRooms;
    
    // ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØºØ±Ù ÙˆØ§Ù„Ø®Ù„ÙÙŠØ§Øª Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±Ù
    updatedRooms.forEach(room => {
        if (room.settings) {
            roomsWithSettings[room.id] = room.settings;
        }
        if (room.background) {
            roomsWithBackgrounds[room.id] = room.background;
        }
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ØºØ±ÙØ©
    if (currentRoom) {
        const newSettings = roomsWithSettings[currentRoom.id];
        if (newSettings) {
            currentRoomSettings = newSettings;
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
            const bubbles = document.querySelectorAll('.message-bubble');
            bubbles.forEach(bubble => {
                const messageContainer = bubble.closest('.chat-message');
                // Ù„Ø§ Ù†ØºÙŠØ± Ø£Ù„ÙˆØ§Ù† Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø£Ùˆ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡
                if (messageContainer && !messageContainer.classList.contains('system-message') && !bubble.classList.contains('own-message')) {
                    const oldClasses = Array.from(bubble.classList)
                        .filter(cls => cls.startsWith('bg-') || cls.startsWith('text-'));
                    oldClasses.forEach(cls => bubble.classList.remove(cls));
                    
                    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØºØ±ÙØ©
                    const settingClasses = newSettings.messageBackground.split(' ');
                    settingClasses.forEach(cls => {
                        if (cls.trim()) bubble.classList.add(cls);
                    });
                    
                    if (newSettings.textColor) {
                        bubble.classList.add(newSettings.textColor);
                    }
                }
            });
        }
        
        const newBackground = roomsWithBackgrounds[currentRoom.id];
        if (newBackground && JSON.stringify(newBackground) !== JSON.stringify(currentRoomBackground)) {
            currentRoomBackground = newBackground;
            applyBackground(newBackground, true);
        }
    }
    
    loadRooms(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù…ÙØªÙˆØ­Ø©ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…ØªÙ‡Ø§ Ø£ÙŠØ¶Ø§Ù‹
    if (document.getElementById('controlPanelModal').classList.contains('show')) {
        updateRoomsListTable(); // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØºØ±Ù
    }
});

socket.on('ranks update', (updatedRanks) => {
    ranks = updatedRanks;
    updateWingsConfig();
    if (document.getElementById('controlPanelModal').classList.contains('show')) {
        updateRanksTable();
    }
    // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø¹Ø±ÙˆØ¶Ø© Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø±ØªØ¨Ø©
    if (currentUser) {
        updateWelcomeMessage();
    }
});

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø®Ø·Ø£ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© (Ù…Ø«Ù„ ÙˆØ¬ÙˆØ¯ Ø§Ø³Ù… Ù…ÙƒØ±Ø±)
socket.on('join error', (error) => {
    showNotification(error, 'error');
    hideLoading();
    goBack(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
});

        // --- Ù…Ù†Ø·Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© ---
        const canvas = document.getElementById('sharedCanvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;
        let currentX = 0;
        let currentY = 0;

        function openDrawingBoard() {
            document.getElementById('drawingModal').classList.add('show');
            socket.emit('get board state');
        }

        function closeDrawingBoard() {
            document.getElementById('drawingModal').classList.remove('show');
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            let clientX = e.clientX;
            let clientY = e.clientY;
            
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            }

            return [
                (clientX - rect.left) * scaleX,
                (clientY - rect.top) * scaleY
            ];
        }

        function drawLine(x0, y0, x1, y1, color, width, emit) {
            ctx.beginPath();
            ctx.moveTo(x0, y0);
            ctx.lineTo(x1, y1);
            ctx.strokeStyle = color;
            ctx.lineWidth = width;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            ctx.closePath();

            if (emit) {
                socket.emit('draw', { x0, y0, x1, y1, color, width });
            }
        }

        // Mouse events
        canvas.addEventListener('mousedown', (e) => {
            drawing = true;
            [currentX, currentY] = getPos(e);
        });
        canvas.addEventListener('mouseup', () => drawing = false);
        canvas.addEventListener('mouseout', () => drawing = false);
        canvas.addEventListener('mousemove', (e) => {
            if (!drawing) return;
            const [newX, newY] = getPos(e);
            const color = document.getElementById('drawingColor').value;
            const width = document.getElementById('drawingWidth').value;
            drawLine(currentX, currentY, newX, newY, color, width, true);
            [currentX, currentY] = [newX, newY];
        });

        // Touch events
        canvas.addEventListener('touchstart', (e) => {
            drawing = true;
            [currentX, currentY] = getPos(e);
            e.preventDefault();
        }, { passive: false });
        canvas.addEventListener('touchend', () => drawing = false);
        canvas.addEventListener('touchmove', (e) => {
            if (!drawing) return;
            const [newX, newY] = getPos(e);
            const color = document.getElementById('drawingColor').value;
            const width = document.getElementById('drawingWidth').value;
            drawLine(currentX, currentY, newX, newY, color, width, true);
            [currentX, currentY] = [newX, newY];
            e.preventDefault();
        }, { passive: false });

        function clearDrawingBoard() {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')) {
                socket.emit('clear board');
            }
        }

        // Socket listeners for drawing
        socket.on('draw', (data) => {
            drawLine(data.x0, data.y0, data.x1, data.y1, data.color, data.width, false);
        });

        socket.on('board state', (history) => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ØªØ¹ÙŠÙŠÙ† Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            history.forEach(data => {
                drawLine(data.x0, data.y0, data.x1, data.y1, data.color, data.width, false);
            });
        });

        socket.on('clear board', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        });

        function openRoomInfo() {
            if (!currentRoom) {
                showNotification('ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙÙŠ ØºØ±ÙØ©', 'error');
                return;
            }
            socket.emit('get room info', currentRoom.id);
        }

        function closeRoomInfo() {
            document.getElementById('roomInfoModal').classList.remove('show');
        }

        socket.on('room info', (roomInfo) => {
            const modal = document.getElementById('roomInfoModal');
            const title = document.getElementById('roomInfoTitle');
            const desc = document.getElementById('roomInfoDesc');
            const content = document.getElementById('roomInfoContent');

            title.textContent = `${roomInfo.icon} ${roomInfo.name}`;
            desc.textContent = roomInfo.description || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØµÙ Ù„Ù„ØºØ±ÙØ©';

            let html = `
                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                    <h3 class="text-white font-semibold mb-3">ğŸ‘® Ù…Ø¯ÙŠØ±Ùˆ Ø§Ù„ØºØ±ÙØ©</h3>
                    <div class="text-sm">
                        ${roomInfo.managers.length > 0 
                            ? `<p class="text-yellow-400">${roomInfo.managers.join(', ')}</p>`
                            : '<p class="text-slate-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯ÙŠØ±ÙˆÙ†</p>'
                        }
                    </div>
                </div>

                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                    <h3 class="text-white font-semibold mb-3">ğŸ“ Ø§Ù„ÙˆØµÙ</h3>
                    <p class="text-slate-300 text-sm">${roomInfo.description || roomInfo.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                </div>
            `;

            const isManager = currentUser && (currentUser.isSiteOwner || roomInfo.managers.includes(currentUser.name));
            if (isManager) {
                html += `
                    <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                        <h3 class="text-white font-semibold mb-4">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØºØ±ÙØ©</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm text-slate-300 mb-2 block">ÙˆØµÙ Ø§Ù„ØºØ±ÙØ©</label>
                                <input type="text" id="roomDescInput" value="${roomInfo.description || ''}" placeholder="Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ø§Ù„ØºØ±ÙØ©" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                            </div>

                            <div>
                                <label class="text-sm text-slate-300 mb-2 block">Ù„ÙˆÙ† Ø§Ù„Ù†Øµ</label>
                                <select id="roomTextColorSelect" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <optgroup label="Ø£Ø³Ø§Ø³ÙŠ" class="bg-gray-800">
                                        <option value="text-white" ${roomInfo.settings?.textColor === 'text-white' ? 'selected' : ''}>Ø£Ø¨ÙŠØ¶ Ø§ÙØªØ±Ø§Ø¶ÙŠ</option>
                                        <option value="text-gray-200" ${roomInfo.settings?.textColor === 'text-gray-200' ? 'selected' : ''}>Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­</option>
                                    </optgroup>
                                    <optgroup label="Ø£Ù„ÙˆØ§Ù† Ø­ÙŠÙˆÙŠØ©" class="bg-gray-800">
                                        <option value="text-blue-300" ${roomInfo.settings?.textColor === 'text-blue-300' ? 'selected' : ''}>Ø£Ø²Ø±Ù‚ Ø³Ù…Ø§ÙˆÙŠ</option>
                                        <option value="text-cyan-300" ${roomInfo.settings?.textColor === 'text-cyan-300' ? 'selected' : ''}>ÙÙŠØ±ÙˆØ²ÙŠ (Ø³ÙŠØ§Ù†)</option>
                                        <option value="text-emerald-300" ${roomInfo.settings?.textColor === 'text-emerald-300' ? 'selected' : ''}>Ø²Ù…Ø±Ø¯ÙŠ</option>
                                        <option value="text-green-300" ${roomInfo.settings?.textColor === 'text-green-300' ? 'selected' : ''}>Ø£Ø®Ø¶Ø± ÙØ§ØªØ­</option>
                                        <option value="text-yellow-200" ${roomInfo.settings?.textColor === 'text-yellow-200' ? 'selected' : ''}>Ø£ØµÙØ± Ø°Ù‡Ø¨ÙŠ</option>
                                        <option value="text-orange-300" ${roomInfo.settings?.textColor === 'text-orange-300' ? 'selected' : ''}>Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</option>
                                        <option value="text-red-300" ${roomInfo.settings?.textColor === 'text-red-300' ? 'selected' : ''}>Ø£Ø­Ù…Ø± Ù†Ø§Ø¹Ù…</option>
                                        <option value="text-pink-300" ${roomInfo.settings?.textColor === 'text-pink-300' ? 'selected' : ''}>ÙˆØ±Ø¯ÙŠ</option>
                                        <option value="text-purple-300" ${roomInfo.settings?.textColor === 'text-purple-300' ? 'selected' : ''}>Ø¨Ù†ÙØ³Ø¬ÙŠ</option>
                                        <option value="text-indigo-300" ${roomInfo.settings?.textColor === 'text-indigo-300' ? 'selected' : ''}>Ø¥Ù†Ø¯ÙŠØ¬Ùˆ</option>
                                    </optgroup>
                                </select>
                            </div>

                            <div>
                                <label class="text-sm text-slate-300 mb-2 block">Ø®Ù„ÙÙŠØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</label>
                                <select id="roomMessageBgSelect" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <optgroup label="Ø´ÙØ§ÙÙŠØ© ÙˆÙ…Ø¤Ø«Ø±Ø§Øª" class="bg-gray-800">
                                        <option value="bg-gray-800" ${roomInfo.settings?.messageBackground === 'bg-gray-800' ? 'selected' : ''}>Ø±Ù…Ø§Ø¯ÙŠ Ø¯Ø§ÙƒÙ† (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
                                        <option value="bg-slate-900/80" ${roomInfo.settings?.messageBackground === 'bg-slate-900/80' ? 'selected' : ''}>Ø³Ù„ÙŠØª Ø²Ø¬Ø§Ø¬ÙŠ</option>
                                        <option value="bg-black/50" ${roomInfo.settings?.messageBackground === 'bg-black/50' ? 'selected' : ''}>Ø£Ø³ÙˆØ¯ Ø´ÙØ§Ù</option>
                                        <option value="bg-white/10" ${roomInfo.settings?.messageBackground === 'bg-white/10' ? 'selected' : ''}>Ø£Ø¨ÙŠØ¶ Ø²Ø¬Ø§Ø¬ÙŠ</option>
                                    </optgroup>
                                    <optgroup label="Ø£Ù„ÙˆØ§Ù† ØµÙ„Ø¨Ø©" class="bg-gray-800">
                                        <option value="bg-blue-600" ${roomInfo.settings?.messageBackground === 'bg-blue-600' ? 'selected' : ''}>Ø£Ø²Ø±Ù‚ Ø§Ø­ØªØ±Ø§ÙÙŠ</option>
                                        <option value="bg-indigo-700" ${roomInfo.settings?.messageBackground === 'bg-indigo-700' ? 'selected' : ''}>Ø¥Ù†Ø¯ÙŠØ¬Ùˆ Ø¹Ù…ÙŠÙ‚</option>
                                        <option value="bg-purple-800" ${roomInfo.settings?.messageBackground === 'bg-purple-800' ? 'selected' : ''}>Ø¨Ù†ÙØ³Ø¬ÙŠ Ù…Ù„ÙƒÙŠ</option>
                                        <option value="bg-emerald-700" ${roomInfo.settings?.messageBackground === 'bg-emerald-700' ? 'selected' : ''}>Ø£Ø®Ø¶Ø± Ø²Ù…Ø±Ø¯ÙŠ</option>
                                        <option value="bg-rose-700" ${roomInfo.settings?.messageBackground === 'bg-rose-700' ? 'selected' : ''}>ÙˆØ±Ø¯ÙŠ ØºØ§Ù…Ù‚</option>
                                        <option value="bg-amber-700" ${roomInfo.settings?.messageBackground === 'bg-amber-700' ? 'selected' : ''}>Ø¹Ù†Ø¨Ø±ÙŠ (Ø£Ù…Ø¨Ø±)</option>
                                    </optgroup>
                                </select>
                            </div>

                            <div>
                                <label class="text-sm text-slate-300 mb-2 block">Ø®Ù„ÙÙŠØ© Ø§Ù„ØºØ±ÙØ©</label>
                                <select id="roomBgTypeSelect" onchange="updateBackgroundTypeOptions()" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="gradient" ${roomInfo.background?.type === 'gradient' ? 'selected' : ''}>ØªØ¯Ø±Ø¬</option>
                                    <option value="color" ${roomInfo.background?.type === 'color' ? 'selected' : ''}>Ù„ÙˆÙ†</option>
                                    <option value="image" ${roomInfo.background?.type === 'image' ? 'selected' : ''}>ØµÙˆØ±Ø© Ù…Ø®ØµØµØ©</option>
                                </select>
                            </div>

                            <div id="backgroundOptionsContainer">
                                ${roomInfo.background?.type === 'gradient' ? `
                                    <div>
                                        <label class="text-sm text-slate-300 mb-2 block">Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ù„ÙˆÙ†ÙŠ</label>
                                        <select id="roomBgValueSelect" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                            <option value="from-purple-900 via-blue-900 to-indigo-900" ${roomInfo.background?.value === 'from-purple-900 via-blue-900 to-indigo-900' ? 'selected' : ''}>Ø¨Ù†ÙØ³Ø¬ÙŠ-Ø£Ø²Ø±Ù‚</option>
                                            <option value="from-green-900 via-blue-900 to-purple-900" ${roomInfo.background?.value === 'from-green-900 via-blue-900 to-purple-900' ? 'selected' : ''}>Ø£Ø®Ø¶Ø±-Ø£Ø²Ø±Ù‚</option>
                                            <option value="from-pink-900 via-red-900 to-orange-900" ${roomInfo.background?.value === 'from-pink-900 via-red-900 to-orange-900' ? 'selected' : ''}>ÙˆØ±Ø¯ÙŠ-Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</option>
                                            <option value="from-gray-800 to-gray-900" ${roomInfo.background?.value === 'from-gray-800 to-gray-900' ? 'selected' : ''}>Ø±Ù…Ø§Ø¯ÙŠ</option>
                                        </select>
                                    </div>
                                ` : roomInfo.background?.type === 'color' ? `
                                    <div>
                                        <label class="text-sm text-slate-300 mb-2 block">Ø§Ù„Ù„ÙˆÙ†</label>
                                        <input type="color" id="roomBgColorInput" value="${roomInfo.background?.value || '#1f2937'}" class="w-full h-10 rounded-lg cursor-pointer">
                                    </div>
                                ` : roomInfo.background?.type === 'image' ? `
                                    <div>
                                        <label class="text-sm text-slate-300 mb-2 block">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®ØµØµØ©</label>
                                        <input type="file" id="roomBgImageInput" accept="image/*" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <div id="imageUploadProgress" class="text-sm text-slate-300 mt-2"></div>
                                    </div>
                                ` : ''}
                            </div>

                            <button onclick="saveRoomSettings('${currentRoom.id}')" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors mt-4">
                                ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                            </button>
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html;
            modal.classList.add('show');
        });

        function updateBackgroundTypeOptions() {
            const bgType = document.getElementById('roomBgTypeSelect')?.value || 'gradient';
            const container = document.getElementById('backgroundOptionsContainer');
            
            let html = '';
            if (bgType === 'gradient') {
                html = `
                    <div>
                        <label class="text-sm text-slate-300 mb-2 block">Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ù„ÙˆÙ†ÙŠ</label>
                        <select id="roomBgValueSelect" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="from-purple-900 via-blue-900 to-indigo-900">Ø¨Ù†ÙØ³Ø¬ÙŠ-Ø£Ø²Ø±Ù‚</option>
                            <option value="from-green-900 via-blue-900 to-purple-900">Ø£Ø®Ø¶Ø±-Ø£Ø²Ø±Ù‚</option>
                            <option value="from-pink-900 via-red-900 to-orange-900">ÙˆØ±Ø¯ÙŠ-Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ</option>
                            <option value="from-gray-800 to-gray-900">Ø±Ù…Ø§Ø¯ÙŠ</option>
                        </select>
                    </div>
                `;
            } else if (bgType === 'color') {
                html = `
                    <div>
                        <label class="text-sm text-slate-300 mb-2 block">Ø§Ù„Ù„ÙˆÙ†</label>
                        <input type="color" id="roomBgColorInput" value="#1f2937" class="w-full h-10 rounded-lg cursor-pointer">
                    </div>
                `;
            } else if (bgType === 'image') {
                html = `
                    <div>
                        <label class="text-sm text-slate-300 mb-2 block">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®ØµØµØ©</label>
                        <input type="file" id="roomBgImageInput" accept="image/*" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <div id="imageUploadProgress" class="text-sm text-slate-300 mt-2"></div>
                    </div>
                `;
            }
            
            if (container) {
                container.innerHTML = html;
            }
        }

        function uploadRoomBackground(roomId, file) {
            const formData = new FormData();
            formData.append('image', file);

            const progressDiv = document.getElementById('imageUploadProgress');
            if (progressDiv) {
                progressDiv.textContent = 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...';
            }

            fetch('/api/upload-room-background', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (progressDiv) {
                        progressDiv.textContent = 'ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­';
                    }
                    socket.emit('update room background', {
                        roomId,
                        backgroundType: 'image',
                        backgroundValue: data.fileUrl,
                        currentUser
                    });
                    setTimeout(() => {
                        if (progressDiv) {
                            progressDiv.textContent = '';
                        }
                    }, 2000);
                } else {
                    if (progressDiv) {
                        progressDiv.textContent = 'ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©';
                    }
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                if (progressDiv) {
                    progressDiv.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©';
                }
            });
        }

        function saveRoomSettings(roomId) {
            const description = document.getElementById('roomDescInput')?.value || '';
            const textColor = document.getElementById('roomTextColorSelect')?.value || 'text-white';
            const messageBackground = document.getElementById('roomMessageBgSelect')?.value || 'bg-gray-800';
            const backgroundType = document.getElementById('roomBgTypeSelect')?.value || 'gradient';

            socket.emit('update room settings', {
                roomId,
                description,
                textColor,
                messageBackground,
                currentUser
            });

            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø®Ù„ÙÙŠØ© Ø§Ù„ØºØ±ÙØ©
            if (backgroundType === 'image') {
                const imageInput = document.getElementById('roomBgImageInput');
                if (imageInput && imageInput.files.length > 0) {
                    uploadRoomBackground(roomId, imageInput.files[0]);
                }
            } else if (backgroundType === 'gradient') {
                const backgroundValue = document.getElementById('roomBgValueSelect')?.value || 'from-gray-800 to-gray-900';
                socket.emit('update room background', {
                    roomId,
                    backgroundType: 'gradient',
                    backgroundValue,
                    currentUser
                });
            } else if (backgroundType === 'color') {
                const backgroundValue = document.getElementById('roomBgColorInput')?.value || '#1f2937';
                socket.emit('update room background', {
                    roomId,
                    backgroundType: 'color',
                    backgroundValue,
                    currentUser
                });
            }
        }

        socket.on('message deleted', (data) => {
            const messageEl = document.querySelector(`[data-message-id="${data.messageId}"]`);
            if (messageEl) {
                messageEl.remove();
            }
        });

        // --- Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª (QuizBot) ---
        function renderQuizQuestions(questions) {
            const tbody = document.getElementById('quizQuestionsTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            
            questions.forEach(q => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-3 text-blue-400 font-semibold">${q.category || 'Ø¹Ø§Ù…'}</td>
                    <td class="px-4 py-3 text-white">${q.question}</td>
                    <td class="px-4 py-3 text-yellow-300 font-bold">${q.answer}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteQuizQuestion(${q.id})" class="text-red-400 hover:text-red-600 px-2 py-1 rounded hover:bg-red-500/20 transition-colors text-sm">
                            ğŸ—‘ï¸ Ø­Ø°Ù
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function addQuizQuestion() {
            const category = document.getElementById('newQuizCategory').value.trim();
            const question = document.getElementById('newQuizQuestion').value.trim();
            const answer = document.getElementById('newQuizAnswer').value.trim();
            
            if (!category || !question || !answer) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙØ¦Ø©ØŒ Ø§Ù„Ø³Ø¤Ø§Ù„ØŒ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø©', 'error');
                return;
            }
            
            socket.emit('add quiz question', { category, question, answer, currentUser });
            document.getElementById('newQuizCategory').value = '';
            document.getElementById('newQuizQuestion').value = '';
            document.getElementById('newQuizAnswer').value = '';
        }

        function deleteQuizQuestion(id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ')) {
                socket.emit('delete quiz question', { id, currentUser });
            }
        }

        socket.on('quiz questions list', (questions) => {
            renderQuizQuestions(questions);
        });
    </script>
</body>
</html>