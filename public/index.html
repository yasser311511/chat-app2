 
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WalChat - وال شات  منصة الدردشة العربية </title>
    <meta name="description" content="WalChat - منصة دردشة عربية آمنة وممتعة. تواصل مع الأصدقاء في بيئة محمية بقوانين صارمة ضد الإساءة والمحتوى غير اللائق.">
    <meta name="keywords" content="دردشة عربية, شات عربي, محادثة, تواصل ,وال شات,WalChat, دردشة آمنة">
    <meta name="author" content="WalChat">
    <meta property="og:title" content="WalChat - منصة الدردشة العربية">
    <meta property="og:description" content="انضم إلى مجتمع WalChat للدردشة العربية الآمنة والممتعة">
    <meta property="og:image" content="https://walidchating.onrender.com/icon.png">
    <meta property="og:url" content="https://walidchating.onrender.com">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="canonical" href="https://walidchating.onrender.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&family=Amiri:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Cairo:wght@300;400;600;700&family=Changa:wght@400;700&family=El+Messiri:wght@400;700&family=Harmattan:wght@400;700&family=Katibeh&family=Kufam:wght@400;700&family=Lalezar&family=Lateef&family=Lemonada:wght@400;700&family=Mada:wght@200;300;400;500;600;700;900&family=Mirza:wght@400;500;600;700&family=Rakkas&family=Readex+Pro:wght@200;400;700&family=Reem+Kufi:wght@400;500;600;700&family=Scheherazade+New:wght@400;700&family=Tajawal:wght@400;700&family=Vibes&display=swap');
        
        .font-cairo { font-family: 'Cairo', sans-serif; }
        .font-tajawal { font-family: 'Tajawal', sans-serif; }
        .font-amiri { font-family: 'Amiri', serif; }
        .font-aref { font-family: 'Aref Ruqaa', serif; }
        .font-rakkas { font-family: 'Rakkas', serif; }
        .font-lemonada { font-family: 'Lemonada', cursive; }
        .font-changa { font-family: 'Changa', sans-serif; }
        .font-messiri { font-family: 'El Messiri', sans-serif; }
        .font-almarai { font-family: 'Almarai', sans-serif; }
        .font-harmattan { font-family: 'Harmattan', sans-serif; }
        .font-lalezar { font-family: 'Lalezar', cursive; }
        .font-mada { font-family: 'Mada', sans-serif; }
        .font-reem-kufi { font-family: 'Reem Kufi', sans-serif; }
        .font-scheherazade { font-family: 'Scheherazade New', serif; }
        .font-lateef { font-family: 'Lateef', cursive; }
        .font-mirza { font-family: 'Mirza', cursive; }
        .font-vibes { font-family: 'Vibes', cursive; }
        .font-katibeh { font-family: 'Katibeh', cursive; }
        .font-kufam { font-family: 'Kufam', sans-serif; }
        .font-readex { font-family: 'Readex Pro', sans-serif; }

        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #000000;
        }
        .chat-message {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-container { transition: all 0.3s ease; }
        .tab-button { transition: all 0.2s ease; }
        .avatar-option { transition: all 0.2s ease; }
        .avatar-option:hover { transform: scale(1.1); }
        .avatar-option.selected { border: 3px solid #3B82F6; }
        .notification {
            animation: notificationSlide 0.5s ease-out, notificationFade 5s forwards;
        }
        @keyframes notificationSlide {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes notificationFade {
            0%, 70% { opacity: 1; }
            100% { opacity: 0; }
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        /* تعديل z-index للشاشات الكبيرة - تم نقله إلى رأس المحادثة */
        @media (min-width: 768px) {
            #onlineUsersPanel { z-index: 20; }
        }
        /* تعديل خاص بالشاشات الصغيرة */
        @media (max-width: 768px) {
            .chat-header-mobile { min-height: auto; }
            .chat-header-buttons { flex-wrap: wrap; justify-content: flex-end; gap: 0.5rem; }
        }
        .rank-badge {
            background: linear-gradient(45deg, #3B82F6, #8B5CF6);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            margin-left: 5px;
        }
        .achievement-badge {
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-right: 2px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: help;
        }
        .achievement-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            transition: all 0.3s ease;
        }
        .achievement-card.completed {
            border-color: #10B981;
            background: rgba(16, 185, 129, 0.1);
        }
        .achievement-count-badge {
            position: absolute;
            bottom: -4px;
            right: -4px;
            width: 14px;
            height: 14px;
            background: #6B7280;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 5;
        }
        .messages-container {
            height: 100%;
            overflow-y: auto;
        }
    
        .users-container {
            height: 100%;
            overflow-y: auto;
        }
    
        /* نضمن أن المحتوى الرئيسي لا ينزاح */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* سبينر التحميل */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        /* Responsive Canvas */
        canvas {
            max-width: 100% !important;
            height: auto !important;
        }

        @media (max-width: 768px) {
            .users-container {
                position: fixed;
                top: 0;
                right: -100%;
                width: 80%;
                height: 100vh;
                z-index: 200 !important;
                transition: transform 0.3s ease;
                background: rgba(15, 23, 42, 0.95);
                backdrop-filter: blur(10px);
                padding: 1rem;
            }
            
            .users-container.show {
                right: 0;
                transform: translateX(0);
                display: block !important;
            }
            
            .users-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }
            
            .users-overlay.show {
                display: block;
            }
        }

        /* Responsive adjustments for very small screens */
        @media (max-width: 380px) {
            /* Reduce padding on main chat send button */
            #messageInputContainer {
                padding: 0.25rem !important;
                gap: 0.25rem !important;
            }
            #messageInput {
                padding: 0.5rem !important;
            }
            #messageInputContainer button {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            #messageInputContainer span {
                display: none; /* Hide the "Send" text */
            }
            #messageInputContainer svg {
                margin: auto;
            }
            #sendMessageButton {
                padding: 0.5rem !important;
            }

            /* Reduce padding on login/register form */
            #loginPage .p-8 {
                padding: 1.5rem;
            }

            /* Reduce font size on room cards */
            #roomsContainer h3 {
                font-size: 1.1rem;
            }
            #roomsContainer p {
                font-size: 0.8rem;
            }
        }

        /* Ensure main chat area flexes correctly */
        #chatPage > .flex-1 {
            flex-direction: column;
        }
        @media (min-width: 768px) {
            #chatPage > .flex-1 {
                flex-direction: row;
            }
        }

        /* نمط نافذة الملف الشخصي */
       .private-chat-modal {
    position: fixed;
    bottom: 100px;
    right: 20px;
    width: 350px;
    height: 450px;
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    z-index: 999;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    transform: translateY(100%);
    opacity: 0;
    transition: all 0.3s ease;
    pointer-events: none; /* هذا السطر مهم لمنع التفاعل عندما يكون مخفيًا */
}

.private-chat-modal.show {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto; /* السماح بالتفاعل عندما يكون ظاهرًا */
}
        
        .profile-content {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            width: 90%;
            max-width: 550px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            margin: auto;
        }
        
        .profile-modal.show .profile-content {
            transform: scale(1);
        }
        
        /* نمط نافذة المحادثة الخاصة */
        /* نمط نافذة الملف الشخصي */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            overflow-y: auto;
            padding: 2rem 0;
        }
        .profile-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .private-chat-modal {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 350px;
            height: 450px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .private-chat-modal.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .private-chat-header {
            background: rgba(30, 41, 59, 0.8);
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .private-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .private-chat-input {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* تنسيقات جديدة للرأس والصفحة الرئيسية */
        .main-header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
        }
        
        .user-profile-btn {
            transition: all 0.3s ease;
        }
        
        .user-profile-btn:hover {
            transform: translateY(-2px);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #EF4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        /* تنسيقات قائمة الأصدقاء */
        .friends-sidebar {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            width: 300px;
            height: 100vh;
            position: fixed;
            top: 0;
            right: 0;
            z-index: 40;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .friends-sidebar.show {
            transform: translateX(0);
        }
        
        .friends-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 30;
        }
        
        .friends-overlay.show {
            display: block;
        }
        
        .friend-item {
            transition: all 0.3s ease;
        }
        
        .friend-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* إضافة هذه الأنماط في قسم style */
        /* نمط نافذة الايموجيات المتحركة المطور */
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            left: 20px;
            width: 320px;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 0;
            margin-bottom: 5px;
            display: none;
            flex-direction: column;
            max-height: 350px;
            overflow: hidden;
            z-index: 1000;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .emoji-picker.show {
            display: flex;
        }
        .emoji-picker-header {
            display: flex;
            background: rgba(30, 41, 59, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .emoji-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            color: #94a3b8;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .emoji-tab.active {
            color: #fff;
            background: rgba(59, 130, 246, 0.5);
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }
        /* تصغير حجم الايموجيات الثابتة */
        #grid-animated-emojiPicker, #grid-animated-privateEmojiPicker {
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }
        .animated-emoji {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: contain;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .animated-emoji:hover {
            transform: scale(1.2);
        }

.bg-option {
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.bg-option:hover {
    transform: scale(1.05);
}

.bg-option.selected > div {
    border-color: #3B82F6 !important;
}

/* أنماط الصور في المحادثة */
.chat-image {
    max-width: 300px;
    max-height: 300px;
    border-radius: 10px;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.chat-image:hover {
    transform: scale(1.02);
}

.image-modal {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; } to { opacity: 1; }
}

#imageButton, #privateImageButton {
    transition: all 0.3s ease;
}

#imageButton:hover, #privateImageButton:hover {
    transform: scale(1.05);
}

/* --- أنماط احترافية ومدمجة للرسائل --- */
.chat-message {
    margin-bottom: 0.25rem !important; /* تقليل المسافة بين الرسائل */
}
/* إظهار خيارات الرسالة عند التمرير */
.message-actions {
    opacity: 1;
    transition: opacity 0.2s ease-in-out;
}
.chat-message:hover .message-actions {
    opacity: 1;
}
/* تعديل لرسائل النظام لتجنب التأثر بـ hover */
.chat-message.justify-center:hover .message-actions {
    opacity: 0;
}

/* تقليل حجم الصورة الشخصية في الرسائل */
.chat-message .avatar-container {
    width: 2rem !important; /* 32px */
    height: 2rem !important; /* 32px */
    overflow: visible !important;
}

/* تعديل فقاعة الرسالة */
.chat-message .message-bubble {
    padding: 0.5rem 0.85rem !important; /* تقليل الحشو الداخلي للفقاعة */
    padding-left: 2.5rem !important; /* مساحة إضافية لزر الخيارات */
    border-radius: 0.75rem !important; /* تقليل استدارة الزوايا لمظهر كلاسيكي */
}

/* تعديل حجم خط الرسالة */
.chat-message .message-content {
    font-size: 0.9rem !important; /* 14.4px */
    line-height: 1.4 !important;
    word-break: break-word; /* --- الحل لمشكلة خروج النص من الفقاعة --- */
    /* --- الحل لمشكلة اتجاه النص --- */
    unicode-bidi: plaintext;
}

/* تعديل حجم خط اسم المستخدم */
.chat-message .username-text {
    font-size: 0.8rem !important; /* 12.8px */
}

/* تعديل حجم خط الوقت */
.chat-message .timestamp-text {
    font-size: 0.7rem !important; /* 11.2px */
}

/* تقليل حجم الصور داخل المحادثة */
.chat-image {
    max-width: 220px !important;
    max-height: 180px !important;
    border-radius: 0.5rem !important;
}

/* تقليل حجم رتبة المستخدم */
.rank-badge {
    font-size: 0.65rem !important; /* 10.4px */
    padding: 1px 5px !important;
    margin-bottom: 2px !important;
}

/* تحسين تخطيط معلومات المستخدم */
.chat-message .flex.items-center.space-x-3 {
    margin-bottom: 0.25rem !important;
}

.chat-message .space-x-3 > * + * {
    margin-right: 0.75rem !important;
}

/* تحسين تخطيط رسائل النظام */
.chat-message.justify-center .max-w-md {
    padding: 0.3rem 0.75rem !important;
    font-size: 0.8rem !important;
}

/* تحسين منطقة عرض الرسائل */
.messages-container {
    padding: 0.5rem !important;
}

/* تأثير دخول المستخدمين */
@keyframes slideInUser {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}
.user-entry-animation {
    animation: slideInUser 0.4s ease-out forwards;
}

/* أنماط شريط الإعلان المنبثق */
#announcementModalText {
    scrollbar-width: thin;
    scrollbar-color: rgba(239, 68, 68, 0.3) transparent;
}
#announcementModalText::-webkit-scrollbar {
    width: 6px;
}
#announcementModalText::-webkit-scrollbar-thumb {
    background-color: rgba(239, 68, 68, 0.3);
    border-radius: 10px;
}

/* الأنماط الجديدة لأقسام الملف الشخصي */
.profile-tab-btn {
    padding: 0.75rem 0.5rem;
    font-weight: 600;
    font-size: 0.85rem;
    color: #94a3b8;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
    flex: 1;
    text-align: center;
    min-width: fit-content;
}
.profile-tab-btn.active, .profile-tab-btn:hover {
    color: #3b82f6; /* text-blue-500 */
    border-bottom-color: #3b82f6;
}

/* أنماط إطارات الصور */
.frame-none { border: none; }
.frame-gold { border: 3px solid #FFD700; box-shadow: 0 0 5px #FFD700; }
.frame-silver { border: 3px solid #C0C0C0; box-shadow: 0 0 5px #C0C0C0; }
.frame-red-glow { border: 2px solid #FF4500; box-shadow: 0 0 8px #FF4500; }
.frame-blue-glow { border: 2px solid #00BFFF; box-shadow: 0 0 8px #00BFFF; }
.frame-double { border: 4px double #ffffff; }
.frame-dashed { border: 3px dashed #ffffff; }

/* إطارات متحركة جديدة */
.frame-rainbow {
    border: 3px solid transparent;
    border-image: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet) 1;
    animation: rainbow-border 3s linear infinite;
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
}
@keyframes rainbow-border {
    0% { filter: hue-rotate(0deg); }
    100% { filter: hue-rotate(360deg); }
}

.frame-neon-pulse {
    border: 3px solid #00ff00;
    animation: neon-pulse 1.5s ease-in-out infinite;
    box-shadow: 0 0 15px #00ff00;
}
@keyframes neon-pulse {
    0%, 100% { box-shadow: 0 0 5px #00ff00; border-color: #00ff00; }
    50% { box-shadow: 0 0 20px #00ff00, 0 0 30px #00ff00; border-color: #7fff00; }
}

.frame-fire {
    border: 3px solid #ff4500;
    animation: fire-glow 1s ease-in-out infinite;
    box-shadow: 0 0 10px #ff4500;
}
@keyframes fire-glow {
    0%, 100% { box-shadow: 0 0 10px #ff4500, 0 0 5px #ff8c00; }
    50% { box-shadow: 0 0 20px #ff4500, 0 0 10px #ff8c00; }
}

.frame-rotating {
    border: 3px dashed #3498db;
    animation: rotate-border 4s linear infinite;
}
@keyframes rotate-border {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* تدرجات ألوان جديدة لنص الاسم */
.text-gradient-rainbow {
    background: linear-gradient(to right, #ef4444, #f59e0b, #10b981, #3b82f6, #8b5cf6, #ec4899);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: bold;
}
.text-gradient-gold {
    background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: bold;
}
.text-gradient-fire {
    background: linear-gradient(to right, #f83600 0%, #f9d423 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: bold;
}
.text-gradient-ocean {
    background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: bold;
}

/* ألوان أسماء براقة ومتحركة */
.text-sparkle-gold {
    background: linear-gradient(90deg, #ffd700, #fff7ad, #ffd700);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shine 2s linear infinite;
    font-weight: bold;
    text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
}

.text-sparkle-rainbow {
    background: linear-gradient(to right, #ef4444, #f59e0b, #10b981, #3b82f6, #8b5cf6, #ec4899);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: rainbow-move 3s linear infinite;
    font-weight: bold;
}

.text-sparkle-blue {
    background: linear-gradient(90deg, #00d2ff, #3a7bd5, #00d2ff);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shine 2s linear infinite;
    font-weight: bold;
}

.text-sparkle-pink {
    background: linear-gradient(90deg, #ec4899, #f472b6, #ec4899);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shine 2s linear infinite;
    font-weight: bold;
}

.text-neon-pulse {
    color: #00ff00;
    text-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00;
    animation: neon-text-pulse 1.5s ease-in-out infinite alternate;
    font-weight: bold;
}
@keyframes neon-text-pulse {
    from { text-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
    to { text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00, 0 0 30px #00ff00; }
}

.text-fire-wave {
    background: linear-gradient(0deg, #f59e0b, #ef4444);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: fire-wave-anim 1s ease-in-out infinite alternate;
    font-weight: bold;
}
@keyframes fire-wave-anim {
    from { filter: brightness(1) drop-shadow(0 0 2px #ef4444); }
    to { filter: brightness(1.3) drop-shadow(0 0 5px #f59e0b); }
}

@keyframes shine {
    to { background-position: 200% center; }
}

@keyframes rainbow-move {
    0% { background-position: 0% center; }
    100% { background-position: 200% center; }
}

/* إطارات دائرية متحركة وبراقة */
.frame-diamond-sparkle {
    border: 3px solid #b9f2ff;
    box-shadow: 0 0 10px #b9f2ff, inset 0 0 5px #b9f2ff;
    animation: diamond-pulse 2s infinite alternate;
}
@keyframes diamond-pulse {
    0% { box-shadow: 0 0 5px #b9f2ff; transform: scale(1); }
    100% { box-shadow: 0 0 15px #b9f2ff, 0 0 20px #fff; transform: scale(1.02); }
}

.frame-electric {
    border: 3px solid #00ffff;
    box-shadow: 0 0 10px #00ffff;
    animation: electric-glow 0.8s ease-in-out infinite alternate;
}
@keyframes electric-glow {
    from { box-shadow: 0 0 5px #00ffff; border-color: #00ffff; }
    to { box-shadow: 0 0 15px #00ffff, 0 0 10px #fff; border-color: #fff; }
}

.frame-magic-purple {
    border: 3px double #a855f7;
    box-shadow: 0 0 10px #a855f7;
    animation: magic-rotate 3s linear infinite;
}
@keyframes magic-rotate {
    0% { border-color: #a855f7; box-shadow: 0 0 10px #a855f7; filter: hue-rotate(0deg); }
    100% { border-color: #a855f7; box-shadow: 0 0 10px #a855f7; filter: hue-rotate(360deg); }
}

.frame-lava {
    border: 3px solid #ff4d00;
    box-shadow: 0 0 10px #ff4d00;
    animation: lava-flow 2s ease-in-out infinite;
}
@keyframes lava-flow {
    0%, 100% { border-color: #ff4d00; box-shadow: 0 0 8px #ff4d00; }
    50% { border-color: #ffcc00; box-shadow: 0 0 15px #ffcc00; }
}

.frame-royal-gold {
    border: 3px solid #ffd700;
    position: relative;
    overflow: hidden;
}
.frame-royal-gold::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent 45%, rgba(255,255,255,0.6) 50%, transparent 55%);
    animation: royal-shine 3s infinite;
}
@keyframes royal-shine {
    0% { transform: translate(-30%, -30%) rotate(0deg); }
    100% { transform: translate(30%, 30%) rotate(0deg); }
}

.frame-matrix {
    border: 3px solid #00ff00;
    box-shadow: 0 0 10px #00ff00;
    animation: matrix-pulse 1.5s steps(4) infinite;
}
@keyframes matrix-pulse {
    0%, 100% { opacity: 1; border-color: #00ff00; }
    50% { opacity: 0.7; border-color: #008800; }
}

.frame-ghostly {
    border: 2px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
    animation: ghostly-fade 2s ease-in-out infinite;
}
@keyframes ghostly-fade {
    0%, 100% { opacity: 0.5; transform: scale(0.95); }
    50% { opacity: 1; transform: scale(1.05); }
}

/* إطارات جديدة */
.frame-golden-rain {
    border: 3px solid #ffd700;
    box-shadow: 0 0 10px #ffd700, inset 0 0 5px #ffd700;
    animation: golden-pulse 2s infinite;
}
@keyframes golden-pulse {
    0% { box-shadow: 0 0 5px #ffd700, inset 0 0 5px #ffd700; border-color: #ffd700; }
    50% { box-shadow: 0 0 20px #ffd700, inset 0 0 10px #ffd700; border-color: #fff; }
    100% { box-shadow: 0 0 5px #ffd700, inset 0 0 5px #ffd700; border-color: #ffd700; }
}

.frame-matrix-rain {
    border: 3px dashed #00ff00;
    box-shadow: 0 0 10px #00ff00;
    animation: spin 10s linear infinite;
}

.frame-fast-emerald {
    border: 3px solid #50c878;
    box-shadow: 0 0 15px #50c878;
    animation: emerald-flash 0.5s infinite alternate;
}
@keyframes emerald-flash {
    from { border-color: #50c878; box-shadow: 0 0 10px #50c878; }
    to { border-color: #aaffc3; box-shadow: 0 0 25px #50c878; }
}

.frame-electricity {
    border: 3px solid #00bfff;
    box-shadow: 0 0 10px #00bfff;
    animation: electric-jitter 0.3s infinite;
}
@keyframes electric-jitter {
    0% { transform: translate(0, 0); border-color: #00bfff; }
    25% { transform: translate(1px, 1px); border-color: #fff; }
    50% { transform: translate(-1px, -1px); border-color: #00bfff; }
    75% { transform: translate(-1px, 1px); border-color: #fff; }
    100% { transform: translate(1px, -1px); border-color: #00bfff; }
}

/* خلفية رسالة الانضمام النارية */
.fire-join-bg {
    background: linear-gradient(-45deg, #ff0000, #ff7f00, #ffeb3b, #ff0000);
    background-size: 400% 400%;
    animation: fireShimmer 3s ease infinite;
    border: 2px solid #ffca28;
    box-shadow: 0 0 15px rgba(255, 69, 0, 0.6);
    color: #fff !important;
}
@keyframes fireShimmer {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* إطارات التاج الخاصة */
.frame-crown-gold {
    border: 3px solid #FFD700;
    box-shadow: 0 0 10px #FFD700;
    animation: pulse-gold 2s infinite;
    position: relative;
    overflow: visible !important;
}
@keyframes pulse-gold {
    0% { box-shadow: 0 0 10px #FFD700; }
    50% { box-shadow: 0 0 20px #FFD700, 0 0 10px #FFA500; }
    100% { box-shadow: 0 0 10px #FFD700; }
}
.frame-crown-gold::after {
    content: '';
    position: absolute;
    top: -18px;
    left: 50%;
    transform: translateX(-50%);
    width: 20px;
    height: 20px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23FFD700' stroke='%23B8860B' stroke-width='1'%3E%3Cpath d='M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.6));
    z-index: 10;
}

.frame-crown-rainbow {
    border: 3px solid transparent;
    position: relative;
    background: linear-gradient(#2c2c2c, #2c2c2c) padding-box,
                linear-gradient(45deg, #ff0000, #ffff00, #0000ff, #ff0000) border-box;
    background-size: 400% 400%;
    animation: gradient-shift 3s ease infinite;
    overflow: visible !important;
}
@keyframes gradient-shift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
.frame-crown-rainbow::after {
    content: '';
    position: absolute;
    top: -18px;
    left: 50%;
    transform: translateX(-50%);
    width: 20px;
    height: 20px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='url(%23rainbow)' stroke='white' stroke-width='1'%3E%3Cdefs%3E%3ClinearGradient id='rainbow' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' style='stop-color:%23ff0000;stop-opacity:1' /%3E%3Cstop offset='50%25' style='stop-color:%23ffff00;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%230000ff;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.6));
    z-index: 10;
}

/* إطار النار الأزرق */
.frame-blue-fire {
    border: 3px solid #00bfff;
    box-shadow: 0 0 10px #00bfff, 0 0 20px #0000ff;
    animation: blue-fire-pulse 1.5s infinite alternate;
    position: relative;
    overflow: visible !important;
}
@keyframes blue-fire-pulse {
    0% { box-shadow: 0 0 10px #00bfff, 0 0 20px #0000ff; }
    100% { box-shadow: 0 0 20px #00bfff, 0 0 40px #0000ff, 0 0 10px #ffffff; }
}
.frame-blue-fire::after {
    content: '';
    position: absolute;
    top: -22px;
    left: 50%;
    width: 20px;
    height: 20px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2300bfff' stroke='%23ffffff' stroke-width='1'%3E%3Cpath d='M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    filter: drop-shadow(0 0 5px #0000ff);
    z-index: 10;
    animation: crown-spin-3d 4s linear infinite;
    transform-origin: center center;
}
@keyframes crown-spin-3d {
    0% { transform: translateX(-50%) rotateY(0deg); }
    100% { transform: translateX(-50%) rotateY(360deg); }
}

/* إطار النار البرتقالي (XP) */
.frame-orange-fire {
    border: 3px solid #ff4500;
    box-shadow: 0 0 10px #ff4500, 0 0 20px #ff8c00;
    animation: orange-fire-pulse 1.5s infinite alternate;
    position: relative;
    overflow: visible !important;
}
@keyframes orange-fire-pulse {
    0% { box-shadow: 0 0 10px #ff4500, 0 0 20px #ff8c00; border-color: #ff4500; }
    100% { box-shadow: 0 0 20px #ff4500, 0 0 40px #ffa500, 0 0 10px #ffffff; border-color: #ff8c00; }
}
.frame-orange-fire::after {
    content: '';
    position: absolute;
    top: -22px;
    left: 50%;
    transform: translateX(-50%);
    width: 20px;
    height: 20px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ff8c00' stroke='%23ff4500' stroke-width='1'%3E%3Cpath d='M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    filter: drop-shadow(0 0 5px #ff4500);
    z-index: 10;
    animation: crown-glow 2s infinite alternate;
}
@keyframes crown-glow {
    from { filter: drop-shadow(0 0 2px #ff4500); }
    to { filter: drop-shadow(0 0 8px #ffa500); }
}

/* خيارات الألوان في الميزات */
.color-option { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
.color-option:hover { transform: scale(1.2); }
.color-option.selected { border-color: white; transform: scale(1.1); }

/* أنماط عجلة الحظ */
.wheel-container {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 0 auto;
}
.wheel {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 8px solid #fbbf24;
    box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    position: relative;
    transition: transform 4s cubic-bezier(0.17, 0.67, 0.83, 0.67);
    background: conic-gradient(
        #ef4444 0deg 51.4deg, 
        #3b82f6 51.4deg 102.8deg, 
        #10b981 102.8deg 154.2deg, 
        #f59e0b 154.2deg 205.6deg, 
        #8b5cf6 205.6deg 257deg, 
        #ec4899 257deg 308.4deg, 
        #6b7280 308.4deg 360deg
    );
}
.wheel-pointer {
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-top: 30px solid #fff;
    z-index: 10;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
}

/* تأثيرات نصية جديدة خرافية */
.text-cosmic-galaxy {
    background: linear-gradient(to right, #ff00cc, #333399, #66ffff, #ff00cc);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: cosmic-anim 3s linear infinite;
    font-weight: bold;
    filter: drop-shadow(0 0 2px rgba(255, 0, 204, 0.5));
}
@keyframes cosmic-anim { to { background-position: 200% center; } }

.text-liquid-gold {
    background: linear-gradient(to right, #cfc09f, #ffecb3, #a67c00, #ffecb3, #cfc09f);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: gold-flow 2.5s linear infinite;
    font-weight: bold;
    text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
}
@keyframes gold-flow { to { background-position: 200% center; } }

.text-cyber-glitch {
    color: #0ff;
    text-shadow: 2px 0 #f0f, -2px 0 #0ff;
    animation: glitch-text 0.3s infinite;
    font-weight: bold;
}
@keyframes glitch-text {
    0% { text-shadow: 2px 0 #f0f, -2px 0 #0ff; transform: translate(0); }
    25% { text-shadow: -2px 0 #f0f, 2px 0 #0ff; transform: translate(1px, 1px); }
    50% { text-shadow: 2px 0 #0ff, -2px 0 #f0f; transform: translate(-1px, -1px); }
    75% { text-shadow: -2px 0 #0ff, 2px 0 #f0f; transform: translate(0); }
    100% { text-shadow: 2px 0 #f0f, -2px 0 #0ff; transform: translate(0); }
}

.text-inferno-blaze {
    background: linear-gradient(0deg, #ff0000, #ff7f00, #ffff00);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: blaze-anim 0.8s ease-in-out infinite alternate;
    font-weight: bold;
    filter: drop-shadow(0 0 3px #ff4500);
}
@keyframes blaze-anim {
    from { filter: drop-shadow(0 0 2px #ff0000); }
    to { filter: drop-shadow(0 0 8px #ffff00); }
}

.text-electric-storm {
    color: #e0f7fa;
    text-shadow: 0 0 5px #00bcd4, 0 0 10px #00bcd4, 0 0 20px #00bcd4;
    animation: electric-pulse 0.1s infinite alternate;
    font-weight: bold;
}
@keyframes electric-pulse {
    from { opacity: 0.8; text-shadow: 0 0 5px #00bcd4; }
    to { opacity: 1; text-shadow: 0 0 15px #00bcd4, 0 0 25px #fff; }
}

.text-diamond-prism {
    background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
    background-size: 400% 400%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: prism-move 4s ease infinite;
    font-weight: bold;
    filter: drop-shadow(0 0 2px rgba(255,255,255,0.5));
}
@keyframes prism-move {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* تأثيرات أسماء جديدة خرافية */
.text-aurora {
    background: linear-gradient(90deg, #00ff99, #00ccff, #9933ff, #00ff99);
    background-size: 300% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: aurora-flow 4s linear infinite;
    font-weight: bold;
    filter: drop-shadow(0 0 2px rgba(0, 255, 153, 0.5));
}
@keyframes aurora-flow {
    0% { background-position: 0% 50%; }
    100% { background-position: 100% 50%; }
}

.text-golden-glitch {
    color: #ffd700;
    text-shadow: 2px 0 #b8860b, -2px 0 #fffacd;
    animation: golden-glitch-anim 0.5s infinite;
    font-weight: bold;
}
@keyframes golden-glitch-anim {
    0% { text-shadow: 2px 0 #b8860b, -2px 0 #fffacd; transform: translate(0); }
    25% { text-shadow: -2px 0 #b8860b, 2px 0 #fffacd; transform: translate(1px, 1px); }
    50% { text-shadow: 2px 0 #fffacd, -2px 0 #b8860b; transform: translate(-1px, -1px); }
    75% { text-shadow: -2px 0 #fffacd, 2px 0 #b8860b; transform: translate(0); }
    100% { text-shadow: 2px 0 #b8860b, -2px 0 #fffacd; transform: translate(0); }
}

.text-plasma {
    background: linear-gradient(to right, #ff00cc, #ff3300, #ff00cc);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: plasma-move 2s linear infinite;
    font-weight: bold;
    filter: drop-shadow(0 0 3px #ff00cc);
}
@keyframes plasma-move {
    to { background-position: 200% center; }
}

.text-crystal {
    background: linear-gradient(135deg, #e0f7fa 0%, #00bcd4 50%, #e0f7fa 100%);
    background-size: 200% 200%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: crystal-shine 3s ease infinite;
    font-weight: bold;
    text-shadow: 0 0 5px rgba(224, 247, 250, 0.5);
}
@keyframes crystal-shine {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.text-radioactive {
    color: #ccff00;
    text-shadow: 0 0 5px #ccff00, 0 0 10px #33ff00;
    animation: radioactive-pulse 1s ease-in-out infinite alternate;
    font-weight: bold;
}
@keyframes radioactive-pulse {
    from { text-shadow: 0 0 5px #ccff00, 0 0 10px #33ff00; }
    to { text-shadow: 0 0 10px #ccff00, 0 0 20px #33ff00, 0 0 30px #00ff00; }
}

/* --- ألوان جديدة خرافية (10 ألوان) --- */
.text-matrix-rain { background: linear-gradient(180deg, #0f0, #003300); background-size: 100% 200%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: matrix-fall 2s linear infinite; font-weight: bold; text-shadow: 0 0 5px #0f0; }
@keyframes matrix-fall { 0% { background-position: 0% 0%; } 100% { background-position: 0% 200%; } }

.text-matrix-white { background: linear-gradient(180deg, #ffffff, #555555); background-size: 100% 200%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: matrix-fall 2s linear infinite; font-weight: bold; text-shadow: 0 0 5px #ffffff; }

.text-nebula-dream { background: linear-gradient(45deg, #ff00cc, #333399, #00ccff); background-size: 200% 200%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: nebula-swirl 5s ease infinite; font-weight: bold; }
@keyframes nebula-swirl { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

.text-volcanic-ash { background: linear-gradient(to top, #330000, #ff4500, #555); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: ash-rise 3s infinite alternate; font-weight: bold; text-shadow: 0 -2px 5px rgba(255, 69, 0, 0.5); }
@keyframes ash-rise { from { filter: brightness(0.8); } to { filter: brightness(1.2); } }

.text-holographic { background: linear-gradient(135deg, #e6e6e6 0%, #ffffff 25%, #d4d4d4 50%, #e6e6e6 75%, #ffffff 100%); background-size: 200% 200%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: holo-shift 3s linear infinite; font-weight: bold; filter: drop-shadow(0 0 2px rgba(255,255,255,0.5)); }
@keyframes holo-shift { 0% { background-position: 0% 0%; } 100% { background-position: 100% 100%; } }

.text-quantum-flux { color: #00ffff; text-shadow: 2px 0 #ff00ff; animation: quantum-vibrate 0.1s infinite; font-weight: bold; }
@keyframes quantum-vibrate { 0% { transform: translate(0,0); } 20% { transform: translate(-1px,1px); } 40% { transform: translate(1px,-1px); } 60% { transform: translate(-1px,-1px); } 80% { transform: translate(1px,1px); } 100% { transform: translate(0,0); } }

.text-starlight-shimmer { background: linear-gradient(90deg, #fff, #a1a1aa, #fff); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: star-twinkle 3s ease-in-out infinite; font-weight: bold; text-shadow: 0 0 5px #fff; }
@keyframes star-twinkle { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

.text-midnight-aurora { background: linear-gradient(to right, #020024, #097969, #00d4ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; animation: aurora-wave 4s infinite alternate; }
@keyframes aurora-wave { from { filter: hue-rotate(0deg); } to { filter: hue-rotate(30deg); } }

.text-crimson-night { background: linear-gradient(to bottom, #ff0000, #330000); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; text-shadow: 0 0 10px #ff0000; animation: crimson-pulse 2s infinite; }
@keyframes crimson-pulse { 0%, 100% { text-shadow: 0 0 10px #ff0000; } 50% { text-shadow: 0 0 20px #ff0000; } }

.text-solar-flare { background: linear-gradient(to right, #f59e0b, #ef4444, #f59e0b); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: solar-burst 1.5s linear infinite; font-weight: bold; filter: drop-shadow(0 0 3px #f59e0b); }
@keyframes solar-burst { to { background-position: 200% center; } }

.text-void-walker { background: linear-gradient(to right, #4c1d95, #000000, #4c1d95); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: void-consume 4s ease infinite; font-weight: bold; text-shadow: 0 0 5px #8b5cf6; }
@keyframes void-consume { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

/* --- ألوان متحركة جديدة (إضاءات زاهية) --- */
/* 1. نيون أزرق متحرك (يمين يسار) */
.text-anim-neon-blue {
    background: linear-gradient(90deg, #00f2fe, #4facfe, #00f2fe);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: anim-neon-blue 3s linear infinite;
    font-weight: bold;
    text-shadow: 0 0 5px rgba(0, 242, 254, 0.5);
}
@keyframes anim-neon-blue {
    0% { background-position: 0% center; }
    100% { background-position: 200% center; }
}

/* 2. مطر ذهبي (فوق تحت) */
.text-anim-golden-shower {
    background: linear-gradient(180deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
    background-size: 100% 200%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: anim-golden-shower 3s linear infinite;
    font-weight: bold;
    text-shadow: 0 0 5px rgba(191, 149, 63, 0.5);
}
@keyframes anim-golden-shower {
    0% { background-position: 0% 0%; }
    100% { background-position: 0% 200%; }
}

/* 3. نار قرمزية (تحت فوق) */
.text-anim-crimson-fire {
    background: linear-gradient(0deg, #800000, #ff0000, #ff4d4d, #800000);
    background-size: 100% 200%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: anim-crimson-fire 2s linear infinite;
    font-weight: bold;
    text-shadow: 0 0 8px rgba(255, 0, 0, 0.6);
}
@keyframes anim-crimson-fire {
    0% { background-position: 0% 100%; }
    100% { background-position: 0% 0%; }
}

/* 4. كهرباء بنفسجية (قطري) */
.text-anim-electric-purple {
    background: linear-gradient(135deg, #8a2be2, #e056fd, #8a2be2);
    background-size: 200% 200%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: anim-electric-purple 3s ease infinite;
    font-weight: bold;
    text-shadow: 0 0 5px rgba(224, 86, 253, 0.5);
}
@keyframes anim-electric-purple {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* 5. زمرد سريع (يمين يسار سريع) */
.text-anim-emerald-glitch {
    background: linear-gradient(90deg, #006400, #00ff00, #006400);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: anim-emerald-glitch 1s linear infinite;
    font-weight: bold;
    text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
}
@keyframes anim-emerald-glitch {
    0% { background-position: 200% center; }
    100% { background-position: 0% center; }
}

/* أنماط باتل رويال */
#battleRoyaleWinnerOverlay {
    text-shadow: 0 0 15px rgba(251, 191, 36, 0.8);
    animation: winner-pulse 1.5s infinite;
}

/* نظام الإشعارات بالنقطة الحمراء */
.notification-dot {
    position: absolute;
    top: 6px;
    left: 6px; /* مناسب للـ RTL */
    width: 10px;
    height: 10px;
    background-color: #ef4444; /* red-500 */
    border-radius: 50%;
    border: 2px solid #1e293b; /* slate-800 */
    animation: pulse-dot 1.5s infinite;
}
@keyframes pulse-dot {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.25); opacity: 0.8; }
}

        #changeBotAvatarBtn:hover { filter: brightness(1.2); cursor: pointer; }
        #changeBotAvatarBtn:hover::after { content: '\270E'; position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; }

        /* --- تحسينات خاصة للهواتف والشاشات الصغيرة جداً --- */
        @media (max-width: 640px) {
            /* 1. تحسين النوافذ المنبثقة (Modals) لتملأ الشاشة تقريباً */
            .profile-content {
                width: 100% !important;
                max-width: none !important;
                height: auto !important;
                min-height: 100% !important;
                margin: 0 !important;
                border-radius: 0 !important;
                overflow: visible !important;
            }
            .profile-modal {
                padding: 0 !important;
                overflow-y: auto !important;
            }
            /* 2. تحويل المحادثة الخاصة إلى ملء الشاشة */
            .private-chat-modal {
                width: 100% !important;
                height: 100% !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                border-radius: 0 !important;
                transform: translateY(100%); /* للحفاظ على الانيميشن */
            }
            .private-chat-modal.show {
                transform: translateY(0);
            }
            .private-chat-messages {
                padding-bottom: 80px !important; /* مساحة لمنطقة الكتابة */
            }

            /* 3. تحسين منطقة الرسائل في الغرفة */
            .chat-message .message-bubble {
                max-width: 85% !important; /* السماح للرسالة بأخذ عرض أكبر */
                font-size: 0.85rem !important;
                padding: 0.5rem !important;
            }
            .chat-message .avatar-container {
                width: 1.75rem !important; /* تصغير الصورة الرمزية قليلاً */
                height: 1.75rem !important;
            }
            .chat-message .username-text {
                font-size: 0.75rem !important;
            }
            
            /* 4. تحسين منطقة الإدخال (Input Area) */
            #messageInputContainer {
                gap: 0.25rem !important;
                padding: 0.25rem !important;
            }
            #messageInput {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.9rem !important;
                height: 2.75rem !important;
            }
            /* إخفاء كلمة "إرسال" والاكتفاء بالأيقونة لتوفير المساحة */
            #sendMessageButton span {
                display: none !important;
            }
            #sendMessageButton {
                padding: 0 0.75rem !important;
                height: 2.75rem !important;
            }
            /* تصغير أزرار الصور والايموجي */
            #imageButton, #emojiButton {
                width: 2.75rem !important;
                height: 2.75rem !important;
                padding: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }

            /* 5. تحسين رأس الصفحة */
            .chat-header-mobile {
                padding: 0.5rem !important;
            }
            #chatTitle {
                font-size: 1rem !important;
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .chat-header-buttons button {
                padding: 0.35rem !important;
            }
            .chat-header-buttons svg {
                width: 1.25rem !important;
                height: 1.25rem !important;
            }

            /* 6. تحسين القوائم الجانبية */
            .friends-sidebar, #leftSidebar {
                width: 85% !important; /* ليس كامل الشاشة ليبقى جزء مظلم */
            }
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    <input type="file" id="botAvatarInput" class="hidden" accept="image/*" onchange="uploadBotAvatar(event)">
    <!-- سبينر التحميل -->
    <div id="loadingSpinner" class="loading-overlay hidden">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-white text-lg font-bold mb-2">جاري التحميل...</p>
            <p id="loadingStatus" class="text-blue-300 text-sm animate-pulse">يرجى الانتظار</p>
        </div>
    </div>

    <!-- نافذة الإعلان الهام المنبثقة -->
    <div id="announcementModal" class="fixed inset-0 z-[10000] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-slate-900 border border-red-500/30 rounded-3xl shadow-[0_0_50px_rgba(239,68,68,0.2)] max-w-lg w-full transform scale-95 transition-transform duration-300 overflow-hidden">
            <div class="bg-gradient-to-r from-red-600 to-red-800 px-6 py-4 flex items-center gap-3">
                <span class="text-2xl">📢</span>
                <h2 id="announcementModalTitle" class="text-xl font-bold text-white">إعلان</h2>
            </div>
            <div class="p-8">
                <div id="announcementModalText" class="text-lg text-slate-200 leading-relaxed text-center whitespace-pre-wrap break-words"></div>
                <div class="mt-8 flex justify-center">
                    <button id="announcementModalClose" onclick="closeAnnouncementModal()" class="bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white font-bold py-3 px-12 rounded-2xl transition-all duration-300 transform active:scale-95 shadow-lg shadow-red-500/25">
                        حسناً
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- صفحة تسجيل الدخول -->
    <div id="loginPage" class="hidden min-h-screen flex items-center justify-center px-4 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 via-gray-900 to-black relative overflow-hidden">
        <!-- عناصر ديكور خلفية -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
            <div class="absolute -top-[10%] -left-[10%] w-[40%] h-[40%] bg-blue-600/20 blur-[120px] rounded-full animate-pulse"></div>
            <div class="absolute -bottom-[10%] -right-[10%] w-[40%] h-[40%] bg-purple-600/20 blur-[120px] rounded-full animate-pulse" style="animation-delay: 2s;"></div>
        </div>

        <div class="bg-gray-900/40 backdrop-blur-xl rounded-[2.5rem] p-8 max-w-md w-full border border-white/10 shadow-[0_20px_50px_rgba(0,0,0,0.5)] transform transition-all duration-500 hover:shadow-blue-500/10">
            <div class="text-center mb-10">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-tr from-blue-600 to-purple-600 rounded-3xl shadow-lg shadow-blue-500/30 mb-6 rotate-3 hover:rotate-0 transition-transform duration-300">
                    <span class="text-4xl">💬</span>
                </div>
                <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400 mb-2 tracking-tight">WalChat</h1>
                <p class="text-slate-400 font-medium">مرحباً بك في مجتمعك العربي الآمن</p>
            </div>

            <!-- أزرار التبديل -->
            <div class="flex bg-black/40 backdrop-blur-md rounded-2xl p-1.5 mb-8 border border-white/5">
                <button id="loginTab" class="tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 bg-gradient-to-r from-blue-600 to-blue-500 text-white shadow-lg">
                    تسجيل دخول
                </button>
                <button id="registerTab" class="tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white">
                    إنشاء حساب
                </button>
                <button id="guestTab" class="tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white">
                    دخول زائر
                </button>
            </div>

            <!-- نموذج تسجيل الدخول -->
            <form id="loginForm" class="form-container space-y-5">
                <div class="group">
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1 transition-colors group-focus-within:text-blue-400">اسم المستخدم</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        </span>
                        <input type="text" id="loginUsername" placeholder="أدخل اسمك هنا" required 
                            class="w-full bg-white/5 border border-white/10 rounded-2xl pl-12 pr-4 py-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:bg-white/10 transition-all duration-300">
                    </div>
                </div>

                <div class="group">
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1 transition-colors group-focus-within:text-blue-400">كلمة السر</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        </span>
                        <input type="password" id="loginPassword" placeholder="••••••••" required 
                            class="w-full bg-white/5 border border-white/10 rounded-2xl pl-12 pr-4 py-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:bg-white/10 transition-all duration-300">
                    </div>
                </div>

                <div class="flex items-center justify-between px-1">
                    <label class="flex items-center cursor-pointer group">
                        <input type="checkbox" id="rememberMe" class="hidden">
                        <div class="w-5 h-5 border-2 border-white/20 rounded-md mr-3 flex items-center justify-center group-hover:border-blue-500 transition-all duration-200" id="rememberMeCustom">
                            <div class="w-2.5 h-2.5 bg-blue-500 rounded-sm scale-0 transition-transform duration-200"></div>
                        </div>
                        <span class="text-slate-400 text-sm font-medium select-none">تذكرني</span>
                    </label>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-black py-4 px-4 rounded-2xl transition-all duration-300 transform active:scale-[0.98] shadow-lg shadow-blue-500/25">
                    دخول آمن
                </button>
            </form>

            <!-- نموذج إنشاء حساب -->
            <form id="registerForm" class="form-container hidden space-y-5">
                <div class="group">
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1 group-focus-within:text-green-400">اسم المستخدم</label>
                    <input type="text" id="registerUsername" placeholder="اختر اسمك المستعار" required 
                        class="w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:bg-white/10 transition-all duration-300">
                </div>

                <div class="group">
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1 group-focus-within:text-green-400">كلمة السر</label>
                    <input type="password" id="registerPassword" placeholder="اختر كلمة سر قوية" required 
                        class="w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500/50 focus:bg-white/10 transition-all duration-300">
                </div>

                <div class="group">
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1 group-focus-within:text-green-400">الجنس</label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="relative flex items-center justify-center bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl p-4 cursor-pointer transition-all duration-300 group/item overflow-hidden">
                            <input type="radio" name="gender" value="male" required class="absolute inset-0 opacity-0 cursor-pointer z-10 peer">
                            <div class="absolute inset-0 bg-blue-600/20 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                            <span class="text-white relative z-20 font-bold peer-checked:text-blue-400">👨 ذكر</span>
                        </label>
                        <label class="relative flex items-center justify-center bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl p-4 cursor-pointer transition-all duration-300 group/item overflow-hidden">
                            <input type="radio" name="gender" value="female" required class="absolute inset-0 opacity-0 cursor-pointer z-10 peer">
                            <div class="absolute inset-0 bg-pink-600/20 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                            <span class="text-white relative z-20 font-bold peer-checked:text-pink-400">👩 أنثى</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-emerald-500 hover:from-green-500 hover:to-emerald-400 text-white font-black py-4 px-4 rounded-2xl transition-all duration-300 transform active:scale-[0.98] shadow-lg shadow-green-500/25">
                    إنشاء الحساب
                </button>
            </form>

            <!-- نموذج دخول زائر -->
            <form id="guestForm" class="form-container hidden space-y-5">
                <div class="group">
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1 group-focus-within:text-purple-400">اسم الزائر</label>
                    <input type="text" id="guestUsername" placeholder="كيف تود أن نناديك؟" required 
                        class="w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:bg-white/10 transition-all duration-300">
                </div>

                <div class="group">
                    <label class="block text-slate-400 text-xs font-bold uppercase tracking-wider mb-2 ml-1 group-focus-within:text-purple-400">الجنس</label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="relative flex items-center justify-center bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl p-4 cursor-pointer transition-all duration-300 group/item overflow-hidden">
                            <input type="radio" name="guestGender" value="male" required class="absolute inset-0 opacity-0 cursor-pointer z-10 peer">
                            <div class="absolute inset-0 bg-blue-600/20 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                            <span class="text-white relative z-20 font-bold peer-checked:text-blue-400">👨 ذكر</span>
                        </label>
                        <label class="relative flex items-center justify-center bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl p-4 cursor-pointer transition-all duration-300 group/item overflow-hidden">
                            <input type="radio" name="guestGender" value="female" required class="absolute inset-0 opacity-0 cursor-pointer z-10 peer">
                            <div class="absolute inset-0 bg-pink-600/20 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                            <span class="text-white relative z-20 font-bold peer-checked:text-pink-400">👩 أنثى</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-indigo-500 hover:from-purple-500 hover:to-indigo-400 text-white font-black py-4 px-4 rounded-2xl transition-all duration-300 transform active:scale-[0.98] shadow-lg shadow-purple-500/25">
                    دخول سريع
                </button>
            </form>

            <div class="mt-8 text-center">
                <div class="flex items-center justify-center space-x-2 space-x-reverse text-xs text-slate-500">
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                    <span>${onlineUsersCount.textContent || '0'} مستخدم متصل الآن</span>
                </div>
            </div>
        </div>
    </div>

    <!-- الصفحة الرئيسية -->
    <div id="mainPage" class="hidden min-h-screen">
        <!-- رأس الصفحة الرئيسية -->
        <header class="bg-gray-900/80 backdrop-blur-lg border-b border-gray-700 p-4 flex justify-between items-center">
            <div></div> <!-- عنصر فارغ للمساحة اليسرى -->
            <h1 id="welcomeMessage" class="text-2xl font-bold text-white">🏠 غرف المحادثة</h1>
<!-- زر المنشورات في الصفحة الرئيسية - سيتم إخفاؤه -->
<div class="relative hidden">
    <button id="postsButton" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors relative">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <span id="postsBadge" class="notification-badge hidden">0</span>
    </button>
</div>

                <div class="flex items-center space-x-4 space-x-reverse">
<button onclick="openDrawingBoard()" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors" title="لوحة الرسم">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
    </svg>
</button>
                <!-- زر الإشعارات والرسائل - سيتم إخفاؤه -->
                <div class="relative hidden">
    <button id="messagesButton" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors relative">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
        </svg>
        <span id="messagesBadge" class="notification-badge hidden">0</span>
        <!-- القائمة المنبثقة للإشعارات -->
        <div id="notificationsDropdown" class="hidden absolute top-full left-0 mt-2 w-72 bg-slate-800 rounded-lg shadow-lg border border-slate-700 z-50">
            <div class="p-3 border-b border-slate-700">
                <h3 class="text-white font-semibold">الإشعارات</h3>
            </div>
            <div id="notificationsList" class="p-2 max-h-80 overflow-y-auto custom-scrollbar">
                <!-- الإشعارات ستظهر هنا -->
            </div>
        </div>
    </button>
</div>
                
                <!-- زر قائمة الأصدقاء - سيتم إخفاؤه -->
                <button id="friendsButton" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                </button>
                
                <!-- زر الملف الشخصي -->
                <button id="profileButton" class="user-profile-btn flex items-center space-x-2 space-x-reverse bg-gray-800 hover:bg-gray-700 rounded-full pl-3 pr-2 py-1 transition-colors">
                    <span class="text-white text-sm font-medium" id="headerUsername"></span>
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white">
                        <span id="headerAvatarInitial"></span>
                    </div>
                </button>
                
                <!-- زر الخروج -->
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-full font-semibold transition-colors flex items-center space-x-2 space-x-reverse text-sm">
                    <span>خروج</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 01-3-3h4a3 3 0 013 3v1"></path>
                    </svg>
                </button>
            </div>
        </header>
       
        <div class="container mx-auto px-4 py-8">
            <div class="text-center mb-12">
                <p class="text-xl text-slate-300">اختر غرفة المحادثة التي تريد الانضمام إليها</p>
            </div>
           
            <div id="roomsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 max-w-7xl mx-auto">
                <!-- الغرف سيتم تحميلها ديناميكياً -->
            </div>
        </div>
    </div>

    <!-- صفحة المحادثة -->
    <div id="chatPage" class="hidden h-full w-full flex flex-col overflow-hidden fixed inset-0">
        <!-- القائمة الجانبية اليسرى -->
        <div id="leftSidebar" class="fixed top-0 left-0 h-full w-72 bg-gray-900/95 backdrop-blur-xl border-r border-gray-700 transform -translate-x-full transition-transform duration-300 z-[60] flex flex-col shadow-2xl">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800/50">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <span>☰</span> القائمة
                </h3>
                <button onclick="toggleLeftSidebar()" class="text-slate-400 hover:text-white p-1 rounded-lg hover:bg-white/10 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-3 space-y-2 overflow-y-auto custom-scrollbar flex-1">
                <!-- أزرار القائمة المنقولة -->
                <button id="adminControlRoomBtn" onclick="openControlPanel(); toggleLeftSidebar();" class="hidden w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-blue-600/20 hover:text-blue-400 transition-all group">
                    <div class="bg-gray-800 p-2 rounded-lg text-blue-500 group-hover:bg-blue-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div>
                    <span class="font-bold">غرفة التحكم</span>
                </button>
                
                <button onclick="openDailyCenter(); toggleLeftSidebar();" class="w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-yellow-600/20 hover:text-yellow-400 transition-all group">
                    <div class="bg-gray-800 p-2 rounded-lg text-yellow-500 group-hover:bg-yellow-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                    <span class="font-bold">المركز اليومي</span>
                </button>

                <button onclick="openSnakeGame(); toggleLeftSidebar();" class="w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-green-600/20 hover:text-green-400 transition-all group">
                    <div class="bg-gray-800 p-2 rounded-lg text-green-500 group-hover:bg-green-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                    <span class="font-bold">لعبة الثعبان</span>
                </button>

                <button onclick="startHideAndSeekGame(); toggleLeftSidebar();" class="w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-indigo-600/20 hover:text-indigo-400 transition-all group">
                    <div class="bg-gray-800 p-2 rounded-lg text-indigo-500 group-hover:bg-indigo-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></div>
                    <span class="font-bold">لعبة الاختباء 🕵️‍♂️</span>
                </button>

                <button onclick="openSnakeLeaderboard(); toggleLeftSidebar();" class="w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-yellow-600/20 hover:text-yellow-400 transition-all group">
                    <div class="bg-gray-800 p-2 rounded-lg text-yellow-500 group-hover:bg-yellow-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg></div>
                    <span class="font-bold">ملوك الثعبان 🐍</span>
                </button>

                <button id="shopButton" onclick="openShopModal(); toggleLeftSidebar();" class="w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-purple-600/20 hover:text-purple-400 transition-all group relative">
                    <div class="bg-gray-800 p-2 rounded-lg text-purple-500 group-hover:bg-purple-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
                    <span class="font-bold">المتجر</span>
                </button>

                <button onclick="openDrawingBoard(); toggleLeftSidebar();" class="w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-pink-600/20 hover:text-pink-400 transition-all group relative">
                    <div class="bg-gray-800 p-2 rounded-lg text-pink-500 group-hover:bg-pink-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path></svg></div>
                    <span class="font-bold">لوحة الرسم</span>
                    <span id="drawingNotificationDot" class="notification-dot hidden"></span>
                </button>

                <button id="chatPostsButton" onclick="openPostsSidebar(); toggleLeftSidebar();" class="w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-indigo-600/20 hover:text-indigo-400 transition-all group relative">
                    <div class="bg-gray-800 p-2 rounded-lg text-indigo-500 group-hover:bg-indigo-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div>
                    <span class="font-bold">المنشورات</span>
                    <span id="postsNotificationDot" class="notification-dot hidden"></span>
                </button>

                <button id="topUsersButton" onclick="openTopUsersModal(); toggleLeftSidebar();" class="w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-orange-600/20 hover:text-orange-400 transition-all group relative">
                    <div class="bg-gray-800 p-2 rounded-lg text-orange-500 group-hover:bg-orange-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14v6m-3-3h6M6 10h2a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10 0h2a2 2 0 002-2V6a2 2 0 00-2-2h-2a2 2 0 00-2 2v2a2 2 0 002 2zM6 20h2a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2z"></path></svg></div>
                    <span class="font-bold">المتفاعلين</span>
                </button>

                <button onclick="openXPLeaderboard(); toggleLeftSidebar();" class="w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-cyan-600/20 hover:text-cyan-400 transition-all group relative">
                    <div class="bg-gray-800 p-2 rounded-lg text-cyan-500 group-hover:bg-cyan-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg></div>
                    <span class="font-bold">لوحة الشرف</span>
                </button>

                <button onclick="openOldestUsersLeaderboard(); toggleLeftSidebar();" class="w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-amber-600/20 hover:text-amber-400 transition-all group relative">
                    <div class="bg-gray-800 p-2 rounded-lg text-amber-500 group-hover:bg-amber-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                    <span class="font-bold">المستخدمين القدامى</span>
                </button>

                <button onclick="openInteractionLeaderboard(); toggleLeftSidebar();" class="w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-rose-600/20 hover:text-rose-400 transition-all group relative">
                    <div class="bg-gray-800 p-2 rounded-lg text-rose-500 group-hover:bg-rose-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
                    <span class="font-bold">لوحة المشاركين</span>
                </button>

                <button id="chatFriendsButton" onclick="openFriendsSidebar(); toggleLeftSidebar();" class="w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-green-600/20 hover:text-green-400 transition-all group relative">
                    <div class="bg-gray-800 p-2 rounded-lg text-green-500 group-hover:bg-green-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
                    <span class="font-bold">الأصدقاء</span>
                    <span id="friendsNotificationDot" class="notification-dot hidden"></span>
                </button>

                <button id="roomInfoButton" onclick="openRoomInfo(); toggleLeftSidebar();" class="w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-teal-600/20 hover:text-teal-400 transition-all group relative">
                    <div class="bg-gray-800 p-2 rounded-lg text-teal-500 group-hover:bg-teal-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                    <span class="font-bold">معلومات الغرفة</span>
                </button>

                <a href="https://xo-game-6m3e.onrender.com/" target="_blank" class="w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-red-600/20 hover:text-red-400 transition-all group">
                    <div class="bg-gray-800 p-2 rounded-lg text-red-500 group-hover:bg-red-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                    <span class="font-bold">لعبة XO</span>
                </a>

                <a href="https://www.instagram.com/walchat_officiel/" target="_blank" class="w-full flex items-center space-x-3 space-x-reverse text-slate-200 p-3 rounded-xl hover:bg-pink-600/20 hover:text-pink-400 transition-all group">
                    <div class="bg-gray-800 p-2 rounded-lg text-pink-500 group-hover:bg-pink-500 group-hover:text-white transition-colors"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.069-4.85.069-3.204 0-3.584-.012-4.849-.069-3.225-.149-4.771-1.664-4.919-4.919-.058-1.265-.07-1.644-.069-4.849 0-3.204.013-3.583.069-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg></div>
                    <span class="font-bold">للتواصل معنا</span>
                </a>
            </div>
        </div>
        <div id="leftSidebarOverlay" class="fixed inset-0 bg-black/50 z-[55] hidden backdrop-blur-sm" onclick="toggleLeftSidebar()"></div>

        <!-- رأس المحادثة -->
        <div class="bg-gray-900/90 backdrop-blur-lg border-b border-gray-700 py-2 px-4 relative z-30 md:z-40 chat-header-mobile">
            <div class="w-full flex items-center justify-between flex-wrap md:flex-nowrap">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <button onclick="goBack()" class="text-slate-300 hover:text-blue-500 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </button>
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <div id="chatIcon" class="text-3xl"></div>
                        <div>
                            <h2 id="chatTitle" class="text-xl font-semibold text-white"></h2>
                            <p class="text-sm text-slate-400">متصل الآن</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2 space-x-reverse mt-2 md:mt-0 chat-header-buttons">
                    <button id="toggleUsersButton" class="md:hidden text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </button>
                    <!-- زر الإشعارات (الجرس) -->
    <div class="relative" id="chatNotificationsButtonContainer">
        <button id="chatNotificationsButton" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors relative">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
            </svg>
            <span id="chatNotificationsBadge" class="notification-badge hidden"></span>
        </button>
        <div id="chatNotificationsDropdown" class="hidden absolute top-full left-0 mt-2 w-72 bg-slate-800 rounded-lg shadow-lg border border-slate-700 z-50">
            <div class="p-3 border-b border-slate-700">
                <h3 class="text-white font-semibold">الإشعارات</h3>
            </div>
            <div id="chatNotificationsList" class="p-2 max-h-80 overflow-y-auto custom-scrollbar">
                <!-- إشعارات المنشورات ستظهر هنا -->
            </div>
        </div>
    </div>
                    <!-- زر الرسائل الخاصة (البريد) -->
    <div class="relative" id="chatMessagesButtonContainer">
        <button id="chatMessagesButton" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors relative">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            <span id="messagesNotificationDot" class="notification-dot hidden" style="top: -2px; right: -2px;"></span>
            <span id="chatMessagesBadge" class="notification-badge hidden"></span>
        </button>
        <div id="privateConversationsDropdown" class="hidden absolute top-full left-0 mt-2 w-72 bg-slate-800 rounded-lg shadow-lg border border-slate-700 z-50">
            <div class="p-3 border-b border-slate-700">
                <h3 class="text-white font-semibold">المحادثات الخاصة</h3>
            </div>
            <div id="privateConversationsList" class="p-2 max-h-80 overflow-y-auto custom-scrollbar">
                <!-- المحادثات الخاصة ستظهر هنا -->
            </div>
        </div>
    </div>
                    <!-- زر القائمة الجانبية (جديد) -->
                    <button onclick="toggleLeftSidebar()" class="text-slate-300 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors relative" title="القائمة">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        <span id="masterNotificationDot" class="notification-dot hidden"></span>
                    </button>
</div>
            </div>
        </div>

        <!-- المحتوى الرئيسي -->
        <div class="flex-1 flex overflow-hidden relative">
            <!-- قائمة المستخدمين المتصلين (للشاشات الكبيرة) -->
            <div id="onlineUsersPanel" class="hidden md:block w-72 flex-shrink-0 bg-gray-800/70 backdrop-blur-lg border-l border-gray-700 p-4 users-container custom-scrollbar z-20">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-white font-bold flex items-center space-x-2 space-x-reverse">
                        <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                        <span>المستخدمون المتصلون</span>
                        <span id="onlineUsersCount" class="bg-blue-600 text-white text-xs px-2 py-1 rounded-full">0</span>
                    </h3>
                    <button onclick="toggleUsersList()" class="md:hidden text-slate-400 hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
        
                <div id="onlineUsersList" class="space-y-3">
                    <!-- المستخدمون المتصلون سيتم تحميلهم ديناميكياً -->
                </div>
            </div>

            <!-- منطقة الدردشة (الرسائل + الإدخال) -->
            <div class="flex-1 flex flex-col overflow-hidden min-w-0 bg-black/20">
                <!-- منطقة الرسائل -->
                <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar w-full">
                    <!-- الرسائل ستظهر هنا -->
                </div>

                <!-- منطقة إرسال الرسائل -->
                <div id="messageArea" class="bg-gray-900/95 backdrop-blur-xl border-t border-gray-700 p-2 shrink-0 w-full z-10">
                    <div class="w-full">
                        <!-- لوحة إدارة الرتب -->
                        <div id="rankManagementPanel" class="hidden mb-4 bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-xl p-4 border border-purple-500/50">
                    <h3 class="text-white font-bold mb-3 flex items-center space-x-2 space-x-reverse">
                        <span>👑</span>
                        <span>إدارة الرتب</span>
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-white text-sm font-semibold mb-2">اسم المستخدم</label>
                            <input 
                                type="text"
                                id="rankUserName"
                                placeholder="أدخل اسم المستخدم..."
                                class="w-full bg-gray-700 border border-purple-300/50 rounded-lg px-4 py-2 text-white placeholder-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                            >
                        </div>
                        <div>
                            <label class="block text-white text-sm font-semibold mb-2">الرتبة الجديدة</label>
                            <select 
                                id="rankSelect"
                                class="w-full bg-gray-700 border border-purple-300/50 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-400"
                            >
                                <option value="" class="bg-gray-900">اختر الرتبة...</option>
                                <option value="جيد" class="bg-gray-900">❇️ جيد</option>
                                <option value="بريميوم" class="bg-gray-900">💎 بريميوم</option>
                                <option value="ادمن" class="bg-gray-900">🛡️ ادمن</option>
                                <option value="سوبر ادمن" class="bg-gray-900">⭐ سوبر ادمن</option>
                                <option value="منشئ" class="bg-gray-900">👑 منشئ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex space-x-4 space-x-reverse">
                        <button 
                            onclick="assignRank()"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                        >
                            <span>منح الرتبة</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                        <button 
                            onclick="removeRank()"
                            class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                        >
                            <span>إزالة الرتبة</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                            </svg>
                        </button>
                        <button
                            onclick="showAllRanks()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                        >
                            <span>عرض جميع الرتب</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                        <!-- لوحة إدارة المستخدمين -->
                        <div id="userManagementPanel" class="hidden mb-4 bg-gradient-to-r from-red-900/30 to-orange-900/30 rounded-xl p-4 border border-red-500/50">
                    <h3 class="text-white font-bold mb-3 flex items-center space-x-2 space-x-reverse">
                        <span>👑</span>
                        <span id="managementTitle">إدارة المستخدمين</span>
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-white text-sm font-semibold mb-2">اسم المستخدم</label>
                            <input 
                                type="text"
                                id="managedUserName"
                                placeholder="أدخل اسم المستخدم..."
                                class="w-full bg-gray-700 border border-red-300/50 rounded-lg px-4 py-2 text-white placeholder-red-300 focus:outline-none focus:ring-2 focus:ring-red-400"
                            >
                        </div>
                        <div>
                            <label class="block text-white text-sm font-semibold mb-2">الإجراء</label>
                            <select 
                                id="userActionSelect"
                                class="w-full bg-gray-700 border border-red-300/50 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-red-400"
                                onchange="toggleManagementFields()"
                            >
                                <option value="" class="bg-gray-900">اختر الإجراء...</option>
                                <option value="mute" class="bg-gray-900">🔇 كتم</option>
                                <option value="unmute" class="bg-gray-900">🔊 إزالة الكتم</option>
                                <option value="banFromRoom" class="bg-gray-900">🚫 حظر من الغرفة</option>
                                <option value="unbanFromRoom" class="bg-gray-900">✅ إزالة حظر الغرفة</option>
                                <option value="banFromSite" class="bg-gray-900">⛔ حظر من الموقع</option>
                                <option value="unbanFromSite" class="bg-gray-900">🌐 إزالة حظر الموقع</option>
                                <option value="deleteUser" class="bg-gray-900">🗑️ حذف المستخدم</option>
                                <option value="showStatus" class="bg-gray-900">📋 عرض الحالة</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="durationField" class="hidden mb-4">
                        <label class="block text-white text-sm font-semibold mb-2">مدة الكتم (دقائق)</label>
                        <input 
                            type="number"
                            id="muteDuration"
                            placeholder="المدة بالدقائق..."
                            min="1"
                            class="w-full bg-gray-700 border border-red-300/50 rounded-lg px-4 py-2 text-white placeholder-red-300 focus:outline-none focus:ring-2 focus:ring-red-400"
                        >
                    </div>
                    
                    <div id="reasonField" class="hidden mb-4">
                        <label class="block text-white text-sm font-semibold mb-2">سبب الحظر (اختياري)</label>
                        <input 
                            type="text"
                            id="banReason"
                            placeholder="أدخل سبب الحظر..."
                            class="w-full bg-gray-700 border border-red-300/50 rounded-lg px-4 py-2 text-white placeholder-red-300 focus:outline-none focus:ring-2 focus:ring-red-400"
                        >
                    </div>
                    
                    <div class="flex space-x-4 space-x-reverse">
                        <button 
                            onclick="manageUser()"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                        >
                            <span>تنفيذ</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </button>
                        <button 
                            onclick="clearManagementFields()"
                            class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                        >
                            <span>مسح الحقول</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"> 
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- حاوية إدخال الرسالة والرد -->
                <div class="relative">
                    <!-- نافذة الايموجيات المتحركة -->
                    <div id="emojiPicker" class="emoji-picker custom-scrollbar"></div>

                    <!-- منطقة عرض الرد -->
                    <div id="replyPreview" class="hidden mb-2 bg-gray-700 rounded-lg p-2 max-w-4xl mx-auto relative z-20">
                        <div class="flex justify-between items-center">
                            <div class="text-xs text-white overflow-hidden">
                                <div class="font-semibold">الرد على <span id="replyUsername"></span></div>
                                <p id="replyContent" class="truncate opacity-70"></p>
                            </div>
                            <button onclick="cancelReply()" class="text-white hover:text-red-400 p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div id="messageInputContainer" class="flex space-x-2 space-x-reverse relative z-10">
                        <input 
                        type="text"
                        id="messageInput"
                        placeholder="اكتب رسالتك هنا..."
                        class="flex-1 bg-gray-800 border border-gray-700 rounded-full px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-colors"
                        onkeypress="handleKeyPress(event)"
                        oninput="checkMessageLength()"
                        style="text-align: start; direction: rtl; padding-left: 20px; position: relative; z-index: 10;"
                                >                      
                        <button 
                            id="sendMessageButton"
                            onclick="sendMessage()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full font-semibold transition-colors flex items-center space-x-2 space-x-reverse disabled:bg-gray-500 disabled:cursor-not-allowed"
                        >
                            <span>إرسال</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            
            <!-- زر إخفاء/إظهار قائمة المتصلين للجوال -->
            <div id="usersOverlay" class="users-overlay" onclick="toggleUsersList()"></div>
            </div>
    </div>

    <!-- نافذة الملف الشخصي -->
    <div id="profileModal" class="profile-modal">
        <div id="profileContent" class="profile-content custom-scrollbar relative">
            <!-- رأس الملف الشخصي -->
            <div id="profileHeader" class="relative h-64 w-full bg-gray-800 border-b border-gray-700/50 overflow-hidden">
                 <!-- صورة الغلاف -->
                 <div class="absolute inset-0 z-0">
                    <img id="profileCoverDisplay" src="" class="w-full h-full object-cover hidden">
                 </div>

                 <button onclick="closeProfileModal()" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 transition-colors z-20 bg-black/20 rounded-full p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>

                <!-- حاوية المعلومات السفلية -->
                <div class="absolute bottom-0 right-0 w-full p-4 flex items-end space-x-4 space-x-reverse z-10">
                    <!-- الصورة الشخصية -->
                    <div class="relative group flex-shrink-0">
                        <div id="profileAvatarFrame" class="w-24 h-24 rounded-full relative">
                            <img id="profileAvatar" src="" class="w-full h-full rounded-full object-cover border-4 border-gray-800 shadow-xl transition-transform duration-300 group-hover:scale-105">
                        </div>
                        <!-- زر تغيير الصورة (يظهر فقط لصاحب الحساب) -->
                        <button id="changeProfilePicBtn" onclick="openImageUploadForProfile()" class="hidden absolute bottom-0 right-0 bg-blue-600 hover:bg-blue-700 text-white p-1.5 rounded-full shadow-lg transition-all duration-200 transform hover:scale-110 border-2 border-gray-800" title="تغيير الصورة">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </button>
                        <!-- زر حذف الصورة الشخصية -->
                        <button id="removeProfilePicBtn" onclick="removeProfilePic()" class="hidden absolute bottom-0 left-0 bg-red-600 hover:bg-red-700 text-white p-1.5 rounded-full shadow-lg transition-all duration-200 transform hover:scale-110 border-2 border-gray-800" title="حذف الصورة الشخصية">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        <!-- زر تغيير الغلاف (جديد) -->
                        <button id="changeCoverBtn" onclick="openCoverUpload()" class="hidden absolute top-0 right-0 -mt-1 -mr-1 bg-gray-800/80 hover:bg-gray-700 text-white p-1.5 rounded-full shadow-lg transition-all duration-200 border border-gray-600 z-20" title="تغيير الغلاف">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </button>
                        <!-- زر حذف الغلاف -->
                        <button id="removeCoverBtn" onclick="removeCover()" class="hidden absolute top-0 left-0 -mt-1 -ml-1 bg-red-600/80 hover:bg-red-700 text-white p-1.5 rounded-full shadow-lg transition-all duration-200 border border-gray-600 z-20" title="حذف الغلاف">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    <!-- المعلومات النصية -->
                    <div class="flex-1 mb-1 text-right">
                        <h2 id="profileUsername" class="text-2xl font-bold text-white tracking-wide drop-shadow-md"></h2>
                        <div class="flex items-center gap-2 mt-1">
                            <div id="profileRank" class="inline-block px-3 py-0.5 rounded-full text-xs font-semibold text-white shadow-sm"></div>
                            <div id="profileStatus" class="flex items-center space-x-1 space-x-reverse bg-gray-800/60 inline-flex px-2 py-0.5 rounded-full border border-gray-700/50 backdrop-blur-sm">
                                <span class="w-2 h-2 rounded-full"></span>
                                <span class="text-xs text-blue-200"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- قائمة الخيارات الإدارية (تم نقلها هنا لتظهر فوق المحتوى) -->
            <div id="profileMenuContainer" class="absolute top-4 left-4 z-20">
                <!-- سيتم ملء هذه القائمة ديناميكياً -->
            </div>

            <!-- أقسام الملف الشخصي -->
            <div class="flex border-b border-gray-700/50 px-2 justify-center flex-wrap">
                <button onclick="switchProfileTab(event, 'details')" class="profile-tab-btn active">تفاصيل</button>
                <button onclick="switchProfileTab(event, 'friends')" class="profile-tab-btn">الأصدقاء</button>
                <button onclick="switchProfileTab(event, 'achievements')" class="profile-tab-btn">🏅 الإنجازات</button>
                <button id="actionsTabButton" onclick="switchProfileTab(event, 'actions')" class="profile-tab-btn hidden">الأمر ⚡</button>
                <button id="featuresTabButton" onclick="switchProfileTab(event, 'features')" class="profile-tab-btn hidden">ميزات 🌟</button>
                <button id="optionsTabButton" onclick="switchProfileTab(event, 'options')" class="profile-tab-btn hidden">خيارات ⚙️</button>
                <button id="accountTabButton" onclick="switchProfileTab(event, 'account')" class="profile-tab-btn hidden">حول الحساب</button>
            </div>

            <div id="profileBody" class="p-6 bg-gray-900/50">
                <!-- قسم التفاصيل -->
                <div id="profileTab-details" class="profile-tab-content">
                    <!-- الجنس -->
                    <div class="bg-gray-800/50 rounded-xl p-3 mb-4 border border-gray-700/30 flex items-center justify-between">
                        <span class="text-slate-400 text-sm">الجنس</span>
                        <span id="profileGender" class="text-white font-medium text-sm"></span>
                    </div>

                    <!-- تاريخ الانضمام (جديد) -->
                    <div class="bg-gray-800/50 rounded-xl p-3 mb-2 border border-gray-700/30 flex items-center justify-between">
                        <span class="text-slate-400 text-sm">تاريخ الانضمام</span>
                        <span id="profileJoinDate" class="text-white font-medium text-sm" dir="ltr"></span>
                    </div>

                    <!-- انتهاء الرتبة (جديد) -->
                    <div id="profileRankExpiryContainer" class="bg-gray-800/50 rounded-xl p-3 mb-2 border border-gray-700/30 flex items-center justify-between hidden">
                        <span class="text-slate-400 text-sm">انتهاء الرتبة</span>
                        <span id="profileRankExpiryText" class="text-yellow-300 font-medium text-sm"></span>
                    </div>

                    <!-- مركز لوحة الشرف (جديد) -->
                    <div id="profileXpRankContainer" class="bg-gray-800/50 rounded-xl p-3 mb-4 border border-gray-700/30 flex items-center justify-between hidden">
                        <span class="text-slate-400 text-sm">مركز لوحة الشرف</span>
                        <span id="profileXpRankText" class="text-cyan-300 font-medium text-sm"></span>
                    </div>

                    <!-- مركز القدامى (جديد) -->
                    <div id="profileOldestRankContainer" class="bg-gray-800/50 rounded-xl p-3 mb-2 border border-gray-700/30 flex items-center justify-between hidden">
                        <span class="text-slate-400 text-sm">مركز القدامى</span>
                        <span id="profileOldestRankText" class="text-amber-300 font-medium text-sm"></span>
                    </div>

                    <!-- مركز المشاركين (جديد) -->
                    <div id="profileInteractionRankContainer" class="bg-gray-800/50 rounded-xl p-3 mb-4 border border-gray-700/30 flex items-center justify-between hidden">
                        <span class="text-slate-400 text-sm">مركز المشاركين</span>
                        <span id="profileInteractionRankText" class="text-rose-300 font-medium text-sm"></span>
                    </div>

                    <!-- النقاط والمستوى -->
                    <div class="grid grid-cols-3 gap-3 text-center">
                        <div class="bg-gray-800/80 rounded-xl p-4 border border-gray-700/50 hover:border-yellow-500/30 transition-colors group">
                            <div class="text-yellow-400 text-3xl mb-1 group-hover:scale-110 transition-transform duration-200">⭐</div>
                            <div class="text-white font-bold text-lg" id="profilePoints">0</div>
                            <div class="text-slate-400 text-xs font-medium">النقاط</div>
                        </div>
                        <div class="bg-gray-800/80 rounded-xl p-4 border border-gray-700/50 hover:border-green-500/30 transition-colors group">
                            <div class="text-green-400 text-3xl mb-1 group-hover:scale-110 transition-transform duration-200">📈</div>
                            <div class="text-white font-bold text-lg" id="profileLevel">1</div>
                            <div class="text-slate-400 text-xs font-medium">المستوى</div>
                        </div>
                        <div class="bg-gray-800/80 rounded-xl p-4 border border-gray-700/50 hover:border-cyan-500/30 transition-colors group">
                            <div class="text-cyan-400 text-3xl mb-1 group-hover:scale-110 transition-transform duration-200">⚡</div>
                            <div class="text-white font-bold text-lg" id="profileXP">0</div>
                            <div class="text-slate-400 text-xs font-medium">الخبرة (XP)</div>
                        </div>
                    </div>

                    <!-- إحصائيات التفاعل ونظام الدعوة -->
                    <div id="referralSection" class="mt-6 p-4 bg-gray-800/40 border border-gray-700/50 rounded-2xl">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">🔥</span>
                                <span class="text-sm font-bold text-slate-200">درجة التفاعل</span>
                            </div>
                            <div id="interactionScore" class="bg-orange-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg shadow-orange-500/20">0</div>
                        </div>
                        
                        <div id="referralLinkContainer" class="hidden">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 px-1">رابط الدعوة الخاص بك</label>
                            <div class="flex gap-2">
                                <input type="text" id="referralLinkInput" readonly class="flex-1 bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-xs text-blue-400 focus:outline-none focus:border-blue-500/50">
                                <button onclick="copyReferralLink()" class="bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 p-2 rounded-xl border border-blue-500/20 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                </button>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-2 px-1 text-center italic">شارك رابطك لرفع درجة تفاعلك عند تسجيل أعضاء جدد</p>
                        </div>
                    </div>

                    <div class="text-center pt-6" id="bioSection">
                        <h3 class="text-sm font-bold text-slate-300 mb-3 flex items-center justify-center gap-2">
                            <span>📝</span> معلوماتي
                        </h3>
                        <div id="bioContainer" class="relative text-slate-300 text-sm bg-gray-900/50 rounded-lg p-4 min-h-[120px] whitespace-pre-wrap border border-gray-700/50 w-full">
                            <p id="profileBio" class="text-center leading-relaxed"></p>
                            <textarea id="profileBioInput" class="hidden w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" placeholder="اكتب شيئاً عن نفسك..." oninput="updateBioCharCount()"></textarea>
                            <div id="bioCharCounter" class="hidden absolute bottom-2 left-3 text-xs text-gray-400">0 / 500</div>
                        </div>
                        <div id="editBioButtons" class="mt-3 space-x-2 space-x-reverse">
                            <button id="editBioButton" onclick="toggleBioEdit(true)" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-full text-sm font-semibold transition-colors">
                                تعديل
                            </button>
                            <button id="saveBioButton" onclick="saveBio()" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded-full text-sm font-semibold transition-colors">
                                حفظ
                            </button>
                            <button id="cancelBioButton" onclick="toggleBioEdit(false)" class="hidden bg-gray-600 hover:bg-gray-700 text-white px-4 py-1 rounded-full text-sm font-semibold transition-colors">
                                إلغاء
                            </button>
                        </div>
                    </div>
                </div>

                <!-- قسم الأمر (Actions) -->
                <div id="profileTab-actions" class="profile-tab-content hidden">
                    <div id="visitorActions" class="space-y-3 pt-2">
                        <button id="privateChatButton" onclick="startPrivateChat()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-900/20 transition-all duration-200 transform hover:-translate-y-0.5 flex items-center justify-center space-x-2 space-x-reverse">
                            <span>محادثة خاصة</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        </button>
                        <button id="addFriendButton" onclick="sendFriendRequest()" class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-green-900/20 transition-all duration-200 transform hover:-translate-y-0.5 flex items-center justify-center space-x-2 space-x-reverse">
                            <span>إضافة صديق</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                        </button>
                        <button id="sendPointsButton" onclick="sendPoints()" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-500 hover:to-purple-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-purple-900/20 transition-all duration-200 transform hover:-translate-y-0.5 flex items-center justify-center space-x-2 space-x-reverse">
                            <span>إرسال نقاط</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-1V4m0 2v1m0 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        </button>
                    </div>
                </div>

                <!-- قسم الأصدقاء (جديد) -->
                <div id="profileTab-friends" class="profile-tab-content hidden">
                    <div id="profileFriendsList" class="grid grid-cols-3 gap-3">
                        <!-- سيتم ملء الأصدقاء هنا -->
                    </div>
                </div>

                <!-- قسم الإنجازات (جديد) -->
                <div id="profileTab-achievements" class="profile-tab-content hidden">
                    <div class="mb-4">
                        <h3 class="text-sm font-bold text-slate-300 mb-4 flex items-center gap-2">
                            <span>🏆</span> الإنجازات والأوسمة
                        </h3>
                        <div id="profileAchievementsList" class="space-y-3">
                            <!-- سيتم ملء الإنجازات هنا -->
                        </div>
                    </div>
                </div>

                <!-- قسم الخيارات (جديد) -->
                <div id="profileTab-options" class="profile-tab-content hidden">
                    <div class="space-y-4">
                        <h3 class="text-sm font-bold text-slate-300 mb-4 flex items-center gap-2">
                            <span>🔊</span> إعدادات الأصوات
                        </h3>
                        
                        <div class="flex items-center justify-between bg-gray-800/50 p-3 rounded-lg border border-gray-700/30">
                            <span class="text-white text-sm">صوت المنشن (Mention)</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="setting-playMentionSound" class="sr-only peer" onchange="toggleSetting('playMentionSound')">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>

                        <div class="flex items-center justify-between bg-gray-800/50 p-3 rounded-lg border border-gray-700/30">
                            <span class="text-white text-sm">صوت دخول المستخدمين</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="setting-playEntrySound" class="sr-only peer" onchange="toggleSetting('playEntrySound')">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>

                        <div class="flex items-center justify-between bg-gray-800/50 p-3 rounded-lg border border-gray-700/30">
                            <span class="text-white text-sm">صوت خروج المستخدمين</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="setting-playExitSound" class="sr-only peer" onchange="toggleSetting('playExitSound')">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- قسم الميزات (للرتب العالية) -->
                <div id="profileTab-features" class="profile-tab-content hidden space-y-6">
                    <!-- تبويبات فرعية للميزات -->
                    <div class="flex justify-center space-x-1 space-x-reverse bg-gray-800/50 p-1 rounded-lg mb-4">
                        <button onclick="switchFeatureSubTab('nameColor')" class="feature-sub-btn flex-1 py-1 px-2 rounded text-xs font-semibold bg-blue-600 text-white" id="btn-nameColor">لون الاسم</button>
                        <button onclick="switchFeatureSubTab('nameBackground')" class="feature-sub-btn flex-1 py-1 px-2 rounded text-xs font-semibold text-slate-400 hover:bg-gray-700" id="btn-nameBackground">خلفية الاسم</button>
                        <button onclick="switchFeatureSubTab('avatarFrame')" class="feature-sub-btn flex-1 py-1 px-2 rounded text-xs font-semibold text-slate-400 hover:bg-gray-700" id="btn-avatarFrame">إطار الصورة</button>
                        <button onclick="switchFeatureSubTab('userCardBackground')" class="feature-sub-btn flex-1 py-1 px-2 rounded text-xs font-semibold text-slate-400 hover:bg-gray-700" id="btn-userCardBackground">خلفية البطاقة</button>
                         <button onclick="switchFeatureSubTab('profileBackground')" class="feature-sub-btn flex-1 py-1 px-2 rounded text-xs font-semibold text-slate-400 hover:bg-gray-700" id="btn-profileBackground">لون البروفايل</button>
                        <button onclick="switchFeatureSubTab('nameCardBorder')" class="feature-sub-btn flex-1 py-1 px-2 rounded text-xs font-semibold text-slate-400 hover:bg-gray-700" id="btn-nameCardBorder">إطار البطاقة</button>
                        <button onclick="switchFeatureSubTab('nameFont')" class="feature-sub-btn flex-1 py-1 px-2 rounded text-xs font-semibold text-slate-400 hover:bg-gray-700" id="btn-nameFont">نوع الخط</button>
                        <button onclick="switchFeatureSubTab('changeName')" class="feature-sub-btn flex-1 py-1 px-2 rounded text-xs font-semibold text-slate-400 hover:bg-gray-700" id="btn-changeName">تغيير الاسم</button>
                    </div>

                    <!-- محتوى لون الاسم -->
                    <div id="feature-nameColor" class="feature-content">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">اختر لون لاسمك:</h4>
                        <div class="grid grid-cols-6 gap-3 justify-items-center mb-4" id="nameColorGrid">
                            <!-- سيتم ملؤها بواسطة JS -->
                        </div>
                        <div class="border-t border-gray-700 pt-3">
                            <h4 class="text-xs font-bold text-slate-400 mb-2">تدرج لوني أو لون مخصص:</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="selectFeature('nameColor', 'text-gradient-rainbow')" class="py-1 px-2 rounded bg-gradient-to-r from-red-500 via-green-500 to-blue-500 text-white text-[10px] font-bold">قوس قزح</button>
                                <button onclick="selectFeature('nameColor', 'text-gradient-gold')" class="py-1 px-2 rounded bg-gradient-to-r from-yellow-600 to-yellow-200 text-black text-[10px] font-bold">ذهبي ملكي</button>
                                <button onclick="selectFeature('nameColor', 'text-gradient-fire')" class="py-1 px-2 rounded bg-gradient-to-r from-red-600 to-orange-400 text-white text-[10px] font-bold">ناري</button>
                                <button onclick="selectFeature('nameColor', 'text-gradient-ocean')" class="py-1 px-2 rounded bg-gradient-to-r from-blue-400 to-cyan-300 text-white text-[10px] font-bold">محيط</button>
                                <button onclick="selectFeature('nameColor', 'text-sparkle-gold')" class="py-1 px-2 rounded text-sparkle-gold text-[10px] font-bold bg-black/40">بريق ذهبي ✨</button>
                                <button onclick="selectFeature('nameColor', 'text-sparkle-rainbow')" class="py-1 px-2 rounded text-sparkle-rainbow text-[10px] font-bold bg-black/40">بريق قوس قزح 🌈</button>
                                <button onclick="selectFeature('nameColor', 'text-sparkle-blue')" class="py-1 px-2 rounded text-sparkle-blue text-[10px] font-bold bg-black/40">بريق أزرق 💎</button>
                                <button onclick="selectFeature('nameColor', 'text-sparkle-pink')" class="py-1 px-2 rounded text-sparkle-pink text-[10px] font-bold bg-black/40">بريق وردي ✨</button>
                                <button onclick="selectFeature('nameColor', 'text-neon-pulse')" class="py-1 px-2 rounded text-neon-pulse text-[10px] font-bold bg-black/40">نيون نابض 🔋</button>
                                <button onclick="selectFeature('nameColor', 'text-fire-wave')" class="py-1 px-2 rounded text-fire-wave text-[10px] font-bold bg-black/40">موجة نارية 🔥</button>
                                <button onclick="selectFeature('nameColor', 'text-cosmic-galaxy')" class="py-1 px-2 rounded text-cosmic-galaxy text-[10px] font-bold bg-black/40">مجرة كونية 🌌</button>
                                <button onclick="selectFeature('nameColor', 'text-liquid-gold')" class="py-1 px-2 rounded text-liquid-gold text-[10px] font-bold bg-black/40">ذهب سائل 🔱</button>
                                <button onclick="selectFeature('nameColor', 'text-cyber-glitch')" class="py-1 px-2 rounded text-cyber-glitch text-[10px] font-bold bg-black/40">خلل سايبر 👾</button>
                                <button onclick="selectFeature('nameColor', 'text-inferno-blaze')" class="py-1 px-2 rounded text-inferno-blaze text-[10px] font-bold bg-black/40">جحيم مستعر 🌋</button>
                                <button onclick="selectFeature('nameColor', 'text-electric-storm')" class="py-1 px-2 rounded text-electric-storm text-[10px] font-bold bg-black/40">عاصفة كهربائية ⚡</button>
                                <button onclick="selectFeature('nameColor', 'text-diamond-prism')" class="py-1 px-2 rounded text-diamond-prism text-[10px] font-bold bg-black/40">منشور ماسي 💎</button>
                                <button onclick="selectFeature('nameColor', 'text-aurora')" class="py-1 px-2 rounded text-aurora text-[10px] font-bold bg-black/40">شفق قطبي 🌌</button>
                                <button onclick="selectFeature('nameColor', 'text-golden-glitch')" class="py-1 px-2 rounded text-golden-glitch text-[10px] font-bold bg-black/40">خلل ذهبي 🔱</button>
                                <button onclick="selectFeature('nameColor', 'text-plasma')" class="py-1 px-2 rounded text-plasma text-[10px] font-bold bg-black/40">بلازما ⚛️</button>
                                <button onclick="selectFeature('nameColor', 'text-crystal')" class="py-1 px-2 rounded text-crystal text-[10px] font-bold bg-black/40">كريستال ❄️</button>
                                <button onclick="selectFeature('nameColor', 'text-radioactive')" class="py-1 px-2 rounded text-radioactive text-[10px] font-bold bg-black/40">مشع ☢️</button>
                                <button onclick="selectFeature('nameColor', 'text-matrix-rain')" class="py-1 px-2 rounded text-matrix-rain text-[10px] font-bold bg-black/40">مصفوفة 📟</button>
                                <button onclick="selectFeature('nameColor', 'text-matrix-white')" class="py-1 px-2 rounded text-matrix-white text-[10px] font-bold bg-black/40">مصفوفة بيضاء 🌪️</button>
                                <button onclick="selectFeature('nameColor', 'text-nebula-dream')" class="py-1 px-2 rounded text-nebula-dream text-[10px] font-bold bg-black/40">سديم 🌌</button>
                                <button onclick="selectFeature('nameColor', 'text-volcanic-ash')" class="py-1 px-2 rounded text-volcanic-ash text-[10px] font-bold bg-black/40">رماد بركاني 🌋</button>
                                <button onclick="selectFeature('nameColor', 'text-holographic')" class="py-1 px-2 rounded text-holographic text-[10px] font-bold bg-black/40">هولوغرافي 💿</button>
                                <button onclick="selectFeature('nameColor', 'text-quantum-flux')" class="py-1 px-2 rounded text-quantum-flux text-[10px] font-bold bg-black/40">كمي ⚛️</button>
                                <button onclick="selectFeature('nameColor', 'text-starlight-shimmer')" class="py-1 px-2 rounded text-starlight-shimmer text-[10px] font-bold bg-black/40">نجوم ✨</button>
                                <button onclick="selectFeature('nameColor', 'text-midnight-aurora')" class="py-1 px-2 rounded text-midnight-aurora text-[10px] font-bold bg-black/40">شفق ليلي 🌃</button>
                                <button onclick="selectFeature('nameColor', 'text-crimson-night')" class="py-1 px-2 rounded text-crimson-night text-[10px] font-bold bg-black/40">قرمزي 🩸</button>
                                <button onclick="selectFeature('nameColor', 'text-solar-flare')" class="py-1 px-2 rounded text-solar-flare text-[10px] font-bold bg-black/40">وهج شمسي ☀️</button>
                                <button onclick="selectFeature('nameColor', 'text-void-walker')" class="py-1 px-2 rounded text-void-walker text-[10px] font-bold bg-black/40">فراغ 🌑</button>
                                <button onclick="selectFeature('nameColor', 'text-anim-neon-blue')" class="py-1 px-2 rounded text-anim-neon-blue text-[10px] font-bold bg-black/40">نيون أزرق متحرك 🌊</button>
                                <button onclick="selectFeature('nameColor', 'text-anim-golden-shower')" class="py-1 px-2 rounded text-anim-golden-shower text-[10px] font-bold bg-black/40">مطر ذهبي 🚿</button>
                                <button onclick="selectFeature('nameColor', 'text-anim-crimson-fire')" class="py-1 px-2 rounded text-anim-crimson-fire text-[10px] font-bold bg-black/40">نار قرمزية 🔥</button>
                                <button onclick="selectFeature('nameColor', 'text-anim-electric-purple')" class="py-1 px-2 rounded text-anim-electric-purple text-[10px] font-bold bg-black/40">كهرباء بنفسجية ⚡</button>
                                <button onclick="selectFeature('nameColor', 'text-anim-emerald-glitch')" class="py-1 px-2 rounded text-anim-emerald-glitch text-[10px] font-bold bg-black/40">زمرد سريع 💨</button>
                            </div>
                            <div class="mt-3 flex items-center justify-between bg-gray-800/50 p-2 rounded-lg">
                                <span class="text-[10px] text-slate-300">لون مخصص (مزج):</span>
                                <input type="color" id="customNameColorPicker" onchange="applyCustomColor('nameColor', this.value)" class="w-8 h-6 bg-transparent cursor-pointer">
                            </div>
                        </div>
                    </div>

                    <!-- محتوى خلفية الاسم -->
                    <div id="feature-nameBackground" class="feature-content hidden">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">اختر خلفية لاسمك (تظهر في الرسائل):</h4>
                        <div class="grid grid-cols-4 gap-3" id="nameBackgroundGrid">
                            <div onclick="selectFeature('nameBackground', null)" class="cursor-pointer p-2 rounded text-center border border-gray-600 hover:border-white text-xs">بدون خلفية</div>
                            <!-- سيتم ملؤها بواسطة JS -->
                        </div>
                        <div class="mt-4 p-3 bg-gray-800 rounded-lg text-center">
                            <p class="text-xs text-slate-400 mb-1">معاينة:</p>
                            <span id="nameBackgroundPreview" class="px-2 py-1 rounded">اسم المستخدم</span>
                        </div>
                    </div>

                    <!-- محتوى إطار الصورة -->
                    <div id="feature-avatarFrame" class="feature-content hidden">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">اختر إطاراً لصورتك:</h4>
                        <div class="grid grid-cols-4 gap-4 justify-items-center" id="avatarFrameGrid">
                            <!-- سيتم ملؤها بواسطة JS -->
                        </div>
                        <div class="mt-3 flex items-center justify-between bg-gray-800/50 p-2 rounded-lg">
                            <span class="text-[10px] text-slate-300">لون مخصص للإطار:</span>
                            <input type="color" id="customFrameColorPicker" onchange="applyCustomColor('avatarFrame', this.value)" class="w-8 h-6 bg-transparent cursor-pointer">
                        </div>
                    </div>

                    <!-- محتوى خلفية البطاقة (جديد) -->
                    <div id="feature-userCardBackground" class="feature-content hidden">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">اختر خلفية لبطاقتك في قائمة المتصلين:</h4>
                        <div class="grid grid-cols-3 gap-3" id="userCardBackgroundGrid">
                            <div onclick="selectFeature('userCardBackground', null)" class="cursor-pointer p-3 rounded-lg text-center border border-gray-600 hover:border-white text-xs bg-gray-800">افتراضي</div>
                            <!-- سيتم ملؤها بواسطة JS -->
                        </div>
                        <div class="mt-4 p-2 rounded-lg border border-gray-700" id="cardBackgroundPreview">
                            <p class="text-xs text-slate-400 mb-2">معاينة:</p>
                            <div class="flex items-center space-x-3 space-x-reverse p-2 rounded-lg" id="previewCardDiv"><div class="w-8 h-8 rounded-full bg-gray-500"></div><span class="text-white text-sm">اسم المستخدم</span></div>
                        </div>
                        <div class="mt-3 flex items-center justify-between bg-gray-800/50 p-2 rounded-lg">
                            <span class="text-[10px] text-slate-300">لون مخصص للبطاقة:</span>
                            <input type="color" id="customCardColorPicker" onchange="applyCustomColor('userCardBackground', this.value)" class="w-8 h-6 bg-transparent cursor-pointer">
                        </div>
                    </div>

                    <!-- محتوى لون البروفايل (جديد) -->
                    <div id="feature-profileBackground" class="feature-content hidden">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">اختر لوناً لملفك الشخصي:</h4>
                        <div class="grid grid-cols-3 gap-3" id="profileBackgroundGrid">
                            <div onclick="selectFeature('profileBackground', null)" class="cursor-pointer p-3 rounded-lg text-center border border-gray-600 hover:border-white text-xs bg-gray-800">افتراضي</div>
                            <!-- سيتم ملؤها بواسطة JS -->
                        </div>
                        <div class="mt-4 p-2 rounded-lg border border-gray-700">
                            <p class="text-xs text-slate-400 mb-2">معاينة:</p>
                            <div id="previewProfileDiv" class="p-4 rounded-lg text-center bg-gradient-to-b from-gray-800 to-gray-900">
                                <span class="text-white text-sm">ملف شخصي</span>
                            </div>
                        </div>
                        <div class="mt-3 flex items-center justify-between bg-gray-800/50 p-2 rounded-lg">
                            <span class="text-[10px] text-slate-300">لون مخصص للملف:</span>
                            <input type="color" id="customProfileColorPicker" onchange="applyCustomColor('profileBackground', this.value)" class="w-8 h-6 bg-transparent cursor-pointer">
                        </div>
                    </div>

                    <!-- محتوى إطار بطاقة الاسم (جديد) -->
                    <div id="feature-nameCardBorder" class="feature-content hidden">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">اختر لوناً لإطار البطاقة:</h4>
                        <p class="text-xs text-slate-400 mb-3">يمكنك اختيار لون الإطار من الإنجازات التي حققتها فقط</p>
                        <div class="grid grid-cols-4 gap-3" id="nameCardBorderGrid">
                            <!-- سيتم ملؤها بواسطة JS -->
                        </div>
                        <div class="mt-4 p-2 rounded-lg border border-gray-700" id="cardBorderPreview">
                            <p class="text-xs text-slate-400 mb-2">معاينة:</p>
                            <div class="flex items-center space-x-3 space-x-reverse p-3 rounded-lg" id="previewCardBorderDiv" style="border: 3px solid #6366f1;"><div class="w-8 h-8 rounded-full bg-gray-500"></div><span class="text-white text-sm">اسم المستخدم</span></div>
                        </div>
                    </div>

                    <!-- محتوى نوع الخط (جديد) -->
                    <div id="feature-nameFont" class="feature-content hidden">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">اختر نوع الخط لاسمك:</h4>
                        <div class="grid grid-cols-2 gap-3" id="nameFontGrid">
                            <!-- سيتم ملؤها بواسطة JS -->
                        </div>
                        <div class="mt-4 p-3 bg-gray-800 rounded-lg text-center">
                            <p class="text-xs text-slate-400 mb-1">معاينة:</p>
                            <span id="nameFontPreview" class="text-xl px-2 py-1 rounded">اسم المستخدم</span>
                        </div>
                    </div>

                    <!-- محتوى تغيير الاسم (جديد) -->
                    <div id="feature-changeName" class="feature-content hidden">
                        <h4 class="text-sm font-bold text-slate-300 mb-3">تغيير اسم المستخدم:</h4>
                        <p class="text-xs text-slate-400 mb-4">ملاحظة: سيتم تسجيل خروجك بعد تغيير الاسم. يجب أن يتكون الاسم من 3-15 حرف (أحرف إنجليزية، أرقام، ومسافات فقط).</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-slate-200 text-sm font-semibold mb-2">الاسم الجديد</label>
                                <input type="text" id="newUsernameInput" placeholder="أدخل الاسم الجديد..." 
                                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            </div>
                            <button onclick="requestUsernameChange()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                حفظ الاسم الجديد
                            </button>
                        </div>
                    </div>

                    <div class="mt-6 text-center">
                        <button onclick="saveSelectedFeature()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-2 rounded-full font-bold shadow-lg transition-transform transform hover:scale-105">
                            حفظ التغييرات
                        </button>
                    </div>
                </div>

                <!-- قسم حول الحساب -->
                <div id="profileTab-account" class="profile-tab-content hidden space-y-6">
                    <div id="accountActions">
                        <h3 class="text-lg font-bold text-red-400 mb-2">إجراءات خطيرة</h3>
                        <p class="text-sm text-slate-400 mb-4">هذه الإجراءات لا يمكن التراجع عنها. يرجى توخي الحذر.</p>
                        <button onclick="confirmDeleteAccount()" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            حذف حسابي نهائياً
                        </button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- نافذة المحادثة الخاصة -->
    <div id="privateChatModal" class="private-chat-modal">
        <div class="private-chat-header bg-slate-800 border-b border-white/10 px-4 py-3 flex items-center justify-between shadow-lg">
            <div class="flex items-center gap-3">
                <div class="relative cursor-pointer" onclick="showUserProfileModal(document.getElementById('privateChatUsername').textContent)">
                    <img id="privateChatAvatar" src="" class="w-10 h-10 rounded-full object-cover border-2 border-blue-500/20" onerror="this.src = '/my-avatar.png'">
                    <span id="privateChatStatusDot" class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-slate-800"></span>
                </div>
                <div class="cursor-pointer" onclick="showUserProfileModal(document.getElementById('privateChatUsername').textContent)">
                    <h3 id="privateChatUsername" class="text-white font-bold text-sm leading-tight"></h3>
                    <p id="privateChatStatus" class="text-[10px] text-slate-400 font-medium"></p>
                </div>
            </div>
            <button onclick="closePrivateChat()" class="text-slate-400 hover:text-white hover:bg-white/10 p-2 rounded-full transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div id="privateChatMessages" class="private-chat-messages custom-scrollbar">
            <!-- الرسائل الخاصة ستظهر هنا -->
        </div>
        
        <div class="private-chat-input bg-slate-800/50 p-3 relative">
            <div id="privateEmojiPicker" class="emoji-picker custom-scrollbar"></div>
            <div class="flex items-center gap-2">
                <input
                    type="text"
                    id="privateMessageInput"
                    placeholder="اكتب رسالتك الخاصة..."
                    class="flex-1 bg-slate-900/50 border border-white/10 rounded-full px-4 py-2 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-sm transition-all"
                    onkeypress="handlePrivateKeyPress(event)"
                >
                <button
                    onclick="sendPrivateMessage()"
                    class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full transition-all shadow-lg shadow-blue-900/20 active:scale-95"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- قائمة الأصدقاء -->
    <div id="friendsSidebar" class="friends-sidebar">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-white">👥 قائمة الأصدقاء</h2>
            <button onclick="closeFriendsSidebar()" class="text-slate-300 hover:text-blue-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- بحث عن مستخدمين -->
        <div class="mb-6">
            <div class="relative">
                <input
                    type="text"
                    id="userSearchInput"
                    placeholder="ابحث عن مستخدم..."
                    class="w-full bg-gray-700 border border-gray-600 rounded-full px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent text-sm"
                >
                <button onclick="searchUsers()" class="absolute left-2 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
            </div>
            <div id="searchResults" class="mt-3 hidden bg-white/10 rounded-lg p-3 max-h-40 overflow-y-auto">
                <!-- نتائج البحث ستظهر هنا -->
            </div>
        </div>
        
        <!-- طلبات الصداقة -->
        <div class="mb-6">
            <h3 class="text-white font-semibold mb-3 flex items-center space-x-2 space-x-reverse">
                <span>📩</span>
                <span>طلبات الصداقة</span>
                <span id="friendRequestsCount" class="bg-blue-600 text-white text-xs px-2 py-1 rounded-full">0</span>
            </h3>
            <div id="friendRequestsList" class="space-y-2">
                <!-- طلبات الصداقة ستظهر هنا -->
            </div>
        </div>
        
        <!-- قائمة الأصدقاء -->
        <div>
            <h3 class="text-white font-semibold mb-3 flex items-center space-x-2 space-x-reverse">
                <span>👥</span>
                <span>أصدقائي</span>
                <span id="friendsCount" class="bg-green-600 text-white text-xs px-2 py-1 rounded-full">0</span>
            </h3>
            <div id="friendsList" class="space-y-2">
                <!-- قائمة الأصدقاء ستظهر هنا -->
            </div>
        </div>
    </div>
    
    <div id="friendsOverlay" class="friends-overlay" onclick="closeFriendsSidebar()"></div>

    <!-- منطقة الإشعارات العامة -->
    <div id="globalNotifications" class="fixed top-4 right-4 z-50 space-y-3 max-w-sm"></div>
<!-- نافذة المنشورات -->
<div id="postsModal" class="profile-modal">
    <div class="profile-content custom-scrollbar" style="max-width: 650px; height: 95vh;">
        <!-- رأس النافذة -->
        <div class="flex justify-between items-center p-4 border-b border-slate-700 flex-shrink-0">
            <h2 class="text-xl font-bold text-white">📝 المنشورات</h2>
            <button onclick="closePostsSidebar()" class="text-slate-300 hover:text-blue-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- محتوى النافذة القابل للتمرير -->
        <div class="flex-1 p-4 overflow-y-auto custom-scrollbar">
            <!-- منطقة إنشاء منشور جديد -->
            <div class="mb-6 bg-gray-800 rounded-xl p-4 border border-gray-700">
                <h3 class="text-white font-semibold mb-3">إنشاء منشور جديد</h3>
                <textarea 
                    id="newPostContent" 
                    placeholder="بماذا تفكر...؟" 
                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm mb-3"
                    rows="3"
                ></textarea>
                <button 
                    onclick="createNewPost()" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors"
                >
                    نشر
                </button>
            </div>
            
            <!-- قائمة المنشورات -->
            <div id="postsList" class="space-y-4">
                <!-- المنشورات سيتم تحميلها هنا -->
            </div>
        </div>
    </div>
</div>

<!-- نافذة قائمة المتفاعلين -->
<div id="topUsersModal" class="profile-modal">
    <div class="profile-content custom-scrollbar">
        <!-- رأس النافذة -->
        <div class="relative bg-gray-800 p-6 text-center">
             <button onclick="closeTopUsersModal()" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">🏆 المتفاعلون</h2>
            <p class="text-slate-400 text-sm">أكثر 10 مستخدمين نشاطاً</p>
        </div>

        <!-- محتوى القائمة -->
        <div id="topUsersListContainer" class="flex-1 p-4 space-y-3 overflow-y-auto custom-scrollbar">
            <!-- سيتم ملء القائمة هنا -->
            <div class="text-center text-slate-400 p-8">
                <div class="spinner mx-auto"></div>
                <p class="mt-2">جاري تحميل القائمة...</p>
            </div>
        </div>
    </div>
</div>

<div id="topUsersOverlay" class="friends-overlay" onclick="closeTopUsersModal()"></div>

<!-- نافذة لوحة الشرف (XP Leaderboard) -->
<div id="xpLeaderboardModal" class="profile-modal">
    <div class="profile-content custom-scrollbar">
        <div class="relative bg-gray-800 p-6 text-center">
             <button onclick="closeXPLeaderboard()" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">⚡ لوحة الشرف</h2>
            <p class="text-slate-400 text-sm">أكثر المستخدمين خبرة (XP)</p>
        </div>
        <div id="xpLeaderboardList" class="flex-1 p-4 space-y-3 overflow-y-auto custom-scrollbar">
            <div class="text-center text-slate-400 p-8">
                <div class="spinner mx-auto"></div>
                <p class="mt-2">جاري تحميل القائمة...</p>
            </div>
        </div>
    </div>
</div>
<div id="xpLeaderboardOverlay" class="friends-overlay" onclick="closeXPLeaderboard()"></div>

<!-- نافذة لوحة المستخدمين القدامى -->
<div id="oldestUsersModal" class="profile-modal">
    <div class="profile-content custom-scrollbar">
        <div class="relative bg-gray-800 p-6 text-center">
             <button onclick="closeOldestUsersLeaderboard()" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">🕰️ المستخدمين القدامى</h2>
            <p class="text-slate-400 text-sm">أقدم الأعضاء انضماماً للموقع</p>
        </div>
        <div id="oldestUsersList" class="flex-1 p-4 space-y-3 overflow-y-auto custom-scrollbar">
            <div class="text-center text-slate-400 p-8">
                <div class="spinner mx-auto"></div>
                <p class="mt-2">جاري تحميل القائمة...</p>
            </div>
        </div>
    </div>
</div>
<div id="oldestUsersOverlay" class="friends-overlay" onclick="closeOldestUsersLeaderboard()"></div>

<!-- نافذة لوحة المشاركين (التفاعل) -->
<div id="interactionLeaderboardModal" class="profile-modal">
    <div class="profile-content custom-scrollbar">
        <div class="relative bg-gray-800 p-6 text-center">
             <button onclick="closeInteractionLeaderboard()" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">🔥 لوحة المشاركين</h2>
            <p class="text-slate-400 text-sm">الأكثر تفاعلاً ودعوة للأصدقاء</p>
        </div>
        <div id="interactionLeaderboardList" class="flex-1 p-4 space-y-3 overflow-y-auto custom-scrollbar">
            <div class="text-center text-slate-400 p-8">
                <div class="spinner mx-auto"></div>
                <p class="mt-2">جاري تحميل القائمة...</p>
            </div>
        </div>
    </div>
</div>
<div id="interactionLeaderboardOverlay" class="friends-overlay" onclick="closeInteractionLeaderboard()"></div>

<!-- نافذة المتجر -->
<div id="shopModal" class="profile-modal">
    <div class="profile-content custom-scrollbar" style="width: 95%; max-width: 500px;">
        <!-- رأس النافذة --> 
        <div class="relative bg-gray-800 p-6 text-center">
             <button onclick="closeShopModal()" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">🛒 المتجر</h2>
            <p class="text-slate-400 text-sm">استخدم نقاطك لشراء عناصر مميزة</p>
        </div>

        <!-- محتوى المتجر -->
        <div id="shopItemsContainer" class="flex-1 p-4 overflow-y-auto custom-scrollbar">
            <!-- سيتم ملء العناصر هنا بالشبكة الجديدة -->
            <div class="text-center text-slate-400 p-8">
                <div class="spinner mx-auto"></div>
                <p class="mt-2">جاري تحميل عناصر المتجر...</p>
            </div>
        </div>
    </div>
</div>
<div id="shopOverlay" class="friends-overlay" onclick="closeShopModal()"></div>

<style>
    #shopModal.show {
        opacity: 1;
        visibility: visible;
    }
    #shopModal.show .profile-content {
        transform: scale(1);
    }
    #shopOverlay.show {
        display: block;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
    }
</style>

<!-- نافذة إرسال النقاط -->
<div id="sendPointsModal" class="profile-modal">
    <div class="profile-content" style="width: 95%; max-width: 350px;">
        <!-- رأس النافذة -->
        <div class="relative bg-gray-800 p-6 text-center">
             <button onclick="closeSendPointsModal()" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">🎁 إرسال نقاط</h2>
            <p id="sendPointsToUser" class="text-slate-400 text-sm"></p>
        </div>

        <!-- محتوى النافذة -->
        <div class="flex-1 p-6 space-y-4">
            <div>
                <label for="pointsAmountInput" class="block text-slate-200 text-sm font-semibold mb-2">عدد النقاط</label>
                <input 
                    type="number"
                    id="pointsAmountInput"
                    placeholder="أدخل عدد النقاط (الحد الأقصى 10,000)..."
                    min="1"
                    max="10000"
                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400"
                >
            </div>
            <button
                onclick="submitSendPoints()"
                class="w-full bg-purple-600 hover:bg-purple-700 text-white px-6 py-2.5 rounded-lg font-semibold transition-colors flex items-center justify-center space-x-2 space-x-reverse"
            >
                <span>إرسال</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-1V4m0 2v1m0 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            </button>
        </div>
    </div>
</div>

<style>
    #topUsersModal.show {
        opacity: 1;
        visibility: visible;
    }
    #topUsersModal.show .profile-content {
        transform: scale(1);
    }
    #topUsersOverlay.show {
        display: block;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
    }
</style>

<!-- نافذة المركز اليومي (Daily Center) -->
<div id="dailyCenterModal" class="profile-modal">
    <div class="profile-content custom-scrollbar" style="width: 95%; max-width: 500px;">
        <div class="relative bg-gray-800 p-6 text-center border-b border-gray-700">
             <button onclick="closeDailyCenter()" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">🎁 المركز اليومي</h2>
            <p class="text-slate-400 text-sm">جوائز ومكافآت يومية بانتظارك!</p>
        </div>

        <div class="flex border-b border-gray-700">
            <button onclick="switchDailyTab('reward')" class="flex-1 py-3 text-sm font-bold text-white border-b-2 border-blue-500 bg-gray-700/50" id="tab-reward">المكافأة اليومية</button>
            <button onclick="switchDailyTab('wheel')" class="flex-1 py-3 text-sm font-bold text-slate-400 hover:text-white" id="tab-wheel">🎡 عجلة الحظ</button>
        </div>

        <div class="p-6 bg-gray-900/50 min-h-[300px]">
            <!-- قسم المكافأة اليومية -->
            <div id="daily-reward-content" class="text-center space-y-6">
                <div class="text-6xl animate-bounce">📅</div>
                <h3 class="text-xl font-bold text-white">سجل دخولك يومياً واربح!</h3>
                <p class="text-slate-300 text-sm">احصل على نقاط مجانية كل 24 ساعة. كلما زادت سلسلة دخولك، زادت الجائزة!</p>
                
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 inline-block w-full">
                    <div class="text-sm text-slate-400 mb-1">الجائزة الحالية</div>
                    <div class="text-3xl font-bold text-yellow-400">100 - 450 نقطة</div>
                </div>

                <button onclick="claimDailyReward()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition hover:scale-105">
                    استلام المكافأة الآن 🎁
                </button>
            </div>

            <!-- قسم عجلة الحظ -->
            <div id="daily-wheel-content" class="hidden text-center space-y-4">
                <div class="wheel-container">
                    <div class="wheel-pointer"></div>
                    <div class="wheel" id="luckyWheel"></div>
                </div>
                
                <div class="mt-4">
                    <p class="text-slate-300 text-sm mb-2">جرب حظك واربح جوائز قيمة!</p>
                    <p class="text-xs text-slate-500 mb-4">تكلفة التدوير: <span class="text-yellow-400 font-bold">500 نقطة</span></p>
                    <button id="spinButton" onclick="spinWheel()" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-bold py-2 px-8 rounded-full shadow-lg transform transition hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                        دوّر العجلة 🎡
                    </button>
                </div>
                
                <div class="grid grid-cols-3 gap-2 text-[10px] text-slate-400 mt-4">
                    <div class="bg-gray-800 p-1 rounded">🔴 100 نقطة</div>
                    <div class="bg-gray-800 p-1 rounded">🔵 300 نقطة</div>
                    <div class="bg-gray-800 p-1 rounded">🟢 500 نقطة</div>
                    <div class="bg-gray-800 p-1 rounded">🟡 1000 نقطة</div>
                    <div class="bg-gray-800 p-1 rounded">🟣 2000 نقطة</div>
                    <div class="bg-gray-800 p-1 rounded">🌸 5000 نقطة</div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="dailyCenterOverlay" class="friends-overlay" onclick="closeDailyCenter()"></div>

<!-- قبل نهاية body -->
<!-- نافذة معلومات الغرفة -->
<div id="roomInfoModal" class="profile-modal">
    <div class="profile-content" style="width: 95%; max-width: 600px;">
        <button onclick="closeRoomInfo()" class="absolute top-4 right-4 text-slate-300 hover:text-red-500">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        
        <div class="bg-gray-800 p-6 text-center border-b border-gray-700">
            <h2 id="roomInfoTitle" class="text-2xl font-bold text-white mb-2">معلومات الغرفة</h2>
            <p id="roomInfoDesc" class="text-slate-400 text-sm"></p>
        </div>

        <div id="roomInfoContent" class="p-6 space-y-6 overflow-y-auto" style="max-height: 70vh;">
            <!-- سيتم ملء المحتوى هنا -->
        </div>
    </div>
</div>

<!-- نافذة تغيير كلمة المرور -->
<div id="changePasswordModal" class="profile-modal">
    <div class="profile-content" style="width: 95%; max-width: 400px;">
        <!-- رأس النافذة -->
        <div class="relative bg-gray-800 p-6 text-center">
             <button onclick="closeChangePasswordModal()" class="absolute top-4 right-4 text-slate-300 hover:text-sky-400 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">🔑 تغيير كلمة المرور</h2>
            <p class="text-slate-400 text-sm mt-1">أدخل كلمة المرور الجديدة</p>
        </div>

        <!-- محتوى النافذة -->
        <div class="flex-1 p-6 space-y-4">
            <div>
                <label for="oldPasswordInput" class="block text-slate-200 text-sm font-semibold mb-2">كلمة المرور القديمة</label>
                <input type="password" id="oldPasswordInput" placeholder="أدخل كلمة المرور الحالية"
                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
            </div>
            <div>
                <label for="newPasswordInput" class="block text-slate-200 text-sm font-semibold mb-2">كلمة المرور الجديدة</label>
                <input type="password" id="newPasswordInput" placeholder="أدخل كلمة المرور الجديدة"
                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
            </div>
            <div>
                <label for="confirmNewPasswordInput" class="block text-slate-200 text-sm font-semibold mb-2">تأكيد كلمة المرور الجديدة</label>
                <input type="password" id="confirmNewPasswordInput" placeholder="أعد إدخال كلمة المرور الجديدة"
                    class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
            </div>
            <button onclick="submitChangePassword()"
                class="w-full bg-teal-600 hover:bg-teal-700 text-white px-6 py-2.5 rounded-lg font-semibold transition-colors flex items-center justify-center space-x-2 space-x-reverse">
                <span>تأكيد التغيير</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>
        </div>
    </div>
</div>

<!-- نافذة غرفة التحكم (Control Panel) -->
<div id="controlPanelModal" class="profile-modal">
    <div class="profile-content custom-scrollbar" style="width: 95%; max-width: 800px; height: 95vh;">
        <!-- رأس النافذة -->
        <div class="relative bg-gray-800 p-6 text-center border-b border-gray-700 flex-shrink-0">
            <button onclick="closeControlPanel()" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">⚙️ غرفة التحكم</h2>
            <p class="text-slate-400 text-sm">لوحة إدارة الموقع الشاملة</p>
        </div>
        
        <!-- محتوى النافذة -->
        <div class="flex-1 p-6 space-y-8 overflow-y-auto custom-scrollbar">
            <!-- قسم الإحصائيات -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gray-700/50 p-4 rounded-xl text-center border border-gray-600">
                    <div class="text-3xl mb-2">👥</div>
                    <div class="text-2xl font-bold text-white" id="statsTotalUsers">0</div>
                    <div class="text-xs text-slate-400">إجمالي المستخدمين</div>
                </div>
                <div class="bg-gray-700/50 p-4 rounded-xl text-center border border-gray-600">
                    <div class="text-3xl mb-2">🟢</div>
                    <div class="text-2xl font-bold text-green-400" id="statsOnline">0</div>
                    <div class="text-xs text-slate-400">المتصلون الآن</div>
                </div>
                <div class="bg-gray-700/50 p-4 rounded-xl text-center border border-gray-600">
                    <div class="text-3xl mb-2">👨</div>
                    <div class="text-2xl font-bold text-blue-400" id="statsMales">0</div>
                    <div class="text-xs text-slate-400">الذكور</div>
                </div>
                <div class="bg-gray-700/50 p-4 rounded-xl text-center border border-gray-600">
                    <div class="text-3xl mb-2">👩</div>
                    <div class="text-2xl font-bold text-pink-400" id="statsFemales">0</div>
                    <div class="text-xs text-slate-400">الإناث</div>
                </div>
            </div>

            <!-- قسم الإعلان الهام -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <span>📢</span> إدارة الإعلانات والتنبيهات
                </h3>
                <div class="flex flex-col gap-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <select id="announcementType" onchange="toggleCustomTitle()" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-red-500">
                            <option value="إعلان هام">إعلان هام</option>
                            <option value="تنبيه">تنبيه</option>
                            <option value="تحديث">تحديث</option>
                            <option value="custom">عنوان مخصص...</option>
                        </select>
                        <input type="text" id="announcementCustomTitle" placeholder="اكتب العنوان المخصص هنا..." class="hidden bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    <textarea id="announcementInput" placeholder="اكتب محتوى الرسالة هنا... (يدعم السطور المتعددة)" rows="3" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-red-500 resize-none"></textarea>
                    <div class="flex gap-2 justify-end">
                        <button onclick="setAnnouncement()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-2 rounded-lg font-semibold transition-colors">نشر الآن</button>
                        <button onclick="removeAnnouncement()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">إزالة</button>
                    </div>
                </div>
            </div>

            <!-- قسم إدارة الرتب -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <span>🌟</span> إدارة الرتب والصلاحيات
                </h3>
                
                <!-- نموذج الإضافة/التعديل -->
                <div class="bg-gray-900/50 p-4 rounded-lg mb-6 border border-gray-600">
                    <h4 class="text-white font-semibold mb-3 text-sm" id="rankFormTitle">إضافة رتبة جديدة</h4>
                    <input type="hidden" id="editingRankName" value="">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="customRankName" placeholder="اسم الرتبة" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 col-span-2 md:col-span-1">
                    
                    <div class="col-span-2 md:col-span-1">
                        <div class="flex gap-2">
                            <input type="text" id="customRankIcon" placeholder="الأيقونة (مثال: 🚀)" class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-center focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <input type="file" id="rankIconUpload" accept="image/*" class="hidden" onchange="handleRankIconUpload()">
                            <button onclick="document.getElementById('rankIconUpload').click()" class="bg-gray-600 hover:bg-gray-500 text-white px-3 py-2 rounded-lg transition-colors" title="رفع صورة">🖼️</button>
                        </div>
                        <div id="rankIconPreviewContainer" class="hidden mt-2 text-center"><img id="rankIconPreview" src="" class="w-8 h-8 mx-auto object-contain"><button onclick="clearRankIconImage()" class="text-xs text-red-400 hover:text-red-300 mt-1">إزالة الصورة</button></div>
                    </div>

                    <input type="number" id="customRankLevel" placeholder="المستوى (1-99)" min="1" max="99" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500" title="المستوى الأعلى يتحكم بالمستوى الأدنى. الحد الأقصى 99.">
                        <select id="customRankColor" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="from-gray-500 to-gray-700">⚪ رمادي (عادي)</option>
                            <option value="from-red-600 to-orange-400">🔴 أحمر - برتقالي (مميز)</option>
                            <option value="from-yellow-400 to-yellow-500">🟡 ذهبي (ملكي)</option>
                            <option value="from-green-500 to-emerald-600">🟢 أخضر (نشط)</option>
                            <option value="from-blue-500 to-cyan-600">🔵 أزرق (إداري)</option>
                            <option value="from-purple-500 to-indigo-600">🟣 بنفسجي (فخم)</option>
                            <option value="from-pink-500 to-rose-500">🌸 وردي (بناتي)</option>
                        </select>
                        <div class="md:col-span-2">
                            <input type="text" id="customRankTarget" placeholder="اسم المستخدم للتعيين (اختياري)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                </div>
                    <div class="flex gap-2">
                        <button onclick="saveRankDefinition()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors" id="saveRankBtn">حفظ وتعيين</button>
                        <button onclick="resetRankForm()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors hidden" id="cancelRankEditBtn">إلغاء</button>
                    </div>
                </div>

                <!-- قائمة الرتب -->
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-right text-gray-400">
                        <thead class="text-xs text-gray-200 uppercase bg-gray-700/50">
                            <tr>
                                <th class="px-4 py-3">الرتبة</th>
                                <th class="px-4 py-3">المستوى (القوة)</th>
                                <th class="px-4 py-3">اللون</th>
                                <th class="px-4 py-3">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="ranksTableBody" class="divide-y divide-gray-700">
                            <!-- سيتم ملء الرتب هنا -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- قسم إدارة مديري الغرف -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <span>👮</span> إدارة مديري الغرف
                </h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-slate-300 mb-2 block">اختر الغرفة</label>
                            <select id="managerRoomSelect" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-orange-500" onchange="updateManagersList()">
                                <option value="">اختر غرفة...</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-slate-300 mb-2 block">اسم المستخدم</label>
                            <input type="text" id="managerUserInput" placeholder="اكتب اسم المستخدم..." class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>
                    <button onclick="assignRoomManager()" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">تعيين مدير الغرفة</button>
                </div>

                <!-- قائمة مديري الغرف الحاليين -->
                <div class="mt-6 pt-6 border-t border-gray-700">
                    <h4 class="text-lg font-semibold text-white mb-4">مديرو الغرف الحاليون</h4>
                    <div id="roomManagersList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- سيتم ملء قائمة المديرين هنا -->
                    </div>
                    <div id="noManagersMsg" class="text-center text-slate-400 text-sm py-6">لا توجد غرف بها مديرون حالياً</div>
                </div>
            </div>

            <!-- قسم إدارة الغرف -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <span>🚪</span> إدارة الغرف
                </h3>

                <!-- نموذج إضافة غرفة جديدة -->
                <div class="bg-gray-900/50 p-4 rounded-lg mb-6 border border-gray-600">
                    <h4 class="text-white font-semibold mb-3 text-sm">إضافة غرفة جديدة</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
                        <input type="text" id="newRoomName" placeholder="اسم الغرفة" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                        <input type="text" id="newRoomIcon" placeholder="أيقونة (مثال: 💬)" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-center focus:outline-none focus:ring-2 focus:ring-green-500">
                        <input type="number" id="newRoomOrder" placeholder="الترتيب (مثال: 1)" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-center focus:outline-none focus:ring-2 focus:ring-green-500" min="0">
                        <input type="text" id="newRoomDesc" placeholder="وصف الغرفة" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 md:col-span-1">
                    </div>
                    <button onclick="addNewRoom()" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">➕ إضافة غرفة</button>
                </div>

                <!-- قائمة الغرف -->
                <div class="overflow-x-auto bg-gray-900/50 rounded-lg border border-gray-700 custom-scrollbar">
                    <table class="w-full text-sm text-right text-gray-400">
                        <thead class="text-xs text-gray-200 uppercase bg-gray-700/80 sticky top-0">
                            <tr>
                                <th class="px-4 py-3">الترتيب</th>
                                <th class="px-4 py-3">الأيقونة</th>
                                <th class="px-4 py-3">اسم الغرفة</th>
                                <th class="px-4 py-3">الوصف</th>
                                <th class="px-4 py-3 text-center">المستخدمون</th>
                                <th class="px-4 py-3 text-center">الحالة</th>
                                <th class="px-4 py-3 text-center">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="roomsListTableBody" class="divide-y divide-gray-700">
                            <!-- سيتم ملء الجدول هنا -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- قسم إدارة المسابقات -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <span>🎮</span> إدارة المسابقات (QuizBot)
                </h3>

                <!-- نموذج إضافة سؤال جديد -->
                <div class="bg-gray-900/50 p-4 rounded-lg mb-6 border border-gray-600">
                    <h4 class="text-white font-semibold mb-3 text-sm">إضافة سؤال جديد</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                        <input type="text" id="newQuizCategory" placeholder="الفئة (مثلاً: رياضة)" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        <input type="text" id="newQuizQuestion" placeholder="السؤال" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        <input type="text" id="newQuizAnswer" placeholder="الإجابة الصحيحة" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500">
                    </div>
                    <button onclick="addQuizQuestion()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">➕ إضافة سؤال</button>
                </div>

                <!-- قائمة الأسئلة -->
                <div class="overflow-x-auto bg-gray-900/50 rounded-lg border border-gray-700 custom-scrollbar">
                    <table class="w-full text-sm text-right text-gray-400">
                        <thead class="text-xs text-gray-200 uppercase bg-gray-700/80 sticky top-0">
                            <tr>
                                <th class="px-4 py-3">الفئة</th>
                                <th class="px-4 py-3">السؤال</th>
                                <th class="px-4 py-3">الإجابة</th>
                                <th class="px-4 py-3 text-center">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="quizQuestionsTableBody" class="divide-y divide-gray-700">
                            <!-- سيتم ملء الجدول هنا -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- قسم قائمة المستخدمين الشاملة -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <span>👥</span> قائمة المستخدمين الشاملة
                    </h3>
                    <div class="relative w-full md:w-64">
                        <input type="text" id="controlUserSearch" placeholder="بحث عن مستخدم..." class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="filterControlUsers()">
                    </div>
                </div>
                <div class="overflow-x-auto bg-gray-900/50 rounded-lg border border-gray-700 custom-scrollbar">
                    <table class="w-full text-sm text-right text-gray-400">
                        <thead class="text-xs text-gray-200 uppercase bg-gray-700/80 sticky top-0">
                            <tr>
                                <th scope="col" class="px-4 py-3">المستخدم (تعديل)</th>
                                <th scope="col" class="px-4 py-3">الرتبة</th>
                                <th scope="col" class="px-4 py-3">النقاط</th>
                                <th scope="col" class="px-4 py-3">المستوى</th>
                                <th scope="col" class="px-4 py-3 text-center">لانهائي</th>
                                <th scope="col" class="px-4 py-3 text-center">المتفاعلين</th>
                                <th scope="col" class="px-4 py-3 text-center">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="controlUsersTableBody" class="divide-y divide-gray-700">
                            <!-- سيتم ملء الجدول هنا -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-2 text-xs text-slate-500 text-center">يتم عرض المتصلين أولاً، ثم الترتيب حسب النقاط</div>
            </div>
        </div>
    </div>
</div>

<!-- نافذة لوحة الرسم المشتركة -->
<div id="drawingModal" class="profile-modal">
    <div class="profile-content custom-scrollbar relative bg-gray-900 border border-gray-700 rounded-xl overflow-hidden" style="max-width: 800px; width: 95%;">
        <div class="flex justify-between items-center p-4 border-b border-gray-700 bg-gray-800">
            <div class="flex items-center gap-3">
                <h2 class="text-xl font-bold text-white">🎨 لوحة الرسم المشتركة</h2>
                <span id="drawingStatusHeader" class="text-xs md:text-sm text-pink-400 animate-pulse font-medium hidden"></span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="clearDrawingBoard()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-bold transition-colors">مسح الكل</button>
                <button onclick="closeDrawingBoard()" class="text-slate-300 hover:text-blue-500 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>
        <div class="p-4 bg-gray-800 flex justify-center overflow-auto">
            <canvas id="sharedCanvas" width="750" height="500" class="bg-white rounded shadow-lg cursor-crosshair touch-none"></canvas>
        </div>
        <div class="p-4 bg-gray-800 border-t border-gray-700 flex justify-center gap-6 items-center flex-wrap">
             <div class="flex items-center gap-2">
                <label class="text-white text-sm font-semibold">اللون:</label>
                <input type="color" id="drawingColor" value="#000000" class="h-8 w-10 rounded cursor-pointer bg-transparent border-0 p-0">
             </div>
             <div class="flex items-center gap-2">
                <label class="text-white text-sm font-semibold">الحجم:</label>
                <input type="range" id="drawingWidth" min="1" max="20" value="3" class="w-32 accent-blue-500">
             </div>
        </div>
    </div>
</div>

<!-- نافذة لعبة الثعبان -->
<div id="snakeGameModal" class="profile-modal">
    <div class="profile-content custom-scrollbar" style="width: 95%; max-width: 650px;">
        <div class="relative bg-gray-800 p-4 text-center border-b border-gray-700">
             <button onclick="closeSnakeGame()" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-xl font-bold text-white">🐍 لعبة الثعبان الجماعية</h2>
        </div>

        <div class="p-4 bg-gray-900/90 flex flex-col items-center">
            <!-- شاشة الانتظار -->
            <div id="snakeScoreDisplay" class="text-xl font-bold text-yellow-400 mb-2 hidden">النتيجة: 0</div>
            <div id="snakeLobby" class="w-full text-center mb-4">
                <h3 class="text-white font-bold mb-2">قاعة الانتظار</h3>
                <div id="snakePlayersList" class="flex justify-center gap-4 mb-4 flex-wrap">
                    <!-- سيتم ملء اللاعبين هنا -->
                </div>
                
                <!-- أدوات التخصيص والاستعداد -->
                <div id="snakeLobbyControls" class="flex flex-col items-center gap-3 mb-4 hidden">
                    <div id="snakeColorPicker" class="flex gap-2 bg-gray-800 p-2 rounded-lg border border-gray-700">
                        <!-- أزرار الألوان ستضاف هنا -->
                    </div>
                    <div class="flex gap-3">
                        <button id="snakeReadyBtn" onclick="toggleSnakeReady()" class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-2 rounded-full font-bold transition-colors">استعداد ✅</button>
                        <button id="startSnakeBtn" onclick="startSnakeGame()" class="hidden bg-green-600 hover:bg-green-700 text-white px-8 py-2 rounded-full font-bold shadow-lg animate-pulse">ابدأ اللعبة 🎮</button>
                    </div>
                </div>

                <button id="createSnakeBtn" onclick="createSnakeGame()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2 rounded-full font-bold shadow-lg">
                    إنشاء غرفة جديدة 🆕
                </button>
                <!-- أزرار اختيار الوضع -->
                <div id="snakeModeSelection" class="hidden flex flex-col gap-3 mt-4 w-full max-w-xs mx-auto">
                    <button onclick="startSinglePlayerSnake()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg transform transition hover:scale-105 flex items-center justify-center gap-2"><span>👤</span> لعب فردي (بدون إشعار)</button>
                    <button onclick="startMultiPlayerSnake()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg transform transition hover:scale-105 flex items-center justify-center gap-2"><span>👥</span> لعب جماعي (مع إشعار)</button>
                    <button onclick="cancelSnakeModeSelection()" class="text-slate-400 hover:text-white text-sm mt-2">إلغاء</button>
                </div>
            </div>

            <!-- لوحة اللعب -->
            <div class="relative">
                <canvas id="snakeCanvas" width="600" height="400" class="bg-black border-2 border-gray-700 rounded-lg shadow-2xl hidden w-full h-auto max-w-full touch-none"></canvas>
                <div id="snakeCountdownOverlay" class="absolute inset-0 flex items-center justify-center bg-gray-900/60 backdrop-blur-sm hidden z-10 rounded-lg" style="transition: transform 0.3s, opacity 0.3s;">
                    <!-- سيظهر العد التنازلي هنا -->
                </div>
                <div id="snakeOverlay" class="absolute inset-0 flex items-center justify-center bg-black/70 hidden">
                    <h2 id="snakeWinnerText" class="text-3xl font-bold text-yellow-400"></h2>
                </div>
            </div>
            
            <!-- أزرار التحكم للجوال -->
            <div id="snakeControls" class="grid grid-cols-3 gap-4 mt-6 md:hidden hidden w-full max-w-[280px] mx-auto" dir="ltr">
                <div></div>
                <button onclick="sendSnakeDir(0, -1)" class="bg-gray-700/90 active:bg-gray-600 p-5 rounded-2xl text-3xl shadow-lg backdrop-blur-sm transition-transform active:scale-90 flex items-center justify-center border border-white/10">⬆️</button>
                <div></div>
                
                <button onclick="sendSnakeDir(-1, 0)" class="bg-gray-700/90 active:bg-gray-600 p-5 rounded-2xl text-3xl shadow-lg backdrop-blur-sm transition-transform active:scale-90 flex items-center justify-center border border-white/10">⬅️</button>
                <div></div>
                <button onclick="sendSnakeDir(1, 0)" class="bg-gray-700/90 active:bg-gray-600 p-5 rounded-2xl text-3xl shadow-lg backdrop-blur-sm transition-transform active:scale-90 flex items-center justify-center border border-white/10">➡️</button>
                
                <div></div>
                <button onclick="sendSnakeDir(0, 1)" class="bg-gray-700/90 active:bg-gray-600 p-5 rounded-2xl text-3xl shadow-lg backdrop-blur-sm transition-transform active:scale-90 flex items-center justify-center border border-white/10">⬇️</button>
                <div></div>
            </div>
        </div>
    </div>
</div>

<!-- نافذة ملوك الثعبان (Leaderboard) -->
<div id="snakeLeaderboardModal" class="profile-modal">
    <div class="profile-content custom-scrollbar" style="width: 95%; max-width: 500px;">
        <div class="relative bg-gray-800 p-6 text-center border-b border-gray-700">
             <button onclick="closeSnakeLeaderboard()" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">🐍 ملوك الثعبان</h2>
        </div>

        <div class="flex border-b border-gray-700">
            <button onclick="switchSnakeTab('single')" class="flex-1 py-3 text-sm font-bold text-white border-b-2 border-green-500 bg-gray-700/50" id="tab-snake-single">🏆 الفردي (أعلى نتيجة)</button>
            <button onclick="switchSnakeTab('multi')" class="flex-1 py-3 text-sm font-bold text-slate-400 hover:text-white" id="tab-snake-multi">⚔️ الجماعي (الكؤوس)</button>
        </div>

        <div class="p-4 bg-gray-900/50 min-h-[300px]">
            <div id="snake-leaderboard-content" class="space-y-3">
                <div class="text-center text-slate-400 p-8"><div class="spinner mx-auto"></div></div>
            </div>
        </div>
    </div>
</div>

<!-- نافذة قبول الهدية (تم النقل للنهاية لضمان الظهور) -->
<div id="giftOfferModal" class="profile-modal" style="z-index: 100000;">
    <div class="profile-content" style="width: 95%; max-width: 400px;">
        <div class="relative bg-gray-800 p-6 text-center border-b border-gray-700">
            <h2 class="text-2xl font-bold text-white mb-2">🎁 هدية جديدة!</h2>
            <p class="text-slate-300 text-sm">لديك عرض هدية معلق</p>
        </div>
        <div class="p-6 text-center space-y-6">
            <div class="text-lg text-white">
                قام <strong id="giftSenderName" class="text-blue-400"></strong> بإهدائك رتبة <strong id="giftRankName" class="text-yellow-400"></strong>.
                <br>هل تقبل الهدية؟
            </div>
            <div class="flex gap-4 justify-center">
                <button onclick="respondToGift(true)" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold transition-colors">قبول ✅</button>
                <button onclick="respondToGift(false)" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-bold transition-colors">رفض ❌</button>
            </div>
        </div>
    </div>
</div>

<!-- عناصر إدخال الملف المخفية -->
<input type="file" id="imageUpload" accept="image/*" class="hidden">
<input type="file" id="privateImageUpload" accept="image/*" class="hidden">
<input type="file" id="profileImageUpload" accept="image/*" class="hidden">
<input type="file" id="coverUpload" accept="image/*" class="hidden">



    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({ 
            transports: ['polling', 'websocket'],
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000
        });
        window.DEFAULT_AVATAR_URL = '/my-avatar.png';
        const SITE_OWNER = {
            username: "Walid dz 31",
            rank: "صاحب الموقع"
        };
        let currentUser = null;
        let BOT_AVATAR_URL = '/icon.png';

        // قائمة الدول
        const COUNTRIES = [
            { code: 'SA', name: 'السعودية', flag: '/flags/sa.png' },
            { code: 'EG', name: 'مصر', flag: '/flags/eg.png' },
            { code: 'DZ', name: 'الجزائر', flag: '/flags/dz.png' },
            { code: 'MA', name: 'المغرب', flag: '/flags/ma.png' },
            { code: 'IQ', name: 'العراق', flag: '/flags/iq.png' },
            { code: 'SY', name: 'سوريا', flag: '/flags/sy.png' },
            { code: 'YE', name: 'اليمن', flag: '/flags/ye.png' },
            { code: 'TN', name: 'تونس', flag: '/flags/tn.png' },
            { code: 'JO', name: 'الأردن', flag: '/flags/jo.png' },
            { code: 'AE', name: 'الإمارات', flag: '/flags/ae.png' },
            { code: 'LB', name: 'لبنان', flag: '/flags/lb.png' },
            { code: 'PS', name: 'فلسطين', flag: '/flags/ps.png' },
            { code: 'KW', name: 'الكويت', flag: '/flags/kw.png' },
            { code: 'OM', name: 'عمان', flag: '/flags/om.png' },
            { code: 'QA', name: 'قطر', flag: '/flags/qa.png' },
            { code: 'BH', name: 'البحرين', flag: '/flags/bh.png' },
            { code: 'SD', name: 'السودان', flag: '/flags/sd.png' },
            { code: 'LY', name: 'ليبيا', flag: '/flags/ly.png' },
            { code: 'MR', name: 'موريتانيا', flag: '/flags/mr.png' },
            { code: 'SO', name: 'الصومال', flag: '/flags/so.png' },
            { code: 'DJ', name: 'جيبوتي', flag: '/flags/dj.png' },
            { code: 'KM', name: 'جزر القمر', flag: '/flags/km.png' },
            { code: 'TR', name: 'تركيا', flag: '/flags/tr.png' },
            { code: 'US', name: 'أمريكا', flag: '/flags/us.png' },
            { code: 'GB', name: 'بريطانيا', flag: '/flags/gb.png' },
            { code: 'FR', name: 'فرنسا', flag: '/flags/fr.png' },
            { code: 'DE', name: 'ألمانيا', flag: '/flags/de.png' }
        ];

        // --- إعدادات المستخدم ---
        let userSettings = {
            playEntrySound: true,
            playExitSound: true,
            playMentionSound: true
        };

        const savedSettings = localStorage.getItem('userSettings');
        if (savedSettings) {
            try {
                userSettings = { ...userSettings, ...JSON.parse(savedSettings) };
            } catch (e) {}
        }

        function saveUserSettings() {
            localStorage.setItem('userSettings', JSON.stringify(userSettings));
        }

        const animatedEmojis = [];
        // توليد قائمة الايموجيات الثابتة تلقائياً (من 1 إلى 100)
        for (let i = 1; i <= 100; i++) {
            animatedEmojis.push(`/f/${i}.png?v=2`);
        }

        const localEmojis = [];
        // توليد قائمة الايموجيات المتحركة تلقائياً (من 1 إلى 100)
        for (let i = 1; i <= 100; i++) {
            localEmojis.push(`/e/${i}.gif`);
        }

        let currentEmojiTab = 'animated';

        function toggleEmojiPicker(isPrivate = false) {
            if (event) event.stopPropagation();
            if (typeof isPrivate !== 'boolean') isPrivate = false;
            
            const pickerId = isPrivate ? 'privateEmojiPicker' : 'emojiPicker';
            const picker = document.getElementById(pickerId);
            
            if (picker.classList.contains('show')) {
                picker.classList.remove('show');
                return;
            }

            const otherPickerId = isPrivate ? 'emojiPicker' : 'privateEmojiPicker';
            const otherPicker = document.getElementById(otherPickerId);
            if (otherPicker) otherPicker.classList.remove('show');

            // التحقق مما إذا كانت القائمة فارغة قبل بنائها لمنع التكرار
            if (picker.children.length === 0) {
                renderEmojiPicker(pickerId, isPrivate);
            }
            picker.classList.add('show');
        }

        function renderEmojiPicker(pickerId, isPrivate) {
            const picker = document.getElementById(pickerId);
            
            // إنشاء الهيكل مرة واحدة فقط إذا لم يكن موجوداً
            if (picker.children.length === 0) {
                picker.innerHTML = `
                    <div class="emoji-picker-header">
                        <div class="emoji-tab" id="tab-animated-${pickerId}" onclick="switchEmojiTab(event, 'animated', '${pickerId}', ${isPrivate})">ثابتة</div>
                        <div class="emoji-tab" id="tab-local-${pickerId}" onclick="switchEmojiTab(event, 'local', '${pickerId}', ${isPrivate})">متحركة</div>
                    </div>
                    <div id="grid-animated-${pickerId}" class="emoji-grid custom-scrollbar" style="display: none;"></div>
                    <div id="grid-local-${pickerId}" class="emoji-grid custom-scrollbar" style="display: none;"></div>
                `;
            }

            // تحديث حالة التبويبات
            const tabAnimated = document.getElementById(`tab-animated-${pickerId}`);
            const tabLocal = document.getElementById(`tab-local-${pickerId}`);
            if (tabAnimated && tabLocal) {
                tabAnimated.className = `emoji-tab ${currentEmojiTab === 'animated' ? 'active' : ''}`;
                tabLocal.className = `emoji-tab ${currentEmojiTab === 'local' ? 'active' : ''}`;
            }

            // تبديل ظهور الشبكات
            const gridAnimated = document.getElementById(`grid-animated-${pickerId}`);
            const gridLocal = document.getElementById(`grid-local-${pickerId}`);
            
            if (currentEmojiTab === 'animated') {
                gridAnimated.style.display = 'grid';
                gridLocal.style.display = 'none';
                if (gridAnimated.children.length === 0) populateEmojiGrid(gridAnimated, animatedEmojis, isPrivate);
            } else {
                gridAnimated.style.display = 'none';
                gridLocal.style.display = 'grid';
                if (gridLocal.children.length === 0) populateEmojiGrid(gridLocal, localEmojis, isPrivate);
            }
        }

        function populateEmojiGrid(grid, emojis, isPrivate) {
            emojis.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.className = 'animated-emoji';
                img.onclick = (e) => {
                    e.stopPropagation();
                    sendAnimatedEmoji(url, isPrivate);
                };
                img.onerror = function() { this.style.display = 'none'; };
                grid.appendChild(img);
            });
        }

        function switchEmojiTab(event, tab, pickerId, isPrivate) {
            if (event) event.stopPropagation();
            currentEmojiTab = tab;
            renderEmojiPicker(pickerId, isPrivate);
        }

        function sendAnimatedEmoji(url, isPrivate) {
            if (isPrivate) {
                const privateInput = document.getElementById('privateMessageInput');
                if (privateInput) {
                    privateInput.value = (privateInput.value.trim() ? privateInput.value + ' ' : '') + url;
                    privateInput.focus();
                }
                document.getElementById('privateEmojiPicker').classList.remove('show');
            } else {
                const input = document.getElementById('messageInput');
                if (input) {
                    input.value = (input.value.trim() ? input.value + ' ' : '') + url;
                    input.focus();
                }
                document.getElementById('emojiPicker').classList.remove('show');
            }
        }

        function triggerBotAvatarUpload() {
            if (currentUser && currentUser.name === SITE_OWNER.username) {
                document.getElementById('botAvatarInput').click();
            }
        }

        function uploadBotAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                showNotification('حجم الصورة كبير جداً (الحد الأقصى 2 ميجابايت)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const avatarUrl = e.target.result;
                socket.emit('update bot avatar', { avatarUrl, currentUser });
                // تحديث محلي فوري
                BOT_AVATAR_URL = avatarUrl;
                document.querySelectorAll('#changeBotAvatarBtn img').forEach(img => img.src = avatarUrl);
            };
            reader.readAsDataURL(file);
        }

        // --- دوال تبديل أقسام الملف الشخصي ---
        function switchProfileTab(event, tabName) {
            // إخفاء جميع المحتويات
            document.querySelectorAll('.profile-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            // إلغاء تفعيل جميع الأزرار
            document.querySelectorAll('.profile-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // إظهار المحتوى المحدد
            document.getElementById(`profileTab-${tabName}`).classList.remove('hidden');
            // تفعيل الزر المحدد
            event.currentTarget.classList.add('active');
        }

        function confirmDeleteAccount() {
            const username = document.getElementById('profileUsername').textContent;
            if (username !== currentUser.name) return;

            const confirmation = prompt(`للتأكيد، يرجى كتابة اسم المستخدم الخاص بك: "${username}"`);
            if (confirmation === username) {
                if (confirm("هل أنت متأكد تماماً؟ سيتم حذف جميع بياناتك نهائياً.")) {
                    socket.emit('delete account', { username: currentUser.name });
                }
            } else if (confirmation !== null) {
                showNotification('اسم المستخدم غير متطابق. تم إلغاء العملية.', 'error');
            }
        }

        function requestUsernameChange() {
            const newUsername = document.getElementById('newUsernameInput').value.trim();
            if (!newUsername) {
                showNotification('يرجى إدخال اسم جديد.', 'error');
                return;
            }
            if (confirm(`هل أنت متأكد من تغيير اسمك إلى "${newUsername}"؟ سيتم تسجيل خروجك.`)) {
                socket.emit('change username', { newUsername, currentUser });
            }
        }

        socket.on('username change success', (message) => {
            showNotification(message, 'success');
            setTimeout(logout, 2000);
        });

        socket.on('username change error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('user name changed', ({ oldUsername, newUsername }) => {
            // تحديث الواجهة لجميع العملاء الآخرين
            document.querySelectorAll(`[data-username="${oldUsername}"]`).forEach(el => {
                el.setAttribute('data-username', newUsername);
                // تحديث النص إذا كان موجوداً
                const textNode = el.querySelector('.font-semibold.truncate, .username-text, #profileUsername');
                if (textNode && textNode.textContent === oldUsername) textNode.textContent = newUsername;
            });
        });

        // --- دوال قسم الميزات ---
        let currentFeatureSelection = {
            feature: 'nameColor',
            value: null
        };

        function switchFeatureSubTab(tabName) {
            // تحديث الأزرار
            document.querySelectorAll('.feature-sub-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-slate-400', 'hover:bg-gray-700');
            });
            const activeBtn = document.getElementById(`btn-${tabName}`);
            activeBtn.classList.remove('text-slate-400', 'hover:bg-gray-700');
            activeBtn.classList.add('bg-blue-600', 'text-white');

            // تحديث المحتوى
            document.querySelectorAll('.feature-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(`feature-${tabName}`).classList.remove('hidden');

            currentFeatureSelection.feature = tabName;
            currentFeatureSelection.value = null; // إعادة تعيين القيمة عند التبديل
        }

        function applyCustomColor(feature, color) {
            let value = '';
            if (feature === 'nameColor') {
                value = `color:${color}`; // استخدام كود اللون مباشرة
            } else if (feature === 'userCardBackground') {
                value = `background-color:${color}`;
            } else if (feature === 'profileBackground') {
                value = `background-color:${color}`;
            } else if (feature === 'avatarFrame') {
                value = `border-color:${color}`;
            }
            selectFeature(feature, value);
        }

        function selectFeature(feature, value) {
            currentFeatureSelection.feature = feature;
            currentFeatureSelection.value = value;

            // تحديث التحديد المرئي
            if (feature === 'nameColor') {
                document.querySelectorAll('#nameColorGrid .color-option').forEach(el => el.classList.remove('selected'));
                if (event && event.target && event.target.classList.contains('color-option')) {
                    event.target.classList.add('selected');
                }
                
                // تحديث المعاينة في بطاقة المستخدم (إذا وجدت معاينة)
                const previewText = document.querySelector('#previewCardDiv .truncate, #previewCardDiv .font-semibold');
                if (previewText) {
                    previewText.className = 'font-semibold truncate text-sm';
                    previewText.style.color = '';
                    previewText.style.background = '';
                    previewText.style.webkitBackgroundClip = '';
                    previewText.style.webkitTextFillColor = '';
                    
                    if (value && value.startsWith('color:')) {
                        previewText.style.color = value.split(':')[1];
                    } else if (value && value.startsWith('text-gradient-')) {
                        previewText.classList.add(value);
                    } else if (value && value.startsWith('text-sparkle-')) {
                        previewText.classList.add(value);
                    } else if (value && value.startsWith('text-neon-')) {
                        previewText.classList.add(value);
                    } else if (value && value.startsWith('text-fire-')) {
                        previewText.classList.add(value);
                    } else if (value) {
                        previewText.classList.add(value);
                    }
                }
            } else if (feature === 'nameBackground') {
                document.querySelectorAll('#nameBackgroundGrid > div').forEach(el => el.classList.remove('border-blue-500', 'border-2'));
                if (event && event.currentTarget) event.currentTarget.classList.add('border-blue-500', 'border-2');
                
                // تحديث المعاينة
                const preview = document.getElementById('nameBackgroundPreview');
                preview.className = `px-2 py-1 rounded ${value || ''}`;
            } else if (feature === 'avatarFrame') {
                document.querySelectorAll('#avatarFrameGrid > div').forEach(el => el.classList.remove('ring-2', 'ring-blue-500'));
                if (event && event.currentTarget && event.currentTarget.id !== 'customFrameColorPicker') event.currentTarget.classList.add('ring-2', 'ring-blue-500');
                
                // تحديث المعاينة الفورية
                const avatarFrame = document.getElementById('profileAvatarFrame');
                if (avatarFrame) {
                    avatarFrame.style.border = '';
                    if (value && value.startsWith('border-color:')) {
                        avatarFrame.className = `w-24 h-24 rounded-full relative`;
                        avatarFrame.style.border = `3px solid ${value.split(':')[1]}`;
                    } else {
                        avatarFrame.className = `w-24 h-24 rounded-full relative ${value || ''}`;
                    }
                }
            } else if (feature === 'userCardBackground') {
                document.querySelectorAll('#userCardBackgroundGrid > div').forEach(el => el.classList.remove('ring-2', 'ring-blue-500'));
                if (event && event.currentTarget && event.currentTarget.id !== 'customCardColorPicker') {
                    event.currentTarget.classList.add('ring-2', 'ring-blue-500');
                }
                
                const previewDiv = document.getElementById('previewCardDiv');
                previewDiv.style.backgroundColor = '';
                if (value && value.startsWith('background-color:')) {
                    previewDiv.className = `flex items-center space-x-3 space-x-reverse p-2 rounded-lg`;
                    previewDiv.style.backgroundColor = value.split(':')[1];
                } else {
                    previewDiv.className = `flex items-center space-x-3 space-x-reverse p-2 rounded-lg ${value || 'bg-gray-800'}`;
                }
            } else if (feature === 'profileBackground') {
                document.querySelectorAll('#profileBackgroundGrid > div').forEach(el => el.classList.remove('ring-2', 'ring-blue-500'));
                if (event && event.currentTarget && event.currentTarget.id !== 'customProfileColorPicker') {
                    event.currentTarget.classList.add('ring-2', 'ring-blue-500');
                }
                
                const previewDiv = document.getElementById('previewProfileDiv');
                previewDiv.style.backgroundColor = '';
                if (value && value.startsWith('background-color:')) {
                    previewDiv.className = `p-4 rounded-lg text-center`;
                    previewDiv.style.backgroundColor = value.split(':')[1];
                } else {
                    previewDiv.className = `p-4 rounded-lg text-center ${value || 'bg-gradient-to-b from-gray-800 to-gray-900'}`;
                }
            } else if (feature === 'nameCardBorder') {
                document.querySelectorAll('#nameCardBorderGrid > div').forEach(el => el.style.borderColor = '');
                if (event && event.currentTarget) {
                    event.currentTarget.style.borderColor = '#3b82f6';
                }
                
                const previewDiv = document.getElementById('previewCardBorderDiv');
                previewDiv.style.borderColor = '#6366f1';
                if (value && value.startsWith('border-color:')) {
                    previewDiv.style.borderColor = value.split(':')[1];
                }
            } else if (feature === 'nameFont') {
                document.querySelectorAll('#nameFontGrid > div').forEach(el => el.classList.remove('border-blue-500', 'border-2'));
                if (event && event.currentTarget) event.currentTarget.classList.add('border-blue-500', 'border-2');
                
                const preview = document.getElementById('nameFontPreview');
                // إزالة كلاسات الخطوط القديمة
                const fontClasses = [
                    'font-cairo', 'font-tajawal', 'font-amiri', 'font-aref', 'font-rakkas', 'font-lemonada', 'font-changa', 'font-messiri',
                    'font-almarai', 'font-harmattan', 'font-lalezar', 'font-mada', 'font-reem-kufi', 'font-scheherazade', 'font-lateef',
                    'font-mirza', 'font-vibes', 'font-katibeh', 'font-kufam', 'font-readex'
                ];
                fontClasses.forEach(cls => preview.classList.remove(cls));
                if (value) preview.classList.add(value);
            }
        }

        function updateNameCardBorderGrid(profileData) {
            const nameCardBorderGrid = document.getElementById('nameCardBorderGrid');
            if (!nameCardBorderGrid || !profileData || !profileData.achievements) return;
            
            nameCardBorderGrid.innerHTML = '';
            const completedAchievements = profileData.achievements.filter(a => a.completed);
            
            if (completedAchievements.length > 0) {
                completedAchievements.forEach(ach => {
                    const div = document.createElement('div');
                    let borderColor = ach.cardColor || '#6366f1';
                    
                    div.className = 'cursor-pointer p-3 rounded-lg border-2 hover:border-white text-center flex flex-col items-center gap-2 bg-gray-800/50';
                    div.style.borderColor = borderColor;
                    div.innerHTML = `<span class="text-2xl">${ach.icon || '🏆'}</span><span class="text-[10px] text-slate-300">${ach.name}</span>`;
                    div.onclick = (e) => selectFeature('nameCardBorder', `border-color:${borderColor}`);
                    nameCardBorderGrid.appendChild(div);
                });
            } else {
                nameCardBorderGrid.innerHTML = '<div class="text-center text-slate-500 text-xs py-4">لا توجد إنجازات محققة بعد</div>';
            }
        }

        function saveSelectedFeature() {
            if (currentFeatureSelection.value === undefined) return; // لم يتم اختيار شيء
            
            socket.emit('update user feature', {
                feature: currentFeatureSelection.feature,
                value: currentFeatureSelection.value,
                currentUser: currentUser
            });

            // تحديث البيانات محلياً فوراً لضمان ظهور التغييرات
            if (currentUser) {
                currentUser[currentFeatureSelection.feature] = currentFeatureSelection.value;
            }
        }

        // تهيئة خيارات الميزات
        function initFeaturesUI() {
            // 1. ألوان الاسم
            const colors = [
                'text-red-500', 'text-orange-500', 'text-yellow-400', 'text-green-500', 'text-cyan-400',
                'text-blue-500', 'text-indigo-500', 'text-purple-500', 'text-pink-500', 'text-lime-400',
                'text-emerald-500', 'text-white'
            ];
            const colorGrid = document.getElementById('nameColorGrid');
            // إضافة الألوان الجديدة للقائمة
            colors.push('text-glitch-red', 'text-glitch-purple');
            colorGrid.innerHTML = '';
            colors.forEach(color => {
                const div = document.createElement('div');
                div.className = `color-option ${color.replace('text-', 'bg-')}`;
                div.onclick = (e) => selectFeature('nameColor', color);
                colorGrid.appendChild(div);
            });

            // 2. خلفيات الاسم
            const backgrounds = [
                'bg-red-600', 'bg-blue-600', 'bg-green-600', 'bg-purple-600', 
                'bg-yellow-600', 'bg-pink-600', 'bg-gray-600', 'bg-indigo-900',
                'bg-gradient-to-r from-purple-500 to-pink-500', 'bg-gradient-to-r from-blue-500 to-teal-400'
            ];
            const bgGrid = document.getElementById('nameBackgroundGrid');
            // الإبقاء على خيار "بدون خلفية" وإضافة الباقي
            backgrounds.forEach(bg => {
                const div = document.createElement('div');
                div.className = `cursor-pointer p-2 rounded text-center text-white text-xs ${bg} border border-transparent hover:border-white`;
                div.textContent = 'Aa';
                div.onclick = (e) => selectFeature('nameBackground', bg);
                bgGrid.appendChild(div);
            });

            // 3. إطارات الصور
            const frames = [
                { id: 'frame-none', name: 'بدون' },
                { id: 'frame-gold', name: 'ذهبي' },
                { id: 'frame-silver', name: 'فضي' },
                { id: 'frame-red-glow', name: 'توهج أحمر' },
                { id: 'frame-blue-glow', name: 'توهج أزرق' },
                { id: 'frame-rainbow', name: 'قوس قزح' },
                { id: 'frame-neon-pulse', name: 'نيون' },
                { id: 'frame-fire', name: 'ناري' },
                { id: 'frame-rotating', name: 'دوار' },
                { id: 'frame-diamond-sparkle', name: 'الماس البراق ✨' },
                { id: 'frame-electric', name: 'كهربائي ⚡' },
                { id: 'frame-magic-purple', name: 'سحر بنفسجي 🔮' },
                { id: 'frame-lava', name: 'حمم بركانية 🌋' },
                { id: 'frame-royal-gold', name: 'ذهبي ملكي 👑' },
                { id: 'frame-matrix', name: 'ماتريكس 📟' },
                { id: 'frame-ghostly', name: 'شبح 👻' },
                { id: 'frame-double', name: 'مزدوج' },
                { id: 'frame-dashed', name: 'متقطع' },
                { id: 'frame-golden-rain', name: 'مطر ذهبي 🌧️' },
                { id: 'frame-matrix-rain', name: 'مصفوفة 📟' },
                { id: 'frame-fast-emerald', name: 'زمرد سريع 💎' },
                { id: 'frame-electricity', name: 'كهرباء ⚡' },
                { id: 'frame-crown-gold', name: 'التاج الذهبي', isPremium: true },
                { id: 'frame-crown-rainbow', name: 'التاج الملون', isPremium: true },
                { id: 'frame-blue-fire', name: 'النار الأزرق', isPremium: true },
                { id: 'frame-orange-fire', name: 'نار برتقالية (XP)', isPremium: true }
            ];
            const frameGrid = document.getElementById('avatarFrameGrid');
            frameGrid.innerHTML = '';
            frames.forEach(frame => {
                const div = document.createElement('div');
                const isLocked = frame.isPremium && (!currentUser.ownedItems || !currentUser.ownedItems.includes(frame.id));
                
                div.className = `cursor-pointer p-2 rounded hover:bg-gray-700 flex flex-col items-center ${isLocked ? 'opacity-70' : ''}`;
                
                if (isLocked) {
                    div.onclick = () => showNotification('هذا الإطار مقفل. يمكنك شراؤه من المتجر.', 'warning');
                } else {
                    div.onclick = (e) => selectFeature('avatarFrame', frame.id === 'frame-none' ? null : frame.id);
                }
                
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-gray-600 ${frame.id}"></div>
                    <span class="text-[10px] mt-1 text-slate-300">${frame.name}</span>
                    ${isLocked ? '<span class="text-[9px] text-red-400 font-bold mt-0.5">🔒 مقفلة</span>' : ''}
                `;
                frameGrid.appendChild(div);
            });

            // 4. خلفيات البطاقة
            const cardBackgrounds = [
                'bg-gradient-to-r from-slate-900 to-slate-700', 'bg-gradient-to-r from-zinc-900 to-stone-800',
                'bg-gradient-to-r from-red-900/80 to-red-800/60', 'bg-gradient-to-r from-orange-900/80 to-amber-800/60',
                'bg-gradient-to-r from-yellow-900/80 to-amber-700/60', 'bg-gradient-to-r from-green-900/80 to-emerald-800/60',
                'bg-gradient-to-r from-teal-900/80 to-cyan-800/60', 'bg-gradient-to-r from-blue-900/80 to-indigo-800/60',
                'bg-gradient-to-r from-indigo-900/80 to-violet-800/60', 'bg-gradient-to-r from-purple-900/80 to-fuchsia-800/60',
                'bg-gradient-to-r from-pink-900/80 to-rose-800/60', 'bg-gradient-to-r from-gray-800 to-gray-600'
            ];
            const cardBgGrid = document.getElementById('userCardBackgroundGrid');
            cardBackgrounds.forEach(bg => {
                const div = document.createElement('div');
                div.className = `cursor-pointer h-10 rounded-lg border border-transparent hover:border-white ${bg}`;
                div.onclick = (e) => selectFeature('userCardBackground', bg);
                cardBgGrid.appendChild(div);
            });

            // 5. خلفيات الملف الشخصي
            const profileBgs = [
                'bg-gradient-to-br from-slate-800 to-slate-900',
                'bg-gradient-to-br from-red-800 to-rose-900',
                'bg-gradient-to-br from-sky-800 to-indigo-900',
                'bg-gradient-to-br from-emerald-800 to-teal-900',
                'bg-gradient-to-br from-amber-800 to-orange-900',
                'bg-gradient-to-br from-fuchsia-800 to-purple-900'
            ];
            const profileBgGrid = document.getElementById('profileBackgroundGrid');
            profileBgs.forEach(bg => {
                const div = document.createElement('div');
                div.className = `cursor-pointer h-10 rounded-lg border border-transparent hover:border-white ${bg}`;
                div.onclick = (e) => selectFeature('profileBackground', bg);
                profileBgGrid.appendChild(div);
            });

            // 6. أنواع الخطوط
            const fonts = [
                { id: 'font-cairo', name: 'كايرو (الافتراضي)' },
                { id: 'font-tajawal', name: 'تجوّل' },
                { id: 'font-amiri', name: 'أميري' },
                { id: 'font-aref', name: 'عارف رقعة' },
                { id: 'font-rakkas', name: 'رقّاص' },
                { id: 'font-lemonada', name: 'ليمونادة' },
                { id: 'font-changa', name: 'تشانغا' },
                { id: 'font-messiri', name: 'المسيري' },
                { id: 'font-almarai', name: 'المراعي' },
                { id: 'font-harmattan', name: 'هرمتان' },
                { id: 'font-lalezar', name: 'لاليزار' },
                { id: 'font-mada', name: 'مدى' },
                { id: 'font-reem-kufi', name: 'ريم كوفي' },
                { id: 'font-scheherazade', name: 'شهرزاد' },
                { id: 'font-lateef', name: 'لطيف' },
                { id: 'font-mirza', name: 'ميرزا' },
                { id: 'font-vibes', name: 'فايبس' },
                { id: 'font-katibeh', name: 'كتيبة' },
                { id: 'font-kufam', name: 'كوفم' },
                { id: 'font-readex', name: 'ريدكس' }
            ];
            const fontGrid = document.getElementById('nameFontGrid');
            fontGrid.innerHTML = '';
            fonts.forEach(font => {
                const div = document.createElement('div');
                div.className = `cursor-pointer p-3 rounded text-center border border-gray-600 hover:border-white text-sm ${font.id}`;
                div.textContent = font.name;
                div.onclick = (e) => selectFeature('nameFont', font.id);
                fontGrid.appendChild(div);
            });

            // 6. ألوان إطار البطاقة (بناءً على الإنجازات)
            // ملاحظة: يتم تحديث هذا من بيانات الملف الشخصي
            // سيتم استدعاء updateNameCardBorderGrid عند تحميل بيانات الملف الشخصي
        }

        let currentRoom = null;
        let currentRoomSettings = {
            textColor: 'text-white',
            messageBackground: 'bg-gray-800'
        };
        let currentRoomBackground = null;
        let rooms = [];
        let roomsWithSettings = {};
        let roomsWithBackgrounds = {};
        let sessionChecked = false;
        let privateChatTarget = null;
        let friendRequests = [];
        let privateConversations = {};
        let friendsList = [];
        let userAvatars = {};
        let shopItems = [];
        // تعريف الرتب الافتراضية (سيتم تحديثها من السيرفر)
        let ranks = {
            'صاحب الموقع': { color: 'from-red-600 to-orange-400', icon: '🏆', level: 6 },
            'رئيس': { color: 'from-yellow-400 to-yellow-500', icon: '🎩', level: 5 },
            'رئيسة': { color: 'from-yellow-400 to-yellow-500', icon: '🎩', level: 5 },
            'منشئ': { color: 'from-yellow-400 to-orange-500', icon: '👑', level: 4 },
            'سوبر ادمن': { color: 'from-red-500 to-pink-600', icon: '⭐', level: 3 },
            'ادمن': { color: 'from-purple-500 to-indigo-600', icon: '🛡️', level: 2 },
            'بريميوم': { color: 'from-green-500 to-emerald-600', icon: '💎', level: 2 },
            'جيد': { color: 'from-blue-500 to-cyan-600', icon: '❇️', level: 1 }
        };
        // تعريف الأجنحة وتكوينها
        let wingsConfig = {
            owners: ['صاحب الموقع', 'رئيس', 'رئيسة'],
            kings: ['منشئ', 'سوبر ادمن', 'ادمن'],
            distinguished: ['بريميوم', 'جيد']
        };
        let previousOnlineUsernames = new Set();
        let isFirstUserLoad = true;
        const entrySound = new Audio('https://codeskulptor-demos.commondatastorage.googleapis.com/pang/pop.mp3');
        entrySound.volume = 0.4;
        const leaveSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2776/2776-preview.mp3'); // Leave sound
        leaveSound.volume = 0.6;
        leaveSound.preload = 'auto';

        const mentionSound = new Audio('/sounds/mention.mp3'); // Local mention sound
        mentionSound.volume = 0.8;
        mentionSound.preload = 'auto';

        // محاولة فك حظر الصوت عند أول تفاعل
        const unlockAudio = () => {
            [mentionSound, entrySound, leaveSound].forEach(sound => {
                sound.play().then(() => {
                    sound.pause();
                    sound.currentTime = 0;
                }).catch(e => console.log("Audio unlock failed for", sound.src, e));
            });
            document.removeEventListener('click', unlockAudio);
            document.removeEventListener('keydown', unlockAudio);
        };
        document.addEventListener('click', unlockAudio);
        document.addEventListener('keydown', unlockAudio);
        
        window.onlineUsersData = {}; // تخزين بيانات المستخدمين للوصول السريع
        
        // تنسيق وقت الرسالة بشكل احترافي
        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            // تحويل الطابع الزمني إلى رقم إذا كان نصاً (للتوافق مع BIGINT من قاعدة البيانات)
            const ts = (typeof timestamp === 'string' && /^\d+$/.test(timestamp)) ? Number(timestamp) : timestamp;
            const date = new Date(ts);
            if (isNaN(date.getTime())) return '';
            
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${hours}:${minutes} ${day}/${month}`;
        }
        // --- دوال أيقونات الرتب ---
        let tempRankIcon = null;

        function handleRankIconUpload() {
            const fileInput = document.getElementById('rankIconUpload');
            const file = fileInput.files[0];
            if (file) {
                if (file.size > 500 * 1024) { // 500KB limit
                     showNotification('حجم الصورة كبير جداً (الحد الأقصى 500KB)', 'error');
                     return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempRankIcon = e.target.result;
                    document.getElementById('rankIconPreview').src = tempRankIcon;
                    document.getElementById('rankIconPreviewContainer').classList.remove('hidden');
                    document.getElementById('customRankIcon').disabled = true;
                    document.getElementById('customRankIcon').placeholder = "(تم اختيار صورة)";
                    document.getElementById('customRankIcon').value = '';
                };
                reader.readAsDataURL(file);
            }
        }

        function clearRankIconImage() {
            tempRankIcon = null;
            document.getElementById('rankIconUpload').value = '';
            document.getElementById('rankIconPreviewContainer').classList.add('hidden');
            document.getElementById('customRankIcon').disabled = false;
            document.getElementById('customRankIcon').placeholder = "الأيقونة (مثال: 🚀)";
        }

        function getRankIconHtml(icon, className = "text-xl") {
            // تم إضافة transform: translateY(2px) لإنزال الصورة قليلاً لتكون في نفس مستوى النص
            if (icon && (icon.startsWith('data:image') || icon.startsWith('http'))) return `<img src="${icon}" class="${className} inline-block object-contain" style="width: 1.5em; height: 1.5em; vertical-align: middle; transform: translateY(-3px);">`;
            return `<span class="${className}">${icon || ''}</span>`;
        }

        // --- دوال نافذة إرسال النقاط (تم نقلها إلى النطاق العام) ---

        function openSendPointsModal(username) {
            const modal = document.getElementById('sendPointsModal');
            const title = document.getElementById('sendPointsToUser');
            const input = document.getElementById('pointsAmountInput');

            title.textContent = `إلى المستخدم: ${username}`;
            modal.dataset.username = username;
            input.value = '';
            modal.classList.add('show');
        }

        function closeSendPointsModal() {
            document.getElementById('sendPointsModal').classList.remove('show');
        }

        // --- دوال نافذة المتجر ---
        function openShopModal() {
            const modal = document.getElementById('shopModal');
            const overlay = document.getElementById('shopOverlay');
            modal.classList.add('show');
            overlay.classList.add('show');
            
            // طلب بيانات المتجر من السيرفر
            socket.emit('get shop items');
        }

        function closeShopModal() {
            const modal = document.getElementById('shopModal');
            const overlay = document.getElementById('shopOverlay');
            modal.classList.remove('show');
            overlay.classList.remove('show');
        }

        // --- دوال إرسال النقاط (تم نقلها إلى النطاق العام) ---
        function sendPoints() {
            const toUser = document.getElementById('profileUsername').textContent;
            if (!toUser || toUser === currentUser.name) {
                showNotification('لا يمكنك إرسال نقاط لنفسك.', 'error');
                return;
            }
            openSendPointsModal(toUser);
        }

        function submitSendPoints() {
            const modal = document.getElementById('sendPointsModal');
            const toUser = modal.dataset.username;
            const amountInput = document.getElementById('pointsAmountInput');
            const amount = parseInt(amountInput.value, 10);

            if (isNaN(amount) || amount <= 0) {
                showNotification('يرجى إدخال عدد نقاط صحيح وأكبر من صفر.', 'error');
                return;
            }

            if (amount > 10000) {
                showNotification('الحد الأقصى لإرسال النقاط هو 10,000 نقطة.', 'error');
                return;
            }

            socket.emit('send points', { fromUser: currentUser.name, toUser: toUser, amount: amount });
            closeSendPointsModal();
        }

// استقبال بيانات الصور من السيرفر
    socket.on('user avatars data', (avatarsData) => {
        userAvatars = { ...userAvatars, ...avatarsData };
        updateFriendsList();
        updateOnlineUsersAvatars();
    });
     // طلب بيانات الصور عند الاتصال
    socket.on('connect', () => {
        
        // إعادة الانضمام للغرفة عند استعادة الاتصال
        if (currentUser && currentRoom) {
             socket.emit('join room', { roomId: currentRoom.id, user: currentUser });
             showNotification('تم استعادة الاتصال.', 'success');
        }

        // إذا لم يتم التحقق من الجلسة بعد، اطلب التحقق مرة أخرى
        const savedSession = localStorage.getItem('userSession');
        if (savedSession) {
            try {
                const sessionData = JSON.parse(savedSession);
                if (sessionData && sessionData.sessionId) {
                    socket.emit('check session', sessionData.sessionId);
                }
            } catch (e) { /* ignore */ }
        }
        // تأكيد أن الجلسة قد تمت معالجتها خلال الاتصال
        if (!sessionChecked) {
            // ضع علامة كمنتهية بعد 3 ثواني من الاتصال إذا لم يأت رد
            setTimeout(() => {
                if (!sessionChecked) {
                    console.warn('لم يصل رد التحقق من الجلسة بعد الاتصال. إخفاء شاشة التحميل كحالة افتراضية.');
                    sessionChecked = true;
                    hideLoading();
                }
            }, 3000);
        }
    });

    socket.on('connect_error', (err) => {
        sessionChecked = true;
        hideLoading();
        showNotification('تعذر الاتصال بالسيرفر. تحقق من الشبكة وحاول مرة أخرى.', 'error');
    });

    socket.on('disconnect', (reason) => {
        if (currentRoom) {
            if (reason === 'io server disconnect') {
                showNotification('تم قطع اتصالك من قبل الخادم.', 'error');
            }
            // تم التعديل: عدم الخروج عند الانقطاع المؤقت
            if (reason === 'io server disconnect') {
                goBack(true); 
            }
        }
    });
        // تتبع الرسائل غير المقروءة
let unreadPrivateMessages = {};

// تحديث الإشعارات
function updateUnreadBadges() {
    // تحديث الإشعارات في قائمة الأصدقاء
    const friendElements = document.querySelectorAll('#friendsList .friend-item');
    friendElements.forEach(element => {
        const usernameElement = element.querySelector('.text-white.font-medium');
        if (usernameElement) {
            const username = usernameElement.textContent;
            const unreadCount = unreadPrivateMessages[username] || 0;
            
            // إزالة الإشعارات القديمة إن وجدت
            const existingBadge = element.querySelector('.unread-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // إضافة إشعار جديد إذا كان هناك رسائل غير مقروءة
            if (unreadCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'unread-badge absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white rounded-full text-xs h-5 w-5 flex items-center justify-center';
                badge.textContent = unreadCount;
                
                const avatarContainer = element.querySelector('.relative');
                if (avatarContainer) {
                    avatarContainer.appendChild(badge);
                }
                
                // تحديث الإشعار في زر فحص الملف الشخصي
                const profileButton = element.querySelector('button[onclick^="showUserProfileModal"]');
                if (profileButton) {
                    let profileBadge = profileButton.querySelector('.unread-badge');
                    if (!profileBadge) {
                        profileBadge = document.createElement('span');
                        profileBadge.className = 'unread-badge absolute -top-1 -right-1 bg-red-500 text-white rounded-full text-xs h-4 w-4 flex items-center justify-center';
                        profileButton.style.position = 'relative';
                        profileButton.appendChild(profileBadge);
                    }
                    profileBadge.textContent = unreadCount;
                    profileBadge.classList.remove('hidden');
                }
            } else {
                // إخفاء الإشعار إذا لم توجد رسائل غير مقروءة
                const profileButton = element.querySelector('button[onclick^="showUserProfileModal"]');
                if (profileButton) {
                    const profileBadge = profileButton.querySelector('.unread-badge');
                    if (profileBadge) {
                        profileBadge.classList.add('hidden');
                    }
                }
            }
        }
    });
    
    // تحديث الإشعارات في زر المحادثة في الملف الشخصي
    const privateChatButton = document.getElementById('privateChatButton');
    if (privateChatButton) {
        const username = privateChatButton.getAttribute('data-username');
        if (username) {
            const unreadCount = unreadPrivateMessages[username] || 0;
            
            // إزالة الإشعارات القديمة إن وجدت
            const existingBadge = privateChatButton.querySelector('.unread-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // إضافة إشعار جديد إذا كان هناك رسائل غير مقروءة
            if (unreadCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'unread-badge absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white rounded-full text-xs h-5 w-5 flex items-center justify-center';
                badge.textContent = unreadCount;
                privateChatButton.style.position = 'relative';
                privateChatButton.appendChild(badge);
            }
        }
    }
    
    // تحديث الإشعارات في زر الرسائل الرئيسي
    updateMessagesBadge();
}
        // صور افتراضية
        const defaultAvatars = {
            'boy1': DEFAULT_AVATAR_URL,
            'boy2': DEFAULT_AVATAR_URL,
            'boy3': DEFAULT_AVATAR_URL,
            'girl1': DEFAULT_AVATAR_URL,
            'girl2': DEFAULT_AVATAR_URL,
            'girl3': DEFAULT_AVATAR_URL,
            'guest': DEFAULT_AVATAR_URL
        };

        // عناصر واجهة المستخدم
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const toggleUsersButton = document.getElementById('toggleUsersButton');
        const onlineUsersPanel = document.getElementById('onlineUsersPanel');
        const usersOverlay = document.getElementById('usersOverlay');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const profileButton = document.getElementById('profileButton');
        const messagesButton = document.getElementById('messagesButton');
        const friendsButton = document.getElementById('friendsButton');

        // تحويل بين نماذج التسجيل والدخول والزائر
        loginTab.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            guestForm.classList.add('hidden');
            loginTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 bg-gradient-to-r from-blue-600 to-blue-500 text-white shadow-lg';
            registerTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white';
            guestTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white';
        });

        registerTab.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            guestForm.classList.add('hidden');
            registerTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 bg-gradient-to-r from-green-600 to-emerald-500 text-white shadow-lg';
            loginTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white';
            guestTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white';
        });

        guestTab.addEventListener('click', (e) => {
            e.preventDefault();
            guestForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            registerForm.classList.add('hidden');
            guestTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 bg-gradient-to-r from-purple-600 to-indigo-500 text-white shadow-lg';
            loginTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white';
            registerTab.className = 'tab-button flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all duration-300 text-slate-400 hover:text-white';
        });

        // إضافة معالج لـ rememberMe مخصص
        const rememberMeInput = document.getElementById('rememberMe');
        const rememberMeCustom = document.getElementById('rememberMeCustom');
        if (rememberMeInput && rememberMeCustom) {
            rememberMeInput.addEventListener('change', () => {
                const check = rememberMeCustom.querySelector('div');
                if (rememberMeInput.checked) {
                    check.classList.remove('scale-0');
                    check.classList.add('scale-100');
                    rememberMeCustom.classList.add('border-blue-500');
                } else {
                    check.classList.add('scale-0');
                    check.classList.remove('scale-100');
                    rememberMeCustom.classList.remove('border-blue-500');
                }
            });
        }

        // أحداث الأزرار الجديدة
        profileButton.addEventListener('click', () => {
            showUserProfileModal(currentUser.name);
        });

        messagesButton.addEventListener('click', () => {
            // افتح نافذة المحادثات الخاصة أو قائمة الرسائل
            openFriendsSidebar();
        });

        friendsButton.addEventListener('click', () => {
            openFriendsSidebar();
        });

        // إظهار وإخفاء سبينر التحميل
        function showLoading(statusText = 'يرجى الانتظار...') {
            loadingSpinner.classList.remove('hidden');
            updateLoadingStatus(statusText);
        }

        function updateLoadingStatus(text) {
            const statusEl = document.getElementById('loadingStatus');
            if (statusEl) statusEl.textContent = text;
        }

        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }

        // دالة لتحميل البيانات الخلفية (الملف الشخصي، الأصدقاء، الصور) بعد الدخول
        function loadBackgroundData() {
            if (!currentUser) return;
            console.log('بدء تحميل البيانات الخلفية المجمعة...');
            // استخدام حدث واحد مجمع لتقليل عدد الطلبات وتحسين الأداء على الشبكات الضعيفة
            socket.emit('get initial data', currentUser.name);
        }

        // استقبال البيانات الأولية المجمعة
        socket.on('initial data', (data) => {
            console.log('تم استقبال البيانات الأولية المجمعة');
            if (data.friendRequests) friendRequests = data.friendRequests;
            if (data.friendsList) friendsList = data.friendsList;
            if (data.userAvatars) userAvatars = data.userAvatars;
            
            if (data.unreadCounts) {
                updateMessagesBadge(data.unreadCounts.privateMessages);
                updateNotificationsBadge(data.unreadCounts.notifications > 0);
            }
            
            // تحديث الواجهة
            updateFriendRequests();
            updateFriendsList();
            updateUnreadBadges();
        });

        // التحقق من الجلسة المحفوظة عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', async () => {
            applyBackground(); // تطبيق الخلفية السوداء الافتراضية فوراً
            showLoading('جاري التحقق من الجلسة...');
            try {
                const response = await fetch('/check-auth');
                const data = await response.json();

                if (data.authenticated) {
                    handleSessionValid(data.user);
                } else {
                    handleSessionInvalid();
                }
            } catch (error) {
                console.error('فشل التحقق من المصادقة:', error);
                handleSessionInvalid();
            }
        });


        // استقبال نتائج التحقق من الجلسة
        function handleSessionValid(userData) {
            currentUser = userData;
            // ضمان وجود كافة الحقول في currentUser
            if (userData.nameCardBorder) currentUser.nameCardBorder = userData.nameCardBorder;
            
            updateHeaderUserInfo();
            updateLoadingStatus('تم التحقق بنجاح! جاري الدخول...');
            showNotification(`مرحباً بعودتك ${userData.name}! 😊`, 'success');
            
            // التحقق من صلاحيات المستخدم
            
            // محاولة الانضمام للغرفة المحفوظة بسرعة
            const savedRoom = localStorage.getItem('currentRoom');
            if (savedRoom) {
                try {
                    const roomData = JSON.parse(savedRoom);
                    if (roomData && roomData.id) {
                        // إذا كانت الغرف محملة، ادخل فوراً، وإلا انتظر أول تحديث للغرف
                        if (rooms.length > 0) {
                            updateLoadingStatus('جاري استعادة الغرفة...');
                            rooms.forEach(r => {
                                if (r.background) roomsWithBackgrounds[r.id] = r.background;
                                if (r.settings) roomsWithSettings[r.id] = r.settings;
                            });
                            openChat(roomData.id, roomData.name, roomData.icon);
                        } else {
                            // سنقوم بالدخول للغرفة بمجرد استقبال 'rooms update' الأول
                            const entryHandler = (updatedRooms) => {
                                updateLoadingStatus('جاري تحميل بيانات الغرف...');
                                // تحديث البيانات أولاً
                                updatedRooms.forEach(room => {
                                    if (room.settings) roomsWithSettings[room.id] = room.settings;
                                    if (room.background) roomsWithBackgrounds[room.id] = room.background;
                                });
                                rooms = updatedRooms;
                                openChat(roomData.id, roomData.name, roomData.icon);
                                socket.off('rooms update', entryHandler); // إزالة المعالج بعد الدخول
                            };
                            socket.on('rooms update', entryHandler);
                            // حد زمني للانتظار
                            setTimeout(() => socket.off('rooms update', entryHandler), 5000);
                            showMainPage();
                        }
                        return;
                    }
                } catch (e) {
                    localStorage.removeItem('currentRoom');
                }
            }

            showMainPage();
            hideLoading();
        }

        function handleSessionInvalid() {
            console.log('الجلسة غير صالحة، جاري تنظيف البيانات المحلية...');
            localStorage.removeItem('currentRoom');
            currentUser = null;
            sessionChecked = true;
            hideLoading();
            document.getElementById('loginPage').classList.remove('hidden');
        }

        // دالة مساعدة لتطبيق لون الاسم (كلاس أو ستايل)
        function getUserNameStyle(colorValue) {
            if (!colorValue) return { class: 'text-gray-200', style: '' };
            if (colorValue.startsWith('color:')) {
                return { class: '', style: `color: ${colorValue.split(':')[1]}` };
            }
            if (colorValue.startsWith('text-gradient-')) {
                return { class: colorValue, style: '' };
            }
            return { class: colorValue, style: '' };
        }

        // تحديث معلومات المستخدم في الرأس
        function updateHeaderUserInfo() {
            if (currentUser) {
                // إظهار زر غرفة التحكم لصاحب الموقع
                const adminControlRoomBtn = document.getElementById('adminControlRoomBtn');
                if (adminControlRoomBtn) {
                    if (currentUser.isSiteOwner || currentUser.name === 'Walid dz 31') {
                        adminControlRoomBtn.classList.remove('hidden');
                    } else {
                        adminControlRoomBtn.classList.add('hidden');
                    }
                }

                const headerUsernameElem = document.getElementById('headerUsername');
                if (headerUsernameElem) {
                    headerUsernameElem.textContent = currentUser.name;
                }
                
                const headerAvatarContainer = document.querySelector('#profileButton .w-8.h-8');
                if (headerAvatarContainer) {
                    headerAvatarContainer.style.border = '';
                    if (currentUser.avatarFrame && currentUser.avatarFrame.startsWith('border-color:')) {
                        headerAvatarContainer.className = `w-8 h-8 rounded-full flex items-center justify-center text-white relative`;
                        headerAvatarContainer.style.border = `2px solid ${currentUser.avatarFrame.split(':')[1]}`;
                    } else {
                        headerAvatarContainer.className = `w-8 h-8 rounded-full flex items-center justify-center text-white relative ${currentUser.avatarFrame || 'bg-blue-600'}`;
                    }
                    const headerAvatarInitialElem = document.getElementById('headerAvatarInitial');
                    if (headerAvatarInitialElem) {
                        headerAvatarInitialElem.textContent = currentUser.name.charAt(0).toUpperCase();
                    }
                }
                
                // تحديث الصورة إذا كانت موجودة
                socket.emit('get avatar', currentUser.name);
            }
        }

        socket.on('avatar data', (data) => {
            if (data.username === currentUser.name && data.avatarUrl) {
                const headerAvatar = document.querySelector('#profileButton .w-8.h-8');
                if (headerAvatar) {
                    let frameStyle = '';
                    let frameClass = '';
                    if (currentUser.avatarFrame && currentUser.avatarFrame.startsWith('border-color:')) {
                        frameStyle = `border: 2px solid ${currentUser.avatarFrame.split(':')[1]};`;
                    } else {
                        frameClass = currentUser.avatarFrame || '';
                    }
                    headerAvatar.innerHTML = `<div class="w-full h-full rounded-full relative ${frameClass}" style="${frameStyle}"><img src="${data.avatarUrl}" class="w-full h-full rounded-full object-cover" alt="${data.username}"></div>`;
                    headerAvatar.className = "w-8 h-8 rounded-full flex items-center justify-center text-white relative";
                }
            }
        });

        // معالجة تسجيل الدخول
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            showLoading('جاري تسجيل الدخول...');
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            socket.emit('user login', { username, password, rememberMe });
        });

        // استخراج كود الدعوة من الرابط إن وجد
        const urlParams = new URLSearchParams(window.location.search);
        const referralCode = urlParams.get('ref');

        // معالجة إنشاء حساب
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            showLoading('جاري إنشاء الحساب...');
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const gender = document.querySelector('input[name="gender"]:checked')?.value;
            
            if (!gender) {
                showNotification('يرجى اختيار الجنس!', 'error');
                hideLoading();
                return;
            }
            
            socket.emit('user register', { 
                username, 
                password, 
                gender,
                referredBy: referralCode // إرسال كود الدعوة للسيرفر
            });
        });

        // معالجة دخول زائر
        guestForm.addEventListener('submit', (e) => {
            e.preventDefault();
            showLoading('جاري الدخول كزائر...');
            const username = document.getElementById('guestUsername').value;
            const gender = document.querySelector('input[name="guestGender"]:checked')?.value;
            
            // تحقق من وجود ايموجي
            const emojiRegex = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/u;
            if (emojiRegex.test(username)) {
                showNotification('عذراً، لا يمكن استخدام الرموز التعبيرية (Emojis) في اسم الزائر!', 'error');
                hideLoading();
                return;
            }

            if (!gender) {
                showNotification('يرجى اختيار الجنس!', 'error');
                hideLoading();
                return;
            }
            
            socket.emit('user guest login', { username, gender });
        });

        // استقبال نتائج دخول الزائر
        socket.on('guest success', (userData) => {
            currentUser = userData;
            updateLoadingStatus('تم الدخول بنجاح!');
            handleSessionValid(userData);
        });

        socket.on('guest error', (error) => {
            showNotification(error, 'error');
            hideLoading();
        });

        // استقبال نتائج تسجيل الدخول
        socket.on('login success', (userData) => {
            // تعيين الكوكي لجلسة الدخول
            currentUser = userData; // تحديث المستخدم الحالي فوراً
            currentUser.nameColor = userData.nameColor; // التأكد من تحديث لون الاسم
            currentUser.bio = userData.bio; // التأكد من تحديث الـ bio
            currentUser.nameBackground = userData.nameBackground;
            currentUser.avatarFrame = userData.avatarFrame;
            currentUser.userCardBackground = userData.userCardBackground;
            currentUser.profileBackground = userData.profileBackground;
            currentUser.profileCover = userData.profileCover;
            currentUser.nameCardBorder = userData.nameCardBorder;
            currentUser.status = userData.status;
            currentUser.country = userData.country;
            currentUser.age = userData.age;
            currentUser.nameFont = userData.nameFont;

            document.cookie = `sessionId=${userData.sessionId}; path=/; max-age=31536000; SameSite=Lax`; // صلاحية لمدة سنة
            updateLoadingStatus('تم تسجيل الدخول! جاري تحضير الواجهة...');
            handleSessionValid(userData);
            // بعد تسجيل الدخول الناجح، تحقق من صلاحيات المستخدم
            if (currentUser) {
                toggleBackgroundButton();
            }

        });

        socket.on('login error', (error) => {
            showNotification(error, 'error');
            hideLoading();
        });

        // استقبال نتائج إنشاء الحساب
        socket.on('register success', (userData) => {
            // تعيين الكوكي لجلسة الدخول
            currentUser = userData; // تحديث المستخدم الحالي فوراً
            currentUser.nameColor = null; // القيمة الافتراضية للحساب الجديد
            currentUser.bio = null; // القيمة الافتراضية للحساب الجديد
            currentUser.nameCardBorder = null;
            currentUser.nameFont = null;

            document.cookie = `sessionId=${userData.sessionId}; path=/; max-age=31536000; SameSite=Lax`; // صلاحية لمدة سنة
            updateLoadingStatus('تم إنشاء الحساب! مرحباً بك...');
            handleSessionValid(userData);
            
            // بعد إنشاء الحساب، تحقق من صلاحيات المستخدم
            if (currentUser) {
                toggleBackgroundButton();
            }
        });

        socket.on('register error', (error) => {
            showNotification(error, 'error');
            hideLoading();
        });

        // دالة لتحديث تكوين الأجنحة بناءً على الرتب
        function updateWingsConfig() {
            // إعادة تعيين التكوين
            wingsConfig = { owners: [], kings: [], distinguished: [] };
            
            // توزيع الرتب على الأجنحة
            for (const [rankName, rankData] of Object.entries(ranks)) {
                if (rankData.wingId === 'owners' || rankData.level >= 5) wingsConfig.owners.push(rankName);
                else if (rankData.wingId === 'kings' || rankData.level >= 3) wingsConfig.kings.push(rankName);
                else if (rankData.wingId === 'distinguished' || rankData.level >= 2) wingsConfig.distinguished.push(rankName);
            }
            // تحديث القائمة إذا كانت معروضة
            const currentUsers = Array.from(document.querySelectorAll('#onlineUsersList > div[data-username]')).map(el => ({name: el.dataset.username, rank: ranks[el.dataset.username]?.rank})); // هذا تقريبي، الأفضل إعادة طلب القائمة
        }

        // استقبال تحديث الغرف
        socket.on('rooms update', (updatedRooms) => {
            rooms = updatedRooms;
            loadRooms();
        });

        // استقبال تحديث المستخدمين
        socket.on('users update', (users) => {
            updateOnlineUsersList(users);
        });

        // استقبال رسائل جديدة
        socket.on('new message', (message) => {
            if (message.type === 'user' || (message.type === 'image' && message.user) || message.replyTo) {
                addMessageToChat(message.user, message.content, message.time, message.user === currentUser.name, message.rank, message.avatar, message.messageId, message.replyTo, null, message.timestamp, message.badges, message.nameCardBorder, message.nameFont);
            } else if (message.type === 'system') {
                addSystemMessage(message, message.time, null, message.timestamp);
            } else {
                addSystemMessage(message, message.time, null, message.timestamp);
            }
            // تمرير إلى الأسفل عند استقبال رسالة جديدة
            setTimeout(scrollToBottom, 100);
        });

        // استقبال تاريخ المحادثة (محدث لدعم الصور)
socket.on('chat history', (messages) => {
    updateLoadingStatus('جاري تحميل الرسائل...');
    const container = document.getElementById('messagesContainer');
    container.innerHTML = '';

    // إضافة زر تحميل المزيد في الأعلى
    const loadMoreBtn = document.createElement('button');
    loadMoreBtn.id = 'loadMoreBtn';
    loadMoreBtn.className = 'w-full py-2 text-sm text-blue-400 hover:text-blue-300 transition-colors mb-2 font-medium';
    loadMoreBtn.innerHTML = '<span>↻ تحميل رسائل أقدم</span>';
    loadMoreBtn.onclick = loadMoreMessages;
    // إخفاء الزر إذا كانت الرسائل قليلة جداً (أقل من الحد الأدنى للدفعة)
    if (messages.length < 25) loadMoreBtn.style.display = 'none';
    
    container.appendChild(loadMoreBtn);
    
    // استخدام DocumentFragment لتحسين الأداء (إضافة دفعة واحدة)
    const fragment = document.createDocumentFragment();
    
    messages.forEach(msg => {
        // إذا لم يوجد messageId، أنشئ واحد حقيقي وفوري
        if (!msg.messageId) {
            msg.messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        if (msg.type === 'user') {
            addMessageToChat(msg.user, msg.content, msg.time, msg.user === currentUser.name, msg.rank, msg.avatar, msg.messageId, msg.replyTo, fragment, msg.timestamp, msg.badges, msg.nameCardBorder, msg.nameFont);
        } else if (msg.type === 'image') {
            addImageMessageToChat(msg.user, msg.imageData, msg.time, msg.user === currentUser.name, msg.rank, msg.avatar, msg.messageId, fragment, msg.timestamp, msg.replyTo, msg.badges, msg.nameCardBorder, msg.nameFont);
        } else {
            addSystemMessage(msg, msg.time, fragment, msg.timestamp);
        }
    });
    
    container.appendChild(fragment);
    
    // التمرير للأسفل فقط عند الدخول الأولي
    setTimeout(() => {
        container.scrollTop = container.scrollHeight;
    }, 100);
    updateLoadingStatus('اكتمل التحميل!');
    hideLoading();
    loadBackgroundData(); // تحميل باقي البيانات الآن بعد عرض الرسائل
});

        // دالة طلب المزيد من الرسائل
        function loadMoreMessages() {
            const container = document.getElementById('messagesContainer');
            // البحث عن أول رسالة فعلية (تجاهل زر التحميل)
            const firstMessage = container.querySelector('.chat-message');
            if (!firstMessage) return;

            const firstMessageId = firstMessage.getAttribute('data-message-id');
            if (!firstMessageId) return;

            const btn = document.getElementById('loadMoreBtn');
            if (btn) btn.innerHTML = '<span class="spinner inline-block w-4 h-4 border-2 border-blue-400 border-t-transparent rounded-full animate-spin ml-2"></span> جاري التحميل...';

            socket.emit('load more messages', {
                roomId: currentRoom.id,
                firstMessageId: firstMessageId
            });
        }

        // استقبال الرسائل القديمة
        socket.on('more chat history', (messages) => {
            const btn = document.getElementById('loadMoreBtn');
            if (messages.length === 0) {
                if (btn) btn.style.display = 'none';
                return;
            }
            if (btn) btn.innerHTML = '<span>↻ تحميل رسائل أقدم</span>';

            const container = document.getElementById('messagesContainer');
            const oldHeight = container.scrollHeight;
            const fragment = document.createDocumentFragment();

            messages.forEach(msg => {
                if (msg.type === 'user') {
                    addMessageToChat(msg.user, msg.content, msg.time, msg.user === currentUser.name, msg.rank, msg.avatar, msg.messageId, msg.replyTo, fragment, msg.timestamp, msg.badges, msg.nameCardBorder, msg.nameFont);
                } else if (msg.type === 'image') {
                    addImageMessageToChat(msg.user, msg.imageData, msg.time, msg.user === currentUser.name, msg.rank, msg.avatar, msg.messageId, fragment, msg.timestamp, msg.replyTo, msg.badges, msg.nameCardBorder, msg.nameFont);
                }
            });

            // إدراج الرسائل بعد زر التحميل وقبل الرسائل الحالية
            container.insertBefore(fragment, btn.nextSibling);
            
            // الحفاظ على موقع التمرير
            container.scrollTop = container.scrollHeight - oldHeight;
        });

        socket.on('feature success', (msg) => {
            showNotification(msg, 'success');
        });

        socket.on('feature error', (msg) => {
            showNotification(msg, 'error');
        });

        // استقبال نتائج الرتب
        socket.on('rank success', (message) => {
            showNotification(message, 'success');
        });

        socket.on('rank error', (error) => {
            showNotification(error, 'error');
        });
        
        socket.on('rank expired', (message) => {
            showNotification(message, 'warning');
        });

        socket.on('show ranks', (message) => {
            addSystemMessage(message.content, message.time);
        });

        // استقبال أخطاء الرسائل
        socket.on('message error', (error) => {
            showNotification(error, 'error');
        });

        // استقبال أحداث الصور
        socket.on('avatar updated', (data) => {
            showNotification(`تم تحديث الصورة الشخصية لـ ${data.username}`, 'success');
            updateHeaderUserInfo();
            // تحديث الصورة في الملف الشخصي إذا كان مفتوحاً
            const profileUsername = document.getElementById('profileUsername').textContent;
            if (profileUsername === data.username) {
                const profileAvatar = document.getElementById('profileAvatar');
                if (profileAvatar) {
                    profileAvatar.src = data.avatarUrl;
                    
                    // تحديث زر الحذف إذا كان المستخدم هو صاحب الملف
                    if (data.username === currentUser.name) {
                        const removeProfilePicBtn = document.getElementById('removeProfilePicBtn');
                        if (removeProfilePicBtn) {
                            if (data.avatarUrl && data.avatarUrl !== DEFAULT_AVATAR_URL) {
                                removeProfilePicBtn.classList.remove('hidden');
                            } else {
                                removeProfilePicBtn.classList.add('hidden');
                            }
                        }
                    }
                }
            }
        });

        socket.on('avatar error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('user avatar updated', (data) => {
            updateOnlineUsersAvatars(data.username, data.avatarUrl);
            // تحديث الصورة في الملف الشخصي إذا كان مفتوحاً
            const profileUsername = document.getElementById('profileUsername').textContent;
            if (profileUsername === data.username) {
                const profileAvatar = document.getElementById('profileAvatar');
                if (profileAvatar) profileAvatar.src = data.avatarUrl;
            }
        });

        // استقبال نتائج إدارة المستخدمين
        socket.on('management success', (message) => {
            showNotification(message, 'success');
        });

        socket.on('management error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('user status', (message) => {
            addSystemMessage(message.content, message.time);
        });

        // استقبال حالات الحظر
        socket.on('banned from room', (data) => {
            showNotification(`تم حظرك من غرفة ${data.room}. السبب: ${data.reason}`, 'error');
            goBack();
        });

        socket.on('banned from site', (data) => {
            showNotification(`تم حظرك من الموقع بالكامل. السبب: ${data.reason}`, 'error');
            logout();
        });

        socket.on('user deleted', () => {
            showNotification('تم حذف حسابك من قبل الإدارة', 'error');
            logout();
        });

        socket.on('user warned', (data) => {
            // عرض تنبيه منبثق للمستخدم
            alert(`⚠️ تنبيه إداري!\n\nتم توجيه تحذير لك من قبل ${data.from}.\nالسبب: ${data.reason}`);
            showNotification(`⚠️ تحذير: ${data.reason}`, 'warning');
        });

        // استقبال بيانات الملف الشخصي
        socket.on('user profile data', (data) => {
            showUserProfile(data);
        });

        // استقبال رسائل خاصة
        socket.on('private message sent', (message) => {
            addPrivateMessageToChat(message, true);
        });

        socket.on('new private message', (message) => {
    if (privateChatTarget && message.from === privateChatTarget) {
        addPrivateMessageToChat(message, false);
    } else {
        // زيادة عدد الرسائل غير المقروءة لهذا المستخدم
        if (!unreadPrivateMessages[message.from]) {
            unreadPrivateMessages[message.from] = 0;
        }
        unreadPrivateMessages[message.from]++;
        
        // تحديث الإشعارات
        updateUnreadBadges();
        
        showDot('messages', true);
        showNotification(`رسالة خاصة جديدة من ${message.from}`, 'info');
        // طلب تحديث العداد من السيرفر لضمان الدقة (عدد المحادثات وليس الرسائل)
        socket.emit('get unread counts', currentUser.name);
    }
});

        // استقبال تاريخ المحادثة الخاصة (محدث لدعم الصور)
socket.on('private messages history', (messages) => {
    const container = document.getElementById('privateChatMessages');
    if (!container) return;
    
    // إزالة مؤشر التحميل أو تفريغ المحتوى القديم
    container.innerHTML = '';
    
    if (messages.length === 0) {
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full text-slate-500 opacity-50">
                <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <p class="text-sm">لا توجد رسائل سابقة</p>
            </div>
        `;
        return;
    }
    
    messages.forEach(msg => {
        if (msg.type === 'image') {
            addPrivateImageMessage(msg, msg.from === currentUser.name);
        } else {
            addPrivateMessageToChat(msg, msg.from === currentUser.name);
        }
    });
    
    setTimeout(() => {
        container.scrollTop = container.scrollHeight;
    }, 100);
});

        // استقبال أحداث نظام الصداقات
        socket.on('new friend request', (data) => { 
            showNotification(`طلب صداقة جديد من ${data.fromUser}`, 'info'); 
            // إضافة الطلب محلياً فوراً
            if (!friendRequests.includes(data.fromUser)) {
                friendRequests.push(data.fromUser);
            }
            updateFriendRequests();
            updateMessagesBadge();
            showDot('friends', true);
        });

        socket.on('new notification', (notification) => {
            showNotification(`🔔 لديك إشعار جديد من ${notification.senderUsername}!`, 'info');
            updateNotificationsBadge(true); // إظهار النقطة الحمراء فوراً
            showDot('master', true); // إظهار النقطة الرئيسية
        });

        socket.on('friend request sent', (message) => {
            showNotification(message, 'success');
            // تحديث زر إضافة صديق إذا كان الملف الشخصي مفتوحاً
            const addFriendButton = document.getElementById('addFriendButton');
            if (addFriendButton && addFriendButton.style.display !== 'none') {
                addFriendButton.innerHTML = `
                    <span>تم الإرسال</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                `;
                addFriendButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                addFriendButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                addFriendButton.disabled = true;
            }
        });

        socket.on('friend request error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('friend request accepted', (data) => {
            showNotification(`قبل ${data.byUser} طلب الصداقة`, 'success');
            // إضافة الصديق محلياً فوراً
            if (!friendsList.some(f => f.username === data.byUser)) {
                friendsList.push({
                    username: data.byUser,
                    avatar: userAvatars[data.byUser] || DEFAULT_AVATAR_URL,
                    isOnline: window.onlineUsersData && window.onlineUsersData[data.byUser] ? true : false,
                    lastSeen: null
                });
            }
            // إزالة من طلبات الصداقة إن وجد
            friendRequests = friendRequests.filter(u => u !== data.byUser);
            
            updateFriendsList();
            updateFriendRequests();
            
            // تحديث زر الملف الشخصي إذا كان مفتوحاً لهذا المستخدم
            const profileUsername = document.getElementById('profileUsername').textContent;
            if (profileUsername === data.byUser) {
                const addFriendButton = document.getElementById('addFriendButton');
                if (addFriendButton) {
                    addFriendButton.innerHTML = `
                        <span>حذف الصديق</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"></path>
                        </svg>
                    `;
                    addFriendButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-blue-600', 'bg-gray-600', 'hover:bg-gray-700');
                    addFriendButton.classList.add('bg-red-600', 'hover:bg-red-700');
                    addFriendButton.disabled = false;
                    addFriendButton.onclick = () => removeFriend(data.byUser);
                }
            }
        });

        socket.on('friend request processed', (message) => {
            showNotification(message, 'success');
            
            // تحديث زر الملف الشخصي إذا كان مفتوحاً
            const profileUsername = document.getElementById('profileUsername').textContent;
            if (profileUsername && message.includes(profileUsername)) {
                if (!friendsList.includes(profileUsername)) {
                    friendsList.push(profileUsername);
                }
                const addFriendButton = document.getElementById('addFriendButton');
                if (addFriendButton) {
                    addFriendButton.innerHTML = `
                        <span>حذف الصديق</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"></path>
                        </svg>
                    `;
                    addFriendButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-blue-600', 'bg-gray-600', 'hover:bg-gray-700');
                    addFriendButton.classList.add('bg-red-600', 'hover:bg-red-700');
                    addFriendButton.disabled = false;
                    addFriendButton.onclick = () => removeFriend(profileUsername);
                }
            }
            
            socket.emit('get friend requests', currentUser.name);
            socket.emit('get friends list', currentUser.name);
        });

        socket.on('friend removed', (message) => {
            showNotification(message, 'success');
            // تحديث قائمة الأصدقاء من السيرفر
            socket.emit('get friends list', currentUser.name);
            
            // إعادة تعيين الزر في الملف الشخصي إذا كان مفتوحاً
            const addFriendButton = document.getElementById('addFriendButton');
            if (addFriendButton && addFriendButton.style.display !== 'none') {
                addFriendButton.innerHTML = `
                    <span>إضافة صديق</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                    </svg>
                `;
                addFriendButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-gray-600', 'hover:bg-gray-700');
                addFriendButton.classList.add('bg-green-600', 'hover:bg-green-700');
                addFriendButton.disabled = false;
                addFriendButton.onclick = sendFriendRequest;
            }
        });

        socket.on('friend removed you', (data) => {
            showNotification(`أزالك ${data.byUser} من قائمة الأصدقاء`, 'info');
            updateFriendsList();
        });

        // استقبال إشعار فتح إنجاز جديد
        socket.on('achievement_unlocked', (data) => {
            const ach = data.achievement;
            showNotification(`🏆 تهانينا! لقد حصلت على وسام جديد: ${ach.name}`, 'success');
            
            // تحديث بيانات المستخدم المحلي فوراً
            if (currentUser) {
                currentUser.badges = data.allBadges || [];
            }

            // تشغيل صوت الإنجاز إذا وجد أو صوت النجاح
            if (window.successSound) successSound.play().catch(e => {});
        });

        socket.on('friend error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('friend requests list', (requests) => {
            friendRequests = requests;
            updateFriendRequests();
            updateMessagesBadge();
        });

        socket.on('friends list', (friends) => {
            friendsList = friends;
            updateFriendsList();
        });

        socket.on('search results', (results) => {
            displaySearchResults(results);
        });


        // إظهار/إخفاء قائمة المتصلين للجوال
        toggleUsersButton.addEventListener('click', toggleUsersList);
        
        function toggleUsersList() {
            onlineUsersPanel.classList.toggle('show');
            usersOverlay.classList.toggle('show');
        }

        function openFriendsSidebar() {
            document.getElementById('friendsSidebar').classList.add('show');
            document.getElementById('friendsOverlay').classList.add('show');
            showDot('friends', false);
        }

        function closeFriendsSidebar() {
            document.getElementById('friendsSidebar').classList.remove('show');
            document.getElementById('friendsOverlay').classList.remove('show');
        }

        // تحديث طلبات الصداقة
        function updateFriendRequests() {
            const container = document.getElementById('friendRequestsList');
            const countElement = document.getElementById('friendRequestsCount');
            
            if (!container || !countElement) return;
            
            container.innerHTML = '';
            countElement.textContent = friendRequests.length;
            
            if (friendRequests.length === 0) {
                container.innerHTML = '<p class="text-blue-200 text-sm text-center">لا توجد طلبات صداقة</p>';
                return;
            }
            
            friendRequests.forEach(username => {
                const requestDiv = document.createElement('div');
                requestDiv.className = 'flex items-center justify-between bg-white/5 rounded-lg p-3 friend-item';
                requestDiv.innerHTML = `
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <div class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-white">
                            ${username.charAt(0).toUpperCase()}
                        </div>
                        <span class="text-white font-medium">${username}</span>
                    </div>
                    <div class="flex space-x-2 space-x-reverse">
                        <button onclick="acceptFriendRequest('${username}')" class="text-green-500 hover:text-green-300">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </button>
                        <button onclick="rejectFriendRequest('${username}')" class="text-red-500 hover:text-red-300">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;
                container.appendChild(requestDiv);
            });
        }

         // تحديث قائمة الأصدقاء مع الصور
        function updateFriendsList() {
            const container = document.getElementById('friendsList');
            const countElement = document.getElementById('friendsCount');
            if (!container || !countElement) return;

            countElement.textContent = friendsList.length;
            container.innerHTML = '';

            if (friendsList.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-sm text-center">لا يوجد أصدقاء بعد.</p>';
                return;
            }

            // ترتيب الأصدقاء: المتصلون أولاً، ثم حسب آخر ظهور
            friendsList.sort((a, b) => {
                if (a.isOnline && !b.isOnline) return -1;
                if (!a.isOnline && b.isOnline) return 1;
                return (b.lastSeen || 0) - (a.lastSeen || 0);
            });

            friendsList.forEach(friend => {
                const avatarUrl = friend.avatar || DEFAULT_AVATAR_URL;
                const friendDiv = document.createElement('div');
                friendDiv.className = 'flex items-center justify-between bg-white/5 rounded-lg p-3 friend-item';

                let statusHtml = '';
                if (friend.isOnline) {
                    statusHtml = '<span class="text-green-400 text-xs">متصل الآن</span>';
                } else if (friend.lastSeen) {
                    statusHtml = `<span class="text-slate-400 text-xs">${getTimeAgo(new Date(friend.lastSeen))}</span>`;
                } else {
                    statusHtml = '<span class="text-slate-500 text-xs">غير معروف</span>';
                }

                friendDiv.innerHTML = `
                    <div class="flex items-center space-x-3 space-x-reverse flex-1 min-w-0">
                        <div class="relative flex-shrink-0">
                            <img src="${avatarUrl}" class="w-10 h-10 rounded-full object-cover" alt="${friend.username}">
                            ${friend.isOnline ? '<span class="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full bg-green-500 border-2 border-gray-800"></span>' : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-white font-semibold truncate">${friend.username}</p>
                            ${statusHtml}
                        </div>
                    </div>
                    <div class="flex space-x-1 space-x-reverse flex-shrink-0">
                        <button onclick="openPrivateChat('${friend.username}'); closeFriendsSidebar();" class="text-blue-400 hover:text-blue-300 p-2 rounded-full hover:bg-blue-500/10 transition-colors" title="محادثة خاصة"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg></button>
                        <button onclick="showUserProfileModal('${friend.username}')" class="text-slate-400 hover:text-white p-2 rounded-full hover:bg-white/10 transition-colors" title="عرض الملف الشخصي"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></button>
                    </div>
                `;
                container.appendChild(friendDiv);
            });
        }

    // متغير لتخزين عدد المحادثات غير المقروءة من السيرفر
    let globalUnreadConversations = 0;

    // تحديث شارة الرسائل (موحدة)
    function updateMessagesBadge(count) {
        const chatBadge = document.getElementById('chatMessagesBadge');
        
        if (typeof count === 'number') {
            globalUnreadConversations = count;
        }
        
        // العدد الإجمالي = عدد المحادثات غير المقروءة فقط
        const totalUnread = globalUnreadConversations;

        if (chatBadge) {
            if (totalUnread > 0) {
                chatBadge.textContent = totalUnread;
                chatBadge.classList.remove('hidden');
            } else {
                chatBadge.classList.add('hidden');
            }
        }
    }

        // البحث عن مستخدمين
        function searchUsers(event) {
            if (event) event.preventDefault();
            const query = document.getElementById('userSearchInput').value.trim();
            
            if (query.length < 2) {
                showNotification('يرجى إدخال حرفين على الأقل للبحث', 'error');
                return;
            }
            
            socket.emit('search users', {
                query: query,
                currentUser: currentUser.name
            });
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (!container) return;
            
            container.innerHTML = '';
            container.classList.remove('hidden');
            
            if (results.length === 0) {
                container.innerHTML = '<p class="text-blue-200 text-sm text-center">لا توجد نتائج</p>';
                return;
            }
            
            results.forEach(username => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'flex items-center justify-between py-2';
                resultDiv.innerHTML = `
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <div class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-white">
                            ${username.charAt(0).toUpperCase()}
                        </div>
                        <span class="text-white font-medium">${username}</span>
                    </div>
                    <button onclick="showUserProfileModal('${username}')" class="text-blue-500 hover:text-blue-300 text-sm">
                        عرض الملف
                    </button>
                `;
                container.appendChild(resultDiv);
            });
        }

        // إرسال طلب صداقة
        function sendFriendRequest() {
            const profileUsername = document.getElementById('profileUsername').textContent;
            
            if (profileUsername === currentUser.name) {
                showNotification('لا يمكنك إرسال طلب صداقة لنفسك', 'error');
                return;
            }
            
            socket.emit('send friend request', {
                fromUser: currentUser.name,
                toUser: profileUsername
            });
        }

        // قبول طلب صداقة
        function acceptFriendRequest(username) {
            socket.emit('accept friend request', {
                fromUser: username,
                toUser: currentUser.name
            });
        }

        // رفض طلب صداقة
        function rejectFriendRequest(username) {
            socket.emit('reject friend request', {
                fromUser: username,
                toUser: currentUser.name
            });
        }

        // إزالة صديق
        function removeFriend(username) {
            if (confirm(`هل تريد بالتأكيد إزالة ${username} من قائمة أصدقائك؟`)) {
                socket.emit('remove friend', {
                    username: currentUser.name,
                    friendToRemove: username
                });
            }
        }

        // عرض الصفحة الرئيسية
        function showMainPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            updateWelcomeMessage();
            
            // إخفاء الأزرار من رأس الصفحة الرئيسية
            document.getElementById('postsButton').parentElement.classList.add('hidden');
            document.getElementById('messagesButton').parentElement.classList.add('hidden');
            document.getElementById('friendsButton').classList.add('hidden');
            
            // طلب قائمة الغرف من السيرفر
            fetch('/api/rooms')
                .then(response => response.json())
                .then(data => {
                    rooms = data;
                    loadRooms();
                });
            
            // إظهار الإعلان المخزن إذا وجد
            if (window.latestAnnouncementData) {
                updateAnnouncementUI(window.latestAnnouncementData);
            }
        }

        // تحديث رسالة الترحيب
        function updateWelcomeMessage() {
            const welcomeElement = document.getElementById('welcomeMessage');
            if (welcomeElement && currentUser) {
                let rankBadge = '';
                if (currentUser.rank) {
                    const rankInfo = ranks[currentUser.rank] || { icon: '' };
                    // استخدام دالة getRankIconHtml لتحويل كود الصورة إلى صورة فعلية
                    const iconHtml = getRankIconHtml(rankInfo.icon, "text-xl");
                    rankBadge = `<span class="inline-flex items-center mx-1" dir="ltr">(${currentUser.rank} ${iconHtml})</span>`;
                }
                welcomeElement.innerHTML = `🏠 مرحباً ${currentUser.name} ${rankBadge}`;
            }
        }

        // تحميل الغرف
        function loadRooms() {
            const roomsContainer = document.getElementById('roomsContainer');
            if (!roomsContainer) return;
            
            // استخدام DocumentFragment لتحسين الأداء
            const fragment = document.createDocumentFragment();
            
            // فرز الغرف قبل العرض
            const sortedRooms = [...rooms].sort((a, b) => (a.order - b.order) || (a.id - b.id));
            
            sortedRooms.forEach(room => {
                const roomDiv = document.createElement('div');
                roomDiv.className = room.protected ? 
                    'bg-gradient-to-br from-red-900/30 to-orange-900/30 backdrop-blur-lg rounded-2xl p-6 hover:from-red-800/40 hover:to-orange-800/40 transition-all duration-300 relative group border-2 border-red-500/50' :
                    'bg-white/10 backdrop-blur-lg rounded-2xl p-6 hover:bg-white/20 transition-all duration-300 relative group';
                
                roomDiv.innerHTML = `
                    <div class="absolute top-4 right-4 bg-blue-600/50 text-white text-xs font-bold px-2.5 py-1 rounded-full flex items-center space-x-1 space-x-reverse backdrop-blur-sm">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <span>${room.userCount !== undefined ? room.userCount : (room.users ? room.users.length : 0)}</span>
                    </div>
                    <div class="cursor-pointer" onclick="${room.protected ? `openProtectedChat(${room.id}, '${room.name}', '${room.icon}')` : `openChat(${room.id}, '${room.name}', '${room.icon}')`}">
                        <div class="text-4xl mb-4 text-center">${room.icon}</div>
                        <h3 class="text-xl font-semibold text-white text-center mb-2">${room.name}</h3>
                        <p class="text-blue-200 text-center text-sm">${room.description}</p>
                        ${room.managers && room.managers.length > 0 ? `
                            <div class="mt-3 pt-3 border-t border-white/20">
                                <p class="text-xs text-slate-300 mb-1">👮 مديرو الغرفة:</p>
                                <p class="text-xs text-yellow-300 font-semibold">${room.managers.join(', ')}</p>
                            </div>
                        ` : ''}
                        <div class="mt-4 text-center">
                            <span class="${room.protected ? 'bg-red-600' : 'bg-gray-500'} text-white px-3 py-1 rounded-full text-xs">
                                ${room.protected ? '🔒 محمية' : 'انقر للدخول'}
                            </span>
                        </div>
                    </div>
                `;
                
                fragment.appendChild(roomDiv);
            });

            // إضافة غرفة التحكم لصاحب الموقع فقط
            if (currentUser && (currentUser.isSiteOwner || currentUser.name === 'Walid dz 31')) {
                const controlDiv = document.createElement('div');
                controlDiv.className = 'bg-gradient-to-br from-slate-800 to-slate-900 border-2 border-blue-500/50 rounded-2xl p-6 hover:shadow-[0_0_20px_rgba(59,130,246,0.5)] transition-all duration-300 relative group cursor-pointer';
                controlDiv.onclick = openControlPanel;
                
                controlDiv.innerHTML = `
                    <div class="absolute top-4 right-4 bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded-full">
                        خاص
                    </div>
                    <div class="text-4xl mb-4 text-center">⚙️</div>
                    <h3 class="text-xl font-bold text-white text-center mb-2">غرفة التحكم</h3>
                    <p class="text-slate-400 text-center text-sm">لوحة إدارة الموقع الشاملة</p>
                    <div class="mt-4 text-center">
                        <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-xs">دخول المالك</span>
                    </div>
                `;
                fragment.appendChild(controlDiv);
            }

            // استبدال المحتوى دفعة واحدة
            roomsContainer.innerHTML = '';
            roomsContainer.appendChild(fragment);
        }

        // فتح غرفة الدردشة
        function openChat(roomId, roomName, icon) {
            // لا نحتاج لإظهار شاشة تحميل كاملة تعطل المستخدم
            // سنكتفي بتبديل الواجهة فوراً
            
            // إعادة تعيين تتبع المستخدمين عند دخول غرفة جديدة
            previousOnlineUsernames.clear();
            isFirstUserLoad = true;

            currentRoom = { id: roomId, name: roomName, icon: icon };
            
            // جلب إعدادات الغرفة
            const roomSettings = roomsWithSettings[roomId] || {
                textColor: 'text-white',
                messageBackground: 'bg-gray-800'
            };
            currentRoomSettings = roomSettings;
            
            // جلب خلفية الغرفة
            let roomBackground = roomsWithBackgrounds[roomId];
            
            // محاولة إضافية للبحث في مصفوفة الغرف إذا لم تكن موجودة في الخريطة
            if (!roomBackground && rooms.length > 0) {
                const roomInList = rooms.find(r => r.id === roomId);
                if (roomInList && roomInList.background) {
                    roomBackground = roomInList.background;
                    roomsWithBackgrounds[roomId] = roomBackground;
                }
            }

            if (roomBackground) {
                currentRoomBackground = roomBackground;
                applyBackground(roomBackground, true);
            } else {
                // تطبيق الخلفية الافتراضية إذا لم تكن هناك خلفية مخصصة
                applyBackground({ type: 'color', value: '#000000' }, true);
            }
            
            // حفظ الغرفة الحالية
            localStorage.setItem('currentRoom', JSON.stringify(currentRoom));
            
            // تبديل الواجهات فوراً
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('chatPage').classList.remove('hidden');
            document.getElementById('chatTitle').textContent = roomName;
            document.getElementById('chatIcon').textContent = icon;
            
            // تهيئة الحاوية لتكون جاهزة (فارغة مؤقتاً)
            const container = document.getElementById('messagesContainer');
            updateLoadingStatus('جاري الاتصال بالغرفة...');
            container.innerHTML = '<div class="flex items-center justify-center h-full"><div class="text-gray-400">جاري تحميل المحادثة...</div></div>';

            // إظهار الأزرار في رأس المحادثة
            document.getElementById('chatPostsButton').classList.remove('hidden');
            document.getElementById('chatMessagesButtonContainer').classList.remove('hidden');
            document.getElementById('chatFriendsButton').classList.remove('hidden');
            
            // إخفاء زر الملف الشخصي في رأس المحادثة
            document.getElementById('profileButton').classList.add('hidden');
            
            // إظهار/إخفاء لوحات الإدارة بناءً على نوع الغرفة
            const rankPanel = document.getElementById('rankManagementPanel');
            const userPanel = document.getElementById('userManagementPanel');
            const messageInputContainer = document.getElementById('messageInputContainer');
            
            if (roomName === 'غرفة الإدارة') {
                rankPanel.classList.remove('hidden');
                userPanel.classList.remove('hidden');
                messageInputContainer.classList.remove('hidden');
            } else {
                rankPanel.classList.add('hidden');
                userPanel.classList.add('hidden');
                messageInputContainer.classList.remove('hidden');
            }
            
            // الانضمام للغرفة في الخلفية
            socket.emit('join room', { roomId, user: currentUser });
        }

        // فتح غرفة محمية بكلمة سر
        function openProtectedChat(roomId, roomName, icon) {
            let password = '';
            
            if (roomName === 'غرفة الإدارة') {
                password = prompt('أدخل كلمة سر غرفة الإدارة:');
                if (password !== 'admin123') {
                    showNotification('كلمة السر غير صحيحة!', 'error');
                    return;
                }
            }
            
            openChat(roomId, roomName, icon);
        }

        // العودة إلى الصفحة الرئيسية
        function goBack(isDisconnected = false) {
    if (currentRoom) {
        socket.emit('leave room', { roomId: currentRoom.id, user: currentUser });
        localStorage.removeItem('currentRoom');
    }
    document.getElementById('chatPage').classList.add('hidden');
    document.getElementById('mainPage').classList.remove('hidden');
    document.getElementById('messagesContainer').innerHTML = '';

    if (isDisconnected) {
        showNotification('لقد فقدت الاتصال بالغرفة بسبب الخمول.', 'warning');
    }
    
    // إخفاء الأزرار في رأس المحادثة عند العودة
    document.getElementById('chatPostsButton').classList.add('hidden');
    document.getElementById('chatMessagesButtonContainer').classList.add('hidden');
    document.getElementById('chatFriendsButton').classList.add('hidden');
    
    // إعادة إظهار زر الملف الشخصي في الرأس
    document.getElementById('profileButton').classList.remove('hidden');
    
    // تطبيق خلفية الموقع السوداء الافتراضية عند العودة
    applyBackground();
    
    currentRoom = null;
}

        // تسجيل الخروج
        // ...existing code...
let manualLogout = false;

function logout() {
    manualLogout = true;
    if (currentRoom) {
        socket.emit('leave room', { roomId: currentRoom.id, user: currentUser });
    }
    
    // إبلاغ السيرفر بتسجيل الخروج
    socket.emit('logout');
    
    localStorage.removeItem('currentRoom');
    document.cookie = "sessionId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"; 
    
    // إعادة تحميل الصفحة لضمان تنظيف كامل للاتصال والذاكرة
    location.reload(); 
}

// منع حذف الجلسة عند إغلاق الصفحة إلا إذا كان logout حقيقي
window.addEventListener('beforeunload', function (e) {
    if (!manualLogout) {
        // لا تحذف الجلسة
        return;
    }
    // إذا كان logout حقيقي، احذف الجلسة
    localStorage.removeItem('currentRoom');
});
// ...existing code...

        // إرسال رسالة
        function sendMessage() {
            const input = document.getElementById('messageInput');
            
            // التحقق من طول الرسالة قبل المعالجة
            if (input.value.length > 300) {
                showNotification('الرسالة طويلة جداً (الحد الأقصى 300 حرف)', 'error');
                return;
            }

            const message = input.value.trim();
            const replyPreview = document.getElementById('replyPreview');
            let replyTo = null;

            if (!replyPreview.classList.contains('hidden')) {
                const isImage = document.getElementById('replyContent').getAttribute('data-is-image') === 'true';
                replyTo = {
                    messageId: replyPreview.getAttribute('data-reply-id'),
                    user: document.getElementById('replyUsername').textContent,
                    content: isImage ? document.getElementById('replyContent').getAttribute('data-image-url') : document.getElementById('replyContent').textContent
                };
            }
           
            if (message && currentUser && currentRoom) {
                socket.emit('send message', { 
                    roomId: currentRoom.id, 
                    message, 
                    user: currentUser,
                    replyTo: replyTo
                });
                input.value = '';
                cancelReply(); // إلغاء وضع الرد بعد الإرسال
            }
        }

        // التعامل مع الضغط على مفتاح Enter
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // التحقق من طول الرسالة
        function checkMessageLength() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendMessageButton');
            if (input.value.length > 300) {
                sendBtn.disabled = true;
                sendBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                sendBtn.classList.add('bg-gray-500');
            } else {
                sendBtn.disabled = false;
                sendBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                sendBtn.classList.remove('bg-gray-500');
            }
        }

        function formatLinks(text) {
            const allEmojis = [...new Set([...animatedEmojis, ...localEmojis])];
            
            let result = text;
            let insideTag = false;
            let output = '';
            
            for (let i = 0; i < result.length; i++) {
                if (result[i] === '<') insideTag = true;
                if (result[i] === '>') insideTag = false;
                
                if (!insideTag) {
                    const remaining = result.substring(i);
                    const urlMatch = remaining.match(/^(https?:\/\/[^\s<]+)/);
                    
                    if (urlMatch) {
                        const url = urlMatch[1];
                        if (allEmojis.includes(url)) {
                            output += url;
                        } else {
                            output += `<a href="${url}" target="_blank" class="text-blue-400 underline hover:text-blue-300 transition-colors">${url}</a>`;
                        }
                        i += url.length - 1;
                        continue;
                    }
                }
                
                output += result[i];
            }
            
            return output;
        }

        function formatMessageWithInlineEmojis(text) {
            let result = text;
            
            const allEmojis = [...new Set([...animatedEmojis, ...localEmojis])];
            
            allEmojis.forEach(emojiUrl => {
                const escapedUrl = emojiUrl.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(escapedUrl, 'g');
                result = result.replace(regex, `<img src="${emojiUrl}" class="h-5 w-auto inline-block align-middle mx-0.5 object-contain" alt="" style="vertical-align: middle;">`);
            });
            
            return result;
        }

        // إضافة رسالة إلى الدردشة (نسخة مدمجة)
function addMessageToChat(user, message, time, isOwn, userRank, avatarUrl, messageId = null, replyTo = null, targetContainer = null, timestamp = null, badges = null, nameCardBorder = null, nameFont = null) {
    let formattedMessage;
    
    if (animatedEmojis.includes(message) || localEmojis.includes(message)) {
        formattedMessage = `<img src="${message}" class="h-6 w-auto inline-block object-contain" alt="" onerror="this.style.display='none'">`;
    } else {
        formattedMessage = formatMessageWithInlineEmojis(message);
        formattedMessage = formatLinks(formattedMessage);
    }
    
    // خاصية المنشن
    let isMentioned = false;
    if (currentUser && message.includes(`@${currentUser.name}`)) {
        isMentioned = true;
        // تلوين الاسم باللون الأصفر فقط للمستخدم المذكور
        const mentionRegex = new RegExp(`@${currentUser.name}(?![\\w\\u0600-\\u06FF])`, 'g');
        formattedMessage = formattedMessage.replace(mentionRegex, `<span class="text-yellow-400 font-bold bg-yellow-400/10 px-1 rounded">@${currentUser.name}</span>`);
        
        // تشغيل صوت العصفور إذا كانت رسالة حية (تم استبعاد شرط isOwn للسماح بالتجربة الشخصية)
        if (!targetContainer && userSettings.playMentionSound) {
            mentionSound.play().catch(e => console.log("Audio play blocked:", e));
        }
    }

    const container = targetContainer || document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');    
    messageDiv.setAttribute('data-message-id', messageId);
   
    const timeStr = formatMessageTime(timestamp || Date.now());
   
    let rankBadge = '';
   
    if (userRank) {
        const rankInfo = ranks[userRank] || {}; 
        const iconHtml = getRankIconHtml(rankInfo.icon, "text-base");
        // إضافة align-middle لضمان المحاذاة
        rankBadge = `<span title="${userRank}" class="mx-1 inline-flex items-center align-middle">${iconHtml}</span>`;
    }

    // إحضار عدد الأوسمة
    let achievementCount = 0;
    if (badges && Array.isArray(badges)) {
        achievementCount = badges.length;
    } else {
        const onlineUserForBadges = isOwn ? currentUser : (window.onlineUsersData ? window.onlineUsersData[user] : null);
        achievementCount = (onlineUserForBadges && onlineUserForBadges.badges) ? onlineUserForBadges.badges.length : 0;
    }
    const achievementCountBadge = achievementCount > 0 ? `<div class="achievement-count-badge" title="${achievementCount} أوسمة">${achievementCount}</div>` : '';

    // --- إصلاح: تحديد لون الاسم والخلفية والإطار بشكل صحيح ---
    let nameColorClass, nameBgClass, avatarFrameClass, currentNameCardBorder, nameFontClass;

    if (isOwn) {
        nameColorClass = currentUser.nameColor || 'text-blue-100';
        nameBgClass = currentUser.nameBackground || '';
        avatarFrameClass = currentUser.avatarFrame || '';
        currentNameCardBorder = nameCardBorder || currentUser.nameCardBorder || null;
        nameFontClass = nameFont || currentUser.nameFont || '';
    } else {
        // استخدام البيانات المخزنة في الذاكرة بدلاً من البحث في DOM (أسرع بكثير)
        const onlineUser = window.onlineUsersData ? window.onlineUsersData[user] : null;
        if (onlineUser) {
            nameColorClass = (onlineUser.nameColor && onlineUser.nameColor !== 'null') ? onlineUser.nameColor : 'text-blue-200';
            nameBgClass = (onlineUser.nameBackground && onlineUser.nameBackground !== 'null') ? onlineUser.nameBackground : '';
            avatarFrameClass = (onlineUser.avatarFrame && onlineUser.avatarFrame !== 'null') ? onlineUser.avatarFrame : '';
            currentNameCardBorder = nameCardBorder || onlineUser.nameCardBorder || null;
            nameFontClass = nameFont || onlineUser.nameFont || '';
        } else {
            nameColorClass = 'text-blue-200';
            nameBgClass = '';
            avatarFrameClass = '';
            currentNameCardBorder = nameCardBorder || null;
            nameFontClass = nameFont || '';
        }
    }

    // تجهيز نمط إطار الفقاعة
    let bubbleStyle = '';
    if (currentNameCardBorder && currentNameCardBorder.startsWith('border-color:')) {
        bubbleStyle = `border: 2px solid ${currentNameCardBorder.split(':')[1]};`;
    }

    // زر الحذف: يظهر دائماً للاختبار
    // --- تعديل: فصل الأزرار عن القائمة ---
    let directActions = '';
    let menuBtn = '';
    if (messageId && user) { // التأكد من وجود المستخدم لتجنب الأخطاء
        const isMessageOwner = user === currentUser.name;
        const canDelete = 
            (currentUser.isSiteOwner) || 
            (isMessageOwner && currentUser.rank); 

        // زر الرد يظهر للجميع
        directActions = `
            <button class="hover:opacity-80 transition-opacity" title="رد" onclick="startReply('${messageId}', '${user}', '${message.replace(/'/g, "\\'")}')">
                <span class="inline-flex items-center justify-center w-5 h-5 bg-slate-700 rounded text-white shadow-sm">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                </span>
            </button>
        `;

        // إضافة زر الحذف فقط إذا كان مسموحاً
        if (canDelete) {
            directActions += `
                <button class="text-gray-400 hover:text-red-500 transition-colors" title="حذف" onclick="deleteRoomMessage('${messageId}')">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>`;
        }

        const myLevel = currentUser.rank ? (ranks[currentUser.rank]?.level || 0) : 0;
        const targetLevel = userRank ? (ranks[userRank]?.level || 0) : 0;
        const canManage = (currentUser.isSiteOwner || (myLevel > targetLevel && myLevel >= 2)) && !isMessageOwner;

        if (canManage) {
            menuBtn = `
            <div class=\"relative inline-block ml-2\">
                <button class=\"menu-btn text-gray-400 hover:text-blue-500 text-xl font-bold\" title=\"خيارات إضافية\" data-message-id=\"${messageId}\" data-user=\"${user}\" data-content=\"${message.replace(/'/g, "\\'")}\">⋮</button>
                <div class=\"message-menu hidden absolute left-0 z-50 bg-slate-800 text-white rounded shadow-lg mt-2 min-w-[160px] text-sm border border-slate-700\">
                    <button class=\"block w-full text-right px-4 py-2 hover:bg-slate-700\" data-action=\"mute\">🔇 كتم المستخدم</button>
                    <button class=\"block w-full text-right px-4 py-2 hover:bg-slate-700\" data-action=\"unmute\">🔊 إلغاء كتم المستخدم</button>
                    <button class=\"block w-full text-right px-4 py-2 hover:bg-slate-700\" data-action=\"warn\">⚠️ تحذير المستخدم</button>
                    <button class=\"block w-full text-right px-4 py-2 hover:bg-slate-700\" data-action=\"banRoom\">🚫 حظر من الغرفة</button>
                    <button class=\"block w-full text-right px-4 py-2 hover:bg-slate-700\" data-action=\"unbanRoom\">✅ إلغاء حظر الغرفة</button>
                </div>
            </div>
            `;
        }
    }

    let replyHtml = '';
    if (replyTo) {
        // التحقق مما إذا كان المحتوى يحتوي على إيموجي (سواء وحده أو مع نص)
        const allEmojis = [...new Set([...animatedEmojis, ...localEmojis])];
        const containsEmoji = replyTo.content && allEmojis.some(e => replyTo.content.includes(e));
        const isImageReply = replyTo.content && (replyTo.content.startsWith('data:image') || replyTo.content.startsWith('http') || replyTo.content.includes('🖼️ صورة') || replyTo.content.includes('صورة 🖼️'));
        
        let displayContent = replyTo.content;
        if (containsEmoji) {
            displayContent = formatMessageWithInlineEmojis(replyTo.content);
        } else if (isImageReply) {
            displayContent = 'صورة 🖼️';
        }

        // تطبيق تلوين المنشن في الرد أيضاً
        if (!isImageReply && currentUser && displayContent && typeof displayContent === 'string' && displayContent.includes(`@${currentUser.name}`)) {
            const mentionRegex = new RegExp(`@${currentUser.name}\\b`, 'g');
            displayContent = displayContent.replace(mentionRegex, `<span class="text-yellow-400 font-bold">@${currentUser.name}</span>`);
        }

        // البحث عن أول إيموجي لعرضه في المعاينة إذا لم تكن صورة
        let emojiPreviewUrl = null;
        if (containsEmoji && !isImageReply) {
            emojiPreviewUrl = allEmojis.find(e => replyTo.content.includes(e));
        }

        const imagePreview = (isImageReply || emojiPreviewUrl) 
            ? `<img src="${isImageReply ? replyTo.content : emojiPreviewUrl}" class="w-10 h-10 rounded-md object-cover ml-2 border border-white/10 shadow-sm">` 
            : '';

        replyHtml = `
            <a href="#${replyTo.messageId}" onclick="scrollToMessage('${replyTo.messageId}')" class="block bg-black/20 hover:bg-black/30 p-2 rounded-lg mb-2 text-xs border-r-4 border-blue-500 transition-colors">
                <div class="flex items-center justify-between gap-3">
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-blue-400 mb-0.5">الرد على ${replyTo.user}</div>
                        <p class="opacity-70 truncate text-slate-300">${displayContent}</p>
                    </div>
                    ${imagePreview}
                </div>
            </a>
        `;
    }


    const avatarHtml = avatarUrl 
        ? `<div class="w-full h-full rounded-full relative ${(avatarFrameClass && !avatarFrameClass.startsWith('border-color:')) ? avatarFrameClass : ''}" style="${(avatarFrameClass && avatarFrameClass.startsWith('border-color:')) ? `border: 2px solid ${avatarFrameClass.split(':')[1]};` : ''}">${achievementCountBadge}<img src="${avatarUrl}" class="w-full h-full rounded-full object-cover" alt="${user}"></div>`
        : `<div class="w-full h-full rounded-full relative bg-gray-400 flex items-center justify-center text-white font-bold text-sm ${(avatarFrameClass && !avatarFrameClass.startsWith('border-color:')) ? avatarFrameClass : ''}" style="${(avatarFrameClass && avatarFrameClass.startsWith('border-color:')) ? `border: 2px solid ${avatarFrameClass.split(':')[1]};` : ''}">${achievementCountBadge}${user.charAt(0).toUpperCase()}</div>`;

    // --- التصميم الجديد المدمج ---
    const messageBgClass = currentRoomSettings?.messageBackground || 'bg-gray-800';
    const messageTextColorClass = currentRoomSettings?.textColor || 'text-white';
    
    messageDiv.innerHTML = `
        <div class="flex items-start gap-3">
            <div class="avatar-container flex-shrink-0 cursor-pointer" onclick="showUserProfileModal('${user}')">
                ${avatarHtml}
            </div>
            <div class="flex items-end gap-2 flex-wrap">
                <div class="message-bubble relative ${messageBgClass + ' ' + messageTextColorClass} rounded-lg p-2 min-w-[50px]" style="${bubbleStyle}">
                    ${replyHtml}
                    <div class="message-content leading-snug flex items-center flex-wrap gap-1">
                        ${rankBadge}
                        <span class="username-text font-bold cursor-pointer ${nameColorClass} ${nameBgClass ? nameBgClass + ' px-1 rounded' : ''} ${nameFontClass}" onclick="mentionUser('${user}')">${user}</span>
                        <span class="font-bold">:</span>
                        <span class="break-words">${formattedMessage}</span>
                    </div>
                </div>
                <div class="flex items-center gap-1 mb-1 message-actions">
                    <span class="timestamp-text opacity-70 text-gray-400 text-[10px] ml-1">${timeStr}</span> 
                    ${directActions}
                    ${menuBtn}
                </div>
            </div>
        </div>
    `;

    messageDiv.className = `chat-message flex flex-row items-start w-full px-0 user-message`;

    container.appendChild(messageDiv);
    // التمرير فقط إذا كانت رسالة حية (ليست جزءاً من التاريخ)
    if (!targetContainer) {
        scrollToBottom();
    }
}

// --- إعادة بناء نظام قائمة خيارات الرسالة ---

// 1. إغلاق جميع القوائم المفتوحة
function closeAllMessageMenus() {
    document.querySelectorAll('.message-menu').forEach(m => m.classList.add('hidden'));
}

// 2. معالج النقر العام
document.addEventListener('click', function(e) {
    const menuButton = e.target.closest('.menu-btn');
    const menuOption = e.target.closest('.message-menu button');

    if (menuButton) {
        // إذا تم النقر على زر القائمة (⋮)
        e.stopPropagation();
        const menu = menuButton.nextElementSibling;
        const isHidden = menu.classList.contains('hidden');
        closeAllMessageMenus(); // أغلق أي قائمة أخرى
        if (isHidden) {
            menu.classList.remove('hidden'); // افتح القائمة الحالية
        }
    } else if (menuOption) {
        // إذا تم النقر على خيار داخل القائمة
        e.stopPropagation();
        const action = menuOption.dataset.action;
        const button = menuOption.closest('.relative').querySelector('.menu-btn');
        const messageId = button.dataset.messageId;
        const user = button.dataset.user; // اسم المستخدم محفوظ في الزر
        const content = button.dataset.content;

        switch (action) {
            case 'reply':
                startReply(messageId, user, content);
                break;
            case 'delete':
                deleteRoomMessage(messageId);
                break;
            case 'mute':
                if (confirm(`هل تريد كتم المستخدم ${user}؟`)) {
                    socket.emit('mute user', { username: user, duration: 60, currentUser });
                }
                break;
            case 'unmute':
                if (confirm(`هل تريد إلغاء كتم المستخدم ${user}؟`)) {
                    socket.emit('unmute user', { username: user, currentUser });
                }
                break;
            case 'banRoom':
                if (confirm(`هل تريد حظر المستخدم ${user} من هذه الغرفة؟`)) {
                    socket.emit('ban from room', { username: user, reason: 'تم الحظر من خلال الرسالة', currentUser });
                }
                break;
            case 'unbanRoom':
                if (confirm(`هل تريد إلغاء حظر المستخدم ${user} من هذه الغرفة؟`)) {
                    socket.emit('unban from room', { username: user, currentUser });
                }
                break;
            case 'warn':
                const reason = prompt(`أدخل سبب التحذير للمستخدم ${user}:`);
                if (reason !== null) {
                    socket.emit('warn user', { username: user, reason, currentUser });
                }
                break;
        }
        closeAllMessageMenus();
    } else {
        // إغلاق قوائم الرسائل والايموجيات عند النقر في الخارج
        closeAllMessageMenus();
    }
    
    const emojiPicker = document.getElementById('emojiPicker');
    const privateEmojiPicker = document.getElementById('privateEmojiPicker');
    const emojiButton = e.target.closest('#emojiButton');
    const privateEmojiButton = e.target.closest('#privateEmojiButton');
    
    if (emojiPicker && emojiPicker.classList.contains('show') && !emojiButton && !e.target.closest('#emojiPicker')) {
        emojiPicker.classList.remove('show');
    }
    if (privateEmojiPicker && privateEmojiPicker.classList.contains('show') && !privateEmojiButton && !e.target.closest('#privateEmojiPicker')) {
        privateEmojiPicker.classList.remove('show');
    }
});

// دوال الرد على الرسائل (تم نقلها إلى المكان الصحيح)
function startReply(messageId, user, content) {
    const replyPreview = document.getElementById('replyPreview');
    const replyUsername = document.getElementById('replyUsername');
    const replyContent = document.getElementById('replyContent');

    replyPreview.setAttribute('data-reply-id', messageId);
    replyUsername.textContent = user;
    
    // التعامل مع محتوى الصور في المعاينة بشكل احترافي
    if (content && (content.startsWith('data:image') || content.startsWith('http'))) {
        replyContent.innerHTML = `
            <div class="flex items-center gap-2">
                <img src="${content}" class="w-10 h-10 rounded-md object-cover border border-white/20 shadow-sm">
                <span class="text-gray-400 italic">صورة</span>
            </div>
        `;
        replyContent.setAttribute('data-is-image', 'true');
        replyContent.setAttribute('data-image-url', content);
    } else {
        replyContent.textContent = content;
        replyContent.removeAttribute('data-is-image');
        replyContent.removeAttribute('data-image-url');
    }

    replyPreview.classList.remove('hidden');
    document.getElementById('messageInput').focus();

    // إغلاق قائمة الخيارات
    closeAllMessageMenus();
}

function cancelReply() {
    const replyPreview = document.getElementById('replyPreview');
    replyPreview.classList.add('hidden');
    replyPreview.removeAttribute('data-reply-id');
}

function scrollToMessage(messageId) {
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    if (messageElement) {
        messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // إضافة تأثير وميض مؤقت
        messageElement.classList.add('animate-pulse');
        setTimeout(() => { messageElement.classList.remove('animate-pulse'); }, 2000);
    }
}

        // إضافة رسالة نظام (نسخة مدمجة)
function addSystemMessage(message, time, targetContainer = null, timestamp = null) {
    const container = targetContainer || document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    
    // إضافة معرف الرسالة لتمكين الحذف الفوري
    if (typeof message === 'object' && message.messageId) {
        messageDiv.setAttribute('data-message-id', message.messageId);
    }
    
    // التحقق مما إذا كانت رسالة انضمام
    if (typeof message === 'object' && message.subType === 'join') {
        messageDiv.className = 'chat-message flex flex-row items-start w-full my-1 px-0';
        const iconHtml = message.rankIcon ? getRankIconHtml(message.rankIcon, "text-xs") : '';
        
        // إضافة زر الحذف إذا كان المستخدم هو صاحب الرسالة أو صاحب الموقع
        let deleteBtn = '';
        if (message.messageId && (message.user === currentUser.name || currentUser.isSiteOwner)) {
            deleteBtn = `<button onclick="deleteRoomMessage('${message.messageId}')" class="text-gray-400 hover:text-red-500 transition-colors" title="حذف"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
        }

        // تحديد كلاس الخلفية (إما نارية أو الافتراضية)
        const bgClass = message.joinBg ? message.joinBg : 'bg-[#2c2c2c]/80 backdrop-blur-sm border-white/5';
        const textClass = message.joinBg ? 'text-white' : 'text-gray-200';

        messageDiv.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="avatar-container flex-shrink-0 cursor-pointer" onclick="showUserProfileModal('${message.user}')">
                    <img src="${message.avatar || 'icon.png'}" class="w-8 h-8 rounded-full border border-red-500/50 object-cover" alt="Avatar">
                </div>
                <div class="flex items-end gap-2 flex-wrap">
                    <div class="${bgClass} px-3 py-1.5 rounded-lg shadow-sm border flex items-center flex-wrap text-sm">
                        <span class="${textClass} font-bold cursor-pointer hover:underline" onclick="mentionUser('${message.user}')">${message.user}</span>
                        <span class="text-red-500 font-bold mx-1">انضم للغرفة</span>
                        ${message.rank ? `<span class="text-gray-400 text-xs">(# ${message.rank} #)</span>` : ''}
                    </div>
                    <div class="flex items-center gap-1 mb-1 message-actions">
                        ${deleteBtn}
                    </div>
                </div>
            </div>
        `;
    } else {
        const content = typeof message === 'object' ? message.content : message;
        const timeStr = formatMessageTime(timestamp || Date.now());
        
        // استثناء: رسائل النظام تستخدم ألوانها الخاصة دائماً ولا تتأثر بإعدادات الغرفة
        let statusColorClass = 'text-white'; 
        if (typeof message === 'object' && message.systemStatus) {
            if (message.systemStatus === 'positive') statusColorClass = 'text-green-400';
            else if (message.systemStatus === 'negative') statusColorClass = 'text-red-400';
        }

        // استثناء: رسائل النظام تستخدم دائماً فقاعة رمادية داكنة افتراضية ولا تتأثر بإعدادات الغرفة
        const messageBgClass = 'bg-gray-800'; 
        const messageTextColorClass = statusColorClass;

        messageDiv.className = 'chat-message flex flex-row items-start w-full px-0 system-message'; // إضافة class للتمييز
        messageDiv.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="avatar-container flex-shrink-0 cursor-pointer" id="${currentUser.name === SITE_OWNER.username ? 'changeBotAvatarBtn' : ''}" onclick="${currentUser.name === SITE_OWNER.username ? 'triggerBotAvatarUpload()' : ''}">
                    <img src="${typeof BOT_AVATAR_URL !== 'undefined' ? BOT_AVATAR_URL : (typeof DEFAULT_AVATAR_URL !== 'undefined' ? DEFAULT_AVATAR_URL : 'icon.png')}" class="w-8 h-8 rounded-full border border-blue-500/50 object-cover" alt="System Bot">
                </div>
                <div class="flex items-end gap-2 flex-wrap">
                    <div class="message-bubble relative ${messageBgClass} ${messageTextColorClass} rounded-lg p-2 min-w-[50px] border border-white/5">
                        <div class="message-content leading-snug flex items-center flex-wrap gap-1">
                            <span class="username-text font-bold text-blue-400 cursor-pointer hover:underline" onclick="mentionUser('رسائل النظام')">رسائل النظام</span>
                            <span class="font-bold">:</span>
                            <span class="break-words font-semibold">${content}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-1 mb-1 message-actions">
                        <span class="timestamp-text opacity-70 text-gray-400 text-[10px] ml-1">${timeStr}</span> 
                    </div>
                </div>
            </div>
        `;
    }
   
    container.appendChild(messageDiv);
    if (!targetContainer) {
        scrollToBottom();
    }
}


        // تحديث قائمة المستخدمين المتصلين مع الترتيب حسب الرتبة
function updateOnlineUsersList(users) {
    const onlineUsersList = document.getElementById('onlineUsersList');
    const onlineUsersCount = document.getElementById('onlineUsersCount');
    
    if (!onlineUsersList || !onlineUsersCount) return;
    
    // عد المستخدمين المتصلين فعلياً فقط
    const realOnlineCount = users.filter(u => u.isOnline !== false).length;
    onlineUsersCount.textContent = realOnlineCount;
    
    const fragment = document.createDocumentFragment();
    
    const wings = [
        {
            id: 'owners',
            title: '👑 جناح صاحب الموقع',
            ranks: wingsConfig.owners,
            classes: 'bg-gradient-to-r from-red-900 via-red-800 to-orange-900 text-yellow-100 border-y border-yellow-500/50 shadow-[0_0_15px_rgba(220,38,38,0.3)]'
        },
        {
            id: 'kings',
            title: '🛡️ جناح الملوك',
            ranks: wingsConfig.kings,
            classes: 'bg-gradient-to-r from-indigo-900 via-purple-900 to-slate-900 text-purple-100 border-y border-purple-500/50 shadow-[0_0_15px_rgba(124,58,237,0.3)]'
        },
        {
            id: 'distinguished',
            title: '💎 جناح الاعضاء المميزين',
            ranks: wingsConfig.distinguished,
            classes: 'bg-gradient-to-r from-emerald-900 via-teal-900 to-slate-900 text-emerald-100 border-y border-emerald-500/50 shadow-[0_0_15px_rgba(16,185,129,0.3)]'
        },
        {
            id: 'members',
            title: '👥 متصلون',
            ranks: [], 
            classes: 'bg-gray-800/80 text-gray-300 border-y border-gray-700'
        },
        {
            id: 'offline',
            title: '💤 غير متصل',
            ranks: [],
            classes: 'bg-gray-900/90 text-gray-500 border-y border-gray-800'
        }
    ];

    let shouldPlaySound = false;
    const groupedUsers = { owners: [], kings: [], distinguished: [], members: [], offline: [] };
    
    window.onlineUsersData = {};

    users.forEach(user => {
        if (user.name === currentUser.name) {
            currentUser.nameColor = user.nameColor;
        }

        // تخزين البيانات للوصول السريع
        window.onlineUsersData[user.name] = user;

        if (user.isOnline === false) {
            groupedUsers.offline.push(user);
            return;
        }

        const rank = user.rank;
        if (wings[0].ranks.includes(rank)) {
            groupedUsers.owners.push(user);
        } else if (wings[1].ranks.includes(rank)) {
            groupedUsers.kings.push(user);
        } else if (wings[2].ranks.includes(rank)) {
            groupedUsers.distinguished.push(user);
        } else {
            groupedUsers.members.push(user);
        }
    });

    const sortUsers = (userList) => {
        return userList.sort((a, b) => {
            const rankA = a.rank ? ranks[a.rank]?.level || 0 : 0; 
            const rankB = b.rank ? ranks[b.rank]?.level || 0 : 0; 
            if (a.rank === 'صاحب الموقع') return -1;
            if (b.rank === 'صاحب الموقع') return 1;
            return rankB - rankA; 
        });
    };

    const currentOnlineUsernames = new Set();

    wings.forEach(wing => {
        const wingUsers = sortUsers(groupedUsers[wing.id]);
        
        if (wingUsers.length > 0) {
            const wingHeader = document.createElement('div');
            wingHeader.className = `py-2 px-3 mb-2 mt-2 font-bold text-sm text-center uppercase tracking-wider rounded-lg backdrop-blur-md ${wing.classes}`;
            wingHeader.innerHTML = wing.title;
            fragment.appendChild(wingHeader);

            wingUsers.forEach(user => {
                if (user.isOnline !== false) {
                    currentOnlineUsernames.add(user.name);
                }
                
                const userDiv = document.createElement('div');
                
                if (user.isOnline !== false && !previousOnlineUsernames.has(user.name)) {
                    userDiv.classList.add('user-entry-animation');
                    shouldPlaySound = true;
                }

                userDiv.onclick = () => showUserProfileModal(user.name);
                userDiv.setAttribute('data-username', user.name);
                userDiv.setAttribute('data-name-color', user.nameColor || 'null');
                userDiv.setAttribute('data-name-background', user.nameBackground || 'null');
                userDiv.setAttribute('data-avatar-frame', user.avatarFrame || 'null');
                userDiv.setAttribute('data-name-font', user.nameFont || 'null');

                let rankIconHtml = '';
                if (user.rank) {
                    const rankInfo = ranks[user.rank] || { icon: '' };
                    rankIconHtml = getRankIconHtml(rankInfo.icon, "text-sm");
                }

                let frameStyle = '';
                let frameClass = '';
                if (user.avatarFrame && user.avatarFrame.startsWith('border-color:')) {
                    frameStyle = `border: 2px solid ${user.avatarFrame.split(':')[1]};`;
                } else {
                    frameClass = user.avatarFrame || '';
                }

                const opacityClass = user.isOnline === false ? 'opacity-50 grayscale-[0.5]' : '';
                const statusColor = user.isOnline === false ? 'bg-gray-500' : 'bg-green-500';

                const avatarHtml = user.avatar 
                    ? `<div class="w-9 h-9 rounded-full relative group-hover:border-blue-400 transition-colors ${frameClass} ${opacityClass}" style="${frameStyle}"><img src="${user.avatar}" class="w-full h-full rounded-full object-cover" alt="${user.name}" loading="lazy"></div>`
                    : `<div class="w-9 h-9 rounded-full bg-gray-600 flex items-center justify-center text-white font-bold text-xs group-hover:border-blue-400 transition-colors ${frameClass} ${opacityClass}" style="${frameStyle}">${user.name.charAt(0).toUpperCase()}</div>`;

                const cardBgValue = user.userCardBackground || 'hover:bg-white/5';
                if (cardBgValue.startsWith('background-color:')) {
                    userDiv.className = `group flex items-center space-x-3 space-x-reverse p-2 rounded-lg transition-all duration-200 ease-in-out cursor-pointer mb-1 border border-transparent hover:border-white/10`;
                    userDiv.style.backgroundColor = cardBgValue.split(':')[1];
                } else {
                    userDiv.className = `group flex items-center space-x-3 space-x-reverse p-2 rounded-lg transition-all duration-200 ease-in-out cursor-pointer mb-1 border border-transparent hover:border-white/10 ${cardBgValue}`;
                    userDiv.style.backgroundColor = '';
                }
                
                if (user.nameCardBorder && user.nameCardBorder.startsWith('border-color:')) {
                    const borderColor = user.nameCardBorder.split(':')[1];
                    userDiv.style.borderColor = borderColor;
                    userDiv.style.borderWidth = '2px';
                }

                const nameStyle = getUserNameStyle(user.nameColor);
                const fontClass = user.nameFont || '';

                // الحصول على علم الدولة
                const userCountry = COUNTRIES.find(c => c.code === user.country);
                const flagHtml = userCountry ? `<img src="${userCountry.flag}" class="w-6 h-4 object-cover rounded-sm shadow-sm" title="${userCountry.name}" alt="${userCountry.name}" onerror="this.onerror=null;this.src='https://flagcdn.com/w40/${userCountry.code.toLowerCase()}.png';">` : '';

                userDiv.innerHTML = `
                    <div class="relative flex-shrink-0 ml-3">
                        ${avatarHtml}
                        <span class="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full ${statusColor} border-2 border-gray-800"></span>
                    </div>
                    <div class="flex-1 min-w-0 flex flex-col justify-center ${user.isOnline === false ? 'opacity-60' : ''}">
                        <div class="flex items-center gap-1 mb-0.5">
                            ${rankIconHtml ? `<span class="flex-shrink-0">${rankIconHtml}</span>` : ''}
                            <div class="font-semibold truncate ${nameStyle.class} text-sm ${fontClass}" style="${nameStyle.style}">${user.name}</div>
                        </div>
                        <div class="text-xs text-slate-400 truncate max-w-[150px] h-4 leading-4" title="${user.status || ''}">${user.status || ''}</div>
                    </div>
                    <div class="flex-shrink-0 ml-1">
                        ${flagHtml}
                    </div>
                `;
                fragment.appendChild(userDiv);
            });
        }
    });

    onlineUsersList.innerHTML = '';
    onlineUsersList.appendChild(fragment);

    if (shouldPlaySound && !isFirstUserLoad && userSettings.playEntrySound) {
        entrySound.play().catch(e => {});
    }

    if (!isFirstUserLoad && currentUser && userSettings.playExitSound) {
        for (const username of previousOnlineUsernames) {
            if (!currentOnlineUsernames.has(username) && username !== currentUser.name) {
                // نتحقق إذا كان المستخدم أصبح "غير متصل" أو خرج تماماً
                const stillInRoomOffline = groupedUsers.offline.some(u => u.name === username);
                if (!stillInRoomOffline) {
                    leaveSound.currentTime = 0;
                    leaveSound.play().catch(e => console.log("Audio play blocked:", e));
                    break;
                }
            }
        }
    }

    isFirstUserLoad = false;
    previousOnlineUsernames = currentOnlineUsernames;
    document.getElementById('onlineUsersPanel').classList.remove('hidden');
}

        // دوال إدارة الرتب
        function assignRank() {
            const username = document.getElementById('rankUserName').value.trim();
            const selectedRank = document.getElementById('rankSelect').value;
            
            if (!username || !selectedRank) {
                showNotification('يرجى إدخال اسم المستخدم واختيار الرتبة', 'error');
                return;
            }
            
            socket.emit('assign rank', { 
                username, 
                rank: selectedRank, 
                currentUser: { ...currentUser, roomId: currentRoom.id } 
            });
        }

        function removeRank() {
            const username = document.getElementById('rankUserName').value.trim();
            
            if (!username) {
                showNotification('يرجى إدخال اسم المستخدم', 'error');
                return;
            }
            
            socket.emit('remove rank', { 
                username, 
                currentUser: { ...currentUser, roomId: currentRoom.id } 
            });
        }

        function showAllRanks() {
            socket.emit('show all ranks', { 
                currentUser: { ...currentUser, roomId: currentRoom.id } 
            });
        }

        function updateOnlineUsersAvatars(username, avatarUrl) {
            const userElements = document.querySelectorAll('#onlineUsersList .flex.items-center');
            userElements.forEach(element => {
                const userNameElement = element.querySelector('.font-semibold');
                if (userNameElement && userNameElement.textContent === username) {
                    const imgElement = element.querySelector('img');
                    if (imgElement) {
                        imgElement.src = avatarUrl;
                    } else {
                        const divElement = element.querySelector('.rounded-full');
                        if (divElement) {
                            divElement.innerHTML = `<img src="${avatarUrl}" class="w-10 h-10 rounded-full object-cover" alt="${username}">`;
                        }
                    }
                }
            });
        }

        // دوال إدارة المستخدمين
        function toggleManagementFields() {
            const action = document.getElementById('userActionSelect').value;
            const durationField = document.getElementById('durationField');
            const reasonField = document.getElementById('reasonField');
            
            durationField.classList.add('hidden');
            reasonField.classList.add('hidden');
            
            if (action === 'mute') {
                durationField.classList.remove('hidden');
            } else if (['banFromRoom', 'banFromSite'].includes(action)) {
                reasonField.classList.remove('hidden');
            }
        }

        function clearManagementFields() {
            document.getElementById('managedUserName').value = '';
            document.getElementById('userActionSelect').value = '';
            document.getElementById('muteDuration').value = '';
            document.getElementById('banReason').value = '';
            document.getElementById('durationField').classList.add('hidden');
            document.getElementById('reasonField').classList.add('hidden');
        }

        function manageUser() {
            const username = document.getElementById('managedUserName').value.trim();
            const action = document.getElementById('userActionSelect').value;
            
            if (!username) {
                showNotification('يرجى إدخال اسم المستخدم', 'error');
                return;
            }
            
            if (!action) {
                showNotification('يرجى اختيار الإجراء', 'error');
                return;
            }
            
            if (action === 'mute') {
                const duration = document.getElementById('muteDuration').value;
                if (!duration || duration < 1) {
                    showNotification('يرجى إدخال مدة كتم صحيحة', 'error');
                    return;
                }
                
                socket.emit('mute user', {
                    username,
                    duration,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'unmute') {
                socket.emit('unmute user', {
                    username,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'banFromRoom') {
                const reason = document.getElementById('banReason').value;
                socket.emit('ban from room', {
                    username,
                    reason,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'unbanFromRoom') {
                socket.emit('unban from room', {
                    username,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'banFromSite') {
                const reason = document.getElementById('banReason').value;
                socket.emit('ban from site', {
                    username,
                    reason,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'unbanFromSite') {
                socket.emit('unban from site', {
                    username,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'deleteUser') {
                if (confirm(`هل أنت متأكد من حذف المستخدم ${username}؟ هذا الإجراء لا يمكن التراجع عنه.`)) {
                    socket.emit('delete user', {
                        username,
                        currentUser: { ...currentUser, roomId: currentRoom.id }
                    });
                }
            } else if (action === 'showStatus') {
                socket.emit('get user status', {
                    username,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            }
        }

        // دوال الملف الشخصي والمحادثة الخاصة
        function mentionUser(username) {
            const input = document.getElementById('messageInput');
            if (!input) return;
            
            // إضافة المنشن في نهاية النص الموجود مع مسافة
            const mentionText = `@${username} `;
            input.value = input.value.trim() ? input.value.trim() + ' ' + mentionText : mentionText;
            input.focus();
        }

        function showUserProfileModal(username) {
    if (!currentUser) return;
    
    // الحصول على الصورة من الذاكرة المحلية أولاً
    const avatarUrl = userAvatars[username] || DEFAULT_AVATAR_URL;
    
    socket.emit('get user profile', { username });
}

        socket.on('points sent success', (data) => {
            const message = typeof data === 'object' ? data.message : data;
            const newPoints = typeof data === 'object' ? data.newPoints : null;
            showNotification(message, 'success');
            if (currentUser && newPoints !== null) currentUser.points = newPoints;
        });
        socket.on('points sent error', (error) => {
            showNotification(error, 'error');
        });

        // استقبال حدث تحديث الصفحة الإجباري
        socket.on('force reload', () => {
            location.reload();
        });

        // --- أحداث المتجر ---
        socket.on('shop items data', (items) => {
            window.shopItems = items; // حفظ عناصر المتجر للاستخدام لاحقاً
            const container = document.getElementById('shopItemsContainer'); 
            container.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>';
            const gridContainer = container.querySelector('.grid');
  
            if (items.length === 0) {
                gridContainer.innerHTML = '<p class="text-slate-400 text-center p-8 col-span-2">المتجر فارغ حالياً.</p>';
                return;
            }

            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-gray-800 p-4 rounded-lg border border-gray-700 flex flex-col items-center text-center space-y-3';

                let iconHtml = '';
                if (item.itemType === 'name_change_card') {
                    iconHtml = '<div class="text-4xl">🔑</div>';
                } else if (item.itemType === 'password_change_card') {
                    iconHtml = '<div class="text-4xl">🔐</div>';
                } else if (item.itemType === 'name_color') {
                    // إنشاء عنصر مؤقت لتطبيق كلاس Tailwind واستخراج اللون
                    const tempDiv = document.createElement('div');
                    tempDiv.className = item.itemValue; 
                    document.body.appendChild(tempDiv); // يجب إضافته للـ DOM ليتمكن من حساب النمط
                    const cssColor = window.getComputedStyle(tempDiv).color;
                    document.body.removeChild(tempDiv);
                    iconHtml = `<div class="w-12 h-12 rounded-full border-2 border-slate-600" style="background-color: ${cssColor || '#ffffff'};"></div>`;
                } else if (item.itemType === 'join_message_bg') {
                    iconHtml = '<div class="text-4xl">🔥</div>';
                } else if (item.itemType === 'avatar_frame') {
                    iconHtml = `<div class="w-12 h-12 rounded-full bg-gray-600 ${item.itemValue}"></div>`;
                } else {
                    const rIcon = ranks[item.itemValue]?.icon;
                    if (rIcon && (rIcon.startsWith('data:image') || rIcon.startsWith('http'))) {
                        iconHtml = `<div class="w-12 h-12"><img src="${rIcon}" class="w-full h-full object-contain"></div>`;
                    } else {
                        iconHtml = `<div class="text-4xl">${rIcon || '🛍️'}</div>`;
                    }
                }
                
                let priceDisplay = `<span>${item.price}</span> <span class="text-yellow-300">⭐</span>`;
                let buyBtnClass = "bg-teal-600 hover:bg-teal-700";
                
                if (item.itemValue === 'frame-orange-fire') {
                    priceDisplay = `<span>${item.price}</span> <span class="text-cyan-400 font-bold">XP ⚡</span>`;
                    buyBtnClass = "bg-orange-600 hover:bg-orange-700";
                }

                let buttonsHtml = `
                    <button onclick="buyItem(${item.id})" class="flex-1 ${buyBtnClass} text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 space-x-reverse transition-colors text-xs">
                        ${priceDisplay}
                    </button>
                `;

                if (item.itemType === 'rank') {
                    buttonsHtml = `
                        <div class="flex gap-2 w-full">
                            ${buttonsHtml}
                            <button onclick="giftItem(${item.id}, '${item.name}')" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-3 rounded-lg flex items-center justify-center transition-colors text-xs" title="إهداء لصديق">
                                🎁
                            </button>
                        </div>
                    `;
                } else {
                     buttonsHtml = `<div class="w-full">${buttonsHtml}</div>`;
                }

                itemDiv.innerHTML = `
                    ${iconHtml}
                    <div class="flex-1 w-full">
                        <h4 class="text-white font-semibold text-md">${item.name}</h4>
                        <p class="text-slate-400 text-xs mt-1">${item.description}</p>
                    </div>
                    ${buttonsHtml}
                `;
                gridContainer.appendChild(itemDiv);
            });
        });

        function buyItem(itemId) {
            const item = window.shopItems.find(i => i.id === itemId);
            const currency = (item && item.itemValue === 'frame-orange-fire') ? 'نقاط الخبرة (XP)' : 'النقاط';
            if (confirm(`هل أنت متأكد من شراء هذا العنصر؟ سيتم خصم ${currency} من رصيدك.`)) {
                socket.emit('buy item', { itemId, currentUser });
            }
        }

        function giftItem(itemId, itemName) {
            const targetUsername = prompt(`لمن تريد إهداء "${itemName}"؟\nأدخل اسم المستخدم:`);
            if (targetUsername && targetUsername.trim() !== '') {
                if (confirm(`هل أنت متأكد من إهداء "${itemName}" للمستخدم "${targetUsername}"؟ سيتم خصم النقاط من رصيدك عند قبول المستخدم للهدية.`)) {
                    socket.emit('gift item', { itemId, targetUsername: targetUsername.trim(), currentUser });
                }
            }
        }

        socket.on('buy item success', (data) => {
            showNotification(data.message, 'success');
            
            if (data.newPoints !== undefined && currentUser) {
                currentUser.points = data.newPoints;
                const pointsDisplay = document.getElementById('profilePoints');
                if (pointsDisplay) pointsDisplay.textContent = data.newPoints;
            }
            if (data.newXP !== undefined && currentUser) {
                currentUser.xp = data.newXP;
                const xpDisplay = document.getElementById('profileXP');
                if (xpDisplay) xpDisplay.textContent = data.newXP;
            }
            if (data.ownedItems && currentUser) {
                currentUser.ownedItems = data.ownedItems;
                // تحديث واجهة الميزات فوراً لإزالة القفل
                if (typeof initFeaturesUI === 'function') {
                    initFeaturesUI();
                }
            }
            
            // تحديث الصفحة تلقائياً إذا طلب السيرفر ذلك
            if (data.reload) {
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }
        });

        socket.on('buy item error', (error) => {
            showNotification(error, 'error');
        });

        // استقبال عرض الهدية
        socket.on('gift rank offer', (data) => {
            const modal = document.getElementById('giftOfferModal');
            console.log('Gift offer received:', data); // للتأكد من وصول الحدث
            if (modal) {
                document.getElementById('giftSenderName').textContent = data.sender;
                document.getElementById('giftRankName').textContent = data.rankName;
                modal.classList.add('show');
            }
        });

        function respondToGift(accepted) {
            socket.emit('respond to gift', { accepted, currentUser });
            document.getElementById('giftOfferModal').classList.remove('show');
        }

        socket.on('points update', (data) => {
            if (currentUser) currentUser.points = data.points;
            const pointsDisplay = document.getElementById('profilePoints');
            if (pointsDisplay) pointsDisplay.textContent = data.points;
        });

        socket.on('gift item success', (data) => {
            showNotification(data.message, 'success');
            if (currentUser && data.newPoints !== undefined) {
                currentUser.points = data.newPoints;
                // تحديث عرض النقاط في الملف الشخصي إذا كان مفتوحاً
                const pointsDisplay = document.getElementById('profilePoints');
                if (pointsDisplay) pointsDisplay.textContent = data.newPoints;
            }
        });

        socket.on('control error', (error) => {
            showNotification(error, 'error');
        });

        // --- New Password Change Functions ---
        function usePasswordChangeCard(inventoryId) {
            openChangePasswordModal(inventoryId);
        }

        function openChangePasswordModal(inventoryId) {
            const modal = document.getElementById('changePasswordModal');
            if (modal) {
                modal.dataset.inventoryId = inventoryId;
                modal.classList.add('show');
                document.getElementById('oldPasswordInput').value = '';
                document.getElementById('newPasswordInput').value = '';
                document.getElementById('confirmNewPasswordInput').value = '';
            }
        }

        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        function submitChangePassword() {
            const modal = document.getElementById('changePasswordModal');
            const inventoryId = parseInt(modal.dataset.inventoryId, 10);
            const oldPassword = document.getElementById('oldPasswordInput').value;
            const newPassword = document.getElementById('newPasswordInput').value;
            const confirmNewPassword = document.getElementById('confirmNewPasswordInput').value;

            if (!oldPassword || !newPassword || !confirmNewPassword) {
                showNotification('يرجى ملء جميع الحقول.', 'error');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showNotification('كلمتا المرور الجديدتان غير متطابقتين.', 'error');
                return;
            }
            
            if (newPassword.length < 4) {
                showNotification('يجب أن تتكون كلمة المرور الجديدة من 4 أحرف على الأقل.', 'error');
                return;
            }

            socket.emit('change password', {
                username: currentUser.name,
                oldPassword: oldPassword,
                newPassword: newPassword,
                inventoryId: inventoryId
            });
        }

        socket.on('password change success', (message) => {
            showNotification(message, 'success');
            closeChangePasswordModal();
            setTimeout(logout, 2000); 
        });
        // --- End New Password Change Functions ---

        socket.on('name change success', (data) => {
            showNotification(data.message, 'success');
            // تحديث الكوكي بالجلسة الجديدة
            document.cookie = `sessionId=${data.newSessionId}; path=/; max-age=31536000; SameSite=Lax`;
            // تحديث بيانات المستخدم الحالي
            currentUser.name = data.newUsername;
            currentUser.nameColor = data.nameColor;
            currentUser.sessionId = data.newSessionId;
            updateHeaderUserInfo();
            closeProfileModal();
        });

        socket.on('name change error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('user name changed', ({ oldUsername, newUsername }) => {
            // تحديث اسم المستخدم في الواجهة لجميع المستخدمين
            document.querySelectorAll(`[data-username="${oldUsername}"]`).forEach(el => el.dataset.username = newUsername);
        });

        function useNameChangeCard(inventoryId) {
            const newUsername = prompt("الرجاء إدخال اسمك الجديد:");
            if (newUsername && newUsername.trim() !== '') {
                if (confirm(`هل أنت متأكد من تغيير اسمك إلى "${newUsername}"؟ سيتم استهلاك بطاقة تغيير الاسم.`)) {
                    socket.emit('use name change card', {
                        oldUsername: currentUser.name,
                        newUsername: newUsername.trim(),
                        inventoryId: inventoryId,
                        currentUser: currentUser
                    });
                }
            }
        }


        function showUserProfile(profileData) {
            const modal = document.getElementById('profileModal');
            const avatar = document.getElementById('profileAvatar');
            const usernameElem = document.getElementById('profileUsername');
            const rankElem = document.getElementById('profileRank');
            const genderElem = document.getElementById('profileGender');
            const statusElem = document.getElementById('profileStatus');
            const statusDot = statusElem.querySelector('span:first-child'); // تعديل: اختيار العنصر الأول بشكل موثوق
            const statusText = statusElem.querySelector('span:last-child'); // تعديل: اختيار العنصر الثاني بشكل موثوق
            const joinDateElem = document.getElementById('profileJoinDate');
            const profileMenuContainer = document.getElementById('profileMenuContainer');
            const visitorActions = document.getElementById('visitorActions');
            const profileBio = document.getElementById('profileBio');
            const profileBioInput = document.getElementById('profileBioInput');
            const editBioButton = document.getElementById('editBioButton');
            const saveBioButton = document.getElementById('saveBioButton');
            const changeProfilePicBtn = document.getElementById('changeProfilePicBtn');
            const removeProfilePicBtn = document.getElementById('removeProfilePicBtn');
            const changeCoverBtn = document.getElementById('changeCoverBtn');
            const removeCoverBtn = document.getElementById('removeCoverBtn');
            const featuresTabButton = document.getElementById('featuresTabButton');
            const optionsTabButton = document.getElementById('optionsTabButton');
            const actionsTabButton = document.getElementById('actionsTabButton');
            const sendPointsButton = document.getElementById('sendPointsButton');
            const specialUsers = ["Walid dz 31", "سيد احمد", "ميارا"]; 
            const profileHeader = document.getElementById('profileHeader');
            const profileContent = document.getElementById('profileContent');
            const profileBody = document.getElementById('profileBody');
            const statusInputContainer = document.getElementById('statusInputContainer');
            const countryAgeContainer = document.getElementById('countryAgeContainer');
            
            // تعبئة البيانات
            avatar.src = profileData.avatar || DEFAULT_AVATAR_URL;
            avatar.onerror = function() {
                this.src = DEFAULT_AVATAR_URL;
            };
            
            // تطبيق إطار الصورة
            const avatarFrame = document.getElementById('profileAvatarFrame');
            if (avatarFrame) {
                avatarFrame.style.border = '';
                if (profileData.avatarFrame && profileData.avatarFrame.startsWith('border-color:')) {
                    avatarFrame.className = `w-24 h-24 rounded-full relative`;
                    avatarFrame.style.border = `3px solid ${profileData.avatarFrame.split(':')[1]}`;
                } else {
                    avatarFrame.className = `w-24 h-24 rounded-full relative ${profileData.avatarFrame || ''}`;
                }
            }
            usernameElem.textContent = profileData.username;

            const isOwner = currentUser && profileData.username === currentUser.name;
            if (isOwner) {
                // تحديث بيانات المستخدم الحالي لضمان المزامنة
                currentUser.nameCardBorder = profileData.nameCardBorder;
                currentUser.nameFont = profileData.nameFont;
            }

            if (profileData.nameFont) {
                usernameElem.classList.add(profileData.nameFont);
            }

            // تطبيق لون إطار البطاقة في الملف الشخصي
            if (profileContent) {
                profileContent.style.border = '';
                if (profileData.nameCardBorder && profileData.nameCardBorder.startsWith('border-color:')) {
                    const borderColor = profileData.nameCardBorder.split(':')[1];
                    profileContent.style.border = `2px solid ${borderColor}`;
                }
            }

            // تحديث المعاينة إذا كان هذا هو الملف الشخصي للمستخدم الحالي
            if (isOwner) {
                const previewCardBorderDiv = document.getElementById('previewCardBorderDiv');
                if (previewCardBorderDiv) {
                    previewCardBorderDiv.style.borderColor = '#6366f1'; // اللون الافتراضي
                    if (profileData.nameCardBorder && profileData.nameCardBorder.startsWith('border-color:')) {
                        previewCardBorderDiv.style.borderColor = profileData.nameCardBorder.split(':')[1];
                        previewCardBorderDiv.style.borderWidth = '2px';
                    } else {
                        previewCardBorderDiv.style.borderWidth = '1px';
                    }
                }
            }

            // عرض غلاف الملف الشخصي
            const coverDisplay = document.getElementById('profileCoverDisplay');
            if (profileData.profileCover) {
                coverDisplay.src = profileData.profileCover;
                coverDisplay.classList.remove('hidden');
            } else {
                coverDisplay.classList.add('hidden');
            }

            // تطبيق لون/خلفية الملف الشخصي
            profileContent.style.backgroundColor = '';
            if (profileData.profileBackground) {
                if (profileData.profileBackground.startsWith('background-color:')) {
                    profileContent.className = 'profile-content custom-scrollbar relative';
                    profileContent.style.backgroundColor = profileData.profileBackground.split(':')[1];
                } else {
                    profileContent.className = `profile-content custom-scrollbar relative ${profileData.profileBackground}`;
                }
                profileHeader.className = 'relative h-64 w-full border-b border-gray-700/50 bg-transparent overflow-hidden';
                profileBody.className = 'p-6 bg-transparent';
            } else {
                profileContent.className = 'profile-content custom-scrollbar relative';
                profileHeader.className = 'relative h-64 w-full bg-gray-800 border-b border-gray-700/50 overflow-hidden';
                profileBody.className = 'p-6 bg-gray-900/50';
            }

            usernameElem.className = `text-2xl font-bold tracking-wide ${profileData.nameColor || 'text-white'}`;

            // عرض الحالة (Status)
            const existingStatus = document.getElementById('profileStatusText');
            if (existingStatus) existingStatus.remove();
            
            if (profileData.status) {
                const statusDiv = document.createElement('div');
                statusDiv.id = 'profileStatusText';
                statusDiv.className = 'text-slate-300 text-sm mt-2 text-center italic px-4 break-words';
                statusDiv.textContent = `"${profileData.status}"`;
                // إدراج الحالة تحت الاسم
                usernameElem.parentNode.insertBefore(statusDiv, usernameElem.nextSibling);
            }

            // إعداد حقل تعديل الحالة للمالك
            if (isOwner) {
                // سيتم إنشاء الحقل في قسم التفاصيل إذا لم يكن موجوداً
                createStatusInput(profileData.status || '');
                createCountryAgeInputs(profileData.country || '', profileData.age || '');
            } else {
                // عرض الدولة والعمر للزوار
                displayCountryAge(profileData.country, profileData.age);
            }
            
            // عرض الجنس
            const genderText = profileData.gender === 'male' ? 'ذكر' : 'أنثى';
            genderElem.textContent = genderText;

            // عرض تاريخ الانضمام
            if (profileData.createdAt) {
                const date = new Date(profileData.createdAt);
                joinDateElem.textContent = date.toLocaleDateString('en-GB'); // DD/MM/YYYY
            }

            if (profileData.rank) {
                const rankInfo = ranks[profileData.rank] || { icon: '', color: 'from-gray-500 to-gray-600' };
                const iconHtml = getRankIconHtml(rankInfo.icon, "text-base");
                rankElem.innerHTML = `${iconHtml} ${profileData.rank}`;
                rankElem.className = `inline-block mt-2 px-3 py-1 rounded-full text-sm font-semibold text-white bg-gradient-to-r ${rankInfo.color}`;
                rankElem.style.display = 'inline-block';
            } else {
                rankElem.style.display = 'none';
            }

            // عرض الوقت المتبقي للرتبة في قسم التفاصيل
            const rankExpiryContainer = document.getElementById('profileRankExpiryContainer');
            const rankExpiryText = document.getElementById('profileRankExpiryText');
            
            if (profileData.rankExpiry) {
                const expiryDate = new Date(profileData.rankExpiry);
                const now = new Date();
                if (expiryDate > now) {
                    const diffTime = expiryDate - now;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    rankExpiryText.textContent = `${diffDays} يوم`;
                    rankExpiryContainer.classList.remove('hidden');
                } else {
                    rankExpiryContainer.classList.add('hidden');
                }
            } else {
                rankExpiryContainer.classList.add('hidden');
            }

            // عرض ترتيب XP في قسم التفاصيل
            const xpRankContainer = document.getElementById('profileXpRankContainer');
            const xpRankText = document.getElementById('profileXpRankText');
            if (profileData.xpRank) {
                xpRankText.textContent = `#${profileData.xpRank}`;
                xpRankContainer.classList.remove('hidden');
            } else {
                xpRankContainer.classList.add('hidden');
            }

            // عرض ترتيب الأقدمية
            const oldestRankContainer = document.getElementById('profileOldestRankContainer');
            const oldestRankText = document.getElementById('profileOldestRankText');
            if (profileData.oldestRank) {
                oldestRankText.textContent = `#${profileData.oldestRank}`;
                oldestRankContainer.classList.remove('hidden');
            } else {
                oldestRankContainer.classList.add('hidden');
            }

            // عرض ترتيب التفاعل
            const interactionRankContainer = document.getElementById('profileInteractionRankContainer');
            const interactionRankText = document.getElementById('profileInteractionRankText');
            if (profileData.interactionRank) {
                interactionRankText.textContent = `#${profileData.interactionRank}`;
                interactionRankContainer.classList.remove('hidden');
            } else {
                interactionRankContainer.classList.add('hidden');
            }
            
            if (profileData.isOnline) {
                statusDot.className = 'w-2.5 h-2.5 rounded-full bg-green-500';
                statusText.textContent = 'متصل الآن';
            } else { 
                statusDot.className = 'w-2.5 h-2.5 rounded-full bg-gray-500';
                const lastSeenText = profileData.lastSeen ? `آخر ظهور ${getTimeAgo(new Date(profileData.lastSeen))}` : 'غير متصل';
                statusText.textContent = lastSeenText;
            }
            
            // عرض المعلومات الشخصية (Bio)
            profileBio.textContent = profileData.bio || 'لا توجد معلومات لعرضها.';
            profileBioInput.value = profileData.bio || '';

            // عرض درجة التفاعل ونظام الدعوة
            const interactionScoreElem = document.getElementById('interactionScore');
            const referralLinkContainer = document.getElementById('referralLinkContainer');
            const referralLinkInput = document.getElementById('referralLinkInput');

            if (interactionScoreElem) {
                interactionScoreElem.textContent = profileData.interactionScore || 0;
            }

            if (referralLinkContainer && referralLinkInput) {
                if (isOwner) {
                    referralLinkContainer.classList.remove('hidden');
                    const refLink = `${window.location.origin}/?ref=${profileData.username}`;
                    referralLinkInput.value = refLink;
                } else {
                    referralLinkContainer.classList.add('hidden');
                }
            }

            // تعبئة قائمة الأصدقاء (مع التأكد من عدم التكرار)
            const friendsContainer = document.getElementById('profileFriendsList');
            friendsContainer.innerHTML = '';
            if (profileData.friends && profileData.friends.length > 0) {
                // استخدام Set لضمان فرادة أسماء المستخدمين
                const uniqueFriends = [];
                const seenUsernames = new Set();
                
                profileData.friends.forEach(friend => {
                    if (!seenUsernames.has(friend.username)) {
                        seenUsernames.add(friend.username);
                        uniqueFriends.push(friend);
                    }
                });

                uniqueFriends.forEach(friend => {
                    const friendDiv = document.createElement('div');
                    friendDiv.className = 'bg-gray-800/60 p-2 rounded-lg text-center cursor-pointer hover:bg-gray-700/80 transition-colors border border-gray-700/50';
                    friendDiv.onclick = () => showUserProfileModal(friend.username);
                    friendDiv.innerHTML = `
                        <div class="relative inline-block">
                            <img src="${friend.avatar || defaultAvatars.guest}" class="w-10 h-10 rounded-full object-cover mx-auto mb-1 border border-gray-600">
                            ${friend.isOnline ? '<span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-gray-800 rounded-full"></span>' : ''}
                        </div>
                        <div class="text-xs text-white truncate font-medium">${friend.username}</div>
                    `;
                    friendsContainer.appendChild(friendDiv);
                });
            } else {
                friendsContainer.innerHTML = '<p class="col-span-3 text-center text-slate-400 text-sm py-4">لا يوجد أصدقاء لعرضهم.</p>';
            }

            // تعبئة النقاط والمستوى
            if (specialUsers.includes(profileData.username)) {
                document.getElementById('profilePoints').textContent = '99999';
                document.getElementById('profileLevel').textContent = '9999';
            } else {
                document.getElementById('profilePoints').textContent = profileData.points;
                document.getElementById('profileLevel').textContent = profileData.level;
            }

            // عرض الإنجازات
            const achievementsListElem = document.getElementById('profileAchievementsList');
            if (achievementsListElem) {
                achievementsListElem.innerHTML = '';
                if (profileData.achievements && profileData.achievements.length > 0) {
                    profileData.achievements.forEach(ach => {
                        const card = document.createElement('div');
                        card.className = `achievement-card flex items-center gap-3 ${ach.completed ? 'completed' : 'opacity-60'}`;
                        
                        const progressPercent = Math.min(100, Math.round((ach.currentValue / ach.targetValue) * 100));
                        
                        const borderColor = ach.cardColor || (ach.completed ? '#10b981' : '#4b5563');
                        
                        card.innerHTML = `
                            <div class="achievement-badge w-12 h-12 text-2xl bg-gray-800 border-2 rounded-full flex items-center justify-center" 
                                 style="border-color: ${borderColor}; box-shadow: 0 0 5px ${borderColor}44;">
                                ${ach.icon}
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-center mb-1">
                                    <h4 class="text-sm font-bold text-white">${ach.name}</h4>
                                    <span class="text-[10px] ${ach.completed ? 'text-green-400' : 'text-slate-400'}">
                                        ${ach.completed ? 'مكتمل' : `${ach.currentValue} / ${ach.targetValue}`}
                                    </span>
                                </div>
                                <p class="text-[10px] text-slate-400 mb-2">${ach.description}</p>
                                <div class="w-full bg-gray-700 rounded-full h-1.5 overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                        `;
                        achievementsListElem.appendChild(card);
                    });
                } else {
                    achievementsListElem.innerHTML = '<div class="text-center text-slate-500 text-xs py-4">لا توجد إنجازات متاحة</div>';
                }
            }
 
            // التحقق من الرتبة لإظهار تبويب الميزات
            // ملاحظة: تم تعريف isOwner سابقاً في السطر 5532
            const userRankLevel = profileData.rank ? (ranks[profileData.rank]?.level || 0) : 0;
            if (isOwner && (userRankLevel >= 4 || profileData.username === "Walid dz 31")) {
                featuresTabButton.classList.remove('hidden');
                initFeaturesUI(); // تهيئة واجهة الميزات
                updateNameCardBorderGrid(profileData); // تحديث شبكة إطار البطاقة
            } else {
                featuresTabButton.classList.add('hidden');
            }

            // إظهار تبويب الخيارات للمالك فقط
            if (isOwner) {
                optionsTabButton.classList.remove('hidden');
                // تحديث حالة الـ checkboxes
                document.getElementById('setting-playMentionSound').checked = userSettings.playMentionSound;
                document.getElementById('setting-playEntrySound').checked = userSettings.playEntrySound;
                document.getElementById('setting-playExitSound').checked = userSettings.playExitSound;
            } else {
                optionsTabButton.classList.add('hidden');
            }

            // إظهار/إخفاء أزرار التعديل وقائمة الإدارة
            if (isOwner) {
                changeProfilePicBtn.classList.remove('hidden'); // إظهار زر تغيير الصورة
                changeCoverBtn.classList.remove('hidden'); // إظهار زر تغيير الغلاف
                
                // إظهار زر الحذف فقط إذا كانت الصورة/الغلاف غير افتراضية
                if (profileData.avatar && profileData.avatar !== DEFAULT_AVATAR_URL) {
                    removeProfilePicBtn.classList.remove('hidden');
                } else {
                    removeProfilePicBtn.classList.add('hidden');
                }
                
                if (profileData.profileCover) {
                    removeCoverBtn.classList.remove('hidden');
                } else {
                    removeCoverBtn.classList.add('hidden');
                }

                editBioButton.classList.remove('hidden');
                saveBioButton.classList.add('hidden');
                visitorActions.classList.add('hidden');
                if (actionsTabButton) actionsTabButton.classList.add('hidden');
                
                // إظهار حاوية تعديل الحالة
                const statusContainer = document.getElementById('statusEditContainer');
                if (statusContainer) statusContainer.classList.remove('hidden');

                // إظهار حاوية تعديل الدولة والعمر
                const caContainer = document.getElementById('countryAgeEditContainer');
                if (caContainer) caContainer.classList.remove('hidden');
                const caDisplay = document.getElementById('countryAgeDisplay');
                if (caDisplay) caDisplay.classList.add('hidden');

                profileMenuContainer.innerHTML = ''; // إخفاء قائمة الإدارة
                document.getElementById('accountTabButton').classList.remove('hidden');
            } else {
                changeProfilePicBtn.classList.add('hidden'); // إخفاء زر تغيير الصورة
                removeProfilePicBtn.classList.add('hidden'); // إخفاء زر حذف الصورة
                changeCoverBtn.classList.add('hidden'); // إخفاء زر تغيير الغلاف
                removeCoverBtn.classList.add('hidden'); // إخفاء زر حذف الغلاف
                editBioButton.classList.add('hidden');
                saveBioButton.classList.add('hidden');
                
                // إخفاء حاوية تعديل الحالة
                const statusContainer = document.getElementById('statusEditContainer');
                if (statusContainer) statusContainer.classList.add('hidden');

                // إخفاء حاوية تعديل الدولة والعمر
                const caContainer = document.getElementById('countryAgeEditContainer');
                if (caContainer) caContainer.classList.add('hidden');
                const caDisplay = document.getElementById('countryAgeDisplay');
                if (caDisplay) caDisplay.classList.remove('hidden');

                visitorActions.classList.remove('hidden');
                if (actionsTabButton) actionsTabButton.classList.remove('hidden');
                const privateChatButton = document.getElementById('privateChatButton');
                privateChatButton.style.display = 'flex';
                privateChatButton.setAttribute('data-username', profileData.username);
                const addFriendButton = document.getElementById('addFriendButton');
                
                // إظهار زر إضافة صديق فقط إذا لم يكن المستخدم نفسه
                addFriendButton.style.display = 'flex';
                sendPointsButton.style.display = 'flex';
                addFriendButton.setAttribute('data-username', profileData.username);
                
                // التحقق إذا كان المستخدم صديقاً بالفعل
                // التحقق من قائمة الأصدقاء (سواء كانت كائنات أو نصوص)
                if (friendsList.some(f => (typeof f === 'string' ? f : f.username) === profileData.username)) {
                    addFriendButton.innerHTML = `
                        <span>حذف الصديق</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"></path>
                        </svg>
                    `;
                    addFriendButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-gray-600', 'hover:bg-gray-700');
                    addFriendButton.classList.add('bg-red-600', 'hover:bg-red-700');
                    addFriendButton.disabled = false;
                    addFriendButton.onclick = () => removeFriend(profileData.username);
                } else {
                    addFriendButton.innerHTML = `
                        <span>إضافة صديق</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                        </svg>
                    `;
                    addFriendButton.classList.remove('bg-gray-600', 'hover:bg-gray-700', 'bg-red-600', 'hover:bg-red-700');
                    addFriendButton.classList.add('bg-green-600', 'hover:bg-green-700');
                    addFriendButton.disabled = false;
                    addFriendButton.onclick = sendFriendRequest;
                }

                // إظهار قائمة الإدارة إذا كان المستخدم الحالي مشرفاً
                const isSiteOwner = currentUser.name === "Walid dz 31";
                const managerLevel = ranks[currentUser.rank]?.level || 0;
                const targetLevel = ranks[profileData.rank]?.level || 0;
                const canManage = isSiteOwner || managerLevel > targetLevel;

                if (canManage && currentUser.name !== profileData.username) {
                    profileMenuContainer.innerHTML = ` 
                        <div class="relative inline-block">
                            <button class="menu-btn text-gray-400 hover:text-blue-400 text-xl font-bold" title="خيارات إدارية" onclick="toggleProfileMenu(event, '${profileData.username}')">⋮</button>
                            <div id="profileActionMenu" class="message-menu hidden absolute left-0 z-50 bg-slate-800 text-white rounded shadow-lg mt-2 min-w-[160px] text-sm border border-slate-700">
                                <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileMute('${profileData.username}')">🔇 كتم المستخدم</button>
                                <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileUnmute('${profileData.username}')">🔊 إلغاء الكتم</button>
                                <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileWarn('${profileData.username}')">⚠️ تحذير المستخدم</button>
                                <div class="border-t border-slate-600 my-1"></div>
                                <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileBanRoom('${profileData.username}')">🚫 حظر من الغرفة</button>
                                <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileUnbanRoom('${profileData.username}')">✅ إلغاء حظر الغرفة</button>
                                ${isSiteOwner ? ` 
                                    <div class="border-t border-slate-600 my-1"></div>
                                    <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileBanSite('${profileData.username}')">⛔ حظر من الموقع</button>
                                    <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileUnbanSite('${profileData.username}')">🌐 إلغاء حظر الموقع</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    profileMenuContainer.innerHTML = '';
                }
                document.getElementById('accountTabButton').classList.add('hidden');
            }
            
            modal.classList.add('show');
            // إعادة التعيين إلى قسم التفاصيل عند فتح النافذة
            switchProfileTab({ currentTarget: document.querySelector('.profile-tab-btn') }, 'details');

            // إضافة إشعار الرسائل غير المقروءة إذا وجدت (في زر المحادثة الخاصة)
            const unreadCount = unreadPrivateMessages[profileData.username] || 0;
            if (unreadCount > 0 && profileData.username !== currentUser.name) {
                let badge = privateChatButton.querySelector('.unread-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'unread-badge absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white rounded-full text-xs h-5 w-5 flex items-center justify-center';
                    privateChatButton.style.position = 'relative';
                    privateChatButton.appendChild(badge);
                }
                badge.textContent = unreadCount;
            }
        }

        function createStatusInput(currentStatus) {
            let container = document.getElementById('statusEditContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'statusEditContainer';
                container.className = 'mt-4 mb-4 p-3 bg-gray-800/50 rounded-xl border border-gray-700/30';
                
                const label = document.createElement('label');
                label.className = 'block text-slate-400 text-xs font-bold mb-2';
                label.textContent = 'الحالة (تظهر تحت اسمك)';
                
                const inputGroup = document.createElement('div');
                inputGroup.className = 'flex gap-2';
                
                inputGroup.innerHTML = `
                    <input type="text" id="statusInput" maxlength="200" class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="اكتب حالتك هنا (200 حرف)...">
                    <button onclick="saveStatus()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">حفظ</button>
                `;
                
                container.appendChild(label);
                container.appendChild(inputGroup);
                
                // إضافته في بداية قسم التفاصيل
                const detailsTab = document.getElementById('profileTab-details');
                detailsTab.insertBefore(container, detailsTab.firstChild);
            }
            document.getElementById('statusInput').value = currentStatus;
        }

        function createCountryAgeInputs(currentCountry, currentAge) {
            let container = document.getElementById('countryAgeEditContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'countryAgeEditContainer';
                container.className = 'mt-2 mb-4 p-3 bg-gray-800/50 rounded-xl border border-gray-700/30';
                
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 gap-3';

                // Country Select
                const countryDiv = document.createElement('div');
                countryDiv.innerHTML = `
                    <label class="block text-slate-400 text-xs font-bold mb-1">الدولة</label>
                    <select id="countryInput" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-2 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">اختر الدولة...</option>
                        ${COUNTRIES.map(c => `<option value="${c.code}">${c.name}</option>`).join('')}
                    </select>
                `;

                // Age Input
                const ageDiv = document.createElement('div');
                ageDiv.innerHTML = `
                    <label class="block text-slate-400 text-xs font-bold mb-1">العمر</label>
                    <input type="number" id="ageInput" min="10" max="99" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-2 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="العمر">
                `;

                grid.appendChild(countryDiv);
                grid.appendChild(ageDiv);
                container.appendChild(grid);

                // زر حفظ التغييرات للدولة والعمر
                const saveBtnContainer = document.createElement('div');
                saveBtnContainer.className = 'mt-3 text-center';
                saveBtnContainer.innerHTML = `<button onclick="saveStatus()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-bold transition-colors w-full">حفظ التغييرات</button>`;
                container.appendChild(saveBtnContainer);
                
                // إضافته بعد حقل الحالة
                const detailsTab = document.getElementById('profileTab-details');
                const statusContainer = document.getElementById('statusEditContainer');
                if (statusContainer) {
                    detailsTab.insertBefore(container, statusContainer.nextSibling);
                } else {
                    detailsTab.insertBefore(container, detailsTab.firstChild);
                }
            }
            document.getElementById('countryInput').value = currentCountry || '';
            document.getElementById('ageInput').value = currentAge || '';
        }

        function displayCountryAge(countryCode, age) {
            let container = document.getElementById('countryAgeDisplay');
            if (!container) {
                container = document.createElement('div');
                container.id = 'countryAgeDisplay';
                container.className = 'flex justify-center gap-4 mb-4';
                const detailsTab = document.getElementById('profileTab-details');
                detailsTab.insertBefore(container, detailsTab.firstChild);
            }
            
            const country = COUNTRIES.find(c => c.code === countryCode);
            const countryHtml = country ? 
                `<div class="bg-gray-800/60 px-3 py-1 rounded-full border border-gray-700/50 flex items-center gap-2">
                    <img src="${country.flag}" class="w-6 h-4 object-cover rounded-sm" alt="${country.name}" onerror="this.onerror=null;this.src='https://flagcdn.com/w40/${country.code.toLowerCase()}.png';">
                    <span class="text-sm text-slate-300">${country.name}</span>
                </div>` : '';
                
            const ageHtml = age ? 
                `<div class="bg-gray-800/60 px-3 py-1 rounded-full border border-gray-700/50 flex items-center gap-2">
                    <span class="text-lg">🎂</span>
                    <span class="text-sm text-slate-300">${age} سنة</span>
                </div>` : '';

            container.innerHTML = countryHtml + ageHtml;
            if (!countryHtml && !ageHtml) container.classList.add('hidden');
            else container.classList.remove('hidden');
        }

        function saveStatus() {
            const status = document.getElementById('statusInput').value.trim();
            const country = document.getElementById('countryInput').value;
            const age = document.getElementById('ageInput').value;

            if (status.length > 200) {
                showNotification('الحالة يجب أن لا تتجاوز 200 حرف', 'error');
                return;
            }
            socket.emit('update user details', { 
                username: currentUser.name,
                bio: document.getElementById('profileBioInput').value.trim(), // إرسال البيو أيضاً للحفاظ عليه
                status, 
                country, 
                age, 
                currentUser 
            });
        }

        function toggleSetting(setting) {
            userSettings[setting] = !userSettings[setting];
            saveUserSettings();
        }
        

        socket.on('account deleted', () => {
            showNotification('تم حذف حسابك بنجاح. سيتم تسجيل خروجك الآن.', 'success');
            setTimeout(logout, 2000);
        });

        socket.on('delete account error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('cover success', (data) => {
            const message = typeof data === 'string' ? data : data.message;
            showNotification(message, 'success');
            
            if (typeof data === 'object' && data.coverUrl !== undefined) {
                const coverDisplay = document.getElementById('profileCoverDisplay');
                const removeCoverBtn = document.getElementById('removeCoverBtn');
                
                if (data.coverUrl) {
                    coverDisplay.src = data.coverUrl;
                    coverDisplay.classList.remove('hidden');
                    if (removeCoverBtn) removeCoverBtn.classList.remove('hidden');
                } else {
                    coverDisplay.src = '';
                    coverDisplay.classList.add('hidden');
                    if (removeCoverBtn) removeCoverBtn.classList.add('hidden');
                }
            }
        });

        socket.on('cover error', (msg) => {
            showNotification(msg, 'error');
        });

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
        }

        // دوال قائمة الخيارات في الملف الشخصي
        function toggleProfileMenu(event, username) {
            event.stopPropagation();
            const menu = document.getElementById('profileActionMenu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }

        function handleProfileMute(username) {
            const duration = prompt(`أدخل مدة الكتم للمستخدم ${username} (بالدقائق):`, "60");
            if (duration && !isNaN(duration)) {
                socket.emit('mute user', { username, duration: parseInt(duration), currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileUnmute(username) {
            if (confirm(`هل تريد إلغاء كتم المستخدم ${username}؟`)) {
                socket.emit('unmute user', { username, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileWarn(username) {
            const reason = prompt(`أدخل سبب التحذير للمستخدم ${username}:`);
            if (reason !== null) {
                socket.emit('warn user', { username, reason, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileBanRoom(username) {
            const reason = prompt(`أدخل سبب حظر ${username} من هذه الغرفة:`);
            if (reason !== null) { // يسمح بسبب فارغ
                socket.emit('ban from room', { username, reason, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileUnbanRoom(username) {
            if (confirm(`هل تريد إلغاء حظر المستخدم ${username} من هذه الغرفة؟`)) {
                socket.emit('unban from room', { username, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileBanSite(username) {
            const reason = prompt(`أدخل سبب حظر ${username} من الموقع بالكامل:`);
            if (reason !== null) {
                socket.emit('ban from site', { username, reason, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileUnbanSite(username) {
            if (confirm(`هل تريد إلغاء حظر المستخدم ${username} من الموقع بالكامل؟`)) {
                socket.emit('unban from site', { username, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        // دوال تعديل المعلومات الشخصية
        function updateBioCharCount() {
            const bioInput = document.getElementById('profileBioInput');
            const charCounter = document.getElementById('bioCharCounter');
            const currentLength = bioInput.value.length;
            const maxLength = 500;
            charCounter.textContent = `${currentLength} / ${maxLength}`; 
            if (currentLength > maxLength) {
                charCounter.classList.add('text-red-500');
                charCounter.classList.remove('text-gray-400');
            } else {
                charCounter.classList.remove('text-red-500');
                charCounter.classList.add('text-gray-400');
            }
        }
 
        function toggleBioEdit(isEditing) {
            const bioText = document.getElementById('profileBio');
            const bioInput = document.getElementById('profileBioInput');
            const editButton = document.getElementById('editBioButton');
            const saveButton = document.getElementById('saveBioButton');
            const cancelButton = document.getElementById('cancelBioButton');
            const charCounter = document.getElementById('bioCharCounter');
 
            if (isEditing) {
                bioText.classList.add('hidden');
                bioInput.classList.remove('hidden');
                charCounter.classList.remove('hidden');
                editButton.classList.add('hidden');
                saveButton.classList.remove('hidden');
                cancelButton.classList.remove('hidden');
                bioInput.value = bioText.textContent === 'لا توجد معلومات لعرضها.' ? '' : bioText.textContent;
                updateBioCharCount();
                bioInput.focus();
            } else {
                bioText.classList.remove('hidden');
                bioInput.classList.add('hidden');
                charCounter.classList.add('hidden');
                editButton.classList.remove('hidden');
                saveButton.classList.add('hidden');
                cancelButton.classList.add('hidden');
            }
        }

        function saveBio() {
            const newBio = document.getElementById('profileBioInput').value.trim();
            if (newBio.length > 500) {
                showNotification('المعلومات الشخصية يجب أن لا تتجاوز 500 حرف.', 'error');
                return; 
            }
            socket.emit('update user bio', { username: currentUser.name, bio: newBio, currentUser });
        }

        // دوال تغيير الغلاف
        function openCoverUpload() {
            document.getElementById('coverUpload').click();
        }

        document.getElementById('coverUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('يرجى اختيار ملف صورة فقط', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showNotification('حجم الصورة يجب أن يكون أقل من 5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const coverUrl = e.target.result;
                // تحديث العرض فوراً
                document.getElementById('profileCoverDisplay').src = coverUrl;
                document.getElementById('profileCoverDisplay').classList.remove('hidden');
                socket.emit('update profile cover', { username: currentUser.name, coverUrl, currentUser });
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        });

        socket.on('bio success', (message) => {
            showNotification(message, 'success');
            const newBio = document.getElementById('profileBioInput').value.trim();
            document.getElementById('profileBio').textContent = newBio || 'لا توجد معلومات لعرضها.';
            toggleBioEdit(false);
        });

        socket.on('bio error', (error) => {
            showNotification(error, 'error');
        });
 
        function startPrivateChat() {
            const privateChatButton = document.getElementById('privateChatButton');
            const username = privateChatButton.getAttribute('data-username');
            
            if (!username) return;
            
            closeProfileModal();
            openPrivateChat(username);
        }

/* --- دالة محسّنة لجعل العناصر قابلة للسحب (تدعم اللمس والفأرة) --- */
function makeDraggable(element, handle) {
    let active = false;
    let currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;

    const dragStart = (e) => {
        e = e || window.event;
        if (e.type === 'touchstart') {
            initialX = e.touches[0].clientX - xOffset;
            initialY = e.touches[0].clientY - yOffset;
        } else {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
        }

        if (e.target === handle || handle.contains(e.target)) {
            active = true;
        }
    };

    const dragEnd = () => {
        initialX = currentX;
        initialY = currentY;
        active = false;
    };

    const drag = (e) => {
        if (!active) return;
        e = e || window.event;
        e.preventDefault();

        if (e.type === 'touchmove') {
            currentX = e.touches[0].clientX - initialX;
            currentY = e.touches[0].clientY - initialY;
        } else {
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;
        }

        xOffset = currentX;
        yOffset = currentY;

        requestAnimationFrame(() => {
            element.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
        });
    };

    // إضافة مستمعي الأحداث
    const parent = element.parentElement;
    parent.addEventListener('touchstart', dragStart, false);
    parent.addEventListener('touchend', dragEnd, false);
    parent.addEventListener('touchmove', drag, { passive: false });
    parent.addEventListener('mousedown', dragStart, false);
    parent.addEventListener('mouseup', dragEnd, false);
    parent.addEventListener('mousemove', drag, { passive: false });
}

       function openPrivateChat(username) {
    privateChatTarget = username;
    const modal = document.getElementById('privateChatModal');
    const avatar = document.getElementById('privateChatAvatar');
    const usernameElem = document.getElementById('privateChatUsername');
    const statusElem = document.getElementById('privateChatStatus');
    const statusDot = document.getElementById('privateChatStatusDot');
    
    // جلب رابط الصورة
    const avatarUrl = userAvatars[username] || DEFAULT_AVATAR_URL;
    avatar.src = avatarUrl || DEFAULT_AVATAR_URL;
    avatar.onerror = function() {
        this.src = DEFAULT_AVATAR_URL;
    };
    
    usernameElem.textContent = username;
    
    // تحديث حالة المتصل
    const userData = window.onlineUsersData && window.onlineUsersData[username];
    const isOnline = userData && userData.isOnline !== false;
    if (isOnline) {
        statusDot.className = 'absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-slate-800 bg-green-500';
        statusElem.textContent = 'متصل الآن';
        statusElem.className = 'text-[10px] text-green-400 font-medium';
    } else {
        statusDot.className = 'absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-slate-800 bg-slate-500';
        statusElem.textContent = 'غير متصل';
        statusElem.className = 'text-[10px] text-slate-500 font-medium';
    }
    
    // تفريغ عدد الرسائل غير المقروءة لهذا المستخدم
    if (unreadPrivateMessages[username]) {
        delete unreadPrivateMessages[username];
        updateUnreadBadges();
    }
    
    // إظهار النافذة
    modal.classList.add('show');
    
    // إظهار مؤشر التحميل داخل نافذة المحادثة
    const container = document.getElementById('privateChatMessages');
    container.innerHTML = `
        <div id="privateChatLoader" class="flex flex-col items-center justify-center h-full space-y-3 text-slate-400">
            <div class="spinner w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-xs font-medium">جاري تحميل المحادثة...</p>
        </div>
    `;
    
    // تحميل سجل المحادثة
    socket.emit('get private messages', {
        otherUser: username,
        currentUser: currentUser.name
    });

    // جعل النافذة قابلة للسحب
    const header = document.querySelector('#privateChatModal .private-chat-header');
    makeDraggable(modal, header);
}

        function closePrivateChat() {
            document.getElementById('privateChatModal').classList.remove('show');
            privateChatTarget = null;
        }

        function sendPrivateMessage() {
            if (!privateChatTarget) return;
            
            const input = document.getElementById('privateMessageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            socket.emit('send private message', {
                toUser: privateChatTarget,
                message: message,
                fromUser: currentUser.name
            });
            
            input.value = '';
        }

        function handlePrivateKeyPress(event) {
            if (event.key === 'Enter') {
                sendPrivateMessage();
            }
        }

        function addPrivateMessageToChat(message, isOwn) {
    let formattedContent = formatLinks(message.content);

    // التحقق مما إذا كانت الرسالة ايموجي متحرك (Google أو محلي)
    if (animatedEmojis.includes(message.content) || localEmojis.includes(message.content)) {
        formattedContent = `<img src="${message.content}" class="h-6 w-auto inline-block object-contain" alt="" onerror="this.style.display='none'">`;
    }

    const container = document.getElementById('privateChatMessages');
    
    // إزالة مؤشر التحميل إذا كان موجوداً
    const loader = document.getElementById('privateChatLoader');
    if (loader) {
        container.innerHTML = '';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-4 flex ${isOwn ? 'flex-row-reverse' : 'flex-row'} items-end gap-2 chat-message`;
    
    const timeStr = formatMessageTime(message.timestamp || Date.now());
    const avatarUrl = message.avatar || DEFAULT_AVATAR_URL;

    messageDiv.innerHTML = `
        <img src="${avatarUrl}" class="w-8 h-8 rounded-full border border-white/10" alt="avatar">
        <div class="flex flex-col ${isOwn ? 'items-end' : 'items-start'} max-w-[75%]">
            <div class="px-4 py-2 rounded-2xl text-sm ${
                isOwn
                    ? 'bg-blue-600 text-white rounded-br-none shadow-lg shadow-blue-900/20'
                    : 'bg-slate-700 text-white rounded-bl-none shadow-lg shadow-black/20'
            }">
                <div class="whitespace-pre-wrap break-words">${formattedContent}</div>
            </div>
            <div class="text-[10px] opacity-50 mt-1 mx-1">${timeStr}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}
 
        // وظيفة لعرض الإشعارات
        function showNotification(message, type = 'info') {
            const notificationsContainer = document.getElementById('globalNotifications');
            const notification = document.createElement('div');
            
            let bgColor = 'bg-blue-600';
            if (type === 'error') bgColor = 'bg-red-600';
            if (type === 'success') bgColor = 'bg-green-600';
            if (type === 'warning') bgColor = 'bg-yellow-600';
             
            notification.className = `${bgColor} text-white p-4 rounded-lg shadow-lg notification`;
            notification.innerHTML = `
                <div class="flex items-center space-x-3 space-x-reverse">
                    <span class="text-lg">${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}</span>
                    <span>${message}</span>
                </div>
            `;
             
            notificationsContainer.appendChild(notification);
            
            // إزالة الإشعار تلقائياً بعد 5 ثوانٍ
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // وظيفة لتمرير المحادثة إلى أحدث رسالة
        // دالة التمرير للأسفل مع تحسين الأداء
        let scrollTimeout;
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (!container) return;
            
            // استخدام requestAnimationFrame لضمان سلاسة التمرير وتقليل استهلاك المعالج
            cancelAnimationFrame(scrollTimeout);
            scrollTimeout = requestAnimationFrame(() => {
                container.scrollTop = container.scrollHeight;
            });
        }
        // استقبال حدث الترقية
socket.on('level up', (data) => {
  showNotification(`🎉 لقد ارتقت إلى المستوى ${data.level}! استمر في المحادثة لترتقي أكثر!`, 'success');
});

// حدث النقر على زر الإشعارات في واجهة المحادثة
document.getElementById('chatMessagesButton')?.addEventListener('click', toggleNotificationsDropdown);

document.getElementById('chatFriendsButton')?.addEventListener('click', () => {
    openFriendsSidebar();
});

let pendingPostScrollId = null; // متغير لتخزين معرف المنشور المراد الانتقال إليه

function openPostsSidebar() {
    document.getElementById('postsModal').classList.add('show');
    loadPosts();
    showDot('posts', false);
}

const originalOpenPostsSidebar = openPostsSidebar;
openPostsSidebar = function() {
    document.getElementById('postsModal').classList.add('show');
    // إضافة رمز التحميل داخل قائمة المنشورات
    document.getElementById('postsList').innerHTML = '<div class="text-center p-8"><div class="spinner mx-auto"></div><p class="mt-2 text-slate-400">جاري تحميل المنشورات...</p></div>';
    loadPosts();
    showDot('posts', false);
}

function closePostsSidebar() {
    const modal = document.getElementById('postsModal');
    modal.classList.remove('show');
    modal.querySelector('#postsList').innerHTML = ''; // تفريغ المحتوى عند الإغلاق لتوفير الموارد
}

function createNewPost() {
    const content = document.getElementById('newPostContent').value.trim();
    if (!content) {
        showNotification('يرجى كتابة محتوى للمنشور', 'error');
        return;
    }
    socket.emit('create post', {
        content: content,
        username: currentUser.name
    });
    document.getElementById('newPostContent').value = '';
}

function loadPosts() {
    socket.emit('get posts');
}

function displayPosts(posts, prepend = false) {
    const container = document.getElementById('postsList');
    if (!prepend) {
        container.innerHTML = '';
    }

    if (posts.length === 0 && !prepend) {
        container.innerHTML = '<p class="text-slate-400 text-sm text-center">لا توجد منشورات بعد.</p>';
        return;
    }

    const postsHtml = posts.map(post => {
        // حساب وقت النشر
        const timeAgo = getTimeAgo(new Date(post.timestamp));
        const isLiked = post.likes && post.likes.includes(currentUser.name);
        const isLaughed = post.laughs && post.laughs.includes(currentUser.name);

        return `
            <div class="bg-gray-800/80 backdrop-blur-sm rounded-2xl p-5 border border-gray-700/50 shadow-lg hover:shadow-blue-900/10 transition-all duration-300 mb-4 group" id="post-card-${post.id}">
                <!-- Post Header -->
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <div class="relative cursor-pointer group/avatar" onclick="showUserProfileModal('${post.username}')">
                            <div class="absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full opacity-75 group-hover/avatar:opacity-100 transition duration-300 blur-[2px]"></div>
                            <img src="${post.avatar || defaultAvatars.guest}" class="relative w-12 h-12 rounded-full object-cover border-2 border-gray-900" alt="${post.username}">
                        </div>
                        <div>
                            <h4 class="font-bold text-white text-base hover:text-blue-400 transition-colors cursor-pointer" onclick="showUserProfileModal('${post.username}')">${post.username}</h4>
                            <span class="text-[10px] text-slate-400 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                ${timeAgo}
                            </span>
                        </div>
                    </div>
                    ${post.username === currentUser.name ? `
                        <button onclick="deletePost(${post.id})" class="text-slate-500 hover:text-red-500 p-2 rounded-full hover:bg-red-500/10 transition-all opacity-0 group-hover:opacity-100" title="حذف المنشور">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    ` : ''}
                </div>

                <!-- Post Content -->
                <div class="pl-2 border-r-2 border-gray-700/50 mr-1">
                    <p class="text-slate-200 text-sm leading-relaxed whitespace-pre-wrap break-words font-medium">${post.content}</p>
                </div>

                <!-- Post Actions -->
                <div class="flex items-center gap-4 mt-4 pt-3 border-t border-gray-700/50">
                    <button id="like-btn-${post.id}" onclick="likePost(${post.id})" class="flex items-center gap-2 px-3 py-1.5 rounded-full transition-all ${isLiked ? 'bg-pink-500/10 text-pink-500' : 'hover:bg-gray-700 text-slate-400 hover:text-pink-400'}">
                        <svg class="w-5 h-5 transform transition-transform active:scale-125" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z"></path>
                        </svg>
                        <span class="text-xs font-bold" id="like-count-${post.id}">${post.likes ? post.likes.length : 0}</span>
                    </button>
                    
                    <button id="laugh-btn-${post.id}" onclick="laughPost(${post.id})" class="flex items-center gap-2 px-3 py-1.5 rounded-full transition-all ${isLaughed ? 'bg-yellow-500/10 text-yellow-500' : 'hover:bg-gray-700 text-slate-400 hover:text-yellow-400'}">
                        <svg class="w-5 h-5 transform transition-transform active:scale-125" fill="${isLaughed ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" fill-rule="evenodd" d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z M8.5 11.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z M15.5 11.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z M12 17.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-xs font-bold" id="laugh-count-${post.id}">${post.laughs ? post.laughs.length : 0}</span>
                    </button>
                    
                    <button onclick="toggleComments(${post.id})" class="flex items-center gap-2 px-3 py-1.5 rounded-full hover:bg-gray-700 text-slate-400 hover:text-blue-400 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <span class="text-xs font-bold" id="comment-count-${post.id}">${post.comments ? post.comments.length : 0}</span>
                    </button>
                </div>

                <!-- Comments Section -->
                <div id="comments-section-${post.id}" class="hidden mt-4 space-y-3 bg-black/20 rounded-xl p-3">
                    <div id="comments-list-${post.id}" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-1">
                        ${post.comments ? post.comments.map(comment => `
                            <div class="flex gap-2 group/comment">
                                <div class="w-8 h-8 rounded-full bg-gray-700 flex-shrink-0 flex items-center justify-center text-xs font-bold text-gray-300 border border-gray-600 overflow-hidden">
                                    <img src="${userAvatars[comment.username] || defaultAvatars.guest}" class="w-full h-full object-cover" alt="${comment.username}">
                                </div>
                                <div class="flex-1 bg-gray-700/50 rounded-2xl rounded-tr-none p-3 border border-gray-600/30">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-xs font-bold text-blue-300 cursor-pointer hover:underline" onclick="showUserProfileModal('${comment.username}')">${comment.username}</span>
                                        <span class="text-[10px] text-slate-500">${new Date(comment.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}</span>
                                    </div>
                                    <p class="text-xs text-slate-200 leading-relaxed">${comment.content}</p>
                                </div>
                            </div>
                        `).join('') : ''}
                    </div>
                    <div class="relative">
                        <input type="text" id="comment-input-${post.id}" placeholder="اكتب تعليقاً..." class="w-full bg-gray-700/50 border border-gray-600 rounded-full pl-4 pr-12 py-2.5 text-sm text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:bg-gray-700 transition-all" onkeypress="if(event.key === 'Enter') addComment(${post.id})">
                        <button onclick="addComment(${post.id})" class="absolute left-1.5 top-1.5 bg-blue-600 hover:bg-blue-500 text-white p-1.5 rounded-full transition-colors shadow-lg">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    if (prepend) {
        container.insertAdjacentHTML('afterbegin', postsHtml);
    } else {
        container.innerHTML = postsHtml;
    }

    // التحقق مما إذا كان هناك انتقال معلق لمنشور (من الإشعارات)
    if (pendingPostScrollId) {
        setTimeout(() => {
            const postElement = document.getElementById(`post-card-${pendingPostScrollId}`);
            hideLoading(); // إخفاء شاشة التحميل العامة

            if (postElement) {
                postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                postElement.classList.add('ring-2', 'ring-blue-500', 'bg-blue-900/20'); // تمييز المنشور
                setTimeout(() => postElement.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-900/20'), 3000);
            } else {
                showNotification('لم يتم العثور على المنشور، قد يكون قديماً أو تم حذفه.', 'warning');
            }
            pendingPostScrollId = null; // إعادة تعيين المتغير
        }, 300); // انتظار قصير لضمان رسم العناصر في المتصفح
    }
}

function likePost(postId) {
    socket.emit('like post', {
        postId: postId,
        username: currentUser.name
    });
}

function laughPost(postId) {
    socket.emit('laugh post', {
        postId: postId,
        username: currentUser.name
    });
}

function toggleComments(postId) {
    const commentsSection = document.getElementById(`comments-section-${postId}`);
    commentsSection.classList.toggle('hidden');
    if (!commentsSection.classList.contains('hidden')) {
        document.getElementById(`comment-input-${postId}`).focus();
    }
}

function addComment(postId) {
    const commentInput = document.getElementById(`comment-input-${postId}`);
    const content = commentInput.value.trim();
    
    if (!content) {
        showNotification('يرجى كتابة تعليق', 'error');
        return;
    }
    
    socket.emit('add comment', {
        postId: postId,
        username: currentUser.name,
        content: content
    });
    commentInput.value = '';
}

function deletePost(postId) {
    if (confirm('هل أنت متأكد من حذف هذا المنشور؟ لا يمكن التراجع عن هذا الإجراء.')) {
        socket.emit('delete post', {
            postId: postId,
            username: currentUser.name
        });
    }
}

function getTimeAgo(date) {
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000); 
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (days > 0) return `منذ ${days} يوم`;
    if (hours > 0) return `منذ ${hours} ساعة`;
    if (minutes > 0) return `منذ ${minutes} دقيقة`;
    return 'الآن';
}

// أحداث السوكيت للمنشورات
socket.on('posts data', (posts) => {
    displayPosts(posts);
});

socket.on('new post', (newPost) => {
    showNotification(`منشور جديد من ${newPost.username}`, 'info');
    // إضافة المنشور الجديد في الأعلى بدلاً من إعادة التحميل
    const container = document.getElementById('postsList');
    if (container.querySelector('p')) { // إذا كانت هناك رسالة "لا توجد منشورات"
        container.innerHTML = '';
    }
    displayPosts([newPost], true);
});

socket.on('post liked', ({ postId, likes }) => {
    const likeCountElem = document.getElementById(`like-count-${postId}`);
    const likeBtnElem = document.getElementById(`like-btn-${postId}`);
    
    if (likeCountElem && likeBtnElem) {
        likeCountElem.textContent = likes.length;
        const isLiked = likes.includes(currentUser.name);
        likeBtnElem.classList.toggle('text-pink-500', isLiked);
        likeBtnElem.classList.toggle('bg-pink-500/10', isLiked);
        likeBtnElem.querySelector('svg').setAttribute('fill', isLiked ? 'currentColor' : 'none');
    }
});

socket.on('post laughed', ({ postId, laughs }) => {
    const laughCountElem = document.getElementById(`laugh-count-${postId}`);
    const laughBtnElem = document.getElementById(`laugh-btn-${postId}`);
    
    if (laughCountElem && laughBtnElem) {
        laughCountElem.textContent = laughs.length;
        const isLaughed = laughs.includes(currentUser.name);
        laughBtnElem.classList.toggle('text-yellow-500', isLaughed);
        laughBtnElem.classList.toggle('bg-yellow-500/10', isLaughed);
        laughBtnElem.querySelector('svg').setAttribute('fill', isLaughed ? 'currentColor' : 'none');
    }
});

socket.on('comment added', ({ postId, username, content, timestamp, avatar }) => {
    const commentsList = document.getElementById(`comments-list-${postId}`);
    const commentCountElem = document.getElementById(`comment-count-${postId}`);

    if (commentsList && commentCountElem) {
        const newComment = document.createElement('div');
        newComment.className = 'flex gap-2 group/comment';
        newComment.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-gray-700 flex-shrink-0 flex items-center justify-center text-xs font-bold text-gray-300 border border-gray-600 overflow-hidden">
                 <img src="${avatar || defaultAvatars.guest}" class="w-full h-full object-cover" alt="${username}">
            </div>
            <div class="flex-1 bg-gray-700/50 rounded-2xl rounded-tr-none p-3 border border-gray-600/30">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-xs font-bold text-blue-300 cursor-pointer hover:underline" onclick="showUserProfileModal('${username}')">${username}</span>
                    <span class="text-[10px] text-slate-500">${new Date(timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}</span>
                </div>
                <p class="text-xs text-slate-200 leading-relaxed">${content}</p>
            </div>
        `;
        commentsList.appendChild(newComment);
        commentsList.scrollTop = commentsList.scrollHeight; // تمرير لأسفل
        commentCountElem.textContent = parseInt(commentCountElem.textContent) + 1;
    }
});

socket.on('post deleted', ({ postId }) => {
    document.getElementById(`post-card-${postId}`)?.remove();
});

socket.on('post delete success', (message) => {
    showNotification(message, 'success');
});

socket.on('post delete error', (error) => {
    showNotification(error, 'error');
});
// إضافة مستمعي الأحداث للأزرار الجديدة
document.getElementById('postsButton').addEventListener('click', openPostsSidebar);

document.getElementById('chatPostsButton')?.addEventListener('click', openPostsSidebar);
document.getElementById('chatFriendsButton')?.addEventListener('click', openFriendsSidebar);
document.getElementById('chatMessagesButton')?.addEventListener('click', function(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('privateConversationsDropdown');
    const otherDropdown = document.getElementById('chatNotificationsDropdown');
    const isOpening = dropdown.classList.contains('hidden');
 
    dropdown.classList.toggle('hidden');
 
    if (isOpening) {
        otherDropdown.classList.add('hidden');
        document.getElementById('privateConversationsList').innerHTML = '<div class="text-center p-4"><div class="spinner mx-auto" style="width: 24px; height: 24px; border-width: 3px;"></div><p class="mt-2 text-slate-400 text-xs">جاري التحميل...</p></div>';
        socket.emit('get private conversations', currentUser.name);
        showDot('messages', false);
    }
});
document.getElementById('chatNotificationsButton')?.addEventListener('click', toggleNotificationsDropdown);

// إغلاق القائمة عند النقر خارجها
document.addEventListener('click', function (e) {
    const privateDropdown = document.getElementById('privateConversationsDropdown');
    const privateButton = document.getElementById('chatMessagesButton');
    if (privateDropdown && !privateDropdown.contains(e.target) && !privateButton.contains(e.target)) {
        privateDropdown.classList.add('hidden');
    }

    const dropdown = document.getElementById('chatNotificationsDropdown');
    const button = document.getElementById('chatNotificationsButton');
    if (dropdown && !dropdown.contains(e.target) && !button.contains(e.target)) {
        dropdown.classList.add('hidden');
    }
});

function updateNotificationsBadge(hasUnread) {
    const badge = document.getElementById('chatNotificationsBadge');
    if (badge) {
        badge.classList.toggle('hidden', !hasUnread);
    }
}


socket.on('new notification', (notification) => {
    if (!document.getElementById('chatNotificationsDropdown').classList.contains('hidden')) {
        showNotification(`🔔 لديك إشعار جديد!`, 'info');
        socket.emit('get unread counts', currentUser.name);
    }
});

socket.on('notifications list', (notifications) => {
    const container = document.getElementById('chatNotificationsList');
    container.innerHTML = '';
    const unreadCount = notifications.filter(n => !n.read).length;

    if (notifications.length === 0) {
        container.innerHTML = '<p class="text-blue-200 text-sm text-center p-4">لا توجد إشعارات</p>';
        return;
    }

    notifications.forEach(notif => {
        const notifDiv = document.createElement('div');
        notifDiv.className = `p-2 text-sm rounded-md hover:bg-white/10 cursor-pointer ${!notif.read ? 'bg-blue-500/20' : ''}`;
        
        if (notif.type === 'gift_rank') {
            notifDiv.setAttribute('onclick', `showUserProfileModal('${currentUser.name}')`);
        } else {
            notifDiv.setAttribute('onclick', `goToPost(${notif.postId})`);
        }

        let text = '';
        if (notif.type === 'like') {
            text = `👍 أعجب <strong class="text-white">${notif.senderUsername}</strong> بمنشورك.`;
        } else if (notif.type === 'laugh') {
            text = `😂 أضحك <strong class="text-white">${notif.senderUsername}</strong> على منشورك.`;
        } else if (notif.type === 'comment') {
            text = `💬 علّق <strong class="text-white">${notif.senderUsername}</strong> على منشورك.`;
        } else if (notif.type === 'new_post') {
            text = `✍️ نشر <strong class="text-white">${notif.senderUsername}</strong> منشوراً جديداً.`;
        } else if (notif.type === 'gift_rank') {
            text = `🎁 أهداك <strong class="text-white">${notif.senderUsername}</strong> رتبة جديدة!`;
        }

        notifDiv.innerHTML = `<p class="text-slate-300">${text}</p>`;
        container.appendChild(notifDiv);
    });
});

socket.on('private conversations list', (conversations) => {
    const container = document.getElementById('privateConversationsList');
    container.innerHTML = '';
    let totalUnread = 0;

    if (conversations.length === 0) {
        container.innerHTML = '<p class="text-slate-400 text-sm text-center p-4">لا توجد محادثات خاصة بعد.</p>';
        return;
    }

    conversations.forEach(conv => {
        const convDiv = document.createElement('div');
        const otherUser = conv.otherUser;
        const avatarUrl = userAvatars[otherUser] || defaultAvatars.guest;

        if (conv.unreadCount > 0) {
            totalUnread += conv.unreadCount;
        }

        convDiv.className = `flex items-center p-2 rounded-md cursor-pointer transition-colors ${conv.unreadCount > 0 ? 'bg-blue-500/20' : 'hover:bg-white/10'}`;
        convDiv.onclick = () => {
            openPrivateChat(otherUser);
            document.getElementById('privateConversationsDropdown').classList.add('hidden');
        };

        convDiv.innerHTML = `
            <div class="relative flex-shrink-0">
                <img src="${avatarUrl}" class="w-10 h-10 rounded-full object-cover" alt="${otherUser}">
                ${conv.isOnline ? '<span class="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full bg-green-500 border-2 border-slate-800"></span>' : ''}
            </div>
            <div class="flex-1 min-w-0 mx-3">
                <div class="flex justify-between items-center">
                    <p class="text-white font-semibold truncate">${otherUser}</p>
                </div>
                <div class="flex justify-between items-center">
                    <p class="text-slate-400 text-sm truncate">${conv.lastMessage.content}</p>
                    ${conv.unreadCount > 0 ? `<span class="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">${conv.unreadCount}</span>` : ''}
                </div>
            </div>
        `;
        container.appendChild(convDiv);
    });
});

socket.on('private conversations updated', () => {
    socket.emit('get unread counts', currentUser.name);
    // إذا كانت القائمة مفتوحة، قم بتحديثها
    if (!document.getElementById('privateConversationsDropdown').classList.contains('hidden')) {
        socket.emit('get private conversations', currentUser.name);
    }
});

socket.on('unread counts data', (counts) => {
    updateMessagesBadge(counts.privateMessages);
    updateNotificationsBadge(counts.notifications > 0);
});

function toggleNotificationsDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('chatNotificationsDropdown');
    const otherDropdown = document.getElementById('privateConversationsDropdown');
    const isHidden = dropdown.classList.contains('hidden');

    otherDropdown.classList.add('hidden'); // إخفاء قائمة الرسائل دائماً

    if (isHidden) {
        document.getElementById('chatNotificationsList').innerHTML = '<div class="text-center p-4"><div class="spinner mx-auto" style="width: 24px; height: 24px; border-width: 3px;"></div><p class="mt-2 text-slate-400 text-xs">جاري التحميل...</p></div>';
        socket.emit('get notifications', currentUser.name);
        dropdown.classList.remove('hidden');
        setTimeout(() => {
            socket.emit('mark notifications as read', currentUser.name);
            updateNotificationsBadge(false);
        }, 2000);
    } else {
        dropdown.classList.add('hidden');
    }
}

function goToPost(postId) {
    // 1. إغلاق قائمة الإشعارات
    document.getElementById('chatNotificationsDropdown').classList.add('hidden');

    // 2. تعيين المنشور المستهدف وإظهار التحميل
    pendingPostScrollId = postId;
    showLoading('جاري تحميل المنشور...');

    // 3. فتح القائمة وطلب البيانات (سيتم التعامل مع التمرير في displayPosts)
    openPostsSidebar();
}

// دوال قائمة المتفاعلين
function openTopUsersModal() {
    const modal = document.getElementById('topUsersModal');
    const overlay = document.getElementById('topUsersOverlay');
    modal.classList.add('show');
    overlay.classList.add('show');
    
    // طلب البيانات من السيرفر
    socket.emit('get top users');
}

function closeTopUsersModal() {
    const modal = document.getElementById('topUsersModal');
    const overlay = document.getElementById('topUsersOverlay');
    modal.classList.remove('show');
    overlay.classList.remove('show');
    
    // إعادة تعيين المحتوى إلى حالة التحميل
    const container = document.getElementById('topUsersListContainer');
    container.innerHTML = `
        <div class="text-center text-blue-200 p-8">
            <div class="spinner mx-auto"></div>
            <p class="mt-2">جاري تحميل القائمة...</p>
        </div>
    `;
}

socket.on('top users list', (users) => {
    const container = document.getElementById('topUsersListContainer');
    container.innerHTML = '';

    if (users.length === 0) {
        container.innerHTML = '<p class="text-slate-400 text-center p-8">لا يوجد متفاعلون لعرضهم بعد.</p>';
        return;
    }

    users.forEach((user, index) => {
        const userDiv = document.createElement('div');
        userDiv.className = 'flex items-center bg-gray-800 p-3 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer';
        userDiv.onclick = () => showUserProfileModal(user.username);

        userDiv.innerHTML = `
            <div class="flex-shrink-0 w-10 text-center text-xl font-bold ${index < 3 ? 'text-yellow-400' : 'text-blue-300'}">${index + 1}</div>
            ${user.avatar ? 
                `<img src="${user.avatar}" class="w-10 h-10 rounded-full object-cover" alt="${user.username}">` :
                `<div class="w-10 h-10 rounded-full bg-gray-500 flex items-center justify-center text-white font-bold">${user.username.charAt(0).toUpperCase()}</div>`
            }
            <div class="flex-1 min-w-0 mx-3">
                <div class="text-white font-semibold truncate">${user.username}</div>
                <div class="text-xs text-slate-400">📈 المستوى ${user.level}</div>
            </div>
            <div class="text-yellow-400 font-bold text-sm">⭐ ${user.points}</div>
        `;
        container.appendChild(userDiv);
    });
});

document.getElementById('chatPostsButton').addEventListener('click', openPostsSidebar);

        // إضافة هذه الدوال في قسم JavaScript

function applyBackground(backgroundData, isRoomBackground = false) {
    const body = document.body;
    console.log('Applying background:', { isRoomBackground, backgroundData });
    
    // إزالة الطبقة الشفافة السابقة إذا كانت موجودة
    const existingOverlay = document.getElementById('background-overlay');
    if (existingOverlay) {
        existingOverlay.remove();
    }

    // إذا لم تكن خلفية غرفة، نطبق الخلفية السوداء الافتراضية للموقع
    if (!isRoomBackground) {
        body.style.backgroundColor = '#000000';
        body.style.backgroundImage = 'none';
        body.className = body.className.split(' ').filter(c => 
            !c.startsWith('from-') && !c.startsWith('via-') && !c.startsWith('to-') && 
            c !== 'bg-gradient-to-br' && c !== 'bg-gradient-to-t' && c !== 'bg-slate-900'
        ).join(' ');
        if (!body.classList.contains('bg-black')) body.classList.add('bg-black');
        return;
    }

    // تطبيق خلفية الغرفة
    if (backgroundData) {
        // تنظيف كلاسات التدرج والسواد السابقة دائماً لضمان عدم التداخل
        body.className = body.className.split(' ').filter(c => 
            !c.startsWith('from-') && !c.startsWith('via-') && !c.startsWith('to-') && 
            c !== 'bg-gradient-to-br' && c !== 'bg-gradient-to-t' && c !== 'bg-black' && c !== 'bg-slate-900'
        ).join(' ');
        
        if (backgroundData.type === 'image') {
            body.style.backgroundColor = 'transparent';
            body.style.backgroundImage = `url('${backgroundData.value}')`;
            body.style.backgroundSize = 'cover';
            body.style.backgroundRepeat = 'no-repeat';
            body.style.backgroundAttachment = 'fixed';
            body.style.backgroundPosition = 'center';
            
            const overlay = document.createElement('div');
            overlay.id = 'background-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.3);
                z-index: -1;
                pointer-events: none;
            `;
            body.appendChild(overlay);
        } else if (backgroundData.type === 'color') {
            body.style.backgroundColor = backgroundData.value;
            body.style.backgroundImage = 'none';
        } else {
            body.style.backgroundColor = '';
            body.style.backgroundImage = ''; // إزالة الخلفية اليدوية للسماح لكلاسات التدرج بالعمل
            // التأكد من إضافة كلاس التدرج
            if (!body.classList.contains('bg-gradient-to-br')) {
                body.classList.add('bg-gradient-to-br');
            }
            const gradientClasses = backgroundData.value.split(' ');
            gradientClasses.forEach(className => {
                if (className.trim()) body.classList.add(className.trim());
            });
        }
    }
}

// طلب الاتصال
socket.on('connect', () => {
    // عند تسجيل الدخول، التحقق من بيانات المستخدم
    socket.on('login success', (userData) => {
        currentUser = userData;
    });
    
    socket.on('register success', (userData) => {
        currentUser = userData;
    });
    
    socket.on('session valid', (userData) => {
        currentUser = userData;
    });
});
// دوال إرسال الصور
function openImageUpload() {
    document.getElementById('imageUpload').click();
}

function openPrivateImageUpload() {
    document.getElementById('privateImageUpload').click();
}

function openImageUploadForProfile() {
    document.getElementById('profileImageUpload').click();
}

function removeProfilePic() {
    if (confirm('هل أنت متأكد من حذف صورتك الشخصية والعودة للصورة الافتراضية؟')) {
        socket.emit('update avatar', {
            username: currentUser.name,
            avatarUrl: null,
            currentUser: { ...currentUser, roomId: currentRoom ? currentRoom.id : null }
        });
    }
}

function removeCover() {
    if (confirm('هل أنت متأكد من حذف غلاف الملف الشخصي؟')) {
        socket.emit('update profile cover', {
            username: currentUser.name,
            coverUrl: null,
            currentUser: currentUser
        });
    }
}

// معالجة تحميل صورة الملف الشخصي
document.getElementById('profileImageUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        showNotification('يرجى اختيار ملف صورة فقط', 'error');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showNotification('حجم الصورة يجب أن يكون أقل من 5MB', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const imageData = e.target.result;
        socket.emit('update avatar', {
            username: currentUser.name,
            avatarUrl: imageData,
            currentUser: { ...currentUser, roomId: currentRoom ? currentRoom.id : null }
        });
    };
    reader.readAsDataURL(file);
    e.target.value = ''; // إعادة تعيين الحقل
});

// معالجة تحميل الصور للمحادثة العامة
document.getElementById('imageUpload').addEventListener('change', function(e) {
    handleImageUpload(e, 'public');
});

// معالجة تحميل الصور للمحادثة الخاصة
document.getElementById('privateImageUpload').addEventListener('change', function(e) {
    handleImageUpload(e, 'private');
});

// في دالة handleImageUpload، تأكد من جزء المحادثة الخاصة
function handleImageUpload(event, type) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        showNotification('يرجى اختيار ملف صورة فقط', 'error');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showNotification('حجم الصورة يجب أن يكون أقل من 5MB', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const imageData = e.target.result;
        
        if (type === 'public') {
            socket.emit('send image message', {
                roomId: currentRoom.id,
                imageData: imageData,
                user: currentUser
            });
        } else {
            // للمحادثة الخاصة
            if (!privateChatTarget) {
                showNotification('يرجى فتح محادثة خاصة أولاً', 'error');
                return;
            }
            
            socket.emit('send private image', {
                toUser: privateChatTarget,
                imageData: imageData,
                fromUser: currentUser.name
            });
        }
        
        event.target.value = '';
    };
    
    reader.readAsDataURL(file);
}

// معالجة لصق الصور في حقل النص
function setupPasteHandler() {
    // للمحادثة العامة
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('paste', function(e) {
            handlePaste(e, 'public');
        });
    }
    
    // للمحادثة الخاصة
    const privateMessageInput = document.getElementById('privateMessageInput');
    if (privateMessageInput) {
        privateMessageInput.addEventListener('paste', function(e) {
            handlePaste(e, 'private');
        });
    }
}

function handlePaste(event, type) {
    const items = event.clipboardData?.items;
    if (!items) return;
    
    for (let item of items) {
        if (item.type.indexOf('image') !== -1) {
            event.preventDefault();
            
            const file = item.getAsFile();
            if (!file) return;
            
            // التحقق من حجم الملف (5MB كحد أقصى)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('حجم الصورة يجب أن يكون أقل من 5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                
                if (type === 'public') {
                    socket.emit('send image message', {
                        roomId: currentRoom.id,
                        imageData: imageData,
                        user: currentUser
                    });
                } else {
                    socket.emit('send private image', {
                        toUser: privateChatTarget,
                        imageData: imageData,
                        fromUser: currentUser.name
                    });
                }
            };
            
            reader.readAsDataURL(file);
            break;
        }
    }
}

// استقبال رسائل الصور في المحادثة العامة
socket.on('new image message', (message) => {
    addImageMessageToChat(message.user, message.imageData, message.time, message.user === currentUser.name, message.rank, message.avatar, message.messageId, null, message.timestamp, message.replyTo);
});

// استقبال رسائل الصور في المحادثة الخاصة
socket.on('new private image', (message) => {
    addPrivateImageMessage(message, message.from === currentUser.name);
});

socket.on('private image sent', (message) => {
    addPrivateImageMessage(message, true);
});

// إضافة رسالة صورة إلى المحادثة العامة
// إضافة رسالة صورة إلى الدردشة (نسخة مدمجة)
function addImageMessageToChat(user, imageData, time, isOwn, userRank, avatarUrl, messageId = null, targetContainer = null, timestamp = null, replyTo = null, badges = null, nameCardBorder = null, nameFont = null) {
    const container = targetContainer || document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    
    // تشغيل صوت المنشن إذا كان هناك منشن في الرد (ReplyTo)
    if (currentUser && replyTo && replyTo.content && replyTo.content.includes(`@${currentUser.name}`)) {
        if (!targetContainer && userSettings.playMentionSound) {
            mentionSound.play().catch(e => console.log("Audio play blocked:", e));
        }
    }

    const timeStr = formatMessageTime(timestamp || Date.now());
    
    // إحضار عدد الأوسمة
    let achievementCount = 0;
    if (badges && Array.isArray(badges)) {
        achievementCount = badges.length;
    } else {
        const onlineUserForBadges = isOwn ? currentUser : (window.onlineUsersData ? window.onlineUsersData[user] : null);
        achievementCount = (onlineUserForBadges && onlineUserForBadges.badges) ? onlineUserForBadges.badges.length : 0;
    }
    const achievementCountBadge = achievementCount > 0 ? `<div class="achievement-count-badge" title="${achievementCount} أوسمة">${achievementCount}</div>` : '';

    // توحيد المحاذاة مع الرسائل النصية
    messageDiv.className = `chat-message flex flex-row items-start w-full user-message`;
    
    // --- التصميم الجديد المدمج ---
    const messageBgClass = currentRoomSettings?.messageBackground || 'bg-gray-800';
    const messageTextColorClass = currentRoomSettings?.textColor || 'text-white';
    
    if (!messageId) {
        messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    messageDiv.setAttribute('data-message-id', messageId);
    
    let rankBadge = '';
    if (userRank) {
        const rankInfo = ranks[userRank] || {}; 
        const iconHtml = getRankIconHtml(rankInfo.icon, "text-base");
        rankBadge = `<span title="${userRank}" class="mx-1 inline-flex items-center align-middle">${iconHtml}</span>`;
    }

    // منطق الصلاحيات الموحد للحذف
    const senderLevel = userRank ? (ranks[userRank]?.level || 0) : 0;
    const myLevel = currentUser.rank ? (ranks[currentUser.rank]?.level || 0) : 0;
    const isMessageOwner = user === currentUser.name;
    const canDelete = (currentUser.isSiteOwner) || (isMessageOwner && currentUser.rank) || (myLevel > senderLevel && myLevel >= 2);

    let directActions = `
        <button class="hover:opacity-80 transition-opacity" title="رد" onclick="startReply('${messageId}', '${user}', '${imageData}')">
            <span class="inline-flex items-center justify-center w-5 h-5 bg-slate-700 rounded text-white shadow-sm">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
            </span>
        </button>
    `;

    if (canDelete) {
        directActions += `
            <button class="text-gray-400 hover:text-red-500 transition-colors" title="حذف" onclick="deleteRoomMessage('${messageId}')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>`;
    }

    let extraMenuItems = '';
    if (canDelete) {
        extraMenuItems += `<button class="block w-full text-right px-4 py-2 hover:bg-red-600/20 text-red-400" data-action="delete">❌ حذف الصورة</button>`;
    }
    
    if ((currentUser.isSiteOwner || (myLevel > senderLevel && myLevel >= 2)) && !isMessageOwner) {
        extraMenuItems += `
            <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" data-action="mute">🔇 كتم المستخدم</button>
            <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" data-action="unmute">🔊 إلغاء كتم المستخدم</button>
            <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" data-action="warn">⚠️ تحذير المستخدم</button>
            <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" data-action="banRoom">🚫 حظر من الغرفة</button>
        `;
    }

    let menuBtn = `
    <div class="relative inline-block ml-2">
        <button class="menu-btn text-gray-400 hover:text-blue-500 text-xl font-bold px-1" title="خيارات إضافية" data-message-id="${messageId}" data-user="${user}" data-content="${imageData}">⋮</button>
        <div class="message-menu hidden absolute left-0 z-50 bg-slate-800 text-white rounded shadow-lg mt-2 min-w-[160px] text-sm border border-slate-700 overflow-hidden">
            ${extraMenuItems}
        </div>
    </div>
    `;

    // معالجة الرد (ReplyTo)
    let replyHtml = '';
    if (replyTo) {
        // التحقق مما إذا كان المحتوى يحتوي على إيموجي (سواء وحده أو مع نص)
        const allEmojis = [...new Set([...animatedEmojis, ...localEmojis])];
        const containsEmoji = replyTo.content && allEmojis.some(e => replyTo.content.includes(e));
        const isImageReply = replyTo.content && (replyTo.content.startsWith('data:image') || replyTo.content.startsWith('http') || replyTo.content.includes('🖼️ صورة') || replyTo.content.includes('صورة 🖼️'));
        
        let displayContent = replyTo.content;
        if (containsEmoji) {
            displayContent = formatMessageWithInlineEmojis(replyTo.content);
        } else if (isImageReply) {
            displayContent = 'صورة 🖼️';
        }

        // تطبيق تلوين المنشن في الرد أيضاً
        if (!isImageReply && currentUser && displayContent && typeof displayContent === 'string' && displayContent.includes(`@${currentUser.name}`)) {
            const mentionRegex = new RegExp(`@${currentUser.name}\\b`, 'g');
            displayContent = displayContent.replace(mentionRegex, `<span class="text-yellow-400 font-bold">@${currentUser.name}</span>`);
        }

        // البحث عن أول إيموجي لعرضه في المعاينة إذا لم تكن صورة
        let emojiPreviewUrl = null;
        if (containsEmoji && !isImageReply) {
            emojiPreviewUrl = allEmojis.find(e => replyTo.content.includes(e));
        }

        const imagePreview = (isImageReply || emojiPreviewUrl) 
            ? `<img src="${isImageReply ? replyTo.content : emojiPreviewUrl}" class="w-10 h-10 rounded-md object-cover ml-2 border border-white/10 shadow-sm">` 
            : '';

        replyHtml = `
            <a href="#${replyTo.messageId}" onclick="scrollToMessage('${replyTo.messageId}')" class="block bg-black/20 hover:bg-black/30 p-2 rounded-lg mb-2 text-xs border-r-4 border-blue-500 transition-colors">
                <div class="flex items-center justify-between gap-3">
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-blue-400 mb-0.5">الرد على ${replyTo.user}</div>
                        <p class="opacity-70 truncate text-slate-300">${displayContent}</p>
                    </div>
                    ${imagePreview}
                </div>
            </a>
        `;
    }

    // تحديد الألوان والإطارات
    let nameColorClass, nameBgClass, avatarFrameClass, currentNameCardBorder, nameFontClass;
    if (isOwn) {
        nameColorClass = currentUser.nameColor || 'text-blue-100';
        nameBgClass = currentUser.nameBackground || '';
        avatarFrameClass = currentUser.avatarFrame || '';
        currentNameCardBorder = nameCardBorder || currentUser.nameCardBorder || null;
        nameFontClass = nameFont || currentUser.nameFont || '';
    } else {
        const onlineUser = window.onlineUsersData ? window.onlineUsersData[user] : null;
        if (onlineUser) {
            nameColorClass = (onlineUser.nameColor && onlineUser.nameColor !== 'null') ? onlineUser.nameColor : 'text-blue-200';
            nameBgClass = (onlineUser.nameBackground && onlineUser.nameBackground !== 'null') ? onlineUser.nameBackground : '';
            avatarFrameClass = (onlineUser.avatarFrame && onlineUser.avatarFrame !== 'null') ? onlineUser.avatarFrame : '';
            currentNameCardBorder = nameCardBorder || onlineUser.nameCardBorder || null;
            nameFontClass = nameFont || onlineUser.nameFont || '';
        } else {
            nameColorClass = 'text-blue-200';
            nameBgClass = '';
            avatarFrameClass = '';
            currentNameCardBorder = nameCardBorder || null;
            nameFontClass = nameFont || '';
        }
    }

    // تجهيز نمط إطار الفقاعة
    let bubbleStyle = '';
    if (currentNameCardBorder && currentNameCardBorder.startsWith('border-color:')) {
        bubbleStyle = `border: 2px solid ${currentNameCardBorder.split(':')[1]};`;
    }

    const avatarHtml = avatarUrl 
        ? `<div class="w-full h-full rounded-full relative ${(avatarFrameClass && !avatarFrameClass.startsWith('border-color:')) ? avatarFrameClass : ''}" style="${(avatarFrameClass && avatarFrameClass.startsWith('border-color:')) ? `border: 2px solid ${avatarFrameClass.split(':')[1]};` : ''}">${achievementCountBadge}<img src="${avatarUrl}" class="w-full h-full rounded-full object-cover" alt="${user}"></div>`
        : `<div class="w-full h-full rounded-full relative bg-gray-400 flex items-center justify-center text-white font-bold text-sm ${(avatarFrameClass && !avatarFrameClass.startsWith('border-color:')) ? avatarFrameClass : ''}" style="${(avatarFrameClass && avatarFrameClass.startsWith('border-color:')) ? `border: 2px solid ${avatarFrameClass.split(':')[1]};` : ''}">${achievementCountBadge}${user.charAt(0).toUpperCase()}</div>`;

    messageDiv.innerHTML = `
        <div class="flex items-start gap-3">
            <div class="avatar-container flex-shrink-0 cursor-pointer" onclick="showUserProfileModal('${user}')">
                ${avatarHtml}
            </div>
            <div class="flex items-end gap-2 flex-wrap">
                <div class="message-bubble relative ${messageBgClass + ' ' + messageTextColorClass} rounded-lg p-2 max-w-[250px] sm:max-w-md w-fit" style="${bubbleStyle}">
                    ${replyHtml}
                    <div class="message-content leading-snug flex flex-col gap-1">
                        <div class="flex items-center flex-wrap gap-1">
                            ${rankBadge}
                            <span class="username-text font-bold cursor-pointer ${nameColorClass} ${nameBgClass ? nameBgClass + ' px-1 rounded' : ''} ${nameFontClass}" onclick="mentionUser('${user}')">${user}</span>
                            <span class="font-bold">:</span>
                        </div>
                        <div class="relative">
                            <img src="${imageData}" class="max-w-full h-auto rounded-lg cursor-pointer chat-image" onclick="openImageModal('${imageData}')" alt="صورة محادثة">
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-1 mb-1 message-actions">
                    <span class="timestamp-text opacity-70 text-gray-400 text-[10px] ml-1">${timeStr}</span> 
                    ${directActions}
                    ${menuBtn}
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}
// استقبال حدث حذف الرسالة من السيرفر
socket.on('room message deleted', ({ messageId }) => {
    // حاول حذف الرسالة سواء بالمعرف الحقيقي أو المؤقت
    let msgElem = document.querySelector(`[data-message-id="${messageId}"]`);
    if (!msgElem && window.tempMessageIdMap) {
        // ابحث عن أي معرف مؤقت مرتبط بهذا المعرف
        for (const [tempId, realId] of Object.entries(window.tempMessageIdMap)) {
            if (realId === messageId) {
                msgElem = document.querySelector(`[data-message-id="${tempId}"]`);
                break;
            }
        }
    }
    if (msgElem) msgElem.remove();
});

// دالة حذف رسالة غرفة
function deleteRoomMessage(messageId) {
    if (!currentRoom || !currentUser) return;
    if (!confirm('هل أنت متأكد من حذف هذه الرسالة؟')) return;
    socket.emit('delete room message', {
        roomId: currentRoom.id,
        messageId: messageId,
        currentUser: currentUser
    });
}

// إضافة رسالة صورة إلى المحادثة الخاصة بشكل احترافي
function addPrivateImageMessage(message, isOwn) {
    const container = document.getElementById('privateChatMessages');
    if (!container) return;

    // إزالة مؤشر التحميل إذا كان موجوداً
    const loader = document.getElementById('privateChatLoader');
    if (loader) {
        container.innerHTML = '';
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-4 flex ${isOwn ? 'flex-row-reverse' : 'flex-row'} items-end gap-2 chat-message`;
    
    const timeStr = formatMessageTime(message.timestamp || Date.now());
    const avatarUrl = message.avatar || DEFAULT_AVATAR_URL;
    
    // استخدام صورة مؤقتة أثناء التحميل
    const loadingImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPua1i+ivleWbvuWDjzwvdGV4dD48L3N2Zz4=';
    
    messageDiv.innerHTML = `
        <img src="${avatarUrl}" class="w-8 h-8 rounded-full border border-white/10" alt="avatar">
        <div class="flex flex-col ${isOwn ? 'items-end' : 'items-start'} max-w-[75%]">
            <div class="p-1 rounded-2xl text-sm ${
                isOwn ? 'bg-blue-600 rounded-br-none shadow-lg shadow-blue-900/20' : 'bg-slate-700 rounded-bl-none shadow-lg shadow-black/20'
            }">
                <div class="relative overflow-hidden rounded-xl">
                    <img src="${loadingImage}" data-src="${message.imageData}" class="max-w-full h-auto rounded-lg cursor-pointer chat-image transition-transform hover:scale-[1.02]" onclick="openImageModal('${message.imageData}')" alt="صورة محادثة" onload="handleImageLoad(this)" onerror="handleImageError(this)"> 
                </div>
            </div>
            <div class="text-[10px] opacity-50 mt-1 mx-1">${timeStr}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    
    // تحميل الصورة بعد إضافتها للDOM
    setTimeout(() => {
        loadImageIfNeeded(message.imageData, (finalImageData) => {
            const img = messageDiv.querySelector('img.chat-image');
            if (img) {
                img.src = finalImageData;
                img.setAttribute('onclick', `openImageModal('${finalImageData}')`);
            }
        });
    }, 100);
    
    container.scrollTop = container.scrollHeight;
}

// نافذة عرض الصورة بشكل مكبر
function openImageModal(imageData) {
    // إنشاء نافذة عرض الصورة
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="relative max-w-4xl max-h-full">
            <button onclick="closeImageModal()" class="absolute -top-12 left-0 text-white text-2xl z-10">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <img src="${imageData}" class="max-w-full max-h-full object-contain" alt="صورة مكبرة">
        </div>
    `;
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeImageModal();
        }
    });
    
    document.body.appendChild(modal);
}

function closeImageModal() {
    const modal = document.querySelector('.fixed.inset-0.bg-black');
    if (modal) {
        modal.remove();
    }
}

// تحديث واجهة المستخدم لإضافة أزرار الصور والايموجيات
function updateUIWithImageButtons() {
    // تحديث واجهة المحادثة العامة
    const messageInputContainer = document.getElementById('messageInputContainer');
    if (messageInputContainer) {
        // زر الصور
        if (!messageInputContainer.querySelector('#imageButton')) {
            const imageButton = document.createElement('button');
            imageButton.id = 'imageButton';
            imageButton.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
            `;
                    imageButton.className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full font-semibold transition-colors flex items-center justify-center';
            imageButton.onclick = openImageUpload;
            imageButton.title = 'إرسال صورة';
            
            const sendButton = messageInputContainer.querySelector('#sendMessageButton');
            messageInputContainer.insertBefore(imageButton, sendButton);
        }

        // زر الايموجيات المتحركة
        if (!messageInputContainer.querySelector('#emojiButton')) {
            const emojiButton = document.createElement('button');
            emojiButton.id = 'emojiButton';
            emojiButton.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            `;
                    emojiButton.className = 'bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-full font-semibold transition-colors flex items-center justify-center';
            emojiButton.onclick = (e) => {
                e.stopPropagation();
                toggleEmojiPicker(false);
            };
            emojiButton.title = 'ايموجيات متحركة';
            
            const imageButton = messageInputContainer.querySelector('#imageButton');
            messageInputContainer.insertBefore(emojiButton, imageButton);
        }
    }
    
    // تحديث واجهة المحادثة الخاصة
    const privateChatInput = document.querySelector('.private-chat-input .flex');
    if (privateChatInput) {
        // زر الصور الخاص
        if (!privateChatInput.querySelector('#privateImageButton')) {
            const privateImageButton = document.createElement('button');
            privateImageButton.id = 'privateImageButton';
            privateImageButton.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
            `;
            privateImageButton.className = 'bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-full font-semibold transition-colors flex items-center justify-center text-sm';
            privateImageButton.onclick = openPrivateImageUpload;
            privateImageButton.title = 'إرسال صورة';
            
            const privateSendButton = privateChatInput.querySelector('button[onclick="sendPrivateMessage()"]');
            privateChatInput.insertBefore(privateImageButton, privateSendButton);
        }

        // زر الايموجيات المتحركة الخاص (يمكنك إضافته للمحادثة الخاصة أيضاً إذا أردت)
        if (!privateChatInput.querySelector('#privateEmojiButton')) {
            const privateEmojiButton = document.createElement('button');
            privateEmojiButton.id = 'privateEmojiButton';
            privateEmojiButton.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            `;
            privateEmojiButton.className = 'bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-full font-semibold transition-colors flex items-center justify-center text-sm';
            privateEmojiButton.onclick = (e) => {
                e.stopPropagation();
                toggleEmojiPicker(true);
            };
            privateEmojiButton.title = 'ايموجيات متحركة';
            
            const privateImageButton = privateChatInput.querySelector('#privateImageButton');
            privateChatInput.insertBefore(privateEmojiButton, privateImageButton);
        }
    }
}
// تهيئة ميزات الصور عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // إعداد معالج اللصق
    setupPasteHandler();
    
    // تحديث الواجهة بإضافة أزرار الصور
    setTimeout(updateUIWithImageButtons, 1000);
    
    // تحديث الواجهة عند فتح المحادثة الخاصة
    const originalOpenPrivateChat = openPrivateChat;
    openPrivateChat = function(username) {
        originalOpenPrivateChat(username);
        setTimeout(updateUIWithImageButtons, 100);
    };
});

// تحديث الواجهة عند فتح غرفة المحادثة
const originalOpenChat = openChat;
openChat = function(roomId, roomName, icon) {
    originalOpenChat(roomId, roomName, icon);
    setTimeout(updateUIWithImageButtons, 100);
};


// دالة لتحميل صورة إذا كانت غير محملة
function loadImageIfNeeded(imageData, callback) {
    // إذا كانت الصورة موجودة كـ base64، استخدمها مباشرة
    if (imageData && imageData.startsWith('data:image')) {
        callback(imageData);
        return;
    }
    
    // إذا كانت الصورة مرجعاً (في حال استخدام تخزين منفصل للصور)
    // يمكنك إضافة منطق لتحميل الصورة من السيرفر هنا
    console.log('تحميل الصورة من السيرفر:', imageData);
    callback(imageData); // استخدم البيانات كما هي مؤقتاً
}

// دوال معالجة تحميل الصور
function handleImageLoad(img) {
    img.style.opacity = '0';
    setTimeout(() => {
        img.style.transition = 'opacity 0.3s ease';
        img.style.opacity = '1';
    }, 50);
}

function handleImageError(img) {
    console.error('فشل تحميل الصورة:', img.src);
    img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNjY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPua1i+ivleWksei0pTwvdGV4dD48L3N2Zz4=';
    img.alt = 'فشل تحميل الصورة';
}

// ضغط الصور قبل إرسالها (اختياري)
function compressImage(imageData, quality = 0.7, maxWidth = 800) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // حساب الأبعاد الجديدة
      let width = img.width;
      let height = img.height;
      
      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }
      
      canvas.width = width;
      canvas.height = height;
      
      // رسم الصورة مضغوطة
      ctx.drawImage(img, 0, 0, width, height);
      
      // الحصول على البيانات مضغوطة
      const compressedData = canvas.toDataURL('image/jpeg', quality);
      resolve(compressedData);
    };
    
    img.onerror = function() {
      resolve(imageData); // إرجاع البيانات الأصلية في حالة الخطأ
    };
    
    img.src = imageData;
  });
}
// تحسين فتح المحادثة الخاصة لضمان تحميل الصور
const originalOpenPrivateChat = openPrivateChat;
openPrivateChat = function(username) {
    originalOpenPrivateChat(username);
    
    // إعادة تحميل الصور بعد فتح المحادثة
    setTimeout(() => {
        const images = document.querySelectorAll('#privateChatMessages img.chat-image');
        images.forEach(img => {
            const originalSrc = img.getAttribute('data-src');
            if (originalSrc && img.src !== originalSrc) {
                loadImageIfNeeded(originalSrc, (finalImageData) => {
                    img.src = finalImageData;
                });
            }
        });
    }, 500);
};

// --- دوال غرفة التحكم (Control Panel) ---
function openControlPanel() {
    const modal = document.getElementById('controlPanelModal');
    modal.classList.add('show');
    
    // طلب الإحصائيات
    socket.emit('get control stats', { currentUser });
    socket.emit('get all users stats', { currentUser });
    
    // تحديث قائمة الغرف في لوحة التحكم
    updateRoomsListTable(); // تحديث جدول الغرف الجديد
    updateRanksTable(); // تحديث جدول الرتب
    initManagerPanel(); // تحديث لوحة إدارة المديرين

    // طلب أسئلة المسابقات
    socket.emit('get quiz questions', { currentUser });
}

function closeControlPanel() {
    document.getElementById('controlPanelModal').classList.remove('show');
}

function initManagerPanel() {
    const managerRoomSelect = document.getElementById('managerRoomSelect');
    managerRoomSelect.innerHTML = '<option value="">اختر غرفة...</option>';
    
    rooms.forEach(room => {
        const option = document.createElement('option');
        option.value = room.id;
        option.textContent = `${room.icon} ${room.name}`;
        managerRoomSelect.appendChild(option);
    });

    document.getElementById('managerUserInput').value = '';
    updateManagersList();
}

function updateManagersList() {
    const roomId = parseInt(document.getElementById('managerRoomSelect').value);
    const container = document.getElementById('roomManagersList');
    const noMsg = document.getElementById('noManagersMsg');
    
    container.innerHTML = '';
    let hasManagers = false;

    rooms.forEach(room => {
        if (room.managers && room.managers.length > 0) {
            hasManagers = true;
            const roomCard = document.createElement('div');
            roomCard.className = 'bg-gray-900/50 border border-gray-600 rounded-lg p-4';
            roomCard.innerHTML = `
                <div class="font-semibold text-white mb-2">${room.icon} ${room.name}</div>
                <div class="space-y-2">
                    ${room.managers.map(manager => `
                        <div class="flex items-center justify-between bg-gray-800/50 p-2 rounded text-sm">
                            <span class="text-yellow-300">${manager}</span>
                            <button onclick="removeRoomManager(${room.id}, '${manager}')" class="text-red-400 hover:text-red-300 text-xs px-2 py-1 hover:bg-red-500/10 rounded transition-colors">إزالة</button>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(roomCard);
        }
    });

    noMsg.style.display = hasManagers ? 'none' : 'block';
}

function assignRoomManager() {
    const roomId = parseInt(document.getElementById('managerRoomSelect').value);
    const username = document.getElementById('managerUserInput').value.trim();

    if (!roomId || !username) {
        showNotification('يرجى إدخال الغرفة واسم المستخدم', 'error');
        return;
    }

    socket.emit('set room manager', {
        roomId,
        managerUsername: username,
        currentUser
    });

    document.getElementById('managerUserInput').value = '';
}

function removeRoomManager(roomId, managerUsername) {
    if (confirm(`هل أنت متأكد من إزالة ${managerUsername} كمدير الغرفة؟`)) {
        socket.emit('remove room manager', {
            roomId,
            managerUsername,
            currentUser
        });
    }
}

function addNewRoom() {
    const name = document.getElementById('newRoomName').value.trim();
    const icon = document.getElementById('newRoomIcon').value.trim();
    const order = document.getElementById('newRoomOrder').value.trim();
    const description = document.getElementById('newRoomDesc').value.trim();
    
    if (!name || !icon) {
        showNotification('يرجى إدخال اسم الغرفة والأيقونة', 'error');
        return;
    }
    
    socket.emit('add room', { name, icon, order, description, currentUser });
    document.getElementById('newRoomName').value = '';
    document.getElementById('newRoomIcon').value = '';
    document.getElementById('newRoomOrder').value = '';
    document.getElementById('newRoomDesc').value = '';
}

function updateRoomOrder(roomId, newOrder) {
    socket.emit('update room order', { roomId, newOrder: parseInt(newOrder), currentUser });
}

function deleteRoom(roomId) {
    if (confirm('هل أنت متأكد من حذف هذه الغرفة؟')) {
        socket.emit('delete room', { roomId, currentUser });
    }
}

function updateRoomsListTable() {
    const tbody = document.getElementById('roomsListTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    // فرز الغرف قبل العرض
    const sortedRooms = [...rooms].sort((a, b) => (a.order - b.order) || (a.id - b.id));
    
    sortedRooms.forEach(room => {
        const row = document.createElement('tr');
        const usersCount = room.userCount !== undefined ? room.userCount : (room.users ? room.users.length : 0);
        const status = room.protected ? '🔒 محمية' : '🔓 عامة';
        
        row.innerHTML = `
            <td class="px-4 py-3">
                <input type="number" value="${room.order || 0}" 
                    onchange="updateRoomOrder(${room.id}, this.value)"
                    class="w-16 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-center text-xs focus:outline-none focus:ring-1 focus:ring-blue-500">
            </td>
            <td class="px-4 py-3">${room.icon}</td>
            <td class="px-4 py-3 font-semibold text-white">${room.name}</td>
            <td class="px-4 py-3 text-xs text-slate-300">${room.description || '-'}</td>
            <td class="px-4 py-3 text-center">${usersCount}</td>
            <td class="px-4 py-3 text-center text-xs">${status}</td>
            <td class="px-4 py-3 text-center">
                <div class="flex items-center justify-center gap-2">
                    ${!room.protected ? `
                        <button onclick="deleteRoom(${room.id})" class="text-red-400 hover:text-red-600 px-2 py-1 rounded hover:bg-red-500/20 transition-colors text-sm" title="حذف الغرفة">
                            🗑️
                        </button>
                    ` : '<span class="text-gray-500 text-xs">ثابتة</span>'}
                    <button onclick="clearRoomHistory(${room.id})" class="text-yellow-400 hover:text-yellow-600 px-2 py-1 rounded hover:bg-yellow-500/20 transition-colors text-sm" title="مسح سجل المحادثة">
                        🧹
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// دوال الإعلان الهام
function toggleCustomTitle() {
    const type = document.getElementById('announcementType').value;
    const customInput = document.getElementById('announcementCustomTitle');
    if (type === 'custom') {
        customInput.classList.remove('hidden');
    } else {
        customInput.classList.add('hidden');
    }
}

function setAnnouncement() {
    const type = document.getElementById('announcementType').value;
    const customTitle = document.getElementById('announcementCustomTitle').value.trim();
    const message = document.getElementById('announcementInput').value.trim();
    
    let title = type;
    if (type === 'custom') {
        title = customTitle || 'إعلان';
    }

    if (!message) {
        alert('يرجى كتابة محتوى الإعلان');
        return;
    }
    
    socket.emit('set announcement', { title, message, currentUser });
}

function updateRanksTable() {
    const tbody = document.getElementById('ranksTableBody');
    tbody.innerHTML = '';

    // تحويل كائن الرتب إلى مصفوفة وترتيبها حسب المستوى تنازلياً
    const sortedRanks = Object.entries(ranks).map(([name, data]) => ({
        name,
        ...data
    })).sort((a, b) => b.level - a.level);

    sortedRanks.forEach(rank => {
        const isOwner = rank.name === 'صاحب الموقع';
        const iconHtml = getRankIconHtml(rank.icon);
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-700/30 transition-colors';
        tr.innerHTML = `
            <td class="px-4 py-3 font-medium text-white flex items-center gap-2">
                ${iconHtml}
                ${rank.name}
                ${isOwner ? '<span class="text-xs bg-yellow-500/20 text-yellow-400 px-2 py-0.5 rounded">ثابتة</span>' : ''}
            </td>
            <td class="px-4 py-3 font-bold text-blue-300">${rank.level}</td>
            <td class="px-4 py-3">
                <div class="w-6 h-6 rounded bg-gradient-to-r ${rank.color}"></div>
            </td>
            <td class="px-4 py-3">
                ${!isOwner ? `
                <div class="flex gap-2">
                    <button onclick="editRank('${rank.name}')" class="text-blue-400 hover:text-blue-300 p-1 hover:bg-blue-500/10 rounded" title="تعديل">✏️</button>
                    <button onclick="deleteRankDefinition('${rank.name}')" class="text-red-400 hover:text-red-300 p-1 hover:bg-red-500/10 rounded" title="حذف">🗑️</button>
                </div>
                ` : '<span class="text-slate-600 text-xs">لا يمكن التعديل</span>'}
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function saveRankDefinition() {
    const name = document.getElementById('customRankName').value.trim();
    const iconText = document.getElementById('customRankIcon').value.trim();
    const icon = tempRankIcon || iconText;
    const level = document.getElementById('customRankLevel').value;
    const color = document.getElementById('customRankColor').value;
    const originalName = document.getElementById('editingRankName').value;
    const targetUsername = document.getElementById('customRankTarget').value.trim();

    if (!name || !icon || !level) {
        showNotification('يرجى ملء حقول الرتبة (الاسم، الأيقونة، المستوى)', 'error');
        return;
    }

    socket.emit('save rank', {
        originalName,
        name,
        icon,
        level,
        color,
        targetUsername,
        currentUser
    });
    resetRankForm();
}

function editRank(rankName) {
    const rank = ranks[rankName];
    if (!rank) return;

    document.getElementById('customRankName').value = rankName;
    
    if (rank.icon.startsWith('data:image') || rank.icon.startsWith('http')) {
        tempRankIcon = rank.icon;
        document.getElementById('rankIconPreview').src = tempRankIcon;
        document.getElementById('rankIconPreviewContainer').classList.remove('hidden');
        document.getElementById('customRankIcon').disabled = true;
        document.getElementById('customRankIcon').value = '';
    } else {
        clearRankIconImage();
        document.getElementById('customRankIcon').value = rank.icon;
    }

    document.getElementById('customRankLevel').value = rank.level;
    document.getElementById('customRankColor').value = rank.color;
    document.getElementById('editingRankName').value = rankName;
    document.getElementById('rankFormTitle').textContent = `تعديل الرتبة: ${rankName}`;
    document.getElementById('saveRankBtn').textContent = 'حفظ وتعيين';
    document.getElementById('cancelRankEditBtn').classList.remove('hidden');
}

function deleteRankDefinition(rankName) {
    if (confirm(`هل أنت متأكد من حذف الرتبة "${rankName}"؟ سيتم إزالتها من جميع المستخدمين.`)) {
        socket.emit('delete rank definition', { rankName, currentUser });
    }
}

function clearRoomHistory(roomId) {
    if (confirm('هل أنت متأكد من مسح جميع الرسائل والصور في هذه الغرفة؟ لا يمكن التراجع عن هذا الإجراء.')) {
        socket.emit('clear room history', { roomId, currentUser });
    }
}

function resetRankForm() {
    document.getElementById('customRankName').value = '';
    clearRankIconImage();
    document.getElementById('customRankLevel').value = '';
    document.getElementById('customRankTarget').value = '';
    document.getElementById('editingRankName').value = '';
    document.getElementById('rankFormTitle').textContent = 'إضافة رتبة جديدة';
    document.getElementById('saveRankBtn').textContent = 'حفظ وتعيين';
    document.getElementById('cancelRankEditBtn').classList.add('hidden');
}

function removeAnnouncement() {
    if (confirm('هل أنت متأكد من إزالة الإعلان؟')) {
        socket.emit('set announcement', { title: '', message: '', currentUser });
        document.getElementById('announcementInput').value = '';
    }
}

// متغير عالمي لتتبع معرف الإعلان الحالي
let currentAnnouncementId = null;

function getAnnouncementHash(title, message) {
    const str = (title || '') + (message || '');
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    return 'announcement_seen_' + Math.abs(hash);
}

function closeAnnouncementModal() {
    const modal = document.getElementById('announcementModal');
    
    // حفظ أن المستخدم رأى هذا الإعلان في localStorage
    if (currentAnnouncementId) {
        localStorage.setItem(currentAnnouncementId, 'true');
    }

    modal.classList.add('opacity-0');
    modal.firstElementChild.classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

function updateAnnouncementUI(data) {
    const modal = document.getElementById('announcementModal');
    const titleEl = document.getElementById('announcementModalTitle');
    const textEl = document.getElementById('announcementModalText');
    
    const title = (typeof data === 'object') ? data.title : 'إعلان هام';
    const message = (typeof data === 'object') ? data.message : data;

    if (message && message.trim() !== '') {
        const announcementHash = getAnnouncementHash(title, message);
        currentAnnouncementId = announcementHash;

        // التحقق مما إذا كان المستخدم قد رأى هذا الإعلان بالفعل
        const hasSeen = localStorage.getItem(announcementHash);

        if (!hasSeen) {
            titleEl.textContent = title || 'إعلان';
            textEl.textContent = message;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.firstElementChild.classList.remove('scale-95');
            }, 10);
        }
    } else {
        // إذا تم إزالة الإعلان من السيرفر، نخفي المودال ونصفر المعرف
        currentAnnouncementId = null;
        modal.classList.add('opacity-0');
        modal.firstElementChild.classList.add('scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
}

socket.on('announcement update', (data) => {
    window.latestAnnouncementData = data; // تخزين البيانات لاستخدامها عند الدخول
    if (!currentUser) return; // لا تظهر الإعلان إذا لم يكن المستخدم مسجلاً للدخول
    updateAnnouncementUI(data);
});

// دوال نظام الدعوة والتفاعل
function copyReferralLink() {
    const input = document.getElementById('referralLinkInput');
    if (!input) return;
    
    input.select();
    input.setSelectionRange(0, 99999); // للهواتف
    
    try {
        navigator.clipboard.writeText(input.value).then(() => {
            showNotification('تم نسخ رابط الدعوة بنجاح!', 'success');
        });
    } catch (err) {
        // بديل في حالة عدم دعم navigator.clipboard
        document.execCommand('copy');
        showNotification('تم نسخ رابط الدعوة بنجاح!', 'success');
    }
}

socket.on('interaction update', (data) => {
    // تحديث درجة التفاعل في البروفايل إذا كان مفتوحاً للمستخدم الحالي
    const interactionScoreElem = document.getElementById('interactionScore');
    const profileUsernameElem = document.getElementById('profileUsername');
    
    if (interactionScoreElem && profileUsernameElem && profileUsernameElem.textContent === currentUser.name) {
        interactionScoreElem.textContent = data.score;
        
        // تأثير بصري بسيط عند الزيادة
        interactionScoreElem.classList.add('scale-125', 'bg-green-500');
        interactionScoreElem.classList.remove('bg-orange-500');
        
        setTimeout(() => {
            interactionScoreElem.classList.remove('scale-125', 'bg-green-500');
            interactionScoreElem.classList.add('bg-orange-500');
        }, 1000);
    }
    
    showNotification(`🔥 مبروك! زادت درجة تفاعلك، لديك الآن ${data.score} دعوة ناجحة`, 'success');
});

// استقبال بيانات الإحصائيات
socket.on('control stats data', (stats) => {
    document.getElementById('statsTotalUsers').textContent = stats.totalUsers;
    document.getElementById('statsOnline').textContent = stats.onlineCount;
    document.getElementById('statsMales').textContent = stats.males;
    document.getElementById('statsFemales').textContent = stats.females;
});

// استقبال بيانات قائمة المستخدمين الشاملة
socket.on('all users stats data', (usersList) => {
    window.allControlUsers = usersList; // تخزين القائمة للبحث
    renderControlUsers(usersList);
});

function renderControlUsers(list) {
    const tbody = document.getElementById('controlUsersTableBody');
    tbody.innerHTML = '';
    
    if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-slate-500">لا توجد نتائج</td></tr>';
        return;
    }

    list.forEach(user => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-700/50 transition-colors group';
        
        // Username Column with Edit
        const usernameHtml = `
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full ${user.isOnline ? 'bg-green-500' : 'bg-gray-500'}" title="${user.isOnline ? 'متصل' : 'غير متصل'}"></div>
                <div class="flex items-center gap-1 flex-1">
                    <input type="text" value="${user.username}" id="username-input-${user.username}" class="bg-transparent border border-transparent hover:border-gray-600 focus:border-blue-500 rounded px-1 py-0.5 text-white w-full text-sm focus:outline-none transition-colors" onkeydown="if(event.key === 'Enter') adminRenameUser('${user.username}')">
                    <button onclick="adminRenameUser('${user.username}')" class="text-blue-400 hover:text-blue-300 opacity-0 group-hover:opacity-100 transition-opacity" title="حفظ الاسم">💾</button>
                </div>
            </div>
        `;

        // Points Column with Edit
        const pointsHtml = `
            <div class="flex items-center gap-1">
                <input type="number" value="${user.points}" id="points-input-${user.username}" class="bg-transparent border border-transparent hover:border-gray-600 focus:border-yellow-500 rounded px-1 py-0.5 text-yellow-400 font-bold w-20 text-sm focus:outline-none transition-colors" ${user.isInfinite ? 'disabled' : ''}>
                <button onclick="adminUpdatePoints('${user.username}')" class="text-yellow-400 hover:text-yellow-300 opacity-0 group-hover:opacity-100 transition-opacity" title="حفظ النقاط" ${user.isInfinite ? 'hidden' : ''}>💾</button>
            </div>
        `;

        // Level Column with Edit
        const levelHtml = `
            <div class="flex items-center gap-1">
                <input type="number" value="${user.level}" id="level-input-${user.username}" class="bg-transparent border border-transparent hover:border-gray-600 focus:border-blue-500 rounded px-1 py-0.5 text-blue-300 font-bold w-16 text-sm focus:outline-none transition-colors">
                <button onclick="adminUpdateLevel('${user.username}')" class="text-blue-400 hover:text-blue-300 opacity-0 group-hover:opacity-100 transition-opacity" title="حفظ المستوى">💾</button>
            </div>
        `;

        // Infinite Toggle
        const infiniteHtml = `
            <button onclick="adminToggleInfinite('${user.username}', ${!user.isInfinite})" class="relative inline-flex items-center cursor-pointer">
                <div class="w-9 h-5 bg-gray-600 rounded-full peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 ${user.isInfinite ? 'bg-purple-600' : ''}">
                    <div class="absolute top-[2px] left-[2px] bg-white border-gray-300 border rounded-full h-4 w-4 transition-all ${user.isInfinite ? 'translate-x-full border-white' : ''}"></div>
                </div>
            </button>
        `;

        // Show in Top Toggle
        const showInTopHtml = `
            <button onclick="adminToggleShowInTop('${user.username}', ${!user.showInTop})" class="relative inline-flex items-center cursor-pointer" title="${user.showInTop ? 'إخفاء من المتفاعلين' : 'إظهار في المتفاعلين'}">
                <div class="w-9 h-5 bg-gray-600 rounded-full peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 ${user.showInTop ? 'bg-green-600' : ''}">
                    <div class="absolute top-[2px] left-[2px] bg-white border-gray-300 border rounded-full h-4 w-4 transition-all ${user.showInTop ? 'translate-x-full border-white' : ''}"></div>
                </div>
            </button>
        `;

        // Actions
        const actionsHtml = `
            <button onclick="adminDeleteUser('${user.username}')" class="bg-red-500/10 hover:bg-red-500/20 text-red-400 hover:text-red-300 p-1.5 rounded-lg transition-colors" title="حذف المستخدم">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
        `;

        tr.innerHTML = `
            <td class="px-4 py-3">${usernameHtml}</td>
            <td class="px-4 py-3"><span class="bg-gray-700 px-2 py-1 rounded text-xs">${user.rank}</span></td>
            <td class="px-4 py-3">${pointsHtml}</td>
            <td class="px-4 py-3">${levelHtml}</td>
            <td class="px-4 py-3 text-center">${infiniteHtml}</td>
            <td class="px-4 py-3 text-center">${showInTopHtml}</td>
            <td class="px-4 py-3 text-center">${actionsHtml}</td>
        `;
        tbody.appendChild(tr);
    });
}

function adminRenameUser(oldUsername) {
    const input = document.getElementById(`username-input-${oldUsername}`);
    const newUsername = input.value.trim();
    
    if (newUsername === oldUsername) return;
    
    if (confirm(`هل أنت متأكد من تغيير اسم المستخدم من "${oldUsername}" إلى "${newUsername}"؟`)) {
        socket.emit('admin change username', { oldUsername, newUsername, currentUser });
    } else {
        input.value = oldUsername; // Reset
    }
}

function adminUpdatePoints(username) {
    const input = document.getElementById(`points-input-${username}`);
    const newPoints = input.value;
    
    socket.emit('admin update points', { targetUsername: username, newPoints, currentUser });
    setTimeout(() => socket.emit('get all users stats', { currentUser }), 200);
}

function adminUpdateLevel(username) {
    const input = document.getElementById(`level-input-${username}`);
    const newLevel = input.value;
    
    socket.emit('admin update level', { targetUsername: username, newLevel, currentUser });
    setTimeout(() => socket.emit('get all users stats', { currentUser }), 200);
}

function adminToggleInfinite(username, newState) {
    socket.emit('admin toggle infinite', { targetUsername: username, isInfinite: newState, currentUser });
    setTimeout(() => socket.emit('get all users stats', { currentUser }), 200);
}

function adminToggleShowInTop(username, newState) {
    socket.emit('admin toggle show in top', { targetUsername: username, showInTop: newState, currentUser });
    setTimeout(() => socket.emit('get all users stats', { currentUser }), 200);
}

function adminDeleteUser(username) {
    if (confirm(`⚠️ تحذير: هل أنت متأكد تماماً من حذف المستخدم "${username}"؟ سيتم حذف جميع بياناته نهائياً.`)) {
        socket.emit('delete user', { username, currentUser });
        // تحديث القائمة فوراً
        setTimeout(() => socket.emit('get all users stats', { currentUser }), 500);
    }
}

function filterControlUsers() {
    const query = document.getElementById('controlUserSearch').value.toLowerCase();
    if (!window.allControlUsers) return;
    
    const filtered = window.allControlUsers.filter(u => u.username.toLowerCase().includes(query));
    renderControlUsers(filtered);
}

// تحديث قائمة الغرف في لوحة التحكم عند حدوث تغيير
socket.on('rooms update', (updatedRooms) => {
    rooms = updatedRooms;
    
    // تحديث إعدادات الغرف والخلفيات من بيانات الغرف
    updatedRooms.forEach(room => {
        if (room.settings) {
            roomsWithSettings[room.id] = room.settings;
        }
        if (room.background) {
            roomsWithBackgrounds[room.id] = room.background;
        }
    });
    
    // تحديث الإعدادات الحالية إذا كنا في غرفة
    if (currentRoom) {
        const newSettings = roomsWithSettings[currentRoom.id];
        if (newSettings) {
            currentRoomSettings = newSettings;
            // إعادة تطبيق ألوان الرسائل القديمة (استثناء رسائل النظام والرسائل الخاصة بالمستخدم)
            const bubbles = document.querySelectorAll('.message-bubble');
            bubbles.forEach(bubble => {
                const messageContainer = bubble.closest('.chat-message');
                // لا نغير ألوان رسائل النظام أو رسائل المستخدم نفسه
                if (messageContainer && !messageContainer.classList.contains('system-message') && !bubble.classList.contains('own-message')) {
                    const oldClasses = Array.from(bubble.classList)
                        .filter(cls => cls.startsWith('bg-') || cls.startsWith('text-'));
                    oldClasses.forEach(cls => bubble.classList.remove(cls));
                    
                    // تطبيق التنسيق الجديد للغرفة
                    const settingClasses = newSettings.messageBackground.split(' ');
                    settingClasses.forEach(cls => {
                        if (cls.trim()) bubble.classList.add(cls);
                    });
                    
                    if (newSettings.textColor) {
                        bubble.classList.add(newSettings.textColor);
                    }
                }
            });
        }
        
        const newBackground = roomsWithBackgrounds[currentRoom.id];
        if (newBackground) {
            currentRoomBackground = newBackground;
            applyBackground(newBackground, true);
        }
    }
    
    loadRooms(); // تحديث القائمة الرئيسية
    
    // إذا كانت لوحة التحكم مفتوحة، قم بتحديث قائمتها أيضاً
    if (document.getElementById('controlPanelModal').classList.contains('show')) {
        updateRoomsListTable(); // تحديث جدول الغرف
    }
});

socket.on('ranks update', (updatedRanks) => {
    ranks = updatedRanks;
    updateWingsConfig();
    if (document.getElementById('controlPanelModal').classList.contains('show')) {
        updateRanksTable();
    }
    // تحديث رسالة الترحيب إذا كانت معروضة لضمان ظهور أيقونة الرتبة
    if (currentUser) {
        updateWelcomeMessage();
    }
});

// استقبال خطأ الانضمام للغرفة (مثل وجود اسم مكرر)
socket.on('join error', (error) => {
    showNotification(error, 'error');
    hideLoading();
    goBack(); // إعادة المستخدم للصفحة الرئيسية
});

        // --- منطق لوحة الرسم المشتركة ---
        const canvas = document.getElementById('sharedCanvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;
        let currentX = 0;
        let currentY = 0;

        function openDrawingBoard() {
            document.getElementById('drawingModal').classList.add('show');
            socket.emit('get board state');
            showDot('drawing', false);
        };
        function closeDrawingBoard() {
            document.getElementById('drawingModal').classList.remove('show');
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            let clientX = e.clientX;
            let clientY = e.clientY;
            
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            }

            return [
                (clientX - rect.left) * scaleX,
                (clientY - rect.top) * scaleY
            ];
        }

        function drawLine(x0, y0, x1, y1, color, width, emit) {
            ctx.beginPath();
            ctx.moveTo(x0, y0);
            ctx.lineTo(x1, y1);
            ctx.strokeStyle = color;
            ctx.lineWidth = width;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            ctx.closePath();

            if (emit) {
                socket.emit('draw', { x0, y0, x1, y1, color, width });
            }
        }

        // Mouse events
        canvas.addEventListener('mousedown', (e) => {
            drawing = true;
            [currentX, currentY] = getPos(e);
        });
        canvas.addEventListener('mouseup', () => drawing = false);
        canvas.addEventListener('mouseout', () => drawing = false);
        canvas.addEventListener('mousemove', (e) => {
            if (!drawing) return;
            const [newX, newY] = getPos(e);
            const color = document.getElementById('drawingColor').value;
            const width = document.getElementById('drawingWidth').value;
            drawLine(currentX, currentY, newX, newY, color, width, true);
            [currentX, currentY] = [newX, newY];
        });

        // Touch events
        canvas.addEventListener('touchstart', (e) => {
            drawing = true;
            [currentX, currentY] = getPos(e);
            e.preventDefault();
        }, { passive: false });
        canvas.addEventListener('touchend', () => drawing = false);
        canvas.addEventListener('touchmove', (e) => {
            if (!drawing) return;
            const [newX, newY] = getPos(e);
            const color = document.getElementById('drawingColor').value;
            const width = document.getElementById('drawingWidth').value;
            drawLine(currentX, currentY, newX, newY, color, width, true);
            [currentX, currentY] = [newX, newY];
            e.preventDefault();
        }, { passive: false });

        function clearDrawingBoard() {
            if(confirm('هل أنت متأكد من مسح اللوحة بالكامل؟')) {
                socket.emit('clear board');
            }
        }

        // تتبع الرسامين النشطين
        const activeDrawers = new Map();

        function updateDrawingHeader() {
            const header = document.getElementById('drawingStatusHeader');
            if (!header) return;

            const drawers = Array.from(activeDrawers.keys());
            
            if (drawers.length === 0) {
                header.textContent = '';
                header.classList.add('hidden');
            } else if (drawers.length === 1) {
                header.textContent = `${drawers[0]} يرسم الان..`;
                header.classList.remove('hidden');
            } else {
                // إذا كان أكثر من واحد، نعرض الأسماء مع جملة الجمع
                header.textContent = `${drawers.join('، ')} يرسمون الان..`;
                header.classList.remove('hidden');
            }
        }

        // Socket listeners for drawing
        socket.on('draw', (data) => {
            drawLine(data.x0, data.y0, data.x1, data.y1, data.color, data.width, false);
            
            if (data.username) {
                if (activeDrawers.has(data.username)) clearTimeout(activeDrawers.get(data.username));
                const timeoutId = setTimeout(() => { activeDrawers.delete(data.username); updateDrawingHeader(); }, 1000);
                activeDrawers.set(data.username, timeoutId);
                updateDrawingHeader();
            }
        });

        socket.on('new drawing activity', () => {
            if (!document.getElementById('drawingModal').classList.contains('show')) {
                showDot('drawing', true);
            }
        });

        socket.on('board state', (history) => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // تعيين خلفية بيضاء افتراضية
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            history.forEach(data => {
                drawLine(data.x0, data.y0, data.x1, data.y1, data.color, data.width, false);
            });
        });

        socket.on('clear board', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        });

        function openRoomInfo() {
            if (!currentRoom) {
                showNotification('يجب أن تكون في غرفة', 'error');
                return;
            }
            socket.emit('get room info', currentRoom.id);
        }

        function closeRoomInfo() {
            document.getElementById('roomInfoModal').classList.remove('show');
        }

        socket.on('room info', (roomInfo) => {
            const modal = document.getElementById('roomInfoModal');
            const title = document.getElementById('roomInfoTitle');
            const desc = document.getElementById('roomInfoDesc');
            const content = document.getElementById('roomInfoContent');

            title.textContent = `${roomInfo.icon} ${roomInfo.name}`;
            desc.textContent = roomInfo.description || 'لا توجد وصف للغرفة';

            let html = `
                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                    <h3 class="text-white font-semibold mb-3">👮 مديرو الغرفة</h3>
                    <div class="text-sm">
                        ${roomInfo.managers.length > 0 
                            ? `<p class="text-yellow-400">${roomInfo.managers.join(', ')}</p>`
                            : '<p class="text-slate-400">لا يوجد مديرون</p>'
                        }
                    </div>
                </div>

                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                    <h3 class="text-white font-semibold mb-3">📝 الوصف</h3>
                    <p class="text-slate-300 text-sm">${roomInfo.description || roomInfo.description || 'لا يوجد وصف'}</p>
                </div>
            `;

            const isManager = currentUser && (currentUser.isSiteOwner || roomInfo.managers.includes(currentUser.name));
            if (isManager) {
                html += `
                    <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                        <h3 class="text-white font-semibold mb-4">⚙️ إعدادات الغرفة</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm text-slate-300 mb-2 block">وصف الغرفة</label>
                                <input type="text" id="roomDescInput" value="${roomInfo.description || ''}" placeholder="أدخل وصف الغرفة" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                            </div>

                            <div>
                                <label class="text-sm text-slate-300 mb-2 block">لون النص</label>
                                <select id="roomTextColorSelect" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <optgroup label="أساسي" class="bg-gray-800">
                                        <option value="text-white" ${roomInfo.settings?.textColor === 'text-white' ? 'selected' : ''}>أبيض افتراضي</option>
                                        <option value="text-gray-200" ${roomInfo.settings?.textColor === 'text-gray-200' ? 'selected' : ''}>رمادي فاتح</option>
                                    </optgroup>
                                    <optgroup label="ألوان حيوية" class="bg-gray-800">
                                        <option value="text-blue-300" ${roomInfo.settings?.textColor === 'text-blue-300' ? 'selected' : ''}>أزرق سماوي</option>
                                        <option value="text-cyan-300" ${roomInfo.settings?.textColor === 'text-cyan-300' ? 'selected' : ''}>فيروزي (سيان)</option>
                                        <option value="text-emerald-300" ${roomInfo.settings?.textColor === 'text-emerald-300' ? 'selected' : ''}>زمردي</option>
                                        <option value="text-green-300" ${roomInfo.settings?.textColor === 'text-green-300' ? 'selected' : ''}>أخضر فاتح</option>
                                        <option value="text-yellow-200" ${roomInfo.settings?.textColor === 'text-yellow-200' ? 'selected' : ''}>أصفر ذهبي</option>
                                        <option value="text-orange-300" ${roomInfo.settings?.textColor === 'text-orange-300' ? 'selected' : ''}>برتقالي</option>
                                        <option value="text-red-300" ${roomInfo.settings?.textColor === 'text-red-300' ? 'selected' : ''}>أحمر ناعم</option>
                                        <option value="text-pink-300" ${roomInfo.settings?.textColor === 'text-pink-300' ? 'selected' : ''}>وردي</option>
                                        <option value="text-purple-300" ${roomInfo.settings?.textColor === 'text-purple-300' ? 'selected' : ''}>بنفسجي</option>
                                        <option value="text-indigo-300" ${roomInfo.settings?.textColor === 'text-indigo-300' ? 'selected' : ''}>إنديجو</option>
                                    </optgroup>
                                </select>
                            </div>

                            <div>
                                <label class="text-sm text-slate-300 mb-2 block">خلفية الرسائل</label>
                                <select id="roomMessageBgSelect" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <optgroup label="شفافية ومؤثرات" class="bg-gray-800">
                                        <option value="bg-gray-800" ${roomInfo.settings?.messageBackground === 'bg-gray-800' ? 'selected' : ''}>رمادي داكن (افتراضي)</option>
                                        <option value="bg-slate-900/80" ${roomInfo.settings?.messageBackground === 'bg-slate-900/80' ? 'selected' : ''}>سليت زجاجي</option>
                                        <option value="bg-black/50" ${roomInfo.settings?.messageBackground === 'bg-black/50' ? 'selected' : ''}>أسود شفاف</option>
                                        <option value="bg-white/10" ${roomInfo.settings?.messageBackground === 'bg-white/10' ? 'selected' : ''}>أبيض زجاجي</option>
                                    </optgroup>
                                    <optgroup label="ألوان صلبة" class="bg-gray-800">
                                        <option value="bg-blue-600" ${roomInfo.settings?.messageBackground === 'bg-blue-600' ? 'selected' : ''}>أزرق احترافي</option>
                                        <option value="bg-indigo-700" ${roomInfo.settings?.messageBackground === 'bg-indigo-700' ? 'selected' : ''}>إنديجو عميق</option>
                                        <option value="bg-purple-800" ${roomInfo.settings?.messageBackground === 'bg-purple-800' ? 'selected' : ''}>بنفسجي ملكي</option>
                                        <option value="bg-emerald-700" ${roomInfo.settings?.messageBackground === 'bg-emerald-700' ? 'selected' : ''}>أخضر زمردي</option>
                                        <option value="bg-rose-700" ${roomInfo.settings?.messageBackground === 'bg-rose-700' ? 'selected' : ''}>وردي غامق</option>
                                        <option value="bg-amber-700" ${roomInfo.settings?.messageBackground === 'bg-amber-700' ? 'selected' : ''}>عنبري (أمبر)</option>
                                    </optgroup>
                                </select>
                            </div>

                            <div>
                                <label class="text-sm text-slate-300 mb-2 block">خلفية الغرفة</label>
                                <select id="roomBgTypeSelect" onchange="updateBackgroundTypeOptions()" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="gradient" ${roomInfo.background?.type === 'gradient' ? 'selected' : ''}>تدرج</option>
                                    <option value="color" ${roomInfo.background?.type === 'color' ? 'selected' : ''}>لون</option>
                                    <option value="image" ${roomInfo.background?.type === 'image' ? 'selected' : ''}>صورة مخصصة</option>
                                </select>
                            </div>

                            <div id="backgroundOptionsContainer">
                                ${roomInfo.background?.type === 'gradient' ? `
                                    <div>
                                        <label class="text-sm text-slate-300 mb-2 block">التدرج اللوني</label>
                                        <select id="roomBgValueSelect" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                            <option value="from-purple-900 via-blue-900 to-indigo-900" ${roomInfo.background?.value === 'from-purple-900 via-blue-900 to-indigo-900' ? 'selected' : ''}>بنفسجي-أزرق</option>
                                            <option value="from-green-900 via-blue-900 to-purple-900" ${roomInfo.background?.value === 'from-green-900 via-blue-900 to-purple-900' ? 'selected' : ''}>أخضر-أزرق</option>
                                            <option value="from-pink-900 via-red-900 to-orange-900" ${roomInfo.background?.value === 'from-pink-900 via-red-900 to-orange-900' ? 'selected' : ''}>وردي-برتقالي</option>
                                            <option value="from-gray-800 to-gray-900" ${roomInfo.background?.value === 'from-gray-800 to-gray-900' ? 'selected' : ''}>رمادي</option>
                                        </select>
                                    </div>
                                ` : roomInfo.background?.type === 'color' ? `
                                    <div>
                                        <label class="text-sm text-slate-300 mb-2 block">اللون</label>
                                        <input type="color" id="roomBgColorInput" value="${roomInfo.background?.value || '#1f2937'}" class="w-full h-10 rounded-lg cursor-pointer">
                                    </div>
                                ` : roomInfo.background?.type === 'image' ? `
                                    <div>
                                        <label class="text-sm text-slate-300 mb-2 block">الصورة المخصصة</label>
                                        <input type="file" id="roomBgImageInput" accept="image/*" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <div id="imageUploadProgress" class="text-sm text-slate-300 mt-2"></div>
                                    </div>
                                ` : ''}
                            </div>

                            <button onclick="saveRoomSettings('${currentRoom.id}')" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors mt-4">
                                💾 حفظ الإعدادات
                            </button>
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html;
            modal.classList.add('show');
        });

        function updateBackgroundTypeOptions() {
            const bgType = document.getElementById('roomBgTypeSelect')?.value || 'gradient';
            const container = document.getElementById('backgroundOptionsContainer');
            
            let html = '';
            if (bgType === 'gradient') {
                html = `
                    <div>
                        <label class="text-sm text-slate-300 mb-2 block">التدرج اللوني</label>
                        <select id="roomBgValueSelect" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="from-purple-900 via-blue-900 to-indigo-900">بنفسجي-أزرق</option>
                            <option value="from-green-900 via-blue-900 to-purple-900">أخضر-أزرق</option>
                            <option value="from-pink-900 via-red-900 to-orange-900">وردي-برتقالي</option>
                            <option value="from-gray-800 to-gray-900">رمادي</option>
                        </select>
                    </div>
                `;
            } else if (bgType === 'color') {
                html = `
                    <div>
                        <label class="text-sm text-slate-300 mb-2 block">اللون</label>
                        <input type="color" id="roomBgColorInput" value="#1f2937" class="w-full h-10 rounded-lg cursor-pointer">
                    </div>
                `;
            } else if (bgType === 'image') {
                html = `
                    <div>
                        <label class="text-sm text-slate-300 mb-2 block">الصورة المخصصة</label>
                        <input type="file" id="roomBgImageInput" accept="image/*" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <div id="imageUploadProgress" class="text-sm text-slate-300 mt-2"></div>
                    </div>
                `;
            }
            
            if (container) {
                container.innerHTML = html;
            }
        }

        function uploadRoomBackground(roomId, file) {
            const formData = new FormData();
            formData.append('image', file);

            const progressDiv = document.getElementById('imageUploadProgress');
            if (progressDiv) {
                progressDiv.textContent = 'جاري رفع الصورة...';
            }

            fetch('/api/upload-room-background', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (progressDiv) {
                        progressDiv.textContent = 'تم رفع الصورة بنجاح';
                    }
                    socket.emit('update room background', {
                        roomId,
                        backgroundType: 'image',
                        backgroundValue: data.fileUrl,
                        currentUser
                    });
                    setTimeout(() => {
                        if (progressDiv) {
                            progressDiv.textContent = '';
                        }
                    }, 2000);
                } else {
                    if (progressDiv) {
                        progressDiv.textContent = 'فشل رفع الصورة';
                    }
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                if (progressDiv) {
                    progressDiv.textContent = 'حدث خطأ في رفع الصورة';
                }
            });
        }

        function saveRoomSettings(roomId) {
            const description = document.getElementById('roomDescInput')?.value || '';
            const textColor = document.getElementById('roomTextColorSelect')?.value || 'text-white';
            const messageBackground = document.getElementById('roomMessageBgSelect')?.value || 'bg-gray-800';
            const backgroundType = document.getElementById('roomBgTypeSelect')?.value || 'gradient';

            socket.emit('update room settings', {
                roomId,
                description,
                textColor,
                messageBackground,
                currentUser
            });

            // التعامل مع خلفية الغرفة
            if (backgroundType === 'image') {
                const imageInput = document.getElementById('roomBgImageInput');
                if (imageInput && imageInput.files.length > 0) {
                    uploadRoomBackground(roomId, imageInput.files[0]);
                }
            } else if (backgroundType === 'gradient') {
                const backgroundValue = document.getElementById('roomBgValueSelect')?.value || 'from-gray-800 to-gray-900';
                socket.emit('update room background', {
                    roomId,
                    backgroundType: 'gradient',
                    backgroundValue,
                    currentUser
                });
            } else if (backgroundType === 'color') {
                const backgroundValue = document.getElementById('roomBgColorInput')?.value || '#1f2937';
                socket.emit('update room background', {
                    roomId,
                    backgroundType: 'color',
                    backgroundValue,
                    currentUser
                });
            }
        }

        socket.on('message deleted', (data) => {
            const messageEl = document.querySelector(`[data-message-id="${data.messageId}"]`);
            if (messageEl) {
                messageEl.remove();
            }
        });

        // --- دوال إدارة المسابقات (QuizBot) ---
        function renderQuizQuestions(questions) {
            const tbody = document.getElementById('quizQuestionsTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            
            questions.forEach(q => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-3 text-blue-400 font-semibold">${q.category || 'عام'}</td>
                    <td class="px-4 py-3 text-white">${q.question}</td>
                    <td class="px-4 py-3 text-yellow-300 font-bold">${q.answer}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteQuizQuestion(${q.id})" class="text-red-400 hover:text-red-600 px-2 py-1 rounded hover:bg-red-500/20 transition-colors text-sm">
                            🗑️ حذف
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function addQuizQuestion() {
            const category = document.getElementById('newQuizCategory').value.trim();
            const question = document.getElementById('newQuizQuestion').value.trim();
            const answer = document.getElementById('newQuizAnswer').value.trim();
            
            if (!category || !question || !answer) {
                showNotification('يرجى إدخال الفئة، السؤال، والإجابة', 'error');
                return;
            }
            
            socket.emit('add quiz question', { category, question, answer, currentUser });
            document.getElementById('newQuizCategory').value = '';
            document.getElementById('newQuizQuestion').value = '';
            document.getElementById('newQuizAnswer').value = '';
        }

        function deleteQuizQuestion(id) {
            if (confirm('هل أنت متأكد من حذف هذا السؤال؟')) {
                socket.emit('delete quiz question', { id, currentUser });
            }
        }

        socket.on('quiz questions list', (questions) => {
            renderQuizQuestions(questions);
        });

        // --- دوال القائمة الجانبية ---
        function toggleLeftSidebar() {
            const sidebar = document.getElementById('leftSidebar');
            const overlay = document.getElementById('leftSidebarOverlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // --- دوال المركز اليومي ---
        function openDailyCenter() {
            document.getElementById('dailyCenterModal').classList.add('show');
            document.getElementById('dailyCenterOverlay').classList.add('show');
        }

        function closeDailyCenter() {
            document.getElementById('dailyCenterModal').classList.remove('show');
            document.getElementById('dailyCenterOverlay').classList.remove('show');
        }

        function switchDailyTab(tab) {
            const rewardContent = document.getElementById('daily-reward-content');
            const wheelContent = document.getElementById('daily-wheel-content');
            const rewardTab = document.getElementById('tab-reward');
            const wheelTab = document.getElementById('tab-wheel');

            if (tab === 'reward') {
                rewardContent.classList.remove('hidden');
                wheelContent.classList.add('hidden');
                rewardTab.className = 'flex-1 py-3 text-sm font-bold text-white border-b-2 border-blue-500 bg-gray-700/50';
                wheelTab.className = 'flex-1 py-3 text-sm font-bold text-slate-400 hover:text-white';
            } else {
                rewardContent.classList.add('hidden');
                wheelContent.classList.remove('hidden');
                wheelTab.className = 'flex-1 py-3 text-sm font-bold text-white border-b-2 border-purple-500 bg-gray-700/50';
                rewardTab.className = 'flex-1 py-3 text-sm font-bold text-slate-400 hover:text-white';
            }
        }

        function claimDailyReward() {
            socket.emit('claim daily reward', { currentUser });
        }

        socket.on('daily reward success', (data) => {
            showNotification(`🎉 تم استلام المكافأة! حصلت على ${data.points} نقطة. (سلسلة: ${data.streak} أيام)`, 'success');
            if (currentUser) currentUser.points = data.totalPoints;
            // تشغيل صوت نجاح
            if (window.successSound) successSound.play().catch(e => {});
        });

        socket.on('daily reward error', (msg) => {
            showNotification(msg, 'warning');
        });

        // --- منطق لعبة الثعبان ---
        let currentSnakeGameId = null;
        const snakeCanvas = document.getElementById('snakeCanvas');
        const snakeCtx = snakeCanvas.getContext('2d');
        const CELL_SIZE = 20; // يجب أن يطابق السيرفر (600/30 = 20)
        
        // متغيرات اللعب الفردي
        let isLocalSnakeGame = false;
        let localSnakeState = null;
        let localSnakeLoop = null;

        function openSnakeGame() {
            document.getElementById('snakeGameModal').classList.add('show');
            resetSnakeUI();
        }

        function closeSnakeGame() {
            if (currentSnakeGameId) {
                socket.emit('leave snake game', currentSnakeGameId);
                currentSnakeGameId = null;
            }
            endLocalGame(true); // إنهاء اللعب الفردي إن وجد
            document.getElementById('snakeGameModal').classList.remove('show');
        }

        function resetSnakeUI() {
            document.getElementById('snakeLobby').classList.remove('hidden');
            document.getElementById('createSnakeBtn').classList.remove('hidden');
            document.getElementById('startSnakeBtn').classList.add('hidden');
            document.getElementById('snakeCanvas').classList.add('hidden');
            document.getElementById('snakeControls').classList.add('hidden');
            document.getElementById('snakePlayersList').innerHTML = '';
            document.getElementById('snakeOverlay').classList.add('hidden');
            document.getElementById('snakeScoreDisplay').classList.add('hidden');
            document.getElementById('snakeCountdownOverlay').classList.add('hidden');
            document.getElementById('snakeModeSelection').classList.add('hidden');
            document.getElementById('snakeLobbyControls').classList.add('hidden');
        }

        function createSnakeGame() {
            // بدلاً من الإرسال المباشر، نظهر خيارات الوضع
            document.getElementById('createSnakeBtn').classList.add('hidden');
            document.getElementById('snakeModeSelection').classList.remove('hidden');
        }

        function cancelSnakeModeSelection() {
            document.getElementById('createSnakeBtn').classList.remove('hidden');
            document.getElementById('snakeModeSelection').classList.add('hidden');
        }

        function startMultiPlayerSnake() {
            cancelSnakeModeSelection();
            socket.emit('create snake game', { currentUser });
        }

        function startSinglePlayerSnake() {
            cancelSnakeModeSelection();
            document.getElementById('snakeLobby').classList.add('hidden');
            document.getElementById('snakeCanvas').classList.remove('hidden');
            document.getElementById('snakeControls').classList.remove('hidden');
            document.getElementById('snakeControls').classList.add('md:hidden');
            
            isLocalSnakeGame = true;
            
            // إعداد حالة اللعبة المحلية
            localSnakeState = {
                snake: [{x: 10, y: 10}],
                food: {x: 15, y: 5},
                direction: {x: 0, y: -1},
                nextDirection: {x: 0, y: -1},
                score: 0,
                width: 30, // 600 / 20
                height: 20, // 400 / 20
                frameCount: 0
            };
            
            const scoreEl = document.getElementById('snakeScoreDisplay');
            scoreEl.textContent = `النتيجة: 0`;
            scoreEl.classList.remove('hidden');

            runLocalSnakeGame();
        }

        function runLocalSnakeGame() {
            if (!isLocalSnakeGame) return;

            // تحديث المنطق
            const state = localSnakeState;
            state.frameCount++;
            state.direction = state.nextDirection;
            
            const head = { x: state.snake[0].x + state.direction.x, y: state.snake[0].y + state.direction.y };

            // التحقق من التصادم (جدران أو جسم)
            if (head.x < 0 || head.x >= state.width || head.y < 0 || head.y >= state.height || 
                state.snake.some(s => s.x === head.x && s.y === head.y)) {
                endLocalGame();
                return;
            }

            state.snake.unshift(head);

            // أكل الطعام
            if (head.x === state.food.x && head.y === state.food.y) {
                state.score += 1;
                document.getElementById('snakeScoreDisplay').textContent = `النتيجة: ${state.score}`;
                // طعام جديد
                let valid = false;
                while(!valid) {
                    state.food = { x: Math.floor(Math.random() * state.width), y: Math.floor(Math.random() * state.height) };
                    valid = !state.snake.some(s => s.x === state.food.x && s.y === state.food.y);
                }
            } else {
                state.snake.pop();
            }

            // رسم اللعبة (نستخدم نفس منطق الرسم الموجود في snake game update لكن محلياً)
            // محاكاة كائن اللعبة للرسم
            const mockGameObj = {
                status: 'playing',
                food: state.food,
                players: [{
                    username: currentUser.name,
                    alive: true,
                    color: '#3b82f6',
                    snake: state.snake,
                    direction: state.direction
                }]
            };
            renderSnakeGame(mockGameObj); // دالة رسم مساعدة (سنستخرج كود الرسم الحالي إليها)

            // حلقة اللعبة (سرعة متغيرة)
            let delay = 200;
            if (state.frameCount > 6) {
                 const speedIncrease = Math.floor((state.frameCount - 6) / 50) * 5;
                 delay = Math.max(80, 200 - speedIncrease);
            } else {
                delay = 500; // بداية بطيئة
            }
            localSnakeLoop = setTimeout(runLocalSnakeGame, delay);
        }

        function endLocalGame(force = false) {
            isLocalSnakeGame = false;
            if (localSnakeLoop) clearTimeout(localSnakeLoop);
            
            if (!force && localSnakeState) {
                // إرسال النتيجة للسيرفر
                socket.emit('record snake score', localSnakeState.score);
                
                const overlay = document.getElementById('snakeOverlay');
                const text = document.getElementById('snakeWinnerText');
                overlay.classList.remove('hidden');
                text.innerHTML = `انتهت اللعبة<br><span class="text-sm text-white">النتيجة: ${localSnakeState.score}</span>`;
                
                setTimeout(() => {
                    resetSnakeUI();
                }, 3000);
            }
        }

        function joinSnakeGame(gameId) {
            openSnakeGame(); // فتح النافذة أولاً
            socket.emit('join snake game', { gameId, currentUser });
            currentSnakeGameId = gameId;
        }

        function startSnakeGame() {
            if (currentSnakeGameId) {
                socket.emit('start snake game', currentSnakeGameId);
            }
        }

        function sendSnakeDir(x, y) {
            if (isLocalSnakeGame && localSnakeState) {
                // منع العكس في اللعب الفردي
                if (localSnakeState.direction.x + x !== 0 || localSnakeState.direction.y + y !== 0) {
                    localSnakeState.nextDirection = {x, y};
                }
            } else if (currentSnakeGameId) {
                socket.emit('snake input', { gameId: currentSnakeGameId, direction: {x, y} });
            }
        }

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('snakeCanvas').classList.contains('hidden')) return;
            if (!currentSnakeGameId && !isLocalSnakeGame) return;
            
            switch(e.key) {
                case 'ArrowUp': sendSnakeDir(0, -1); break;
                case 'ArrowDown': sendSnakeDir(0, 1); break;
                case 'ArrowLeft': sendSnakeDir(-1, 0); break;
                case 'ArrowRight': sendSnakeDir(1, 0); break;
            }
        });

        function toggleSnakeReady() {
            if (currentSnakeGameId) {
                socket.emit('snake toggle ready', currentSnakeGameId);
            }
        }

        function updateSnakeColor(color) {
            if (currentSnakeGameId) {
                socket.emit('snake update color', { gameId: currentSnakeGameId, color });
            }
        }

        socket.on('snake game created', (data) => {
            currentSnakeGameId = data.gameId;
            document.getElementById('createSnakeBtn').classList.add('hidden');
            document.getElementById('startSnakeBtn').classList.remove('hidden');
        });

        socket.on('snake error', (msg) => {
            showNotification(msg, 'error');
        });

        socket.on('snake game update', (game) => {
            if (isLocalSnakeGame) return; // تجاهل تحديثات السيرفر إذا كنا في وضع فردي
            
            // تحديث قائمة الانتظار
            const myPlayer = game.players.find(p => p.username === currentUser.name);
            if (game.status === 'waiting') {
                document.getElementById('snakeLobbyControls').classList.remove('hidden');
                
                // تحديث قائمة اللاعبين
                const list = document.getElementById('snakePlayersList');
                list.innerHTML = game.players.map(p => `
                    <div class="bg-gray-800 p-4 rounded-xl border-2 flex flex-col items-center min-w-[120px] transform transition-all hover:scale-105 shadow-lg relative overflow-hidden" style="border-color: ${p.color}">
                        <div class="absolute top-0 left-0 w-full h-1 opacity-50" style="background-color: ${p.color}"></div>
                        <div class="w-12 h-12 rounded-full border-2 border-white/20 mb-2 flex items-center justify-center text-xl font-bold bg-gray-700 text-white shadow-inner">${p.username.charAt(0).toUpperCase()}</div>
                        <span class="text-sm font-bold text-white truncate max-w-[100px]">${p.username}</span>
                        <span class="text-[10px] mt-1 px-2 py-0.5 rounded-full ${p.isReady ? 'text-green-400 bg-green-400/10' : 'text-yellow-400 bg-yellow-400/10'}">
                            ${p.isReady ? 'مستعد ✅' : 'ينتظر...'}
                        </span>
                    </div>
                `).join('');
                
                // تحديث زر الاستعداد الخاص بي
                const readyBtn = document.getElementById('snakeReadyBtn');
                if (myPlayer) {
                    if (myPlayer.isReady) {
                        readyBtn.textContent = 'إلغاء الاستعداد ❌';
                        readyBtn.className = 'bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-full font-bold transition-colors';
                    } else {
                        readyBtn.textContent = 'استعداد ✅';
                        readyBtn.className = 'bg-gray-600 hover:bg-gray-500 text-white px-6 py-2 rounded-full font-bold transition-colors';
                    }
                }

                // تحديث منتقي الألوان (إذا لم يكن جاهزاً)
                const colorPicker = document.getElementById('snakeColorPicker');
                if (myPlayer && !myPlayer.isReady) {
                    const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#ffffff'];
                    colorPicker.innerHTML = colors.map(c => `
                        <button onclick="updateSnakeColor('${c}')" class="w-8 h-8 rounded-full border-2 ${myPlayer.color === c ? 'border-white scale-110' : 'border-transparent hover:scale-110'} transition-transform" style="background-color: ${c};"></button>
                    `).join('');
                    colorPicker.classList.remove('hidden');
                } else {
                    colorPicker.classList.add('hidden');
                }
                
                // إظهار زر البدء للمضيف فقط وفقط إذا كان الجميع مستعدين
                if (game.host === currentUser.name) {
                    const startBtn = document.getElementById('startSnakeBtn');
                    const allReady = game.players.every(p => p.isReady);
                    const enoughPlayers = game.players.length >= 2;

                    if (allReady && enoughPlayers) {
                        startBtn.classList.remove('hidden');
                    } else {
                        startBtn.classList.add('hidden');
                    }
                } else {
                    document.getElementById('startSnakeBtn').classList.add('hidden');
                    document.getElementById('createSnakeBtn').classList.add('hidden');
                }
            } 
            // رسم اللعبة
            else if (game.status === 'playing' || game.status === 'countdown') {
                renderSnakeGame(game, myPlayer);
            }
        });

        // دالة رسم موحدة (للفردي والجماعي)
        function renderSnakeGame(game, myPlayer = null) {
                document.getElementById('snakeLobby').classList.add('hidden');
                document.getElementById('snakeCanvas').classList.remove('hidden');
                document.getElementById('snakeControls').classList.remove('hidden');
                document.getElementById('snakeControls').classList.add('md:hidden'); // إظهار فقط في الجوال

                // تحديث عرض النتيجة (للفردي فقط أو للجميع)
                if (myPlayer) {
                    const scoreEl = document.getElementById('snakeScoreDisplay');
                    scoreEl.textContent = `النتيجة: ${myPlayer.score}`;
                    scoreEl.classList.remove('hidden');
                }

                // مسح الكانفاس
                snakeCtx.fillStyle = '#111827'; // bg-gray-900
                snakeCtx.fillRect(0, 0, snakeCanvas.width, snakeCanvas.height);
                
                // رسم شبكة خفيفة في الخلفية
                snakeCtx.strokeStyle = '#1f2937';
                snakeCtx.lineWidth = 0.5;
                for(let i=0; i<snakeCanvas.width; i+=CELL_SIZE) {
                    snakeCtx.beginPath(); snakeCtx.moveTo(i,0); snakeCtx.lineTo(i, snakeCanvas.height); snakeCtx.stroke();
                }
                for(let i=0; i<snakeCanvas.height; i+=CELL_SIZE) {
                    snakeCtx.beginPath(); snakeCtx.moveTo(0,i); snakeCtx.lineTo(snakeCanvas.width, i); snakeCtx.stroke();
                }

                // رسم الطعام
                // تأثير توهج للطعام
                snakeCtx.shadowBlur = 15;
                snakeCtx.shadowColor = "#ef4444";
                snakeCtx.fillStyle = '#ef4444';
                snakeCtx.beginPath();
                snakeCtx.arc(game.food.x * CELL_SIZE + CELL_SIZE/2, game.food.y * CELL_SIZE + CELL_SIZE/2, CELL_SIZE/2 - 2, 0, Math.PI * 2);
                snakeCtx.fill();
                // ورقة خضراء صغيرة للطعام
                snakeCtx.fillStyle = '#4ade80';
                snakeCtx.fillRect(game.food.x * CELL_SIZE + CELL_SIZE/2, game.food.y * CELL_SIZE, 4, 4);
                snakeCtx.shadowBlur = 0; // إعادة تعيين الظل

                // رسم الثعابين
                game.players.forEach(p => {
                    if (!p.alive) return;
                    snakeCtx.fillStyle = p.color;
                    
                    p.snake.forEach((segment, index) => {
                        const x = segment.x * CELL_SIZE;
                        const y = segment.y * CELL_SIZE;
                        
                        if (index === 0) {
                            // رسم الرأس (دائري قليلاً)
                            snakeCtx.beginPath();
                            snakeCtx.roundRect(x, y, CELL_SIZE, CELL_SIZE, 6);
                            snakeCtx.fill();
                            
                            // رسم العيون
                            snakeCtx.fillStyle = 'white';
                            // تحديد موقع العيون بناءً على الاتجاه (تقريبي)
                            const eyeOffsetX = p.direction.x > 0 ? 12 : (p.direction.x < 0 ? 4 : 4);
                            const eyeOffsetY = p.direction.y > 0 ? 12 : (p.direction.y < 0 ? 4 : 4);
                            
                            snakeCtx.beginPath(); snakeCtx.arc(x + 6, y + 6, 3, 0, Math.PI*2); snakeCtx.fill(); // عين يسرى
                            snakeCtx.beginPath(); snakeCtx.arc(x + 14, y + 6, 3, 0, Math.PI*2); snakeCtx.fill(); // عين يمنى
                            snakeCtx.fillStyle = p.color; // إعادة اللون للجسم
                        } else {
                            // رسم الجسم (مربع بحواف ناعمة قليلاً)
                            snakeCtx.fillRect(x + 1, y + 1, CELL_SIZE - 2, CELL_SIZE - 2);
                        }
                    });
                });
        }

        socket.on('snake countdown', (count) => {
            const countdownOverlay = document.getElementById('snakeCountdownOverlay');
            
            // التأكد من إظهار اللوحة
            document.getElementById('snakeLobby').classList.add('hidden');
            document.getElementById('snakeCanvas').classList.remove('hidden');
            countdownOverlay.classList.remove('hidden');
            
            // عرض الرقم أو كلمة انطلاق
            countdownOverlay.innerHTML = count > 0 ? `<span class="text-9xl font-black text-white drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]">${count}</span>` : '<span class="text-6xl font-black text-green-400 drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]">GO! 🐍</span>';
            
            // Animation for the countdown number
            countdownOverlay.style.transform = 'scale(1.5)';
            countdownOverlay.style.opacity = '0';
            setTimeout(() => {
                countdownOverlay.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
                countdownOverlay.style.transform = 'scale(1)';
                countdownOverlay.style.opacity = '1';
            }, 50);
        });

        socket.on('snake game started', () => {
            document.getElementById('snakeCountdownOverlay').classList.add('hidden');
            showNotification('بدأت اللعبة! حظاً موفقاً 🐍', 'success');
        });

        socket.on('snake game over', (data) => {
            const overlay = document.getElementById('snakeOverlay');
            const text = document.getElementById('snakeWinnerText');
            overlay.classList.remove('hidden');
            
            if (data.isMultiplayer) {
                text.innerHTML = `🏆 الفائز: ${data.winner}<br><span class="text-sm text-white">حصل على كأس!</span>`;
            } else {
                text.innerHTML = `${data.winner}`;
            }
            
            setTimeout(() => {
                resetSnakeUI();
                currentSnakeGameId = null;
            }, 5000);
        });

        // --- منطق لعبة باتل رويال ---
        let currentBattleRoyaleGameId = null;
        const brCanvas = document.getElementById('battleRoyaleCanvas');
        const brCtx = brCanvas ? brCanvas.getContext('2d') : null;
        const BR_CELL_SIZE = 20;

        function openBattleRoyaleGame() {
            document.getElementById('battleRoyaleModal').classList.add('show');
            resetBattleRoyaleUI();
        }

        function closeBattleRoyaleGame() {
            if (currentBattleRoyaleGameId) {
                socket.emit('leave battleRoyale game', currentBattleRoyaleGameId);
                currentBattleRoyaleGameId = null;
            }
            document.getElementById('battleRoyaleModal').classList.remove('show');
        }

        function resetBattleRoyaleUI() {
            document.getElementById('battleRoyaleLobby').classList.remove('hidden');
            document.getElementById('battleRoyaleGameArea').classList.add('hidden');
            document.getElementById('createBattleRoyaleBtn').classList.remove('hidden');
            document.getElementById('battleRoyaleReadyBtn').classList.add('hidden');
            document.getElementById('startBattleRoyaleBtn').classList.add('hidden');
            document.getElementById('battleRoyalePlayersList').innerHTML = '';
            document.getElementById('battleRoyaleWinnerOverlay').classList.add('hidden');
        }

        function createBattleRoyaleGame() {
            socket.emit('create battleRoyale game', { currentUser });
        }

        function joinBattleRoyaleGame(gameId) {
            openBattleRoyaleGame();
            socket.emit('join battleRoyale game', { gameId, currentUser });
            currentBattleRoyaleGameId = gameId;
        }

        function toggleBattleRoyaleReady() {
            if (currentBattleRoyaleGameId) {
                socket.emit('battleRoyale toggle ready', currentBattleRoyaleGameId);
            }
        }

        function startBattleRoyaleGame() {
            if (currentBattleRoyaleGameId) {
                socket.emit('start battleRoyale game', currentBattleRoyaleGameId);
            }
        }

        function sendBattleRoyaleMove(direction) {
            if (currentBattleRoyaleGameId) {
                socket.emit('battleRoyale move', { gameId: currentBattleRoyaleGameId, direction });
            }
        }

        function sendBattleRoyaleShoot() {
            if (currentBattleRoyaleGameId) {
                socket.emit('battleRoyale shoot', currentBattleRoyaleGameId);
            }
        }

        document.addEventListener('keydown', (e) => {
            if (document.getElementById('battleRoyaleModal').classList.contains('show') && !document.getElementById('battleRoyaleGameArea').classList.contains('hidden')) {
                switch(e.key) {
                    case 'w': case 'ArrowUp': sendBattleRoyaleMove('up'); break;
                    case 's': case 'ArrowDown': sendBattleRoyaleMove('down'); break;
                    case 'a': case 'ArrowLeft': sendBattleRoyaleMove('left'); break;
                    case 'd': case 'ArrowRight': sendBattleRoyaleMove('right'); break;
                    case ' ': sendBattleRoyaleShoot(); e.preventDefault(); break;
                }
            }
        });

        socket.on('battleRoyale game created', (data) => {
            currentBattleRoyaleGameId = data.gameId;
            document.getElementById('createBattleRoyaleBtn').classList.add('hidden');
            document.getElementById('battleRoyaleReadyBtn').classList.remove('hidden');
        });

        socket.on('battleRoyale game update', (game) => {
            if (!game) return;
            currentBattleRoyaleGameId = game.id;

            if (game.status === 'waiting') {
                document.getElementById('battleRoyaleLobby').classList.remove('hidden');
                document.getElementById('battleRoyaleGameArea').classList.add('hidden');
                
                const list = document.getElementById('battleRoyalePlayersList');
                list.innerHTML = game.players.map(p => `
                    <div class="bg-gray-800 p-3 rounded-xl border-2 ${p.isReady ? 'border-green-500' : 'border-gray-600'} flex flex-col items-center min-w-[100px]">
                        <img src="${p.avatar}" class="w-10 h-10 rounded-full mb-2 object-cover">
                        <span class="text-sm font-bold text-white truncate max-w-[80px]">${p.username}</span>
                        <span class="text-[10px] mt-1 ${p.isReady ? 'text-green-400' : 'text-yellow-400'}">${p.isReady ? 'مستعد' : 'ينتظر'}</span>
                    </div>
                `).join('');

                if (game.host === currentUser.name && game.players.length >= 1 && game.players.every(p => p.isReady)) {
                    document.getElementById('startBattleRoyaleBtn').classList.remove('hidden');
                } else {
                    document.getElementById('startBattleRoyaleBtn').classList.add('hidden');
                }
                
                if (game.players.some(p => p.username === currentUser.name)) {
                    document.getElementById('createBattleRoyaleBtn').classList.add('hidden');
                    document.getElementById('battleRoyaleReadyBtn').classList.remove('hidden');
                }
            } else if (game.status === 'playing') {
                document.getElementById('battleRoyaleLobby').classList.add('hidden');
                document.getElementById('battleRoyaleGameArea').classList.remove('hidden');
                renderBattleRoyaleGame(game);
            } else if (game.status === 'over') {
                renderBattleRoyaleGame(game); // ارسم الحالة النهائية
                const winnerOverlay = document.getElementById('battleRoyaleWinnerOverlay');
                winnerOverlay.textContent = `🏆 الفائز: ${game.winner}`;
                winnerOverlay.classList.remove('hidden');
                setTimeout(() => {
                    resetBattleRoyaleUI();
                }, 5000);
            }
        });

        function renderBattleRoyaleGame(game) {
            if (!brCtx || !brCanvas) return;
            brCtx.fillStyle = '#111827';
            brCtx.fillRect(0, 0, brCanvas.width, brCanvas.height);

            brCtx.fillStyle = '#4b5563';
            for (let y = 0; y < game.map.length; y++) {
                for (let x = 0; x < game.map[y].length; x++) {
                    if (game.map[y][x] === 1) {
                        brCtx.fillRect(x * BR_CELL_SIZE, y * BR_CELL_SIZE, BR_CELL_SIZE, BR_CELL_SIZE);
                    }
                }
            }

            brCtx.font = "16px Cairo";
            brCtx.fillStyle = '#f59e0b';
            game.items.forEach(item => {
                brCtx.fillText('🔫', item.x * BR_CELL_SIZE, (item.y + 1) * BR_CELL_SIZE - 4);
            });

            game.players.forEach(player => {
                if (player.health > 0) {
                    brCtx.fillStyle = player.color;
                    brCtx.beginPath();
                    brCtx.arc(player.x * BR_CELL_SIZE + BR_CELL_SIZE / 2, player.y * BR_CELL_SIZE + BR_CELL_SIZE / 2, BR_CELL_SIZE / 2 - 2, 0, 2 * Math.PI);
                    brCtx.fill();

                    brCtx.fillStyle = '#dc2626';
                    brCtx.fillRect(player.x * BR_CELL_SIZE, player.y * BR_CELL_SIZE - 7, BR_CELL_SIZE, 4);
                    brCtx.fillStyle = '#16a34a';
                    brCtx.fillRect(player.x * BR_CELL_SIZE, player.y * BR_CELL_SIZE - 7, BR_CELL_SIZE * (player.health / player.maxHealth), 4);
                }
            });

            brCtx.fillStyle = 'white';
            game.projectiles.forEach(p => {
                brCtx.fillRect(p.x * BR_CELL_SIZE + BR_CELL_SIZE/2 - 2, p.y * BR_CELL_SIZE + BR_CELL_SIZE/2 - 2, 4, 4);
            });
        }

        socket.on('battleRoyale error', (msg) => {
            showNotification(msg, 'error');
        });

        // --- لوحة ملوك الثعبان ---
        let snakeLeaderboardData = { single: [], multi: [] };

        function openSnakeLeaderboard() {
            document.getElementById('snakeLeaderboardModal').classList.add('show');
            
            // عرض مؤشر التحميل
            document.getElementById('snake-leaderboard-content').innerHTML = '<div class="text-center text-slate-400 p-8"><div class="spinner mx-auto"></div><p class="mt-2">جاري التحميل...</p></div>';
            
            // تعيين التبويب الافتراضي (بصرياً فقط)
            const singleTab = document.getElementById('tab-snake-single');
            const multiTab = document.getElementById('tab-snake-multi');
            singleTab.className = 'flex-1 py-3 text-sm font-bold text-white border-b-2 border-green-500 bg-gray-700/50';
            multiTab.className = 'flex-1 py-3 text-sm font-bold text-slate-400 hover:text-white';

            socket.emit('get snake leaderboard');
        }

        function closeSnakeLeaderboard() {
            document.getElementById('snakeLeaderboardModal').classList.remove('show');
        }

        function switchSnakeTab(tab) {
            const singleTab = document.getElementById('tab-snake-single');
            const multiTab = document.getElementById('tab-snake-multi');
            
            if (tab === 'single') {
                singleTab.className = 'flex-1 py-3 text-sm font-bold text-white border-b-2 border-green-500 bg-gray-700/50';
                multiTab.className = 'flex-1 py-3 text-sm font-bold text-slate-400 hover:text-white';
                renderSnakeLeaderboard(snakeLeaderboardData.single, 'single');
            } else {
                multiTab.className = 'flex-1 py-3 text-sm font-bold text-white border-b-2 border-yellow-500 bg-gray-700/50';
                singleTab.className = 'flex-1 py-3 text-sm font-bold text-slate-400 hover:text-white';
                renderSnakeLeaderboard(snakeLeaderboardData.multi, 'multi');
            }
        }

        function renderSnakeLeaderboard(list, type) {
            const container = document.getElementById('snake-leaderboard-content');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-400 py-4">لا توجد بيانات بعد.</p>';
                return;
            }

            list.forEach((user, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center bg-gray-800 p-3 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer';
                div.onclick = () => showUserProfileModal(user.username);
                
                const valueDisplay = type === 'single' ? `${user.value} نقطة` : `${user.value} 🏆`;
                const rankColor = index === 0 ? 'text-yellow-400' : (index === 1 ? 'text-gray-300' : (index === 2 ? 'text-orange-400' : 'text-slate-500'));

                div.innerHTML = `
                    <div class="flex-shrink-0 w-8 text-center font-bold ${rankColor} text-lg">${index + 1}</div>
                    <img src="${user.avatar}" class="w-10 h-10 rounded-full object-cover mx-3 border border-gray-600">
                    <div class="flex-1 font-semibold text-white truncate">${user.username}</div>
                    <div class="font-bold text-yellow-300">${valueDisplay}</div>
                `;
                container.appendChild(div);
            });
        }

        socket.on('snake leaderboard data', (data) => {
            snakeLeaderboardData = data;
            // إعادة رسم التبويب الحالي
            const activeTab = document.getElementById('tab-snake-single').classList.contains('border-green-500') ? 'single' : 'multi';
            renderSnakeLeaderboard(data[activeTab], activeTab);
        });

        // منطق عجلة الحظ
        let isSpinning = false;
        
        function spinWheel() {
            if (isSpinning) return;
            if (confirm('هل أنت متأكد؟ سيتم خصم 500 نقطة لتدوير العجلة.')) {
                socket.emit('spin wheel', { currentUser });
            }
        }

        socket.on('spin wheel result', (data) => {
            const wheel = document.getElementById('luckyWheel');
            const spinBtn = document.getElementById('spinButton');
            
            isSpinning = true;
            spinBtn.disabled = true;
            
            // حساب الزاوية: 7 أقسام، كل قسم ~51.4 درجة
            // الأقسام مرتبة في CSS: أحمر(0)، أزرق(1)، أخضر(2)، أصفر(3)، بنفسجي(4)، وردي(5)، رمادي(6)
            // المؤشر في الأعلى، لذا نحتاج لتدوير العجلة بحيث يأتي القسم المطلوب تحت المؤشر
            const segmentAngle = 360 / 7;
            // إضافة دورات عشوائية (5 دورات كاملة على الأقل)
            const spins = 5 * 360; 
            // حساب الزاوية النهائية للوصول للقسم المحدد (مع تعديل بسيط للمؤشر)
            // القسم 0 يبدأ من 0، القسم 1 من 51.4...
            // لكي يأتي القسم 0 تحت المؤشر (أعلى)، الزاوية 0 تكفي (أو 360).
            // لكي يأتي القسم 1، نحتاج تدوير العكس بمقدار 51.4...
            // الصيغة: spins + (360 - (index * segmentAngle) - (segmentAngle / 2))
            const stopAngle = spins + (360 - (data.prizeIndex * segmentAngle) - (segmentAngle / 2));
            
            wheel.style.transform = `rotate(${stopAngle}deg)`;
            
            setTimeout(() => {
                isSpinning = false;
                spinBtn.disabled = false;
                wheel.style.transition = 'none';
                wheel.style.transform = `rotate(${stopAngle % 360}deg)`;
                setTimeout(() => wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.83, 0.67)', 50);
                
                const msg = data.prizeValue > 0 ? `🎉 مبروك! ربحت ${data.prizeValue} نقطة!` : 'حظ أوفر في المرة القادمة!';
                showNotification(msg, data.prizeValue > 0 ? 'success' : 'info');
                if (currentUser) currentUser.points = data.remainingPoints;
            }, 4000); // مدة الدوران
        });
        
        socket.on('spin wheel error', (msg) => {
            showNotification(msg, 'error');
        });

        // --- دوال لوحة الشرف (XP) ---
        function openXPLeaderboard() {
            document.getElementById('xpLeaderboardModal').classList.add('show');
            document.getElementById('xpLeaderboardOverlay').classList.add('show');
            socket.emit('get xp leaderboard');
        }

        function closeXPLeaderboard() {
            document.getElementById('xpLeaderboardModal').classList.remove('show');
            document.getElementById('xpLeaderboardOverlay').classList.remove('show');
        }

        socket.on('xp leaderboard list', (users) => {
            const container = document.getElementById('xpLeaderboardList');
            container.innerHTML = '';
            if (users.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-center p-8">لا توجد بيانات.</p>';
                return;
            }
            users.forEach((user, index) => {
                const userDiv = document.createElement('div');
                userDiv.className = 'flex items-center bg-gray-800 p-3 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer';
                userDiv.onclick = () => showUserProfileModal(user.username);
                userDiv.innerHTML = `
                    <div class="flex-shrink-0 w-10 text-center text-xl font-bold ${index < 3 ? 'text-cyan-400' : 'text-slate-400'}">${index + 1}</div>
                    <img src="${user.avatar}" class="w-10 h-10 rounded-full object-cover mx-2" alt="${user.username}">
                    <div class="flex-1 min-w-0">
                        <div class="text-white font-semibold truncate">${user.username}</div>
                        <div class="text-xs text-slate-400">المستوى ${user.level}</div>
                    </div>
                    <div class="text-cyan-400 font-bold text-sm">⚡ ${user.xp} XP</div>
                `;
                container.appendChild(userDiv);
            });
        });

        // --- دوال لوحة المستخدمين القدامى ---
        function openOldestUsersLeaderboard() {
            document.getElementById('oldestUsersModal').classList.add('show');
            document.getElementById('oldestUsersOverlay').classList.add('show');
            socket.emit('get oldest users leaderboard');
        }

        function closeOldestUsersLeaderboard() {
            document.getElementById('oldestUsersModal').classList.remove('show');
            document.getElementById('oldestUsersOverlay').classList.remove('show');
        }

        socket.on('oldest users list', (users) => {
            const container = document.getElementById('oldestUsersList');
            container.innerHTML = '';
            if (users.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-center p-8">لا توجد بيانات.</p>';
                return;
            }
            users.forEach((user, index) => {
                const userDiv = document.createElement('div');
                userDiv.className = 'flex items-center bg-gray-800 p-3 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer';
                userDiv.onclick = () => showUserProfileModal(user.username);
                const joinDate = new Date(user.createdAt).toLocaleDateString('en-GB');
                userDiv.innerHTML = `
                    <div class="flex-shrink-0 w-10 text-center text-xl font-bold ${index < 3 ? 'text-amber-400' : 'text-slate-400'}">${index + 1}</div>
                    <img src="${user.avatar}" class="w-10 h-10 rounded-full object-cover mx-2" alt="${user.username}">
                    <div class="flex-1 min-w-0">
                        <div class="text-white font-semibold truncate">${user.username}</div>
                        <div class="text-xs text-slate-400">انضم: ${joinDate}</div>
                    </div>
                `;
                container.appendChild(userDiv);
            });
        });

        // --- دوال لوحة المشاركين (التفاعل) ---
        function openInteractionLeaderboard() {
            document.getElementById('interactionLeaderboardModal').classList.add('show');
            document.getElementById('interactionLeaderboardOverlay').classList.add('show');
            socket.emit('get interaction leaderboard');
        }

        function closeInteractionLeaderboard() {
            document.getElementById('interactionLeaderboardModal').classList.remove('show');
            document.getElementById('interactionLeaderboardOverlay').classList.remove('show');
        }

        socket.on('interaction leaderboard list', (users) => {
            const container = document.getElementById('interactionLeaderboardList');
            container.innerHTML = '';
            if (users.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-center p-8">لا توجد بيانات.</p>';
                return;
            }
            users.forEach((user, index) => {
                const userDiv = document.createElement('div');
                userDiv.className = 'flex items-center bg-gray-800 p-3 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer';
                userDiv.onclick = () => showUserProfileModal(user.username);
                userDiv.innerHTML = `
                    <div class="flex-shrink-0 w-10 text-center text-xl font-bold ${index < 3 ? 'text-rose-400' : 'text-slate-400'}">${index + 1}</div>
                    <img src="${user.avatar}" class="w-10 h-10 rounded-full object-cover mx-2" alt="${user.username}">
                    <div class="flex-1 min-w-0">
                        <div class="text-white font-semibold truncate">${user.username}</div>
                    </div>
                    <div class="text-rose-400 font-bold text-sm">🔥 ${user.interactionScore}</div>
                `;
                container.appendChild(userDiv);
            });
        });

        // تحديث دالة عرض الملف الشخصي لتشمل XP
        const originalShowUserProfile = showUserProfile;
        showUserProfile = function(profileData) {
            originalShowUserProfile(profileData);
            const xpElem = document.getElementById('profileXP');
            if (xpElem) xpElem.textContent = profileData.xp || 0;
        };
    </script>
    <script>
       

        function openBattleRoyaleGame() {
            document.getElementById('battleRoyaleModal').classList.add('show');
            resetBattleRoyaleUI();
        }

        function closeBattleRoyaleGame() {
            if (currentBattleRoyaleGameId) {
                socket.emit('leave battleRoyale game', currentBattleRoyaleGameId);
                currentBattleRoyaleGameId = null;
            }
            document.getElementById('battleRoyaleModal').classList.remove('show');
        }

        function resetBattleRoyaleUI() {
            document.getElementById('battleRoyaleLobby').classList.remove('hidden');
            document.getElementById('battleRoyaleGameArea').classList.add('hidden');
            document.getElementById('createBattleRoyaleBtn').classList.remove('hidden');
            document.getElementById('battleRoyaleReadyBtn').classList.add('hidden');
            document.getElementById('startBattleRoyaleBtn').classList.add('hidden');
            document.getElementById('battleRoyalePlayersList').innerHTML = '';
            document.getElementById('battleRoyaleWinnerOverlay').classList.add('hidden');
        }

        function createBattleRoyaleGame() {
            socket.emit('create battleRoyale game', { currentUser });
        }

        function joinBattleRoyaleGame(gameId) {
            openBattleRoyaleGame();
            socket.emit('join battleRoyale game', { gameId, currentUser });
            currentBattleRoyaleGameId = gameId;
        }

        function toggleBattleRoyaleReady() {
            if (currentBattleRoyaleGameId) {
                socket.emit('battleRoyale toggle ready', currentBattleRoyaleGameId);
            }
        }

        function startBattleRoyaleGame() {
            if (currentBattleRoyaleGameId) {
                socket.emit('start battleRoyale game', currentBattleRoyaleGameId);
            }
        }

        function sendBattleRoyaleMove(direction) {
            if (currentBattleRoyaleGameId) {
                socket.emit('battleRoyale move', { gameId: currentBattleRoyaleGameId, direction });
            }
        }

        function sendBattleRoyaleShoot() {
            if (currentBattleRoyaleGameId) {
                socket.emit('battleRoyale shoot', currentBattleRoyaleGameId);
            }
        }

        document.addEventListener('keydown', (e) => {
            if (document.getElementById('battleRoyaleModal').classList.contains('show') && !document.getElementById('battleRoyaleGameArea').classList.contains('hidden')) {
                // منع التمرير عند استخدام الأسهم أو المسافة
                if(['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
                    e.preventDefault();
                }
                switch(e.key) {
                    case 'w': case 'ArrowUp': sendBattleRoyaleMove('up'); break;
                    case 's': case 'ArrowDown': sendBattleRoyaleMove('down'); break;
                    case 'a': case 'ArrowLeft': sendBattleRoyaleMove('left'); break;
                    case 'd': case 'ArrowRight': sendBattleRoyaleMove('right'); break;
                    case ' ': sendBattleRoyaleShoot(); break;
                }
            }
        });

        socket.on('battleRoyale game created', (data) => {
            currentBattleRoyaleGameId = data.gameId;
            document.getElementById('createBattleRoyaleBtn').classList.add('hidden');
            document.getElementById('battleRoyaleReadyBtn').classList.remove('hidden');
        });

        socket.on('battleRoyale game update', (game) => {
            if (!game) return;
            currentBattleRoyaleGameId = game.id;

            if (game.status === 'waiting') {
                document.getElementById('battleRoyaleLobby').classList.remove('hidden');
                document.getElementById('battleRoyaleGameArea').classList.add('hidden');
                
                const list = document.getElementById('battleRoyalePlayersList');
                list.innerHTML = game.players.map(p => `
                    <div class="bg-gray-800 p-3 rounded-xl border-2 ${p.isReady ? 'border-green-500' : 'border-gray-600'} flex flex-col items-center min-w-[100px]">
                        <img src="${p.avatar}" class="w-10 h-10 rounded-full mb-2 object-cover">
                        <span class="text-sm font-bold text-white truncate max-w-[80px]">${p.username}</span>
                        <span class="text-[10px] mt-1 ${p.isReady ? 'text-green-400' : 'text-yellow-400'}">${p.isReady ? 'مستعد' : 'ينتظر'}</span>
                    </div>
                `).join('');

                if (game.host === currentUser.name && game.players.length >= 1 && game.players.every(p => p.isReady)) {
                    document.getElementById('startBattleRoyaleBtn').classList.remove('hidden');
                } else {
                    document.getElementById('startBattleRoyaleBtn').classList.add('hidden');
                }
                
                if (game.players.some(p => p.username === currentUser.name)) {
                    document.getElementById('createBattleRoyaleBtn').classList.add('hidden');
                    document.getElementById('battleRoyaleReadyBtn').classList.remove('hidden');
                }
            } else if (game.status === 'playing') {
                document.getElementById('battleRoyaleLobby').classList.add('hidden');
                document.getElementById('battleRoyaleGameArea').classList.remove('hidden');
                renderBattleRoyaleGame(game);
            } else if (game.status === 'over') {
                renderBattleRoyaleGame(game); // ارسم الحالة النهائية
                const winnerOverlay = document.getElementById('battleRoyaleWinnerOverlay');
                winnerOverlay.textContent = `🏆 الفائز: ${game.winner}`;
                winnerOverlay.classList.remove('hidden');
                setTimeout(() => {
                    resetBattleRoyaleUI();
                }, 5000);
            }
        });

        function renderBattleRoyaleGame(game) {
            brCtx.fillStyle = '#111827';
            brCtx.fillRect(0, 0, brCanvas.width, brCanvas.height);

            brCtx.fillStyle = '#4b5563';
            for (let y = 0; y < game.map.length; y++) {
                for (let x = 0; x < game.map[y].length; x++) {
                    if (game.map[y][x] === 1) {
                        brCtx.fillRect(x * BR_CELL_SIZE, y * BR_CELL_SIZE, BR_CELL_SIZE, BR_CELL_SIZE);
                    }
                }
            }

            game.players.forEach(player => {
                if (player.health > 0) {
                    brCtx.fillStyle = player.color;
                    brCtx.beginPath();
                    brCtx.arc(player.x * BR_CELL_SIZE + BR_CELL_SIZE / 2, player.y * BR_CELL_SIZE + BR_CELL_SIZE / 2, BR_CELL_SIZE / 2 - 2, 0, 2 * Math.PI);
                    brCtx.fill();

                    brCtx.fillStyle = '#dc2626';
                    brCtx.fillRect(player.x * BR_CELL_SIZE, player.y * BR_CELL_SIZE - 7, BR_CELL_SIZE, 4);
                    brCtx.fillStyle = '#16a34a';
                    brCtx.fillRect(player.x * BR_CELL_SIZE, player.y * BR_CELL_SIZE - 7, BR_CELL_SIZE * (player.health / player.maxHealth), 4);
                }
            });

            brCtx.fillStyle = 'white';
            game.projectiles.forEach(p => {
                brCtx.fillRect(p.x * BR_CELL_SIZE + BR_CELL_SIZE/2 - 2, p.y * BR_CELL_SIZE + BR_CELL_SIZE/2 - 2, 4, 4);
            });
        }

        socket.on('battleRoyale error', (msg) => {
            showNotification(msg, 'error');
        });
    </script>
    <script>
        // --- نظام الإشعارات بالنقطة الحمراء ---
        function showDot(type, show) {
            const dot = document.getElementById(`${type}NotificationDot`);
            if (dot) {
                dot.classList.toggle('hidden', !show);
            }
            updateMasterDot();
        }

        function updateMasterDot() {
            const masterDot = document.getElementById('masterNotificationDot');
            if (!masterDot) return;

            const drawingDot = !document.getElementById('drawingNotificationDot')?.classList.contains('hidden');
            const postsDot = !document.getElementById('postsNotificationDot')?.classList.contains('hidden');
            const friendsDot = !document.getElementById('friendsNotificationDot')?.classList.contains('hidden');
            // تم إزالة messagesDot من الشرط كما طلبت
            
            const anyDotVisible = drawingDot || postsDot || friendsDot;
            masterDot.classList.toggle('hidden', !anyDotVisible);
        }

        // عند تحميل الصفحة، تحقق من الإشعارات المحفوظة
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('hasNewPosts') === 'true') showDot('posts', true);
        });
    </script>
</body>
</html>