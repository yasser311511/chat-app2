
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WalChat - ูุงู ุดุงุช  ููุตุฉ ุงูุฏุฑุฏุดุฉ ุงูุนุฑุจูุฉ </title>
    <meta name="description" content="WalChat - ููุตุฉ ุฏุฑุฏุดุฉ ุนุฑุจูุฉ ุขููุฉ ูููุชุนุฉ. ุชูุงุตู ูุน ุงูุฃุตุฏูุงุก ูู ุจูุฆุฉ ูุญููุฉ ุจููุงููู ุตุงุฑูุฉ ุถุฏ ุงูุฅุณุงุกุฉ ูุงููุญุชูู ุบูุฑ ุงููุงุฆู.">
    <meta name="keywords" content="ุฏุฑุฏุดุฉ ุนุฑุจูุฉ, ุดุงุช ุนุฑุจู, ูุญุงุฏุซุฉ, ุชูุงุตู ,ูุงู ุดุงุช,WalChat, ุฏุฑุฏุดุฉ ุขููุฉ">
    <meta name="author" content="WalChat">
    <meta property="og:title" content="WalChat - ููุตุฉ ุงูุฏุฑุฏุดุฉ ุงูุนุฑุจูุฉ">
    <meta property="og:description" content="ุงูุถู ุฅูู ูุฌุชูุน WalChat ููุฏุฑุฏุดุฉ ุงูุนุฑุจูุฉ ุงูุขููุฉ ูุงูููุชุนุฉ">
    <meta property="og:image" content="https://walidchating.onrender.com/icon.png">
    <meta property="og:url" content="https://walidchating.onrender.com">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="canonical" href="https://walidchating.onrender.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        .chat-message {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-container { transition: all 0.3s ease; }
        .tab-button { transition: all 0.2s ease; }
        .avatar-option { transition: all 0.2s ease; }
        .avatar-option:hover { transform: scale(1.1); }
        .avatar-option.selected { border: 3px solid #3B82F6; }
        .notification {
            animation: notificationSlide 0.5s ease-out, notificationFade 5s forwards;
        }
        @keyframes notificationSlide {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes notificationFade {
            0%, 70% { opacity: 1; }
            100% { opacity: 0; }
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        /* ุชุนุฏูู z-index ููุดุงุดุงุช ุงููุจูุฑุฉ - ุชู ูููู ุฅูู ุฑุฃุณ ุงููุญุงุฏุซุฉ */
        @media (min-width: 768px) {
            #onlineUsersPanel { z-index: 20; }
        }
        /* ุชุนุฏูู ุฎุงุต ุจุงูุดุงุดุงุช ุงูุตุบูุฑุฉ */
        @media (max-width: 768px) {
            .chat-header-mobile { min-height: 110px; }
            .chat-header-buttons { flex-wrap: wrap; justify-content: flex-end; gap: 0.5rem; }
        }
        .rank-badge {
            background: linear-gradient(45deg, #3B82F6, #8B5CF6);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            margin-left: 5px;
        }
        .messages-container {
            height: calc(100vh - 200px);
            overflow-y: auto;
        }
    
        .users-container {
            height: calc(100vh - 200px);
            overflow-y: auto;
        }
    
        /* ูุถูู ุฃู ุงููุญุชูู ุงูุฑุฆูุณู ูุง ููุฒุงุญ */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* ุณุจููุฑ ุงูุชุญููู */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        @media (max-width: 768px) {
            .users-container {
                position: fixed;
                top: 0;
                right: -100%;
                width: 80%;
                height: 100vh;
                z-index: 50;
                transition: right 0.3s ease;
                background: rgba(15, 23, 42, 0.95);
                backdrop-filter: blur(10px);
                padding: 1rem;
            }
            
            .users-container.show {
                right: 0;
            }
            
            .users-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }
            
            .users-overlay.show {
                display: block;
            }
        }

        /* ููุท ูุงูุฐุฉ ุงูููู ุงูุดุฎุตู */
       .private-chat-modal {
    position: fixed;
    bottom: 100px;
    right: 20px;
    width: 350px;
    height: 450px;
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    z-index: 999;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    transform: translateY(100%);
    opacity: 0;
    transition: all 0.3s ease;
    pointer-events: none; /* ูุฐุง ุงูุณุทุฑ ููู ูููุน ุงูุชูุงุนู ุนูุฏูุง ูููู ูุฎูููุง */
}

.private-chat-modal.show {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto; /* ุงูุณูุงุญ ุจุงูุชูุงุนู ุนูุฏูุง ูููู ุธุงูุฑูุง */
}
        
        .profile-content {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1.25rem; /* 20px */
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .profile-modal.show .profile-content {
            transform: scale(1);
        }
        
        /* ููุท ูุงูุฐุฉ ุงููุญุงุฏุซุฉ ุงูุฎุงุตุฉ */
        /* ููุท ูุงูุฐุฉ ุงูููู ุงูุดุฎุตู */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .profile-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .private-chat-modal {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 350px;
            height: 450px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .private-chat-modal.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .private-chat-header {
            background: rgba(30, 41, 59, 0.8);
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .private-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .private-chat-input {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ุชูุณููุงุช ุฌุฏูุฏุฉ ููุฑุฃุณ ูุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ */
        .main-header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
        }
        
        .user-profile-btn {
            transition: all 0.3s ease;
        }
        
        .user-profile-btn:hover {
            transform: translateY(-2px);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #EF4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        /* ุชูุณููุงุช ูุงุฆูุฉ ุงูุฃุตุฏูุงุก */
        .friends-sidebar {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            width: 300px;
            height: 100vh;
            position: fixed;
            top: 0;
            right: 0;
            z-index: 40;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .friends-sidebar.show {
            transform: translateX(0);
        }
        
        .friends-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 30;
        }
        
        .friends-overlay.show {
            display: block;
        }
        
        .friend-item {
            transition: all 0.3s ease;
        }
        
        .friend-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* ุฅุถุงูุฉ ูุฐู ุงูุฃููุงุท ูู ูุณู style */
.bg-option {
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.bg-option:hover {
    transform: scale(1.05);
}

.bg-option.selected > div {
    border-color: #3B82F6 !important;
}

/* ุฃููุงุท ุงูุตูุฑ ูู ุงููุญุงุฏุซุฉ */
.chat-image {
    max-width: 300px;
    max-height: 300px;
    border-radius: 10px;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.chat-image:hover {
    transform: scale(1.02);
}

/* ูุงูุฐุฉ ุนุฑุถ ุงูุตูุฑุฉ ุงูููุจุฑุฉ */
.image-modal {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* ุฃุฒุฑุงุฑ ุงูุตูุฑ */
#imageButton, #privateImageButton {
    transition: all 0.3s ease;
}

#imageButton:hover, #privateImageButton:hover {
    transform: scale(1.05);
}

/* ุฃููุงุท ูุฏูุฌุฉ ููุฑุณุงุฆู */
.chat-message {
    margin-bottom: 0.5rem !important;
}

.chat-message .max-w-xs,
.chat-message .max-w-md {
    padding: 0.5rem 0.75rem !important;
    border-radius: 1rem !important;
}

.chat-message .text-sm {
    font-size: 0.875rem !important;
    line-height: 1.25rem !important;
}

.chat-message .text-xs {
    font-size: 0.75rem !important;
}

/* ุชูููู ุญุฌู ุงูุตูุฑ ูู ุงููุญุงุฏุซุฉ */
.chat-image {
    max-width: 200px !important;
    max-height: 150px !important;
}

/* ุชูููู ุญุฌู ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ ูู ุงูุฑุณุงุฆู */
.chat-message img.w-8.h-8 {
    width: 1.5rem !important;
    height: 1.5rem !important;
}

.chat-message .w-8.h-8 {
    width: 1.5rem !important;
    height: 1.5rem !important;
    font-size: 0.75rem !important;
}

/* ุชุญุณูู ุชุฎุทูุท ูุนูููุงุช ุงููุณุชุฎุฏู */
.chat-message .flex.items-center.space-x-3 {
    margin-bottom: 0.25rem !important;
}

.chat-message .space-x-3 > * + * {
    margin-right: 0.5rem !important;
}

/* ุชูููู ุญุฌู ุฑุชุจุฉ ุงููุณุชุฎุฏู */
.rank-badge {
    font-size: 0.7rem !important;
    padding: 1px 6px !important;
}

/* ุชุญุณูู ุชุฎุทูุท ุฑุณุงุฆู ุงููุธุงู */
.chat-message.justify-center .max-w-md {
    padding: 0.4rem 0.75rem !important;
    font-size: 0.8rem !important;
}

/* ุชุญุณูู ููุทูุฉ ุนุฑุถ ุงูุฑุณุงุฆู */
.messages-container {
    padding: 0.5rem !important;
}

/* ุชุญุณูู ุดุฑูุท ุงูุชูุฑูุฑ */
.custom-scrollbar::-webkit-scrollbar {
    width: 4px !important;
}
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen">
    <!-- ุณุจููุฑ ุงูุชุญููู -->
    <div id="loadingSpinner" class="loading-overlay hidden">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-white text-lg">ุฌุงุฑู ุงูุชุญููู...</p>
        </div>
    </div>

    <!-- ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู -->
    <div id="loginPage" class="hidden min-h-screen flex items-center justify-center px-4">
        <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-8 max-w-md w-full border border-white/20 shadow-2xl">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">๐ฌ</div>
                <h1 class="text-3xl font-bold text-white mb-2">WalChat</h1>
                <p class="text-blue-200">ุณุฌู ุฏุฎููู ููุงูุถูุงู ุฅูู ุงููุญุงุฏุซุฉ</p>
            </div>

            <!-- ุฃุฒุฑุงุฑ ุงูุชุจุฏูู -->
            <div class="flex bg-white/10 rounded-xl p-1 mb-6">
                <button id="loginTab" class="tab-button flex-1 py-2 px-4 rounded-xl font-semibold bg-blue-600 text-white">ุชุณุฌูู ุงูุฏุฎูู</button>
                <button id="registerTab" class="tab-button flex-1 py-2 px-4 rounded-xl font-semibold text-blue-200">ุฅูุดุงุก ุญุณุงุจ</button>
            </div>

            <!-- ูููุฐุฌ ุชุณุฌูู ุงูุฏุฎูู -->
            <form id="loginForm" class="form-container space-y-4">
                <div>
                    <label class="block text-white text-sm font-semibold mb-2">ุงุณู ุงููุณุชุฎุฏู</label>
                    <input type="text" id="loginUsername" placeholder="ุฃุฏุฎู ุงุณู ุงููุณุชุฎุฏู" required 
                        class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>

                <div>
                    <label class="block text-white text-sm font-semibold mb-2">ูููุฉ ุงูุณุฑ</label>
                    <input type="password" id="loginPassword" placeholder="ุฃุฏุฎู ูููุฉ ุงูุณุฑ" required 
                        class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="rememberMe" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="rememberMe" class="block text-white text-sm">ุชุฐูุฑูู</label>
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors">
                    ุชุณุฌูู ุงูุฏุฎูู
                </button>
            </form>

            <!-- ูููุฐุฌ ุฅูุดุงุก ุญุณุงุจ -->
            <form id="registerForm" class="form-container hidden space-y-4">
                <div>
                    <label class="block text-white text-sm font-semibold mb-2">ุงุณู ุงููุณุชุฎุฏู</label>
                    <input type="text" id="registerUsername" placeholder="ุงุฎุชุฑ ุงุณู ุงููุณุชุฎุฏู" required 
                        class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>

                <div>
                    <label class="block text-white text-sm font-semibold mb-2">ูููุฉ ุงูุณุฑ</label>
                    <input type="password" id="registerPassword" placeholder="ุงุฎุชุฑ ูููุฉ ุงูุณุฑ" required 
                        class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>

                <div>
                    <label class="block text-white text-sm font-semibold mb-2">ุชุฃููุฏ ูููุฉ ุงูุณุฑ</label>
                    <input type="password" id="confirmPassword" placeholder="ุฃุนุฏ ุฅุฏุฎุงู ูููุฉ ุงูุณุฑ" required 
                        class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>

                <div>
                    <label class="block text-white text-sm font-semibold mb-2">ุงูุฌูุณ</label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="flex items-center space-x-3 space-x-reverse bg-white/10 hover:bg-white/20 rounded-lg p-3 cursor-pointer transition-colors">
                            <input type="radio" name="gender" value="male" required class="text-blue-600 focus:ring-blue-500">
                            <span class="text-white">๐จ ุฐูุฑ</span>
                        </label>
                        <label class="flex items-center space-x-3 space-x-reverse bg-white/10 hover:bg-white/20 rounded-lg p-3 cursor-pointer transition-colors">
                            <input type="radio" name="gender" value="female" required class="text-pink-600 focus:ring-pink-500">
                            <span class="text-white">๐ฉ ุฃูุซู</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors">
                    ุฅูุดุงุก ุญุณุงุจ
                </button>
            </form>

            <div class="mt-6 bg-blue-900/30 rounded-lg p-3">
                <p class="text-xs text-blue-200 text-center">
                     ุญุงูุธู ุนูู ุงููุฑุญ ูุงููุชุนุฉ !๐ก
                     ููููุน ุงูุณุจ ูุงูุดุชู !๐ก
                     ููููุน ุชูููู ุงูุนูุงูุงุช ููุง !๐ก
                     ููููุน ุงูุงุณุงุก ูููุณุชุฎุฏููู !๐ก
                    <br>๐ ุงู ุดุฎุต ูุฎุงูู ุงูููุงููู ูุญุธุฑ ูู ุงููููุน !
                </p>
            </div>
        </div>
    </div>

    <!-- ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ -->
    <div id="mainPage" class="hidden min-h-screen">
        <!-- ุฑุฃุณ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ -->
        <header class="main-header flex justify-between items-center">
            <div></div> <!-- ุนูุตุฑ ูุงุฑุบ ูููุณุงุญุฉ ุงููุณุฑู -->
            <h1 id="welcomeMessage" class="text-2xl font-bold text-white">๐ ุบุฑู ุงููุญุงุฏุซุฉ</h1>
<!-- ุฒุฑ ุงูููุดูุฑุงุช ูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ - ุณูุชู ุฅุฎูุงุคู -->
<div class="relative hidden">
    <button id="postsButton" class="text-white p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors relative">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <span id="postsBadge" class="notification-badge hidden">0</span>
    </button>
</div>

            <div class="flex items-center space-x-4 space-x-reverse">
               <!-- ูู ุฑุฃุณ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ - ุฏุงุฎู <div class="flex items-center space-x-4 space-x-reverse"> -->
<button id="changeBackgroundBtn" class="text-white p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors hidden">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
    </svg>
</button>
                <!-- ุฒุฑ ุงูุฅุดุนุงุฑุงุช ูุงูุฑุณุงุฆู - ุณูุชู ุฅุฎูุงุคู -->
                <div class="relative hidden">
    <button id="messagesButton" class="text-white p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors relative">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
        </svg>
        <span id="messagesBadge" class="notification-badge hidden">0</span>
        <!-- ุงููุงุฆูุฉ ุงูููุจุซูุฉ ููุฅุดุนุงุฑุงุช -->
        <div id="notificationsDropdown" class="hidden absolute top-full left-0 mt-2 w-72 bg-slate-800 rounded-lg shadow-lg border border-slate-700 z-50">
            <div class="p-3 border-b border-slate-700">
                <h3 class="text-white font-semibold">ุงูุฅุดุนุงุฑุงุช</h3>
            </div>
            <div id="notificationsList" class="p-2 max-h-80 overflow-y-auto custom-scrollbar">
                <!-- ุงูุฅุดุนุงุฑุงุช ุณุชุธูุฑ ููุง -->
            </div>
        </div>
    </button>
</div>
                
                <!-- ุฒุฑ ูุงุฆูุฉ ุงูุฃุตุฏูุงุก - ุณูุชู ุฅุฎูุงุคู -->
                <button id="friendsButton" class="text-white p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                </button>
                
                <!-- ุฒุฑ ุงูููู ุงูุดุฎุตู -->
                <button id="profileButton" class="user-profile-btn flex items-center space-x-2 space-x-reverse bg-white/10 hover:bg-white/20 rounded-full pl-3 pr-2 py-1 transition-colors">
                    <span class="text-white text-sm font-medium" id="headerUsername"></span>
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white">
                        <span id="headerAvatarInitial"></span>
                    </div>
                </button>
                
                <!-- ุฒุฑ ุงูุฎุฑูุฌ -->
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-full font-semibold transition-colors flex items-center space-x-2 space-x-reverse text-sm">
                    <span>ุฎุฑูุฌ</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 01-3-3h4a3 3 0 013 3v1"></path>
                    </svg>
                </button>
            </div>
        </header>
       
        <div class="container mx-auto px-4 py-8">
            <div class="text-center mb-12">
                <p class="text-xl text-blue-200">ุงุฎุชุฑ ุบุฑูุฉ ุงููุญุงุฏุซุฉ ุงูุชู ุชุฑูุฏ ุงูุงูุถูุงู ุฅูููุง</p>
            </div>
           
            <div id="roomsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 max-w-7xl mx-auto">
                <!-- ุงูุบุฑู ุณูุชู ุชุญููููุง ุฏููุงููููุงู -->
            </div>
        </div>
    </div>

    <!-- ุตูุญุฉ ุงููุญุงุฏุซุฉ -->
    <div id="chatPage" class="hidden min-h-screen flex flex-col">
        <!-- ุฑุฃุณ ุงููุญุงุฏุซุฉ -->
        <div class="bg-white/10 backdrop-blur-lg border-b border-white/20 p-4 relative z-30 md:z-40 chat-header-mobile">
            <div class="container mx-auto flex items-center justify-between flex-wrap md:flex-nowrap">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <button onclick="goBack()" class="text-white hover:text-blue-200 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </button>
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <div id="chatIcon" class="text-3xl"></div>
                        <div>
                            <h2 id="chatTitle" class="text-xl font-semibold text-white"></h2>
                            <p class="text-sm text-blue-200">ูุชุตู ุงูุขู</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2 space-x-reverse mt-2 md:mt-0 chat-header-buttons">
                    <!-- ุฒุฑ ูุนุจุฉ XO -->
                    <a href="https://xo-game-6m3e.onrender.com/" target="_blank" class="text-white p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" title="ูุนุจุฉ XO">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </a>
                    <!-- ุฒุฑ ุงููุชุฌุฑ -->
                    <button id="shopButton" onclick="openShopModal()" class="text-white p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" title="ุงููุชุฌุฑ">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </button>

                    <!-- ูู ุฑุฃุณ ุตูุญุฉ ุงููุญุงุฏุซุฉ - ุฏุงุฎู <div class="flex items-center space-x-2 space-x-reverse"> -->
<button id="chatChangeBackgroundBtn" class="text-white p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors hidden">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
    </svg>
</button>
                    <!-- ุฒุฑ ุงูููุดูุฑุงุช ูู ูุงุฌูุฉ ุงููุญุงุฏุซุฉ -->
<button id="chatPostsButton" class="text-white p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors relative">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
    </svg>
    <span id="chatPostsBadge" class="notification-badge hidden">0</span>
</button>
                    <!-- ุฒุฑ ูุงุฆูุฉ ุงููุชูุงุนููู -->
                    <button id="topUsersButton" onclick="openTopUsersModal()" class="text-white p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" title="ูุงุฆูุฉ ุงููุชูุงุนููู">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14v6m-3-3h6M6 10h2a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10 0h2a2 2 0 002-2V6a2 2 0 00-2-2h-2a2 2 0 00-2 2v2a2 2 0 002 2zM6 20h2a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                    <!-- ุฒุฑ ุงูุฃุตุฏูุงุก ูู ูุงุฌูุฉ ุงููุญุงุฏุซุฉ -->
    <button id="chatFriendsButton" class="text-white p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
    </button>
                    <!-- ุฒุฑ ุงูุฑุณุงุฆู ุงูุฎุงุตุฉ (ุงูุจุฑูุฏ) -->
    <div class="relative" id="chatMessagesButtonContainer">
        <button id="chatMessagesButton" class="text-white p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors relative">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            <span id="chatMessagesBadge" class="notification-badge hidden"></span>
        </button>
        <div id="privateConversationsDropdown" class="hidden absolute top-full left-0 mt-2 w-72 bg-slate-800 rounded-lg shadow-lg border border-slate-700 z-50">
            <div class="p-3 border-b border-slate-700">
                <h3 class="text-white font-semibold">ุงููุญุงุฏุซุงุช ุงูุฎุงุตุฉ</h3>
            </div>
            <div id="privateConversationsList" class="p-2 max-h-80 overflow-y-auto custom-scrollbar">
                <!-- ุงููุญุงุฏุซุงุช ุงูุฎุงุตุฉ ุณุชุธูุฑ ููุง -->
            </div>
        </div>
    </div>
                    <!-- ุฒุฑ ุงูุฅุดุนุงุฑุงุช (ุงูุฌุฑุณ) -->
    <div class="relative" id="chatNotificationsButtonContainer">
        <button id="chatNotificationsButton" class="text-white p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors relative">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
            </svg>
            <span id="chatNotificationsBadge" class="notification-badge hidden"></span>
        </button>
        <div id="chatNotificationsDropdown" class="hidden absolute top-full left-0 mt-2 w-72 bg-slate-800 rounded-lg shadow-lg border border-slate-700 z-50">
            <div class="p-3 border-b border-slate-700">
                <h3 class="text-white font-semibold">ุงูุฅุดุนุงุฑุงุช</h3>
            </div>
            <div id="chatNotificationsList" class="p-2 max-h-80 overflow-y-auto custom-scrollbar">
                <!-- ุฅุดุนุงุฑุงุช ุงูููุดูุฑุงุช ุณุชุธูุฑ ููุง -->
            </div>
        </div>
    </div>
                    <button id="toggleUsersButton" class="md:hidden text-white p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
        </svg>
    </button>
    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
    <span class="text-white text-sm">ูุดุท</span>
</div>
            </div>
        </div>

        <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
        <div class="flex-1 flex overflow-hidden">
            <!-- ููุทูุฉ ุงูุฑุณุงุฆู -->
            <div class="flex-1 flex flex-col overflow-hidden p-4 relative">
                <div id="messagesContainer" class="container mx-auto max-w-4xl space-y-4 messages-container custom-scrollbar">
                    <!-- ุงูุฑุณุงุฆู ุณุชุธูุฑ ููุง -->
                </div>
            </div>

            <!-- ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุงููุชุตููู (ููุดุงุดุงุช ุงููุจูุฑุฉ) -->
            <div id="onlineUsersPanel" class="hidden md:block w-80 bg-white/5 backdrop-blur-lg border-l border-white/10 p-4 users-container custom-scrollbar">
                <h3 class="text-white font-bold mb-4 flex items-center space-x-2 space-x-reverse">
                    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                    <span>ุงููุณุชุฎุฏููู ุงููุชุตููู</span>
                    <span id="onlineUsersCount" class="bg-blue-600 text-white text-xs px-2 py-1 rounded-full">0</span>
                </h3>
        
                <div id="onlineUsersList" class="space-y-3">
                    <!-- ุงููุณุชุฎุฏููู ุงููุชุตููู ุณูุชู ุชุญููููู ุฏููุงููููุงู -->
                </div>
            </div>
            <!-- ุฒุฑ ุฅุฎูุงุก/ุฅุธูุงุฑ ูุงุฆูุฉ ุงููุชุตููู ููุฌูุงู -->
            <div id="usersOverlay" class="users-overlay" onclick="toggleUsersList()"></div>
        </div>

        <!-- ููุทูุฉ ุฅุฑุณุงู ุงูุฑุณุงุฆู -->
        <div id="messageArea" class="bg-white/10 backdrop-blur-lg border-t border-white/20 p-4">
            <div class="container mx-auto max-w-4xl">
                <!-- ููุญุฉ ุฅุฏุงุฑุฉ ุงูุฑุชุจ -->
                <div id="rankManagementPanel" class="hidden mb-4 bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-xl p-4 border border-purple-500/50">
                    <h3 class="text-white font-bold mb-3 flex items-center space-x-2 space-x-reverse">
                        <span>๐</span>
                        <span>ุฅุฏุงุฑุฉ ุงูุฑุชุจ</span>
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-white text-sm font-semibold mb-2">ุงุณู ุงููุณุชุฎุฏู</label>
                            <input
                                type="text"
                                id="rankUserName"
                                placeholder="ุฃุฏุฎู ุงุณู ุงููุณุชุฎุฏู..."
                                class="w-full bg-white/20 border border-purple-300/50 rounded-lg px-4 py-2 text-white placeholder-purple-200 focus:outline-none focus:ring-2 focus:ring-purple-400"
                            >
                        </div>
                        <div>
                            <label class="block text-white text-sm font-semibold mb-2">ุงูุฑุชุจุฉ ุงูุฌุฏูุฏุฉ</label>
                            <select
                                id="rankSelect"
                                class="w-full bg-white/20 border border-purple-300/50 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-400"
                            >
                                <option value="" class="bg-gray-800">ุงุฎุชุฑ ุงูุฑุชุจุฉ...</option>
                                <option value="ุฌูุฏ" class="bg-gray-800">โ๏ธ ุฌูุฏ</option>
                                <option value="ุจุฑููููู" class="bg-gray-800">๐ ุจุฑููููู</option>
                                <option value="ุงุฏูู" class="bg-gray-800">๐ก๏ธ ุงุฏูู</option>
                                <option value="ุณูุจุฑ ุงุฏูู" class="bg-gray-800">โญ ุณูุจุฑ ุงุฏูู</option>
                                <option value="ููุดุฆ" class="bg-gray-800">๐ ููุดุฆ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex space-x-4 space-x-reverse">
                        <button
                            onclick="assignRank()"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                        >
                            <span>ููุญ ุงูุฑุชุจุฉ</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                        <button
                            onclick="removeRank()"
                            class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                        >
                            <span>ุฅุฒุงูุฉ ุงูุฑุชุจุฉ</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                            </svg>
                        </button>
                        <button
                            onclick="showAllRanks()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                        >
                            <span>ุนุฑุถ ุฌููุน ุงูุฑุชุจ</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- ููุญุฉ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู -->
                <div id="userManagementPanel" class="hidden mb-4 bg-gradient-to-r from-red-900/30 to-orange-900/30 rounded-xl p-4 border border-red-500/50">
                    <h3 class="text-white font-bold mb-3 flex items-center space-x-2 space-x-reverse">
                        <span>๐</span>
                        <span id="managementTitle">ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</span>
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-white text-sm font-semibold mb-2">ุงุณู ุงููุณุชุฎุฏู</label>
                            <input
                                type="text"
                                id="managedUserName"
                                placeholder="ุฃุฏุฎู ุงุณู ุงููุณุชุฎุฏู..."
                                class="w-full bg-white/20 border border-red-300/50 rounded-lg px-4 py-2 text-white placeholder-red-200 focus:outline-none focus:ring-2 focus:ring-red-400"
                            >
                        </div>
                        <div>
                            <label class="block text-white text-sm font-semibold mb-2">ุงูุฅุฌุฑุงุก</label>
                            <select
                                id="userActionSelect"
                                class="w-full bg-white/20 border border-red-300/50 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-red-400"
                                onchange="toggleManagementFields()"
                            >
                                <option value="" class="bg-gray-800">ุงุฎุชุฑ ุงูุฅุฌุฑุงุก...</option>
                                <option value="mute" class="bg-gray-800">๐ ูุชู</option>
                                <option value="unmute" class="bg-gray-800">๐ ุฅุฒุงูุฉ ุงููุชู</option>
                                <option value="banFromRoom" class="bg-gray-800">๐ซ ุญุธุฑ ูู ุงูุบุฑูุฉ</option>
                                <option value="unbanFromRoom" class="bg-gray-800">โ ุฅุฒุงูุฉ ุญุธุฑ ุงูุบุฑูุฉ</option>
                                <option value="banFromSite" class="bg-gray-800">โ ุญุธุฑ ูู ุงููููุน</option>
                                <option value="unbanFromSite" class="bg-gray-800">๐ ุฅุฒุงูุฉ ุญุธุฑ ุงููููุน</option>
                                <option value="deleteUser" class="bg-gray-800">๐๏ธ ุญุฐู ุงููุณุชุฎุฏู</option>
                                <option value="showStatus" class="bg-gray-800">๐ ุนุฑุถ ุงูุญุงูุฉ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="durationField" class="hidden mb-4">
                        <label class="block text-white text-sm font-semibold mb-2">ูุฏุฉ ุงููุชู (ุฏูุงุฆู)</label>
                        <input
                            type="number"
                            id="muteDuration"
                            placeholder="ุงููุฏุฉ ุจุงูุฏูุงุฆู..."
                            min="1"
                            class="w-full bg-white/20 border border-red-300/50 rounded-lg px-4 py-2 text-white placeholder-red-200 focus:outline-none focus:ring-2 focus:ring-red-400"
                        >
                    </div>
                    
                    <div id="reasonField" class="hidden mb-4">
                        <label class="block text-white text-sm font-semibold mb-2">ุณุจุจ ุงูุญุธุฑ (ุงุฎุชูุงุฑู)</label>
                        <input
                            type="text"
                            id="banReason"
                            placeholder="ุฃุฏุฎู ุณุจุจ ุงูุญุธุฑ..."
                            class="w-full bg-white/20 border border-red-300/50 rounded-lg px-4 py-2 text-white placeholder-red-200 focus:outline-none focus:ring-2 focus:ring-red-400"
                        >
                    </div>
                    
                    <div class="flex space-x-4 space-x-reverse">
                        <button
                            onclick="manageUser()"
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                        >
                            <span>ุชูููุฐ</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </button>
                        <button
                            onclick="clearManagementFields()"
                            class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                        >
                            <span>ูุณุญ ุงูุญููู</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- ููุทูุฉ ุนุฑุถ ุงูุฑุฏ -->
                <div id="replyPreview" class="hidden mb-2 bg-white/10 rounded-lg p-2 max-w-4xl mx-auto">
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-white overflow-hidden">
                            <div class="font-semibold">ุงูุฑุฏ ุนูู <span id="replyUsername"></span></div>
                            <p id="replyContent" class="truncate opacity-70"></p>
                        </div>
                        <button onclick="cancelReply()" class="text-white hover:text-red-400 p-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- ููุญุฉ ุฅุฏุงุฑุฉ ุงูุตูุฑ ุงูุดุฎุตูุฉ -->
                <div id="avatarManagementPanel" class="hidden mb-4 bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-xl p-4 border border-purple-500/50">
                    <h3 class="text-white font-bold mb-3 flex items-center space-x-2 space-x-reverse">
                        <span>๐ผ๏ธ</span>
                        <span>ุฅุฏุงุฑุฉ ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ</span>
                    </h3>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm font-semibold mb-2">ุงูุตูุฑ ุงูุงูุชุฑุงุถูุฉ</label>
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <!-- ุตูุฑ ุงูุฃููุงุฏ -->
                            <div class="avatar-option" onclick="selectAvatar('boy1')">
                                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=boy1" class="w-full h-16 object-cover rounded-lg cursor-pointer" alt="ุตูุฑุฉ ููุฏ 1">
                            </div>
                            <div class="avatar-option" onclick="selectAvatar('boy2')">
                                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=boy2" class="w-full h-16 object-cover rounded-lg cursor-pointer" alt="ุตูุฑุฉ ููุฏ 2">
                            </div>
                            <div class="avatar-option" onclick="selectAvatar('boy3')">
                                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=boy3" class="w-full h-16 object-cover rounded-lg cursor-pointer" alt="ุตูุฑุฉ ููุฏ 3">
                            </div>
                            <!-- ุตูุฑ ุงูุจูุงุช -->
                            <div class="avatar-option" onclick="selectAvatar('girl1')">
                                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=girl1&hair=long" class="w-full h-16 object-cover rounded-lg cursor-pointer" alt="ุตูุฑุฉ ุจูุช 1">
                            </div>
                            <div class="avatar-option" onclick="selectAvatar('girl2')">
                                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=girl2&hair=long" class="w-full h-16 object-cover rounded-lg cursor-pointer" alt="ุตูุฑุฉ ุจูุช 2">
                            </div>
                            <div class="avatar-option" onclick="selectAvatar('girl3')">
                                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=girl3&hair=long" class="w-full h-16 object-cover rounded-lg cursor-pointer" alt="ุตูุฑุฉ ุจูุช 3">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-white text-sm font-semibold mb-2">ุฑูุน ุตูุฑุฉ ุดุฎุตูุฉ</label>
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <input
                                type="file"
                                id="avatarUpload"
                                accept="image/*"
                                class="hidden"
                                onchange="handleAvatarUpload()"
                            >
                            <label for="avatarUpload" class="flex-1 bg-white/20 border border-purple-300/50 rounded-lg px-4 py-2 text-white text-center cursor-pointer hover:bg-white/30">
                                ุงุฎุชุฑ ุตูุฑุฉ
                            </label>
                            <button
                                onclick="resetAvatar()"
                                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"
                            >
                                ุฅุนุงุฏุฉ ุชุนููู
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <div class="inline-block bg-white/20 p-2 rounded-lg mb-2">
                            <img id="currentAvatarPreview" src="https://api.dicebear.com/7.x/avataaars/svg?seed=guest" class="w-16 h-16 rounded-full object-cover" alt="ุงูุตูุฑุฉ ุงูุญุงููุฉ">
                        </div>
                        <p class="text-xs text-purple-200">ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ ุงูุญุงููุฉ</p>
                    </div>
                </div>
               
                <div id="messageInputContainer" class="flex space-x-4 space-x-reverse">
                    <input
                    type="text"
                    id="messageInput"
                    placeholder="ุงูุชุจ ุฑุณุงูุชู ููุง..."
                    class="flex-1 bg-white/20 border border-white/30 rounded-full px-6 py-3 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    onkeypress="handleKeyPress(event)"
                    style="text-align: start; direction: rtl; padding-left: 20px; position: relative; z-index: 10;"
                >                      
                    <button
                        onclick="sendMessage()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full font-semibold transition-colors flex items-center space-x-2 space-x-reverse"
                    >
                        <span>ุฅุฑุณุงู</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ูุงูุฐุฉ ุงูููู ุงูุดุฎุตู -->
    <div id="profileModal" class="profile-modal">
        <div class="profile-content custom-scrollbar">
            <!-- ุฑุฃุณ ุงูููู ุงูุดุฎุตู -->
            <div class="relative bg-white/5 p-6 text-center">
                 <button onclick="closeProfileModal()" class="absolute top-4 right-4 text-white hover:text-blue-200 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <!-- ูุงุฆูุฉ ุงูุฎูุงุฑุงุช ุงูุฅุฏุงุฑูุฉ -->
                <div id="profileMenuContainer" class="absolute top-4 left-4">
                    <!-- ุณูุชู ููุก ูุฐู ุงููุงุฆูุฉ ุฏููุงููููุงู -->
                </div>

                <img id="profileAvatar" src="" class="w-24 h-24 rounded-full mx-auto mb-4 object-cover border-4 border-blue-500/50 shadow-lg">
                <h2 id="profileUsername" class="text-2xl font-bold text-white"></h2>
                <div id="profileRank" class="inline-block mt-2 px-3 py-1 rounded-full text-sm font-semibold text-white"></div>
                <div id="profileStatus" class="mt-2 flex items-center justify-center space-x-2 space-x-reverse">
                    <span class="w-2.5 h-2.5 rounded-full"></span>
                    <span class="text-sm text-blue-200"></span>
                </div>
            </div>

            <!-- ูุญุชูู ุงูููู ุงูุดุฎุตู ุงููุงุจู ููุชูุฑูุฑ -->
            <div class="flex-1 p-6 space-y-6 overflow-y-auto custom-scrollbar">
                <!-- ุงูููุงุท ูุงููุณุชูู -->
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-white/5 rounded-lg p-3">
                        <div class="text-yellow-400 text-2xl">โญ</div>
                        <div class="text-white font-semibold" id="profilePoints">0</div>
                        <div class="text-blue-200 text-xs">ุงูููุงุท</div>
                    </div>
                    <div class="bg-white/5 rounded-lg p-3">
                        <div class="text-green-400 text-2xl">๐</div>
                        <div class="text-white font-semibold" id="profileLevel">1</div>
                        <div class="text-blue-200 text-xs">ุงููุณุชูู</div>
                    </div>
                </div>

                <!-- ูุณู ูุฎุฒูู ุงูุนูุงุตุฑ -->
                <div id="inventorySection" class="hidden">
                    <h3 class="text-lg font-semibold text-white mb-2 border-b border-white/20 pb-2">ูุฎุฒููู</h3>
                    <div id="inventoryItems" class="space-y-2">
                        <!-- ุนูุงุตุฑ ุงููุฎุฒูู ุณุชุธูุฑ ููุง -->
                    </div>
                </div>

                <!-- ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช -->
                <div class="space-y-3">
                    <button id="privateChatButton" onclick="startPrivateChat()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-semibold transition-colors flex items-center justify-center space-x-2 space-x-reverse">
                        <span>ูุญุงุฏุซุฉ ุฎุงุตุฉ</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                    </button>
                    
                    <button id="addFriendButton" onclick="sendFriendRequest()" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-lg font-semibold transition-colors flex items-center justify-center space-x-2 space-x-reverse">
                        <span>ุฅุถุงูุฉ ุตุฏูู</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                    </button>

                    <button id="sendPointsButton" onclick="sendPoints()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-6 py-2.5 rounded-lg font-semibold transition-colors flex items-center justify-center space-x-2 space-x-reverse">
                        <span>ุฅุฑุณุงู ููุงุท</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-1V4m0 2v1m0 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    </button>
                </div>

                <!-- ูุณู ูุนูููุงุชู (ุชู ูููู ููุฃุณูู) -->
                <div class="text-center" id="bioSection">
                    <h3 class="text-lg font-semibold text-white mb-2 border-b border-white/20 pb-2">ูุนูููุงุชู</h3>
                    <div id="bioContainer" class="relative text-blue-200 text-sm bg-white/10 rounded-lg p-3 min-h-[80px] whitespace-pre-wrap">
                        <p id="profileBio" class="text-center"></p>
                        <textarea id="profileBioInput" class="hidden w-full bg-white/20 border border-white/30 rounded-lg px-4 py-2 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400" rows="4" placeholder="ุงูุชุจ ุดูุฆุงู ุนู ููุณู..." oninput="updateBioCharCount()"></textarea>
                        <div id="bioCharCounter" class="hidden absolute bottom-2 left-3 text-xs text-gray-400">0 / 500</div>
                    </div>
                    <div id="editBioButtons" class="mt-3 space-x-2 space-x-reverse">
                        <button id="editBioButton" onclick="toggleBioEdit(true)" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-full text-sm font-semibold transition-colors">
                            ุชุนุฏูู
                        </button>
                        <button id="saveBioButton" onclick="saveBio()" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded-full text-sm font-semibold transition-colors">
                            ุญูุธ
                        </button>
                        <button id="cancelBioButton" onclick="toggleBioEdit(false)" class="hidden bg-gray-600 hover:bg-gray-700 text-white px-4 py-1 rounded-full text-sm font-semibold transition-colors">
                            ุฅูุบุงุก
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ูุงูุฐุฉ ุงููุญุงุฏุซุฉ ุงูุฎุงุตุฉ -->
    <div id="privateChatModal" class="private-chat-modal">
        <div class="private-chat-header">
            <div class="flex items-center space-x-3 space-x-reverse">
                <img id="privateChatAvatar" src="" class="w-8 h-8 rounded-full object-cover" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=guest'">
                <div>
                    <h3 id="privateChatUsername" class="text-white font-semibold"></h3>
                    <p id="privateChatStatus" class="text-xs text-blue-200 flex items-center space-x-1 space-x-reverse">
                        <span class="w-2 h-2 rounded-full"></span>
                        <span></span>
                    </p>
                </div>
            </div>
            <button onclick="closePrivateChat()" class="text-white hover:text-blue-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div id="privateChatMessages" class="private-chat-messages custom-scrollbar">
            <!-- ุงูุฑุณุงุฆู ุงูุฎุงุตุฉ ุณุชุธูุฑ ููุง -->
        </div>
        
        <div class="private-chat-input">
            <div class="flex space-x-3 space-x-reverse">
                <input
                    type="text"
                    id="privateMessageInput"
                    placeholder="ุงูุชุจ ุฑุณุงูุชู ููุง..."
                    class="flex-1 bg-white/20 border border-white/30 rounded-full px-4 py-2 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent text-sm"
                    onkeypress="handlePrivateKeyPress(event)"
                >
                <button
                    onclick="sendPrivateMessage()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full font-semibold transition-colors flex items-center space-x-2 space-x-reverse text-sm"
                >
                    <span>ุฅุฑุณุงู</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- ูุงุฆูุฉ ุงูุฃุตุฏูุงุก -->
    <div id="friendsSidebar" class="friends-sidebar">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-white">๐ฅ ูุงุฆูุฉ ุงูุฃุตุฏูุงุก</h2>
            <button onclick="closeFriendsSidebar()" class="text-white hover:text-blue-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- ุจุญุซ ุนู ูุณุชุฎุฏููู -->
        <div class="mb-6">
            <div class="relative">
                <input
                    type="text"
                    id="userSearchInput"
                    placeholder="ุงุจุญุซ ุนู ูุณุชุฎุฏููู..."
                    class="w-full bg-white/20 border border-white/30 rounded-full px-4 py-2 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent text-sm"
                >
                <button onclick="searchUsers()" class="absolute left-2 top-1/2 transform -translate-y-1/2 text-blue-200 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
            </div>
            <div id="searchResults" class="mt-3 hidden bg-white/10 rounded-lg p-3 max-h-40 overflow-y-auto">
                <!-- ูุชุงุฆุฌ ุงูุจุญุซ ุณุชุธูุฑ ููุง -->
            </div>
        </div>
        
        <!-- ุทูุจุงุช ุงูุตุฏุงูุฉ -->
        <div class="mb-6">
            <h3 class="text-white font-semibold mb-3 flex items-center space-x-2 space-x-reverse">
                <span>๐ฉ</span>
                <span>ุทูุจุงุช ุงูุตุฏุงูุฉ</span>
                <span id="friendRequestsCount" class="bg-blue-600 text-white text-xs px-2 py-1 rounded-full">0</span>
            </h3>
            <div id="friendRequestsList" class="space-y-2">
                <!-- ุทูุจุงุช ุงูุตุฏุงูุฉ ุณุชุธูุฑ ููุง -->
            </div>
        </div>
        
        <!-- ูุงุฆูุฉ ุงูุฃุตุฏูุงุก -->
        <div>
            <h3 class="text-white font-semibold mb-3 flex items-center space-x-2 space-x-reverse">
                <span>๐ฅ</span>
                <span>ุฃุตุฏูุงุฆู</span>
                <span id="friendsCount" class="bg-green-600 text-white text-xs px-2 py-1 rounded-full">0</span>
            </h3>
            <div id="friendsList" class="space-y-2">
                <!-- ูุงุฆูุฉ ุงูุฃุตุฏูุงุก ุณุชุธูุฑ ููุง -->
            </div>
        </div>
    </div>
    
    <div id="friendsOverlay" class="friends-overlay" onclick="closeFriendsSidebar()"></div>

    <!-- ููุทูุฉ ุงูุฅุดุนุงุฑุงุช ุงูุนุงูุฉ -->
    <div id="globalNotifications" class="fixed top-4 right-4 z-50 space-y-3 max-w-sm"></div>
<!-- ูุงูุฐุฉ ุงูููุดูุฑุงุช -->
<div id="postsSidebar" class="friends-sidebar">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-white">๐ ุงูููุดูุฑุงุช</h2>
        <button onclick="closePostsSidebar()" class="text-white hover:text-blue-200">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
    
    <!-- ููุทูุฉ ุฅูุดุงุก ููุดูุฑ ุฌุฏูุฏ -->
    <div class="mb-6 bg-white/10 rounded-xl p-4">
        <h3 class="text-white font-semibold mb-3">ุฅูุดุงุก ููุดูุฑ ุฌุฏูุฏ</h3>
        <textarea 
            id="newPostContent" 
            placeholder="ูุงุฐุง ุชุฑูุฏ ุฃู ุชูุดุฑุ" 
            class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-2 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm mb-3"
            rows="3"
        ></textarea>
        <button 
            onclick="createNewPost()" 
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors"
        >
            ูุดุฑ
        </button>
    </div>
    
    <!-- ูุงุฆูุฉ ุงูููุดูุฑุงุช -->
    <div id="postsList" class="space-y-4">
        <!-- ุงูููุดูุฑุงุช ุณูุชู ุชุญููููุง ููุง -->
    </div>
</div>

<div id="postsOverlay" class="friends-overlay" onclick="closePostsSidebar()"></div>

<!-- ูุงูุฐุฉ ูุงุฆูุฉ ุงููุชูุงุนููู -->
<div id="topUsersModal" class="profile-modal">
    <div class="profile-content custom-scrollbar">
        <!-- ุฑุฃุณ ุงููุงูุฐุฉ -->
        <div class="relative bg-white/5 p-6 text-center">
             <button onclick="closeTopUsersModal()" class="absolute top-4 right-4 text-white hover:text-blue-200 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">๐ ุงููุชูุงุนููู</h2>
            <p class="text-blue-200 text-sm">ุฃูุซุฑ 10 ูุณุชุฎุฏููู ูุดุงุทุงู</p>
        </div>

        <!-- ูุญุชูู ุงููุงุฆูุฉ -->
        <div id="topUsersListContainer" class="flex-1 p-4 space-y-3 overflow-y-auto custom-scrollbar">
            <!-- ุณูุชู ููุก ุงููุงุฆูุฉ ููุง -->
            <div class="text-center text-blue-200 p-8">
                <div class="spinner mx-auto"></div>
                <p class="mt-2">ุฌุงุฑู ุชุญููู ุงููุงุฆูุฉ...</p>
            </div>
        </div>
    </div>
</div>

<div id="topUsersOverlay" class="friends-overlay" onclick="closeTopUsersModal()"></div>

<!-- ูุงูุฐุฉ ุงููุชุฌุฑ -->
<div id="shopModal" class="profile-modal">
    <div class="profile-content custom-scrollbar" style="max-width: 500px;">
        <!-- ุฑุฃุณ ุงููุงูุฐุฉ -->
        <div class="relative bg-white/5 p-6 text-center">
             <button onclick="closeShopModal()" class="absolute top-4 right-4 text-white hover:text-blue-200 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">๐ ุงููุชุฌุฑ</h2>
            <p class="text-blue-200 text-sm">ุงุณุชุฎุฏู ููุงุทู ูุดุฑุงุก ุนูุงุตุฑ ูููุฒุฉ</p>
        </div>

        <!-- ูุญุชูู ุงููุชุฌุฑ -->
        <div id="shopItemsContainer" class="flex-1 p-4 space-y-3 overflow-y-auto custom-scrollbar">
            <!-- ุณูุชู ููุก ุงูุนูุงุตุฑ ููุง -->
            <div class="text-center text-blue-200 p-8">
                <div class="spinner mx-auto"></div>
                <p class="mt-2">ุฌุงุฑู ุชุญููู ุนูุงุตุฑ ุงููุชุฌุฑ...</p>
            </div>
        </div>
    </div>
</div>
<div id="shopOverlay" class="friends-overlay" onclick="closeShopModal()"></div>

<style>
    #shopModal.show {
        opacity: 1;
        visibility: visible;
    }
    #shopModal.show .profile-content {
        transform: scale(1);
    }
    #shopOverlay.show {
        display: block;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
    }
</style>

<!-- ูุงูุฐุฉ ุฅุฑุณุงู ุงูููุงุท -->
<div id="sendPointsModal" class="profile-modal">
    <div class="profile-content" style="max-width: 350px;">
        <!-- ุฑุฃุณ ุงููุงูุฐุฉ -->
        <div class="relative bg-white/5 p-6 text-center">
             <button onclick="closeSendPointsModal()" class="absolute top-4 right-4 text-white hover:text-blue-200 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white">๐ ุฅุฑุณุงู ููุงุท</h2>
            <p id="sendPointsToUser" class="text-blue-200 text-sm"></p>
        </div>

        <!-- ูุญุชูู ุงููุงูุฐุฉ -->
        <div class="flex-1 p-6 space-y-4">
            <div>
                <label for="pointsAmountInput" class="block text-white text-sm font-semibold mb-2">ุนุฏุฏ ุงูููุงุท</label>
                <input
                    type="number"
                    id="pointsAmountInput"
                    placeholder="ุฃุฏุฎู ุนุฏุฏ ุงูููุงุท..."
                    min="1"
                    class="w-full bg-white/20 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400"
                >
            </div>
            <button
                onclick="submitSendPoints()"
                class="w-full bg-purple-600 hover:bg-purple-700 text-white px-6 py-2.5 rounded-lg font-semibold transition-colors flex items-center justify-center space-x-2 space-x-reverse"
            >
                <span>ุฅุฑุณุงู</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-1V4m0 2v1m0 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            </button>
        </div>
    </div>
</div>

<style>
    #topUsersModal.show {
        opacity: 1;
        visibility: visible;
    }
    #topUsersModal.show .profile-content {
        transform: scale(1);
    }
    #topUsersOverlay.show {
        display: block;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
    }
</style>

<!-- ูุจู ููุงูุฉ body -->
<!-- ูุงูุฐุฉ ุชุบููุฑ ุฎูููุฉ ุงููููุน -->
<div id="backgroundModal" class="profile-modal">
    <div class="profile-content">
        <div class="text-center mb-6">
            <button onclick="closeBackgroundModal()" class="absolute top-4 left-4 text-white hover:text-blue-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-white mb-4">๐จ ุชุบููุฑ ุฎูููุฉ ุงููููุน</h2>
            <p class="text-blue-200 text-sm">ุณูุชู ุชุทุจูู ุงูุชุบููุฑ ุนูู ุฌููุน ุงููุณุชุฎุฏููู</p>
        </div>
        
        <div class="space-y-4">
            <!-- ุฎูุงุฑุงุช ุงูุชุฏุฑุฌุงุช ุงูููููุฉ -->
            <div>
                <h3 class="text-white font-semibold mb-3">ุชุฏุฑุฌุงุช ููููุฉ</h3>
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-option" onclick="selectBackground('gradient', 'from-purple-900 via-blue-900 to-indigo-900')">
                        <div class="w-full h-16 rounded-lg bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 border-2 border-transparent"></div>
                        <p class="text-white text-xs mt-1">ุงูุชุฑุงุถู</p>
                    </div>
                    <div class="bg-option" onclick="selectBackground('gradient', 'from-green-900 via-blue-900 to-purple-900')">
                        <div class="w-full h-16 rounded-lg bg-gradient-to-br from-green-900 via-blue-900 to-purple-900 border-2 border-transparent"></div>
                        <p class="text-white text-xs mt-1">ุฃุฎุถุฑ-ุฃุฒุฑู</p>
                    </div>
                    <div class="bg-option" onclick="selectBackground('gradient', 'from-pink-900 via-red-900 to-orange-900')">
                        <div class="w-full h-16 rounded-lg bg-gradient-to-br from-pink-900 via-red-900 to-orange-900 border-2 border-transparent"></div>
                        <p class="text-white text-xs mt-1">ูุฑุฏู-ุจุฑุชูุงูู</p>
                    </div>
                    <div class="bg-option" onclick="selectBackground('gradient', 'from-teal-900 via-cyan-900 to-blue-900')">
                        <div class="w-full h-16 rounded-lg bg-gradient-to-br from-teal-900 via-cyan-900 to-blue-900 border-2 border-transparent"></div>
                        <p class="text-white text-xs mt-1">ุชุฑููุงุฒ-ุฃุฒุฑู</p>
                    </div>
                    <div class="bg-option" onclick="selectBackground('gradient', 'from-yellow-900 via-orange-900 to-red-900')">
                        <div class="w-full h-16 rounded-lg bg-gradient-to-br from-yellow-900 via-orange-900 to-red-900 border-2 border-transparent"></div>
                        <p class="text-white text-xs mt-1">ุฃุตูุฑ-ุฃุญูุฑ</p>
                    </div>
                    <div class="bg-option" onclick="selectBackground('gradient', 'from-indigo-900 via-purple-900 to-pink-900')">
                        <div class="w-full h-16 rounded-lg bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 border-2 border-transparent"></div>
                        <p class="text-white text-xs mt-1">ุจููุณุฌู-ูุฑุฏู</p>
                    </div>
                </div>
            </div>
            
            <!-- ุฑูุน ุตูุฑุฉ ุฎูููุฉ ูุฎุตุตุฉ -->
            <div>
                <h3 class="text-white font-semibold mb-3">ุตูุฑุฉ ูุฎุตุตุฉ</h3>
                <div class="flex items-center space-x-3 space-x-reverse">
                    <input
                        type="file"
                        id="backgroundUpload"
                        accept="image/*"
                        class="hidden"
                        onchange="handleBackgroundUpload()"
                    >
                    <label for="backgroundUpload" class="flex-1 bg-white/20 border border-white/30 rounded-lg px-4 py-2 text-white text-center cursor-pointer hover:bg-white/30">
                        ุงุฎุชุฑ ุตูุฑุฉ
                    </label>
                </div>
            </div>
            
            <!-- ุฑุงุจุท ุตูุฑุฉ ุฎุงุฑุฌูุฉ -->
            <div>
                <h3 class="text-white font-semibold mb-3">ุฑุงุจุท ุตูุฑุฉ</h3>
                <div class="flex space-x-3 space-x-reverse">
                    <input
                        type="text"
                        id="backgroundUrl"
                        placeholder="ุฃุฏุฎู ุฑุงุจุท ุงูุตูุฑุฉ..."
                        class="flex-1 bg-white/20 border border-white/30 rounded-lg px-4 py-2 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    >
                    <button
                        onclick="applyUrlBackground()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"
                    >
                        ุชุทุจูู
                    </button>
                </div>
            </div>
        </div>
        
        <div class="mt-6 text-center">
            <button
                onclick="saveBackground()"
                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-full font-semibold transition-colors"
            >
                ุญูุธ ุงูุฎูููุฉ
            </button>
        </div>
    </div>
</div>



<!-- ุนูุงุตุฑ ุฅุฏุฎุงู ุงูููู ุงููุฎููุฉ -->
<input type="file" id="imageUpload" accept="image/*" class="hidden">
<input type="file" id="privateImageUpload" accept="image/*" class="hidden">



    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentUser = null;
        let currentRoom = null;
        let rooms = [];
        let sessionChecked = false;
        let privateChatTarget = null;
        let friendRequests = [];
        let privateConversations = {};
        let friendsList = [];
        let userAvatars = {};
        let shopItems = [];

        // --- ุฏูุงู ูุงูุฐุฉ ุฅุฑุณุงู ุงูููุงุท (ุชู ููููุง ุฅูู ุงููุทุงู ุงูุนุงู) ---

        function openSendPointsModal(username) {
            const modal = document.getElementById('sendPointsModal');
            const title = document.getElementById('sendPointsToUser');
            const input = document.getElementById('pointsAmountInput');

            title.textContent = `ุฅูู ุงููุณุชุฎุฏู: ${username}`;
            modal.dataset.username = username;
            input.value = '';
            modal.classList.add('show');
        }

        function closeSendPointsModal() {
            document.getElementById('sendPointsModal').classList.remove('show');
        }

        // --- ุฏูุงู ูุงูุฐุฉ ุงููุชุฌุฑ ---
        function openShopModal() {
            const modal = document.getElementById('shopModal');
            const overlay = document.getElementById('shopOverlay');
            modal.classList.add('show');
            overlay.classList.add('show');
            
            // ุทูุจ ุจูุงูุงุช ุงููุชุฌุฑ ูู ุงูุณูุฑูุฑ
            socket.emit('get shop items');
        }

        function closeShopModal() {
            const modal = document.getElementById('shopModal');
            const overlay = document.getElementById('shopOverlay');
            modal.classList.remove('show');
            overlay.classList.remove('show');
        }

        // --- ุฏูุงู ุฅุฑุณุงู ุงูููุงุท (ุชู ููููุง ุฅูู ุงููุทุงู ุงูุนุงู) ---
        function sendPoints() {
            const toUser = document.getElementById('profileUsername').textContent;
            if (!toUser || toUser === currentUser.name) {
                showNotification('ูุง ููููู ุฅุฑุณุงู ููุงุท ูููุณู.', 'error');
                return;
            }
            openSendPointsModal(toUser);
        }

        function submitSendPoints() {
            const modal = document.getElementById('sendPointsModal');
            const toUser = modal.dataset.username;
            const amountInput = document.getElementById('pointsAmountInput');
            const amount = parseInt(amountInput.value, 10);

            if (isNaN(amount) || amount <= 0) {
                showNotification('ูุฑุฌู ุฅุฏุฎุงู ุนุฏุฏ ููุงุท ุตุญูุญ ูุฃูุจุฑ ูู ุตูุฑ.', 'error');
                return;
            }

            socket.emit('send points', { fromUser: currentUser.name, toUser: toUser, amount: amount });
            closeSendPointsModal();
        }

// ุงุณุชูุจุงู ุจูุงูุงุช ุงูุตูุฑ ูู ุงูุณูุฑูุฑ
    socket.on('user avatars data', (avatarsData) => {
        userAvatars = { ...userAvatars, ...avatarsData };
        updateFriendsList();
        updateOnlineUsersAvatars();
    });
     // ุทูุจ ุจูุงูุงุช ุงูุตูุฑ ุนูุฏ ุงูุงุชุตุงู
    socket.on('connect', () => {
        console.log('Socket connected:', socket.id);
        socket.emit('get user avatars');
        // ุฅุฐุง ูู ูุชู ุงูุชุญูู ูู ุงูุฌูุณุฉ ุจุนุฏุ ุงุทูุจ ุงูุชุญูู ูุฑุฉ ุฃุฎุฑู
        const savedSession = localStorage.getItem('userSession');
        if (savedSession) {
            try {
                const sessionData = JSON.parse(savedSession);
                if (sessionData && sessionData.sessionId) {
                    socket.emit('check session', sessionData.sessionId);
                }
            } catch (e) { /* ignore */ }
        }
        // ุชุฃููุฏ ุฃู ุงูุฌูุณุฉ ูุฏ ุชูุช ูุนุงูุฌุชูุง ุฎูุงู ุงูุงุชุตุงู
        if (!sessionChecked) {
            // ุถุน ุนูุงูุฉ ูููุชููุฉ ุจุนุฏ 3 ุซูุงูู ูู ุงูุงุชุตุงู ุฅุฐุง ูู ูุฃุช ุฑุฏ
            setTimeout(() => {
                if (!sessionChecked) {
                    console.warn('ูู ูุตู ุฑุฏ ุงูุชุญูู ูู ุงูุฌูุณุฉ ุจุนุฏ ุงูุงุชุตุงู. ุฅุฎูุงุก ุดุงุดุฉ ุงูุชุญููู ูุญุงูุฉ ุงูุชุฑุงุถูุฉ.');
                    sessionChecked = true;
                    hideLoading();
                }
            }, 3000);
        }
    });

    socket.on('connect_error', (err) => {
        console.error('ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูู socket:', err);
        sessionChecked = true;
        hideLoading();
        showNotification('ุชุนุฐุฑ ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ. ุชุญูู ูู ุงูุดุจูุฉ ูุญุงูู ูุฑุฉ ุฃุฎุฑู.', 'error');
    });

    socket.on('disconnect', (reason) => {
        console.warn('ุชู ูุทุน ุงูุงุชุตุงู:', reason);
        if (currentRoom) {
            if (reason === 'io server disconnect') {
                showNotification('ุชู ูุทุน ุงุชุตุงูู ูู ูุจู ุงูุฎุงุฏู.', 'error');
            }
            goBack(true); // ุงูุนูุฏุฉ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ ูุน ุฅุธูุงุฑ ุฑุณุงูุฉ ุงูุฎููู
        }
    });
        // ุชุชุจุน ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ
let unreadPrivateMessages = {};

// ุชุญุฏูุซ ุงูุฅุดุนุงุฑุงุช
function updateUnreadBadges() {
    // ุชุญุฏูุซ ุงูุฅุดุนุงุฑุงุช ูู ูุงุฆูุฉ ุงูุฃุตุฏูุงุก
    const friendElements = document.querySelectorAll('#friendsList .friend-item');
    friendElements.forEach(element => {
        const usernameElement = element.querySelector('.text-white.font-medium');
        if (usernameElement) {
            const username = usernameElement.textContent;
            const unreadCount = unreadPrivateMessages[username] || 0;
            
            // ุฅุฒุงูุฉ ุงูุฅุดุนุงุฑุงุช ุงููุฏููุฉ ุฅู ูุฌุฏุช
            const existingBadge = element.querySelector('.unread-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // ุฅุถุงูุฉ ุฅุดุนุงุฑ ุฌุฏูุฏ ุฅุฐุง ูุงู ููุงู ุฑุณุงุฆู ุบูุฑ ููุฑูุกุฉ
            if (unreadCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'unread-badge absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white rounded-full text-xs h-5 w-5 flex items-center justify-center';
                badge.textContent = unreadCount;
                
                const avatarContainer = element.querySelector('.relative');
                if (avatarContainer) {
                    avatarContainer.appendChild(badge);
                }
                
                // ุชุญุฏูุซ ุงูุฅุดุนุงุฑ ูู ุฒุฑ ูุญุต ุงูููู ุงูุดุฎุตู
                const profileButton = element.querySelector('button[onclick^="showUserProfileModal"]');
                if (profileButton) {
                    let profileBadge = profileButton.querySelector('.unread-badge');
                    if (!profileBadge) {
                        profileBadge = document.createElement('span');
                        profileBadge.className = 'unread-badge absolute -top-1 -right-1 bg-red-500 text-white rounded-full text-xs h-4 w-4 flex items-center justify-center';
                        profileButton.style.position = 'relative';
                        profileButton.appendChild(profileBadge);
                    }
                    profileBadge.textContent = unreadCount;
                    profileBadge.classList.remove('hidden');
                }
            } else {
                // ุฅุฎูุงุก ุงูุฅุดุนุงุฑ ุฅุฐุง ูู ุชูุฌุฏ ุฑุณุงุฆู ุบูุฑ ููุฑูุกุฉ
                const profileButton = element.querySelector('button[onclick^="showUserProfileModal"]');
                if (profileButton) {
                    const profileBadge = profileButton.querySelector('.unread-badge');
                    if (profileBadge) {
                        profileBadge.classList.add('hidden');
                    }
                }
            }
        }
    });
    
    // ุชุญุฏูุซ ุงูุฅุดุนุงุฑุงุช ูู ุฒุฑ ุงููุญุงุฏุซุฉ ูู ุงูููู ุงูุดุฎุตู
    const privateChatButton = document.getElementById('privateChatButton');
    if (privateChatButton) {
        const username = privateChatButton.getAttribute('data-username');
        if (username) {
            const unreadCount = unreadPrivateMessages[username] || 0;
            
            // ุฅุฒุงูุฉ ุงูุฅุดุนุงุฑุงุช ุงููุฏููุฉ ุฅู ูุฌุฏุช
            const existingBadge = privateChatButton.querySelector('.unread-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            // ุฅุถุงูุฉ ุฅุดุนุงุฑ ุฌุฏูุฏ ุฅุฐุง ูุงู ููุงู ุฑุณุงุฆู ุบูุฑ ููุฑูุกุฉ
            if (unreadCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'unread-badge absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white rounded-full text-xs h-5 w-5 flex items-center justify-center';
                badge.textContent = unreadCount;
                privateChatButton.style.position = 'relative';
                privateChatButton.appendChild(badge);
            }
        }
    }
    
    // ุชุญุฏูุซ ุงูุฅุดุนุงุฑุงุช ูู ุฒุฑ ุงูุฑุณุงุฆู ุงูุฑุฆูุณู
    updateMessagesBadge();
}
        // ูุธุงู ุงูุฑุชุจ
        const ranks = {
            'ุตุงุญุจ ุงููููุน': { color: 'from-red-600 to-orange-400', icon: '๐', level: 6 },
            'ุฑุฆูุณ': { color: 'from-yellow-400 to-yellow-500', icon: '๐ฉ', level: 5 },
            'ุฑุฆูุณุฉ': { color: 'from-yellow-400 to-yellow-500', icon: '๐ฉ', level: 5 },
            'ููุดุฆ': { color: 'from-yellow-400 to-orange-500', icon: '๐', level: 4 },
            'ุณูุจุฑ ุงุฏูู': { color: 'from-red-500 to-pink-600', icon: 'โญ', level: 3 },
            'ุงุฏูู': { color: 'from-purple-500 to-indigo-600', icon: '๐ก๏ธ', level: 2 },
            'ุจุฑููููู': { color: 'from-green-500 to-emerald-600', icon: '๐', level: 2 },
            'ุฌูุฏ': { color: 'from-blue-500 to-cyan-600', icon: 'โ๏ธ', level: 1 }
        };

        // ุตูุฑ ุงูุชุฑุงุถูุฉ
        const defaultAvatars = {
            'boy1': 'https://api.dicebear.com/7.x/avataaars/svg?seed=boy1',
            'boy2': 'https://api.dicebear.com/7.x/avataaars/svg?seed=boy2',
            'boy3': 'https://api.dicebear.com/7.x/avataaars/svg?seed=boy3',
            'girl1': 'https://api.dicebear.com/7.x/avataaars/svg?seed=girl1&hair=long',
            'girl2': 'https://api.dicebear.com/7.x/avataaars/svg?seed=girl2&hair=long',
            'girl3': 'https://api.dicebear.com/7.x/avataaars/svg?seed=girl3&hair=long',
            'guest': 'https://api.dicebear.com/7.x/avataaars/svg?seed=guest'
        };

        // ุนูุงุตุฑ ูุงุฌูุฉ ุงููุณุชุฎุฏู
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const toggleUsersButton = document.getElementById('toggleUsersButton');
        const onlineUsersPanel = document.getElementById('onlineUsersPanel');
        const usersOverlay = document.getElementById('usersOverlay');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const profileButton = document.getElementById('profileButton');
        const messagesButton = document.getElementById('messagesButton');
        const friendsButton = document.getElementById('friendsButton');

        // ุชุญููู ุจูู ููุงุฐุฌ ุงูุชุณุฌูู ูุงูุฏุฎูู
        loginTab.addEventListener('click', () => {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            loginTab.classList.add('bg-blue-600', 'text-white');
            loginTab.classList.remove('text-blue-200');
            registerTab.classList.add('text-blue-200');
            registerTab.classList.remove('bg-blue-600', 'text-white');
        });

        registerTab.addEventListener('click', () => {
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            registerTab.classList.add('bg-blue-600', 'text-white');
            registerTab.classList.remove('text-blue-200');
            loginTab.classList.add('text-blue-200');
            loginTab.classList.remove('bg-blue-600', 'text-white');
        });

        // ุฃุญุฏุงุซ ุงูุฃุฒุฑุงุฑ ุงูุฌุฏูุฏุฉ
        profileButton.addEventListener('click', () => {
            showUserProfileModal(currentUser.name);
        });

        messagesButton.addEventListener('click', () => {
            // ุงูุชุญ ูุงูุฐุฉ ุงููุญุงุฏุซุงุช ุงูุฎุงุตุฉ ุฃู ูุงุฆูุฉ ุงูุฑุณุงุฆู
            openFriendsSidebar();
        });

        friendsButton.addEventListener('click', () => {
            openFriendsSidebar();
        });

        // ุฅุธูุงุฑ ูุฅุฎูุงุก ุณุจููุฑ ุงูุชุญููู
        function showLoading() {
            loadingSpinner.classList.remove('hidden');
        }

        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }

        // ุงูุชุญูู ูู ุงูุฌูุณุฉ ุงููุญููุธุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        window.addEventListener('DOMContentLoaded', async () => {
            showLoading();
            try {
                const response = await fetch('/check-auth');
                const data = await response.json();

                if (data.authenticated) {
                    handleSessionValid(data.user);
                } else {
                    handleSessionInvalid();
                }
            } catch (error) {
                console.error('ูุดู ุงูุชุญูู ูู ุงููุตุงุฏูุฉ:', error);
                handleSessionInvalid();
            }
        });


        // ุงุณุชูุจุงู ูุชุงุฆุฌ ุงูุชุญูู ูู ุงูุฌูุณุฉ
        function handleSessionValid(userData) {
            currentUser = userData;
            updateHeaderUserInfo();
            showNotification(`ูุฑุญุจุงู ุจุนูุฏุชู ${userData.name}! ๐`, 'success');
            showMainPage();
            
            // ุชุญููู ุทูุจุงุช ุงูุตุฏุงูุฉ ููุงุฆูุฉ ุงูุฃุตุฏูุงุก
            socket.emit('get friend requests', currentUser.name);
            socket.emit('get friends list', currentUser.name);
            // ุทูุจ ุนุฏุฏ ุงูุฑุณุงุฆู ูุงูุฅุดุนุงุฑุงุช ุบูุฑ ุงูููุฑูุกุฉ ุนูุฏ ุงูุชุญูู ูู ุงูุฌูุณุฉ
            socket.emit('get unread counts', currentUser.name);


            // --- ุชุนุฏูู: ุชุฃุฎูุฑ ุงูุชุญูู ูู ุงูุบุฑูุฉ ุงููุญููุธุฉ ูุถูุงู ุชุญููู ุงูุจูุงูุงุช ---
            setTimeout(() => {
                // ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู (ูุซู ุฅุธูุงุฑ ุฒุฑ ุชุบููุฑ ุงูุฎูููุฉ)
                toggleBackgroundButton();
                
                // ุงูุงูุถูุงู ุฅูู ุงูุบุฑูุฉ ุงููุญููุธุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
                const savedRoom = localStorage.getItem('currentRoom');
                if (savedRoom) {
                    try {
                        const roomData = JSON.parse(savedRoom);
                        if (roomData && roomData.id) {
                            openChat(roomData.id, roomData.name, roomData.icon);
                        } else {
                            hideLoading();
                        }
                    } catch (e) {
                        localStorage.removeItem('currentRoom');
                        hideLoading();
                    }
                } else {
                    hideLoading(); // ุฅุฎูุงุก ุงูุชุญููู ููุท ุฅุฐุง ูู ุชูู ููุงู ุบุฑูุฉ ููุงูุถูุงู ุฅูููุง
                }
            }, 200); // ุชุฃุฎูุฑ ุจุณูุท ูุถูุงู ุฑุณู ุงููุงุฌูุฉ
        }

        function handleSessionInvalid() {
            console.log('ุงูุฌูุณุฉ ุบูุฑ ุตุงูุญุฉุ ุฌุงุฑู ุชูุธูู ุงูุจูุงูุงุช ุงููุญููุฉ...');
            localStorage.removeItem('currentRoom');
            currentUser = null;
            sessionChecked = true;
            hideLoading();
            document.getElementById('loginPage').classList.remove('hidden');
        }

        // ุชุญุฏูุซ ูุนูููุงุช ุงููุณุชุฎุฏู ูู ุงูุฑุฃุณ
        function updateHeaderUserInfo() {
            if (currentUser) {
                const headerUsernameElem = document.getElementById('headerUsername');
                if (headerUsernameElem) {
                    headerUsernameElem.textContent = currentUser.name;
                }
                const headerAvatarInitialElem = document.getElementById('headerAvatarInitial');
                if (headerAvatarInitialElem) {
                    headerAvatarInitialElem.textContent = currentUser.name.charAt(0).toUpperCase();
                }
                
                // ุชุญุฏูุซ ุงูุตูุฑุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
                socket.emit('get avatar', currentUser.name);
            }
        }

        socket.on('avatar data', (data) => {
            if (data.username === currentUser.name && data.avatarUrl) {
                const headerAvatar = document.querySelector('#profileButton .w-8.h-8');
                if (headerAvatar) {
                    headerAvatar.innerHTML = `<img src="${data.avatarUrl}" class="w-8 h-8 rounded-full object-cover" alt="${data.username}">`;
                }
            }
        });

        // ูุนุงูุฌุฉ ุชุณุฌูู ุงูุฏุฎูู
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            showLoading();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            socket.emit('user login', { username, password, rememberMe });
        });

        // ูุนุงูุฌุฉ ุฅูุดุงุก ุญุณุงุจ
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            showLoading();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const gender = document.querySelector('input[name="gender"]:checked')?.value;
            
            if (password !== confirmPassword) {
                showNotification('ูููุฉ ุงูุณุฑ ุบูุฑ ูุชุทุงุจูุฉ!', 'error');
                hideLoading();
                return;
            }
            
            if (!gender) {
                showNotification('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุฌูุณ!', 'error');
                hideLoading();
                return;
            }
            
            socket.emit('user register', { username, password, gender });
        });

        // ุงุณุชูุจุงู ูุชุงุฆุฌ ุชุณุฌูู ุงูุฏุฎูู
        socket.on('login success', (userData) => {
            // ุชุนููู ุงููููู ูุฌูุณุฉ ุงูุฏุฎูู
            document.cookie = `sessionId=${userData.sessionId}; path=/; max-age=31536000; SameSite=Lax`; // ุตูุงุญูุฉ ููุฏุฉ ุณูุฉ
            handleSessionValid(userData);
            socket.emit('get friend requests', currentUser.name);
            socket.emit('get friends list', currentUser.name);
            socket.emit('get unread counts', currentUser.name);
            
            hideLoading();
            // ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู ุงููุงุฌุญุ ุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู
            if (currentUser) {
                toggleBackgroundButton();
            }

        });

        socket.on('login error', (error) => {
            showNotification(error, 'error');
            hideLoading();
        });

        // ุงุณุชูุจุงู ูุชุงุฆุฌ ุฅูุดุงุก ุงูุญุณุงุจ
        socket.on('register success', (userData) => {
            // ุชุนููู ุงููููู ูุฌูุณุฉ ุงูุฏุฎูู
            document.cookie = `sessionId=${userData.sessionId}; path=/; max-age=31536000; SameSite=Lax`; // ุตูุงุญูุฉ ููุฏุฉ ุณูุฉ
            handleSessionValid(userData);
            socket.emit('get friend requests', currentUser.name);
            socket.emit('get friends list', currentUser.name);
            socket.emit('get unread counts', currentUser.name);
            
            // ุจุนุฏ ุฅูุดุงุก ุงูุญุณุงุจุ ุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู
            if (currentUser) {
                toggleBackgroundButton();
            }
            hideLoading();
        });

        socket.on('register error', (error) => {
            showNotification(error, 'error');
            hideLoading();
        });

        // ุงุณุชูุจุงู ุชุญุฏูุซ ุงูุบุฑู
        socket.on('rooms update', (updatedRooms) => {
            rooms = updatedRooms;
            loadRooms();
        });

        // ุงุณุชูุจุงู ุชุญุฏูุซ ุงููุณุชุฎุฏููู
        socket.on('users update', (users) => {
            updateOnlineUsersList(users);
        });

        // ุงุณุชูุจุงู ุฑุณุงุฆู ุฌุฏูุฏุฉ
        socket.on('new message', (message) => {
            if (message.type === 'user' || (message.type === 'image' && message.user) || message.replyTo) {
                addMessageToChat(message.user, message.content, message.time, message.user === currentUser.name, message.rank, message.avatar, message.messageId, message.replyTo);
            } else if (message.type === 'system') {
                addSystemMessage(message.content, message.time);
            } else {
                addSystemMessage(message.content, message.time);
            }
            // ุชูุฑูุฑ ุฅูู ุงูุฃุณูู ุนูุฏ ุงุณุชูุจุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ
            setTimeout(scrollToBottom, 100);
        });

        // ุงุณุชูุจุงู ุชุงุฑูุฎ ุงููุญุงุฏุซุฉ (ูุญุฏุซ ูุฏุนู ุงูุตูุฑ)
socket.on('chat history', (messages) => {
    const container = document.getElementById('messagesContainer');
    container.innerHTML = '';
    
    messages.forEach(msg => {
        // ุฅุฐุง ูู ููุฌุฏ messageIdุ ุฃูุดุฆ ูุงุญุฏ ุญูููู ูููุฑู
        if (!msg.messageId) {
            msg.messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        if (msg.type === 'user') {
            addMessageToChat(msg.user, msg.content, msg.time, msg.user === currentUser.name, msg.rank, msg.avatar, msg.messageId, msg.replyTo);
        } else if (msg.type === 'image') {
            addImageMessageToChat(msg.user, msg.imageData, msg.time, msg.user === currentUser.name, msg.rank, msg.avatar, msg.messageId);
        } else {
            addSystemMessage(msg.content, msg.time);
        }
    });
    
    setTimeout(scrollToBottom, 100);
    hideLoading();
});

        // ุงุณุชูุจุงู ูุชุงุฆุฌ ุงูุฑุชุจ
        socket.on('rank success', (message) => {
            showNotification(message, 'success');
        });

        socket.on('rank error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('show ranks', (message) => {
            addSystemMessage(message.content, message.time);
        });

        // ุงุณุชูุจุงู ุฃุฎุทุงุก ุงูุฑุณุงุฆู
        socket.on('message error', (error) => {
            showNotification(error, 'error');
        });

        // ุงุณุชูุจุงู ุฃุญุฏุงุซ ุงูุตูุฑ
        socket.on('avatar updated', (data) => {
            showNotification(`ุชู ุชุญุฏูุซ ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ ูู ${data.username}`, 'success');
            updateAvatarPreview();
            updateHeaderUserInfo();
        });

        socket.on('avatar error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('avatar data', (data) => {
            if (data.avatarUrl) {
                document.getElementById('currentAvatarPreview').src = data.avatarUrl;
            }
        });

        socket.on('user avatar updated', (data) => {
            updateOnlineUsersAvatars(data.username, data.avatarUrl);
        });

        // ุงุณุชูุจุงู ูุชุงุฆุฌ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
        socket.on('management success', (message) => {
            showNotification(message, 'success');
        });

        socket.on('management error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('user status', (message) => {
            addSystemMessage(message.content, message.time);
        });

        // ุงุณุชูุจุงู ุญุงูุงุช ุงูุญุธุฑ
        socket.on('banned from room', (data) => {
            showNotification(`ุชู ุญุธุฑู ูู ุบุฑูุฉ ${data.room}. ุงูุณุจุจ: ${data.reason}`, 'error');
            goBack();
        });

        socket.on('banned from site', (data) => {
            showNotification(`ุชู ุญุธุฑู ูู ุงููููุน ุจุงููุงูู. ุงูุณุจุจ: ${data.reason}`, 'error');
            logout();
        });

        socket.on('user deleted', () => {
            showNotification('ุชู ุญุฐู ุญุณุงุจู ูู ูุจู ุงูุฅุฏุงุฑุฉ', 'error');
            logout();
        });

        // ุงุณุชูุจุงู ุจูุงูุงุช ุงูููู ุงูุดุฎุตู
        socket.on('user profile data', (data) => {
            showUserProfile(data);
        });

        // ุงุณุชูุจุงู ุฑุณุงุฆู ุฎุงุตุฉ
        socket.on('private message sent', (message) => {
            addPrivateMessageToChat(message, true);
        });

        socket.on('new private message', (message) => {
    if (privateChatTarget && message.from === privateChatTarget) {
        addPrivateMessageToChat(message, false);
    } else {
        // ุฒูุงุฏุฉ ุนุฏุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ ููุฐุง ุงููุณุชุฎุฏู
        if (!unreadPrivateMessages[message.from]) {
            unreadPrivateMessages[message.from] = 0;
        }
        unreadPrivateMessages[message.from]++;
        
        // ุชุญุฏูุซ ุงูุฅุดุนุงุฑุงุช
        updateUnreadBadges();
        
        showNotification(`ุฑุณุงูุฉ ุฎุงุตุฉ ุฌุฏูุฏุฉ ูู ${message.from}`, 'info');
    }
});

        // ุงุณุชูุจุงู ุชุงุฑูุฎ ุงููุญุงุฏุซุฉ ุงูุฎุงุตุฉ (ูุญุฏุซ ูุฏุนู ุงูุตูุฑ)
socket.on('private messages history', (messages) => {
    const container = document.getElementById('privateChatMessages');
    if (!container) return;
    
    container.innerHTML = '';
    
    messages.forEach(msg => {
        if (msg.type === 'image') {
            addPrivateImageMessage(msg, msg.from === currentUser.name);
        } else {
            addPrivateMessageToChat(msg, msg.from === currentUser.name);
        }
    });
    
    setTimeout(() => {
        container.scrollTop = container.scrollHeight;
    }, 100);
});

        // ุงุณุชูุจุงู ุฃุญุฏุงุซ ูุธุงู ุงูุตุฏุงูุงุช
        socket.on('new friend request', (data) => {
            showNotification(`ุทูุจ ุตุฏุงูุฉ ุฌุฏูุฏ ูู ${data.fromUser}`, 'info');
            updateFriendRequests();
            updateMessagesBadge();
        });

        socket.on('friend request sent', (message) => {
            showNotification(message, 'success');
        });

        socket.on('friend request error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('friend request accepted', (data) => {
            showNotification(`ูุจู ${data.byUser} ุทูุจ ุงูุตุฏุงูุฉ`, 'success');
            updateFriendsList();
        });

        socket.on('friend request processed', (message) => {
            showNotification(message, 'success');
            updateFriendRequests();
        });

        socket.on('friend removed', (message) => {
            showNotification(message, 'success');
            updateFriendsList();
        });

        socket.on('friend removed you', (data) => {
            showNotification(`ุฃุฒุงูู ${data.byUser} ูู ูุงุฆูุฉ ุงูุฃุตุฏูุงุก`, 'info');
            updateFriendsList();
        });

        socket.on('friend error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('friend requests list', (requests) => {
            friendRequests = requests;
            updateFriendRequests();
            updateMessagesBadge();
        });

        socket.on('friends list', (friends) => {
            friendsList = friends;
            updateFriendsList();
        });

        socket.on('search results', (results) => {
            displaySearchResults(results);
        });
        // ุนูุฏ ุงูุงุชุตุงู ุงููุงุฌุญุ ุทูุจ ุจูุงูุงุช ุงูุตูุฑ
socket.on('connect', () => {
    if (currentUser) {
        socket.emit('get user avatars');
    }
});


        // ุฅุธูุงุฑ/ุฅุฎูุงุก ูุงุฆูุฉ ุงููุชุตููู ููุฌูุงู
        toggleUsersButton.addEventListener('click', toggleUsersList);
        
        function toggleUsersList() {
            onlineUsersPanel.classList.toggle('show');
            usersOverlay.classList.toggle('show');
        }

        // ูุชุญ ูุฅุบูุงู ูุงุฆูุฉ ุงูุฃุตุฏูุงุก
        function openFriendsSidebar() {
            document.getElementById('friendsSidebar').classList.add('show');
            document.getElementById('friendsOverlay').classList.add('show');
        }

        function closeFriendsSidebar() {
            document.getElementById('friendsSidebar').classList.remove('show');
            document.getElementById('friendsOverlay').classList.remove('show');
        }

        // ุชุญุฏูุซ ุทูุจุงุช ุงูุตุฏุงูุฉ
        function updateFriendRequests() {
            const container = document.getElementById('friendRequestsList');
            const countElement = document.getElementById('friendRequestsCount');
            
            if (!container || !countElement) return;
            
            container.innerHTML = '';
            countElement.textContent = friendRequests.length;
            
            if (friendRequests.length === 0) {
                container.innerHTML = '<p class="text-blue-200 text-sm text-center">ูุง ุชูุฌุฏ ุทูุจุงุช ุตุฏุงูุฉ</p>';
                return;
            }
            
            friendRequests.forEach(username => {
                const requestDiv = document.createElement('div');
                requestDiv.className = 'flex items-center justify-between bg-white/5 rounded-lg p-3 friend-item';
                requestDiv.innerHTML = `
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <div class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-white">
                            ${username.charAt(0).toUpperCase()}
                        </div>
                        <span class="text-white font-medium">${username}</span>
                    </div>
                    <div class="flex space-x-2 space-x-reverse">
                        <button onclick="acceptFriendRequest('${username}')" class="text-green-500 hover:text-green-300">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </button>
                        <button onclick="rejectFriendRequest('${username}')" class="text-red-500 hover:text-red-300">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;
                container.appendChild(requestDiv);
            });
        }

         // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุฃุตุฏูุงุก ูุน ุงูุตูุฑ
    function updateFriendsList() {
        const container = document.getElementById('friendsList');
        if (!container) return;
        
        container.innerHTML = '';
        
        friendsList.forEach(username => {
            const avatarUrl = userAvatars[username] || null;
            const friendDiv = document.createElement('div');
            friendDiv.className = 'flex items-center justify-between bg-white/5 rounded-lg p-3 friend-item';
            
            friendDiv.innerHTML = `
    <div class="flex items-center space-x-3 space-x-reverse">
        ${avatarUrl ? 
            `<img src="${avatarUrl}" class="w-8 h-8 rounded-full object-cover" alt="${username}">` :
            `<div class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-white">
                ${username.charAt(0).toUpperCase()}
            </div>`
        }
        <span class="text-white font-medium">${username}</span>
    </div>
    <div class="flex space-x-2 space-x-reverse">
        <button onclick="showUserProfileModal('${username}')" class="text-blue-500 hover:text-blue-300 relative">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span id="profileBadge_${username}" class="unread-badge hidden absolute -top-1 -right-1 bg-red-500 text-white rounded-full text-xs h-4 w-4 flex items-center justify-center"></span>
        </button>
        <button onclick="removeFriend('${username}')" class="text-red-500 hover:text-red-300">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
        </button>
    </div>
`;
            container.appendChild(friendDiv);
        });
    }

            // ูู ูุณู updateFriendsList
friendsList.forEach(username => {
    const friendDiv = document.createElement('div');
    friendDiv.className = 'flex items-center justify-between bg-white/5 rounded-lg p-3 friend-item';
    
    // ุงูุญุตูู ุนูู ุตูุฑุฉ ุงููุณุชุฎุฏู ูู ุงูุฎุงุฏู
    const avatarUrl = userAvatars[username] || null;
    
    friendDiv.innerHTML = `
        <div class="flex items-center space-x-3 space-x-reverse">
            ${avatarUrl ? 
                `<img src="${avatarUrl}" class="w-8 h-8 rounded-full object-cover" alt="${username}">` :
                `<div class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-white">
                    ${username.charAt(0).toUpperCase()}
                </div>`
            }
            <span class="text-white font-medium">${username}</span>
        </div>
        <div class="flex space-x-2 space-x-reverse">
            <button onclick="showUserProfileModal('${username}')" class="text-blue-500 hover:text-blue-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
            </button>
            <button onclick="removeFriend('${username}')" class="text-red-500 hover:text-red-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
        </div>
    `;
    container.appendChild(friendDiv);
});
        

        // ุชุญุฏูุซ ุดุงุฑุฉ ุงูุฑุณุงุฆู
        function updateMessagesBadge() {
    const badge = document.getElementById('messagesBadge');
    const chatBadge = document.getElementById('chatMessagesBadge');
    
    // ุญุณุงุจ ุฅุฌูุงูู ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ ูู ุฌููุน ุงูุฃุตุฏูุงุก
    let totalUnread = 0;
    for (const username in unreadPrivateMessages) {
        totalUnread += unreadPrivateMessages[username];
    }
    
    // ุฅุถุงูุฉ ุทูุจุงุช ุงูุตุฏุงูุฉ ุฅูู ุงูุนุฏุฏ ุงูุฅุฌูุงูู
    totalUnread += friendRequests.length;
    
    // ุชุญุฏูุซ ุงูุฒุฑ ูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
    if (badge) {
        if (totalUnread > 0) {
            badge.textContent = totalUnread;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
    
    // ุชุญุฏูุซ ุงูุฒุฑ ูู ูุงุฌูุฉ ุงููุญุงุฏุซุฉ
    if (chatBadge) {
        if (totalUnread > 0) {
            chatBadge.textContent = totalUnread;
            chatBadge.classList.remove('hidden');
        } else {
            chatBadge.classList.add('hidden');
        }
    }
}

        // ุงูุจุญุซ ุนู ูุณุชุฎุฏููู
        function searchUsers() {
            const query = document.getElementById('userSearchInput').value.trim();
            
            if (query.length < 2) {
                showNotification('ูุฑุฌู ุฅุฏุฎุงู่ณๅฐ ุญุฑููู ููุจุญุซ', 'error');
                return;
            }
            
            socket.emit('search users', {
                query: query,
                currentUser: currentUser.name
            });
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (!container) return;
            
            container.innerHTML = '';
            container.classList.remove('hidden');
            
            if (results.length === 0) {
                container.innerHTML = '<p class="text-blue-200 text-sm text-center">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</p>';
                return;
            }
            
            results.forEach(username => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'flex items-center justify-between py-2';
                resultDiv.innerHTML = `
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <div class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-white">
                            ${username.charAt(0).toUpperCase()}
                        </div>
                        <span class="text-white font-medium">${username}</span>
                    </div>
                    <button onclick="showUserProfileModal('${username}')" class="text-blue-500 hover:text-blue-300 text-sm">
                        ุนุฑุถ ุงูููู
                    </button>
                `;
                container.appendChild(resultDiv);
            });
        }

        // ุฅุฑุณุงู ุทูุจ ุตุฏุงูุฉ
        function sendFriendRequest() {
            const profileUsername = document.getElementById('profileUsername').textContent;
            
            if (profileUsername === currentUser.name) {
                showNotification('ูุง ููููู ุฅุฑุณุงู ุทูุจ ุตุฏุงูุฉ ูููุณู', 'error');
                return;
            }
            
            socket.emit('send friend request', {
                fromUser: currentUser.name,
                toUser: profileUsername
            });
        }

        // ูุจูู ุทูุจ ุตุฏุงูุฉ
        function acceptFriendRequest(username) {
            socket.emit('accept friend request', {
                fromUser: username,
                toUser: currentUser.name
            });
        }

        // ุฑูุถ ุทูุจ ุตุฏุงูุฉ
        function rejectFriendRequest(username) {
            socket.emit('reject friend request', {
                fromUser: username,
                toUser: currentUser.name
            });
        }

        // ุฅุฒุงูุฉ ุตุฏูู
        function removeFriend(username) {
            if (confirm(`ูู ุชุฑูุฏ ุจุงูุชุฃููุฏ ุฅุฒุงูุฉ ${username} ูู ูุงุฆูุฉ ุฃุตุฏูุงุฆูุ`)) {
                socket.emit('remove friend', {
                    username: currentUser.name,
                    friendToRemove: username
                });
            }
        }

        // ุนุฑุถ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
        function showMainPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            updateWelcomeMessage();
            
            // ุฅุฎูุงุก ุงูุฃุฒุฑุงุฑ ูู ุฑุฃุณ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
            document.getElementById('postsButton').parentElement.classList.add('hidden');
            document.getElementById('messagesButton').parentElement.classList.add('hidden');
            document.getElementById('friendsButton').classList.add('hidden');
            
            // ุทูุจ ูุงุฆูุฉ ุงูุบุฑู ูู ุงูุณูุฑูุฑ
            fetch('/api/rooms')
                .then(response => response.json())
                .then(data => {
                    rooms = data;
                    loadRooms();
                });
        }

        // ุชุญุฏูุซ ุฑุณุงูุฉ ุงูุชุฑุญูุจ
        function updateWelcomeMessage() {
            const welcomeElement = document.getElementById('welcomeMessage');
            if (welcomeElement && currentUser) {
                const rankBadge = currentUser.rank ? `(${ranks[currentUser.rank].icon} ${currentUser.rank})` : '';
                welcomeElement.innerHTML = `๐ ูุฑุญุจุงู ${currentUser.name} ${rankBadge}`;
            }
        }

        // ุชุญููู ุงูุบุฑู
        function loadRooms() {
            const roomsContainer = document.getElementById('roomsContainer');
            roomsContainer.innerHTML = '';
            
            rooms.forEach(room => {
                const roomDiv = document.createElement('div');
                roomDiv.className = room.protected ? 
                    'bg-gradient-to-br from-red-900/30 to-orange-900/30 backdrop-blur-lg rounded-2xl p-6 hover:from-red-800/40 hover:to-orange-800/40 transition-all duration-300 relative group border-2 border-red-500/50' :
                    'bg-white/10 backdrop-blur-lg rounded-2xl p-6 hover:bg-white/20 transition-all duration-300 relative group';
                
                roomDiv.innerHTML = `
                    <div class="absolute top-4 right-4 bg-blue-600/50 text-white text-xs font-bold px-2.5 py-1 rounded-full flex items-center space-x-1 space-x-reverse backdrop-blur-sm">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <span>${room.users.length}</span>
                    </div>
                    <div class="cursor-pointer" onclick="${room.protected ? `openProtectedChat(${room.id}, '${room.name}', '${room.icon}')` : `openChat(${room.id}, '${room.name}', '${room.icon}')`}">
                        <div class="text-4xl mb-4 text-center">${room.icon}</div>
                        <h3 class="text-xl font-semibold text-white text-center mb-2">${room.name}</h3>
                        <p class="text-blue-200 text-center text-sm">${room.description}</p>
                        <div class="mt-4 text-center">
                            <span class="${room.protected ? 'bg-red-600' : 'bg-gray-500'} text-white px-3 py-1 rounded-full text-xs">
                                ${room.protected ? '๐ ูุญููุฉ' : 'ุงููุฑ ููุฏุฎูู'}
                            </span>
                        </div>
                    </div>
                `;
                
                roomsContainer.appendChild(roomDiv);
            });
        }

        // ูุชุญ ุบุฑูุฉ ุงูุฏุฑุฏุดุฉ
        function openChat(roomId, roomName, icon) {
            showLoading();
            currentRoom = { id: roomId, name: roomName, icon: icon };
            
            // ุญูุธ ุงูุบุฑูุฉ ุงูุญุงููุฉ
            localStorage.setItem('currentRoom', JSON.stringify(currentRoom));
            
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('chatPage').classList.remove('hidden');
            document.getElementById('chatTitle').textContent = roomName;
            document.getElementById('chatIcon').textContent = icon;
            
            // ุฅุธูุงุฑ ุงูุฃุฒุฑุงุฑ ูู ุฑุฃุณ ุงููุญุงุฏุซุฉ
            document.getElementById('chatPostsButton').classList.remove('hidden');
            document.getElementById('chatMessagesButtonContainer').classList.remove('hidden');
            document.getElementById('chatFriendsButton').classList.remove('hidden');
            
            // ุฅุฎูุงุก ุฒุฑ ุงูููู ุงูุดุฎุตู ูู ุฑุฃุณ ุงููุญุงุฏุซุฉ
            document.getElementById('profileButton').classList.add('hidden');
            
            // ุฅุธูุงุฑ/ุฅุฎูุงุก ููุญุงุช ุงูุฅุฏุงุฑุฉ ุจูุงุกู ุนูู ููุน ุงูุบุฑูุฉ
            const rankPanel = document.getElementById('rankManagementPanel');
            const userPanel = document.getElementById('userManagementPanel');
            const avatarPanel = document.getElementById('avatarManagementPanel');
            const messageInputContainer = document.getElementById('messageInputContainer');
            
            if (roomName === 'ุบุฑูุฉ ุงูุฅุฏุงุฑุฉ') {
                rankPanel.classList.remove('hidden');
                userPanel.classList.remove('hidden');
                avatarPanel.classList.add('hidden');
                messageInputContainer.classList.remove('hidden');
            } else if (roomName === 'ุบุฑูุฉ ุชุฎุตูุต ุงููุธูุฑ') {
                rankPanel.classList.add('hidden');
                userPanel.classList.add('hidden');
                avatarPanel.classList.remove('hidden');
                messageInputContainer.classList.add('hidden');
                updateAvatarPreview();
            } else {
                rankPanel.classList.add('hidden');
                userPanel.classList.add('hidden');
                avatarPanel.classList.add('hidden');
                messageInputContainer.classList.remove('hidden');
            }
            
            // ุงูุงูุถูุงู ููุบุฑูุฉ
            socket.emit('join room', { roomId, user: currentUser });
        }

        // ูุชุญ ุบุฑูุฉ ูุญููุฉ ุจูููุฉ ุณุฑ
        function openProtectedChat(roomId, roomName, icon) {
            let password = '';
            
            if (roomName === 'ุบุฑูุฉ ุงูุฅุฏุงุฑุฉ') {
                password = prompt('ุฃุฏุฎู ูููุฉ ุณุฑ ุบุฑูุฉ ุงูุฅุฏุงุฑุฉ:');
                if (password !== 'admin123') {
                    showNotification('ูููุฉ ุงูุณุฑ ุบูุฑ ุตุญูุญุฉ!', 'error');
                    return;
                }
            } else if (roomName === 'ุบุฑูุฉ ุชุฎุตูุต ุงููุธูุฑ') {
                password = prompt('ุฃุฏุฎู ูููุฉ ุณุฑ ุบุฑูุฉ ุชุฎุตูุต ุงููุธูุฑ:');
                if (password !== 'a') {
                    showNotification('ูููุฉ ุงูุณุฑ ุบูุฑ ุตุญูุญุฉ!', 'error');
                    return;
                }
            }
            
            openChat(roomId, roomName, icon);
        }

        // ุงูุนูุฏุฉ ุฅูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
        function goBack(isDisconnected = false) {
    if (currentRoom) {
        socket.emit('leave room', { roomId: currentRoom.id, user: currentUser });
        localStorage.removeItem('currentRoom');
    }
    document.getElementById('chatPage').classList.add('hidden');
    document.getElementById('mainPage').classList.remove('hidden');
    document.getElementById('messagesContainer').innerHTML = '';

    if (isDisconnected) {
        showNotification('ููุฏ ููุฏุช ุงูุงุชุตุงู ุจุงูุบุฑูุฉ ุจุณุจุจ ุงูุฎููู.', 'warning');
    }
    
    // ุฅุฎูุงุก ุงูุฃุฒุฑุงุฑ ูู ุฑุฃุณ ุงููุญุงุฏุซุฉ ุนูุฏ ุงูุนูุฏุฉ
    document.getElementById('chatPostsButton').classList.add('hidden');
    document.getElementById('chatMessagesButtonContainer').classList.add('hidden');
    document.getElementById('chatFriendsButton').classList.add('hidden');
    
    // ุฅุนุงุฏุฉ ุฅุธูุงุฑ ุฒุฑ ุงูููู ุงูุดุฎุตู ูู ุงูุฑุฃุณ
    document.getElementById('profileButton').classList.remove('hidden');
    
    currentRoom = null;
}

        // ุชุณุฌูู ุงูุฎุฑูุฌ
        // ...existing code...
let manualLogout = false;

function logout() {
    manualLogout = true;
    if (currentRoom) {
        socket.emit('leave room', { roomId: currentRoom.id, user: currentUser });
    }
    localStorage.removeItem('currentRoom');
    currentUser = null;
    currentRoom = null;
    document.getElementById('mainPage').classList.add('hidden');
    document.getElementById('chatPage').classList.add('hidden');
    document.getElementById('loginPage').classList.remove('hidden');
    document.cookie = "sessionId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"; // ุญุฐู ุงููููู
}

// ููุน ุญุฐู ุงูุฌูุณุฉ ุนูุฏ ุฅุบูุงู ุงูุตูุญุฉ ุฅูุง ุฅุฐุง ูุงู logout ุญูููู
window.addEventListener('beforeunload', function (e) {
    if (!manualLogout) {
        // ูุง ุชุญุฐู ุงูุฌูุณุฉ
        return;
    }
    // ุฅุฐุง ูุงู logout ุญููููุ ุงุญุฐู ุงูุฌูุณุฉ
    localStorage.removeItem('currentRoom');
});
// ...existing code...

        // ุฅุฑุณุงู ุฑุณุงูุฉ
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            const replyPreview = document.getElementById('replyPreview');
            let replyTo = null;

            if (!replyPreview.classList.contains('hidden')) {
                replyTo = {
                    messageId: replyPreview.getAttribute('data-reply-id'),
                    user: document.getElementById('replyUsername').textContent,
                    content: document.getElementById('replyContent').textContent
                };
            }
           
            if (message && currentUser && currentRoom) {
                socket.emit('send message', { 
                    roomId: currentRoom.id, 
                    message, 
                    user: currentUser,
                    replyTo: replyTo
                });
                input.value = '';
                cancelReply(); // ุฅูุบุงุก ูุถุน ุงูุฑุฏ ุจุนุฏ ุงูุฅุฑุณุงู
            }
        }

        // ุงูุชุนุงูู ูุน ุงูุถุบุท ุนูู ููุชุงุญ Enter
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ุฅุถุงูุฉ ุฑุณุงูุฉ ุฅูู ุงูุฏุฑุฏุดุฉ (ูุณุฎุฉ ูุฏูุฌุฉ)
function addMessageToChat(user, message, time, isOwn, userRank, avatarUrl, messageId = null, replyTo = null) {
    const container = document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');    
    messageDiv.setAttribute('data-message-id', messageId);
   
    let rankBadge = '';
   
    if (userRank) {
        const rankInfo = ranks[userRank];
        rankBadge = `
            <div class="inline-flex items-center space-x-1 space-x-reverse bg-gradient-to-r ${rankInfo.color} px-2 py-1 rounded-full text-xs font-bold text-white shadow-lg mb-1">
                <span>${rankInfo.icon}</span>
                <span>${userRank}</span>
            </div>
        `;
    }

    // ุงูุจุญุซ ุนู ููู ุงุณู ุงููุณุชุฎุฏู
    let nameColorClass = 'text-blue-200'; // ุงูููู ุงูุงูุชุฑุงุถู
    const onlineUser = document.querySelector(`#onlineUsersList [data-username="${user}"]`);
    if (onlineUser) {
        const color = onlineUser.dataset.nameColor;
        if (color && color !== 'null') {
            nameColorClass = color;
        }
    }

    // ุฒุฑ ุงูุญุฐู: ูุธูุฑ ุฏุงุฆูุงู ููุงุฎุชุจุงุฑ
    // --- ุชุนุฏูู: ูุตู ุงูุฃุฒุฑุงุฑ ุนู ุงููุงุฆูุฉ ---
    let directActions = '';
    let menuBtn = '';
    if (messageId && user) { // ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูุชุฌูุจ ุงูุฃุฎุทุงุก
        const isMessageOwner = user === currentUser.name;
        const canDelete = 
            (currentUser.name === "Walid dz 31") || // ุตุงุญุจ ุงููููุน
            (isMessageOwner && currentUser.rank); // ุงููุณุชุฎุฏู ูููู ุฑุณุงูุชู ููุฏูู ุฑุชุจุฉ

        // ุฒุฑ ุงูุฑุฏ ูุธูุฑ ููุฌููุน
        directActions = `
            <button class="text-gray-400 hover:text-blue-400" title="ุฑุฏ" onclick="startReply('${messageId}', '${user}', '${message.replace(/'/g, "\\'")}')">โช๏ธ</button>
        `;

        // ุฅุถุงูุฉ ุฒุฑ ุงูุญุฐู ููุท ุฅุฐุง ูุงู ูุณููุญุงู
        if (canDelete) {
            directActions += `<button class="text-red-400 hover:text-red-600" title="ุญุฐู" onclick="deleteRoomMessage('${messageId}')">๐๏ธ</button>`;
        }

        menuBtn = `
        <div class=\"relative inline-block ml-2\">
            <button class=\"menu-btn text-gray-400 hover:text-blue-500 text-xl font-bold\" title=\"ุฎูุงุฑุงุช ุฅุถุงููุฉ\" data-message-id=\"${messageId}\" data-user=\"${user}\" data-content=\"${message.replace(/'/g, "\\'")}\">โฎ</button>
            <div class=\"message-menu hidden absolute left-0 z-50 bg-slate-800 text-white rounded shadow-lg mt-2 min-w-[160px] text-sm border border-slate-700\">
                <button class=\"block w-full text-right px-4 py-2 hover:bg-slate-700\" data-action=\"mute\">๐ ูุชู ุงููุณุชุฎุฏู</button>
                <button class=\"block w-full text-right px-4 py-2 hover:bg-slate-700\" data-action=\"unmute\">๐ ุฅูุบุงุก ูุชู ุงููุณุชุฎุฏู</button>
                <button class=\"block w-full text-right px-4 py-2 hover:bg-slate-700\" data-action=\"banRoom\">๐ซ ุญุธุฑ ูู ุงูุบุฑูุฉ</button>
                <button class=\"block w-full text-right px-4 py-2 hover:bg-slate-700\" data-action=\"unbanRoom\">โ ุฅูุบุงุก ุญุธุฑ ุงูุบุฑูุฉ</button>
            </div>
        </div>
        `;
    }

    let replyHtml = '';
    if (replyTo) {
        replyHtml = `
            <a href="#${replyTo.messageId}" onclick="scrollToMessage('${replyTo.messageId}')" class="block bg-black/20 p-2 rounded-lg mb-2 text-xs border-l-2 border-blue-400">
                <div class="font-semibold text-blue-300">ุฑุฏ ุนูู ${replyTo.user}</div>
                <p class="opacity-80 truncate">${replyTo.content}</p>
            </a>
        `;
    }


    if (avatarUrl) {
        messageDiv.innerHTML = `
            <div class="max-w-xs lg:max-w-md px-4 py-3 rounded-2xl ${
                isOwn
                    ? 'bg-blue-600 text-white ml-3'
                    : 'bg-white/20 text-white mr-3'
            }">
                <div class="flex items-center space-x-2 space-x-reverse mb-1">
                    <img src="${avatarUrl}" class="w-6 h-6 rounded-full object-cover" alt="${user}" onclick="showUserProfileModal('${user}')" style="cursor:pointer">
                    <div>
                        ${rankBadge}
                        <div class="font-semibold text-sm ${isOwn ? 'text-blue-100' : nameColorClass}" onclick="showUserProfileModal('${user}')" style="cursor:pointer">${user}</div>
                    </div>
                    <div class="flex items-center space-x-2 space-x-reverse mr-auto">
                        ${directActions}
                        ${menuBtn}
                    </div>
                </div>
                ${replyHtml}
                <div class="text-sm leading-relaxed">${message}</div>
                <div class="text-xs mt-1 opacity-70">${time}</div>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="max-w-xs lg:max-w-md px-4 py-3 rounded-2xl ${
                isOwn
                    ? 'bg-blue-600 text-white ml-3'
                    : 'bg-white/20 text-white mr-3'
            }">
                <div class="flex items-center space-x-2 space-x-reverse mb-1">
                    <div class="w-6 h-6 rounded-full bg-gray-400 flex items-center justify-center text-white" onclick="showUserProfileModal('${user}')" style="cursor:pointer">
                        ${user.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        ${rankBadge}
                        <div class="font-semibold text-sm ${isOwn ? 'text-blue-100' : nameColorClass}" onclick="showUserProfileModal('${user}')" style="cursor:pointer">${user}</div>
                    </div>
                    <div class="flex items-center space-x-2 space-x-reverse mr-auto">
                        ${directActions}
                        ${menuBtn}
                    </div>
                </div>
                ${replyHtml}
                <div class="text-sm leading-relaxed">${message}</div>
                <div class="text-xs mt-1 opacity-70">${time}</div>
            </div>
        `;
    }

    messageDiv.className = `chat-message flex ${isOwn ? 'justify-end' : 'justify-start'}`;

    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

// --- ุฅุนุงุฏุฉ ุจูุงุก ูุธุงู ูุงุฆูุฉ ุฎูุงุฑุงุช ุงูุฑุณุงูุฉ ---

// 1. ุฅุบูุงู ุฌููุน ุงูููุงุฆู ุงูููุชูุญุฉ
function closeAllMessageMenus() {
    document.querySelectorAll('.message-menu').forEach(m => m.classList.add('hidden'));
}

// 2. ูุนุงูุฌ ุงูููุฑ ุงูุนุงู
document.addEventListener('click', function(e) {
    const menuButton = e.target.closest('.menu-btn');
    const menuOption = e.target.closest('.message-menu button');

    if (menuButton) {
        // ุฅุฐุง ุชู ุงูููุฑ ุนูู ุฒุฑ ุงููุงุฆูุฉ (โฎ)
        e.stopPropagation();
        const menu = menuButton.nextElementSibling;
        const isHidden = menu.classList.contains('hidden');
        closeAllMessageMenus(); // ุฃุบูู ุฃู ูุงุฆูุฉ ุฃุฎุฑู
        if (isHidden) {
            menu.classList.remove('hidden'); // ุงูุชุญ ุงููุงุฆูุฉ ุงูุญุงููุฉ
        }
    } else if (menuOption) {
        // ุฅุฐุง ุชู ุงูููุฑ ุนูู ุฎูุงุฑ ุฏุงุฎู ุงููุงุฆูุฉ
        e.stopPropagation();
        const action = menuOption.dataset.action;
        const button = menuOption.closest('.relative').querySelector('.menu-btn');
        const messageId = button.dataset.messageId;
        const user = button.dataset.user; // ุงุณู ุงููุณุชุฎุฏู ูุญููุธ ูู ุงูุฒุฑ
        const content = button.dataset.content;

        switch (action) {
            case 'reply':
                startReply(messageId, user, content);
                break;
            case 'delete':
                deleteRoomMessage(messageId);
                break;
            case 'mute':
                if (confirm(`ูู ุชุฑูุฏ ูุชู ุงููุณุชุฎุฏู ${user}ุ`)) {
                    socket.emit('mute user', { username: user, duration: 60, currentUser });
                }
                break;
            case 'unmute':
                if (confirm(`ูู ุชุฑูุฏ ุฅูุบุงุก ูุชู ุงููุณุชุฎุฏู ${user}ุ`)) {
                    socket.emit('unmute user', { username: user, currentUser });
                }
                break;
            case 'banRoom':
                if (confirm(`ูู ุชุฑูุฏ ุญุธุฑ ุงููุณุชุฎุฏู ${user} ูู ูุฐู ุงูุบุฑูุฉุ`)) {
                    socket.emit('ban from room', { username: user, reason: 'ุชู ุงูุญุธุฑ ูู ุฎูุงู ุงูุฑุณุงูุฉ', currentUser });
                }
                break;
            case 'unbanRoom':
                if (confirm(`ูู ุชุฑูุฏ ุฅูุบุงุก ุญุธุฑ ุงููุณุชุฎุฏู ${user} ูู ูุฐู ุงูุบุฑูุฉุ`)) {
                    socket.emit('unban from room', { username: user, currentUser });
                }
                break;
        }
        closeAllMessageMenus();
    } else {
        // ุฅุฐุง ุชู ุงูููุฑ ูู ุฃู ููุงู ุขุฎุฑุ ุฃุบูู ุฌููุน ุงูููุงุฆู
        closeAllMessageMenus();
    }
});

// ุฏูุงู ุงูุฑุฏ ุนูู ุงูุฑุณุงุฆู (ุชู ููููุง ุฅูู ุงูููุงู ุงูุตุญูุญ)
function startReply(messageId, user, content) {
    const replyPreview = document.getElementById('replyPreview');
    const replyUsername = document.getElementById('replyUsername');
    const replyContent = document.getElementById('replyContent');

    replyPreview.setAttribute('data-reply-id', messageId);
    replyUsername.textContent = user;
    replyContent.textContent = content;

    replyPreview.classList.remove('hidden');
    document.getElementById('messageInput').focus();

    // ุฅุบูุงู ูุงุฆูุฉ ุงูุฎูุงุฑุงุช
    closeAllMessageMenus();
}

function cancelReply() {
    const replyPreview = document.getElementById('replyPreview');
    replyPreview.classList.add('hidden');
    replyPreview.removeAttribute('data-reply-id');
}

function scrollToMessage(messageId) {
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    if (messageElement) {
        messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // ุฅุถุงูุฉ ุชุฃุซูุฑ ูููุถ ูุคูุช
        messageElement.classList.add('animate-pulse');
        setTimeout(() => { messageElement.classList.remove('animate-pulse'); }, 2000);
    }
}

        // ุฅุถุงูุฉ ุฑุณุงูุฉ ูุธุงู (ูุณุฎุฉ ูุฏูุฌุฉ)
function addSystemMessage(message, time) {
    const container = document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message flex justify-center';
   
    messageDiv.innerHTML = `
        <div class="max-w-md px-3 py-2 rounded-2xl bg-slate-700/80 text-white text-center border border-cyan-500/30">
            <div class="flex items-center justify-center space-x-2 space-x-reverse mb-1">
                <img src="https://api.dicebear.com/7.x/bottts-neutral/svg?seed=system-bot" class="w-5 h-5 rounded-full" alt="System Bot">
                <div class="font-semibold text-sm text-cyan-300">ุฑุณุงุฆู ุงููุธุงู</div>
            </div>
            <div class="text-sm leading-relaxed">${message}</div>
            <div class="text-xs mt-1 opacity-60">${time}</div>
        </div>
    `;
   
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}


        // ุชุญุฏูุซ ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุงููุชุตููู ูุน ุงูุชุฑุชูุจ ุญุณุจ ุงูุฑุชุจุฉ
function updateOnlineUsersList(users) {
    const onlineUsersList = document.getElementById('onlineUsersList');
    const onlineUsersCount = document.getElementById('onlineUsersCount');
    
    if (!onlineUsersList || !onlineUsersCount) return;
    
    onlineUsersCount.textContent = users.length;
    onlineUsersList.innerHTML = '';
    
    // ุชุฑุชูุจ ุงููุณุชุฎุฏููู ุญุณุจ ุงูุฑุชุจุฉ (ูู ุงูุฃุนูู ุฅูู ุงูุฃุฏูู)
    const sortedUsers = users.sort((a, b) => {
        const rankA = a.rank ? ranks[a.rank]?.level || 0 : 0;
        const rankB = b.rank ? ranks[b.rank]?.level || 0 : 0;
        if (a.rank === 'ุตุงุญุจ ุงููููุน') return -1;
        if (b.rank === 'ุตุงุญุจ ุงููููุน') return 1;
        return rankB - rankA;
    });
    
    // ุชุญุฏูุซ ููู ุงุณู ุงููุณุชุฎุฏู ูู ุงููุงุฌูุฉ
    users.forEach(user => {
        if (user.name === currentUser.name) {
            currentUser.nameColor = user.nameColor;
        }
    });

    sortedUsers.forEach(user => {
        const userDiv = document.createElement('div');
        const isOwner = user.rank === 'ุตุงุญุจ ุงููููุน';
        
        // ุชุญุฏูุฏ ุงูููุงุณุงุช ุงูุฃุณุงุณูุฉ ูุชุฃุซูุฑุงุช ุงูู hover
        let baseClasses = 'group flex items-center space-x-3 space-x-reverse p-2.5 rounded-lg transition-all duration-200 ease-in-out cursor-pointer hover:bg-white/10';
        if (isOwner) {
            baseClasses += ' bg-yellow-500/10 border-r-4 border-yellow-400';
        } else {
            baseClasses += ' bg-white/5';
        }
        userDiv.className = baseClasses;
        userDiv.onclick = () => showUserProfileModal(user.name);
        userDiv.setAttribute('data-username', user.name);
        userDiv.setAttribute('data-name-color', user.nameColor || 'null');

        // ุฅูุดุงุก ุดุงุฑุฉ ุงูุฑุชุจุฉ
        let rankBadge = '';
        if (user.rank) {
            const rankInfo = ranks[user.rank];
            rankBadge = `<div class="inline-flex items-center space-x-1 space-x-reverse bg-gradient-to-r ${rankInfo.color} px-2 py-0.5 rounded-full text-xs font-bold text-white shadow-md">${rankInfo.icon} <span>${user.rank}</span></div>`;
        }

        // ุฅูุดุงุก ุงูุตูุฑุฉ ุงูุฑูุฒูุฉ
        const avatarHtml = user.avatar 
            ? `<img src="${user.avatar}" class="w-10 h-10 rounded-full object-cover border-2 border-slate-600 group-hover:border-blue-400 transition-colors" alt="${user.name}">`
            : `<div class="w-10 h-10 rounded-full bg-gray-500 flex items-center justify-center text-white font-bold border-2 border-slate-600 group-hover:border-blue-400 transition-colors">${user.name.charAt(0).toUpperCase()}</div>`;

        userDiv.innerHTML = `
            <div class="relative flex-shrink-0">
                ${avatarHtml}
                <span class="absolute bottom-0 right-0 block h-3 w-3 rounded-full bg-green-500 border-2 border-slate-800 ring-1 ring-green-400"></span>
            </div>
            <div class="flex-1 min-w-0">
                <div class="font-semibold truncate ${user.nameColor || 'text-white'}">${user.name}</div>
                ${rankBadge}
            </div>
        `;
        onlineUsersList.appendChild(userDiv);
    });
    
    document.getElementById('onlineUsersPanel').classList.remove('hidden');
}

        // ุฏูุงู ุฅุฏุงุฑุฉ ุงูุฑุชุจ
        function assignRank() {
            const username = document.getElementById('rankUserName').value.trim();
            const selectedRank = document.getElementById('rankSelect').value;
            
            if (!username || !selectedRank) {
                showNotification('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุณุชุฎุฏู ูุงุฎุชูุงุฑ ุงูุฑุชุจุฉ', 'error');
                return;
            }
            
            socket.emit('assign rank', { 
                username, 
                rank: selectedRank, 
                currentUser: { ...currentUser, roomId: currentRoom.id } 
            });
        }

        function removeRank() {
            const username = document.getElementById('rankUserName').value.trim();
            
            if (!username) {
                showNotification('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุณุชุฎุฏู', 'error');
                return;
            }
            
            socket.emit('remove rank', { 
                username, 
                currentUser: { ...currentUser, roomId: currentRoom.id } 
            });
        }

        function showAllRanks() {
            socket.emit('show all ranks', { 
                currentUser: { ...currentUser, roomId: currentRoom.id } 
            });
        }

        // ุฏูุงู ุฅุฏุงุฑุฉ ุงูุตูุฑ
        function selectAvatar(avatarKey) {
            if (!currentUser) return;
            
            const avatarUrl = defaultAvatars[avatarKey];
            socket.emit('update avatar', {
                username: currentUser.name,
                avatarUrl: avatarUrl,
                currentUser: { ...currentUser, roomId: currentRoom.id }
            });
        }

        function handleAvatarUpload() {
            if (!currentUser) return;
            
            const fileInput = document.getElementById('avatarUpload');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('ูุฑุฌู ุงุฎุชูุงุฑ ููู ุตูุฑุฉ ููุท', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                socket.emit('update avatar', {
                    username: currentUser.name,
                    avatarUrl: e.target.result,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            };
            reader.readAsDataURL(file);
        }

        function resetAvatar() {
            if (!currentUser) return;
            
            const defaultAvatar = currentUser.gender === 'female' ? defaultAvatars.girl1 : defaultAvatars.boy1;
            socket.emit('update avatar', {
                username: currentUser.name,
                avatarUrl: defaultAvatar,
                currentUser: { ...currentUser, roomId: currentRoom.id }
            });
        }

        function updateAvatarPreview() {
            if (!currentUser) return;
            socket.emit('get avatar', currentUser.name);
        }

        function updateOnlineUsersAvatars(username, avatarUrl) {
            const userElements = document.querySelectorAll('#onlineUsersList .flex.items-center');
            userElements.forEach(element => {
                const userNameElement = element.querySelector('.font-semibold');
                if (userNameElement && userNameElement.textContent === username) {
                    const imgElement = element.querySelector('img');
                    if (imgElement) {
                        imgElement.src = avatarUrl;
                    } else {
                        const divElement = element.querySelector('.rounded-full');
                        if (divElement) {
                            divElement.innerHTML = `<img src="${avatarUrl}" class="w-10 h-10 rounded-full object-cover" alt="${username}">`;
                        }
                    }
                }
            });
        }

        // ุฏูุงู ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
        function toggleManagementFields() {
            const action = document.getElementById('userActionSelect').value;
            const durationField = document.getElementById('durationField');
            const reasonField = document.getElementById('reasonField');
            
            durationField.classList.add('hidden');
            reasonField.classList.add('hidden');
            
            if (action === 'mute') {
                durationField.classList.remove('hidden');
            } else if (['banFromRoom', 'banFromSite'].includes(action)) {
                reasonField.classList.remove('hidden');
            }
        }

        function clearManagementFields() {
            document.getElementById('managedUserName').value = '';
            document.getElementById('userActionSelect').value = '';
            document.getElementById('muteDuration').value = '';
            document.getElementById('banReason').value = '';
            document.getElementById('durationField').classList.add('hidden');
            document.getElementById('reasonField').classList.add('hidden');
        }

        function manageUser() {
            const username = document.getElementById('managedUserName').value.trim();
            const action = document.getElementById('userActionSelect').value;
            
            if (!username) {
                showNotification('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุณุชุฎุฏู', 'error');
                return;
            }
            
            if (!action) {
                showNotification('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุฅุฌุฑุงุก', 'error');
                return;
            }
            
            if (action === 'mute') {
                const duration = document.getElementById('muteDuration').value;
                if (!duration || duration < 1) {
                    showNotification('ูุฑุฌู ุฅุฏุฎุงู ูุฏุฉ ูุชู ุตุญูุญุฉ', 'error');
                    return;
                }
                
                socket.emit('mute user', {
                    username,
                    duration,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'unmute') {
                socket.emit('unmute user', {
                    username,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'banFromRoom') {
                const reason = document.getElementById('banReason').value;
                socket.emit('ban from room', {
                    username,
                    reason,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'unbanFromRoom') {
                socket.emit('unban from room', {
                    username,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'banFromSite') {
                const reason = document.getElementById('banReason').value;
                socket.emit('ban from site', {
                    username,
                    reason,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'unbanFromSite') {
                socket.emit('unban from site', {
                    username,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            } else if (action === 'deleteUser') {
                if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงููุณุชุฎุฏู ${username}ุ ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู.`)) {
                    socket.emit('delete user', {
                        username,
                        currentUser: { ...currentUser, roomId: currentRoom.id }
                    });
                }
            } else if (action === 'showStatus') {
                socket.emit('get user status', {
                    username,
                    currentUser: { ...currentUser, roomId: currentRoom.id }
                });
            }
        }

        // ุฏูุงู ุงูููู ุงูุดุฎุตู ูุงููุญุงุฏุซุฉ ุงูุฎุงุตุฉ
        function showUserProfileModal(username) {
    if (!currentUser) return;
    
    // ุงูุญุตูู ุนูู ุงูุตูุฑุฉ ูู ุงูุฐุงูุฑุฉ ุงููุญููุฉ ุฃููุงู
    const avatarUrl = userAvatars[username] || null;
    
    socket.emit('get user profile', { username });
}

        socket.on('points sent success', (data) => {
            const message = typeof data === 'object' ? data.message : data;
            const newPoints = typeof data === 'object' ? data.newPoints : null;
            showNotification(message, 'success');
            if (currentUser && newPoints !== null) currentUser.points = newPoints;
        });
        socket.on('points sent error', (error) => {
            showNotification(error, 'error');
        });

        // --- ุฃุญุฏุงุซ ุงููุชุฌุฑ ---
        socket.on('shop items data', (items) => {
            window.shopItems = items; // ุญูุธ ุนูุงุตุฑ ุงููุชุฌุฑ ููุงุณุชุฎุฏุงู ูุงุญูุงู
            const container = document.getElementById('shopItemsContainer');
            container.innerHTML = '';

            if (items.length === 0) {
                container.innerHTML = '<p class="text-blue-200 text-center p-8">ุงููุชุฌุฑ ูุงุฑุบ ุญุงููุงู.</p>';
                return;
            }

            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center bg-slate-800/50 p-4 rounded-lg border border-slate-700';
                
                itemDiv.innerHTML = `
                    <div class="text-3xl ml-4">${item.itemType === 'name_change_card' ? '๐ณ' : (ranks[item.itemValue]?.icon || '๐๏ธ')}</div>
                    <div class="flex-1">
                        <h4 class="text-white font-semibold">${item.name}</h4>
                        <p class="text-blue-200 text-xs">${item.description}</p>
                    </div>
                    <button onclick="buyItem(${item.id})" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 space-x-reverse">
                        <span>${item.price}</span>
                        <span class="text-yellow-300">โญ</span>
                    </button>
                `;
                container.appendChild(itemDiv);
            });
        });

        function buyItem(itemId) {
            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุดุฑุงุก ูุฐุง ุงูุนูุตุฑุ ุณูุชู ุฎุตู ุงูููุงุท ูู ุฑุตูุฏู.')) {
                socket.emit('buy item', { itemId, currentUser });
            }
        }

        socket.on('buy item success', (data) => {
            showNotification(data.message, 'success');
            // ุชุญุฏูุซ ููุงุท ุงููุณุชุฎุฏู
            if (currentUser) currentUser.points = data.newPoints;
            // ุชุญุฏูุซ ููู ุงุณู ุงููุณุชุฎุฏู ุฅุฐุง ุชู ุดุฑุงุคู
            if (data.updatedNameColor) {
                currentUser.nameColor = data.updatedNameColor;
                updateHeaderUserInfo();
            }
            // ุชุญุฏูุซ ุนุฑุถ ุงูููุงุท ูู ุงูููู ุงูุดุฎุตู ุฅุฐุง ูุงู ููุชูุญุงู
            if (!document.getElementById('profileModal').classList.contains('hidden')) {
                document.getElementById('profilePoints').textContent = data.newPoints;
            }
            // ุฅุฐุง ูุงู ุงูุนูุตุฑ ุงููุดุชุฑู ูู ุจุทุงูุฉ ุชุบููุฑ ุงูุงุณูุ ุงูุชุญ ูุงูุฐุฉ ุงูุชุบููุฑ
            if (data.purchasedItem && data.purchasedItem.itemType === 'name_change_card') {
                closeShopModal();
                useNameChangeCard(data.inventory[data.inventory.length - 1].id);
            }
        });

        socket.on('buy item error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('name change success', (data) => {
            showNotification(data.message, 'success');
            // ุชุญุฏูุซ ุงููููู ุจุงูุฌูุณุฉ ุงูุฌุฏูุฏุฉ
            document.cookie = `sessionId=${data.newSessionId}; path=/; max-age=31536000; SameSite=Lax`;
            // ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุญุงูู
            currentUser.name = data.newUsername;
            currentUser.nameColor = data.nameColor;
            currentUser.sessionId = data.newSessionId;
            updateHeaderUserInfo();
            closeProfileModal();
        });

        socket.on('name change error', (error) => {
            showNotification(error, 'error');
        });

        socket.on('user name changed', ({ oldUsername, newUsername }) => {
            // ุชุญุฏูุซ ุงุณู ุงููุณุชุฎุฏู ูู ุงููุงุฌูุฉ ูุฌููุน ุงููุณุชุฎุฏููู
            document.querySelectorAll(`[data-username="${oldUsername}"]`).forEach(el => el.dataset.username = newUsername);
        });

        function useNameChangeCard(inventoryId) {
            const newUsername = prompt("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณูู ุงูุฌุฏูุฏ:");
            if (newUsername && newUsername.trim() !== '') {
                if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุชุบููุฑ ุงุณูู ุฅูู "${newUsername}"ุ ุณูุชู ุงุณุชููุงู ุจุทุงูุฉ ุชุบููุฑ ุงูุงุณู.`)) {
                    socket.emit('use name change card', {
                        oldUsername: currentUser.name,
                        newUsername: newUsername.trim(),
                        inventoryId: inventoryId,
                        currentUser: currentUser
                    });
                }
            }
        }


        function showUserProfile(profileData) {
            const modal = document.getElementById('profileModal');
            const avatar = document.getElementById('profileAvatar');
            const usernameElem = document.getElementById('profileUsername');
            const rankElem = document.getElementById('profileRank');
            const statusElem = document.getElementById('profileStatus');
            const statusDot = statusElem.querySelector('span:first-child'); // ุชุนุฏูู: ุงุฎุชูุงุฑ ุงูุนูุตุฑ ุงูุฃูู ุจุดูู ููุซูู
            const statusText = statusElem.querySelector('span:last-child'); // ุชุนุฏูู: ุงุฎุชูุงุฑ ุงูุนูุตุฑ ุงูุซุงูู ุจุดูู ููุซูู
            const privateChatButton = document.getElementById('privateChatButton');
            const addFriendButton = document.getElementById('addFriendButton');
            const sendPointsButton = document.getElementById('sendPointsButton');
            const profileMenuContainer = document.getElementById('profileMenuContainer');
            const profileBio = document.getElementById('profileBio');
            const profileBioInput = document.getElementById('profileBioInput');
            const editBioButton = document.getElementById('editBioButton');
            const saveBioButton = document.getElementById('saveBioButton');
            const specialUsers = ["Walid dz 31", "ุณูุฏ ุงุญูุฏ", "ููุงุฑุง"];
            
            if (specialUsers.includes(profileData.username)) {
                document.getElementById('profilePoints').textContent = '99999';
                document.getElementById('profileLevel').textContent = '9999';
            } else {
                document.getElementById('profilePoints').textContent = profileData.points;
                document.getElementById('profileLevel').textContent = profileData.level;
            }

            const inventorySection = document.getElementById('inventorySection');
            const inventoryItemsContainer = document.getElementById('inventoryItems');
            
            // ุชุนุจุฆุฉ ุงูุจูุงูุงุช
            avatar.src = profileData.avatar || (profileData.gender === 'female' ? defaultAvatars.girl1 : defaultAvatars.boy1);
            avatar.onerror = function() {
                this.src = profileData.gender === 'female' ? defaultAvatars.girl1 : defaultAvatars.boy1;
            };
            usernameElem.textContent = profileData.username;
            
            if (profileData.rank) {
                const rankInfo = ranks[profileData.rank];
                rankElem.textContent = `${rankInfo.icon} ${profileData.rank}`;
                rankElem.className = `inline-block mt-2 px-3 py-1 rounded-full text-sm font-semibold text-white bg-gradient-to-r ${rankInfo.color}`;
                rankElem.style.display = 'inline-block';
            } else {
                rankElem.style.display = 'none';
            }
            
            if (profileData.isOnline) {
                statusDot.className = 'w-2.5 h-2.5 rounded-full bg-green-500';
                statusText.textContent = 'ูุชุตู ุงูุขู';
            } else {
                statusDot.className = 'w-2.5 h-2.5 rounded-full bg-gray-500';
                const lastSeenText = profileData.lastSeen ? `ุขุฎุฑ ุธููุฑ ${getTimeAgo(new Date(profileData.lastSeen))}` : 'ุบูุฑ ูุชุตู';
                statusText.textContent = lastSeenText;
            }
            
            // ุนุฑุถ ุงููุนูููุงุช ุงูุดุฎุตูุฉ (Bio)
            profileBio.textContent = profileData.bio || 'ูุง ุชูุฌุฏ ูุนูููุงุช ูุนุฑุถูุง.';
            profileBioInput.value = profileData.bio || '';

            // ุฅุธูุงุฑ/ุฅุฎูุงุก ุฃุฒุฑุงุฑ ุงูุชุนุฏูู ููุงุฆูุฉ ุงูุฅุฏุงุฑุฉ
            if (profileData.username === currentUser.name) {
                editBioButton.classList.remove('hidden');
                saveBioButton.classList.add('hidden');
                privateChatButton.style.display = 'none';
                addFriendButton.style.display = 'none';
                sendPointsButton.style.display = 'none';
                profileMenuContainer.innerHTML = ''; // ุฅุฎูุงุก ูุงุฆูุฉ ุงูุฅุฏุงุฑุฉ

                // ุนุฑุถ ูุฎุฒูู ุงููุณุชุฎุฏู
                inventorySection.classList.remove('hidden');
                inventoryItemsContainer.innerHTML = '';
                if (profileData.inventory && profileData.inventory.length > 0) {
                    profileData.inventory.forEach(invItem => {
                        const shopItem = shopItems.find(si => si.id === invItem.itemId);
                        if (shopItem && shopItem.itemType === 'name_change_card') {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'flex items-center justify-between bg-white/10 p-2 rounded-lg';
                            itemDiv.innerHTML = `
                                <span class="text-white text-sm">๐ณ ${shopItem.name}</span>
                                <button onclick="useNameChangeCard(${invItem.id})" class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded-md">ุงุณุชุฎุฏุงู</button>
                            `;
                            inventoryItemsContainer.appendChild(itemDiv);
                        }
                    });
                } else {
                    inventoryItemsContainer.innerHTML = '<p class="text-blue-200 text-xs text-center">ุงููุฎุฒูู ูุงุฑุบ.</p>';
                }

            } else {
                editBioButton.classList.add('hidden');
                saveBioButton.classList.add('hidden');
                privateChatButton.style.display = 'flex';
                privateChatButton.setAttribute('data-username', profileData.username);
                
                // ุฅุธูุงุฑ ุฒุฑ ุฅุถุงูุฉ ุตุฏูู ููุท ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู ููุณู
                addFriendButton.style.display = 'flex';
                sendPointsButton.style.display = 'flex';
                inventorySection.classList.add('hidden');
                addFriendButton.setAttribute('data-username', profileData.username);
                
                // ุงูุชุญูู ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุตุฏููุงู ุจุงููุนู
                if (friendsList.includes(profileData.username)) {
                    addFriendButton.innerHTML = `
                        <span>ุตุฏูู</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    `;
                    addFriendButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                    addFriendButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
                    addFriendButton.disabled = true;
                } else {
                    addFriendButton.innerHTML = `
                        <span>ุฅุถุงูุฉ ุตุฏูู</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                        </svg>
                    `;
                    addFriendButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                    addFriendButton.classList.add('bg-green-600', 'hover:bg-green-700');
                    addFriendButton.disabled = false;
                }

                // ุฅุธูุงุฑ ูุงุฆูุฉ ุงูุฅุฏุงุฑุฉ ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุงูุญุงูู ูุดุฑูุงู
                const isSiteOwner = currentUser.name === "Walid dz 31";
                const managerLevel = ranks[currentUser.rank]?.level || 0;
                const targetLevel = ranks[profileData.rank]?.level || 0;
                const canManage = isSiteOwner || managerLevel > targetLevel;

                if (canManage && currentUser.name !== profileData.username) {
                    profileMenuContainer.innerHTML = `
                        <div class="relative inline-block">
                            <button class="menu-btn text-gray-400 hover:text-blue-400 text-xl font-bold" title="ุฎูุงุฑุงุช ุฅุฏุงุฑูุฉ" onclick="toggleProfileMenu(event, '${profileData.username}')">โฎ</button>
                            <div id="profileActionMenu" class="message-menu hidden absolute left-0 z-50 bg-slate-800 text-white rounded shadow-lg mt-2 min-w-[160px] text-sm border border-slate-700">
                                <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileMute('${profileData.username}')">๐ ูุชู ุงููุณุชุฎุฏู</button>
                                <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileUnmute('${profileData.username}')">๐ ุฅูุบุงุก ุงููุชู</button>
                                <div class="border-t border-slate-600 my-1"></div>
                                <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileBanRoom('${profileData.username}')">๐ซ ุญุธุฑ ูู ุงูุบุฑูุฉ</button>
                                <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileUnbanRoom('${profileData.username}')">โ ุฅูุบุงุก ุญุธุฑ ุงูุบุฑูุฉ</button>
                                ${isSiteOwner ? `
                                    <div class="border-t border-slate-600 my-1"></div>
                                    <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileBanSite('${profileData.username}')">โ ุญุธุฑ ูู ุงููููุน</button>
                                    <button class="block w-full text-right px-4 py-2 hover:bg-slate-700" onclick="handleProfileUnbanSite('${profileData.username}')">๐ ุฅูุบุงุก ุญุธุฑ ุงููููุน</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    profileMenuContainer.innerHTML = '';
                }
            }
            
            modal.classList.add('show');
            // ุฅุถุงูุฉ ุฅุดุนุงุฑ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ ุฅุฐุง ูุฌุฏุช
    const unreadCount = unreadPrivateMessages[profileData.username] || 0;
    if (unreadCount > 0 && profileData.username !== currentUser.name) {
        let badge = privateChatButton.querySelector('.unread-badge');
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'unread-badge absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white rounded-full text-xs h-5 w-5 flex items-center justify-center';
            privateChatButton.style.position = 'relative';
            privateChatButton.appendChild(badge);
        }
        badge.textContent = unreadCount;
    }
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
        }

        // ุฏูุงู ูุงุฆูุฉ ุงูุฎูุงุฑุงุช ูู ุงูููู ุงูุดุฎุตู
        function toggleProfileMenu(event, username) {
            event.stopPropagation();
            const menu = document.getElementById('profileActionMenu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }

        function handleProfileMute(username) {
            const duration = prompt(`ุฃุฏุฎู ูุฏุฉ ุงููุชู ูููุณุชุฎุฏู ${username} (ุจุงูุฏูุงุฆู):`, "60");
            if (duration && !isNaN(duration)) {
                socket.emit('mute user', { username, duration: parseInt(duration), currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileUnmute(username) {
            if (confirm(`ูู ุชุฑูุฏ ุฅูุบุงุก ูุชู ุงููุณุชุฎุฏู ${username}ุ`)) {
                socket.emit('unmute user', { username, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileBanRoom(username) {
            const reason = prompt(`ุฃุฏุฎู ุณุจุจ ุญุธุฑ ${username} ูู ูุฐู ุงูุบุฑูุฉ:`);
            if (reason !== null) { // ูุณูุญ ุจุณุจุจ ูุงุฑุบ
                socket.emit('ban from room', { username, reason, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileUnbanRoom(username) {
            if (confirm(`ูู ุชุฑูุฏ ุฅูุบุงุก ุญุธุฑ ุงููุณุชุฎุฏู ${username} ูู ูุฐู ุงูุบุฑูุฉุ`)) {
                socket.emit('unban from room', { username, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileBanSite(username) {
            const reason = prompt(`ุฃุฏุฎู ุณุจุจ ุญุธุฑ ${username} ูู ุงููููุน ุจุงููุงูู:`);
            if (reason !== null) {
                socket.emit('ban from site', { username, reason, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        function handleProfileUnbanSite(username) {
            if (confirm(`ูู ุชุฑูุฏ ุฅูุบุงุก ุญุธุฑ ุงููุณุชุฎุฏู ${username} ูู ุงููููุน ุจุงููุงููุ`)) {
                socket.emit('unban from site', { username, currentUser });
            }
            document.getElementById('profileActionMenu')?.classList.add('hidden');
        }

        // ุฏูุงู ุชุนุฏูู ุงููุนูููุงุช ุงูุดุฎุตูุฉ
        function updateBioCharCount() {
            const bioInput = document.getElementById('profileBioInput');
            const charCounter = document.getElementById('bioCharCounter');
            const currentLength = bioInput.value.length;
            const maxLength = 500;
            charCounter.textContent = `${currentLength} / ${maxLength}`;
            if (currentLength > maxLength) {
                charCounter.classList.add('text-red-500');
                charCounter.classList.remove('text-gray-400');
            } else {
                charCounter.classList.remove('text-red-500');
                charCounter.classList.add('text-gray-400');
            }
        }

        function toggleBioEdit(isEditing) {
            const bioText = document.getElementById('profileBio');
            const bioInput = document.getElementById('profileBioInput');
            const editButton = document.getElementById('editBioButton');
            const saveButton = document.getElementById('saveBioButton');
            const cancelButton = document.getElementById('cancelBioButton');
            const charCounter = document.getElementById('bioCharCounter');

            if (isEditing) {
                bioText.classList.add('hidden');
                bioInput.classList.remove('hidden');
                charCounter.classList.remove('hidden');
                editButton.classList.add('hidden');
                saveButton.classList.remove('hidden');
                cancelButton.classList.remove('hidden');
                bioInput.value = bioText.textContent === 'ูุง ุชูุฌุฏ ูุนูููุงุช ูุนุฑุถูุง.' ? '' : bioText.textContent;
                updateBioCharCount();
                bioInput.focus();
            } else {
                bioText.classList.remove('hidden');
                bioInput.classList.add('hidden');
                charCounter.classList.add('hidden');
                editButton.classList.remove('hidden');
                saveButton.classList.add('hidden');
                cancelButton.classList.add('hidden');
            }
        }

        function saveBio() {
            const newBio = document.getElementById('profileBioInput').value.trim();
            if (newBio.length > 500) {
                showNotification('ุงููุนูููุงุช ุงูุดุฎุตูุฉ ูุฌุจ ุฃู ูุง ุชุชุฌุงูุฒ 500 ุญุฑู.', 'error');
                return;
            }
            socket.emit('update user bio', { username: currentUser.name, bio: newBio, currentUser });
        }

        socket.on('bio success', (message) => {
            showNotification(message, 'success');
            const newBio = document.getElementById('profileBioInput').value.trim();
            document.getElementById('profileBio').textContent = newBio || 'ูุง ุชูุฌุฏ ูุนูููุงุช ูุนุฑุถูุง.';
            toggleBioEdit(false);
        });

        socket.on('bio error', (error) => {
            showNotification(error, 'error');
        });

        function startPrivateChat() {
            const privateChatButton = document.getElementById('privateChatButton');
            const username = privateChatButton.getAttribute('data-username');
            
            if (!username) return;
            
            closeProfileModal();
            openPrivateChat(username);
        }

/* --- ุฏุงูุฉ ูุญุณููุฉ ูุฌุนู ุงูุนูุงุตุฑ ูุงุจูุฉ ููุณุญุจ (ุชุฏุนู ุงูููุณ ูุงููุฃุฑุฉ) --- */
function makeDraggable(element, handle) {
    let active = false;
    let currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;

    const dragStart = (e) => {
        e = e || window.event;
        if (e.type === 'touchstart') {
            initialX = e.touches[0].clientX - xOffset;
            initialY = e.touches[0].clientY - yOffset;
        } else {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
        }

        if (e.target === handle || handle.contains(e.target)) {
            active = true;
        }
    };

    const dragEnd = () => {
        initialX = currentX;
        initialY = currentY;
        active = false;
    };

    const drag = (e) => {
        if (!active) return;
        e = e || window.event;
        e.preventDefault();

        if (e.type === 'touchmove') {
            currentX = e.touches[0].clientX - initialX;
            currentY = e.touches[0].clientY - initialY;
        } else {
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;
        }

        xOffset = currentX;
        yOffset = currentY;

        requestAnimationFrame(() => {
            element.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
        });
    };

    // ุฅุถุงูุฉ ูุณุชูุนู ุงูุฃุญุฏุงุซ
    const parent = element.parentElement;
    parent.addEventListener('touchstart', dragStart, false);
    parent.addEventListener('touchend', dragEnd, false);
    parent.addEventListener('touchmove', drag, { passive: false });
    parent.addEventListener('mousedown', dragStart, false);
    parent.addEventListener('mouseup', dragEnd, false);
    parent.addEventListener('mousemove', drag, { passive: false });
}

       function openPrivateChat(username) {
    privateChatTarget = username;
    const modal = document.getElementById('privateChatModal');
    const avatar = document.getElementById('privateChatAvatar');
    const usernameElem = document.getElementById('privateChatUsername');
    const statusElem = document.getElementById('privateChatStatus');
    const statusDot = statusElem.querySelector('.w-2');
    const statusText = statusElem.querySelector('span:last-child');
    
    // ุงุณุชุฎุฏุงู userAvatars ุจุฏูุงู ูู userAvatars (ุชู ุชุตุญูุญ ุงูุฎุทุฃ ุงูุฅููุงุฆู)
    const avatarUrl = userAvatars[username] || null;
    avatar.src = avatarUrl || defaultAvatars.guest;
    avatar.onerror = function() {
        this.src = defaultAvatars.guest;
    };
    
    usernameElem.textContent = username;
    
    // ุชูุฑูุบ ุนุฏุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ ููุฐุง ุงููุณุชุฎุฏู
    if (unreadPrivateMessages[username]) {
        delete unreadPrivateMessages[username];
        updateUnreadBadges();
    }
    
    // ุฅุธูุงุฑ ุงููุงูุฐุฉ
    modal.classList.add('show');
    
    // ุชุญููู ุณุฌู ุงููุญุงุฏุซุฉ
    socket.emit('get private messages', {
        otherUser: username,
        currentUser: currentUser.name
    });

    // ุฌุนู ุงููุงูุฐุฉ ูุงุจูุฉ ููุณุญุจ
    const header = document.querySelector('#privateChatModal .private-chat-header');
    makeDraggable(modal, header);
}

        function closePrivateChat() {
            document.getElementById('privateChatModal').classList.remove('show');
            privateChatTarget = null;
        }

        function sendPrivateMessage() {
            if (!privateChatTarget) return;
            
            const input = document.getElementById('privateMessageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            socket.emit('send private message', {
                toUser: privateChatTarget,
                message: message,
                fromUser: currentUser.name
            });
            
            input.value = '';
        }

        function handlePrivateKeyPress(event) {
            if (event.key === 'Enter') {
                sendPrivateMessage();
            }
        }

        function addPrivateMessageToChat(message, isOwn) {
    const container = document.getElementById('privateChatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-4 flex ${isOwn ? 'justify-end' : 'justify-start'}`;
    
    messageDiv.innerHTML = `
        <div class="max-w-xs px-4 py-3 rounded-xl ${
            isOwn
                ? 'bg-blue-600 text-white'
                : 'bg-white/20 text-white'
        }">
            <div class="font-semibold text-sm mb-1">${isOwn ? 'ุฃูุช' : message.from}</div>
            <div class="text-sm">${message.content}</div>
            <div class="text-xs opacity-70 mt-1 text-left">${message.time}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

        // ูุธููุฉ ูุนุฑุถ ุงูุฅุดุนุงุฑุงุช
        function showNotification(message, type = 'info') {
            const notificationsContainer = document.getElementById('globalNotifications');
            const notification = document.createElement('div');
            
            let bgColor = 'bg-blue-600';
            if (type === 'error') bgColor = 'bg-red-600';
            if (type === 'success') bgColor = 'bg-green-600';
            if (type === 'warning') bgColor = 'bg-yellow-600';
            
            notification.className = `${bgColor} text-white p-4 rounded-lg shadow-lg notification`;
            notification.innerHTML = `
                <div class="flex items-center space-x-3 space-x-reverse">
                    <span class="text-lg">${type === 'success' ? 'โ' : type === 'error' ? 'โ' : 'โน๏ธ'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            notificationsContainer.appendChild(notification);
            
            // ุฅุฒุงูุฉ ุงูุฅุดุนุงุฑ ุชููุงุฆูุงู ุจุนุฏ 5 ุซูุงูู
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // ูุธููุฉ ูุชูุฑูุฑ ุงููุญุงุฏุซุฉ ุฅูู ุฃุญุฏุซ ุฑุณุงูุฉ
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }
        // ุงุณุชูุจุงู ุญุฏุซ ุงูุชุฑููุฉ
socket.on('level up', (data) => {
  showNotification(`๐ ููุฏ ุงุฑุชูุช ุฅูู ุงููุณุชูู ${data.level}! ุงุณุชูุฑ ูู ุงููุญุงุฏุซุฉ ูุชุฑุชูู ุฃูุซุฑ!`, 'success');
});

function updateChatMessagesBadge() {
    const badge = document.getElementById('chatMessagesBadge');
    
    if (badge) {
        // ุญุณุงุจ ุฅุฌูุงูู ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ ูู ุฌููุน ุงูุฃุตุฏูุงุก
        let totalUnread = 0;
        for (const username in unreadPrivateMessages) {
            totalUnread += unreadPrivateMessages[username];
        }
        
        // ุฅุถุงูุฉ ุทูุจุงุช ุงูุตุฏุงูุฉ ุฅูู ุงูุนุฏุฏ ุงูุฅุฌูุงูู
        totalUnread += friendRequests.length;
        
        if (totalUnread > 0) {
            badge.textContent = totalUnread;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
}
// ุญุฏุซ ุงูููุฑ ุนูู ุฒุฑ ุงูุฅุดุนุงุฑุงุช ูู ูุงุฌูุฉ ุงููุญุงุฏุซุฉ
document.getElementById('chatMessagesButton')?.addEventListener('click', toggleNotificationsDropdown);

document.getElementById('chatFriendsButton')?.addEventListener('click', () => {
    openFriendsSidebar();
});

function openPostsSidebar() {
    document.getElementById('postsSidebar').classList.add('show');
    document.getElementById('postsOverlay').classList.add('show');
    loadPosts();
}

function closePostsSidebar() {
    document.getElementById('postsSidebar').classList.remove('show');
    document.getElementById('postsOverlay').classList.remove('show');
}

function createNewPost() {
    const content = document.getElementById('newPostContent').value.trim();
    if (!content) {
        showNotification('ูุฑุฌู ูุชุงุจุฉ ูุญุชูู ููููุดูุฑ', 'error');
        return;
    }
    socket.emit('create post', {
        content: content,
        username: currentUser.name
    });
    document.getElementById('newPostContent').value = '';
}

function loadPosts() {
    socket.emit('get posts');
}

function displayPosts(posts, prepend = false) {
    const container = document.getElementById('postsList');
    if (!prepend) {
        container.innerHTML = '';
    }

    if (posts.length === 0 && !prepend) {
        container.innerHTML = '<p class="text-blue-200 text-sm text-center">ูุง ุชูุฌุฏ ููุดูุฑุงุช ุจุนุฏ.</p>';
        return;
    }

    const postsHtml = posts.map(post => {
        // ุญุณุงุจ ููุช ุงููุดุฑ
        const timeAgo = getTimeAgo(new Date(post.timestamp));
        const isLiked = post.likes && post.likes.includes(currentUser.name);

        return `
            <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700" id="post-card-${post.id}">
                <!-- Post Header -->
                <div class="flex items-center space-x-3 space-x-reverse mb-4">
                    <img src="${post.avatar || defaultAvatars.guest}" class="w-11 h-11 rounded-full object-cover cursor-pointer border-2 border-slate-600" onclick="showUserProfileModal('${post.username}')" alt="${post.username}">
                    <div class="flex-1">
                        <p class="font-semibold text-white cursor-pointer" onclick="showUserProfileModal('${post.username}')">${post.username}</p>
                        <p class="text-xs text-slate-400">${timeAgo}</p>
                    </div>
                    ${post.username === currentUser.name ? `
                        <button onclick="deletePost(${post.id})" class="text-slate-400 hover:text-red-500 transition-colors" title="ุญุฐู ุงูููุดูุฑ">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    ` : ''}
                </div>

                <!-- Post Content -->
                <p class="text-slate-200 text-sm mb-4 whitespace-pre-wrap">${post.content}</p>

                <!-- Post Actions -->
                <div class="flex items-center justify-between text-slate-400 border-t border-slate-700 pt-2">
                    <button id="like-btn-${post.id}" onclick="likePost(${post.id})" class="flex items-center space-x-2 space-x-reverse hover:text-pink-500 transition-colors ${isLiked ? 'text-pink-500' : ''}">
                        <svg class="w-5 h-5" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z"></path>
                        </svg>
                        <span id="like-count-${post.id}">${post.likes ? post.likes.length : 0}</span>
                    </button>
                    <button onclick="toggleComments(${post.id})" class="flex items-center space-x-2 space-x-reverse hover:text-blue-400 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <span id="comment-count-${post.id}">${post.comments ? post.comments.length : 0}</span>
                    </button>
                </div>

                <!-- Comments Section -->
                <div id="comments-section-${post.id}" class="hidden mt-4 pt-3 border-t border-slate-700">
                    <div id="comments-list-${post.id}" class="space-y-3 mb-3 max-h-60 overflow-y-auto custom-scrollbar">
                        ${post.comments ? post.comments.map(comment => `
                            <div class="bg-slate-700/50 rounded-lg p-3 text-sm">
                                <div class="flex items-center space-x-2 space-x-reverse mb-1">
                                    <p class="font-semibold text-blue-300">${comment.username}</p>
                                    <p class="text-xs text-slate-400">${new Date(comment.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}</p>
                                </div>
                                <p class="text-slate-300">${comment.content}</p>
                            </div>
                        `).join('') : ''}
                    </div>
                    <div class="flex space-x-2 space-x-reverse mt-2">
                        <input type="text" id="comment-input-${post.id}" placeholder="ุงูุชุจ ุชุนูููู..." class="flex-1 bg-slate-700 border border-slate-600 rounded-full px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" onkeypress="if(event.key === 'Enter') addComment(${post.id})">
                        <button onclick="addComment(${post.id})" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-full transition-colors text-sm">
                            ุฅุฑุณุงู
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    if (prepend) {
        container.insertAdjacentHTML('afterbegin', postsHtml);
    } else {
        container.innerHTML = postsHtml;
    }
}

function likePost(postId) {
    socket.emit('like post', {
        postId: postId,
        username: currentUser.name
    });
}

function toggleComments(postId) {
    const commentsSection = document.getElementById(`comments-section-${postId}`);
    commentsSection.classList.toggle('hidden');
    if (!commentsSection.classList.contains('hidden')) {
        document.getElementById(`comment-input-${postId}`).focus();
    }
}

function addComment(postId) {
    const commentInput = document.getElementById(`comment-input-${postId}`);
    const content = commentInput.value.trim();
    
    if (!content) {
        showNotification('ูุฑุฌู ูุชุงุจุฉ ุชุนููู', 'error');
        return;
    }
    
    socket.emit('add comment', {
        postId: postId,
        username: currentUser.name,
        content: content
    });
    commentInput.value = '';
}

function deletePost(postId) {
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูููุดูุฑุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.')) {
        socket.emit('delete post', {
            postId: postId,
            username: currentUser.name
        });
    }
}

function getTimeAgo(date) {
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000); 
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (days > 0) return `ููุฐ ${days} ููู`;
    if (hours > 0) return `ููุฐ ${hours} ุณุงุนุฉ`;
    if (minutes > 0) return `ููุฐ ${minutes} ุฏูููุฉ`;
    return 'ุงูุขู';
}

// ุฃุญุฏุงุซ ุงูุณูููุช ููููุดูุฑุงุช
socket.on('posts data', (posts) => {
    displayPosts(posts);
});

socket.on('new post', (newPost) => {
    showNotification(`ููุดูุฑ ุฌุฏูุฏ ูู ${newPost.username}`, 'info');
    // ุฅุถุงูุฉ ุงูููุดูุฑ ุงูุฌุฏูุฏ ูู ุงูุฃุนูู ุจุฏูุงู ูู ุฅุนุงุฏุฉ ุงูุชุญููู
    const container = document.getElementById('postsList');
    if (container.querySelector('p')) { // ุฅุฐุง ูุงูุช ููุงู ุฑุณุงูุฉ "ูุง ุชูุฌุฏ ููุดูุฑุงุช"
        container.innerHTML = '';
    }
    displayPosts([newPost], true);
});

socket.on('post liked', ({ postId, likes }) => {
    const likeCountElem = document.getElementById(`like-count-${postId}`);
    const likeBtnElem = document.getElementById(`like-btn-${postId}`);
    
    if (likeCountElem && likeBtnElem) {
        likeCountElem.textContent = likes.length;
        const isLiked = likes.includes(currentUser.name);
        likeBtnElem.classList.toggle('text-pink-500', isLiked);
        likeBtnElem.querySelector('svg').setAttribute('fill', isLiked ? 'currentColor' : 'none');
    }
});

socket.on('comment added', ({ postId, username, content, timestamp }) => {
    const commentsList = document.getElementById(`comments-list-${postId}`);
    const commentCountElem = document.getElementById(`comment-count-${postId}`);

    if (commentsList && commentCountElem) {
        const newComment = document.createElement('div');
        newComment.className = 'bg-slate-700/50 rounded-lg p-3 text-sm';
        newComment.innerHTML = `
            <div class="flex items-center space-x-2 space-x-reverse mb-1">
                <p class="font-semibold text-blue-300">${username}</p>
                <p class="text-xs text-slate-400">${new Date(timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}</p>
            </div>
            <p class="text-slate-300">${content}</p>
        `;
        commentsList.appendChild(newComment);
        commentsList.scrollTop = commentsList.scrollHeight; // ุชูุฑูุฑ ูุฃุณูู
        commentCountElem.textContent = parseInt(commentCountElem.textContent) + 1;
    }
});

socket.on('post deleted', ({ postId }) => {
    document.getElementById(`post-card-${postId}`)?.remove();
});

socket.on('post delete success', (message) => {
    showNotification(message, 'success');
});

socket.on('post delete error', (error) => {
    showNotification(error, 'error');
});
// ุฅุถุงูุฉ ูุณุชูุนู ุงูุฃุญุฏุงุซ ููุฃุฒุฑุงุฑ ุงูุฌุฏูุฏุฉ
document.getElementById('postsButton').addEventListener('click', openPostsSidebar);

document.getElementById('chatPostsButton')?.addEventListener('click', openPostsSidebar);
document.getElementById('chatFriendsButton')?.addEventListener('click', openFriendsSidebar);
document.getElementById('chatMessagesButton')?.addEventListener('click', togglePrivateConversationsDropdown);
document.getElementById('chatNotificationsButton')?.addEventListener('click', toggleNotificationsDropdown);

// --- ูุธุงู ุงูุฅุดุนุงุฑุงุช ุงูุฌุฏูุฏ ---

function togglePrivateConversationsDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('privateConversationsDropdown');
    const otherDropdown = document.getElementById('chatNotificationsDropdown');
    const isHidden = dropdown.classList.contains('hidden');
 
    // ุชุจุฏูู ุญุงูุฉ ุงูุธููุฑ
    dropdown.classList.toggle('hidden');
 
    // ุฅุฐุง ุชู ูุชุญ ุงููุงุฆูุฉ ุงูุขู
    if (isHidden) {
        otherDropdown.classList.add('hidden'); // ุชุฃูุฏ ูู ุฅุบูุงู ุงููุงุฆูุฉ ุงูุฃุฎุฑู
        socket.emit('get private conversations', currentUser.name); // ุงุทูุจ ุงููุญุงุฏุซุงุช ูู ุงูุณูุฑูุฑ
    }
}

// ุฅุบูุงู ุงููุงุฆูุฉ ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
document.addEventListener('click', function (e) {
    const privateDropdown = document.getElementById('privateConversationsDropdown');
    const privateButton = document.getElementById('chatMessagesButton');
    if (privateDropdown && !privateDropdown.contains(e.target) && !privateButton.contains(e.target)) {
        privateDropdown.classList.add('hidden');
    }

    const dropdown = document.getElementById('chatNotificationsDropdown');
    const button = document.getElementById('chatNotificationsButton');
    if (dropdown && !dropdown.contains(e.target) && !button.contains(e.target)) {
        dropdown.classList.add('hidden');
    }
});

function updateNotificationsBadge(hasUnread) {
    const badge = document.getElementById('chatNotificationsBadge');
    if (badge) {
        badge.classList.toggle('hidden', !hasUnread);
    }
}

function updateMessagesBadge(count) {
    const chatBadge = document.getElementById('chatMessagesBadge');
    if (chatBadge) {
        if (count > 0) {
            chatBadge.textContent = count;
            chatBadge.classList.remove('hidden');
        } else {
            chatBadge.classList.add('hidden');
        }
    }
}

socket.on('new notification', (notification) => {
    showNotification(`๐ ูุฏูู ุฅุดุนุงุฑ ุฌุฏูุฏ!`, 'info');
    socket.emit('get unread counts', currentUser.name);
});

socket.on('notifications list', (notifications) => {
    const container = document.getElementById('chatNotificationsList');
    container.innerHTML = '';
    const unreadCount = notifications.filter(n => !n.read).length;

    if (notifications.length === 0) {
        container.innerHTML = '<p class="text-blue-200 text-sm text-center p-4">ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช</p>';
        return;
    }

    notifications.forEach(notif => {
        const notifDiv = document.createElement('div');
        notifDiv.className = `p-2 text-sm rounded-md hover:bg-white/10 cursor-pointer ${!notif.read ? 'bg-blue-500/20' : ''}`;
        notifDiv.setAttribute('onclick', `goToPost(${notif.postId})`);

        let text = '';
        if (notif.type === 'like') {
            text = `๐ ุฃุนุฌุจ <strong class="text-white">${notif.senderUsername}</strong> ุจููุดูุฑู.`;
        } else if (notif.type === 'comment') {
            text = `๐ฌ ุนููู <strong class="text-white">${notif.senderUsername}</strong> ุนูู ููุดูุฑู.`;
        } else if (notif.type === 'new_post') {
            text = `โ๏ธ ูุดุฑ <strong class="text-white">${notif.senderUsername}</strong> ููุดูุฑุงู ุฌุฏูุฏุงู.`;
        }

        notifDiv.innerHTML = `<p class="text-blue-200">${text}</p>`;
        container.appendChild(notifDiv);
    });
});

socket.on('private conversations list', (conversations) => {
    const container = document.getElementById('privateConversationsList');
    container.innerHTML = '';
    let totalUnread = 0;

    if (conversations.length === 0) {
        container.innerHTML = '<p class="text-blue-200 text-sm text-center p-4">ูุง ุชูุฌุฏ ูุญุงุฏุซุงุช ุฎุงุตุฉ ุจุนุฏ.</p>';
        return;
    }

    conversations.forEach(conv => {
        const convDiv = document.createElement('div');
        const otherUser = conv.otherUser;
        const avatarUrl = userAvatars[otherUser] || defaultAvatars.guest;

        if (conv.unreadCount > 0) {
            totalUnread += conv.unreadCount;
        }

        convDiv.className = `flex items-center p-2 rounded-md cursor-pointer transition-colors ${conv.unreadCount > 0 ? 'bg-blue-500/20' : 'hover:bg-white/10'}`;
        convDiv.onclick = () => {
            openPrivateChat(otherUser);
            document.getElementById('privateConversationsDropdown').classList.add('hidden');
        };

        convDiv.innerHTML = `
            <div class="relative flex-shrink-0">
                <img src="${avatarUrl}" class="w-10 h-10 rounded-full object-cover" alt="${otherUser}">
                ${conv.isOnline ? '<span class="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full bg-green-500 border-2 border-slate-800"></span>' : ''}
            </div>
            <div class="flex-1 min-w-0 mx-3">
                <div class="flex justify-between items-center">
                    <p class="text-white font-semibold truncate">${otherUser}</p>
                </div>
                <div class="flex justify-between items-center">
                    <p class="text-blue-200 text-sm truncate">${conv.lastMessage.content}</p>
                    ${conv.unreadCount > 0 ? `<span class="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">${conv.unreadCount}</span>` : ''}
                </div>
            </div>
        `;
        container.appendChild(convDiv);
    });
});

socket.on('private conversations updated', () => {
    socket.emit('get unread counts', currentUser.name);
    // ุฅุฐุง ูุงูุช ุงููุงุฆูุฉ ููุชูุญุฉุ ูู ุจุชุญุฏูุซูุง
    if (!document.getElementById('privateConversationsDropdown').classList.contains('hidden')) {
        socket.emit('get private conversations', currentUser.name);
    }
});

socket.on('unread counts data', (counts) => {
    updateMessagesBadge(counts.privateMessages);
    updateNotificationsBadge(counts.notifications > 0);
});

function toggleNotificationsDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('chatNotificationsDropdown');
    const otherDropdown = document.getElementById('privateConversationsDropdown');
    const isHidden = dropdown.classList.contains('hidden');

    otherDropdown.classList.add('hidden'); // ุฅุฎูุงุก ูุงุฆูุฉ ุงูุฑุณุงุฆู ุฏุงุฆูุงู

    if (isHidden) {
        socket.emit('get notifications', currentUser.name);
        dropdown.classList.remove('hidden');
        setTimeout(() => {
            socket.emit('mark notifications as read', currentUser.name);
            updateNotificationsBadge(false);
        }, 2000);
    } else {
        dropdown.classList.add('hidden');
    }
}

function goToPost(postId) {
    // 1. ุฅุบูุงู ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช
    document.getElementById('chatNotificationsDropdown').classList.add('hidden');

    // 2. ูุชุญ ูุงุฆูุฉ ุงูููุดูุฑุงุช (ุณูุคุฏู ูุฐุง ุฅูู ุชุญููููุง)
    openPostsSidebar();

    // 3. ุงูุจุญุซ ุนู ุงูููุดูุฑ ูุชูุฑูุฑ ุงูุดุงุดุฉ ุฅููู ุจุนุฏ ูุชุฑุฉ ูุตูุฑุฉ ููุณูุงุญ ุจุงูุชุญููู
    setTimeout(() => {
        const postElement = document.getElementById(`post-card-${postId}`);
        if (postElement) {
            // ุงูุชูุฑูุฑ ุฅูู ุงูููุดูุฑ
            postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // ุชูููุฒ ุงูููุดูุฑ ุจููู ูุฎุชูู
            postElement.style.transition = 'background-color 0.5s ease';
            postElement.style.backgroundColor = 'rgba(59, 130, 246, 0.3)'; // ุชูููุฒ ุฃุฒุฑู

            // ุฅุฒุงูุฉ ุงูุชูููุฒ ุจุนุฏ ูุชุฑุฉ
            setTimeout(() => {
                postElement.style.backgroundColor = '';
            }, 2500);
        } else {
            showNotification('ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุดูุฑุ ูุฏ ูููู ูุฏููุงู.', 'warning');
        }
    }, 500); // ุงูุชุธุงุฑ ูุตู ุซุงููุฉ ููุณูุงุญ ุจุชุญููู ุงูููุดูุฑุงุช
}

// ุฏูุงู ูุงุฆูุฉ ุงููุชูุงุนููู
function openTopUsersModal() {
    const modal = document.getElementById('topUsersModal');
    const overlay = document.getElementById('topUsersOverlay');
    modal.classList.add('show');
    overlay.classList.add('show');
    
    // ุทูุจ ุงูุจูุงูุงุช ูู ุงูุณูุฑูุฑ
    socket.emit('get top users');
}

function closeTopUsersModal() {
    const modal = document.getElementById('topUsersModal');
    const overlay = document.getElementById('topUsersOverlay');
    modal.classList.remove('show');
    overlay.classList.remove('show');
    
    // ุฅุนุงุฏุฉ ุชุนููู ุงููุญุชูู ุฅูู ุญุงูุฉ ุงูุชุญููู
    const container = document.getElementById('topUsersListContainer');
    container.innerHTML = `
        <div class="text-center text-blue-200 p-8">
            <div class="spinner mx-auto"></div>
            <p class="mt-2">ุฌุงุฑู ุชุญููู ุงููุงุฆูุฉ...</p>
        </div>
    `;
}

socket.on('top users list', (users) => {
    const container = document.getElementById('topUsersListContainer');
    container.innerHTML = '';

    if (users.length === 0) {
        container.innerHTML = '<p class="text-blue-200 text-center p-8">ูุง ููุฌุฏ ูุชูุงุนููู ูุนุฑุถูู ุจุนุฏ.</p>';
        return;
    }

    users.forEach((user, index) => {
        const userDiv = document.createElement('div');
        userDiv.className = 'flex items-center bg-white/5 p-3 rounded-lg hover:bg-white/10 transition-colors cursor-pointer';
        userDiv.onclick = () => showUserProfileModal(user.username);

        userDiv.innerHTML = `
            <div class="flex-shrink-0 w-10 text-center text-xl font-bold ${index < 3 ? 'text-yellow-400' : 'text-blue-300'}">${index + 1}</div>
            ${user.avatar ? 
                `<img src="${user.avatar}" class="w-10 h-10 rounded-full object-cover" alt="${user.username}">` :
                `<div class="w-10 h-10 rounded-full bg-gray-500 flex items-center justify-center text-white font-bold">${user.username.charAt(0).toUpperCase()}</div>`
            }
            <div class="flex-1 min-w-0 mx-3">
                <div class="text-white font-semibold truncate">${user.username}</div>
                <div class="text-xs text-blue-200">๐ ุงููุณุชูู ${user.level}</div>
            </div>
            <div class="text-yellow-400 font-bold text-sm">โญ ${user.points}</div>
        `;
        container.appendChild(userDiv);
    });
});

document.getElementById('chatPostsButton').addEventListener('click', openPostsSidebar);
        
        // ุฅุถุงูุฉ ูุฐู ุงูุฏูุงู ูู ูุณู JavaScript

// ุฏูุงู ุฅุฏุงุฑุฉ ุฎูููุฉ ุงููููุน
function showBackgroundModal() {
    document.getElementById('backgroundModal').classList.add('show');
}

function closeBackgroundModal() {
    document.getElementById('backgroundModal').classList.remove('show');
}

function selectBackground(type, value) {
    // ุฅุฒุงูุฉ ุงูุชุญุฏูุฏ ูู ุฌููุน ุงูุฎูุงุฑุงุช
    document.querySelectorAll('.bg-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // ุฅุถุงูุฉ ุงูุชุญุฏูุฏ ููุฎูุงุฑ ุงููุญุฏุฏ
    event.currentTarget.classList.add('selected');
    
    // ุญูุธ ุงูุฎูููุฉ ุงููุฎุชุงุฑุฉ ูุคูุชุงู
    window.tempBackground = {
        type: type,
        value: value
    };
}

function handleBackgroundUpload() {
    const fileInput = document.getElementById('backgroundUpload');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        showNotification('ูุฑุฌู ุงุฎุชูุงุฑ ููู ุตูุฑุฉ ููุท', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        // ุญูุธ ุงูุฎูููุฉ ุงููุฎุชุงุฑุฉ ูุคูุชุงู
        window.tempBackground = {
            type: 'image',
            value: e.target.result
        };
        
        showNotification('ุชู ุชุญููู ุงูุตูุฑุฉ ุจูุฌุงุญุ ุงุถุบุท ุญูุธ ููุชุทุจูู', 'success');
    };
    reader.readAsDataURL(file);
}

function applyUrlBackground() {
    const url = document.getElementById('backgroundUrl').value.trim();
    
    if (!url) {
        showNotification('ูุฑุฌู ุฅุฏุฎุงู ุฑุงุจุท ุงูุตูุฑุฉ', 'error');
        return;
    }
    
    // ุงูุชุญูู ูู ุฃู ุงูุฑุงุจุท ูุดูุฑ ุฅูู ุตูุฑุฉ
    if (!url.match(/\.(jpeg|jpg|gif|png|webp|svg)(\?.*)?$/i)) {
        showNotification('ูุฑุฌู ุฅุฏุฎุงู ุฑุงุจุท ุตูุฑุฉ ุตุงูุญ', 'error');
        return;
    }
    
    // ุญูุธ ุงูุฎูููุฉ ุงููุฎุชุงุฑุฉ ูุคูุชุงู
    window.tempBackground = {
        type: 'image',
        value: url
    };
    showNotification('ุชู ุชุญููู ุงูุฑุงุจุท ุจูุฌุงุญุ ุงุถุบุท ุญูุธ ููุชุทุจูู', 'success');
}

function saveBackground() {
    if (!window.tempBackground) {
        showNotification('ูุฑุฌู ุงุฎุชูุงุฑ ุฎูููุฉ ุฃููุงู', 'error');
        return;
    }
    
    // ุฅุฑุณุงู ุงูุฎูููุฉ ุฅูู ุงูุณูุฑูุฑ
    socket.emit('update site background', {
        backgroundType: window.tempBackground.type,
        backgroundValue: window.tempBackground.value,
        currentUser: currentUser
    });
    
    // ุฅุบูุงู ุงููุงูุฐุฉ
    closeBackgroundModal();
}

function applyBackground(backgroundData) {
    const body = document.body;
    
    console.log('ุชุทุจูู ุงูุฎูููุฉ:', backgroundData);
    
    if (!backgroundData) {
        // ุงุณุชุฎุฏุงู ุงูุฎูููุฉ ุงูุงูุชุฑุงุถูุฉ ุฅุฐุง ูู ุชูุฌุฏ ุจูุงูุงุช
        backgroundData = {
            type: 'gradient',
            value: 'from-purple-900 via-blue-900 to-indigo-900'
        };
    }
    
    // ุฅุฒุงูุฉ ุฌููุน ูุฆุงุช ุงูุฎูููุฉ ุงูููุฌูุฏุฉ
    const gradientClasses = [
        'from-purple-900', 'via-blue-900', 'to-indigo-900',
        'from-green-900', 'to-purple-900',
        'from-pink-900', 'via-red-900', 'to-orange-900',
        'from-teal-900', 'via-cyan-900', 'to-blue-900',
        'from-yellow-900', 'via-orange-900', 'to-red-900',
        'from-indigo-900', 'via-purple-900', 'to-pink-900'
    ];
    
    gradientClasses.forEach(className => {
        body.classList.remove(className);
    });
    
    // ุฅุฒุงูุฉ ุฎูููุฉ ุงูุตูุฑุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
    body.style.backgroundImage = '';
    body.style.backgroundSize = '';
    body.style.backgroundRepeat = '';
    body.style.backgroundAttachment = '';
    body.style.backgroundPosition = '';
    
    // ุฅุฒุงูุฉ ุงูุทุจูุฉ ุงูุดูุงูุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
    const existingOverlay = document.getElementById('background-overlay');
    if (existingOverlay) {
        existingOverlay.remove();
    }
    
    // ุชุทุจูู ุงูุฎูููุฉ ุงูุฌุฏูุฏุฉ
    if (backgroundData.type === 'image') {
        // ุฅุฐุง ูุงูุช ุตูุฑุฉ
        body.style.backgroundImage = `url('${backgroundData.value}')`;
        body.style.backgroundSize = 'cover';
        body.style.backgroundRepeat = 'no-repeat';
        body.style.backgroundAttachment = 'fixed';
        body.style.backgroundPosition = 'center';
        
        // ุฅุถุงูุฉ ุทุจูุฉ ุดูุงูุฉ ููู ุงูุฎูููุฉ ูุชุญุณูู ูุฑุงุกุฉ ุงููุต
        const overlay = document.createElement('div');
        overlay.id = 'background-overlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: -1;
            pointer-events: none;
        `;
        body.appendChild(overlay);
        
    } else {
        // ุฅุฐุง ูุงูุช ุชุฏุฑุฌ ูููู
        body.classList.add('bg-gradient-to-br');
        const gradientClasses = backgroundData.value.split(' ');
        gradientClasses.forEach(className => {
            body.classList.add(className);
        });
    }
    
    console.log('ุชู ุชุทุจูู ุงูุฎูููุฉ ุจูุฌุงุญ');
}
// ุฅุธูุงุฑ ุฒุฑ ุชุบููุฑ ุงูุฎูููุฉ ููุท ูุตุงุญุจ ุงููููุน
function toggleBackgroundButton() {
    const isSiteOwner = currentUser && currentUser.name === "Walid dz 31";
    
    const mainBtn = document.getElementById('changeBackgroundBtn');
    const chatBtn = document.getElementById('chatChangeBackgroundBtn');
    
    if (mainBtn) mainBtn.classList.toggle('hidden', !isSiteOwner);
    if (chatBtn) chatBtn.classList.toggle('hidden', !isSiteOwner);
}

// ุงุณุชูุจุงู ุฃุญุฏุงุซ ุงูุฎูููุฉ ูู ุงูุณูุฑูุฑ
socket.on('site background data', (backgroundData) => {
    console.log('ุชู ุงุณุชูุจุงู ุฎูููุฉ ุงููููุน:', backgroundData);
    applyBackground(backgroundData);
});

socket.on('site background updated', (backgroundData) => {
    console.log('ุชู ุชุญุฏูุซ ุฎูููุฉ ุงููููุน:', backgroundData);
    applyBackground(backgroundData);
    showNotification('ุชู ุชุญุฏูุซ ุฎูููุฉ ุงููููุน', 'success');
});

socket.on('background success', (message) => {
    showNotification(message, 'success');
});

socket.on('background error', (error) => {
    showNotification(error, 'error');
});

// ุทูุจ ุงูุฎูููุฉ ุนูุฏ ุงูุงุชุตุงู
socket.on('connect', () => {
    socket.emit('get site background');

    
    // ุฅุถุงูุฉ ูุณุชูุนู ุงูุฃุญุฏุงุซ ูุฃุฒุฑุงุฑ ุชุบููุฑ ุงูุฎูููุฉ
    document.getElementById('changeBackgroundBtn')?.addEventListener('click', showBackgroundModal);
    document.getElementById('chatChangeBackgroundBtn')?.addEventListener('click', showBackgroundModal);
    
    // ุนูุฏ ุชุณุฌูู ุงูุฏุฎููุ ุงูุชุญูู ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุตุงุญุจ ุงููููุน
    socket.on('login success', (userData) => {
        currentUser = userData;
        toggleBackgroundButton();
    });
    
    socket.on('register success', (userData) => {
        currentUser = userData;
        toggleBackgroundButton();
    });
    
    socket.on('session valid', (userData) => {
        currentUser = userData;
        toggleBackgroundButton();
    });
});
// ุฏูุงู ุฅุฑุณุงู ุงูุตูุฑ
function openImageUpload() {
    document.getElementById('imageUpload').click();
}

function openPrivateImageUpload() {
    document.getElementById('privateImageUpload').click();
}

// ูุนุงูุฌุฉ ุชุญููู ุงูุตูุฑ ูููุญุงุฏุซุฉ ุงูุนุงูุฉ
document.getElementById('imageUpload').addEventListener('change', function(e) {
    handleImageUpload(e, 'public');
});

// ูุนุงูุฌุฉ ุชุญููู ุงูุตูุฑ ูููุญุงุฏุซุฉ ุงูุฎุงุตุฉ
document.getElementById('privateImageUpload').addEventListener('change', function(e) {
    handleImageUpload(e, 'private');
});

// ูู ุฏุงูุฉ handleImageUploadุ ุชุฃูุฏ ูู ุฌุฒุก ุงููุญุงุฏุซุฉ ุงูุฎุงุตุฉ
function handleImageUpload(event, type) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        showNotification('ูุฑุฌู ุงุฎุชูุงุฑ ููู ุตูุฑุฉ ููุท', 'error');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showNotification('ุญุฌู ุงูุตูุฑุฉ ูุฌุจ ุฃู ูููู ุฃูู ูู 5MB', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const imageData = e.target.result;
        
        if (type === 'public') {
            socket.emit('send image message', {
                roomId: currentRoom.id,
                imageData: imageData,
                user: currentUser
            });
        } else {
            // ูููุญุงุฏุซุฉ ุงูุฎุงุตุฉ
            if (!privateChatTarget) {
                showNotification('ูุฑุฌู ูุชุญ ูุญุงุฏุซุฉ ุฎุงุตุฉ ุฃููุงู', 'error');
                return;
            }
            
            socket.emit('send private image', {
                toUser: privateChatTarget,
                imageData: imageData,
                fromUser: currentUser.name
            });
        }
        
        event.target.value = '';
    };
    
    reader.readAsDataURL(file);
}

// ูุนุงูุฌุฉ ูุตู ุงูุตูุฑ ูู ุญูู ุงููุต
function setupPasteHandler() {
    // ูููุญุงุฏุซุฉ ุงูุนุงูุฉ
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('paste', function(e) {
            handlePaste(e, 'public');
        });
    }
    
    // ูููุญุงุฏุซุฉ ุงูุฎุงุตุฉ
    const privateMessageInput = document.getElementById('privateMessageInput');
    if (privateMessageInput) {
        privateMessageInput.addEventListener('paste', function(e) {
            handlePaste(e, 'private');
        });
    }
}

function handlePaste(event, type) {
    const items = event.clipboardData?.items;
    if (!items) return;
    
    for (let item of items) {
        if (item.type.indexOf('image') !== -1) {
            event.preventDefault();
            
            const file = item.getAsFile();
            if (!file) return;
            
            // ุงูุชุญูู ูู ุญุฌู ุงูููู (5MB ูุญุฏ ุฃูุตู)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('ุญุฌู ุงูุตูุฑุฉ ูุฌุจ ุฃู ูููู ุฃูู ูู 5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                
                if (type === 'public') {
                    socket.emit('send image message', {
                        roomId: currentRoom.id,
                        imageData: imageData,
                        user: currentUser
                    });
                } else {
                    socket.emit('send private image', {
                        toUser: privateChatTarget,
                        imageData: imageData,
                        fromUser: currentUser.name
                    });
                }
            };
            
            reader.readAsDataURL(file);
            break;
        }
    }
}

// ุงุณุชูุจุงู ุฑุณุงุฆู ุงูุตูุฑ ูู ุงููุญุงุฏุซุฉ ุงูุนุงูุฉ
socket.on('new image message', (message) => {
    addImageMessageToChat(message.user, message.imageData, message.time, message.user === currentUser.name, message.rank, message.avatar);
});

// ุงุณุชูุจุงู ุฑุณุงุฆู ุงูุตูุฑ ูู ุงููุญุงุฏุซุฉ ุงูุฎุงุตุฉ
socket.on('new private image', (message) => {
    addPrivateImageMessage(message, message.from === currentUser.name);
});

socket.on('private image sent', (message) => {
    addPrivateImageMessage(message, true);
});

// ุฅุถุงูุฉ ุฑุณุงูุฉ ุตูุฑุฉ ุฅูู ุงููุญุงุฏุซุฉ ุงูุนุงูุฉ
// ุฅุถุงูุฉ ุฑุณุงูุฉ ุตูุฑุฉ ุฅูู ุงูุฏุฑุฏุดุฉ (ูุณุฎุฉ ูุฏูุฌุฉ)
function addImageMessageToChat(user, imageData, time, isOwn, userRank, avatarUrl, messageId = null) {
    const container = document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message flex ${isOwn ? 'justify-end' : 'justify-start'}`;
    // ุฅุฐุง ูู ููุฌุฏ messageIdุ ุฃูุดุฆ ูุงุญุฏ ูุคูุช
    // ุฅุฐุง ูู ููุฌุฏ messageIdุ ุฃูุดุฆ ูุงุญุฏ ูุคูุชุ ูุงุญุชูุธ ุจุฎุฑูุทุฉ ุชุฑุจุท ุงููุคูุช ุจุงูุญูููู
    // ุฏุงุฆูุงู ุงุณุชุฎุฏู messageId ุญูููู
    if (!messageId) {
        messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    messageDiv.setAttribute('data-message-id', messageId);
    
    let rankBadge = '';
    if (userRank) {
        const rankInfo = ranks[userRank];
        rankBadge = `
            <div class="inline-flex items-center space-x-1 space-x-reverse bg-gradient-to-r ${rankInfo.color} px-2 py-1 rounded-full text-xs font-bold text-white shadow-lg mb-1">
                <span>${rankInfo.icon}</span>
                <span>${userRank}</span>
            </div>
        `;
    }
    // ุฒุฑ ุงูุญุฐู: ูุธูุฑ ุฏุงุฆูุงู ููุงุฎุชุจุงุฑ
    let deleteBtn = '';
    if (messageId) {
        deleteBtn = `<button class=\"ml-2 text-red-400 hover:text-red-600 text-xs font-bold\" title=\"ุญุฐู ุงูุฑุณุงูุฉ\" onclick=\"deleteRoomMessage('${messageId}')\">๐๏ธ</button>`;
    }

    messageDiv.innerHTML = `
        <div class="max-w-xs lg:max-w-md px-3 py-2 rounded-2xl ${
            isOwn ? 'bg-blue-600 text-white ml-3' : 'bg-white/20 text-white mr-3'
        }">
            <div class="flex items-center space-x-2 space-x-reverse mb-1">
                ${avatarUrl ? 
                    `<img src="${avatarUrl}" class="w-6 h-6 rounded-full object-cover" alt="${user}" onclick="showUserProfileModal('${user}')" style="cursor:pointer">` :
                    `<div class="w-6 h-6 rounded-full bg-gray-400 flex items-center justify-center text-white" onclick="showUserProfileModal('${user}')" style="cursor:pointer">
                        ${user.charAt(0).toUpperCase()}
                    </div>`
                }
                <div>
                    ${rankBadge}
                    <div class="font-semibold text-sm ${isOwn ? 'text-blue-100' : 'text-blue-200'}" onclick="showUserProfileModal('${user}')" style="cursor:pointer">${user}</div>
                </div>
                ${deleteBtn}
            </div>
            <div class="mb-1">
                <img src="${imageData}" class="max-w-full h-auto rounded-lg cursor-pointer chat-image" onclick="openImageModal('${imageData}')" alt="ุตูุฑุฉ ูุญุงุฏุซุฉ">
            </div>
            <div class="text-xs opacity-70">${time}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}
// ุงุณุชูุจุงู ุญุฏุซ ุญุฐู ุงูุฑุณุงูุฉ ูู ุงูุณูุฑูุฑ
socket.on('room message deleted', ({ messageId }) => {
    // ุญุงูู ุญุฐู ุงูุฑุณุงูุฉ ุณูุงุก ุจุงููุนุฑู ุงูุญูููู ุฃู ุงููุคูุช
    let msgElem = document.querySelector(`[data-message-id="${messageId}"]`);
    if (!msgElem && window.tempMessageIdMap) {
        // ุงุจุญุซ ุนู ุฃู ูุนุฑู ูุคูุช ูุฑุชุจุท ุจูุฐุง ุงููุนุฑู
        for (const [tempId, realId] of Object.entries(window.tempMessageIdMap)) {
            if (realId === messageId) {
                msgElem = document.querySelector(`[data-message-id="${tempId}"]`);
                break;
            }
        }
    }
    if (msgElem) msgElem.remove();
});

// ุฏุงูุฉ ุญุฐู ุฑุณุงูุฉ ุบุฑูุฉ
function deleteRoomMessage(messageId) {
    if (!currentRoom || !currentUser) return;
    if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงูุฑุณุงูุฉุ')) return;
    socket.emit('delete room message', {
        roomId: currentRoom.id,
        messageId: messageId,
        currentUser: currentUser
    });
}

// ุฅุถุงูุฉ ุฑุณุงูุฉ ุตูุฑุฉ ุฅูู ุงููุญุงุฏุซุฉ ุงูุฎุงุตุฉ
function addPrivateImageMessage(message, isOwn) {
    const container = document.getElementById('privateChatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-4 flex ${isOwn ? 'justify-end' : 'justify-start'}`;
    
    messageDiv.innerHTML = `
        <div class="max-w-xs px-4 py-3 rounded-xl ${
            isOwn ? 'bg-blue-600 text-white' : 'bg-white/20 text-white'
        }">
            <div class="font-semibold text-sm mb-1">${isOwn ? 'ุฃูุช' : message.from}</div>
            <div class="mb-2">
                <img src="${message.imageData}" class="max-w-full h-auto rounded-lg cursor-pointer" onclick="openImageModal('${message.imageData}')" alt="ุตูุฑุฉ ูุญุงุฏุซุฉ">
            </div>
            <div class="text-xs opacity-70 mt-1 text-left">${message.time}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

// ูุงูุฐุฉ ุนุฑุถ ุงูุตูุฑุฉ ุจุดูู ููุจุฑ
function openImageModal(imageData) {
    // ุฅูุดุงุก ูุงูุฐุฉ ุนุฑุถ ุงูุตูุฑุฉ
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="relative max-w-4xl max-h-full">
            <button onclick="closeImageModal()" class="absolute -top-12 left-0 text-white text-2xl z-10">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <img src="${imageData}" class="max-w-full max-h-full object-contain" alt="ุตูุฑุฉ ููุจุฑุฉ">
        </div>
    `;
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeImageModal();
        }
    });
    
    document.body.appendChild(modal);
}

function closeImageModal() {
    const modal = document.querySelector('.fixed.inset-0.bg-black');
    if (modal) {
        modal.remove();
    }
}

// ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู ูุฅุถุงูุฉ ุฃุฒุฑุงุฑ ุงูุตูุฑ
function updateUIWithImageButtons() {
    // ุชุญุฏูุซ ูุงุฌูุฉ ุงููุญุงุฏุซุฉ ุงูุนุงูุฉ
    const messageInputContainer = document.getElementById('messageInputContainer');
    if (messageInputContainer && !messageInputContainer.querySelector('#imageButton')) {
        const imageButton = document.createElement('button');
        imageButton.id = 'imageButton';
        imageButton.innerHTML = '๐ผ๏ธ';
        imageButton.className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-full font-semibold transition-colors flex items-center space-x-2 space-x-reverse';
        imageButton.onclick = openImageUpload;
        imageButton.title = 'ุฅุฑุณุงู ุตูุฑุฉ';
        
        // ุฅุฏุฑุงุฌ ุงูุฒุฑ ูุจู ุฒุฑ ุงูุฅุฑุณุงู
        const sendButton = messageInputContainer.querySelector('button[onclick="sendMessage()"]');
        messageInputContainer.insertBefore(imageButton, sendButton);
    }
    
    // ุชุญุฏูุซ ูุงุฌูุฉ ุงููุญุงุฏุซุฉ ุงูุฎุงุตุฉ
    const privateChatInput = document.querySelector('.private-chat-input .flex');
    if (privateChatInput && !privateChatInput.querySelector('#privateImageButton')) {
        const privateImageButton = document.createElement('button');
        privateImageButton.id = 'privateImageButton';
        privateImageButton.innerHTML = '๐ผ๏ธ';
        privateImageButton.className = 'bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-full font-semibold transition-colors flex items-center space-x-2 space-x-reverse text-sm';
        privateImageButton.onclick = openPrivateImageUpload;
        privateImageButton.title = 'ุฅุฑุณุงู ุตูุฑุฉ';
        
        // ุฅุฏุฑุงุฌ ุงูุฒุฑ ูุจู ุฒุฑ ุงูุฅุฑุณุงู
        const privateSendButton = privateChatInput.querySelector('button[onclick="sendPrivateMessage()"]');
        privateChatInput.insertBefore(privateImageButton, privateSendButton);
    }
}
// ุชููุฆุฉ ููุฒุงุช ุงูุตูุฑ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
document.addEventListener('DOMContentLoaded', function() {
    // ุฅุนุฏุงุฏ ูุนุงูุฌ ุงููุตู
    setupPasteHandler();
    
    // ุชุญุฏูุซ ุงููุงุฌูุฉ ุจุฅุถุงูุฉ ุฃุฒุฑุงุฑ ุงูุตูุฑ
    setTimeout(updateUIWithImageButtons, 1000);
    
    // ุชุญุฏูุซ ุงููุงุฌูุฉ ุนูุฏ ูุชุญ ุงููุญุงุฏุซุฉ ุงูุฎุงุตุฉ
    const originalOpenPrivateChat = openPrivateChat;
    openPrivateChat = function(username) {
        originalOpenPrivateChat(username);
        setTimeout(updateUIWithImageButtons, 100);
    };
});

// ุชุญุฏูุซ ุงููุงุฌูุฉ ุนูุฏ ูุชุญ ุบุฑูุฉ ุงููุญุงุฏุซุฉ
const originalOpenChat = openChat;
openChat = function(roomId, roomName, icon) {
    originalOpenChat(roomId, roomName, icon);
    setTimeout(updateUIWithImageButtons, 100);
};


// ุฏุงูุฉ ูุชุญููู ุตูุฑุฉ ุฅุฐุง ูุงูุช ุบูุฑ ูุญููุฉ
function loadImageIfNeeded(imageData, callback) {
    // ุฅุฐุง ูุงูุช ุงูุตูุฑุฉ ููุฌูุฏุฉ ูู base64ุ ุงุณุชุฎุฏููุง ูุจุงุดุฑุฉ
    if (imageData && imageData.startsWith('data:image')) {
        callback(imageData);
        return;
    }
    
    // ุฅุฐุง ูุงูุช ุงูุตูุฑุฉ ูุฑุฌุนุงู (ูู ุญุงู ุงุณุชุฎุฏุงู ุชุฎุฒูู ูููุตู ููุตูุฑ)
    // ููููู ุฅุถุงูุฉ ููุทู ูุชุญููู ุงูุตูุฑุฉ ูู ุงูุณูุฑูุฑ ููุง
    console.log('ุชุญููู ุงูุตูุฑุฉ ูู ุงูุณูุฑูุฑ:', imageData);
    callback(imageData); // ุงุณุชุฎุฏู ุงูุจูุงูุงุช ููุง ูู ูุคูุชุงู
}

// ุชุญุฏูุซ ุฏุงูุฉ ุนุฑุถ ุงูุตูุฑ ูุชุฏุนู ุงูุชุญููู
function addImageMessageToChat(user, imageData, time, isOwn, userRank, avatarUrl) {
    const container = document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message flex ${isOwn ? 'justify-end' : 'justify-start'}`;
    
    let rankBadge = '';
    if (userRank) {
        const rankInfo = ranks[userRank];
        rankBadge = `
            <div class="inline-flex items-center space-x-1 space-x-reverse bg-gradient-to-r ${rankInfo.color} px-2 py-1 rounded-full text-xs font-bold text-white shadow-lg mb-1">
                <span>${rankInfo.icon}</span>
                <span>${userRank}</span>
            </div>
        `;
    }

    // ุงุณุชุฎุฏุงู ุตูุฑุฉ ูุคูุชุฉ ุฃุซูุงุก ุงูุชุญููู
    const loadingImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPua1i+ivleWbvuWDjzwvdGV4dD48L3N2Zz4=';
    
    messageDiv.innerHTML = `
        <div class="max-w-xs lg:max-w-md px-4 py-3 rounded-2xl ${
            isOwn ? 'bg-blue-600 text-white ml-4' : 'bg-white/20 text-white mr-4'
        }">
            <div class="flex items-center space-x-3 space-x-reverse mb-2">
                ${avatarUrl ? 
                    `<img src="${avatarUrl}" class="w-8 h-8 rounded-full object-cover" alt="${user}" onclick="showUserProfileModal('${user}')" style="cursor:pointer">` :
                    `<div class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-white" onclick="showUserProfileModal('${user}')" style="cursor:pointer">
                        ${user.charAt(0).toUpperCase()}
                    </div>`
                }
                <div>
                    ${rankBadge}
                    <div class="font-semibold text-sm ${isOwn ? 'text-blue-100' : 'text-blue-200'}" onclick="showUserProfileModal('${user}')" style="cursor:pointer">${user}</div>
                </div>
            </div>
            <div class="mb-2">
                <img src="${loadingImage}" data-src="${imageData}" class="max-w-full h-auto rounded-lg cursor-pointer chat-image" onclick="openImageModal('${imageData}')" alt="ุตูุฑุฉ ูุญุงุฏุซุฉ" onload="handleImageLoad(this)" onerror="handleImageError(this)">
            </div>
            <div class="text-xs opacity-70">${time}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    
    // ุชุญููู ุงูุตูุฑุฉ ุจุนุฏ ุฅุถุงูุชูุง ููDOM
    setTimeout(() => {
        loadImageIfNeeded(imageData, (finalImageData) => {
            const img = messageDiv.querySelector('img.chat-image');
            if (img) {
                img.src = finalImageData;
                img.setAttribute('onclick', `openImageModal('${finalImageData}')`);
            }
        });
    }, 100);
    
    container.scrollTop = container.scrollHeight;
}

// ุฏูุงู ูุนุงูุฌุฉ ุชุญููู ุงูุตูุฑ
function handleImageLoad(img) {
    img.style.opacity = '0';
    setTimeout(() => {
        img.style.transition = 'opacity 0.3s ease';
        img.style.opacity = '1';
    }, 50);
}

function handleImageError(img) {
    console.error('ูุดู ุชุญููู ุงูุตูุฑุฉ:', img.src);
    img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNjY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPua1i+ivleWksei0pTwvdGV4dD48L3N2Zz4=';
    img.alt = 'ูุดู ุชุญููู ุงูุตูุฑุฉ';
}

// ุถุบุท ุงูุตูุฑ ูุจู ุฅุฑุณุงููุง (ุงุฎุชูุงุฑู)
function compressImage(imageData, quality = 0.7, maxWidth = 800) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // ุญุณุงุจ ุงูุฃุจุนุงุฏ ุงูุฌุฏูุฏุฉ
      let width = img.width;
      let height = img.height;
      
      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }
      
      canvas.width = width;
      canvas.height = height;
      
      // ุฑุณู ุงูุตูุฑุฉ ูุถุบูุทุฉ
      ctx.drawImage(img, 0, 0, width, height);
      
      // ุงูุญุตูู ุนูู ุงูุจูุงูุงุช ูุถุบูุทุฉ
      const compressedData = canvas.toDataURL('image/jpeg', quality);
      resolve(compressedData);
    };
    
    img.onerror = function() {
      resolve(imageData); // ุฅุฑุฌุงุน ุงูุจูุงูุงุช ุงูุฃุตููุฉ ูู ุญุงูุฉ ุงูุฎุทุฃ
    };
    
    img.src = imageData;
  });
}
// ุฅุถุงูุฉ ุฑุณุงูุฉ ุตูุฑุฉ ุฅูู ุงููุญุงุฏุซุฉ ุงูุฎุงุตุฉ ูุน ุฏุนู ุงูุชุญููู
function addPrivateImageMessage(message, isOwn) {
    const container = document.getElementById('privateChatMessages');
    if (!container) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-4 flex ${isOwn ? 'justify-end' : 'justify-start'}`;
    
    // ุงุณุชุฎุฏุงู ุตูุฑุฉ ูุคูุชุฉ ุฃุซูุงุก ุงูุชุญููู
    const loadingImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMzMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPua1i+ivleWbvuWDjzwvdGV4dD48L3N2Zz4=';
    
    messageDiv.innerHTML = `
        <div class="max-w-xs px-4 py-3 rounded-xl ${
            isOwn ? 'bg-blue-600 text-white' : 'bg-white/20 text-white'
        }">
            <div class="font-semibold text-sm mb-1">${isOwn ? 'ุฃูุช' : message.from}</div>
            <div class="mb-2">
                <img src="${loadingImage}" data-src="${message.imageData}" class="max-w-full h-auto rounded-lg cursor-pointer chat-image" onclick="openImageModal('${message.imageData}')" alt="ุตูุฑุฉ ูุญุงุฏุซุฉ" onload="handleImageLoad(this)" onerror="handleImageError(this)">
            </div>
            <div class="text-xs opacity-70 mt-1 text-left">${message.time}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    
    // ุชุญููู ุงูุตูุฑุฉ ุจุนุฏ ุฅุถุงูุชูุง ููDOM
    setTimeout(() => {
        loadImageIfNeeded(message.imageData, (finalImageData) => {
            const img = messageDiv.querySelector('img.chat-image');
            if (img) {
                img.src = finalImageData;
                img.setAttribute('onclick', `openImageModal('${finalImageData}')`);
            }
        });
    }, 100);
    
    container.scrollTop = container.scrollHeight;
}

// ุชุญุณูู ูุชุญ ุงููุญุงุฏุซุฉ ุงูุฎุงุตุฉ ูุถูุงู ุชุญููู ุงูุตูุฑ
const originalOpenPrivateChat = openPrivateChat;
openPrivateChat = function(username) {
    originalOpenPrivateChat(username);
    
    // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุฑ ุจุนุฏ ูุชุญ ุงููุญุงุฏุซุฉ
    setTimeout(() => {
        const images = document.querySelectorAll('#privateChatMessages img.chat-image');
        images.forEach(img => {
            const originalSrc = img.getAttribute('data-src');
            if (originalSrc && img.src !== originalSrc) {
                loadImageIfNeeded(originalSrc, (finalImageData) => {
                    img.src = finalImageData;
                });
            }
        });
    }, 500);
};
    </script>
</body>
</html>